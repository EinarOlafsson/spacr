<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spacr.plot &mdash; spacr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >

          
          
          <a href="../../index.html" class="icon icon-home">
            spacr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spacr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spacr.plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spacr.plot</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">re</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndi</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">imageio.v2</span> <span class="k">as</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">skimage.segmentation</span> <span class="kn">import</span> <span class="n">find_boundaries</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>

<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">IntSlider</span><span class="p">,</span> <span class="n">interact</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">ipyimage</span>

<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">log_function_call</span>


<span class="c1">#from .io import _save_figure</span>
<span class="c1">#from .timelapse import _save_mask_timelapse_as_gif</span>
<span class="c1">#from .utils import normalize_to_dtype, _remove_outside_objects, _remove_multiobject_cells, _find_similar_sized_images, _remove_noninfected</span>

<div class="viewcode-block" id="plot_masks">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.plot_masks">[docs]</a>
<span class="k">def</span> <span class="nf">plot_masks</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">flows</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">figuresize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span> <span class="n">print_object_number</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the masks and flows for a given batch of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (numpy.ndarray): The batch of images.</span>
<span class="sd">        masks (list or numpy.ndarray): The masks corresponding to the images.</span>
<span class="sd">        flows (list or numpy.ndarray): The flows corresponding to the images.</span>
<span class="sd">        cmap (str, optional): The colormap to use for displaying the images. Defaults to &#39;inferno&#39;.</span>
<span class="sd">        figuresize (int, optional): The size of the figure. Defaults to 20.</span>
<span class="sd">        nr (int, optional): The maximum number of images to plot. Defaults to 1.</span>
<span class="sd">        file_type (str, optional): The file type of the flows. Defaults to &#39;.npz&#39;.</span>
<span class="sd">        print_object_number (bool, optional): Whether to print the object number on the mask. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">masks</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flows</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">flows</span> <span class="o">=</span> <span class="p">[</span><span class="n">flows</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flows</span> <span class="o">=</span> <span class="n">flows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span><span class="p">:</span>
        <span class="n">flows</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flows</span><span class="p">]</span>  <span class="c1"># assuming this is what you want to do when file_type is &#39;png&#39;</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">figuresize</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">flows</span><span class="p">):</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        
        <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">[</span><span class="n">unique_labels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">random_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_objects</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">random_colors</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">random_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">random_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">random_colors</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">chans</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">v</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span> <span class="c1">#_imshow</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Image - Channel&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">chans</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">random_cmap</span><span class="p">)</span> <span class="c1">#_imshow</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">chans</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mask&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">print_object_number</span><span class="p">:</span>
                <span class="n">unique_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">unique_objects</span><span class="p">:</span>
                    <span class="n">cy</span><span class="p">,</span> <span class="n">cx</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">chans</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">chans</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span> <span class="c1">#_imshow</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">chans</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flow&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_plot_4D_arrays</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">figuresize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">nr_npz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot 4D arrays from .npz files.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The directory path where the .npz files are located.</span>
<span class="sd">        figuresize (int, optional): The size of the figure. Defaults to 10.</span>
<span class="sd">        cmap (str, optional): The colormap to use for image visualization. Defaults to &#39;inferno&#39;.</span>
<span class="sd">        nr_npz (int, optional): The number of .npz files to plot. Defaults to 1.</span>
<span class="sd">        nr (int, optional): The number of images to plot from each .npz file. Defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">nr_npz</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">num_images</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">num_channels</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">num_images</span><span class="p">)):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Create subplots</span>
            <span class="k">if</span> <span class="n">num_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">))</span>
                <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span>  <span class="c1"># Make axs a list to use axs[c] later</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_channels</span> <span class="o">*</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">):</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span> <span class="c1">#_imshow</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span>

<div class="viewcode-block" id="generate_mask_random_cmap">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.generate_mask_random_cmap">[docs]</a>
<span class="k">def</span> <span class="nf">generate_mask_random_cmap</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a random colormap based on the unique labels in the given mask.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    mask (numpy.ndarray): The input mask array.</span>

<span class="sd">    Returns:</span>
<span class="sd">    matplotlib.colors.ListedColormap: The random colormap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">[</span><span class="n">unique_labels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">random_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_objects</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">random_colors</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">random_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">random_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">random_colors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_cmap</span></div>

    
<div class="viewcode-block" id="random_cmap">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.random_cmap">[docs]</a>
<span class="k">def</span> <span class="nf">random_cmap</span><span class="p">(</span><span class="n">num_objects</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a random colormap.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    num_objects (int): The number of objects to generate colors for. Default is 100.</span>

<span class="sd">    Returns:</span>
<span class="sd">    random_cmap (matplotlib.colors.ListedColormap): A random colormap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">random_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_objects</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">random_colors</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">random_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">random_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">random_colors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_cmap</span></div>


<span class="k">def</span> <span class="nf">_generate_mask_random_cmap</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a random colormap based on the unique labels in the given mask.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    mask (ndarray): The mask array containing unique labels.</span>

<span class="sd">    Returns:</span>
<span class="sd">    ListedColormap: A random colormap generated based on the unique labels in the mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">[</span><span class="n">unique_labels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">random_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_objects</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">random_colors</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">random_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">random_cmap</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">random_colors</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_cmap</span>

<span class="k">def</span> <span class="nf">_get_colours_merged</span><span class="p">(</span><span class="n">outline_color</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the merged outline colors based on the specified outline color format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    outline_color (str): The outline color format. Can be one of &#39;rgb&#39;, &#39;bgr&#39;, &#39;gbr&#39;, or &#39;rbg&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">    list: A list of merged outline colors based on the specified format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="n">outline_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>  <span class="c1"># rgb</span>
    <span class="k">elif</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s1">&#39;bgr&#39;</span><span class="p">:</span>
        <span class="n">outline_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># bgr</span>
    <span class="k">elif</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s1">&#39;gbr&#39;</span><span class="p">:</span>
        <span class="n">outline_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># gbr</span>
    <span class="k">elif</span> <span class="n">outline_color</span> <span class="o">==</span> <span class="s1">&#39;rbg&#39;</span><span class="p">:</span>
        <span class="n">outline_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># rbg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outline_colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># rbg</span>
    <span class="k">return</span> <span class="n">outline_colors</span>

<div class="viewcode-block" id="plot_images_and_arrays">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.plot_images_and_arrays">[docs]</a>
<span class="k">def</span> <span class="nf">plot_images_and_arrays</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper_percentile</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot images and arrays from the given folders.</span>

<span class="sd">    Args:</span>
<span class="sd">        folders (list): A list of folder paths containing the images and arrays.</span>
<span class="sd">        lower_percentile (int, optional): The lower percentile for image normalization. Defaults to 1.</span>
<span class="sd">        upper_percentile (int, optional): The upper percentile for image normalization. Defaults to 99.</span>
<span class="sd">        threshold (int, optional): The threshold for determining whether to display an image as a mask or normalize it. Defaults to 1000.</span>
<span class="sd">        extensions (list, optional): A list of file extensions to consider. Defaults to [&#39;.npy&#39;, &#39;.tif&#39;, &#39;.tiff&#39;, &#39;.png&#39;].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">normalize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
        <span class="n">p2</span><span class="p">,</span> <span class="n">p98</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">image</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p98</span> <span class="o">-</span> <span class="n">p2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]):</span>
        <span class="n">file_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">):</span>
                        <span class="n">file_name_wo_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">file_name_wo_ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="p">:</span>
                            <span class="n">file_dict</span><span class="p">[</span><span class="n">file_name_wo_ext</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">file_dict</span><span class="p">[</span><span class="n">file_name_wo_ext</span><span class="p">][</span><span class="n">folder</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>

        <span class="c1"># Filter out files that don&#39;t have paths in all folders</span>
        <span class="n">filtered_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">folders</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">filtered_dict</span>

    <span class="k">def</span> <span class="nf">plot_from_file_dict</span><span class="p">(</span><span class="n">file_dict</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper_percentile</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot images and arrays from the given file dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_dict (dict): A dictionary containing the file paths for each image or array.</span>
<span class="sd">            threshold (int, optional): The threshold for determining whether to display an image as a mask or normalize it. Defaults to 1000.</span>
<span class="sd">            lower_percentile (int, optional): The lower percentile for image normalization. Defaults to 1.</span>
<span class="sd">            upper_percentile (int, optional): The upper percentile for image normalization. Defaults to 99.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder_paths</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">num_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder_paths</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_files</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="c1">#fig.suptitle(filename)</span>

            <span class="c1"># Ensure axes is always a list</span>
            <span class="k">if</span> <span class="n">num_files</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folder_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tiff&#39;</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="c1"># Normalize image to percentiles</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">normalize_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">upper_percentile</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Display as mask with random colormap</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">random_cmap</span><span class="p">(</span><span class="n">num_objects</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                        
    <span class="n">file_dict</span> <span class="o">=</span> <span class="n">find_files</span><span class="p">(</span><span class="n">folders</span><span class="p">,</span> <span class="n">extensions</span><span class="p">)</span>
    <span class="n">plot_from_file_dict</span><span class="p">(</span><span class="n">file_dict</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">upper_percentile</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_filter_objects_in_plot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">cell_mask_dim</span><span class="p">,</span> <span class="n">nucleus_mask_dim</span><span class="p">,</span> <span class="n">pathogen_mask_dim</span><span class="p">,</span> <span class="n">mask_dims</span><span class="p">,</span> <span class="n">filter_min_max</span><span class="p">,</span> <span class="n">include_multinucleated</span><span class="p">,</span> <span class="n">include_multiinfected</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filters objects in a plot based on various criteria.</span>

<span class="sd">    Args:</span>
<span class="sd">        stack (numpy.ndarray): The input stack of masks.</span>
<span class="sd">        cell_mask_dim (int): The dimension index of the cell mask.</span>
<span class="sd">        nucleus_mask_dim (int): The dimension index of the nucleus mask.</span>
<span class="sd">        pathogen_mask_dim (int): The dimension index of the pathogen mask.</span>
<span class="sd">        mask_dims (list): A list of dimension indices for additional masks.</span>
<span class="sd">        filter_min_max (list): A list of minimum and maximum area values for each mask.</span>
<span class="sd">        include_multinucleated (bool): Whether to include multinucleated cells.</span>
<span class="sd">        include_multiinfected (bool): Whether to include multiinfected cells.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The filtered stack of masks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_remove_outside_objects</span><span class="p">,</span> <span class="n">_remove_multiobject_cells</span>
    
    <span class="n">stack</span> <span class="o">=</span> <span class="n">_remove_outside_objects</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">cell_mask_dim</span><span class="p">,</span> <span class="n">nucleus_mask_dim</span><span class="p">,</span> <span class="n">pathogen_mask_dim</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask_dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask_dims</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_min_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="n">filter_min_max</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000000</span><span class="p">]</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mask_dim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">])</span>
        <span class="c1">#props = measure.regionprops_table(mask, intensity_image=intensity_image, properties=[&#39;label&#39;, &#39;area&#39;, &#39;mean_intensity&#39;])</span>
        <span class="n">avg_size_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span>
        <span class="n">total_count_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filter_min_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valid_labels</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>  
            <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">mask_dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>  

        <span class="n">props_after</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">mask_dim</span><span class="p">],</span> <span class="n">properties</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">])</span> 
        <span class="n">avg_size_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">props_after</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">])</span>
        <span class="n">total_count_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">props_after</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">mask_dim</span> <span class="o">==</span> <span class="n">cell_mask_dim</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_multinucleated</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">nucleus_mask_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">_remove_multiobject_cells</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mask_dim</span><span class="p">,</span> <span class="n">cell_mask_dim</span><span class="p">,</span> <span class="n">nucleus_mask_dim</span><span class="p">,</span> <span class="n">pathogen_mask_dim</span><span class="p">,</span> <span class="n">object_dim</span><span class="o">=</span><span class="n">pathogen_mask_dim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_multiinfected</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">cell_mask_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pathogen_mask_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">_remove_multiobject_cells</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mask_dim</span><span class="p">,</span> <span class="n">cell_mask_dim</span><span class="p">,</span> <span class="n">nucleus_mask_dim</span><span class="p">,</span> <span class="n">pathogen_mask_dim</span><span class="p">,</span> <span class="n">object_dim</span><span class="o">=</span><span class="n">nucleus_mask_dim</span><span class="p">)</span>
            <span class="n">cell_area_before</span> <span class="o">=</span> <span class="n">avg_size_before</span>
            <span class="n">cell_count_before</span> <span class="o">=</span> <span class="n">total_count_before</span>
            <span class="n">cell_area_after</span> <span class="o">=</span> <span class="n">avg_size_after</span>
            <span class="n">cell_count_after</span> <span class="o">=</span> <span class="n">total_count_after</span>
        <span class="k">if</span> <span class="n">mask_dim</span> <span class="o">==</span> <span class="n">nucleus_mask_dim</span><span class="p">:</span>
            <span class="n">nucleus_area_before</span> <span class="o">=</span> <span class="n">avg_size_before</span>
            <span class="n">nucleus_count_before</span> <span class="o">=</span> <span class="n">total_count_before</span>
            <span class="n">nucleus_area_after</span> <span class="o">=</span> <span class="n">avg_size_after</span>
            <span class="n">nucleus_count_after</span> <span class="o">=</span> <span class="n">total_count_after</span>
        <span class="k">if</span> <span class="n">mask_dim</span> <span class="o">==</span> <span class="n">pathogen_mask_dim</span><span class="p">:</span>
            <span class="n">pathogen_area_before</span> <span class="o">=</span> <span class="n">avg_size_before</span>
            <span class="n">pathogen_count_before</span> <span class="o">=</span> <span class="n">total_count_before</span>
            <span class="n">pathogen_area_after</span> <span class="o">=</span> <span class="n">avg_size_after</span>
            <span class="n">pathogen_count_after</span> <span class="o">=</span> <span class="n">total_count_after</span>

    <span class="k">if</span> <span class="n">cell_mask_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;removed </span><span class="si">{</span><span class="n">cell_count_before</span><span class="o">-</span><span class="n">cell_count_after</span><span class="si">}</span><span class="s1"> cells, cell size from </span><span class="si">{</span><span class="n">cell_area_before</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">cell_area_after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nucleus_mask_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;removed </span><span class="si">{</span><span class="n">nucleus_count_before</span><span class="o">-</span><span class="n">nucleus_count_after</span><span class="si">}</span><span class="s1"> nucleus, nucleus size from </span><span class="si">{</span><span class="n">nucleus_area_before</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">nucleus_area_after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pathogen_mask_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;removed </span><span class="si">{</span><span class="n">pathogen_count_before</span><span class="o">-</span><span class="n">pathogen_count_after</span><span class="si">}</span><span class="s1"> pathogens, pathogen size from </span><span class="si">{</span><span class="n">pathogen_area_before</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">pathogen_area_after</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stack</span>

<div class="viewcode-block" id="plot_arrays">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.plot_arrays">[docs]</a>
<span class="k">def</span> <span class="nf">plot_arrays</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">figuresize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">q1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">q2</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot randomly selected arrays from a given directory.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - src (str): The directory path containing the arrays.</span>
<span class="sd">    - figuresize (int): The size of the figure (default: 50).</span>
<span class="sd">    - cmap (str): The colormap to use for displaying the arrays (default: &#39;inferno&#39;).</span>
<span class="sd">    - nr (int): The number of arrays to plot (default: 1).</span>
<span class="sd">    - normalize (bool): Whether to normalize the arrays (default: True).</span>
<span class="sd">    - q1 (int): The lower percentile for normalization (default: 1).</span>
<span class="sd">    - q2 (int): The upper percentile for normalization (default: 99).</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">normalize_to_dtype</span>
    
    <span class="n">mask_cmap</span> <span class="o">=</span> <span class="n">random_cmap</span><span class="p">()</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image path:</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">normalize_to_dtype</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">p1</span><span class="o">=</span><span class="n">q1</span><span class="p">,</span> <span class="n">p2</span><span class="o">=</span><span class="n">q2</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">array_nr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_nr</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">,</span><span class="n">figuresize</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">array_nr</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span> <span class="c1">#_imshow</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Channel &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">,</span><span class="n">figuresize</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span> <span class="c1">#_imshow</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Channel 0&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_normalize_and_outline</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">remove_background</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">normalization_percentiles</span><span class="p">,</span> <span class="n">overlay</span><span class="p">,</span> <span class="n">overlay_chans</span><span class="p">,</span> <span class="n">mask_dims</span><span class="p">,</span> <span class="n">outline_colors</span><span class="p">,</span> <span class="n">outline_thickness</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize and outline an image.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (ndarray): The input image.</span>
<span class="sd">        remove_background (bool): Flag indicating whether to remove the background.</span>
<span class="sd">        backgrounds (list): List of background values for each channel.</span>
<span class="sd">        normalize (bool): Flag indicating whether to normalize the image.</span>
<span class="sd">        normalization_percentiles (list): List of percentiles for normalization.</span>
<span class="sd">        overlay (bool): Flag indicating whether to overlay outlines onto the image.</span>
<span class="sd">        overlay_chans (list): List of channel indices to overlay.</span>
<span class="sd">        mask_dims (list): List of dimensions to use for masking.</span>
<span class="sd">        outline_colors (list): List of colors for the outlines.</span>
<span class="sd">        outline_thickness (int): Thickness of the outlines.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the overlayed image, the original image, and a list of outlines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">normalize_to_dtype</span><span class="p">,</span> <span class="n">_outline_and_overlay</span><span class="p">,</span> <span class="n">_gen_rgb_image</span>

    <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="n">backgrounds</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chan_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">chan_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mask_dims</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
        <span class="n">image</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">normalize_to_dtype</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">p1</span><span class="o">=</span><span class="n">normalization_percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="o">=</span><span class="n">normalization_percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">normalize_to_dtype</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">p1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">p2</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">_gen_rgb_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">overlay_chans</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">overlay</span><span class="p">:</span>
        <span class="n">overlayed_image</span><span class="p">,</span> <span class="n">outlines</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">_outline_and_overlay</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rgb_image</span><span class="p">,</span> <span class="n">mask_dims</span><span class="p">,</span> <span class="n">outline_colors</span><span class="p">,</span> <span class="n">outline_thickness</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">overlayed_image</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">outlines</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Remove mask_dims from image</span>
        <span class="n">channels_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mask_dims</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channels_to_keep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="n">image</span><span class="p">,</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">_plot_merged_plot</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">mask_dims</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">overlayed_image</span><span class="p">,</span> <span class="n">outlines</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">outline_colors</span><span class="p">,</span> <span class="n">print_object_number</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the merged plot with overlay, image channels, and masks.</span>

<span class="sd">    Args:</span>
<span class="sd">        overlay (bool): Flag indicating whether to overlay the image with outlines.</span>
<span class="sd">        image (ndarray): Input image array.</span>
<span class="sd">        stack (ndarray): Stack of masks.</span>
<span class="sd">        mask_dims (list): List of mask dimensions.</span>
<span class="sd">        figuresize (float): Size of the figure.</span>
<span class="sd">        overlayed_image (ndarray): Overlayed image array.</span>
<span class="sd">        outlines (list): List of outlines.</span>
<span class="sd">        cmap (str): Colormap for the masks.</span>
<span class="sd">        outline_colors (list): List of outline colors.</span>
<span class="sd">        print_object_number (bool): Flag indicating whether to print object numbers on the masks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (Figure): The generated matplotlib figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">overlay</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">overlayed_image</span><span class="p">)</span> <span class="c1">#_imshow</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Overlayed Image&#39;</span><span class="p">)</span>
        <span class="n">ax_index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_dims</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">))</span>
        <span class="n">ax_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Normalize and plot each channel with outlines</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">channel_image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
        <span class="n">channel_image_normalized</span> <span class="o">=</span> <span class="n">channel_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">channel_image_normalized</span> <span class="o">-=</span> <span class="n">channel_image_normalized</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">channel_image_normalized</span> <span class="o">/=</span> <span class="n">channel_image_normalized</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">channel_image_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">channel_image_normalized</span><span class="p">,</span> <span class="n">channel_image_normalized</span><span class="p">,</span> <span class="n">channel_image_normalized</span><span class="p">))</span>

        <span class="c1"># Apply the outlines onto the RGB image</span>
        <span class="k">for</span> <span class="n">outline</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">outlines</span><span class="p">,</span> <span class="n">outline_colors</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">outline</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">channel_image_rgb</span><span class="p">[</span><span class="n">outline</span> <span class="o">==</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">v</span> <span class="o">+</span> <span class="n">ax_index</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">channel_image_rgb</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">v</span> <span class="o">+</span> <span class="n">ax_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Image - Channel&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask_dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mask_dims</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mask_dim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">random_cmap</span> <span class="o">=</span> <span class="n">_generate_mask_random_cmap</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax_index</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">random_cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax_index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mask &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">print_object_number</span><span class="p">:</span>
            <span class="n">unique_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">unique_objects</span><span class="p">:</span>
                <span class="n">cy</span><span class="p">,</span> <span class="n">cx</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ax_index</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<div class="viewcode-block" id="plot_merged">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.plot_merged">[docs]</a>
<span class="k">def</span> <span class="nf">plot_merged</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the merged images after applying various filters and modifications.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (path): Path to folder with images.</span>
<span class="sd">        settings (dict): The settings for the plot.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_remove_noninfected</span>

    
    
    <span class="n">font</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;figuresize&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">outline_colors</span> <span class="o">=</span> <span class="n">_get_colours_merged</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;outline_color&#39;</span><span class="p">])</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="n">mask_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_mask_dim&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_mask_dim&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_mask_dim&#39;</span><span class="p">]]</span>
    <span class="n">mask_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">mask_dims</span> <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_mask_dim&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;include_multiinfected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;include_noninfected&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_mask_dim&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_mask_dim&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">_remove_noninfected</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_mask_dim&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_mask_dim&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_mask_dim&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;include_multiinfected&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;include_multinucleated&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;filter_min_max&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">_filter_objects_in_plot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_mask_dim&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_mask_dim&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_mask_dim&#39;</span><span class="p">],</span> <span class="n">mask_dims</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;filter_min_max&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;include_multinucleated&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;include_multiinfected&#39;</span><span class="p">])</span>

        <span class="n">overlayed_image</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">outlines</span> <span class="o">=</span> <span class="n">_normalize_and_outline</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> 
                                                                  <span class="n">remove_background</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background&#39;</span><span class="p">],</span>
                                                                  <span class="n">normalize</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;normalize&#39;</span><span class="p">],</span>
                                                                  <span class="n">normalization_percentiles</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;normalization_percentiles&#39;</span><span class="p">],</span>
                                                                  <span class="n">overlay</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;overlay&#39;</span><span class="p">],</span>
                                                                  <span class="n">overlay_chans</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;overlay_chans&#39;</span><span class="p">],</span>
                                                                  <span class="n">mask_dims</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">,</span>
                                                                  <span class="n">outline_colors</span><span class="o">=</span><span class="n">outline_colors</span><span class="p">,</span>
                                                                  <span class="n">outline_thickness</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;outline_thickness&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">]:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">_plot_merged_plot</span><span class="p">(</span><span class="n">overlay</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;overlay&#39;</span><span class="p">],</span>
                                    <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
                                    <span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
                                    <span class="n">mask_dims</span><span class="o">=</span><span class="n">mask_dims</span><span class="p">,</span>
                                    <span class="n">figuresize</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;figuresize&#39;</span><span class="p">],</span>
                                    <span class="n">overlayed_image</span><span class="o">=</span><span class="n">overlayed_image</span><span class="p">,</span>
                                    <span class="n">outlines</span><span class="o">=</span><span class="n">outlines</span><span class="p">,</span>
                                    <span class="n">cmap</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span>
                                    <span class="n">outline_colors</span><span class="o">=</span><span class="n">outline_colors</span><span class="p">,</span>
                                    <span class="n">print_object_number</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;print_object_number&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">_plot_images_on_grid</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">channel_indices</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="p">,</span> <span class="n">scale_bar_length_um</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">show_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a grid of images with optional scale bar and channel names.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_files (list): List of image file paths.</span>
<span class="sd">        channel_indices (list): List of channel indices to select from the images.</span>
<span class="sd">        um_per_pixel (float): Micrometers per pixel.</span>
<span class="sd">        scale_bar_length_um (float, optional): Length of the scale bar in micrometers. Defaults to 5.</span>
<span class="sd">        fontsize (int, optional): Font size for the image titles. Defaults to 8.</span>
<span class="sd">        show_filename (bool, optional): Whether to show the image file names as titles. Defaults to True.</span>
<span class="sd">        channel_names (list, optional): List of channel names. Defaults to None.</span>
<span class="sd">        plot (bool, optional): Whether to display the plot. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.figure.Figure: The generated figure object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;scale bar represents </span><span class="si">{</span><span class="n">scale_bar_length_um</span><span class="si">}</span><span class="s1"> um&#39;</span><span class="p">)</span>
    <span class="n">nr_of_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nr_of_images</span><span class="p">)))</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nr_of_images</span> <span class="o">/</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># Calculate the scale bar length in pixels</span>
    <span class="n">scale_bar_length_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scale_bar_length_um</span> <span class="o">/</span> <span class="n">um_per_pixel</span><span class="p">)</span>  <span class="c1"># Convert to pixels</span>

    <span class="n">channel_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_files</span><span class="p">):</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_UNCHANGED</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img_array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">img_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
        <span class="c1"># Handle different channel selections</span>
        <span class="k">if</span> <span class="n">channel_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Single channel (grayscale)</span>
                <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">channel_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Dual channels</span>
                <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">channel_indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># RGB or more channels</span>
                <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">channel_indices</span><span class="p">]</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">img_array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;gray&#39;</span>
        <span class="c1"># Normalize based on dtype</span>
        <span class="k">if</span> <span class="n">img_array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span>
            <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">65535.0</span>
        <span class="k">elif</span> <span class="n">img_array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">:</span>
            <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_filename</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image_file</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># Add scale bar</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">scale_bar_length_px</span><span class="p">],</span> <span class="p">[</span><span class="n">img_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="c1"># Add channel names at the top if specified</span>
    <span class="n">initial_offset</span> <span class="o">=</span> <span class="mf">0.02</span>  <span class="c1"># Starting offset from the left side of the figure</span>
    <span class="n">increment</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># Fixed increment for each subsequent channel name, adjust based on figure width</span>
    <span class="k">if</span> <span class="n">channel_names</span><span class="p">:</span>
        <span class="n">current_offset</span> <span class="o">=</span> <span class="n">initial_offset</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_names</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">channel_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_colors</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;white&#39;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">current_offset</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">channel_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">current_offset</span> <span class="o">+=</span> <span class="n">increment</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="k">def</span> <span class="nf">_save_scimg_plot</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">channel_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">um_per_pixel</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scale_bar_length_um</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">show_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">all_folders</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save and visualize single-cell images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory path.</span>
<span class="sd">        nr_imgs (int, optional): The number of images to visualize. Defaults to 16.</span>
<span class="sd">        channel_indices (list, optional): List of channel indices to visualize. Defaults to [0,1,2].</span>
<span class="sd">        um_per_pixel (float, optional): Micrometers per pixel. Defaults to 0.1.</span>
<span class="sd">        scale_bar_length_um (float, optional): Length of the scale bar in micrometers. Defaults to 10.</span>
<span class="sd">        standardize (bool, optional): Whether to standardize the image sizes. Defaults to True.</span>
<span class="sd">        fontsize (int, optional): Font size for the filename. Defaults to 8.</span>
<span class="sd">        show_filename (bool, optional): Whether to show the filename on the image. Defaults to True.</span>
<span class="sd">        channel_names (list, optional): List of channel names. Defaults to None.</span>
<span class="sd">        dpi (int, optional): Dots per inch for the saved image. Defaults to 300.</span>
<span class="sd">        plot (bool, optional): Whether to plot the images. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">_save_figure</span>
    
    <span class="k">def</span> <span class="nf">_visualize_scimgs</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">scale_bar_length_um</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">show_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize single-cell images.</span>

<span class="sd">        Args:</span>
<span class="sd">            src (str): The source directory path.</span>
<span class="sd">            channel_indices (list, optional): List of channel indices to visualize. Defaults to None.</span>
<span class="sd">            um_per_pixel (float, optional): Micrometers per pixel. Defaults to 0.1.</span>
<span class="sd">            scale_bar_length_um (float, optional): Length of the scale bar in micrometers. Defaults to 10.</span>
<span class="sd">            show_filename (bool, optional): Whether to show the filename on the image. Defaults to True.</span>
<span class="sd">            standardize (bool, optional): Whether to standardize the image sizes. Defaults to True.</span>
<span class="sd">            nr_imgs (int, optional): The number of images to visualize. Defaults to None.</span>
<span class="sd">            fontsize (int, optional): Font size for the filename. Defaults to 8.</span>
<span class="sd">            channel_names (list, optional): List of channel names. Defaults to None.</span>
<span class="sd">            plot (bool, optional): Whether to plot the images. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib.figure.Figure: The figure object containing the plotted images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_find_similar_sized_images</span>
        <span class="k">def</span> <span class="nf">_generate_filelist</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate a list of image files in the specified directory.</span>

<span class="sd">            Args:</span>
<span class="sd">                src (str): The source directory path.</span>

<span class="sd">            Returns:</span>
<span class="sd">                list: A list of image file paths.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
            <span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">))]</span>
            <span class="k">return</span> <span class="n">image_files</span>

        <span class="k">def</span> <span class="nf">_random_sample</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Randomly selects a subset of files from the given file list.</span>

<span class="sd">            Args:</span>
<span class="sd">                file_list (list): A list of file names.</span>
<span class="sd">                nr_imgs (int, optional): The number of files to select. If None, all files are selected. Defaults to None.</span>

<span class="sd">            Returns:</span>
<span class="sd">                list: A list of randomly selected file names.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">nr_imgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nr_imgs</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
                <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
                <span class="n">file_list</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">file_list</span>

        <span class="n">image_files</span> <span class="o">=</span> <span class="n">_generate_filelist</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
            <span class="n">image_files</span> <span class="o">=</span> <span class="n">_find_similar_sized_images</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nr_imgs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">image_files</span> <span class="o">=</span> <span class="n">_random_sample</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">_plot_images_on_grid</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">channel_indices</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="p">,</span> <span class="n">scale_bar_length_um</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">show_filename</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">,</span> <span class="n">plot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">_visualize_scimgs</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel_indices</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="p">,</span> <span class="n">scale_bar_length_um</span><span class="p">,</span> <span class="n">show_filename</span><span class="p">,</span> <span class="n">standardize</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">,</span> <span class="n">plot</span><span class="p">)</span>
    <span class="n">_save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;all_channels&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channel_indices</span><span class="p">:</span>
        <span class="n">channel_indices</span><span class="o">=</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">_visualize_scimgs</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel_indices</span><span class="p">,</span> <span class="n">um_per_pixel</span><span class="p">,</span> <span class="n">scale_bar_length_um</span><span class="p">,</span> <span class="n">show_filename</span><span class="p">,</span> <span class="n">standardize</span><span class="p">,</span> <span class="n">nr_imgs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">channel_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="n">_save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;channel_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_plot_cropped_arrays</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">figuresize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot cropped arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        stack (ndarray): The array to be plotted.</span>
<span class="sd">        figuresize (int, optional): The size of the figure. Defaults to 20.</span>
<span class="sd">        cmap (str, optional): The colormap to be used. Defaults to &#39;inferno&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span> 
    <span class="n">channel</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">,</span><span class="n">figuresize</span><span class="p">))</span>
        <span class="n">a</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Channel one&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">anr</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">anr</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="p">,</span><span class="n">figuresize</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">anr</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">[:,:,</span><span class="n">channel</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">))</span>
            <span class="n">a</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Channel &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">channel</span><span class="p">),</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plot_cropped_arrays&#39;</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>
    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_visualize_and_save_timelapse_stack_with_tracks</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">tracks_df</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">object_type</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;btrack&#39;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualizes and saves a timelapse stack with tracks.</span>

<span class="sd">    Args:</span>
<span class="sd">        masks (list): List of binary masks representing each frame of the timelapse stack.</span>
<span class="sd">        tracks_df (pandas.DataFrame): DataFrame containing track information.</span>
<span class="sd">        save (bool): Flag indicating whether to save the timelapse stack.</span>
<span class="sd">        src (str): Source file path.</span>
<span class="sd">        name (str): Name of the timelapse stack.</span>
<span class="sd">        plot (bool): Flag indicating whether to plot the timelapse stack.</span>
<span class="sd">        filenames (list): List of filenames corresponding to each frame of the timelapse stack.</span>
<span class="sd">        object_type (str): Type of object being tracked.</span>
<span class="sd">        mode (str, optional): Tracking mode. Defaults to &#39;btrack&#39;.</span>
<span class="sd">        interactive (bool, optional): Flag indicating whether to display the timelapse stack interactively. Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">_save_mask_timelapse_as_gif</span>
    
    <span class="n">highest_label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">)</span>
    <span class="c1"># Generate random colors for each label, including the background</span>
    <span class="n">random_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">highest_label</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">random_colors</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Full opacity</span>
    <span class="n">random_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Background color</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">random_colors</span><span class="p">)</span>
    <span class="c1"># Ensure the normalization range covers all labels</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">highest_label</span><span class="p">)</span>

    <span class="c1"># Function to plot a frame and overlay tracks</span>
    <span class="k">def</span> <span class="nf">_view_frame_with_tracks</span><span class="p">(</span><span class="n">frame</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the frame with tracks overlaid.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        frame (int): The frame number to display.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">current_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">current_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>  <span class="c1"># Apply both colormap and normalization</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame: </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Directly annotate each object with its label number from the mask</span>
        <span class="k">for</span> <span class="n">label_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">current_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># Skip background</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_mask</span> <span class="o">==</span> <span class="n">label_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_value</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Overlay tracks</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">_track</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="p">[</span><span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_track</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">_track</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
            <span class="n">interact</span><span class="p">(</span><span class="n">_view_frame_with_tracks</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Save as gif</span>
        <span class="n">gif_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;movies&#39;</span><span class="p">,</span> <span class="s1">&#39;gif&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gif_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">save_path_gif</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gif_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;timelapse_masks_</span><span class="si">{</span><span class="n">object_type</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.gif&#39;</span><span class="p">)</span>
        <span class="n">_save_mask_timelapse_as_gif</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">tracks_df</span><span class="p">,</span> <span class="n">save_path_gif</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
                <span class="n">_display_gif</span><span class="p">(</span><span class="n">save_path_gif</span><span class="p">)</span>
                
<span class="k">def</span> <span class="nf">_display_gif</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a GIF image from the given path.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    path (str): The path to the GIF image file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ipyimage</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
        
<span class="k">def</span> <span class="nf">_plot_recruitment</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_type</span><span class="p">,</span> <span class="n">channel_of_interest</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[],</span> <span class="n">figuresize</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot recruitment data for different conditions and pathogens.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (DataFrame): The input DataFrame containing the recruitment data.</span>
<span class="sd">        df_type (str): The type of DataFrame (e.g., &#39;train&#39;, &#39;test&#39;).</span>
<span class="sd">        channel_of_interest (str): The channel of interest for plotting.</span>
<span class="sd">        target (str): The target variable for plotting.</span>
<span class="sd">        columns (list, optional): Additional columns to plot. Defaults to an empty list.</span>
<span class="sd">        figuresize (int, optional): The size of the figure. Defaults to 50.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">color_list</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">255</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">)]</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set_palette</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">color_list</span><span class="p">))</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">figuresize</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">width</span><span class="o">=</span><span class="n">figuresize</span>
    <span class="n">height</span><span class="o">=</span><span class="n">figuresize</span><span class="o">/</span><span class="mi">4</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;cell_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen </span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cell_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;nucleus_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen </span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;cytoplasm_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen </span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cytoplasm_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;pathogen_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen </span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;pathogen_cytoplasm_mean_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_cytoplasm_q75_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_periphery_cytoplasm_mean_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_outside_cytoplasm_mean_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_outside_cytoplasm_q75_mean&#39;</span><span class="p">]</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pathogen_slope_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pathogen_cell_distance_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;nucleus_cell_distance_channel_</span><span class="si">{</span><span class="n">channel_of_interest</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>

    <span class="n">width</span> <span class="o">=</span> <span class="n">figuresize</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">columns_per_row</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">figuresize</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">columns_per_row</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">columns_per_row</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen </span><span class="si">{</span><span class="n">df_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">font</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="k">def</span> <span class="nf">_plot_controls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mask_chans</span><span class="p">,</span> <span class="n">channel_of_interest</span><span class="p">,</span> <span class="n">figuresize</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot controls for different channels and conditions.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): The DataFrame containing the data.</span>
<span class="sd">        mask_chans (list): The list of channels to include in the plot.</span>
<span class="sd">        channel_of_interest (int): The channel of interest.</span>
<span class="sd">        figuresize (int, optional): The size of the figure. Defaults to 5.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_of_interest</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_chans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">mask_chans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_chans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">mask_chans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_chans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">mask_chans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_chans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mask_chans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">controls_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">mask_chans</span><span class="p">:</span>

        <span class="n">controls_cols_c</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">controls_cols_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cell_channel_</span><span class="si">{</span><span class="n">chan</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">)</span>
        <span class="n">controls_cols_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus_channel_</span><span class="si">{</span><span class="n">chan</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">)</span>
        <span class="n">controls_cols_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogen_channel_</span><span class="si">{</span><span class="n">chan</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">)</span>
        <span class="n">controls_cols_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cytoplasm_channel_</span><span class="si">{</span><span class="n">chan</span><span class="si">}</span><span class="s1">_mean_intensity&#39;</span><span class="p">)</span>
        <span class="n">controls_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">controls_cols_c</span><span class="p">)</span>

    <span class="n">unique_conditions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_conditions</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">unique_conditions</span><span class="o">=</span><span class="n">unique_conditions</span><span class="o">+</span><span class="n">unique_conditions</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_conditions</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask_chans</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figuresize</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">mask_chans</span><span class="p">),</span> <span class="n">figuresize</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_conditions</span><span class="p">)))</span>

    <span class="c1"># Define RGB color tuples (scaled to 0-1 range)</span>
    <span class="n">color_list</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> 
                  <span class="p">(</span><span class="mi">255</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">55</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="o">/</span><span class="mi">255</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">idx_condition</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_conditions</span><span class="p">):</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">condition</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx_channel</span><span class="p">,</span> <span class="n">control_cols_c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">controls_cols</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">std_dev</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">control_col</span> <span class="ow">in</span> <span class="n">control_cols_c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">control_col</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">mean_intensity</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="n">control_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">mean_intensity</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mean_intensity</span><span class="p">)</span> <span class="k">else</span> <span class="n">mean_intensity</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_intensity</span><span class="p">)</span>
                    <span class="n">std_dev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="n">control_col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

            <span class="n">current_axis</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx_condition</span><span class="p">][</span><span class="n">idx_channel</span><span class="p">]</span>
            <span class="n">current_axis</span><span class="o">.</span><span class="n">bar</span><span class="p">([</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="s2">&quot;nucleus&quot;</span><span class="p">,</span> <span class="s2">&quot;pathogen&quot;</span><span class="p">,</span> <span class="s2">&quot;cytoplasm&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">std_dev</span><span class="p">,</span> 
                             <span class="n">capsize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_list</span><span class="p">)</span>
            <span class="n">current_axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Component&#39;</span><span class="p">)</span>
            <span class="n">current_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Intensity&#39;</span><span class="p">)</span>
            <span class="n">current_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Condition: </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1"> - Channel </span><span class="si">{</span><span class="n">idx_channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">###################################################</span>
<span class="c1">#  Classify</span>
<span class="c1">###################################################</span>

<span class="k">def</span> <span class="nf">_imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display multiple images in a grid with corresponding labels.</span>

<span class="sd">    Args:</span>
<span class="sd">        img (list): List of images to display.</span>
<span class="sd">        labels (list): List of labels corresponding to each image.</span>
<span class="sd">        nrow (int, optional): Number of images per row in the grid. Defaults to 20.</span>
<span class="sd">        color (str, optional): Color of the label text. Defaults to &#39;white&#39;.</span>
<span class="sd">        fontsize (int, optional): Font size of the label text. Defaults to 12.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">n_col</span> <span class="o">=</span> <span class="n">nrow</span>
    <span class="n">n_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_images</span> <span class="o">/</span> <span class="n">n_col</span><span class="p">))</span>
    <span class="n">img_height</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">img_width</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img_height</span> <span class="o">*</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">n_col</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_row</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_col</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">n_col</span> <span class="o">+</span> <span class="n">j</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n_images</span><span class="p">:</span>
                <span class="n">canvas</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">img_height</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_height</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">:(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>        
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">n_col</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_col</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">col</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">row</span> <span class="o">*</span> <span class="n">img_height</span> <span class="o">+</span> <span class="mi">15</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="k">def</span> <span class="nf">_plot_histograms_and_stats</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">condition</span><span class="p">]</span>
        
        <span class="c1"># Calculate the statistics</span>
        <span class="n">mean_pred</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">over_0_5</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">under_0_5</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Print the statistics</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Condition: </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean of pred: </span><span class="si">{</span><span class="n">mean_pred</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Count of pred values over 0.5: </span><span class="si">{</span><span class="n">over_0_5</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Count of pred values under 0.5: </span><span class="si">{</span><span class="n">under_0_5</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percent positive: </span><span class="si">{</span><span class="p">(</span><span class="n">over_0_5</span><span class="o">/</span><span class="p">(</span><span class="n">over_0_5</span><span class="o">+</span><span class="n">under_0_5</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percent negative: </span><span class="si">{</span><span class="p">(</span><span class="n">under_0_5</span><span class="o">/</span><span class="p">(</span><span class="n">over_0_5</span><span class="o">+</span><span class="n">under_0_5</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
        
        <span class="c1"># Plot the histogram</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_pred</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean = </span><span class="si">{</span><span class="n">mean_pred</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Histogram for pred - Condition: </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pred Value&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_show_residules</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>

    <span class="c1"># Get the residuals</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span>

    <span class="c1"># Histogram of residuals</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of Residuals&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Residual Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># QQ plot</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;45&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;QQ Plot&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Residuals vs. Fitted values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">fittedvalues</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Fitted values&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Residuals vs. Fitted Values&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Shapiro-Wilk test for normality</span>
    <span class="n">W</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shapiro-Wilk Test W-statistic: </span><span class="si">{</span><span class="n">W</span><span class="si">}</span><span class="s1">, p-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">_reg_v_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">plate_number</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;-log10(p)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>

    <span class="c1"># Create the volcano plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;effect&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;-log10(p)&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;effect&#39;</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Volcano Plot&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Coefficient&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;-log10(P-value)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># Add text for specified points</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span><span class="c1"># and abs(row[&#39;effect&#39;]) &gt; 0.1:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;effect&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.05</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># line for p=0.05</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<div class="viewcode-block" id="generate_plate_heatmap">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.generate_plate_heatmap">[docs]</a>
<span class="k">def</span> <span class="nf">generate_plate_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plate_number</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">min_count</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Work on a copy to avoid SettingWithCopyWarning</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
    
    <span class="c1"># Filtering the dataframe based on the plate_number</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">plate_number</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Create another copy after filtering</span>
    
    <span class="c1"># Ensure proper ordering</span>
    <span class="n">row_order</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;r</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">)]</span>
    <span class="n">col_order</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;c</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">)]</span>  <span class="c1"># Exclude c15 as per your earlier code</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">row_order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">col_order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">])[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">min_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_count</span><span class="p">]</span>

    <span class="c1"># Explicitly set observed=True to avoid FutureWarning</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

    
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported grouping: </span><span class="si">{</span><span class="n">grouping</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">plate_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">min_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_map</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">plate_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="k">elif</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;allq&#39;</span><span class="p">:</span>
        <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">plate_map</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_max</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">)):</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">plate_map</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">)):</span> 
            <span class="n">min_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        
    <span class="k">return</span> <span class="n">plate_map</span><span class="p">,</span> <span class="n">min_max</span></div>


<span class="k">def</span> <span class="nf">_plot_plates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">plates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plates</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">plate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plates</span><span class="p">):</span>
        <span class="n">plate_map</span><span class="p">,</span> <span class="n">min_max_values</span> <span class="o">=</span> <span class="n">generate_plate_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">min_count</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">plate_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">min_max_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">min_max_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plate</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plates</span><span class="p">),</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1">#def plate_heatmap(src, variable=&#39;recruitment&#39;, grouping=&#39;mean&#39;, min_max=&#39;allq&#39;, cmap=&#39;viridis&#39;, channel_of_interest=3, min_count=25, verbose=False):</span>
<span class="c1">#    db_loc = [src+&#39;/measurements/measurements.db&#39;]</span>
<span class="c1">#    tables = [&#39;cell&#39;, &#39;nucleus&#39;, &#39;pathogen&#39;,&#39;cytoplasm&#39;]</span>
<span class="c1">#    include_multinucleated, include_multiinfected, include_noninfected = True, 2.0, True</span>
<span class="c1">#    df, _ = spacr.io._read_and_merge_data(db_loc, </span>
<span class="c1">#                                 tables,</span>
<span class="c1">#                                 verbose=verbose,</span>
<span class="c1">#                                 include_multinucleated=include_multinucleated,</span>
<span class="c1">#                                 include_multiinfected=include_multiinfected,</span>
<span class="c1">#                                 include_noninfected=include_noninfected)</span>
<span class="c1">#    </span>
<span class="c1">#    df[&#39;recruitment&#39;] = df[f&#39;pathogen_channel_{channel_of_interest}_outside_75_percentile&#39;]/df[f&#39;cytoplasm_channel_{channel_of_interest}_mean_intensity&#39;]</span>
<span class="c1">#</span>
<span class="c1">#    spacr.plot._plot_plates(df, variable, grouping, min_max, cmap, min_count)</span>
<span class="c1">#    #display(df)</span>
<span class="c1">#    #for col in df.columns:</span>
<span class="c1">#    #    print(col)</span>
<span class="c1">#    return</span>

<span class="c1">#from finetune cellpose</span>
<span class="c1">#def plot_arrays(src, figuresize=50, cmap=&#39;inferno&#39;, nr=1, normalize=True, q1=1, q2=99):</span>
<span class="c1">#    paths = []</span>
<span class="c1">#    for file in os.listdir(src):</span>
<span class="c1">#        if file.endswith(&#39;.tif&#39;) or file.endswith(&#39;.tiff&#39;):</span>
<span class="c1">#            path = os.path.join(src, file)</span>
<span class="c1">#            paths.append(path)</span>
<span class="c1">#    paths = random.sample(paths, nr)</span>
<span class="c1">#    for path in paths:</span>
<span class="c1">#        print(f&#39;Image path:{path}&#39;)</span>
<span class="c1">#        img = cv2.imread(path, cv2.IMREAD_UNCHANGED)</span>
<span class="c1">#        if normalize:</span>
<span class="c1">#            img = normalize_to_dtype(array=img, q1=q1, q2=q2)</span>
<span class="c1">#        dim = img.shape</span>
<span class="c1">#        if len(img.shape) &gt; 2:</span>
<span class="c1">#            array_nr = img.shape[2]</span>
<span class="c1">#            fig, axs = plt.subplots(1, array_nr, figsize=(figuresize, figuresize))</span>
<span class="c1">#            for channel in range(array_nr):</span>
<span class="c1">#                i = np.take(img, [channel], axis=2)</span>
<span class="c1">#                axs[channel].imshow(i, cmap=plt.get_cmap(cmap))</span>
<span class="c1">#                axs[channel].set_title(&#39;Channel &#39;+str(channel), size=24)</span>
<span class="c1">#                axs[channel].axis(&#39;off&#39;)</span>
<span class="c1">#        else:</span>
<span class="c1">#            fig, ax = plt.subplots(1, 1, figsize=(figuresize, figuresize))</span>
<span class="c1">#            ax.imshow(img, cmap=plt.get_cmap(cmap))</span>
<span class="c1">#            ax.set_title(&#39;Channel 0&#39;, size=24)</span>
<span class="c1">#            ax.axis(&#39;off&#39;)</span>
<span class="c1">#        fig.tight_layout()</span>
<span class="c1">#        plt.show()</span>
<span class="c1">#    return</span>

<div class="viewcode-block" id="print_mask_and_flows">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.print_mask_and_flows">[docs]</a>
<span class="k">def</span> <span class="nf">print_mask_and_flows</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flows</span><span class="p">,</span> <span class="n">overlay</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Adjust subplot layout</span>
    
    <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    
    <span class="c1"># Display original image or its first channel</span>
    <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected stack dimensionality.&quot;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    

    <span class="c1"># Overlay mask on original image if overlay is True</span>
    <span class="k">if</span> <span class="n">overlay</span><span class="p">:</span>
        <span class="n">mask_cmap</span> <span class="o">=</span> <span class="n">generate_mask_random_cmap</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>  <span class="c1"># Generate random colormap for mask</span>
        <span class="n">mask_overlay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>  <span class="c1"># Mask background</span>
        <span class="n">outlines</span> <span class="o">=</span> <span class="n">find_boundaries</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;thick&#39;</span><span class="p">)</span>  <span class="c1"># Find mask outlines</span>

        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span> <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_overlay</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mask_cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Overlay mask</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">outlines</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Add red outlines with thickness 2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mask with Overlay&#39;</span> <span class="k">if</span> <span class="n">overlay</span> <span class="k">else</span> <span class="s1">&#39;Mask&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># Display flow image or its first channel</span>
    <span class="k">if</span> <span class="n">flows</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flows</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">flows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="n">flow_image</span> <span class="o">=</span> <span class="n">flows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">flow_image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">flow_image</span> <span class="o">=</span> <span class="n">flow_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Use first channel for 3D</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flow_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected flow dimensionality or structure.&quot;</span><span class="p">)</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flows&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="plot_resize">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.plot_resize">[docs]</a>
<span class="k">def</span> <span class="nf">plot_resize</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">resized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">resized_labels</span><span class="p">):</span>
    <span class="c1"># Display an example image and label before and after resizing</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    
    <span class="c1"># Check if the image is grayscale; if so, add a colormap and keep dimensions correct</span>
    <span class="k">if</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Grayscale image</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># RGB or RGBA image</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resized_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Grayscale image</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resized_images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># RGB or RGBA image</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resized_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Resized Image&#39;</span><span class="p">)</span>

    <span class="c1"># Assuming labels are always grayscale (most common scenario)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Label&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">resized_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Resized Label&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="normalize_and_visualize">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.normalize_and_visualize">[docs]</a>
<span class="k">def</span> <span class="nf">normalize_and_visualize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">normalized_image</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function for visualization&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># Multi-channel image</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># Display the average over channels for visualization</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Grayscale image</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original &quot;</span> <span class="o">+</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalized_image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normalized_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>  <span class="c1"># Similarly, display the average over channels</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">normalized_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Normalized &quot;</span> <span class="o">+</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="visualize_masks">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.visualize_masks">[docs]</a>
<span class="k">def</span> <span class="nf">visualize_masks</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">mask3</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Masks Comparison&quot;</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="n">mask1</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">mask3</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Mask 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Mask 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Mask 3&#39;</span><span class="p">]):</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">generate_mask_random_cmap</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="c1"># If the mask is binary, we can skip normalization</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normalize the image for displaying purposes</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="visualize_cellpose_masks">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.visualize_cellpose_masks">[docs]</a>
<span class="k">def</span> <span class="nf">visualize_cellpose_masks</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize multiple masks with optional titles.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        masks (list of np.ndarray): A list of masks to visualize.</span>
<span class="sd">        titles (list of str, optional): A list of titles for the masks. If None, default titles will be used.</span>
<span class="sd">        comparison_title (str): Title for the entire figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">comparison_title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Masks Comparison for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">if</span> <span class="n">titles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Mask </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">))]</span>
    
    <span class="c1"># Ensure the length of titles matches the number of masks</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">),</span> <span class="s2">&quot;Number of titles and masks must match&quot;</span>
    
    <span class="n">num_masks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_masks</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">num_masks</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Adjusting figure size dynamically</span>
    
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">titles</span><span class="p">):</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">generate_mask_random_cmap</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="c1"># Normalize and display the mask</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">comparison_title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">results_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved figure to </span><span class="si">{</span><span class="n">fig_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>


    
<div class="viewcode-block" id="plot_comparison_results">
<a class="viewcode-back" href="../../spacr.html#spacr.plot.plot_comparison_results">[docs]</a>
<span class="k">def</span> <span class="nf">plot_comparison_results</span><span class="p">(</span><span class="n">comparison_results</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison_results</span><span class="p">)</span>
    <span class="n">df_melted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="n">df_jaccard</span> <span class="o">=</span> <span class="n">df_melted</span><span class="p">[</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;jaccard&#39;</span><span class="p">)]</span>
    <span class="n">df_dice</span> <span class="o">=</span> <span class="n">df_melted</span><span class="p">[</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;dice&#39;</span><span class="p">)]</span>
    <span class="n">df_boundary_f1</span> <span class="o">=</span> <span class="n">df_melted</span><span class="p">[</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;boundary_f1&#39;</span><span class="p">)]</span>
    <span class="n">df_ap</span> <span class="o">=</span> <span class="n">df_melted</span><span class="p">[</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;metric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;average_precision&#39;</span><span class="p">)]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    
    <span class="c1"># Jaccard Index Plot</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_jaccard</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_jaccard</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Jaccard Index by Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Jaccard Index&#39;</span><span class="p">)</span>
    <span class="c1"># Dice Coefficient Plot</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_dice</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_dice</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Dice Coefficient by Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dice Coefficient&#39;</span><span class="p">)</span>
    <span class="c1"># Border F1 scores</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_boundary_f1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_boundary_f1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Boundary F1 Score by Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Boundary F1 Score&#39;</span><span class="p">)</span>
    <span class="c1"># AP scores plot</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_ap</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgrey&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_ap</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Average Precision by Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Comparison&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average Precision&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Einar Birnir Olafsson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-XXXXXXX-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>