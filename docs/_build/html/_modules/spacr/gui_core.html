

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spacr.gui_core &mdash; spacr 1.0.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=45a07ac9" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=aec50437"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #005f73" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_spacr.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/index.html">spacr</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/index.html#submodules">Submodules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/app_classify/index.html">spacr.app_classify</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/app_mask/index.html">spacr.app_mask</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/app_measure/index.html">spacr.app_measure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/app_sequencing/index.html">spacr.app_sequencing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/core/index.html">spacr.core</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html">spacr.deep_spacr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html">spacr.gui</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_core/index.html">spacr.gui_core</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html">spacr.gui_elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_utils/index.html">spacr.gui_utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html">spacr.io</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/logger/index.html">spacr.logger</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/measure/index.html">spacr.measure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/ml/index.html">spacr.ml</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html">spacr.plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/sequencing/index.html">spacr.sequencing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/settings/index.html">spacr.settings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/sp_stats/index.html">spacr.sp_stats</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html">spacr.spacr_cellpose</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html">spacr.submodules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/timelapse/index.html">spacr.timelapse</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/toxo/index.html">spacr.toxo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html">spacr.utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/version/index.html">spacr.version</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #005f73" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spacr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spacr.gui_core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spacr.gui_core</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">ctypes</span><span class="o">,</span> <span class="nn">csv</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">ttk</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">filedialog</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">set_start_method</span>
<span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">ttk</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_tkagg</span> <span class="kn">import</span> <span class="n">FigureCanvasTkAgg</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">GPUtil</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">tracemalloc</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">shcore</span><span class="o">.</span><span class="n">SetProcessDpiAwareness</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">spacrProgressBar</span><span class="p">,</span> <span class="n">spacrButton</span><span class="p">,</span> <span class="n">spacrFrame</span><span class="p">,</span> <span class="n">spacrDropdownMenu</span> <span class="p">,</span> <span class="n">spacrSlider</span><span class="p">,</span> <span class="n">set_dark_style</span>

<span class="c1"># Define global variables</span>
<div class="viewcode-block" id="q">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.q">[docs]</a>
<span class="n">q</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="console_output">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.console_output">[docs]</a>
<span class="n">console_output</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="parent_frame">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.parent_frame">[docs]</a>
<span class="n">parent_frame</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="vars_dict">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.vars_dict">[docs]</a>
<span class="n">vars_dict</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="canvas">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.canvas">[docs]</a>
<span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="canvas_widget">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.canvas_widget">[docs]</a>
<span class="n">canvas_widget</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="scrollable_frame">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.scrollable_frame">[docs]</a>
<span class="n">scrollable_frame</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="progress_label">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.progress_label">[docs]</a>
<span class="n">progress_label</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="fig_queue">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.fig_queue">[docs]</a>
<span class="n">fig_queue</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="figures">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.figures">[docs]</a>
<span class="n">figures</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="figure_index">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.figure_index">[docs]</a>
<span class="n">figure_index</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="progress_bar">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.progress_bar">[docs]</a>
<span class="n">progress_bar</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="usage_bars">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.usage_bars">[docs]</a>
<span class="n">usage_bars</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="index_control">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.index_control">[docs]</a>
<span class="n">index_control</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="thread_control">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.thread_control">[docs]</a>
<span class="n">thread_control</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;run_thread&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;stop_requested&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>


<div class="viewcode-block" id="toggle_settings">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.toggle_settings">[docs]</a>
<span class="k">def</span> <span class="nf">toggle_settings</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes and displays a dropdown menu to toggle visibility of categorized GUI settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        button_scrollable_frame (tk.Widget): A scrollable frame where the dropdown menu will be placed.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If `vars_dict` is not initialized.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Imports setting categories and hides all setting widgets initially.</span>
<span class="sd">        - Adds a dropdown menu that lets users toggle the visibility of settings belonging to each category.</span>
<span class="sd">        - When a category is selected, it toggles visibility for all settings in that category.</span>
<span class="sd">        - Updates the dropdown appearance based on which categories are currently active.</span>

<span class="sd">    Globals:</span>
<span class="sd">        vars_dict (dict): A dictionary mapping setting keys to (label, widget, _, frame) tuples.</span>
<span class="sd">            Must be initialized before calling this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">vars_dict</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">categories</span>
    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">hide_all_settings</span>
    <span class="k">if</span> <span class="n">vars_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;vars_dict is not initialized.&quot;</span><span class="p">)</span>

    <span class="n">active_categories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">toggle_category</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">vars_dict</span><span class="p">:</span>
                <span class="n">label</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">vars_dict</span><span class="p">[</span><span class="n">setting</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">grid_info</span><span class="p">():</span>
                    <span class="n">label</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
                    <span class="n">frame</span><span class="o">.</span><span class="n">grid_remove</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                    <span class="n">widget</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
                    <span class="n">frame</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_category_select</span><span class="p">(</span><span class="n">selected_category</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">selected_category</span> <span class="o">==</span> <span class="s2">&quot;Select Category&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">selected_category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">toggle_category</span><span class="p">(</span><span class="n">categories</span><span class="p">[</span><span class="n">selected_category</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">selected_category</span> <span class="ow">in</span> <span class="n">active_categories</span><span class="p">:</span>
                <span class="n">active_categories</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">selected_category</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">active_categories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">selected_category</span><span class="p">)</span>
        <span class="n">category_dropdown</span><span class="o">.</span><span class="n">update_styles</span><span class="p">(</span><span class="n">active_categories</span><span class="p">)</span>
        <span class="n">category_var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;Select Category&quot;</span><span class="p">)</span>

    <span class="n">category_var</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">StringVar</span><span class="p">()</span>
    <span class="n">non_empty_categories</span> <span class="o">=</span> <span class="p">[</span><span class="n">category</span> <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">settings</span> <span class="ow">in</span> <span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">setting</span> <span class="ow">in</span> <span class="n">vars_dict</span> <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">)]</span>
    <span class="n">category_dropdown</span> <span class="o">=</span> <span class="n">spacrDropdownMenu</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">category_var</span><span class="p">,</span> <span class="n">non_empty_categories</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">on_category_select</span><span class="p">)</span>
    <span class="n">category_dropdown</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">vars_dict</span> <span class="o">=</span> <span class="n">hide_all_settings</span><span class="p">(</span><span class="n">vars_dict</span><span class="p">,</span> <span class="n">categories</span><span class="p">)</span></div>


<div class="viewcode-block" id="display_figure">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.display_figure">[docs]</a>
<span class="k">def</span> <span class="nf">display_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays a matplotlib figure within a Tkinter GUI canvas, enabling interactive features such as:</span>
<span class="sd">    - Zooming with mouse scroll</span>
<span class="sd">    - Navigation via left/right click</span>
<span class="sd">    - Context menu for saving or modifying the figure</span>
<span class="sd">    - Dynamic annotation visibility based on zoom level</span>

<span class="sd">    Args:</span>
<span class="sd">        fig (matplotlib.figure.Figure): The figure to display in the GUI.</span>

<span class="sd">    Global Variables:</span>
<span class="sd">        canvas (FigureCanvasTkAgg): The current canvas used for displaying the figure.</span>
<span class="sd">        canvas_widget (tk.Widget): The widget associated with the canvas.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Destroys any existing canvas before rendering the new figure.</span>
<span class="sd">        - Initializes zooming around cursor position using scroll wheel.</span>
<span class="sd">        - Binds left/right clicks to navigate between figures (via show_previous_figure / show_next_figure).</span>
<span class="sd">        - Adds a right-click context menu to save as PNG/PDF, modify figure, or reset zoom.</span>
<span class="sd">        - Preserves original axis limits for reset functionality.</span>
<span class="sd">        - Dynamically toggles text label visibility depending on zoom.</span>
<span class="sd">        - Applies consistent dark theme styling for background and context menu.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Assumes `show_previous_figure()`, `show_next_figure()`, `set_dark_style()`, </span>
<span class="sd">          `save_figure_as_format()`, `modify_figure()`, and `process_fig_queue()` are defined elsewhere.</span>
<span class="sd">        - Should be called after global `canvas` and `canvas_widget` have been initialized.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If canvas_widget is not properly initialized prior to calling this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span>

    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">save_figure_as_format</span><span class="p">,</span> <span class="n">modify_figure</span>

    <span class="c1"># Apply the dark style to the context menu</span>
    <span class="n">style_out</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">())</span>
    <span class="n">bg_color</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">]</span>
    <span class="n">fg_color</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">]</span>

    <span class="c1"># Initialize the scale factor for zooming</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># Save the original x and y limits of the first axis (assuming all axes have the same limits)</span>
    <span class="n">original_xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()]</span>
    <span class="n">original_ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()]</span>

    <span class="c1"># Clear previous canvas content</span>
    <span class="k">if</span> <span class="n">canvas</span><span class="p">:</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="c1"># Create a new canvas for the figure</span>
    <span class="n">new_canvas</span> <span class="o">=</span> <span class="n">FigureCanvasTkAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">master</span><span class="p">)</span>
    <span class="n">new_canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="n">new_canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">)</span>
    
    <span class="c1"># Store existing text labels on each axis for zoom visibility control (new feature)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">():</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">texts</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">_label_annotations</span> <span class="o">=</span> <span class="n">texts</span>

    <span class="c1"># Update the global canvas and canvas_widget references</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">new_canvas</span>
    <span class="n">canvas_widget</span> <span class="o">=</span> <span class="n">new_canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span>
    <span class="n">canvas_widget</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="n">bg_color</span><span class="p">)</span>

    <span class="c1"># Create the context menu</span>
    <span class="n">context_menu</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Menu</span><span class="p">(</span><span class="n">canvas_widget</span><span class="p">,</span> <span class="n">tearoff</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="n">fg_color</span><span class="p">)</span>
    <span class="n">context_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Save Figure as PDF&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">save_figure_as_format</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">))</span>
    <span class="n">context_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Save Figure as PNG&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">save_figure_as_format</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">))</span>
    <span class="n">context_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Modify Figure&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">modify_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">))</span>
    <span class="n">context_menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reset Zoom&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">reset_zoom</span><span class="p">(</span><span class="n">fig</span><span class="p">))</span>  <span class="c1"># Add Reset Zoom option</span>

    <span class="k">def</span> <span class="nf">reset_zoom</span><span class="p">(</span><span class="n">fig</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">scale_factor</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Reset the scale factor</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">original_xlim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">original_ylim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_right_click</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">context_menu</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">x_root</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y_root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_hover</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">widget_width</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span>
        <span class="n">x_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span>

        <span class="k">if</span> <span class="n">x_position</span> <span class="o">&lt;</span> <span class="n">widget_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">canvas_widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="s2">&quot;hand2&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">canvas_widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="s2">&quot;hand2&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_leave</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="s2">&quot;arrow&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flash_feedback</span><span class="p">(</span><span class="n">side</span><span class="p">):</span>
        <span class="n">flash</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="p">(</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">master</span><span class="p">)</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">overrideredirect</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">flash_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">flash_height</span> <span class="o">=</span> <span class="n">canvas_widget</span><span class="o">.</span><span class="n">winfo_height</span><span class="p">()</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="s1">&#39;-alpha&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
            <span class="n">flash</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flash_width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">flash_height</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">winfo_rootx</span><span class="p">()</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">winfo_rooty</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flash_width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">flash_height</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">winfo_rootx</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">flash_width</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">canvas_widget</span><span class="o">.</span><span class="n">winfo_rooty</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flash</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>

        <span class="c1"># Ensure the flash covers the correct area only</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">flash</span><span class="o">.</span><span class="n">destroy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_click</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">widget_width</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span>
        <span class="n">x_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span>

        <span class="k">if</span> <span class="n">x_position</span> <span class="o">&lt;</span> <span class="n">widget_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1">#flash_feedback(&quot;left&quot;)</span>
            <span class="n">show_previous_figure</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#flash_feedback(&quot;right&quot;)</span>
            <span class="n">show_next_figure</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">zoom</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">zoom_in_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">1.2</span>
        <span class="n">zoom_out_factor</span> <span class="o">=</span> <span class="mf">1.2</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">zoom_in_factor</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">zoom_out_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Find the axis under the cursor</span>
        <span class="n">ref_ax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">canvas</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_axes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
                <span class="n">ref_ax</span> <span class="o">=</span> <span class="n">ax</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">ref_ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert mouse position to data coords in reference axis</span>
            <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span> <span class="o">=</span> <span class="n">ref_ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Get current limits</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">ref_ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ref_ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="c1"># Compute new limits for the reference axis</span>
        <span class="n">new_xlim</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">data_x</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_x</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
            <span class="n">data_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="p">]</span>
        <span class="n">new_ylim</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">data_y</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_y</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
            <span class="n">data_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="p">]</span>

        <span class="c1"># Apply the same limits to all axes</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">canvas</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_axes</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">new_xlim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">new_ylim</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">texts</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;_label_annotations&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">_label_annotations</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
                    <span class="n">visible</span> <span class="o">=</span> <span class="n">new_xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">new_xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">new_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">new_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">visible</span><span class="p">)</span>

        <span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">zoom_v1</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c1"># Fixed zoom factors (adjust these if you want faster or slower zoom)</span>
        <span class="n">zoom_in_factor</span> <span class="o">=</span> <span class="mf">0.9</span>   <span class="c1"># When zooming in, ranges shrink by 10%</span>
        <span class="n">zoom_out_factor</span> <span class="o">=</span> <span class="mf">1.1</span>  <span class="c1"># When zooming out, ranges increase by 10%</span>

        <span class="c1"># Determine the zoom direction based on the scroll event</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># Scroll up = zoom in</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">zoom_in_factor</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># Scroll down = zoom out</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">zoom_out_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># No recognized scroll direction</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">canvas</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">get_axes</span><span class="p">():</span>
            <span class="c1"># Get the current mouse position in pixel coordinates</span>
            <span class="n">mouse_x</span><span class="p">,</span> <span class="n">mouse_y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span>

            <span class="c1"># Convert pixel coordinates to data coordinates</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span>
            <span class="n">data_x</span><span class="p">,</span> <span class="n">data_y</span> <span class="o">=</span> <span class="n">inv</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">mouse_x</span><span class="p">,</span> <span class="n">mouse_y</span><span class="p">))</span>

            <span class="c1"># Get the current axis limits</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="c1"># Calculate the zooming range around the cursor position</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">y_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span>

            <span class="c1"># Adjust the limits while keeping the mouse position fixed</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">data_x</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_x</span> <span class="o">-</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">data_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">data_y</span> <span class="o">-</span> <span class="p">(</span><span class="n">data_y</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">data_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span><span class="p">])</span>

        <span class="c1"># Redraw the figure efficiently</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

    <span class="c1"># Bind events for hover, click interactions, and zoom</span>
    <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Motion&gt;&quot;</span><span class="p">,</span> <span class="n">on_hover</span><span class="p">)</span>
    <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Leave&gt;&quot;</span><span class="p">,</span> <span class="n">on_leave</span><span class="p">)</span>
    <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-1&gt;&quot;</span><span class="p">,</span> <span class="n">on_click</span><span class="p">)</span>
    <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-3&gt;&quot;</span><span class="p">,</span> <span class="n">on_right_click</span><span class="p">)</span>

    <span class="c1"># Detect the operating system and bind the appropriate mouse wheel events</span>
    <span class="n">current_os</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">current_os</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;MouseWheel&gt;&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>  <span class="c1"># Windows</span>
    <span class="k">elif</span> <span class="n">current_os</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;MouseWheel&gt;&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-4&gt;&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>  <span class="c1"># Scroll up</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-5&gt;&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>  <span class="c1"># Scroll down</span>
    <span class="k">elif</span> <span class="n">current_os</span> <span class="o">==</span> <span class="s2">&quot;Linux&quot;</span><span class="p">:</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-4&gt;&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>  <span class="c1"># Linux Scroll up</span>
        <span class="n">canvas_widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Button-5&gt;&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>  <span class="c1"># Linux Scroll down</span>
        
    <span class="n">process_fig_queue</span><span class="p">()</span></div>


<div class="viewcode-block" id="clear_unused_figures">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.clear_unused_figures">[docs]</a>
<span class="k">def</span> <span class="nf">clear_unused_figures</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clears figures from memory that are not within ±20 of the current figure index to reduce memory usage.</span>

<span class="sd">    Globals:</span>
<span class="sd">        figures (collections.deque): A deque of currently stored matplotlib figures.</span>
<span class="sd">        figure_index (int): Index of the currently displayed figure.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Retains only figures within 20 indices before and after the current figure_index.</span>
<span class="sd">        - Updates the figure_index to remain within valid bounds of the updated figures deque.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">figures</span><span class="p">,</span> <span class="n">figure_index</span>

    <span class="n">lower_bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">figure_index</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">),</span> <span class="n">figure_index</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span>
    <span class="c1"># Clear figures outside of the +/- 20 range</span>
    <span class="n">figures</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">fig</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="k">if</span> <span class="n">lower_bound</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">])</span>
    <span class="c1"># Update the figure index after clearing</span>
    <span class="n">figure_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">figure_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_previous_figure">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.show_previous_figure">[docs]</a>
<span class="k">def</span> <span class="nf">show_previous_figure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays the previous figure in the global figures list, if available.</span>

<span class="sd">    Globals:</span>
<span class="sd">        figure_index (int): Current index of the displayed figure.</span>
<span class="sd">        figures (list): List of matplotlib figures.</span>
<span class="sd">        fig_queue (queue.Queue): Queue of figures to be displayed later (unused here).</span>
<span class="sd">        index_control (tk.IntVar or custom object): UI controller for setting and tracking current index.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Decrements figure_index.</span>
<span class="sd">        - Standardizes and displays the previous figure.</span>
<span class="sd">        - Updates index_control to reflect the new figure index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">standardize_figure</span>
    <span class="k">global</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">index_control</span>
    
    <span class="k">if</span> <span class="n">figure_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figure_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">figure_index</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">figure_index</span><span class="p">)</span>
        <span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
        <span class="n">display_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span></div>

        <span class="c1">#clear_unused_figures()</span>

<div class="viewcode-block" id="show_next_figure">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.show_next_figure">[docs]</a>
<span class="k">def</span> <span class="nf">show_next_figure</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays the next figure in the figures list or loads one from the queue if at the end.</span>

<span class="sd">    Globals:</span>
<span class="sd">        figure_index (int): Current index of the displayed figure.</span>
<span class="sd">        figures (list): List of existing matplotlib figures.</span>
<span class="sd">        fig_queue (queue.Queue): Queue of figures to display when user navigates forward.</span>
<span class="sd">        index_control (tk.IntVar or custom object): UI control to sync figure index display.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - If not at the end of figures list, increments index and displays the next figure.</span>
<span class="sd">        - If at the end and the figure queue is not empty, loads and displays the next figure from the queue.</span>
<span class="sd">        - Updates index_control to reflect the current position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">standardize_figure</span>
    <span class="k">global</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">index_control</span>
    <span class="k">if</span> <span class="n">figure_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figure_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">figure_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">figure_index</span><span class="p">)</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set_to</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
        <span class="n">display_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
        <span class="c1">#clear_unused_figures()</span>
        
    <span class="k">elif</span> <span class="n">figure_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fig_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">fig_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">figure_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">figure_index</span><span class="p">)</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set_to</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">display_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="process_fig_queue">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.process_fig_queue">[docs]</a>
<span class="k">def</span> <span class="nf">process_fig_queue</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes the figure queue and updates the GUI with new figures as they arrive.</span>

<span class="sd">    Globals:</span>
<span class="sd">        canvas (FigureCanvasTkAgg): The current canvas displaying the figure.</span>
<span class="sd">        fig_queue (queue.Queue): Queue containing matplotlib figures to be displayed.</span>
<span class="sd">        canvas_widget (tk.Widget): The widget holding the canvas.</span>
<span class="sd">        parent_frame (tk.Frame): Parent frame that manages periodic GUI updates.</span>
<span class="sd">        uppdate_frequency (int): Delay in milliseconds between re-checking the queue.</span>
<span class="sd">        figures (collections.deque): A deque holding all currently active figures.</span>
<span class="sd">        figure_index (int): Index of the currently displayed figure.</span>
<span class="sd">        index_control (tk.IntVar or similar): Control object for syncing figure index in GUI.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Retrieves and displays figures from fig_queue.</span>
<span class="sd">        - Standardizes figure appearance using `standardize_figure`.</span>
<span class="sd">        - Maintains a fixed-size deque (max 100) by discarding oldest figures.</span>
<span class="sd">        - If no figure is currently displayed, it displays the first one.</span>
<span class="sd">        - Sets slider/index control to match the latest figure.</span>
<span class="sd">        - Reschedules itself using `after()` to poll for new figures continuously.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">uppdate_frequency</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">index_control</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">standardize_figure</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">fig_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">fig_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Retrieved a None figure from fig_queue.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Standardize the figure appearance before adding it</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">standardize_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

            <span class="c1"># OPTIONAL: Cap the size of the figures deque at 100</span>
            <span class="n">MAX_FIGURES</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_FIGURES</span><span class="p">:</span>
                <span class="c1"># Discard the oldest figure</span>
                <span class="n">old_fig</span> <span class="o">=</span> <span class="n">figures</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="c1"># If needed, you could also close the figure to free memory:</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">old_fig</span><span class="p">)</span>

            <span class="c1"># Update slider maximum</span>
            <span class="n">index_control</span><span class="o">.</span><span class="n">set_to</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># If no figure has been displayed yet</span>
            <span class="k">if</span> <span class="n">figure_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">figure_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">display_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
                <span class="n">index_control</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">figure_index</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception in process_fig_queue:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Schedule process_fig_queue() to run again</span>
        <span class="n">after_id</span> <span class="o">=</span> <span class="n">canvas_widget</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">uppdate_frequency</span><span class="p">,</span> <span class="n">process_fig_queue</span><span class="p">)</span>
        <span class="n">parent_frame</span><span class="o">.</span><span class="n">after_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">after_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_figure">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.update_figure">[docs]</a>
<span class="k">def</span> <span class="nf">update_figure</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the currently displayed figure based on slider value.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (str or int): Index of the figure to display.</span>
<span class="sd">    </span>
<span class="sd">    Globals:</span>
<span class="sd">        figure_index (int): Index of the current figure.</span>
<span class="sd">        figures (deque): Deque of matplotlib figures.</span>
<span class="sd">        index_control (spacrSlider): Slider control for index selection.</span>

<span class="sd">    Effects:</span>
<span class="sd">        - Updates the canvas with the selected figure.</span>
<span class="sd">        - Applies standard formatting to the figure.</span>
<span class="sd">        - Sets the slider and index state accordingly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">standardize_figure</span>
    <span class="k">global</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">index_control</span>
    
    <span class="c1"># Convert the value to an integer</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    
    <span class="c1"># Check if the index is valid</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">):</span>
        <span class="n">figure_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
        <span class="n">display_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">figure_index</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;update_figure called with value:&quot;</span><span class="p">,</span> <span class="n">figure_index</span><span class="p">)</span>
        <span class="n">index_control</span><span class="o">.</span><span class="n">set_to</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="setup_plot_section">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_plot_section">[docs]</a>
<span class="k">def</span> <span class="nf">setup_plot_section</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the figure display section and associated slider for navigating figures.</span>

<span class="sd">    Args:</span>
<span class="sd">        vertical_container (tk.PanedWindow or tk.Frame): Parent container.</span>
<span class="sd">        settings_type (str): Mode to configure specific behaviors (e.g. &#39;map_barcodes&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (canvas, canvas_widget)</span>

<span class="sd">    Globals:</span>
<span class="sd">        canvas, canvas_widget: For figure rendering.</span>
<span class="sd">        figures (deque): Storage of figures.</span>
<span class="sd">        figure_index (int): Current index.</span>
<span class="sd">        index_control (spacrSlider): Slider widget for navigating figure list.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Displays initial blank figure.</span>
<span class="sd">        - Adds slider for figure navigation.</span>
<span class="sd">        - Applies dark style.</span>
<span class="sd">        - Optionally shows media for &#39;map_barcodes&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">index_control</span>
    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">display_media_in_plot_frame</span>

    <span class="n">style_out</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">())</span>
    <span class="n">bg</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">]</span>
    <span class="n">fg</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">]</span>

    <span class="c1"># Initialize deque for storing figures and the current index</span>
    <span class="n">figures</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
    <span class="n">figure_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Start with no figure displayed</span>

    <span class="c1"># Create a frame for the plot section</span>
    <span class="n">plot_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">)</span>
    <span class="n">plot_frame</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="n">bg</span><span class="p">)</span>
    <span class="n">vertical_container</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">plot_frame</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>

    <span class="c1"># Clear the plot_frame (optional)</span>
    <span class="k">for</span> <span class="n">widget</span> <span class="ow">in</span> <span class="n">plot_frame</span><span class="o">.</span><span class="n">winfo_children</span><span class="p">():</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="c1"># Create a figure and plot (initial figure)</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plot</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[])</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;map_barcodes&#39;</span><span class="p">:</span>
        <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">resources_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;icons&#39;</span><span class="p">)</span>
        <span class="c1">#gif_path = os.path.join(resources_path, &#39;dna_matrix.mp4&#39;)</span>
        <span class="c1">#display_media_in_plot_frame(gif_path, plot_frame)</span>

        <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasTkAgg</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">plot_frame</span><span class="p">)</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="s1">&#39;arrow&#39;</span><span class="p">,</span> <span class="n">highlightthickness</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">canvas_widget</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span>
    
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasTkAgg</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">master</span><span class="o">=</span><span class="n">plot_frame</span><span class="p">)</span>
    <span class="n">canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="s1">&#39;arrow&#39;</span><span class="p">,</span> <span class="n">highlightthickness</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">canvas_widget</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span>
    <span class="n">canvas_widget</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">)</span>
    <span class="n">plot_frame</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="n">canvas</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">figure</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
    <span class="n">containers</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_frame</span><span class="p">]</span>

    <span class="c1"># Create slider</span>
    <span class="n">control_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">plot_frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">15</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>  <span class="n">bg</span><span class="o">=</span><span class="n">bg</span><span class="p">)</span>
    <span class="n">control_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">control_frame</span><span class="o">.</span><span class="n">grid_propagate</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">index_control</span> <span class="o">=</span> <span class="n">spacrSlider</span><span class="p">(</span><span class="n">control_frame</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">knob_radius</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">position</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">show_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">update_figure</span><span class="p">)</span>
    
    <span class="n">index_control</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;ew&quot;</span><span class="p">)</span>
    <span class="n">control_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">canvas_widget</span><span class="p">,</span> <span class="n">index_control</span><span class="p">]</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">containers</span><span class="o">=</span><span class="n">containers</span><span class="p">,</span> <span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">)</span>

    <span class="c1"># Now ensure the first figure is displayed and recognized:</span>
    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
    <span class="n">figure_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">display_figure</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
    <span class="n">index_control</span><span class="o">.</span><span class="n">set_to</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># Slider max = 0 in this case, since there&#39;s only one figure</span>
    <span class="n">index_control</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">figure_index</span><span class="p">)</span>          <span class="c1"># Set slider to 0 to indicate the first figure</span>

    <span class="k">return</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span></div>


<div class="viewcode-block" id="set_globals">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.set_globals">[docs]</a>
<span class="k">def</span> <span class="nf">set_globals</span><span class="p">(</span><span class="n">thread_control_var</span><span class="p">,</span> <span class="n">q_var</span><span class="p">,</span> <span class="n">console_output_var</span><span class="p">,</span> <span class="n">parent_frame_var</span><span class="p">,</span> <span class="n">vars_dict_var</span><span class="p">,</span> <span class="n">canvas_var</span><span class="p">,</span> <span class="n">canvas_widget_var</span><span class="p">,</span> <span class="n">scrollable_frame_var</span><span class="p">,</span> <span class="n">fig_queue_var</span><span class="p">,</span> <span class="n">progress_bar_var</span><span class="p">,</span> <span class="n">usage_bars_var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns external references to global variables for use throughout the GUI.</span>

<span class="sd">    Args:</span>
<span class="sd">        *_var: Various widget and control object references.</span>

<span class="sd">    Globals Set:</span>
<span class="sd">        thread_control, q, console_output, parent_frame, vars_dict,</span>
<span class="sd">        canvas, canvas_widget, scrollable_frame, fig_queue,</span>
<span class="sd">        progress_bar, usage_bars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">thread_control</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">console_output</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">,</span> <span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">usage_bars</span>
    <span class="n">thread_control</span> <span class="o">=</span> <span class="n">thread_control_var</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q_var</span>
    <span class="n">console_output</span> <span class="o">=</span> <span class="n">console_output_var</span>
    <span class="n">parent_frame</span> <span class="o">=</span> <span class="n">parent_frame_var</span>
    <span class="n">vars_dict</span> <span class="o">=</span> <span class="n">vars_dict_var</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas_var</span>
    <span class="n">canvas_widget</span> <span class="o">=</span> <span class="n">canvas_widget_var</span>
    <span class="n">scrollable_frame</span> <span class="o">=</span> <span class="n">scrollable_frame_var</span>
    <span class="n">fig_queue</span> <span class="o">=</span> <span class="n">fig_queue_var</span>
    <span class="c1">#figures = figures_var</span>
    <span class="c1">#figure_index = figure_index_var</span>
    <span class="c1">#index_control = index_control_var</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">progress_bar_var</span>
    <span class="n">usage_bars</span> <span class="o">=</span> <span class="n">usage_bars_var</span></div>


<div class="viewcode-block" id="import_settings">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.import_settings">[docs]</a>
<span class="k">def</span> <span class="nf">import_settings</span><span class="p">(</span><span class="n">settings_type</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports a settings CSV and applies it to the GUI panel for a specific mode.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings_type (str): Type of settings to load (&#39;mask&#39;, &#39;measure&#39;, &#39;classify&#39;, etc.)</span>

<span class="sd">    Globals:</span>
<span class="sd">        vars_dict: Dictionary of GUI widget references.</span>
<span class="sd">        scrollable_frame: Frame that holds the settings widgets.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Reads key-value settings from CSV.</span>
<span class="sd">        - Applies them to the current settings panel.</span>
<span class="sd">        - Updates `vars_dict` accordingly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">button_scrollable_frame</span>

    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">convert_settings_dict_for_gui</span><span class="p">,</span> <span class="n">hide_all_settings</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">generate_fields</span><span class="p">,</span> <span class="n">set_default_settings_preprocess_generate_masks</span><span class="p">,</span> <span class="n">get_measure_crop_settings</span><span class="p">,</span> <span class="n">set_default_train_test_model</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_default_generate_barecode_mapping</span><span class="p">,</span> <span class="n">set_default_umap_image_settings</span><span class="p">,</span> <span class="n">get_analyze_recruitment_default_settings</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">get_default_generate_activation_map_settings</span><span class="p">,</span> <span class="n">get_analyze_plaque_settings</span>

    <span class="k">def</span> <span class="nf">read_settings_from_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
                <span class="n">settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">settings</span>

    <span class="k">def</span> <span class="nf">update_settings_from_csv</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">csv_settings</span><span class="p">):</span>
        <span class="n">new_settings</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Start with a copy of the original settings</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">csv_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_settings</span><span class="p">:</span>
                <span class="c1"># Get the variable type and options from the original settings</span>
                <span class="n">var_type</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">new_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># Update the default value with the CSV value, keeping the type and options unchanged</span>
                <span class="n">new_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_type</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_settings</span>

    <span class="n">csv_file_path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span><span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;CSV files&quot;</span><span class="p">,</span> <span class="s2">&quot;*.csv&quot;</span><span class="p">)])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">csv_file_path</span><span class="p">:</span>  <span class="c1"># If no file is selected, return early</span>
        <span class="k">return</span>
    
    <span class="c1">#vars_dict = hide_all_settings(vars_dict, categories=None)</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">read_settings_from_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_settings_preprocess_generate_masks</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;measure&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_measure_crop_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;classify&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_train_test_model</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;sequencing&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_generate_barecode_mapping</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;umap&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_umap_image_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;recruitment&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_analyze_recruitment_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;activation&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_default_generate_activation_map_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;analyze_plaques&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_analyze_plaque_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;convert&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid settings type: </span><span class="si">{</span><span class="n">settings_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">variables</span> <span class="o">=</span> <span class="n">convert_settings_dict_for_gui</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">new_settings</span> <span class="o">=</span> <span class="n">update_settings_from_csv</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">csv_settings</span><span class="p">)</span>
    <span class="n">vars_dict</span> <span class="o">=</span> <span class="n">generate_fields</span><span class="p">(</span><span class="n">new_settings</span><span class="p">,</span> <span class="n">scrollable_frame</span><span class="p">)</span>
    <span class="n">vars_dict</span> <span class="o">=</span> <span class="n">hide_all_settings</span><span class="p">(</span><span class="n">vars_dict</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="setup_settings_panel">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_settings_panel">[docs]</a>
<span class="k">def</span> <span class="nf">setup_settings_panel</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">,</span> <span class="n">settings_type</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the scrollable settings panel for a given analysis type.</span>

<span class="sd">    Args:</span>
<span class="sd">        vertical_container (tk.PanedWindow or tk.Frame): Parent container.</span>
<span class="sd">        settings_type (str): One of the predefined modes such as &#39;mask&#39;, &#39;classify&#39;, etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (scrollable_frame, vars_dict)</span>

<span class="sd">    Globals:</span>
<span class="sd">        vars_dict: Dict mapping setting names to widget metadata.</span>
<span class="sd">        scrollable_frame: Frame containing all input widgets.</span>

<span class="sd">    Behavior:</span>
<span class="sd">        - Initializes and populates settings UI.</span>
<span class="sd">        - Loads defaults depending on `settings_type`.</span>
<span class="sd">        - Applies theme and layout configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">scrollable_frame</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">get_identify_masks_finetune_default_settings</span><span class="p">,</span> <span class="n">set_default_analyze_screen</span><span class="p">,</span> <span class="n">set_default_settings_preprocess_generate_masks</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">get_measure_crop_settings</span><span class="p">,</span> <span class="n">deep_spacr_defaults</span><span class="p">,</span> <span class="n">set_default_generate_barecode_mapping</span><span class="p">,</span> <span class="n">set_default_umap_image_settings</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">get_map_barcodes_default_settings</span><span class="p">,</span> <span class="n">get_analyze_recruitment_default_settings</span><span class="p">,</span> <span class="n">get_check_cellpose_models_default_settings</span><span class="p">,</span> <span class="n">get_analyze_plaque_settings</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">generate_fields</span><span class="p">,</span> <span class="n">get_perform_regression_default_settings</span><span class="p">,</span> <span class="n">get_train_cellpose_default_settings</span><span class="p">,</span> <span class="n">get_default_generate_activation_map_settings</span>
    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">convert_settings_dict_for_gui</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">set_element_size</span>

    <span class="n">size_dict</span> <span class="o">=</span> <span class="n">set_element_size</span><span class="p">()</span>
    
    <span class="n">settings_width</span> <span class="o">=</span> <span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;settings_width&#39;</span><span class="p">]</span>
        
    <span class="c1"># Create a PanedWindow for the settings panel</span>
    <span class="n">settings_paned_window</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">PanedWindow</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="n">tk</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">settings_width</span><span class="p">)</span>
    <span class="n">vertical_container</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">settings_paned_window</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>

    <span class="n">settings_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">settings_paned_window</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">settings_width</span><span class="p">)</span>
    <span class="n">settings_frame</span><span class="o">.</span><span class="n">pack_propagate</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">settings_paned_window</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">settings_frame</span><span class="p">)</span>
    <span class="c1">#settings_paned_window.add(settings_frame, width=settings_width)</span>
    

    <span class="n">scrollable_frame</span> <span class="o">=</span> <span class="n">spacrFrame</span><span class="p">(</span><span class="n">settings_frame</span><span class="p">)</span>
    <span class="n">scrollable_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">)</span>
    <span class="n">settings_frame</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">settings_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_settings_preprocess_generate_masks</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;measure&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_measure_crop_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;classify&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">deep_spacr_defaults</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;umap&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_umap_image_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;train_cellpose&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_train_cellpose_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;ml_analyze&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_analyze_screen</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;cellpose_masks&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_identify_masks_finetune_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;cellpose_all&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_check_cellpose_models_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;map_barcodes&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_generate_barecode_mapping</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;regression&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_perform_regression_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;recruitment&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_analyze_recruitment_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;activation&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_default_generate_activation_map_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;analyze_plaques&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">get_analyze_plaque_settings</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">elif</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;convert&#39;</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src&#39;</span><span class="p">:</span><span class="s1">&#39;path to images&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid settings type: </span><span class="si">{</span><span class="n">settings_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="n">convert_settings_dict_for_gui</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">vars_dict</span> <span class="o">=</span> <span class="n">generate_fields</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">scrollable_frame</span><span class="p">)</span>
    
    <span class="n">containers</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings_frame</span><span class="p">]</span>
    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">scrollable_frame</span><span class="p">]</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">containers</span><span class="o">=</span><span class="n">containers</span><span class="p">,</span> <span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Settings panel setup complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">vars_dict</span></div>


<div class="viewcode-block" id="setup_console">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_console">[docs]</a>
<span class="k">def</span> <span class="nf">setup_console</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up a scrollable console output section with hover effect and dark theme styling.</span>

<span class="sd">    Args:</span>
<span class="sd">        vertical_container (tk.PanedWindow or tk.Frame): Parent container to attach the console.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            console_output (tk.Text): The text widget for console output.</span>
<span class="sd">            console_frame (tk.Frame): The frame containing the console.</span>

<span class="sd">    Globals Set:</span>
<span class="sd">        console_output: Reference to the console&#39;s text widget.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">console_output</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">set_dark_style</span>
    
    <span class="c1"># Apply dark style and get style output</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
    <span class="n">style_out</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>

    <span class="c1"># Create a frame for the console section</span>
    <span class="n">console_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">])</span>
    <span class="n">vertical_container</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">console_frame</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>

    <span class="c1"># Create a thicker frame at the top for the hover effect</span>
    <span class="n">top_border</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">console_frame</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">])</span>
    <span class="n">top_border</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;ew&quot;</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Create the scrollable frame (which is a Text widget) with white text</span>
    <span class="n">family</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;font_family&#39;</span><span class="p">]</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;font_size&#39;</span><span class="p">]</span>
    <span class="n">font_loader</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;font_loader&#39;</span><span class="p">]</span>
    <span class="n">console_output</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">console_frame</span><span class="p">,</span> <span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">],</span> <span class="n">fg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">],</span> <span class="n">font</span><span class="o">=</span><span class="n">font_loader</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span> <span class="n">bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">highlightthickness</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">console_output</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">)</span>  <span class="c1"># Use grid for console_output</span>

    <span class="c1"># Configure the grid to allow expansion</span>
    <span class="n">console_frame</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">console_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_enter</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">top_border</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;active_color&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">on_leave</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">top_border</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">])</span>

    <span class="c1">#def on_enter_key(event):</span>
    <span class="c1">#    user_input = console_output.get(&quot;1.0&quot;, &quot;end-1c&quot;).strip()  # Get the user input from the console</span>
    <span class="c1">#    if user_input:</span>
    <span class="c1">#        # Print the user input with the (user) tag</span>
    <span class="c1">#        console_output.insert(&quot;end&quot;, f&quot;\n(user): {user_input}\n&quot;)</span>
    <span class="c1">#        </span>
    <span class="c1">#        # Get the AI response from the chatbot</span>
    <span class="c1">#        response = chatbot.ask_question(user_input)</span>
    <span class="c1">#        </span>
    <span class="c1">#        # Print the AI response with the (ai) tag</span>
    <span class="c1">#        console_output.insert(&quot;end&quot;, f&quot;(ai): {response}\n&quot;)</span>
    <span class="c1">#        </span>
    <span class="c1">#        console_output.see(&quot;end&quot;)  # Scroll to the end</span>
    <span class="c1">#        #console_output.delete(&quot;1.0&quot;, &quot;end&quot;)  # Clear the input field</span>
    <span class="c1">#    return &quot;break&quot;  # Prevent the default behavior of inserting a new line</span>

    <span class="n">console_output</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Enter&gt;&quot;</span><span class="p">,</span> <span class="n">on_enter</span><span class="p">)</span>
    <span class="n">console_output</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;&lt;Leave&gt;&quot;</span><span class="p">,</span> <span class="n">on_leave</span><span class="p">)</span>

    <span class="c1">#console_output.bind(&quot;&lt;Return&gt;&quot;, on_enter_key)</span>

    <span class="k">return</span> <span class="n">console_output</span><span class="p">,</span> <span class="n">console_frame</span></div>


<div class="viewcode-block" id="setup_button_section">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_button_section">[docs]</a>
<span class="k">def</span> <span class="nf">setup_button_section</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">,</span> <span class="n">settings_type</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">import_btn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the button section with control buttons (run, abort, download, import) and a progress bar.</span>

<span class="sd">    Args:</span>
<span class="sd">        horizontal_container (tk.PanedWindow or tk.Frame): Container to add the button section.</span>
<span class="sd">        settings_type (str): Workflow type to adjust button behavior.</span>
<span class="sd">        run (bool): Whether to include a &quot;Run&quot; button.</span>
<span class="sd">        abort (bool): Whether to include an &quot;Abort&quot; button.</span>
<span class="sd">        download (bool): Whether to include a &quot;Download&quot; button.</span>
<span class="sd">        import_btn (bool): Whether to include a &quot;Settings Import&quot; button.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            button_scrollable_frame (spacrFrame): The frame holding the buttons.</span>
<span class="sd">            btn_col (int): Final column index after placing buttons.</span>

<span class="sd">    Globals Set:</span>
<span class="sd">        run_button, abort_button, download_dataset_button, import_button, progress_bar</span>
<span class="sd">        button_frame, button_scrollable_frame, thread_control, q, fig_queue, vars_dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">thread_control</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">button_frame</span><span class="p">,</span> <span class="n">button_scrollable_frame</span><span class="p">,</span> <span class="n">run_button</span><span class="p">,</span> <span class="n">abort_button</span><span class="p">,</span> <span class="n">download_dataset_button</span><span class="p">,</span> <span class="n">import_button</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">progress_bar</span>
    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">download_hug_dataset</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">set_element_size</span>

    <span class="n">size_dict</span> <span class="o">=</span> <span class="n">set_element_size</span><span class="p">()</span>
    <span class="n">button_section_height</span> <span class="o">=</span> <span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;panel_height&#39;</span><span class="p">]</span>
    <span class="n">button_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">button_section_height</span><span class="p">)</span>
    
    <span class="n">horizontal_container</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">)</span>
    <span class="n">button_scrollable_frame</span> <span class="o">=</span> <span class="n">spacrFrame</span><span class="p">(</span><span class="n">button_frame</span><span class="p">,</span> <span class="n">scrollbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">)</span>
    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">]</span>

    <span class="n">btn_col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">btn_row</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
        <span class="n">run_button</span> <span class="o">=</span> <span class="n">spacrButton</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">start_process</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">),</span> <span class="n">show_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;btn_size&#39;</span><span class="p">],</span> <span class="n">animation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">run_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">btn_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">btn_col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_button</span><span class="p">)</span>
        <span class="n">btn_col</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">abort</span> <span class="ow">and</span> <span class="n">settings_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;measure&#39;</span><span class="p">,</span> <span class="s1">&#39;classify&#39;</span><span class="p">,</span> <span class="s1">&#39;sequencing&#39;</span><span class="p">,</span> <span class="s1">&#39;umap&#39;</span><span class="p">,</span> <span class="s1">&#39;map_barcodes&#39;</span><span class="p">]:</span>
        <span class="n">abort_button</span> <span class="o">=</span> <span class="n">spacrButton</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;abort&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">initiate_abort</span><span class="p">(),</span> <span class="n">show_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;btn_size&#39;</span><span class="p">],</span> <span class="n">animation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">abort_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">btn_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">btn_col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abort_button</span><span class="p">)</span>
        <span class="n">btn_col</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">download</span> <span class="ow">and</span> <span class="n">settings_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]:</span>
        <span class="n">download_dataset_button</span> <span class="o">=</span> <span class="n">spacrButton</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">download_hug_dataset</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">vars_dict</span><span class="p">),</span> <span class="n">show_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;btn_size&#39;</span><span class="p">],</span> <span class="n">animation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">download_dataset_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">btn_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">btn_col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">download_dataset_button</span><span class="p">)</span>
        <span class="n">btn_col</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">import_btn</span><span class="p">:</span>
        <span class="n">import_button</span> <span class="o">=</span> <span class="n">spacrButton</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;settings&quot;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">import_settings</span><span class="p">(</span><span class="n">settings_type</span><span class="p">),</span> <span class="n">show_text</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;btn_size&#39;</span><span class="p">],</span> <span class="n">animation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">import_button</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">btn_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">btn_col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">import_button</span><span class="p">)</span>
        <span class="n">btn_row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">btn_row</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Add the batch progress bar</span>
    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">)</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">btn_row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
    <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">()</span>  <span class="c1"># Set the label position after grid placement</span>
    <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">progress_bar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vars_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toggle_settings</span><span class="p">(</span><span class="n">button_scrollable_frame</span><span class="p">)</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">containers</span><span class="o">=</span><span class="p">[</span><span class="n">button_frame</span><span class="p">],</span> <span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">button_scrollable_frame</span><span class="p">,</span> <span class="n">btn_col</span></div>


<div class="viewcode-block" id="setup_usage_panel">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_usage_panel">[docs]</a>
<span class="k">def</span> <span class="nf">setup_usage_panel</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">,</span> <span class="n">btn_col</span><span class="p">,</span> <span class="n">uppdate_frequency</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the system usage panel displaying RAM, VRAM, GPU, and CPU core usage as progress bars.</span>

<span class="sd">    Args:</span>
<span class="sd">        horizontal_container (tk.PanedWindow or tk.Frame): Container for the usage panel.</span>
<span class="sd">        btn_col (int): Starting column index from button section (not used directly here).</span>
<span class="sd">        uppdate_frequency (int): Update interval for usage stats in milliseconds.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            usage_scrollable_frame (spacrFrame): Frame containing the usage bars.</span>
<span class="sd">            usage_bars (list): List of spacrProgressBar widgets for RAM, VRAM, GPU, and CPU cores.</span>
<span class="sd">            usg_col (int): Column index used for placement in the parent container.</span>

<span class="sd">    Globals Set:</span>
<span class="sd">        usage_bars: List of progress bars used to update usage statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">usage_bars</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">set_dark_style</span><span class="p">,</span> <span class="n">set_element_size</span>

    <span class="n">usg_col</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">update_usage</span><span class="p">(</span><span class="n">ram_bar</span><span class="p">,</span> <span class="n">vram_bar</span><span class="p">,</span> <span class="n">gpu_bar</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">):</span>
        <span class="c1"># Update RAM usage</span>
        <span class="n">ram_usage</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">percent</span>
        <span class="n">ram_bar</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ram_usage</span>

        <span class="c1"># Update GPU and VRAM usage</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vram_usage</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">memoryUtil</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">gpu_usage</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">load</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">vram_bar</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vram_usage</span>
            <span class="n">gpu_bar</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpu_usage</span>

        <span class="c1"># Update CPU usage for each core</span>
        <span class="n">cpu_percentages</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">percpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">usage</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">usage_bars</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">cpu_percentages</span><span class="p">):</span>
            <span class="n">bar</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage</span>

        <span class="c1"># Schedule the function to run again after 1000 ms (1 second)</span>
        <span class="n">parent_frame</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">uppdate_frequency</span><span class="p">,</span> <span class="n">update_usage</span><span class="p">,</span> <span class="n">ram_bar</span><span class="p">,</span> <span class="n">vram_bar</span><span class="p">,</span> <span class="n">gpu_bar</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">)</span>

    <span class="n">size_dict</span> <span class="o">=</span> <span class="n">set_element_size</span><span class="p">()</span>
    <span class="n">usage_panel_height</span> <span class="o">=</span> <span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;panel_height&#39;</span><span class="p">]</span>
    <span class="n">usage_frame</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">usage_panel_height</span><span class="p">)</span>
    <span class="n">horizontal_container</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">usage_frame</span><span class="p">)</span>

    <span class="n">usage_frame</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">usage_frame</span><span class="o">.</span><span class="n">grid_rowconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">usage_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">usage_frame</span><span class="o">.</span><span class="n">grid_columnconfigure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">usage_scrollable_frame</span> <span class="o">=</span> <span class="n">spacrFrame</span><span class="p">(</span><span class="n">usage_frame</span><span class="p">,</span> <span class="n">scrollbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&quot;nsew&quot;</span><span class="p">,</span> <span class="n">columnspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">]</span>
    
    <span class="n">usage_bars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_elements_per_column</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Initialize RAM, VRAM, and GPU bars as None</span>
    <span class="n">ram_bar</span><span class="p">,</span> <span class="n">vram_bar</span><span class="p">,</span> <span class="n">gpu_bar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    
    <span class="c1"># Configure the style for the label</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">()</span>
    <span class="n">style_out</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
    <span class="n">font_loader</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;font_loader&#39;</span><span class="p">]</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;font_size&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">style</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;usage.TLabel&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font_loader</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span> <span class="n">foreground</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">])</span>

    <span class="c1"># Try adding RAM bar</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ram_info</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
        <span class="n">ram_label_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;RAM&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="n">ram_label_text</span><span class="p">,</span><span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="n">font_loader</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span><span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">],</span><span class="n">fg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">])</span>
        <span class="n">label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">ram_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ram_bar</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ram_bar</span><span class="p">)</span>
        <span class="n">usage_bars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ram_bar</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add RAM usage bar: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Try adding VRAM and GPU usage bars</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gpus</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getGPUs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
            <span class="n">gpu</span> <span class="o">=</span> <span class="n">gpus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vram_label_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;VRAM&quot;</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="n">vram_label_text</span><span class="p">,</span><span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="n">font_loader</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span><span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">],</span><span class="n">fg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">])</span>
            <span class="n">label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">vram_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">vram_bar</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vram_bar</span><span class="p">)</span>
            <span class="n">usage_bars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vram_bar</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">gpu_label_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;GPU&quot;</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="n">gpu_label_text</span><span class="p">,</span><span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="n">font_loader</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span><span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">],</span><span class="n">fg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">])</span>
            <span class="n">label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">gpu_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">gpu_bar</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpu_bar</span><span class="p">)</span>
            <span class="n">usage_bars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpu_bar</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add VRAM or GPU usage bars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Add CPU core usage bars</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cpu_cores</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cpu_freq</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_freq</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cpu_cores</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span> <span class="o">%</span> <span class="n">max_elements_per_column</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">label</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">core</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="n">font_loader</span><span class="o">.</span><span class="n">get_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span><span class="n">bg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;bg_color&#39;</span><span class="p">],</span><span class="n">fg</span><span class="o">=</span><span class="n">style_out</span><span class="p">[</span><span class="s1">&#39;fg_color&#39;</span><span class="p">])</span>
            <span class="n">label</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="s1">&#39;ew&#39;</span><span class="p">)</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">widgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
            <span class="n">usage_bars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add CPU core usage bars: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">style</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">set_dark_style</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">containers</span><span class="o">=</span><span class="p">[</span><span class="n">usage_frame</span><span class="p">],</span> <span class="n">widgets</span><span class="o">=</span><span class="n">widgets</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ram_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ram_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vram_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vram_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpu_bar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gpu_bar</span> <span class="o">=</span> <span class="n">spacrProgressBar</span><span class="p">(</span><span class="n">usage_scrollable_frame</span><span class="o">.</span><span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">size_dict</span><span class="p">[</span><span class="s1">&#39;bar_size&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">update_usage</span><span class="p">(</span><span class="n">ram_bar</span><span class="p">,</span> <span class="n">vram_bar</span><span class="p">,</span> <span class="n">gpu_bar</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">,</span> <span class="n">usage_frame</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">usage_scrollable_frame</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">,</span> <span class="n">usg_col</span></div>


<div class="viewcode-block" id="initiate_abort">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.initiate_abort">[docs]</a>
<span class="k">def</span> <span class="nf">initiate_abort</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminates the currently running threaded process if any, and resets the control flags.</span>

<span class="sd">    Globals:</span>
<span class="sd">        thread_control (dict): Holds the active thread and abort flag.</span>
<span class="sd">        q (queue.Queue): Message queue for status updates.</span>
<span class="sd">        parent_frame: Not used directly, but kept for potential extension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">thread_control</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">parent_frame</span>
    <span class="k">if</span> <span class="n">thread_control</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_thread&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#q.put(&quot;Aborting processes...&quot;)</span>
            <span class="n">thread_control</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_thread&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">thread_control</span><span class="p">[</span><span class="s2">&quot;run_thread&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;Processes aborted.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error aborting process: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">thread_control</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;run_thread&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;stop_requested&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></div>

    
<div class="viewcode-block" id="check_src_folders_files">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.check_src_folders_files">[docs]</a>
<span class="k">def</span> <span class="nf">check_src_folders_files</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if &#39;src&#39; is a key in the settings dictionary and if it exists as a valid path.</span>
<span class="sd">    If &#39;src&#39; is a list, iterates through the list and checks each path.</span>
<span class="sd">    If any path is missing, prompts the user to edit or remove invalid paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">request_stop</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">def</span> <span class="nf">_folder_has_images</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">image_extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;.bmp&quot;</span><span class="p">,</span> <span class="s2">&quot;.gif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.webp&quot;</span><span class="p">,</span> <span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;.npz&quot;</span><span class="p">,</span> <span class="s2">&quot;nd2&quot;</span><span class="p">,</span> <span class="s2">&quot;czi&quot;</span><span class="p">,</span> <span class="s2">&quot;lif&quot;</span><span class="p">}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a folder contains any image files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">image_extensions</span><span class="p">))</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_has_folder</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">sub_folder</span><span class="o">=</span><span class="s2">&quot;measure&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a specific sub-folder exists inside the given folder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">sub_folder</span><span class="p">))</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">normalize_src_path</span><span class="p">,</span> <span class="n">generate_image_path_map</span>
    
    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize_src_path</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>

    <span class="n">src_value</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)</span>

    <span class="c1"># **Skip if &#39;src&#39; is missing**</span>
    <span class="k">if</span> <span class="n">src_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request_stop</span>

    <span class="c1"># Convert single string src to a list for uniform handling</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">src_value</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="n">src_value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request_stop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">request_stop</span>  <span class="c1"># Ensure early exit</span>

    <span class="c1"># Identify missing paths</span>
    <span class="n">missing_paths</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">path</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src_list</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>

    <span class="k">if</span> <span class="n">missing_paths</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: The following paths are missing: </span><span class="si">{</span><span class="n">missing_paths</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">request_stop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">request_stop</span>  <span class="c1"># Ensure early exit</span>

    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>  <span class="c1"># Initialize conditions list</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">src_list</span><span class="p">:</span>  <span class="c1"># Fixed: Use src_list instead of src_value</span>
        <span class="k">if</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;consolidate&#39;</span><span class="p">]:</span>
                <span class="n">image_map</span> <span class="o">=</span> <span class="n">generate_image_path_map</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">request_stop</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="n">request_stop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Missing subfolders with images for: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">request_stop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="n">request_stop</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pictures_continue</span> <span class="o">=</span> <span class="n">_folder_has_images</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">folder_chan_continue</span> <span class="o">=</span> <span class="n">_has_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
                <span class="n">folder_stack_continue</span> <span class="o">=</span> <span class="n">_has_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">)</span>
                <span class="n">folder_npz_continue</span> <span class="o">=</span> <span class="n">_has_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)</span>
            
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pictures_continue</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">folder_chan_continue</span><span class="p">,</span> <span class="n">folder_stack_continue</span><span class="p">,</span> <span class="n">folder_npz_continue</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_chan_continue</span><span class="p">:</span>
                            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Missing channel folder in folder: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_stack_continue</span><span class="p">:</span>
                            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Missing stack folder in folder: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_npz_continue</span><span class="p">:</span>
                            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Missing masks folder in folder: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No images in folder: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1">#q.put(f&quot;path:{path}&quot;)</span>
                <span class="c1">#q.put(f&quot;pictures_continue:{pictures_continue}, folder_chan_continue:{folder_chan_continue}, folder_stack_continue:{folder_stack_continue}, folder_npz_continue:{folder_npz_continue}&quot;)</span>

                <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="n">pictures_continue</span><span class="p">,</span> <span class="n">folder_chan_continue</span><span class="p">,</span> <span class="n">folder_stack_continue</span><span class="p">,</span> <span class="n">folder_npz_continue</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">settings_type</span> <span class="o">==</span> <span class="s1">&#39;measure&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;merged&#39;</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;merged&quot;</span><span class="p">)</span>
            <span class="n">npy_continue</span> <span class="o">=</span> <span class="n">_folder_has_images</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">image_extensions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;.npy&quot;</span><span class="p">})</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="n">npy_continue</span><span class="p">]</span>
            
        <span class="c1">#if settings_type == &#39;recruitment&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
            
        <span class="c1">#if settings_type == &#39;umap&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
            
        <span class="c1">#if settings_type == &#39;analyze_plaques&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
        
        <span class="c1">#if settings_type == &#39;map_barcodes&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
        
        <span class="c1">#if settings_type == &#39;regression&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
            
        <span class="c1">#if settings_type == &#39;classify&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
            
        <span class="c1">#if settings_type == &#39;analyze_plaques&#39;:</span>
        <span class="c1">#    if not os.path.basename(path) == &#39;measurements&#39;:</span>
        <span class="c1">#        path = os.path.join(path, &quot;measurements&quot;)</span>
        <span class="c1">#    db_continue = _folder_has_images(path, image_extensions={&quot;.db&quot;})</span>
        <span class="c1">#    conditions = [db_continue]</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">conditions</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: The following path(s) is missing images or folders: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">request_stop</span> <span class="o">=</span> <span class="kc">True</span>
            
    <span class="k">return</span> <span class="n">request_stop</span></div>


<div class="viewcode-block" id="start_process">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.start_process">[docs]</a>
<span class="k">def</span> <span class="nf">start_process</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings_type</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts a multiprocessing task based on the provided settings type and GUI settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        q (multiprocessing.Queue, optional): Queue for logging or progress updates.</span>
<span class="sd">        fig_queue (multiprocessing.Queue, optional): Queue for passing figures or plot data.</span>
<span class="sd">        settings_type (str): Type of processing task to run (e.g., &#39;mask&#39;, &#39;measure&#39;).</span>

<span class="sd">    Globals Used:</span>
<span class="sd">        thread_control (dict): Controls the running thread and abort flags.</span>
<span class="sd">        vars_dict (dict): Holds current GUI settings.</span>
<span class="sd">        parent_frame (tk.Frame): Main parent GUI frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">thread_control</span><span class="p">,</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">parent_frame</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">check_settings</span><span class="p">,</span> <span class="n">expected_types</span>
    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">run_function_gui</span><span class="p">,</span> <span class="n">set_cpu_affinity</span><span class="p">,</span> <span class="n">initialize_cuda</span><span class="p">,</span> <span class="n">display_gif_in_plot_frame</span><span class="p">,</span> <span class="n">print_widget_structure</span>
        
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fig_queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">check_settings</span><span class="p">(</span><span class="n">vars_dict</span><span class="p">,</span> <span class="n">expected_types</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">check_src_folders_files</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
            <span class="k">return</span>
    
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thread_control</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">thread_control</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_thread&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initiate_abort</span><span class="p">()</span>
    
    <span class="n">stop_requested</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">thread_control</span><span class="p">[</span><span class="s2">&quot;stop_requested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_requested</span>

    <span class="c1"># Initialize CUDA in the main process</span>
    <span class="n">initialize_cuda</span><span class="p">()</span>

    <span class="n">process_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">settings_type</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">stop_requested</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;umap&#39;</span><span class="p">,</span> <span class="s1">&#39;measure&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation&#39;</span><span class="p">,</span> <span class="s1">&#39;sequencing&#39;</span><span class="p">,</span> <span class="s1">&#39;classify&#39;</span><span class="p">,</span> <span class="s1">&#39;analyze_plaques&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;cellpose_dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;train_cellpose&#39;</span><span class="p">,</span> <span class="s1">&#39;ml_analyze&#39;</span><span class="p">,</span> <span class="s1">&#39;cellpose_masks&#39;</span><span class="p">,</span> <span class="s1">&#39;cellpose_all&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;map_barcodes&#39;</span><span class="p">,</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span> <span class="s1">&#39;recruitment&#39;</span><span class="p">,</span> <span class="s1">&#39;cellpose_compare&#39;</span><span class="p">,</span> <span class="s1">&#39;vision_scores&#39;</span><span class="p">,</span> 
                         <span class="s1">&#39;vision_dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;convert&#39;</span><span class="p">]:</span>

        <span class="c1"># Start the process</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_function_gui</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">process_args</span><span class="p">)</span>
        <span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Set CPU affinity if necessary</span>
        <span class="n">set_cpu_affinity</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

        <span class="c1"># Store the process in thread_control for future reference</span>
        <span class="n">thread_control</span><span class="p">[</span><span class="s2">&quot;run_thread&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Unknown settings type &#39;</span><span class="si">{</span><span class="n">settings_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="process_console_queue">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.process_console_queue">[docs]</a>
<span class="k">def</span> <span class="nf">process_console_queue</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Periodically reads from the message queue and updates the console widget with formatted messages.</span>
<span class="sd">    Supports special formatting for errors, warnings, and progress updates.</span>

<span class="sd">    Globals Used:</span>
<span class="sd">        q (Queue): Queue for status and log messages.</span>
<span class="sd">        console_output (tk.Text): The console widget.</span>
<span class="sd">        parent_frame (tk.Frame): The main GUI frame containing the console.</span>
<span class="sd">        progress_bar (spacrProgressBar): Progress bar updated with progress information.</span>
<span class="sd">        uppdate_frequency (int): Refresh rate in milliseconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">q</span><span class="p">,</span> <span class="n">console_output</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">process_console_queue</span>

    <span class="c1"># Initialize function attribute if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process_console_queue</span><span class="p">,</span> <span class="s2">&quot;completed_tasks&quot;</span><span class="p">):</span>
        <span class="n">process_console_queue</span><span class="o">.</span><span class="n">completed_tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process_console_queue</span><span class="p">,</span> <span class="s2">&quot;current_maximum&quot;</span><span class="p">):</span>
        <span class="n">process_console_queue</span><span class="o">.</span><span class="n">current_maximum</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">ansi_escape_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\x1B\[[0-?]*[ -/]*[@-~]&#39;</span><span class="p">)</span>
    
    <span class="n">spacing</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># **Configure styles for different message types**</span>
    <span class="n">console_output</span><span class="o">.</span><span class="n">tag_configure</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">spacing3</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">)</span>
    <span class="n">console_output</span><span class="o">.</span><span class="n">tag_configure</span><span class="p">(</span><span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">spacing3</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">)</span>
    <span class="n">console_output</span><span class="o">.</span><span class="n">tag_configure</span><span class="p">(</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">spacing3</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="n">clean_message</span> <span class="o">=</span> <span class="n">ansi_escape_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="c1"># **Detect Error Messages (Red)**</span>
        <span class="k">if</span> <span class="n">clean_message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Error:&quot;</span><span class="p">):</span>
            <span class="n">console_output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="n">clean_message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="n">console_output</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>
            <span class="c1">#print(&quot;Run aborted due to error:&quot;, clean_message)  # Debug message</span>
            <span class="c1">#return  # **Exit immediately to stop further execution**</span>

        <span class="c1"># **Detect Warning Messages (Orange)**</span>
        <span class="k">elif</span> <span class="n">clean_message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Warning:&quot;</span><span class="p">):</span>
            <span class="n">console_output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="n">clean_message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        
        <span class="c1"># **Process Progress Messages Normally**</span>
        <span class="k">elif</span> <span class="n">clean_message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Progress:&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Extract the progress information</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Progress: (\d+)/(\d+), operation_type: ([\w\s]*),(.*)&#39;</span><span class="p">,</span> <span class="n">clean_message</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">current_progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">total_progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">operation_type</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">additional_info</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Capture everything after operation_type</span>
                    
                    <span class="c1"># Check if the maximum value has changed</span>
                    <span class="k">if</span> <span class="n">process_console_queue</span><span class="o">.</span><span class="n">current_maximum</span> <span class="o">!=</span> <span class="n">total_progress</span><span class="p">:</span>
                        <span class="n">process_console_queue</span><span class="o">.</span><span class="n">current_maximum</span> <span class="o">=</span> <span class="n">total_progress</span>
                        <span class="n">process_console_queue</span><span class="o">.</span><span class="n">completed_tasks</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># Add the task to the completed set</span>
                    <span class="n">process_console_queue</span><span class="o">.</span><span class="n">completed_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_progress</span><span class="p">)</span>
                    
                    <span class="c1"># Calculate the unique progress count</span>
                    <span class="n">unique_progress_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">process_console_queue</span><span class="o">.</span><span class="n">completed_tasks</span><span class="p">))</span>

                    <span class="c1"># Update the progress bar</span>
                    <span class="k">if</span> <span class="n">progress_bar</span><span class="p">:</span>
                        <span class="n">progress_bar</span><span class="p">[</span><span class="s1">&#39;maximum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_progress</span>
                        <span class="n">progress_bar</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_progress_count</span>

                    <span class="c1"># Store operation type and additional info</span>
                    <span class="k">if</span> <span class="n">operation_type</span><span class="p">:</span>
                        <span class="n">progress_bar</span><span class="o">.</span><span class="n">operation_type</span> <span class="o">=</span> <span class="n">operation_type</span>
                        <span class="n">progress_bar</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span>

                    <span class="c1"># Update the progress label</span>
                    <span class="k">if</span> <span class="n">progress_bar</span><span class="o">.</span><span class="n">progress_label</span><span class="p">:</span>
                        <span class="n">progress_bar</span><span class="o">.</span><span class="n">update_label</span><span class="p">()</span>

                    <span class="c1"># Clear completed tasks when progress is complete</span>
                    <span class="k">if</span> <span class="n">unique_progress_count</span> <span class="o">&gt;=</span> <span class="n">total_progress</span><span class="p">:</span>
                        <span class="n">process_console_queue</span><span class="o">.</span><span class="n">completed_tasks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing progress message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># **Insert Normal Messages with Extra Line Spacing**</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">console_output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="n">clean_message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>

        <span class="n">console_output</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">END</span><span class="p">)</span>

    <span class="c1"># **Continue processing if no error was detected**</span>
    <span class="n">after_id</span> <span class="o">=</span> <span class="n">console_output</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">uppdate_frequency</span><span class="p">,</span> <span class="n">process_console_queue</span><span class="p">)</span>
    <span class="n">parent_frame</span><span class="o">.</span><span class="n">after_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">after_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="main_thread_update_function">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.main_thread_update_function">[docs]</a>
<span class="k">def</span> <span class="nf">main_thread_update_function</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Periodically triggers updates on the GUI&#39;s canvas or figures from a queue.</span>

<span class="sd">    Args:</span>
<span class="sd">        root (tk.Tk): Root GUI window.</span>
<span class="sd">        q (Queue): Message queue (currently unused inside function).</span>
<span class="sd">        fig_queue (Queue): Queue for figure data (currently unused inside function).</span>
<span class="sd">        canvas_widget (tk.Widget): Canvas widget to refresh.</span>

<span class="sd">    Globals Used:</span>
<span class="sd">        uppdate_frequency (int): Interval for update scheduling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">uppdate_frequency</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating GUI canvas: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">root</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">uppdate_frequency</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">main_thread_update_function</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="cleanup_previous_instance">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.cleanup_previous_instance">[docs]</a>
<span class="k">def</span> <span class="nf">cleanup_previous_instance</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up any remnants of the previous application run, including GUI widgets,</span>
<span class="sd">    background tasks, queues, threads, and canvas elements.</span>

<span class="sd">    Globals Modified:</span>
<span class="sd">        parent_frame, usage_bars, figures, figure_index, thread_control,</span>
<span class="sd">        canvas, q, fig_queue</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">thread_control</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span>

    <span class="c1"># 1. Destroy all widgets in the parent frame</span>
    <span class="k">if</span> <span class="n">parent_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">widget</span> <span class="ow">in</span> <span class="n">parent_frame</span><span class="o">.</span><span class="n">winfo_children</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error destroying widget: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">parent_frame</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
        <span class="n">parent_frame</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 2. Cancel all pending `after` tasks</span>
    <span class="k">if</span> <span class="n">parent_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parent_window</span> <span class="o">=</span> <span class="n">parent_frame</span><span class="o">.</span><span class="n">winfo_toplevel</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent_window</span><span class="p">,</span> <span class="s1">&#39;after_tasks&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">after_id</span> <span class="ow">in</span> <span class="n">parent_window</span><span class="o">.</span><span class="n">after_tasks</span><span class="p">:</span>
                <span class="n">parent_window</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="n">after_id</span><span class="p">)</span>
            <span class="n">parent_window</span><span class="o">.</span><span class="n">after_tasks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 3. Clear global queues</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">fig_queue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">fig_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">fig_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">fig_queue</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># 4. Stop and reset global thread control</span>
    <span class="k">if</span> <span class="n">thread_control</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">thread_control</span><span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">#thread_control = None</span>

    <span class="c1"># 5. Reset usage bars, figures, and indices</span>
    <span class="n">usage_bars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">figures</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
    <span class="n">figure_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># 6. Clear canvas or other visualizations</span>
    <span class="k">if</span> <span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">):</span>  <span class="c1"># Check if it&#39;s a FigureCanvasTkAgg</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear the Matplotlib figure</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">get_tk_widget</span><span class="p">()</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>  <span class="c1"># Destroy the Tkinter widget</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Assume it&#39;s a standard Tkinter Canvas</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clearing canvas: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Previous instance cleaned up successfully.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="initiate_root">
<a class="viewcode-back" href="../../api/spacr/gui_core/index.html#spacr.gui_core.initiate_root">[docs]</a>
<span class="k">def</span> <span class="nf">initiate_root</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">settings_type</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes and builds the GUI based on the selected settings type.</span>

<span class="sd">    Args:</span>
<span class="sd">        parent (tk.Tk or tk.Toplevel): Root window for the GUI.</span>
<span class="sd">        settings_type (str): Type of settings to configure (e.g., &#39;mask&#39;, &#39;measure&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            parent_frame (tk.Frame): The root GUI container.</span>
<span class="sd">            vars_dict (dict): Dictionary of user-configurable variables.</span>

<span class="sd">    Globals Set:</span>
<span class="sd">        q, fig_queue, thread_control, parent_frame, scrollable_frame, </span>
<span class="sd">        button_frame, vars_dict, canvas, canvas_widget, button_scrollable_frame, </span>
<span class="sd">        progress_bar, uppdate_frequency, figures, figure_index, index_control, usage_bars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">global</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">thread_control</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">button_frame</span><span class="p">,</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">,</span> <span class="n">button_scrollable_frame</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">uppdate_frequency</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">figure_index</span><span class="p">,</span> <span class="n">index_control</span><span class="p">,</span> <span class="n">usage_bars</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">set_element_size</span>
    
    <span class="c1"># Clean up any previous instance</span>
    <span class="n">cleanup_previous_instance</span><span class="p">()</span>
    
    <span class="kn">from</span> <span class="nn">.gui_utils</span> <span class="kn">import</span> <span class="n">setup_frame</span>
    <span class="kn">from</span> <span class="nn">.gui_elements</span> <span class="kn">import</span> <span class="n">create_menu_bar</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">descriptions</span>
    <span class="c1">#from .openai import Chatbot</span>

    <span class="n">uppdate_frequency</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">num_cores</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="c1"># Start tracemalloc and initialize global variables</span>
    <span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">set_start_method</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#set_start_method(&#39;forkserver&#39;, force=True)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing root with settings_type:&quot;</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">)</span>

    <span class="c1"># Initialize global variables</span>
    <span class="n">figures</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
    <span class="n">figure_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">parent_frame</span> <span class="o">=</span> <span class="n">parent</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="p">)):</span>
        <span class="n">parent_window</span> <span class="o">=</span> <span class="n">parent_frame</span><span class="o">.</span><span class="n">winfo_toplevel</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parent_window</span> <span class="o">=</span> <span class="n">parent_frame</span>

    <span class="n">parent_window</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent_window</span><span class="p">,</span> <span class="s1">&#39;after_tasks&#39;</span><span class="p">):</span>
        <span class="n">parent_window</span><span class="o">.</span><span class="n">after_tasks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">fig_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">parent_frame</span><span class="p">,</span> <span class="n">vertical_container</span><span class="p">,</span> <span class="n">horizontal_container</span><span class="p">,</span> <span class="n">settings_container</span> <span class="o">=</span> <span class="n">setup_frame</span><span class="p">(</span><span class="n">parent_frame</span><span class="p">)</span>

    <span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">vars_dict</span> <span class="o">=</span> <span class="n">setup_settings_panel</span><span class="p">(</span><span class="n">settings_container</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setup_settings_panel&#39;</span><span class="p">)</span>
    <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span> <span class="o">=</span> <span class="n">setup_plot_section</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">)</span>
    <span class="n">console_output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">setup_console</span><span class="p">(</span><span class="n">vertical_container</span><span class="p">)</span> <span class="c1">#, chatbot)</span>
    <span class="n">button_scrollable_frame</span><span class="p">,</span> <span class="n">btn_col</span> <span class="o">=</span> <span class="n">setup_button_section</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">,</span> <span class="n">settings_type</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">num_cores</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">,</span> <span class="n">btn_col</span> <span class="o">=</span> <span class="n">setup_usage_panel</span><span class="p">(</span><span class="n">horizontal_container</span><span class="p">,</span> <span class="n">btn_col</span><span class="p">,</span> <span class="n">uppdate_frequency</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">usage_bars</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">set_globals</span><span class="p">(</span><span class="n">thread_control</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">console_output</span><span class="p">,</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">vars_dict</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">,</span> <span class="n">scrollable_frame</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">progress_bar</span><span class="p">,</span> <span class="n">usage_bars</span><span class="p">)</span>
    <span class="n">description_text</span> <span class="o">=</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings_type</span><span class="p">,</span> <span class="s2">&quot;No description available for this module.&quot;</span><span class="p">)</span>
    
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Console&quot;</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">description_text</span><span class="p">)</span>
    
    <span class="n">process_console_queue</span><span class="p">()</span>
    <span class="n">process_fig_queue</span><span class="p">()</span>
    <span class="n">create_menu_bar</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
    <span class="n">after_id</span> <span class="o">=</span> <span class="n">parent_window</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">uppdate_frequency</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">main_thread_update_function</span><span class="p">(</span><span class="n">parent_window</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fig_queue</span><span class="p">,</span> <span class="n">canvas_widget</span><span class="p">))</span>
    <span class="n">parent_window</span><span class="o">.</span><span class="n">after_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">after_id</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Root initialization complete&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parent_frame</span><span class="p">,</span> <span class="n">vars_dict</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>