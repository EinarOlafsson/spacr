

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spacr.io &mdash; spacr 1.0.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=45a07ac9" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=aec50437"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #005f73" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_spacr.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/core/index.html">Core Logic</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/core/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/core/index.html#spacr.core.preprocess_generate_masks"><code class="docutils literal notranslate"><span class="pre">preprocess_generate_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/core/index.html#spacr.core.generate_cellpose_masks"><code class="docutils literal notranslate"><span class="pre">generate_cellpose_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/core/index.html#spacr.core.generate_screen_graphs"><code class="docutils literal notranslate"><span class="pre">generate_screen_graphs()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/io/index.html">IO Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/io/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.process_non_tif_non_2D_images"><code class="docutils literal notranslate"><span class="pre">process_non_tif_non_2D_images()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders"><code class="docutils literal notranslate"><span class="pre">CombineLoaders</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.train_loaders"><code class="docutils literal notranslate"><span class="pre">CombineLoaders.train_loaders</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.loader_iters"><code class="docutils literal notranslate"><span class="pre">CombineLoaders.loader_iters</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.__iter__"><code class="docutils literal notranslate"><span class="pre">CombineLoaders.__iter__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.__next__"><code class="docutils literal notranslate"><span class="pre">CombineLoaders.__next__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset"><code class="docutils literal notranslate"><span class="pre">CombinedDataset</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.datasets"><code class="docutils literal notranslate"><span class="pre">CombinedDataset.datasets</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.lengths"><code class="docutils literal notranslate"><span class="pre">CombinedDataset.lengths</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.total_length"><code class="docutils literal notranslate"><span class="pre">CombinedDataset.total_length</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.shuffle"><code class="docutils literal notranslate"><span class="pre">CombinedDataset.shuffle</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.__getitem__"><code class="docutils literal notranslate"><span class="pre">CombinedDataset.__getitem__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.__len__"><code class="docutils literal notranslate"><span class="pre">CombinedDataset.__len__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset"><code class="docutils literal notranslate"><span class="pre">NoClassDataset</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.data_dir"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.data_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.transform"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.transform</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.shuffle"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.shuffle</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.load_to_memory"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.load_to_memory</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.filenames"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.filenames</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.load_image"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.load_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.__len__"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.__len__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.shuffle_dataset"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.shuffle_dataset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.__getitem__"><code class="docutils literal notranslate"><span class="pre">NoClassDataset.__getitem__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset"><code class="docutils literal notranslate"><span class="pre">spacrDataset</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.data_dir"><code class="docutils literal notranslate"><span class="pre">spacrDataset.data_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.classes"><code class="docutils literal notranslate"><span class="pre">spacrDataset.classes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.transform"><code class="docutils literal notranslate"><span class="pre">spacrDataset.transform</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.shuffle"><code class="docutils literal notranslate"><span class="pre">spacrDataset.shuffle</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.pin_memory"><code class="docutils literal notranslate"><span class="pre">spacrDataset.pin_memory</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.filenames"><code class="docutils literal notranslate"><span class="pre">spacrDataset.filenames</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.labels"><code class="docutils literal notranslate"><span class="pre">spacrDataset.labels</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.load_image"><code class="docutils literal notranslate"><span class="pre">spacrDataset.load_image()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.__len__"><code class="docutils literal notranslate"><span class="pre">spacrDataset.__len__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.shuffle_dataset"><code class="docutils literal notranslate"><span class="pre">spacrDataset.shuffle_dataset()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.get_plate"><code class="docutils literal notranslate"><span class="pre">spacrDataset.get_plate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.__getitem__"><code class="docutils literal notranslate"><span class="pre">spacrDataset.__getitem__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.preload_batches"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.preload_batches</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.batch_queue"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.batch_queue</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.process"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.process</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.current_batch_index"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.current_batch_index</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.pin_memory"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.pin_memory</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.__iter__"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.__iter__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.__next__"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.__next__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.cleanup"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.cleanup()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.__del__"><code class="docutils literal notranslate"><span class="pre">spacrDataLoader.__del__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset"><code class="docutils literal notranslate"><span class="pre">TarImageDataset</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.members"><code class="docutils literal notranslate"><span class="pre">TarImageDataset.members</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.tar_path"><code class="docutils literal notranslate"><span class="pre">TarImageDataset.tar_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.transform"><code class="docutils literal notranslate"><span class="pre">TarImageDataset.transform</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.__len__"><code class="docutils literal notranslate"><span class="pre">TarImageDataset.__len__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.__getitem__"><code class="docutils literal notranslate"><span class="pre">TarImageDataset.__getitem__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.load_images_from_paths"><code class="docutils literal notranslate"><span class="pre">load_images_from_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.concatenate_and_normalize"><code class="docutils literal notranslate"><span class="pre">concatenate_and_normalize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.delete_empty_subdirectories"><code class="docutils literal notranslate"><span class="pre">delete_empty_subdirectories()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.preprocess_img_data"><code class="docutils literal notranslate"><span class="pre">preprocess_img_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.read_plot_model_stats"><code class="docutils literal notranslate"><span class="pre">read_plot_model_stats()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.convert_numpy_to_tiff"><code class="docutils literal notranslate"><span class="pre">convert_numpy_to_tiff()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.generate_cellpose_train_test"><code class="docutils literal notranslate"><span class="pre">generate_cellpose_train_test()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.parse_gz_files"><code class="docutils literal notranslate"><span class="pre">parse_gz_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.generate_dataset"><code class="docutils literal notranslate"><span class="pre">generate_dataset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.generate_loaders"><code class="docutils literal notranslate"><span class="pre">generate_loaders()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.generate_training_dataset"><code class="docutils literal notranslate"><span class="pre">generate_training_dataset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.training_dataset_from_annotation"><code class="docutils literal notranslate"><span class="pre">training_dataset_from_annotation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.training_dataset_from_annotation_metadata"><code class="docutils literal notranslate"><span class="pre">training_dataset_from_annotation_metadata()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.generate_dataset_from_lists"><code class="docutils literal notranslate"><span class="pre">generate_dataset_from_lists()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.convert_separate_files_to_yokogawa"><code class="docutils literal notranslate"><span class="pre">convert_separate_files_to_yokogawa()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.convert_to_yokogawa"><code class="docutils literal notranslate"><span class="pre">convert_to_yokogawa()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.apply_augmentation"><code class="docutils literal notranslate"><span class="pre">apply_augmentation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.process_instruction"><code class="docutils literal notranslate"><span class="pre">process_instruction()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/io/index.html#spacr.io.prepare_cellpose_dataset"><code class="docutils literal notranslate"><span class="pre">prepare_cellpose_dataset()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/utils/index.html">General Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/utils/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.spacr_path"><code class="docutils literal notranslate"><span class="pre">spacr_path</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.filepaths_to_database"><code class="docutils literal notranslate"><span class="pre">filepaths_to_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.activation_maps_to_database"><code class="docutils literal notranslate"><span class="pre">activation_maps_to_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.activation_correlations_to_database"><code class="docutils literal notranslate"><span class="pre">activation_correlations_to_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.calculate_activation_correlations"><code class="docutils literal notranslate"><span class="pre">calculate_activation_correlations()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.load_settings"><code class="docutils literal notranslate"><span class="pre">load_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.save_settings"><code class="docutils literal notranslate"><span class="pre">save_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.print_progress"><code class="docutils literal notranslate"><span class="pre">print_progress()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.reset_mp"><code class="docutils literal notranslate"><span class="pre">reset_mp()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.is_multiprocessing_process"><code class="docutils literal notranslate"><span class="pre">is_multiprocessing_process()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.close_file_descriptors"><code class="docutils literal notranslate"><span class="pre">close_file_descriptors()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.close_multiprocessing_processes"><code class="docutils literal notranslate"><span class="pre">close_multiprocessing_processes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.check_mask_folder"><code class="docutils literal notranslate"><span class="pre">check_mask_folder()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.smooth_hull_lines"><code class="docutils literal notranslate"><span class="pre">smooth_hull_lines()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.mask_object_count"><code class="docutils literal notranslate"><span class="pre">mask_object_count()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.is_list_of_lists"><code class="docutils literal notranslate"><span class="pre">is_list_of_lists()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.normalize_to_dtype"><code class="docutils literal notranslate"><span class="pre">normalize_to_dtype()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.annotate_conditions"><code class="docutils literal notranslate"><span class="pre">annotate_conditions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.Cache"><code class="docutils literal notranslate"><span class="pre">Cache</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.Cache.cache"><code class="docutils literal notranslate"><span class="pre">Cache.cache</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.Cache.max_size"><code class="docutils literal notranslate"><span class="pre">Cache.max_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.Cache.get"><code class="docutils literal notranslate"><span class="pre">Cache.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.Cache.put"><code class="docutils literal notranslate"><span class="pre">Cache.put()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ScaledDotProductAttention_v1"><code class="docutils literal notranslate"><span class="pre">ScaledDotProductAttention_v1</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ScaledDotProductAttention_v1.d_k"><code class="docutils literal notranslate"><span class="pre">ScaledDotProductAttention_v1.d_k</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ScaledDotProductAttention_v1.forward"><code class="docutils literal notranslate"><span class="pre">ScaledDotProductAttention_v1.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention_v1"><code class="docutils literal notranslate"><span class="pre">SelfAttention_v1</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention_v1.W_q"><code class="docutils literal notranslate"><span class="pre">SelfAttention_v1.W_q</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention_v1.W_k"><code class="docutils literal notranslate"><span class="pre">SelfAttention_v1.W_k</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention_v1.W_v"><code class="docutils literal notranslate"><span class="pre">SelfAttention_v1.W_v</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention_v1.attention"><code class="docutils literal notranslate"><span class="pre">SelfAttention_v1.attention</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention_v1.forward"><code class="docutils literal notranslate"><span class="pre">SelfAttention_v1.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ScaledDotProductAttention"><code class="docutils literal notranslate"><span class="pre">ScaledDotProductAttention</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ScaledDotProductAttention.d_k"><code class="docutils literal notranslate"><span class="pre">ScaledDotProductAttention.d_k</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ScaledDotProductAttention.forward"><code class="docutils literal notranslate"><span class="pre">ScaledDotProductAttention.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention"><code class="docutils literal notranslate"><span class="pre">SelfAttention</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention.W_q"><code class="docutils literal notranslate"><span class="pre">SelfAttention.W_q</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention.W_k"><code class="docutils literal notranslate"><span class="pre">SelfAttention.W_k</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention.W_v"><code class="docutils literal notranslate"><span class="pre">SelfAttention.W_v</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention.attention"><code class="docutils literal notranslate"><span class="pre">SelfAttention.attention</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelfAttention.forward"><code class="docutils literal notranslate"><span class="pre">SelfAttention.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.EarlyFusion"><code class="docutils literal notranslate"><span class="pre">EarlyFusion</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.EarlyFusion.conv1"><code class="docutils literal notranslate"><span class="pre">EarlyFusion.conv1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.EarlyFusion.forward"><code class="docutils literal notranslate"><span class="pre">EarlyFusion.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SpatialAttention"><code class="docutils literal notranslate"><span class="pre">SpatialAttention</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SpatialAttention.conv1"><code class="docutils literal notranslate"><span class="pre">SpatialAttention.conv1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SpatialAttention.sigmoid"><code class="docutils literal notranslate"><span class="pre">SpatialAttention.sigmoid</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SpatialAttention.forward"><code class="docutils literal notranslate"><span class="pre">SpatialAttention.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.MultiScaleBlockWithAttention"><code class="docutils literal notranslate"><span class="pre">MultiScaleBlockWithAttention</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.MultiScaleBlockWithAttention.dilated_conv1"><code class="docutils literal notranslate"><span class="pre">MultiScaleBlockWithAttention.dilated_conv1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.MultiScaleBlockWithAttention.spatial_attention"><code class="docutils literal notranslate"><span class="pre">MultiScaleBlockWithAttention.spatial_attention</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.MultiScaleBlockWithAttention.custom_forward"><code class="docutils literal notranslate"><span class="pre">MultiScaleBlockWithAttention.custom_forward()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.MultiScaleBlockWithAttention.forward"><code class="docutils literal notranslate"><span class="pre">MultiScaleBlockWithAttention.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier.early_fusion"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier.early_fusion</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier.multi_scale_block_1"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier.multi_scale_block_1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier.fc1"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier.fc1</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier.use_checkpoint"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier.use_checkpoint</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier.custom_forward"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier.custom_forward()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.CustomCellClassifier.forward"><code class="docutils literal notranslate"><span class="pre">CustomCellClassifier.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel"><code class="docutils literal notranslate"><span class="pre">TorchModel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.model_name"><code class="docutils literal notranslate"><span class="pre">TorchModel.model_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.use_checkpoint"><code class="docutils literal notranslate"><span class="pre">TorchModel.use_checkpoint</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.base_model"><code class="docutils literal notranslate"><span class="pre">TorchModel.base_model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.num_ftrs"><code class="docutils literal notranslate"><span class="pre">TorchModel.num_ftrs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.apply_dropout_rate"><code class="docutils literal notranslate"><span class="pre">TorchModel.apply_dropout_rate()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.init_base_model"><code class="docutils literal notranslate"><span class="pre">TorchModel.init_base_model()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.get_weight_choice"><code class="docutils literal notranslate"><span class="pre">TorchModel.get_weight_choice()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.get_num_ftrs"><code class="docutils literal notranslate"><span class="pre">TorchModel.get_num_ftrs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.init_spacr_classifier"><code class="docutils literal notranslate"><span class="pre">TorchModel.init_spacr_classifier()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.TorchModel.forward"><code class="docutils literal notranslate"><span class="pre">TorchModel.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.FocalLossWithLogits"><code class="docutils literal notranslate"><span class="pre">FocalLossWithLogits</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.FocalLossWithLogits.alpha"><code class="docutils literal notranslate"><span class="pre">FocalLossWithLogits.alpha</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.FocalLossWithLogits.gamma"><code class="docutils literal notranslate"><span class="pre">FocalLossWithLogits.gamma</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.FocalLossWithLogits.forward"><code class="docutils literal notranslate"><span class="pre">FocalLossWithLogits.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ResNet"><code class="docutils literal notranslate"><span class="pre">ResNet</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ResNet.initialize_base"><code class="docutils literal notranslate"><span class="pre">ResNet.initialize_base()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.ResNet.forward"><code class="docutils literal notranslate"><span class="pre">ResNet.forward()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.split_my_dataset"><code class="docutils literal notranslate"><span class="pre">split_my_dataset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.classification_metrics"><code class="docutils literal notranslate"><span class="pre">classification_metrics()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.compute_irm_penalty"><code class="docutils literal notranslate"><span class="pre">compute_irm_penalty()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.choose_model"><code class="docutils literal notranslate"><span class="pre">choose_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.calculate_loss"><code class="docutils literal notranslate"><span class="pre">calculate_loss()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.pick_best_model"><code class="docutils literal notranslate"><span class="pre">pick_best_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_paths_from_db"><code class="docutils literal notranslate"><span class="pre">get_paths_from_db()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.save_file_lists"><code class="docutils literal notranslate"><span class="pre">save_file_lists()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.augment_single_image"><code class="docutils literal notranslate"><span class="pre">augment_single_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.augment_images"><code class="docutils literal notranslate"><span class="pre">augment_images()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.augment_classes"><code class="docutils literal notranslate"><span class="pre">augment_classes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.annotate_predictions"><code class="docutils literal notranslate"><span class="pre">annotate_predictions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.initiate_counter"><code class="docutils literal notranslate"><span class="pre">initiate_counter()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.add_images_to_tar"><code class="docutils literal notranslate"><span class="pre">add_images_to_tar()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.generate_fraction_map"><code class="docutils literal notranslate"><span class="pre">generate_fraction_map()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.fishers_odds"><code class="docutils literal notranslate"><span class="pre">fishers_odds()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.model_metrics"><code class="docutils literal notranslate"><span class="pre">model_metrics()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.check_multicollinearity"><code class="docutils literal notranslate"><span class="pre">check_multicollinearity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.lasso_reg"><code class="docutils literal notranslate"><span class="pre">lasso_reg()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.MLR"><code class="docutils literal notranslate"><span class="pre">MLR()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_files_from_dir"><code class="docutils literal notranslate"><span class="pre">get_files_from_dir()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.create_circular_mask"><code class="docutils literal notranslate"><span class="pre">create_circular_mask()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.apply_mask"><code class="docutils literal notranslate"><span class="pre">apply_mask()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.invert_image"><code class="docutils literal notranslate"><span class="pre">invert_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.resize_images_and_labels"><code class="docutils literal notranslate"><span class="pre">resize_images_and_labels()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.resize_labels_back"><code class="docutils literal notranslate"><span class="pre">resize_labels_back()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.calculate_iou"><code class="docutils literal notranslate"><span class="pre">calculate_iou()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.match_masks"><code class="docutils literal notranslate"><span class="pre">match_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.compute_average_precision"><code class="docutils literal notranslate"><span class="pre">compute_average_precision()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.pad_to_same_shape"><code class="docutils literal notranslate"><span class="pre">pad_to_same_shape()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.compute_ap_over_iou_thresholds"><code class="docutils literal notranslate"><span class="pre">compute_ap_over_iou_thresholds()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.compute_segmentation_ap"><code class="docutils literal notranslate"><span class="pre">compute_segmentation_ap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.jaccard_index"><code class="docutils literal notranslate"><span class="pre">jaccard_index()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.dice_coefficient"><code class="docutils literal notranslate"><span class="pre">dice_coefficient()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.extract_boundaries"><code class="docutils literal notranslate"><span class="pre">extract_boundaries()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.boundary_f1_score"><code class="docutils literal notranslate"><span class="pre">boundary_f1_score()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.merge_touching_objects"><code class="docutils literal notranslate"><span class="pre">merge_touching_objects()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_intensity_objects"><code class="docutils literal notranslate"><span class="pre">remove_intensity_objects()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelectChannels"><code class="docutils literal notranslate"><span class="pre">SelectChannels</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelectChannels.channels"><code class="docutils literal notranslate"><span class="pre">SelectChannels.channels</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SelectChannels.__call__"><code class="docutils literal notranslate"><span class="pre">SelectChannels.__call__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.preprocess_image_v1"><code class="docutils literal notranslate"><span class="pre">preprocess_image_v1()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SaliencyMapGenerator"><code class="docutils literal notranslate"><span class="pre">SaliencyMapGenerator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SaliencyMapGenerator.model"><code class="docutils literal notranslate"><span class="pre">SaliencyMapGenerator.model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SaliencyMapGenerator.compute_saliency_maps"><code class="docutils literal notranslate"><span class="pre">SaliencyMapGenerator.compute_saliency_maps()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SaliencyMapGenerator.compute_saliency_and_predictions"><code class="docutils literal notranslate"><span class="pre">SaliencyMapGenerator.compute_saliency_and_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SaliencyMapGenerator.plot_activation_grid"><code class="docutils literal notranslate"><span class="pre">SaliencyMapGenerator.plot_activation_grid()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.SaliencyMapGenerator.percentile_normalize"><code class="docutils literal notranslate"><span class="pre">SaliencyMapGenerator.percentile_normalize()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.model"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.target_layer"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.target_layer</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.cam_type"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.cam_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.gradients"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.gradients</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.activations"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.activations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.target_layer_module"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.target_layer_module</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.hook_layers"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.hook_layers()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.get_layer"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.get_layer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.compute_gradcam_maps"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.compute_gradcam_maps()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.compute_gradcam_and_predictions"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.compute_gradcam_and_predictions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.plot_activation_grid"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.plot_activation_grid()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAMGenerator.percentile_normalize"><code class="docutils literal notranslate"><span class="pre">GradCAMGenerator.percentile_normalize()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.preprocess_image"><code class="docutils literal notranslate"><span class="pre">preprocess_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.class_visualization"><code class="docutils literal notranslate"><span class="pre">class_visualization()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_submodules"><code class="docutils literal notranslate"><span class="pre">get_submodules()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAM"><code class="docutils literal notranslate"><span class="pre">GradCAM</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAM.model"><code class="docutils literal notranslate"><span class="pre">GradCAM.model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAM.target_layers"><code class="docutils literal notranslate"><span class="pre">GradCAM.target_layers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAM.cuda"><code class="docutils literal notranslate"><span class="pre">GradCAM.cuda</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAM.forward"><code class="docutils literal notranslate"><span class="pre">GradCAM.forward()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.GradCAM.__call__"><code class="docutils literal notranslate"><span class="pre">GradCAM.__call__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.show_cam_on_image"><code class="docutils literal notranslate"><span class="pre">show_cam_on_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.recommend_target_layers"><code class="docutils literal notranslate"><span class="pre">recommend_target_layers()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.IntegratedGradients"><code class="docutils literal notranslate"><span class="pre">IntegratedGradients</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.IntegratedGradients.model"><code class="docutils literal notranslate"><span class="pre">IntegratedGradients.model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.IntegratedGradients.generate_integrated_gradients"><code class="docutils literal notranslate"><span class="pre">IntegratedGradients.generate_integrated_gradients()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_db_paths"><code class="docutils literal notranslate"><span class="pre">get_db_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_sequencing_paths"><code class="docutils literal notranslate"><span class="pre">get_sequencing_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.load_image_paths"><code class="docutils literal notranslate"><span class="pre">load_image_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.merge_dataframes"><code class="docutils literal notranslate"><span class="pre">merge_dataframes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_highly_correlated_columns_v1"><code class="docutils literal notranslate"><span class="pre">remove_highly_correlated_columns_v1()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.filter_columns"><code class="docutils literal notranslate"><span class="pre">filter_columns()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.reduction_and_clustering"><code class="docutils literal notranslate"><span class="pre">reduction_and_clustering()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_noise"><code class="docutils literal notranslate"><span class="pre">remove_noise()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_embedding"><code class="docutils literal notranslate"><span class="pre">plot_embedding()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.generate_colors"><code class="docutils literal notranslate"><span class="pre">generate_colors()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.assign_colors"><code class="docutils literal notranslate"><span class="pre">assign_colors()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.setup_plot"><code class="docutils literal notranslate"><span class="pre">setup_plot()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_clusters"><code class="docutils literal notranslate"><span class="pre">plot_clusters()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_umap_images"><code class="docutils literal notranslate"><span class="pre">plot_umap_images()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_images_by_cluster"><code class="docutils literal notranslate"><span class="pre">plot_images_by_cluster()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_image"><code class="docutils literal notranslate"><span class="pre">plot_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_canvas"><code class="docutils literal notranslate"><span class="pre">remove_canvas()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_clusters_grid"><code class="docutils literal notranslate"><span class="pre">plot_clusters_grid()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.plot_grid"><code class="docutils literal notranslate"><span class="pre">plot_grid()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.generate_path_list_from_db"><code class="docutils literal notranslate"><span class="pre">generate_path_list_from_db()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.correct_paths"><code class="docutils literal notranslate"><span class="pre">correct_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.delete_folder"><code class="docutils literal notranslate"><span class="pre">delete_folder()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.measure_test_mode"><code class="docutils literal notranslate"><span class="pre">measure_test_mode()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.preprocess_data"><code class="docutils literal notranslate"><span class="pre">preprocess_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_low_variance_columns"><code class="docutils literal notranslate"><span class="pre">remove_low_variance_columns()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_highly_correlated_columns"><code class="docutils literal notranslate"><span class="pre">remove_highly_correlated_columns()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.filter_dataframe_features"><code class="docutils literal notranslate"><span class="pre">filter_dataframe_features()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.check_overlap"><code class="docutils literal notranslate"><span class="pre">check_overlap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.find_non_overlapping_position"><code class="docutils literal notranslate"><span class="pre">find_non_overlapping_position()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.search_reduction_and_clustering"><code class="docutils literal notranslate"><span class="pre">search_reduction_and_clustering()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.load_image"><code class="docutils literal notranslate"><span class="pre">load_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.extract_features"><code class="docutils literal notranslate"><span class="pre">extract_features()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.check_normality"><code class="docutils literal notranslate"><span class="pre">check_normality()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.random_forest_feature_importance"><code class="docutils literal notranslate"><span class="pre">random_forest_feature_importance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.perform_statistical_tests"><code class="docutils literal notranslate"><span class="pre">perform_statistical_tests()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.combine_results"><code class="docutils literal notranslate"><span class="pre">combine_results()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.cluster_feature_analysis"><code class="docutils literal notranslate"><span class="pre">cluster_feature_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.process_mask_file_adjust_cell"><code class="docutils literal notranslate"><span class="pre">process_mask_file_adjust_cell()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.adjust_cell_masks"><code class="docutils literal notranslate"><span class="pre">adjust_cell_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.adjust_cell_masks_v1"><code class="docutils literal notranslate"><span class="pre">adjust_cell_masks_v1()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.process_masks"><code class="docutils literal notranslate"><span class="pre">process_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.merge_regression_res_with_metadata"><code class="docutils literal notranslate"><span class="pre">merge_regression_res_with_metadata()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.process_vision_results"><code class="docutils literal notranslate"><span class="pre">process_vision_results()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_ml_results_paths"><code class="docutils literal notranslate"><span class="pre">get_ml_results_paths()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.augment_image"><code class="docutils literal notranslate"><span class="pre">augment_image()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.augment_dataset"><code class="docutils literal notranslate"><span class="pre">augment_dataset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.convert_and_relabel_masks"><code class="docutils literal notranslate"><span class="pre">convert_and_relabel_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.correct_masks"><code class="docutils literal notranslate"><span class="pre">correct_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.count_reads_in_fastq"><code class="docutils literal notranslate"><span class="pre">count_reads_in_fastq()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.get_cuda_version"><code class="docutils literal notranslate"><span class="pre">get_cuda_version()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.all_elements_match"><code class="docutils literal notranslate"><span class="pre">all_elements_match()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.prepare_batch_for_segmentation"><code class="docutils literal notranslate"><span class="pre">prepare_batch_for_segmentation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.check_index"><code class="docutils literal notranslate"><span class="pre">check_index()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.map_condition"><code class="docutils literal notranslate"><span class="pre">map_condition()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.download_models"><code class="docutils literal notranslate"><span class="pre">download_models()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.generate_cytoplasm_mask"><code class="docutils literal notranslate"><span class="pre">generate_cytoplasm_mask()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.add_column_to_database"><code class="docutils literal notranslate"><span class="pre">add_column_to_database()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.fill_holes_in_mask"><code class="docutils literal notranslate"><span class="pre">fill_holes_in_mask()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.correct_metadata_column_names"><code class="docutils literal notranslate"><span class="pre">correct_metadata_column_names()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.control_filelist"><code class="docutils literal notranslate"><span class="pre">control_filelist()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.rename_columns_in_db"><code class="docutils literal notranslate"><span class="pre">rename_columns_in_db()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.group_feature_class"><code class="docutils literal notranslate"><span class="pre">group_feature_class()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.delete_intermedeate_files"><code class="docutils literal notranslate"><span class="pre">delete_intermedeate_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.filter_and_save_csv"><code class="docutils literal notranslate"><span class="pre">filter_and_save_csv()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.extract_tar_bz2_files"><code class="docutils literal notranslate"><span class="pre">extract_tar_bz2_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.calculate_shortest_distance"><code class="docutils literal notranslate"><span class="pre">calculate_shortest_distance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.format_path_for_system"><code class="docutils literal notranslate"><span class="pre">format_path_for_system()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.normalize_src_path"><code class="docutils literal notranslate"><span class="pre">normalize_src_path()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.generate_image_path_map"><code class="docutils literal notranslate"><span class="pre">generate_image_path_map()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.copy_images_to_consolidated"><code class="docutils literal notranslate"><span class="pre">copy_images_to_consolidated()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.correct_metadata"><code class="docutils literal notranslate"><span class="pre">correct_metadata()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/utils/index.html#spacr.utils.remove_outliers_by_group"><code class="docutils literal notranslate"><span class="pre">remove_outliers_by_group()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/settings/index.html">Settings</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/settings/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_plot_merge_settings"><code class="docutils literal notranslate"><span class="pre">set_default_plot_merge_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_settings_preprocess_generate_masks"><code class="docutils literal notranslate"><span class="pre">set_default_settings_preprocess_generate_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_plot_data_from_db"><code class="docutils literal notranslate"><span class="pre">set_default_plot_data_from_db()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_settings_preprocess_img_data"><code class="docutils literal notranslate"><span class="pre">set_default_settings_preprocess_img_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_umap_image_settings"><code class="docutils literal notranslate"><span class="pre">set_default_umap_image_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_measure_crop_settings"><code class="docutils literal notranslate"><span class="pre">get_measure_crop_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_analyze_screen"><code class="docutils literal notranslate"><span class="pre">set_default_analyze_screen()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_train_test_model"><code class="docutils literal notranslate"><span class="pre">set_default_train_test_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_generate_training_dataset_defaults"><code class="docutils literal notranslate"><span class="pre">set_generate_training_dataset_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.deep_spacr_defaults"><code class="docutils literal notranslate"><span class="pre">deep_spacr_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_train_test_model_settings"><code class="docutils literal notranslate"><span class="pre">get_train_test_model_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_analyze_recruitment_default_settings"><code class="docutils literal notranslate"><span class="pre">get_analyze_recruitment_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_default_test_cellpose_model_settings"><code class="docutils literal notranslate"><span class="pre">get_default_test_cellpose_model_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_default_apply_cellpose_model_settings"><code class="docutils literal notranslate"><span class="pre">get_default_apply_cellpose_model_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.default_settings_analyze_percent_positive"><code class="docutils literal notranslate"><span class="pre">default_settings_analyze_percent_positive()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_analyze_reads_default_settings"><code class="docutils literal notranslate"><span class="pre">get_analyze_reads_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_map_barcodes_default_settings"><code class="docutils literal notranslate"><span class="pre">get_map_barcodes_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_train_cellpose_default_settings"><code class="docutils literal notranslate"><span class="pre">get_train_cellpose_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_generate_dataset_defaults"><code class="docutils literal notranslate"><span class="pre">set_generate_dataset_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_perform_regression_default_settings"><code class="docutils literal notranslate"><span class="pre">get_perform_regression_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_check_cellpose_models_default_settings"><code class="docutils literal notranslate"><span class="pre">get_check_cellpose_models_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_identify_masks_finetune_default_settings"><code class="docutils literal notranslate"><span class="pre">get_identify_masks_finetune_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.q"><code class="docutils literal notranslate"><span class="pre">q</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.expected_types"><code class="docutils literal notranslate"><span class="pre">expected_types</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.categories"><code class="docutils literal notranslate"><span class="pre">categories</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.category_keys"><code class="docutils literal notranslate"><span class="pre">category_keys</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.check_settings"><code class="docutils literal notranslate"><span class="pre">check_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.generate_fields"><code class="docutils literal notranslate"><span class="pre">generate_fields()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.descriptions"><code class="docutils literal notranslate"><span class="pre">descriptions</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_annotate_default_settings"><code class="docutils literal notranslate"><span class="pre">set_annotate_default_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_default_generate_barecode_mapping"><code class="docutils literal notranslate"><span class="pre">set_default_generate_barecode_mapping()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_default_generate_activation_map_settings"><code class="docutils literal notranslate"><span class="pre">get_default_generate_activation_map_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_analyze_plaque_settings"><code class="docutils literal notranslate"><span class="pre">get_analyze_plaque_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_graph_importance_defaults"><code class="docutils literal notranslate"><span class="pre">set_graph_importance_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_interperate_vision_model_defaults"><code class="docutils literal notranslate"><span class="pre">set_interperate_vision_model_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_analyze_endodyogeny_defaults"><code class="docutils literal notranslate"><span class="pre">set_analyze_endodyogeny_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.set_analyze_class_proportion_defaults"><code class="docutils literal notranslate"><span class="pre">set_analyze_class_proportion_defaults()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/settings/index.html#spacr.settings.get_plot_data_from_csv_default_settings"><code class="docutils literal notranslate"><span class="pre">get_plot_data_from_csv_default_settings()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/sp_stats/index.html">Statistics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#spacr.sp_stats.choose_p_adjust_method"><code class="docutils literal notranslate"><span class="pre">choose_p_adjust_method()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#spacr.sp_stats.perform_normality_tests"><code class="docutils literal notranslate"><span class="pre">perform_normality_tests()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#spacr.sp_stats.perform_levene_test"><code class="docutils literal notranslate"><span class="pre">perform_levene_test()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#spacr.sp_stats.perform_statistical_tests"><code class="docutils literal notranslate"><span class="pre">perform_statistical_tests()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#spacr.sp_stats.perform_posthoc_tests"><code class="docutils literal notranslate"><span class="pre">perform_posthoc_tests()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sp_stats/index.html#spacr.sp_stats.chi_pairwise"><code class="docutils literal notranslate"><span class="pre">chi_pairwise()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Image Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/measure/index.html">Measurement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/measure/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.get_components"><code class="docutils literal notranslate"><span class="pre">get_components()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.save_and_add_image_to_grid"><code class="docutils literal notranslate"><span class="pre">save_and_add_image_to_grid()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.img_list_to_grid"><code class="docutils literal notranslate"><span class="pre">img_list_to_grid()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.measure_crop"><code class="docutils literal notranslate"><span class="pre">measure_crop()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.process_meassure_crop_results"><code class="docutils literal notranslate"><span class="pre">process_meassure_crop_results()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.generate_cellpose_train_set"><code class="docutils literal notranslate"><span class="pre">generate_cellpose_train_set()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/measure/index.html#spacr.measure.get_object_counts"><code class="docutils literal notranslate"><span class="pre">get_object_counts()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/plot/index.html">Plotting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/plot/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_image_mask_overlay"><code class="docutils literal notranslate"><span class="pre">plot_image_mask_overlay()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_cellpose4_output"><code class="docutils literal notranslate"><span class="pre">plot_cellpose4_output()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_masks"><code class="docutils literal notranslate"><span class="pre">plot_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.generate_mask_random_cmap"><code class="docutils literal notranslate"><span class="pre">generate_mask_random_cmap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.random_cmap"><code class="docutils literal notranslate"><span class="pre">random_cmap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_images_and_arrays"><code class="docutils literal notranslate"><span class="pre">plot_images_and_arrays()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_arrays"><code class="docutils literal notranslate"><span class="pre">plot_arrays()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_arrays_v1"><code class="docutils literal notranslate"><span class="pre">plot_arrays_v1()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_merged"><code class="docutils literal notranslate"><span class="pre">plot_merged()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.generate_plate_heatmap"><code class="docutils literal notranslate"><span class="pre">generate_plate_heatmap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_plates"><code class="docutils literal notranslate"><span class="pre">plot_plates()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.print_mask_and_flows"><code class="docutils literal notranslate"><span class="pre">print_mask_and_flows()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_resize"><code class="docutils literal notranslate"><span class="pre">plot_resize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.normalize_and_visualize"><code class="docutils literal notranslate"><span class="pre">normalize_and_visualize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.visualize_masks"><code class="docutils literal notranslate"><span class="pre">visualize_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.visualize_cellpose_masks"><code class="docutils literal notranslate"><span class="pre">visualize_cellpose_masks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_comparison_results"><code class="docutils literal notranslate"><span class="pre">plot_comparison_results()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_object_outlines"><code class="docutils literal notranslate"><span class="pre">plot_object_outlines()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.volcano_plot"><code class="docutils literal notranslate"><span class="pre">volcano_plot()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_histogram"><code class="docutils literal notranslate"><span class="pre">plot_histogram()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_lorenz_curves"><code class="docutils literal notranslate"><span class="pre">plot_lorenz_curves()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_permutation"><code class="docutils literal notranslate"><span class="pre">plot_permutation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_feature_importance"><code class="docutils literal notranslate"><span class="pre">plot_feature_importance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.read_and_plot__vision_results"><code class="docutils literal notranslate"><span class="pre">read_and_plot__vision_results()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.jitterplot_by_annotation"><code class="docutils literal notranslate"><span class="pre">jitterplot_by_annotation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.create_grouped_plot"><code class="docutils literal notranslate"><span class="pre">create_grouped_plot()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph"><code class="docutils literal notranslate"><span class="pre">spacrGraph</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.df"><code class="docutils literal notranslate"><span class="pre">spacrGraph.df</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.grouping_column"><code class="docutils literal notranslate"><span class="pre">spacrGraph.grouping_column</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.order"><code class="docutils literal notranslate"><span class="pre">spacrGraph.order</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.data_column"><code class="docutils literal notranslate"><span class="pre">spacrGraph.data_column</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.graph_type"><code class="docutils literal notranslate"><span class="pre">spacrGraph.graph_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.summary_func"><code class="docutils literal notranslate"><span class="pre">spacrGraph.summary_func</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.colors"><code class="docutils literal notranslate"><span class="pre">spacrGraph.colors</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.output_dir"><code class="docutils literal notranslate"><span class="pre">spacrGraph.output_dir</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.save"><code class="docutils literal notranslate"><span class="pre">spacrGraph.save</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.error_bar_type"><code class="docutils literal notranslate"><span class="pre">spacrGraph.error_bar_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.remove_outliers"><code class="docutils literal notranslate"><span class="pre">spacrGraph.remove_outliers</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.theme"><code class="docutils literal notranslate"><span class="pre">spacrGraph.theme</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.representation"><code class="docutils literal notranslate"><span class="pre">spacrGraph.representation</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.paired"><code class="docutils literal notranslate"><span class="pre">spacrGraph.paired</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.all_to_all"><code class="docutils literal notranslate"><span class="pre">spacrGraph.all_to_all</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.compare_group"><code class="docutils literal notranslate"><span class="pre">spacrGraph.compare_group</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.y_lim"><code class="docutils literal notranslate"><span class="pre">spacrGraph.y_lim</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.graph_name"><code class="docutils literal notranslate"><span class="pre">spacrGraph.graph_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.log_x"><code class="docutils literal notranslate"><span class="pre">spacrGraph.log_x</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.log_y"><code class="docutils literal notranslate"><span class="pre">spacrGraph.log_y</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.results_df"><code class="docutils literal notranslate"><span class="pre">spacrGraph.results_df</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.sns_palette"><code class="docutils literal notranslate"><span class="pre">spacrGraph.sns_palette</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.fig"><code class="docutils literal notranslate"><span class="pre">spacrGraph.fig</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.results_name"><code class="docutils literal notranslate"><span class="pre">spacrGraph.results_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.raw_df"><code class="docutils literal notranslate"><span class="pre">spacrGraph.raw_df</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.preprocess_data"><code class="docutils literal notranslate"><span class="pre">spacrGraph.preprocess_data()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.remove_outliers_from_plot"><code class="docutils literal notranslate"><span class="pre">spacrGraph.remove_outliers_from_plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.perform_normality_tests"><code class="docutils literal notranslate"><span class="pre">spacrGraph.perform_normality_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.perform_levene_test"><code class="docutils literal notranslate"><span class="pre">spacrGraph.perform_levene_test()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.perform_statistical_tests"><code class="docutils literal notranslate"><span class="pre">spacrGraph.perform_statistical_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.perform_posthoc_tests"><code class="docutils literal notranslate"><span class="pre">spacrGraph.perform_posthoc_tests()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.create_plot"><code class="docutils literal notranslate"><span class="pre">spacrGraph.create_plot()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.get_results"><code class="docutils literal notranslate"><span class="pre">spacrGraph.get_results()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.spacrGraph.get_figure"><code class="docutils literal notranslate"><span class="pre">spacrGraph.get_figure()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_data_from_db"><code class="docutils literal notranslate"><span class="pre">plot_data_from_db()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_data_from_csv"><code class="docutils literal notranslate"><span class="pre">plot_data_from_csv()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_region"><code class="docutils literal notranslate"><span class="pre">plot_region()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_image_grid"><code class="docutils literal notranslate"><span class="pre">plot_image_grid()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.overlay_masks_on_images"><code class="docutils literal notranslate"><span class="pre">overlay_masks_on_images()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.graph_importance"><code class="docutils literal notranslate"><span class="pre">graph_importance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.plot_proportion_stacked_bars"><code class="docutils literal notranslate"><span class="pre">plot_proportion_stacked_bars()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/plot/index.html#spacr.plot.create_venn_diagram"><code class="docutils literal notranslate"><span class="pre">create_venn_diagram()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html">Cellpose Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.parse_cellpose4_output"><code class="docutils literal notranslate"><span class="pre">parse_cellpose4_output()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.identify_masks_finetune"><code class="docutils literal notranslate"><span class="pre">identify_masks_finetune()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.generate_masks_from_imgs"><code class="docutils literal notranslate"><span class="pre">generate_masks_from_imgs()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.check_cellpose_models"><code class="docutils literal notranslate"><span class="pre">check_cellpose_models()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.save_results_and_figure"><code class="docutils literal notranslate"><span class="pre">save_results_and_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.compare_mask"><code class="docutils literal notranslate"><span class="pre">compare_mask()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/spacr_cellpose/index.html#spacr.spacr_cellpose.compare_cellpose_masks"><code class="docutils literal notranslate"><span class="pre">compare_cellpose_masks()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Classification</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/ml/index.html">Classical ML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/ml/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.QuasiBinomial"><code class="docutils literal notranslate"><span class="pre">QuasiBinomial</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.QuasiBinomial.dispersion"><code class="docutils literal notranslate"><span class="pre">QuasiBinomial.dispersion</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.QuasiBinomial.variance"><code class="docutils literal notranslate"><span class="pre">QuasiBinomial.variance()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.calculate_p_values"><code class="docutils literal notranslate"><span class="pre">calculate_p_values()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.perform_mixed_model"><code class="docutils literal notranslate"><span class="pre">perform_mixed_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.create_volcano_filename"><code class="docutils literal notranslate"><span class="pre">create_volcano_filename()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.scale_variables"><code class="docutils literal notranslate"><span class="pre">scale_variables()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.select_glm_family"><code class="docutils literal notranslate"><span class="pre">select_glm_family()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.prepare_formula"><code class="docutils literal notranslate"><span class="pre">prepare_formula()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.fit_mixed_model"><code class="docutils literal notranslate"><span class="pre">fit_mixed_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.check_and_clean_data"><code class="docutils literal notranslate"><span class="pre">check_and_clean_data()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.minimum_cell_simulation"><code class="docutils literal notranslate"><span class="pre">minimum_cell_simulation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.process_model_coefficients"><code class="docutils literal notranslate"><span class="pre">process_model_coefficients()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.check_distribution"><code class="docutils literal notranslate"><span class="pre">check_distribution()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.pick_glm_family_and_link"><code class="docutils literal notranslate"><span class="pre">pick_glm_family_and_link()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.regression_model"><code class="docutils literal notranslate"><span class="pre">regression_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.regression"><code class="docutils literal notranslate"><span class="pre">regression()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.save_summary_to_file"><code class="docutils literal notranslate"><span class="pre">save_summary_to_file()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.perform_regression"><code class="docutils literal notranslate"><span class="pre">perform_regression()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.process_reads"><code class="docutils literal notranslate"><span class="pre">process_reads()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.apply_transformation"><code class="docutils literal notranslate"><span class="pre">apply_transformation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.check_normality"><code class="docutils literal notranslate"><span class="pre">check_normality()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.clean_controls"><code class="docutils literal notranslate"><span class="pre">clean_controls()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.process_scores"><code class="docutils literal notranslate"><span class="pre">process_scores()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.generate_ml_scores"><code class="docutils literal notranslate"><span class="pre">generate_ml_scores()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.ml_analysis"><code class="docutils literal notranslate"><span class="pre">ml_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.shap_analysis"><code class="docutils literal notranslate"><span class="pre">shap_analysis()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.find_optimal_threshold"><code class="docutils literal notranslate"><span class="pre">find_optimal_threshold()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/ml/index.html#spacr.ml.interperate_vision_model"><code class="docutils literal notranslate"><span class="pre">interperate_vision_model()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html">Deep Learning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.apply_model"><code class="docutils literal notranslate"><span class="pre">apply_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.apply_model_to_tar"><code class="docutils literal notranslate"><span class="pre">apply_model_to_tar()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.evaluate_model_performance"><code class="docutils literal notranslate"><span class="pre">evaluate_model_performance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.test_model_core"><code class="docutils literal notranslate"><span class="pre">test_model_core()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.test_model_performance"><code class="docutils literal notranslate"><span class="pre">test_model_performance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.train_test_model"><code class="docutils literal notranslate"><span class="pre">train_test_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.train_model"><code class="docutils literal notranslate"><span class="pre">train_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.generate_activation_map"><code class="docutils literal notranslate"><span class="pre">generate_activation_map()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.visualize_classes"><code class="docutils literal notranslate"><span class="pre">visualize_classes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.visualize_integrated_gradients"><code class="docutils literal notranslate"><span class="pre">visualize_integrated_gradients()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.SmoothGrad"><code class="docutils literal notranslate"><span class="pre">SmoothGrad</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.SmoothGrad.model"><code class="docutils literal notranslate"><span class="pre">SmoothGrad.model</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.SmoothGrad.n_samples"><code class="docutils literal notranslate"><span class="pre">SmoothGrad.n_samples</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.SmoothGrad.stdev_spread"><code class="docutils literal notranslate"><span class="pre">SmoothGrad.stdev_spread</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.SmoothGrad.compute_smooth_grad"><code class="docutils literal notranslate"><span class="pre">SmoothGrad.compute_smooth_grad()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.visualize_smooth_grad"><code class="docutils literal notranslate"><span class="pre">visualize_smooth_grad()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.deep_spacr"><code class="docutils literal notranslate"><span class="pre">deep_spacr()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.model_knowledge_transfer"><code class="docutils literal notranslate"><span class="pre">model_knowledge_transfer()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.model_fusion"><code class="docutils literal notranslate"><span class="pre">model_fusion()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/deep_spacr/index.html#spacr.deep_spacr.annotate_filter_vision"><code class="docutils literal notranslate"><span class="pre">annotate_filter_vision()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GUI Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/gui/index.html">GUI Main App</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/gui/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp"><code class="docutils literal notranslate"><span class="pre">MainApp</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.color_settings"><code class="docutils literal notranslate"><span class="pre">MainApp.color_settings</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.main_buttons"><code class="docutils literal notranslate"><span class="pre">MainApp.main_buttons</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.additional_buttons"><code class="docutils literal notranslate"><span class="pre">MainApp.additional_buttons</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.main_gui_apps"><code class="docutils literal notranslate"><span class="pre">MainApp.main_gui_apps</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.additional_gui_apps"><code class="docutils literal notranslate"><span class="pre">MainApp.additional_gui_apps</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.selected_app"><code class="docutils literal notranslate"><span class="pre">MainApp.selected_app</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.create_widgets"><code class="docutils literal notranslate"><span class="pre">MainApp.create_widgets()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.create_startup_screen"><code class="docutils literal notranslate"><span class="pre">MainApp.create_startup_screen()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.update_description"><code class="docutils literal notranslate"><span class="pre">MainApp.update_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.show_description"><code class="docutils literal notranslate"><span class="pre">MainApp.show_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.clear_description"><code class="docutils literal notranslate"><span class="pre">MainApp.clear_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.load_app"><code class="docutils literal notranslate"><span class="pre">MainApp.load_app()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.MainApp.clear_frame"><code class="docutils literal notranslate"><span class="pre">MainApp.clear_frame()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui/index.html#spacr.gui.gui_app"><code class="docutils literal notranslate"><span class="pre">gui_app()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/gui_core/index.html">GUI Core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/gui_core/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.q"><code class="docutils literal notranslate"><span class="pre">q</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.console_output"><code class="docutils literal notranslate"><span class="pre">console_output</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.parent_frame"><code class="docutils literal notranslate"><span class="pre">parent_frame</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.vars_dict"><code class="docutils literal notranslate"><span class="pre">vars_dict</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.canvas"><code class="docutils literal notranslate"><span class="pre">canvas</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.canvas_widget"><code class="docutils literal notranslate"><span class="pre">canvas_widget</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.scrollable_frame"><code class="docutils literal notranslate"><span class="pre">scrollable_frame</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.progress_label"><code class="docutils literal notranslate"><span class="pre">progress_label</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.fig_queue"><code class="docutils literal notranslate"><span class="pre">fig_queue</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.figures"><code class="docutils literal notranslate"><span class="pre">figures</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.figure_index"><code class="docutils literal notranslate"><span class="pre">figure_index</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.progress_bar"><code class="docutils literal notranslate"><span class="pre">progress_bar</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.usage_bars"><code class="docutils literal notranslate"><span class="pre">usage_bars</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.index_control"><code class="docutils literal notranslate"><span class="pre">index_control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.thread_control"><code class="docutils literal notranslate"><span class="pre">thread_control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.toggle_settings"><code class="docutils literal notranslate"><span class="pre">toggle_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.display_figure"><code class="docutils literal notranslate"><span class="pre">display_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.clear_unused_figures"><code class="docutils literal notranslate"><span class="pre">clear_unused_figures()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.show_previous_figure"><code class="docutils literal notranslate"><span class="pre">show_previous_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.show_next_figure"><code class="docutils literal notranslate"><span class="pre">show_next_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.process_fig_queue"><code class="docutils literal notranslate"><span class="pre">process_fig_queue()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.update_figure"><code class="docutils literal notranslate"><span class="pre">update_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_plot_section"><code class="docutils literal notranslate"><span class="pre">setup_plot_section()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.set_globals"><code class="docutils literal notranslate"><span class="pre">set_globals()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.import_settings"><code class="docutils literal notranslate"><span class="pre">import_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_settings_panel"><code class="docutils literal notranslate"><span class="pre">setup_settings_panel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_console"><code class="docutils literal notranslate"><span class="pre">setup_console()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_button_section"><code class="docutils literal notranslate"><span class="pre">setup_button_section()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.setup_usage_panel"><code class="docutils literal notranslate"><span class="pre">setup_usage_panel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.initiate_abort"><code class="docutils literal notranslate"><span class="pre">initiate_abort()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.check_src_folders_files"><code class="docutils literal notranslate"><span class="pre">check_src_folders_files()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.start_process"><code class="docutils literal notranslate"><span class="pre">start_process()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.process_console_queue"><code class="docutils literal notranslate"><span class="pre">process_console_queue()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.main_thread_update_function"><code class="docutils literal notranslate"><span class="pre">main_thread_update_function()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.cleanup_previous_instance"><code class="docutils literal notranslate"><span class="pre">cleanup_previous_instance()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_core/index.html#spacr.gui_core.initiate_root"><code class="docutils literal notranslate"><span class="pre">initiate_root()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/gui_elements/index.html">GUI Elements</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.fig"><code class="docutils literal notranslate"><span class="pre">fig</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.restart_gui_app"><code class="docutils literal notranslate"><span class="pre">restart_gui_app()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.create_menu_bar"><code class="docutils literal notranslate"><span class="pre">create_menu_bar()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.set_element_size"><code class="docutils literal notranslate"><span class="pre">set_element_size()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.set_dark_style"><code class="docutils literal notranslate"><span class="pre">set_dark_style()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont"><code class="docutils literal notranslate"><span class="pre">spacrFont</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.font_name"><code class="docutils literal notranslate"><span class="pre">spacrFont.font_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.font_style"><code class="docutils literal notranslate"><span class="pre">spacrFont.font_style</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.font_size"><code class="docutils literal notranslate"><span class="pre">spacrFont.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.font_path"><code class="docutils literal notranslate"><span class="pre">spacrFont.font_path</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.get_font_path"><code class="docutils literal notranslate"><span class="pre">spacrFont.get_font_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.load_font"><code class="docutils literal notranslate"><span class="pre">spacrFont.load_font()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFont.get_font"><code class="docutils literal notranslate"><span class="pre">spacrFont.get_font()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer"><code class="docutils literal notranslate"><span class="pre">spacrContainer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.orient"><code class="docutils literal notranslate"><span class="pre">spacrContainer.orient</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.bg"><code class="docutils literal notranslate"><span class="pre">spacrContainer.bg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.sash_thickness"><code class="docutils literal notranslate"><span class="pre">spacrContainer.sash_thickness</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.panes"><code class="docutils literal notranslate"><span class="pre">spacrContainer.panes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.sashes"><code class="docutils literal notranslate"><span class="pre">spacrContainer.sashes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.add"><code class="docutils literal notranslate"><span class="pre">spacrContainer.add()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.create_sash"><code class="docutils literal notranslate"><span class="pre">spacrContainer.create_sash()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.reposition_panes"><code class="docutils literal notranslate"><span class="pre">spacrContainer.reposition_panes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.on_configure"><code class="docutils literal notranslate"><span class="pre">spacrContainer.on_configure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.on_enter_sash"><code class="docutils literal notranslate"><span class="pre">spacrContainer.on_enter_sash()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.on_leave_sash"><code class="docutils literal notranslate"><span class="pre">spacrContainer.on_leave_sash()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.start_resize"><code class="docutils literal notranslate"><span class="pre">spacrContainer.start_resize()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrContainer.perform_resize"><code class="docutils literal notranslate"><span class="pre">spacrContainer.perform_resize()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry"><code class="docutils literal notranslate"><span class="pre">spacrEntry</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrEntry.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.active_color"><code class="docutils literal notranslate"><span class="pre">spacrEntry.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrEntry.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.outline"><code class="docutils literal notranslate"><span class="pre">spacrEntry.outline</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.font_family"><code class="docutils literal notranslate"><span class="pre">spacrEntry.font_family</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.font_size"><code class="docutils literal notranslate"><span class="pre">spacrEntry.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.font_loader"><code class="docutils literal notranslate"><span class="pre">spacrEntry.font_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.canvas_height"><code class="docutils literal notranslate"><span class="pre">spacrEntry.canvas_height</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.canvas"><code class="docutils literal notranslate"><span class="pre">spacrEntry.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.draw_rounded_rectangle"><code class="docutils literal notranslate"><span class="pre">spacrEntry.draw_rounded_rectangle()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.on_focus_in"><code class="docutils literal notranslate"><span class="pre">spacrEntry.on_focus_in()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrEntry.on_focus_out"><code class="docutils literal notranslate"><span class="pre">spacrEntry.on_focus_out()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck"><code class="docutils literal notranslate"><span class="pre">spacrCheck</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrCheck.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.active_color"><code class="docutils literal notranslate"><span class="pre">spacrCheck.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrCheck.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrCheck.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.variable"><code class="docutils literal notranslate"><span class="pre">spacrCheck.variable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.canvas_width"><code class="docutils literal notranslate"><span class="pre">spacrCheck.canvas_width</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.canvas_height"><code class="docutils literal notranslate"><span class="pre">spacrCheck.canvas_height</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.canvas"><code class="docutils literal notranslate"><span class="pre">spacrCheck.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.draw_rounded_square"><code class="docutils literal notranslate"><span class="pre">spacrCheck.draw_rounded_square()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.update_check"><code class="docutils literal notranslate"><span class="pre">spacrCheck.update_check()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheck.toggle_variable"><code class="docutils literal notranslate"><span class="pre">spacrCheck.toggle_variable()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo"><code class="docutils literal notranslate"><span class="pre">spacrCombo</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrCombo.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.active_color"><code class="docutils literal notranslate"><span class="pre">spacrCombo.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrCombo.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrCombo.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.font_family"><code class="docutils literal notranslate"><span class="pre">spacrCombo.font_family</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.font_size"><code class="docutils literal notranslate"><span class="pre">spacrCombo.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.font_loader"><code class="docutils literal notranslate"><span class="pre">spacrCombo.font_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.values"><code class="docutils literal notranslate"><span class="pre">spacrCombo.values</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.canvas_width"><code class="docutils literal notranslate"><span class="pre">spacrCombo.canvas_width</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.canvas_height"><code class="docutils literal notranslate"><span class="pre">spacrCombo.canvas_height</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.canvas"><code class="docutils literal notranslate"><span class="pre">spacrCombo.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.var"><code class="docutils literal notranslate"><span class="pre">spacrCombo.var</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.selected_value"><code class="docutils literal notranslate"><span class="pre">spacrCombo.selected_value</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.dropdown_menu"><code class="docutils literal notranslate"><span class="pre">spacrCombo.dropdown_menu</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.draw_rounded_rectangle"><code class="docutils literal notranslate"><span class="pre">spacrCombo.draw_rounded_rectangle()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.on_click"><code class="docutils literal notranslate"><span class="pre">spacrCombo.on_click()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.open_dropdown"><code class="docutils literal notranslate"><span class="pre">spacrCombo.open_dropdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.close_dropdown"><code class="docutils literal notranslate"><span class="pre">spacrCombo.close_dropdown()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.on_select"><code class="docutils literal notranslate"><span class="pre">spacrCombo.on_select()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCombo.set"><code class="docutils literal notranslate"><span class="pre">spacrCombo.set()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.variable"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.variable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.options"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.options</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.command"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.command</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.text"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.size"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.font_size"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.font_loader"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.font_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.button_width"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.button_width</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.canvas_width"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.canvas_width</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.canvas_height"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.canvas_height</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.canvas"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.active_color"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.button_bg"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.button_bg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.button_text"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.button_text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.menu"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.menu</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.create_rounded_rectangle"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.create_rounded_rectangle()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.on_enter"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.on_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.on_leave"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.on_leave()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.on_click"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.on_click()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.post_menu"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.post_menu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.on_select"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.on_select()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrDropdownMenu.update_styles"><code class="docutils literal notranslate"><span class="pre">spacrDropdownMenu.update_styles()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheckbutton"><code class="docutils literal notranslate"><span class="pre">spacrCheckbutton</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheckbutton.text"><code class="docutils literal notranslate"><span class="pre">spacrCheckbutton.text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheckbutton.variable"><code class="docutils literal notranslate"><span class="pre">spacrCheckbutton.variable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrCheckbutton.command"><code class="docutils literal notranslate"><span class="pre">spacrCheckbutton.command</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.active_color"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.font_size"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.font_loader"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.font_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.style"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.style</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.label"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.label</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.operation_type"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.operation_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.additional_info"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.additional_info</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.set_label_position"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.set_label_position()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrProgressBar.update_label"><code class="docutils literal notranslate"><span class="pre">spacrProgressBar.update_label()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider"><code class="docutils literal notranslate"><span class="pre">spacrSlider</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.specified_length"><code class="docutils literal notranslate"><span class="pre">spacrSlider.specified_length</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.knob_radius"><code class="docutils literal notranslate"><span class="pre">spacrSlider.knob_radius</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.thickness"><code class="docutils literal notranslate"><span class="pre">spacrSlider.thickness</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.knob_position"><code class="docutils literal notranslate"><span class="pre">spacrSlider.knob_position</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.slider_line"><code class="docutils literal notranslate"><span class="pre">spacrSlider.slider_line</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.knob"><code class="docutils literal notranslate"><span class="pre">spacrSlider.knob</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.position"><code class="docutils literal notranslate"><span class="pre">spacrSlider.position</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.offset"><code class="docutils literal notranslate"><span class="pre">spacrSlider.offset</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.from_"><code class="docutils literal notranslate"><span class="pre">spacrSlider.from_</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.to"><code class="docutils literal notranslate"><span class="pre">spacrSlider.to</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.value"><code class="docutils literal notranslate"><span class="pre">spacrSlider.value</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.show_index"><code class="docutils literal notranslate"><span class="pre">spacrSlider.show_index</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.command"><code class="docutils literal notranslate"><span class="pre">spacrSlider.command</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrSlider.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrSlider.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.active_color"><code class="docutils literal notranslate"><span class="pre">spacrSlider.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrSlider.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.canvas"><code class="docutils literal notranslate"><span class="pre">spacrSlider.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.length"><code class="docutils literal notranslate"><span class="pre">spacrSlider.length</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.resize_slider"><code class="docutils literal notranslate"><span class="pre">spacrSlider.resize_slider()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.value_to_position"><code class="docutils literal notranslate"><span class="pre">spacrSlider.value_to_position()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.position_to_value"><code class="docutils literal notranslate"><span class="pre">spacrSlider.position_to_value()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.draw_slider"><code class="docutils literal notranslate"><span class="pre">spacrSlider.draw_slider()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.move_knob"><code class="docutils literal notranslate"><span class="pre">spacrSlider.move_knob()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.activate_knob"><code class="docutils literal notranslate"><span class="pre">spacrSlider.activate_knob()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.release_knob"><code class="docutils literal notranslate"><span class="pre">spacrSlider.release_knob()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.set_to"><code class="docutils literal notranslate"><span class="pre">spacrSlider.set_to()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.get"><code class="docutils literal notranslate"><span class="pre">spacrSlider.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.set"><code class="docutils literal notranslate"><span class="pre">spacrSlider.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.jump_to_click"><code class="docutils literal notranslate"><span class="pre">spacrSlider.jump_to_click()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSlider.update_slider_from_entry"><code class="docutils literal notranslate"><span class="pre">spacrSlider.update_slider_from_entry()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrScrollbarStyle"><code class="docutils literal notranslate"><span class="pre">spacrScrollbarStyle()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFrame"><code class="docutils literal notranslate"><span class="pre">spacrFrame</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFrame.scrollable_frame"><code class="docutils literal notranslate"><span class="pre">spacrFrame.scrollable_frame</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFrame.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrFrame.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFrame.active_color"><code class="docutils literal notranslate"><span class="pre">spacrFrame.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFrame.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrFrame.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrFrame.rounded_rectangle"><code class="docutils literal notranslate"><span class="pre">spacrFrame.rounded_rectangle()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel"><code class="docutils literal notranslate"><span class="pre">spacrLabel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.text"><code class="docutils literal notranslate"><span class="pre">spacrLabel.text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.align"><code class="docutils literal notranslate"><span class="pre">spacrLabel.align</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.style_out"><code class="docutils literal notranslate"><span class="pre">spacrLabel.style_out</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.font_style"><code class="docutils literal notranslate"><span class="pre">spacrLabel.font_style</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.font_size"><code class="docutils literal notranslate"><span class="pre">spacrLabel.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.font_family"><code class="docutils literal notranslate"><span class="pre">spacrLabel.font_family</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.font_loader"><code class="docutils literal notranslate"><span class="pre">spacrLabel.font_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.canvas"><code class="docutils literal notranslate"><span class="pre">spacrLabel.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.style"><code class="docutils literal notranslate"><span class="pre">spacrLabel.style</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrLabel.set_text"><code class="docutils literal notranslate"><span class="pre">spacrLabel.set_text()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton"><code class="docutils literal notranslate"><span class="pre">spacrButton</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.text"><code class="docutils literal notranslate"><span class="pre">spacrButton.text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.command"><code class="docutils literal notranslate"><span class="pre">spacrButton.command</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.icon_name"><code class="docutils literal notranslate"><span class="pre">spacrButton.icon_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.size"><code class="docutils literal notranslate"><span class="pre">spacrButton.size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.show_text"><code class="docutils literal notranslate"><span class="pre">spacrButton.show_text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.outline"><code class="docutils literal notranslate"><span class="pre">spacrButton.outline</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.animation"><code class="docutils literal notranslate"><span class="pre">spacrButton.animation</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.font_size"><code class="docutils literal notranslate"><span class="pre">spacrButton.font_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.font_loader"><code class="docutils literal notranslate"><span class="pre">spacrButton.font_loader</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.canvas"><code class="docutils literal notranslate"><span class="pre">spacrButton.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.inactive_color"><code class="docutils literal notranslate"><span class="pre">spacrButton.inactive_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.bg_color"><code class="docutils literal notranslate"><span class="pre">spacrButton.bg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.active_color"><code class="docutils literal notranslate"><span class="pre">spacrButton.active_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.fg_color"><code class="docutils literal notranslate"><span class="pre">spacrButton.fg_color</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.is_zoomed_in"><code class="docutils literal notranslate"><span class="pre">spacrButton.is_zoomed_in</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.load_icon"><code class="docutils literal notranslate"><span class="pre">spacrButton.load_icon()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.get_icon_path"><code class="docutils literal notranslate"><span class="pre">spacrButton.get_icon_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.on_enter"><code class="docutils literal notranslate"><span class="pre">spacrButton.on_enter()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.on_leave"><code class="docutils literal notranslate"><span class="pre">spacrButton.on_leave()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.on_click"><code class="docutils literal notranslate"><span class="pre">spacrButton.on_click()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.create_rounded_rectangle"><code class="docutils literal notranslate"><span class="pre">spacrButton.create_rounded_rectangle()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.update_description"><code class="docutils literal notranslate"><span class="pre">spacrButton.update_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.clear_description"><code class="docutils literal notranslate"><span class="pre">spacrButton.clear_description()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.animate_zoom"><code class="docutils literal notranslate"><span class="pre">spacrButton.animate_zoom()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrButton.zoom_icon"><code class="docutils literal notranslate"><span class="pre">spacrButton.zoom_icon()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch"><code class="docutils literal notranslate"><span class="pre">spacrSwitch</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.text"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.variable"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.variable</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.command"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.command</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.canvas"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.canvas</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.switch_bg"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.switch_bg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.switch"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.switch</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.label"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.label</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.toggle"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.toggle()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.update_switch"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.update_switch()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.animate_switch"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.animate_switch()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.animate_movement"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.animate_movement()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.get"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.get()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.set"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.set()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrSwitch.create_rounded_rectangle"><code class="docutils literal notranslate"><span class="pre">spacrSwitch.create_rounded_rectangle()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrToolTip"><code class="docutils literal notranslate"><span class="pre">spacrToolTip</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrToolTip.widget"><code class="docutils literal notranslate"><span class="pre">spacrToolTip.widget</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrToolTip.text"><code class="docutils literal notranslate"><span class="pre">spacrToolTip.text</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrToolTip.tooltip_window"><code class="docutils literal notranslate"><span class="pre">spacrToolTip.tooltip_window</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrToolTip.show_tooltip"><code class="docutils literal notranslate"><span class="pre">spacrToolTip.show_tooltip()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.spacrToolTip.hide_tooltip"><code class="docutils literal notranslate"><span class="pre">spacrToolTip.hide_tooltip()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.standardize_figure"><code class="docutils literal notranslate"><span class="pre">standardize_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.modify_figure_properties"><code class="docutils literal notranslate"><span class="pre">modify_figure_properties()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.save_figure_as_format"><code class="docutils literal notranslate"><span class="pre">save_figure_as_format()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.modify_figure"><code class="docutils literal notranslate"><span class="pre">modify_figure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_elements/index.html#spacr.gui_elements.generate_dna_matrix"><code class="docutils literal notranslate"><span class="pre">generate_dna_matrix()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/gui_utils/index.html">GUI Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.initialize_cuda"><code class="docutils literal notranslate"><span class="pre">initialize_cuda()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.set_high_priority"><code class="docutils literal notranslate"><span class="pre">set_high_priority()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.set_cpu_affinity"><code class="docutils literal notranslate"><span class="pre">set_cpu_affinity()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.proceed_with_app"><code class="docutils literal notranslate"><span class="pre">proceed_with_app()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.load_app"><code class="docutils literal notranslate"><span class="pre">load_app()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.parse_list"><code class="docutils literal notranslate"><span class="pre">parse_list()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.create_input_field"><code class="docutils literal notranslate"><span class="pre">create_input_field()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.process_stdout_stderr"><code class="docutils literal notranslate"><span class="pre">process_stdout_stderr()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.WriteToQueue"><code class="docutils literal notranslate"><span class="pre">WriteToQueue</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.WriteToQueue.q"><code class="docutils literal notranslate"><span class="pre">WriteToQueue.q</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.WriteToQueue.write"><code class="docutils literal notranslate"><span class="pre">WriteToQueue.write()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.WriteToQueue.flush"><code class="docutils literal notranslate"><span class="pre">WriteToQueue.flush()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.cancel_after_tasks"><code class="docutils literal notranslate"><span class="pre">cancel_after_tasks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.load_next_app"><code class="docutils literal notranslate"><span class="pre">load_next_app()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.convert_settings_dict_for_gui"><code class="docutils literal notranslate"><span class="pre">convert_settings_dict_for_gui()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.spacrFigShow"><code class="docutils literal notranslate"><span class="pre">spacrFigShow()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.function_gui_wrapper"><code class="docutils literal notranslate"><span class="pre">function_gui_wrapper()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.run_function_gui"><code class="docutils literal notranslate"><span class="pre">run_function_gui()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.hide_all_settings"><code class="docutils literal notranslate"><span class="pre">hide_all_settings()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.setup_frame"><code class="docutils literal notranslate"><span class="pre">setup_frame()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.download_hug_dataset"><code class="docutils literal notranslate"><span class="pre">download_hug_dataset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.download_dataset"><code class="docutils literal notranslate"><span class="pre">download_dataset()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.ensure_after_tasks"><code class="docutils literal notranslate"><span class="pre">ensure_after_tasks()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.display_gif_in_plot_frame"><code class="docutils literal notranslate"><span class="pre">display_gif_in_plot_frame()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.display_media_in_plot_frame"><code class="docutils literal notranslate"><span class="pre">display_media_in_plot_frame()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.print_widget_structure"><code class="docutils literal notranslate"><span class="pre">print_widget_structure()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.get_screen_dimensions"><code class="docutils literal notranslate"><span class="pre">get_screen_dimensions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/gui_utils/index.html#spacr.gui_utils.convert_to_number"><code class="docutils literal notranslate"><span class="pre">convert_to_number()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Sequencing &amp; Submodules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/sequencing/index.html">Sequencing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/sequencing/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.map_sequences_to_names"><code class="docutils literal notranslate"><span class="pre">map_sequences_to_names()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.save_df_to_hdf5"><code class="docutils literal notranslate"><span class="pre">save_df_to_hdf5()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.save_unique_combinations_to_csv"><code class="docutils literal notranslate"><span class="pre">save_unique_combinations_to_csv()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.save_qc_df_to_csv"><code class="docutils literal notranslate"><span class="pre">save_qc_df_to_csv()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.extract_sequence_and_quality"><code class="docutils literal notranslate"><span class="pre">extract_sequence_and_quality()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.create_consensus"><code class="docutils literal notranslate"><span class="pre">create_consensus()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.get_consensus_base"><code class="docutils literal notranslate"><span class="pre">get_consensus_base()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.reverse_complement"><code class="docutils literal notranslate"><span class="pre">reverse_complement()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.process_chunk"><code class="docutils literal notranslate"><span class="pre">process_chunk()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.saver_process"><code class="docutils literal notranslate"><span class="pre">saver_process()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.paired_read_chunked_processing"><code class="docutils literal notranslate"><span class="pre">paired_read_chunked_processing()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.single_read_chunked_processing"><code class="docutils literal notranslate"><span class="pre">single_read_chunked_processing()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.generate_barecode_mapping"><code class="docutils literal notranslate"><span class="pre">generate_barecode_mapping()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.barecodes_reverse_complement"><code class="docutils literal notranslate"><span class="pre">barecodes_reverse_complement()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/sequencing/index.html#spacr.sequencing.graph_sequencing_stats"><code class="docutils literal notranslate"><span class="pre">graph_sequencing_stats()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/toxo/index.html">Toxoplasma Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/toxo/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/toxo/index.html#spacr.toxo.custom_volcano_plot"><code class="docutils literal notranslate"><span class="pre">custom_volcano_plot()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/toxo/index.html#spacr.toxo.go_term_enrichment_by_column"><code class="docutils literal notranslate"><span class="pre">go_term_enrichment_by_column()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/toxo/index.html#spacr.toxo.plot_gene_phenotypes"><code class="docutils literal notranslate"><span class="pre">plot_gene_phenotypes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/toxo/index.html#spacr.toxo.plot_gene_heatmaps"><code class="docutils literal notranslate"><span class="pre">plot_gene_heatmaps()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/toxo/index.html#spacr.toxo.generate_score_heatmap"><code class="docutils literal notranslate"><span class="pre">generate_score_heatmap()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/spacr/submodules/index.html">Submodules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/spacr/submodules/index.html#module-contents">Module Contents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.normalize"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.normalize</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.percentiles"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.percentiles</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.target_size"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.target_size</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.augment"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.augment</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.__len__"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.__len__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.apply_augmentation"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.apply_augmentation()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.CellposeLazyDataset.__getitem__"><code class="docutils literal notranslate"><span class="pre">CellposeLazyDataset.__getitem__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.train_cellpose"><code class="docutils literal notranslate"><span class="pre">train_cellpose()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.test_cellpose_model"><code class="docutils literal notranslate"><span class="pre">test_cellpose_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.apply_cellpose_model"><code class="docutils literal notranslate"><span class="pre">apply_cellpose_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.plot_cellpose_batch"><code class="docutils literal notranslate"><span class="pre">plot_cellpose_batch()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.analyze_percent_positive"><code class="docutils literal notranslate"><span class="pre">analyze_percent_positive()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.analyze_recruitment"><code class="docutils literal notranslate"><span class="pre">analyze_recruitment()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.analyze_plaques"><code class="docutils literal notranslate"><span class="pre">analyze_plaques()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.count_phenotypes"><code class="docutils literal notranslate"><span class="pre">count_phenotypes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.compare_reads_to_scores"><code class="docutils literal notranslate"><span class="pre">compare_reads_to_scores()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.interperate_vision_model"><code class="docutils literal notranslate"><span class="pre">interperate_vision_model()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.analyze_endodyogeny"><code class="docutils literal notranslate"><span class="pre">analyze_endodyogeny()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.analyze_class_proportion"><code class="docutils literal notranslate"><span class="pre">analyze_class_proportion()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.generate_score_heatmap"><code class="docutils literal notranslate"><span class="pre">generate_score_heatmap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/spacr/submodules/index.html#spacr.submodules.post_regression_analysis"><code class="docutils literal notranslate"><span class="pre">post_regression_analysis()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API Reference</a><ul class="simple">
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #005f73" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spacr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spacr.io</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spacr.io</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">tarfile</span><span class="o">,</span> <span class="nn">cellpose</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">queue</span><span class="o">,</span> <span class="nn">tifffile</span><span class="o">,</span> <span class="nn">czifile</span><span class="o">,</span> <span class="nn">atexit</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">readlif</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">img_as_uint</span>
<span class="kn">from</span> <span class="nn">skimage.exposure</span> <span class="kn">import</span> <span class="n">rescale_intensity</span>
<span class="kn">import</span> <span class="nn">skimage.measure</span> <span class="k">as</span> <span class="nn">measure</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>
<span class="kn">import</span> <span class="nn">imageio.v2</span> <span class="k">as</span> <span class="nn">imageio2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> 
<span class="kn">from</span> <span class="nn">nd2reader</span> <span class="kn">import</span> <span class="n">ND2Reader</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">pylibCZIrw</span> <span class="kn">import</span> <span class="n">czi</span> <span class="k">as</span> <span class="n">pyczi</span>

<div class="viewcode-block" id="process_non_tif_non_2D_images">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.process_non_tif_non_2D_images">[docs]</a>
<span class="k">def</span> <span class="nf">process_non_tif_non_2D_images</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process and standardize image files in a folder by converting or splitting them into grayscale TIFFs.</span>

<span class="sd">    This function supports various image formats (PNG, JPEG, CZI, ND2, TIFF) and ensures all output images </span>
<span class="sd">    are grayscale TIFF files saved with consistent naming based on dimensions (channel, z-plane, timepoint).</span>

<span class="sd">    For 2D grayscale images in non-TIFF formats, it converts them to TIFF.</span>
<span class="sd">    For 3D, 4D, or 5D images, it splits them into individual grayscale channels and saves them with suffixes </span>
<span class="sd">    (_C#, _Z#, _T#) to indicate channel, z-stack, and time point respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder (str): Path to the folder containing image files to be processed.</span>

<span class="sd">    Supported file extensions:</span>
<span class="sd">        - .tif, .tiff</span>
<span class="sd">        - .png</span>
<span class="sd">        - .jpg, .jpeg</span>
<span class="sd">        - .czi</span>
<span class="sd">        - .nd2</span>

<span class="sd">    Output:</span>
<span class="sd">        - Saves standardized grayscale TIFF images in the same folder with descriptive filenames.</span>
<span class="sd">        - Prints a log message for each file processed or skipped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Helper function to save grayscale images</span>
    <span class="k">def</span> <span class="nf">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a single grayscale image slice as a TIFF file with a descriptive filename.</span>

<span class="sd">        The output filename is constructed from the base name and optionally includes</span>
<span class="sd">        suffixes for channel (C#), z-plane (Z#), and timepoint (T#) to reflect its position</span>
<span class="sd">        in a multidimensional dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.ndarray): The grayscale image array to save.</span>
<span class="sd">            base_name (str): The base filename (without extension).</span>
<span class="sd">            folder (str): Directory in which to save the output TIFF.</span>
<span class="sd">            dtype (np.dtype): Desired data type to cast the image before saving (e.g., np.uint8, np.uint16).</span>
<span class="sd">            channel (int, optional): Channel index (1-based) to include in the filename.</span>
<span class="sd">            z (int, optional): Z-plane index (1-based) to include in the filename.</span>
<span class="sd">            t (int, optional): Timepoint index (1-based) to include in the filename.</span>

<span class="sd">        Output:</span>
<span class="sd">            Saves the image as a `.tif` file in the specified folder with the constructed filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_C</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_Z</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_T</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

    <span class="c1"># Function to handle splitting of multi-dimensional images into grayscale channels</span>
    <span class="k">def</span> <span class="nf">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split and save multi-dimensional image data into individual grayscale TIFF files.</span>

<span class="sd">        This function handles 3D, 4D, and 5D images by separating each channel (and optionally</span>
<span class="sd">        z-slices and timepoints) and saving each as an individual grayscale image using the</span>
<span class="sd">        `save_grayscale_images` function.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.ndarray): Input image array with shape:</span>
<span class="sd">                - 3D: (height, width, channels)</span>
<span class="sd">                - 4D: (height, width, channels, z)</span>
<span class="sd">                - 5D: (height, width, channels, z, t)</span>
<span class="sd">            folder (str): Output directory where the grayscale images will be saved.</span>
<span class="sd">            base_name (str): Base name used for constructing output filenames.</span>
<span class="sd">            dtype (np.dtype): Desired data type to cast images before saving.</span>

<span class="sd">        Note:</span>
<span class="sd">            2D grayscale images are ignored, as they should be handled separately.</span>
<span class="sd">            The output TIFF filenames will include suffixes like `_C1`, `_Z1`, `_T1` to</span>
<span class="sd">            indicate channel, z-plane, and timepoint respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Grayscale image, already processed separately</span>
            <span class="k">return</span>
        
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># 3D image: (height, width, channels)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># 4D image: (height, width, channels, Z-dimension)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># 5D image: (height, width, channels, Z-dimension, Time)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Function to load images in various formats</span>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an image file of various supported formats and return it as a NumPy array.</span>

<span class="sd">        Supports TIFF, PNG, JPEG, CZI, and ND2 image formats. Converts the image to a NumPy array</span>
<span class="sd">        and returns it along with its data type for further processing.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_path (str): Path to the image file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple (image, dtype) where:</span>
<span class="sd">                - image (np.ndarray): Loaded image as a NumPy array.</span>
<span class="sd">                - dtype: Data type of the image (e.g., np.uint16, np.float32, etc.).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the file extension is not supported.</span>

<span class="sd">        Supported formats:</span>
<span class="sd">            - .tif, .tiff (TIFF)</span>
<span class="sd">            - .png, .jpg, .jpeg (standard image formats)</span>
<span class="sd">            - .czi (Zeiss CZI microscopy format)</span>
<span class="sd">            - .nd2 (Nikon ND2 microscopy format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">]:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.czi&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">czifile</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czi</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">nd2</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nd2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Function to check if an image is grayscale and save it as a TIFF if it isn&#39;t already</span>
    <span class="k">def</span> <span class="nf">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a grayscale image to TIFF format and save it, preserving the original bit depth.</span>

<span class="sd">        This function is intended for grayscale (2D) images in non-TIFF formats (e.g., PNG, JPEG).</span>
<span class="sd">        It converts the image to the specified dtype and saves it as a TIFF in the specified folder.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (np.ndarray): Grayscale image as a NumPy array.</span>
<span class="sd">            filename (str): Original filename (used to derive output name).</span>
<span class="sd">            folder (str): Destination folder where the TIFF image will be saved.</span>
<span class="sd">            dtype (np.dtype): Data type to cast the image before saving.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted grayscale image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to TIFF with bit depth </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># Supported formats</span>
    <span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">]</span>
    
    <span class="c1"># Loop through all files in the folder</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load the image and its dtype</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                
                <span class="c1"># If the image is grayscale (2D), convert it to TIFF if it&#39;s not already in TIFF format</span>
                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
                        <span class="n">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is already grayscale and in TIFF format, skipping.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Otherwise, split channels and save images</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_load_images_and_labels</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load image and label files from disk and optionally normalize intensity.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_files (list[str]): List of paths to image files.</span>
<span class="sd">        label_files (list[str]): List of paths to label (mask) files.</span>
<span class="sd">        invert (bool): If True, invert the intensity of input images.</span>

<span class="sd">    Returns:</span>
<span class="sd">        images (list[np.ndarray]): List of loaded image arrays.</span>
<span class="sd">        labels (list[np.ndarray]): List of loaded label arrays.</span>
<span class="sd">        image_names (list[str]): List of image file names (no paths).</span>
<span class="sd">        label_names (list[str]): List of label file names (no paths).</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">invert_image</span>
    
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">image_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">])</span> <span class="k">if</span> <span class="n">image_files</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">label_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">])</span> <span class="k">if</span> <span class="n">label_files</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">image_files</span> <span class="ow">and</span> <span class="n">label_files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img_file</span><span class="p">,</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load image: </span><span class="si">{</span><span class="n">img_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="n">label</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load label: </span><span class="si">{</span><span class="n">lbl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">image_files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load image: </span><span class="si">{</span><span class="n">img_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">label_files</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load label: </span><span class="si">{</span><span class="n">lbl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">image_files</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">label_files</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels from </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">label_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image shape: </span><span class="si">{</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, image type: </span><span class="si">{</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">; &#39;</span>
              <span class="sa">f</span><span class="s1">&#39;label shape: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, label type: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_names</span><span class="p">,</span> <span class="n">label_names</span>

<span class="k">def</span> <span class="nf">_load_normalized_images_and_labels</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  
                                       <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                       <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Signal_to_noise</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load, normalize, and optionally resize images and labels for downstream analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_files (list[str]): List of paths to image files.</span>
<span class="sd">        label_files (list[str] or None): List of paths to label (mask) files.</span>
<span class="sd">        channels (list[int] or None): Indices of image channels to retain.</span>
<span class="sd">        percentiles (list[int, int] or None): Percentile range for intensity normalization.</span>
<span class="sd">        invert (bool): If True, invert image intensity.</span>
<span class="sd">        visualize (bool): If True, display plots of raw and normalized images.</span>
<span class="sd">        remove_background (bool): If True, zero pixels below `background` threshold.</span>
<span class="sd">        background (float): Background intensity threshold.</span>
<span class="sd">        Signal_to_noise (float): Minimum signal-to-noise ratio used to detect saturation.</span>
<span class="sd">        target_height (int or None): Target height for image resizing.</span>
<span class="sd">        target_width (int or None): Target width for image resizing.</span>

<span class="sd">    Returns:</span>
<span class="sd">        normalized_images (list[np.ndarray]): List of normalized image arrays.</span>
<span class="sd">        labels (list[np.ndarray]): List of label arrays (resized if needed).</span>
<span class="sd">        image_names (list[str]): List of image file names.</span>
<span class="sd">        label_names (list[str]): List of label file names.</span>
<span class="sd">        orig_dims (list[Tuple[int, int]]): Original dimensions of each image before resizing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">normalize_and_visualize</span><span class="p">,</span> <span class="n">plot_resize</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">invert_image</span><span class="p">,</span> <span class="n">apply_mask</span>
    <span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span> <span class="k">as</span> <span class="n">resizescikit</span>

    <span class="c1"># Ensure percentiles are valid</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">signal_thresholds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">Signal_to_noise</span><span class="p">)</span>
    <span class="n">lower_percentile</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">orig_dims</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">num_channels</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">percentiles_1</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)]</span>
    <span class="n">percentiles_99</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)]</span>

    <span class="n">image_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">]</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">]</span>
        <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_names</span><span class="p">,</span> <span class="n">label_dir</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>

    <span class="c1"># Load, normalize, and resize images</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_files</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
        <span class="n">orig_dims</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Select specific channels if needed</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate percentiles if not provided</span>
        <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="p">)</span>
                <span class="n">percentiles_1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

                <span class="c1"># Ensure `signal_thresholds` and `p` are floats for comparison</span>
                <span class="k">for</span> <span class="n">percentile</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="mf">99.999</span><span class="p">]:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">signal_thresholds</span><span class="p">:</span>
                        <span class="n">percentiles_99</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="c1"># Resize image if required</span>
        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">and</span> <span class="n">target_width</span><span class="p">:</span>
            <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">resizescikit</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Calculate average percentiles if needed</span>
    <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">avg_p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles_1</span><span class="p">]</span>
        <span class="n">avg_p99</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="k">else</span> <span class="n">avg_p1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">percentiles_99</span><span class="p">)]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average 1st percentiles: </span><span class="si">{</span><span class="n">avg_p1</span><span class="si">}</span><span class="s1">, Average 99th percentiles: </span><span class="si">{</span><span class="n">avg_p99</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">normalized_images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">avg_p1</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">avg_p99</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span>
        <span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">normalized_images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> 
                                        <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> 
                                        <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span>
        <span class="p">]</span>

    <span class="c1"># Load and resize labels if provided</span>
    <span class="k">if</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">resizescikit</span><span class="p">(</span><span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">),</span> 
                               <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_height</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="k">else</span> <span class="n">orig_dims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                               <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_files</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded and normalized </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels from </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">label_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">visualize</span> <span class="ow">and</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">plot_resize</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">normalized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normalized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_names</span><span class="p">,</span> <span class="n">label_names</span><span class="p">,</span> <span class="n">orig_dims</span>

<div class="viewcode-block" id="CombineLoaders">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders">[docs]</a>
<span class="k">class</span> <span class="nc">CombineLoaders</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that combines multiple PyTorch data loaders into a single iterable.</span>

<span class="sd">    This class allows iteration over a mixed sequence of batches from several</span>
<span class="sd">    data loaders, yielding a tuple with the loader index and the corresponding batch.</span>
<span class="sd">    Once a loader is exhausted, it is removed from the iteration pool.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_loaders (list): A list of PyTorch DataLoader objects.</span>

<span class="sd">    Raises:</span>
<span class="sd">        StopIteration: When all data loaders are exhausted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loaders</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the CombineLoaders instance.</span>

<span class="sd">        Converts each data loader into an iterator for independent traversal.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_loaders (list): List of torch.utils.data.DataLoader instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CombineLoaders.train_loaders">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.train_loaders">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_loaders</span> <span class="o">=</span> <span class="n">train_loaders</span></div>

<div class="viewcode-block" id="CombineLoaders.loader_iters">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.loader_iters">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span> <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">train_loaders</span><span class="p">]</span></div>


<div class="viewcode-block" id="CombineLoaders.__iter__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.__iter__">[docs]</a>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the iterator object (self).</span>

<span class="sd">        Returns:</span>
<span class="sd">            CombineLoaders: The iterator object itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="CombineLoaders.__next__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombineLoaders.__next__">[docs]</a>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the next batch from the available data loaders.</span>

<span class="sd">        Data loaders are shuffled at each step to randomize the batch source.</span>
<span class="sd">        If a data loader is exhausted, it is removed from the pool.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple (i, batch) where i is the index of the originating loader,</span>
<span class="sd">                   and batch is the next batch of data from that loader.</span>

<span class="sd">        Raises:</span>
<span class="sd">            StopIteration: When all loaders have been exhausted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loader_iter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">loader_iter</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span></div>
</div>


<div class="viewcode-block" id="CombinedDataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset">[docs]</a>
<span class="k">class</span> <span class="nc">CombinedDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dataset that combines multiple datasets into one seamless dataset.</span>

<span class="sd">    This class supports optional shuffling across datasets and presents</span>
<span class="sd">    a unified indexing interface for training or evaluation.</span>

<span class="sd">    Args:</span>
<span class="sd">        datasets (list): A list of PyTorch Dataset objects to combine.</span>
<span class="sd">        shuffle (bool, optional): Whether to shuffle the indices for data access. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the CombinedDataset.</span>

<span class="sd">        Computes lengths of each dataset and optionally shuffles the access indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            datasets (list): A list of datasets to be combined.</span>
<span class="sd">            shuffle (bool, optional): Whether to shuffle the combined dataset. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CombinedDataset.datasets">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.datasets">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span></div>

<div class="viewcode-block" id="CombinedDataset.lengths">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.lengths">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span></div>

<div class="viewcode-block" id="CombinedDataset.total_length">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.total_length">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span></div>

<div class="viewcode-block" id="CombinedDataset.shuffle">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.shuffle">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span></div>

        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_length</span><span class="p">))</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="CombinedDataset.__getitem__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.__getitem__">[docs]</a>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve an item from the combined dataset.</span>

<span class="sd">        The method accounts for shuffling and maps the index to the appropriate dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            index (int): Index of the item in the combined dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The item retrieved from the corresponding sub-dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">-=</span> <span class="n">length</span></div>

<div class="viewcode-block" id="CombinedDataset.__len__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.CombinedDataset.__len__">[docs]</a>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the total length of the combined dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Total number of items across all datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span></div>
</div>

    
<div class="viewcode-block" id="NoClassDataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset">[docs]</a>
<span class="k">class</span> <span class="nc">NoClassDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom dataset class for handling image data without class labels.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_dir (str): The directory path where the image files are located.</span>
<span class="sd">        transform (callable, optional): A function/transform to apply to the image data. Default is None.</span>
<span class="sd">        shuffle (bool, optional): Whether to shuffle the dataset. Default is True.</span>
<span class="sd">        load_to_memory (bool, optional): Whether to load all images into memory. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<div class="viewcode-block" id="NoClassDataset.data_dir">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.data_dir">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span></div>

<div class="viewcode-block" id="NoClassDataset.transform">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.transform">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span></div>

<div class="viewcode-block" id="NoClassDataset.shuffle">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.shuffle">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span></div>

<div class="viewcode-block" id="NoClassDataset.load_to_memory">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.load_to_memory">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span></div>

<div class="viewcode-block" id="NoClassDataset.filenames">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.filenames">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="p">]</span></div>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
    
<div class="viewcode-block" id="NoClassDataset.load_image">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.load_image">[docs]</a>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an image from the given file path.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            img_path (str): The file path of the image.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            PIL.Image: The loaded image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span></div>

    
<div class="viewcode-block" id="NoClassDataset.__len__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.__len__">[docs]</a>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the total number of images in the dataset.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            int: The number of images in the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NoClassDataset.shuffle_dataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.shuffle_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shuffle the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="NoClassDataset.__getitem__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.NoClassDataset.__getitem__">[docs]</a>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the image and its corresponding filename at the given index.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            index (int): The index of the image in the dataset.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the image and its filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>
</div>


<div class="viewcode-block" id="spacrDataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset">[docs]</a>
<span class="k">class</span> <span class="nc">spacrDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom PyTorch Dataset for loading labeled image data organized by class folders or from specified file lists.</span>

<span class="sd">    This dataset supports loading images either from directory structures organized by class or from explicit</span>
<span class="sd">    file and label lists. It supports optional preloading of all images into memory for faster access.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dir (str): Root directory containing subfolders for each class.</span>
<span class="sd">        loader_classes (list[str]): List of class names corresponding to subfolder names in `data_dir`.</span>
<span class="sd">        transform (callable, optional): Transform to apply to images (e.g., torchvision transforms).</span>
<span class="sd">        shuffle (bool): Whether to shuffle the dataset. Default is True.</span>
<span class="sd">        pin_memory (bool): If True, pre-load all images into memory using multiprocessing. Default is False.</span>
<span class="sd">        specific_files (list[str], optional): Specific image file paths to load instead of scanning `data_dir`.</span>
<span class="sd">        specific_labels (list[int], optional): Corresponding labels for `specific_files`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">loader_classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">specific_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specific_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the spacrDataset.</span>

<span class="sd">        Constructs the dataset either by scanning the data directory or using provided file paths and labels.</span>
<span class="sd">        Optionally shuffles and preloads images into memory.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_dir (str): Directory containing class subfolders.</span>
<span class="sd">            loader_classes (list): List of class names.</span>
<span class="sd">            transform (callable, optional): Transform function to apply to images.</span>
<span class="sd">            shuffle (bool): Whether to shuffle the dataset. Default is True.</span>
<span class="sd">            pin_memory (bool): Whether to preload images into memory. Default is False.</span>
<span class="sd">            specific_files (list[str], optional): List of file paths to use directly.</span>
<span class="sd">            specific_labels (list[int], optional): List of labels corresponding to specific files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="spacrDataset.data_dir">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.data_dir">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span></div>

<div class="viewcode-block" id="spacrDataset.classes">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.classes">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">loader_classes</span></div>

<div class="viewcode-block" id="spacrDataset.transform">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.transform">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span></div>

<div class="viewcode-block" id="spacrDataset.shuffle">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.shuffle">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span></div>

<div class="viewcode-block" id="spacrDataset.pin_memory">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.pin_memory">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span></div>

<div class="viewcode-block" id="spacrDataset.filenames">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.filenames">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="spacrDataset.labels">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.labels">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span></div>


        <span class="k">if</span> <span class="n">specific_files</span> <span class="ow">and</span> <span class="n">specific_labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">specific_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">specific_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                <span class="n">class_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
                <span class="n">class_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_files</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_name</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_files</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
            <span class="c1"># Use multiprocessing to load images in parallel</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="spacrDataset.load_image">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.load_image">[docs]</a>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and return a single image with orientation correction.</span>

<span class="sd">        Args:</span>
<span class="sd">            img_path (str): Path to the image file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PIL.Image: Loaded RGB image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># Handle image orientation</span>
        <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="spacrDataset.__len__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.__len__">[docs]</a>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of samples in the dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Total number of images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span></div>


<div class="viewcode-block" id="spacrDataset.shuffle_dataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.shuffle_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shuffle the dataset filenames and labels in unison.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combined</span><span class="p">)</span></div>


<div class="viewcode-block" id="spacrDataset.get_plate">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.get_plate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the plate identifier from the filename.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath (str): Full path to the file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Plate ID extracted from the filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="spacrDataset.__getitem__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataset.__getitem__">[docs]</a>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve an image, its label, and the filename.</span>

<span class="sd">        Args:</span>
<span class="sd">            index (int): Index of the image to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (image, label, filename)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">filename</span></div>
</div>

    
<div class="viewcode-block" id="spacrDataLoader">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader">[docs]</a>
<span class="k">class</span> <span class="nc">spacrDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom DataLoader with background batch preloading support using multiprocessing.</span>

<span class="sd">    This class extends `torch.utils.data.DataLoader` and adds asynchronous background</span>
<span class="sd">    preloading of a specified number of batches using a separate process or in-place loading</span>
<span class="sd">    if `pin_memory=True`.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Arguments passed to the base DataLoader.</span>
<span class="sd">        preload_batches (int): Number of batches to preload in a background process. Default is 1.</span>
<span class="sd">        **kwargs: Keyword arguments passed to the base DataLoader. Supports all standard DataLoader arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">preload_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the spacrDataLoader.</span>

<span class="sd">        Sets up the queue and multiprocessing process for background preloading of batches.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Arguments passed to torch.utils.data.DataLoader.</span>
<span class="sd">            preload_batches (int): Number of batches to preload. Default is 1.</span>
<span class="sd">            **kwargs: Keyword arguments passed to the base DataLoader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="viewcode-block" id="spacrDataLoader.preload_batches">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.preload_batches">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span> <span class="o">=</span> <span class="n">preload_batches</span></div>

<div class="viewcode-block" id="spacrDataLoader.batch_queue">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.batch_queue">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">preload_batches</span><span class="p">)</span></div>

<div class="viewcode-block" id="spacrDataLoader.process">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.process">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="spacrDataLoader.current_batch_index">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.current_batch_index">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="spacrDataLoader.pin_memory">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.pin_memory">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin_memory&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_preload_next_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method to fetch the next N batches and put them in the queue.</span>

<span class="sd">        If `pin_memory` is True, batches are pinned to CUDA memory.</span>
<span class="sd">        Stops if the iterator is exhausted or the stop event is set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_start_preloading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a new background process to preload batches.</span>

<span class="sd">        If `pin_memory` is True, loading is done in the main thread instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">()</span>  <span class="c1"># Directly load if pin_memory is True</span>

    <span class="k">def</span> <span class="nf">_pin_memory_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively pin memory for all tensors in the batch.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch: A batch of data, possibly a tuple, list, or tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The batch with pinned memory (if applicable).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">batch</span>

<div class="viewcode-block" id="spacrDataLoader.__iter__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.__iter__">[docs]</a>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the iterator and initiate background preloading.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="spacrDataLoader.__next__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.__next__">[docs]</a>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the next batch from the queue.</span>

<span class="sd">        If the queue is empty and the process has exited, raises StopIteration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The next batch of data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Start preloading the next batches</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">next_batch</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span></div>


<div class="viewcode-block" id="spacrDataLoader.cleanup">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.cleanup">[docs]</a>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleanup method to terminate background preloading processes.</span>

<span class="sd">        Ensures graceful shutdown of worker processes at exit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<div class="viewcode-block" id="spacrDataLoader.__del__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.spacrDataLoader.__del__">[docs]</a>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Destructor to ensure cleanup is called when the object is deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>
</div>


<div class="viewcode-block" id="TarImageDataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset">[docs]</a>
<span class="k">class</span> <span class="nc">TarImageDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A PyTorch Dataset for loading images directly from a .tar archive without extraction.</span>

<span class="sd">    This is useful for large datasets stored as compressed tar archives, enabling on-the-fly </span>
<span class="sd">    access to individual image files without unpacking the archive to disk.</span>

<span class="sd">    Args:</span>
<span class="sd">        tar_path (str): Path to the .tar archive containing image files.</span>
<span class="sd">        transform (callable, optional): Optional transform to be applied on a sample.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        members (List[TarInfo]): List of image members in the tar archive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the dataset and index image members from the tar archive.</span>

<span class="sd">        Args:</span>
<span class="sd">            tar_path (str): Path to the .tar file.</span>
<span class="sd">            transform (callable, optional): Transform function to apply to each image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TarImageDataset.tar_path">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.tar_path">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span> <span class="o">=</span> <span class="n">tar_path</span></div>

<div class="viewcode-block" id="TarImageDataset.transform">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.transform">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span></div>


        <span class="c1"># Open the tar file just to build the list of members</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isfile</span><span class="p">()]</span>

<div class="viewcode-block" id="TarImageDataset.__len__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.__len__">[docs]</a>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of image files in the archive.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of image files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">)</span></div>


<div class="viewcode-block" id="TarImageDataset.__getitem__">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.TarImageDataset.__getitem__">[docs]</a>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve an image by index directly from the tar archive.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (int): Index of the image to retrieve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (PIL.Image.Image or transformed image, str) where the string is the file name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">img_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span></div>
</div>

    
<div class="viewcode-block" id="load_images_from_paths">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.load_images_from_paths">[docs]</a>
<span class="k">def</span> <span class="nf">load_images_from_paths</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load images from a dictionary mapping keys to lists of image file paths.</span>

<span class="sd">    Each key in the input dictionary corresponds to a list of file paths. The function</span>
<span class="sd">    loads each image as a NumPy array and returns a new dictionary with the same keys,</span>
<span class="sd">    where each value is a list of loaded images.</span>

<span class="sd">    Args:</span>
<span class="sd">        images_by_key (dict): A dictionary where each key maps to a list of image file paths (str).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where each key maps to a list of NumPy arrays representing the loaded images.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Images are loaded using PIL and converted to NumPy arrays.</span>
<span class="sd">        - Any image that fails to load will be skipped, and an error message will be printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">images_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                    <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading image from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">images_dict</span></div>


<span class="c1">#@log_function_call </span>
<span class="k">def</span> <span class="nf">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">metadata_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">img_format</span><span class="o">=</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert z-stack images to maximum intensity projection (MIP) images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the z-stack images.</span>
<span class="sd">        regex (str): The regular expression pattern used to match the filenames of the z-stack images.</span>
<span class="sd">        batch_size (int, optional): The number of images to process in each batch. Defaults to 100.</span>
<span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_format</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">img_format</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_format</span><span class="p">]</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_extract_filename_metadata</span><span class="p">,</span> <span class="n">print_progress</span>
    
    <span class="n">regular_expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
    <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stack_path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">all_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">img_format</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">all_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_filenames</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="c1">#Exclude hidden files</span>
        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_paths_by_key</span> <span class="o">=</span> <span class="n">_extract_filename_metadata</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">regular_expression</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">)</span>
        <span class="c1"># Convert dictionary keys to a list for batching</span>
        <span class="n">batching_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All unique FOV: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="p">)</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Select batch keys and create a subset of the dictionary for this batch</span>
            <span class="n">batch_keys</span> <span class="o">=</span> <span class="n">batching_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="n">batch_images_by_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">image_paths_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_keys</span><span class="p">}</span>
            <span class="n">images_by_key</span> <span class="o">=</span> <span class="n">load_images_from_paths</span><span class="p">(</span><span class="n">batch_images_by_key</span><span class="p">)</span>
            
            <span class="c1"># Process each batch of images</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                
                <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">sliceID</span> <span class="o">=</span> <span class="n">key</span>
                
                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
                    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">.tif&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">timeID</span><span class="si">}</span><span class="s1">.tif&#39;</span>
                    
                <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
                <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mip</span><span class="p">)</span>
               
                <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span>
                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Preprocessing filenames&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                    <span class="n">mip_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">images_by_key</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Move original images to a new directory</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="c1">#print(f&quot;{filename}: {os.path.splitext(filename)[1]}&quot;)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">img_format</span><span class="p">:</span>
                <span class="n">move</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">move</span><span class="p">)</span>
    <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_merge_file</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">,</span> <span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge multiple channels into a single stack and save it as a numpy array, using os module for path handling.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        chan_dirs (list): List of directories containing channel images.</span>
<span class="sd">        stack_dir (str): Directory to save the merged stack.</span>
<span class="sd">        file_name (str): File name of the channel image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Construct new file path</span>
    <span class="n">file_root</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">new_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
    
    <span class="c1"># Check if the new file exists and create the stack directory if it doesn&#39;t</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_file</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chan_dir</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">):</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chan_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to read image </span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">img</span>  <span class="c1"># Explicitly delete the reference to the image to free up memory</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Periodically suggest garbage collection</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid channels to merge for file </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_dir_empty</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a directory is empty using os module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_generate_time_lists</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate sorted lists of filenames grouped by plate, well, and field.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_list (list): A list of filenames.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of sorted file lists, where each file list contains filenames</span>
<span class="sd">              belonging to the same plate, well, and field, sorted by timepoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timepoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># Skip file on conversion error</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">file_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">timepoint</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Skip file if not correctly formatted</span>

    <span class="c1"># Sort each list by timepoint, but keep them grouped</span>
    <span class="n">sorted_grouped_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="c1"># Extract just the filenames from each group</span>
    <span class="n">sorted_file_lists</span> <span class="o">=</span> <span class="p">[[</span><span class="n">filename</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sorted_grouped_filenames</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sorted_file_lists</span>

<span class="k">def</span> <span class="nf">_move_to_chan_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Organize image files in a source directory into channel-specific subfolders </span>
<span class="sd">    based on metadata extracted from filenames using a regular expression.</span>

<span class="sd">    This function assumes filenames contain fields like plate ID, well ID, field ID, </span>
<span class="sd">    channel ID, and time point. It parses these from the filename using the provided </span>
<span class="sd">    regex, reformats the filename, and moves the file into a subdirectory named after </span>
<span class="sd">    the channel ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str or Path): Path to the source directory containing image files.</span>
<span class="sd">        regex (str): Regular expression to extract metadata from filenames. </span>
<span class="sd">                     Expected named groups: plateID, wellID, fieldID, chanID, timeID.</span>
<span class="sd">        timelapse (bool, optional): Whether to include the timeID in the new filename. Defaults to False.</span>
<span class="sd">        metadata_type (str, optional): Special handling for specific metadata types. </span>
<span class="sd">                                       If &#39;cq1&#39;, converts wellID to CQ1 format. Defaults to &#39;&#39;.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Only `.tif` and `.png` files are processed.</span>
<span class="sd">        - Files are copied into folders named after their channel ID.</span>
<span class="sd">        - A backup of the original files is moved to a new `orig/` folder.</span>
<span class="sd">        - Skips files that do not match the regex or are missing required groups.</span>
<span class="sd">        - Issues warnings if destination files already exist.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_safe_int_convert</span><span class="p">,</span> <span class="n">_convert_cq1_well_id</span>
    
    <span class="n">src_path</span> <span class="o">=</span> <span class="n">src</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src</span> <span class="o">/</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> 
                    <span class="k">try</span><span class="p">:</span>                  
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">plateID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;plateID&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">plateID</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span>

                        <span class="n">wellID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;wellID&#39;</span><span class="p">)</span>
                        <span class="n">fieldID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;fieldID&#39;</span><span class="p">)</span>
                        <span class="n">chanID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;chanID&#39;</span><span class="p">)</span>
                        <span class="n">timeID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;timeID&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">wellID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">wellID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">wellID</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">fieldID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">fieldID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">fieldID</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">chanID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">chanID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">chanID</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">timeID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">timeID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">timeID</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">metadata_type</span> <span class="o">==</span><span class="s1">&#39;cq1&#39;</span><span class="p">:</span>
                            <span class="n">orig_wellID</span> <span class="o">=</span> <span class="n">wellID</span>
                            <span class="n">wellID</span> <span class="o">=</span> <span class="n">_convert_cq1_well_id</span><span class="p">(</span><span class="n">wellID</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Converted Well ID: </span><span class="si">{</span><span class="n">orig_wellID</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">wellID</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span>

                        <span class="n">newname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plateID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">wellID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fieldID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeID</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">timelapse</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">newpath</span> <span class="o">=</span> <span class="n">src</span> <span class="o">/</span> <span class="n">chanID</span>
                        <span class="n">move</span> <span class="o">=</span> <span class="n">newpath</span> <span class="o">/</span> <span class="n">newname</span>
                        <span class="k">if</span> <span class="n">move</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">newpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract information from filename </span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">regex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Move original images to a new directory</span>
        <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
                <span class="n">move</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">move</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge single-channel image files from multiple folders into multi-channel NumPy arrays.</span>

<span class="sd">    This function assumes the source directory `src` contains subdirectories named as channel </span>
<span class="sd">    identifiers (e.g., &#39;0&#39;, &#39;01&#39;, ..., &#39;100&#39;), each holding single-channel image files </span>
<span class="sd">    with identical filenames. It merges images with the same name across these folders </span>
<span class="sd">    into a single multi-channel `.npy` file stored in the `stack/` subdirectory.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str or Path): Path to the parent directory containing channel subfolders.</span>
<span class="sd">        plot (bool, optional): If True, plot the merged arrays after processing using `plot_arrays`. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of matching channel folders that were merged.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Only processes if `stack/` directory is empty.</span>
<span class="sd">        - Output is saved as `.npy` files in `src/stack/`.</span>
<span class="sd">        - Channel folders must be named as integers or zero-padded strings from &#39;0&#39; to &#39;100&#39;.</span>
<span class="sd">        - Files are matched by filename across all channel folders.</span>
<span class="sd">        - Skips if a file is not present in all channels or is not a file.</span>
<span class="sd">        - Uses `_merge_file` to perform the merging operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
    
    <span class="n">stack_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
    <span class="c1">#allowed_names = [&#39;01&#39;, &#39;02&#39;, &#39;03&#39;, &#39;04&#39;, &#39;00&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;0&#39;]</span>
    
    <span class="n">string_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="n">allowed_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">string_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="c1"># List directories that match the allowed names</span>
    <span class="n">chan_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">allowed_names</span><span class="p">]</span>
    <span class="n">chan_dirs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    
    <span class="n">num_matching_folders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;List of folders in src: </span><span class="si">{</span><span class="n">chan_dirs</span><span class="si">}</span><span class="s1">. Single channel folders.&#39;</span><span class="p">)</span>
    
    <span class="c1"># Assuming chan_dirs[0] is not empty and exists, adjust according to your logic</span>
    <span class="n">first_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">chan_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dir_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">first_dir_path</span><span class="p">)</span>

    <span class="c1"># Create the &#39;stack&#39; directory if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated folder with merged arrays: </span><span class="si">{</span><span class="n">stack_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_is_dir_empty</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">):</span>
        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dir_files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dir_files</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">full_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">):</span>
                <span class="n">_merge_file</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">chan_dirs</span><span class="p">],</span> <span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Merging channels into npy stacks&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">num_matching_folders</span>

<span class="k">def</span> <span class="nf">_mip_all</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">include_first_chan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate maximum intensity projections (MIPs) for each NumPy array file in the specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The directory path containing the NumPy array files.</span>
<span class="sd">        include_first_chan (bool, optional): Whether to include the first channel of the array in the MIP computation. </span>
<span class="sd">                                                Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#print(&#39;========== generating MIPs ==========&#39;)</span>
    <span class="c1"># Iterate over each file in the specified directory (src).</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="c1"># Check if the current file is a NumPy array file (with .npy extension).</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="c1"># Load the array from the file.</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="c1"># Normalize the array </span>
            <span class="c1">#array = normalize_to_dtype(array, q1=0, q2=99, percentiles=None)</span>

            <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Check if the array is not 3-dimensional.</span>
                <span class="c1"># Log a message indicating a zero array will be generated due to unexpected dimensions.</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating zero array for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> due to unexpected dimensions: </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Create a zero array with the same height and width as the original array, but with a single depth layer.</span>
                <span class="n">zeros_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                <span class="c1"># Concatenate the original array with the zero array along the depth axis.</span>
                <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">zeros_array</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">include_first_chan</span><span class="p">:</span>
                    <span class="c1"># Compute the MIP for the entire array along the third axis.</span>
                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Compute the MIP excluding the first layer of the array along the depth axis.</span>
                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Reshape the MIP to make it 3-dimensional.</span>
                <span class="n">mip</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="c1"># Concatenate the MIP with the original array.</span>
                <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">mip</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># save</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">concatenated</span><span class="p">)</span>
    <span class="k">return</span>

<span class="c1">#@log_function_call</span>
<span class="k">def</span> <span class="nf">_concatenate_channel</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenates channel data from multiple files and saves the concatenated data as numpy arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the channel data files.</span>
<span class="sd">        channels (list): The list of channel indices to be concatenated.</span>
<span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
<span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
<span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The directory path where the concatenated channel data is saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">channel_stack_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;channel_stack&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">time_stack_path_lists</span>
                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>
                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">stack</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Added this to name the output files</span>
        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>  <span class="c1"># store the filename</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimentions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>
                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increment this after each batch is saved</span>
                <span class="k">del</span> <span class="n">stack</span>  <span class="c1"># delete to free memory</span>
                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty the list for the next batch</span>
                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty the filenames list for the next batch</span>
                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and saved to:</span><span class="si">{</span><span class="n">channel_stack_loc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">channel_stack_loc</span>

<span class="k">def</span> <span class="nf">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the stack of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        stack (numpy.ndarray): The stack of images to normalize.</span>
<span class="sd">        lower_percentile (int): Lower percentile value for normalization.</span>
<span class="sd">        save_dtype (numpy.dtype): Data type for saving the normalized stack.</span>
<span class="sd">        settings (dict): keword arguments</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The normalized stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1">#for channel in range(stack.shape[-1]):</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">]:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_nucleus&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">]:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_cell&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_pathogen&#39;</span><span class="p">]</span>

        <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: background=</span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s1">, signal_threshold=</span><span class="si">{</span><span class="n">signal_threshold</span><span class="si">}</span><span class="s1">, remove_background=</span><span class="si">{</span><span class="n">remove_background</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Step 3: Remove background if required</span>
        <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
            <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Step 4: Calculate global lower percentile for the channel</span>
        <span class="n">non_zero_single_channel</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">global_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;lower_percentile&#39;</span><span class="p">])</span>

        <span class="c1"># Step 5: Calculate global upper percentile for the channel</span>
        <span class="n">global_upper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">upper_p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">upper_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">upper_value</span> <span class="o">&gt;=</span> <span class="n">signal_threshold</span><span class="p">:</span>
                <span class="n">global_upper</span> <span class="o">=</span> <span class="n">upper_value</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">global_upper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">global_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>  <span class="c1"># Fallback in case no upper percentile met the threshold</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: global_lower=</span><span class="si">{</span><span class="n">global_lower</span><span class="si">}</span><span class="s1">, global_upper=</span><span class="si">{</span><span class="n">global_upper</span><span class="si">}</span><span class="s1">, Signal-to-noise=</span><span class="si">{</span><span class="n">global_upper</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">global_lower</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Step 6: Normalize each array from global_lower to global_upper between 0 and 1</span>
        <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">arr_2d_normalized</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">global_lower</span><span class="p">,</span> <span class="n">global_upper</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">normalized_stack</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_normalized</span>

        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normalizing&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normalized_stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">save_dtype</span><span class="p">)</span>

<div class="viewcode-block" id="concatenate_and_normalize">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.concatenate_and_normalize">[docs]</a>
<span class="k">def</span> <span class="nf">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenates and normalizes channel data from multiple files and saves the normalized data.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the channel data files.</span>
<span class="sd">        channels (list): The list of channel indices to be concatenated and normalized.</span>
<span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
<span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
<span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>
<span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
<span class="sd">        remove_backgrounds (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
<span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
<span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
<span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
<span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The directory path where the concatenated and normalized channel data is saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
    
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating concatenated and normalized channel data for channels: </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>                    
                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">)</span>
                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>

                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> 
                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                
                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
                
                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">plot_arrays</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;figuresize&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span> <span class="n">nr</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;randomize&#39;</span><span class="p">]:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimensions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
                
                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                
                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>

                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">_norm.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>                
                <span class="k">if</span> <span class="n">batch_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting: </span><span class="si">{</span><span class="n">save_loc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">plot_arrays</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;figuresize&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span> <span class="n">nr</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and normalized. Saved to: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_fldr</span></div>


<span class="k">def</span> <span class="nf">_get_lists_for_normalization</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get lists for normalization based on the provided settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): A dictionary containing the settings for normalization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing three lists - backgrounds, signal_to_noise, and signal_thresholds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize the lists</span>
    <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">signal_to_noise</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">signal_thresholds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remove_background</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate through the channels and append the corresponding values if the channel is not None</span>
    <span class="c1"># for ch in settings[&#39;channels&#39;]:</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">]:</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">])</span>
                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">])</span>
                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">])</span>
                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_nucleus&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">]:</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">])</span>
                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">])</span>
                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">])</span>
                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_cell&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]:</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">])</span>
                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">])</span>
                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">])</span>
                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_pathogen&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">backgrounds</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="p">,</span> <span class="n">signal_thresholds</span><span class="p">,</span> <span class="n">remove_background</span>

<span class="k">def</span> <span class="nf">_normalize_stack</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">backgrounds</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">remove_backgrounds</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">signal_thresholds</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the stack of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the stack of images.</span>
<span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
<span class="sd">        remove_background (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
<span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
<span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
<span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
<span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>
        
        <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chan_index</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">signal_thresholds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">remove_backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="n">signal_2_noise</span> <span class="o">=</span> <span class="n">signal_to_noise</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chan_index:</span><span class="si">{</span><span class="n">chan_index</span><span class="si">}</span><span class="s1"> background:</span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s1"> signal_threshold:</span><span class="si">{</span><span class="n">signal_threshold</span><span class="si">}</span><span class="s1"> remove_background:</span><span class="si">{</span><span class="n">remove_background</span><span class="si">}</span><span class="s1"> signal_2_noise:</span><span class="si">{</span><span class="n">signal_2_noise</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
                <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Calculate the global lower and upper percentiles for non-zero pixels</span>
            <span class="n">non_zero_single_channel</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">global_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">upper_p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">global_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">global_upper</span> <span class="o">&gt;=</span> <span class="n">signal_threshold</span><span class="p">:</span>
                    <span class="k">break</span>
            
            <span class="c1"># Normalize the pixels in each image to the global percentiles and then dtype.</span>
            <span class="n">arr_2d_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">single_channel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">single_channel</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">signal_to_noise_ratio_ls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">non_zero_arr_2d</span> <span class="o">=</span> <span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">non_zero_arr_2d</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_arr_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">lower_percentile</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">))</span>
                    <span class="n">signal_to_noise_ratio</span> <span class="o">=</span> <span class="n">upper</span> <span class="o">/</span> <span class="n">lower</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">signal_to_noise_ratio</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">signal_to_noise_ratio_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal_to_noise_ratio</span><span class="p">)</span>
                <span class="n">average_stnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signal_to_noise_ratio_ls</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_to_noise_ratio_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">signal_to_noise_ratio</span> <span class="o">&gt;</span> <span class="n">signal_2_noise</span><span class="p">:</span>
                    <span class="n">arr_2d_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">arr_2d_normalized</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr_2d_rescaled</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arr_2d_normalized</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr_2d</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">average_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time_ls</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels:</span><span class="si">{</span><span class="n">chan_index</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">, arrays:</span><span class="si">{</span><span class="n">array_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, Signal:</span><span class="si">{</span><span class="n">upper</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, noise:</span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Signal-to-noise:</span><span class="si">{</span><span class="n">average_stnr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Time/channel:</span><span class="si">{</span><span class="n">average_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">sec&#39;</span><span class="p">)</span>

                <span class="c1">#stop = time.time()</span>
                <span class="c1">#duration = stop - start</span>
                <span class="c1">#time_ls.append(duration)</span>
                <span class="c1">#files_processed = file_index + 1</span>
                <span class="c1">#files_to_process = len(paths)</span>
                <span class="c1">#print_progress(files_processed, files_to_process, n_jobs=1, time_ls=time_ls, batch_size=None, operation_type=&quot;Normalizing&quot;)</span>
                
            <span class="n">normalized_stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_normalized</span>
        
        <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_stack.npz&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">save_dtype</span><span class="p">),</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">normalized_stack</span><span class="p">,</span> <span class="n">single_channel</span><span class="p">,</span> <span class="n">arr_2d_normalized</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved stacks: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_normalize_timelapse</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the timelapse data by rescaling the intensity values based on percentiles.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the timelapse data files.</span>
<span class="sd">        lower_percentile (int, optional): The lower percentile used to calculate the intensity range. Defaults to 1.</span>
<span class="sd">        save_dtype (numpy.dtype, optional): The data type to save the normalized stack. Defaults to np.float32.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>

        <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chan_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span>
            <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">]</span>
                <span class="c1"># Calculate the 1% and 98% percentiles for this specific image</span>
                <span class="n">q_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="p">)</span>
                <span class="n">q_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">98</span><span class="p">)</span>

                <span class="c1"># Rescale intensity based on the calculated percentiles to fill the dtype range</span>
                <span class="n">arr_2d_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">q_low</span><span class="p">,</span> <span class="n">q_high</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="s1">&#39;dtype&#39;</span><span class="p">)</span>
                <span class="n">normalized_stack</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_rescaled</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels:</span><span class="si">{</span><span class="n">chan_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, arrays:</span><span class="si">{</span><span class="n">array_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1">#stop = time.time()</span>
                <span class="c1">#duration = stop - start</span>
                <span class="c1">#time_ls.append(duration)</span>
                <span class="c1">#files_processed = file_index+1</span>
                <span class="c1">#files_to_process = len(paths)</span>
                <span class="c1">#print_progress(files_processed, files_to_process, n_jobs=1, time_ls=time_ls, batch_size=None, operation_type=&quot;Normalizing&quot;)</span>

        <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">normalized_stack</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saved normalized stacks: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create movies from numpy files per channel.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the numpy files.</span>
<span class="sd">        fps (int, optional): Frames per second for the output movies. Defaults to 10.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">.timelapse</span> <span class="kn">import</span> <span class="n">_npz_to_movie</span>
    
    <span class="n">master_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">master_path</span><span class="p">,</span><span class="s1">&#39;movies&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Organize files by plate, well, field</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
    <span class="n">organized_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)_(\w+)_(\w+)_(\d+)\.npy&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">organized_files</span><span class="p">:</span>
                <span class="n">organized_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">organized_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">organized_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1">#if array.dtype != np.uint8:</span>
            <span class="c1">#    array = ((array - array.min()) / (array.max() - array.min()) * 255).astype(np.uint8)</span>
            <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arrays</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># Extract the current channel for all time points</span>
        <span class="n">channel_arrays</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span>
        <span class="c1"># Flatten the channel data to compute global percentiles</span>
        <span class="n">channel_data_flat</span> <span class="o">=</span> <span class="n">channel_arrays</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_data_flat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span>
        <span class="c1"># Normalize and rescale each array in the channel</span>
        <span class="n">normalized_channel_arrays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">arr</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p99</span> <span class="o">-</span> <span class="n">p1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">channel_arrays</span><span class="p">]</span>
        <span class="c1"># Convert the list of 2D arrays into a list of 3D arrays with a single channel</span>
        <span class="n">normalized_channel_arrays_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">normalized_channel_arrays</span><span class="p">]</span>
        <span class="c1"># Save as movie for the current channel</span>
        <span class="n">channel_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">_channel_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.mp4&#39;</span><span class="p">)</span>
        <span class="n">_npz_to_movie</span><span class="p">(</span><span class="n">normalized_channel_arrays_3d</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">channel_save_path</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>

<div class="viewcode-block" id="delete_empty_subdirectories">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.delete_empty_subdirectories">[docs]</a>
<span class="k">def</span> <span class="nf">delete_empty_subdirectories</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes all empty subdirectories in the specified folder.</span>

<span class="sd">    Args:</span>
<span class="sd">    - folder_path (str): The path to the folder in which to look for empty subdirectories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check each item in the specified folder</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># os.walk is used with topdown=False to start from the innermost directories and work upwards.</span>
        <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="c1"># Construct the full path to the subdirectory</span>
            <span class="n">full_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
            <span class="c1"># Try to remove the directory and catch any error (like if the directory is not empty)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">full_dir_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted empty directory: </span><span class="si">{</span><span class="n">full_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span></div>

                <span class="c1"># An error occurred, likely because the directory is not empty</span>
                <span class="c1">#print(f&quot;Skipping non-empty directory: {full_dir_path}&quot;)</span>

<span class="c1">#@log_function_call</span>
<div class="viewcode-block" id="preprocess_img_data">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.preprocess_img_data">[docs]</a>
<span class="k">def</span> <span class="nf">preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocesses image data by converting z-stack images to maximum intensity projection (MIP) images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the z-stack images.</span>
<span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;cellvoyager&#39;.</span>
<span class="sd">        custom_regex (str, optional): The custom regular expression pattern used to match the filenames of the z-stack images. Defaults to None.</span>
<span class="sd">        cmap (str, optional): The colormap used for plotting. Defaults to &#39;inferno&#39;.</span>
<span class="sd">        figuresize (int, optional): The size of the figure for plotting. Defaults to 15.</span>
<span class="sd">        normalize (bool, optional): Whether to normalize the images. Defaults to False.</span>
<span class="sd">        nr (int, optional): The number of images to preprocess. Defaults to 1.</span>
<span class="sd">        plot (bool, optional): Whether to plot the images. Defaults to False.</span>
<span class="sd">        mask_channels (list, optional): The channels to use for masking. Defaults to [0, 1, 2].</span>
<span class="sd">        batch_size (list, optional): The number of images to process in each batch. Defaults to [100, 100, 100].</span>
<span class="sd">        timelapse (bool, optional): Whether the images are from a timelapse experiment. Defaults to False.</span>
<span class="sd">        remove_background (bool, optional): Whether to remove the background from the images. Defaults to False.</span>
<span class="sd">        backgrounds (int, optional): The number of background images to use for background removal. Defaults to 100.</span>
<span class="sd">        lower_percentile (float, optional): The lower percentile used for background removal. Defaults to 1.</span>
<span class="sd">        save_dtype (type, optional): The data type used for saving the preprocessed images. Defaults to np.float32.</span>
<span class="sd">        randomize (bool, optional): Whether to randomize the order of the images. Defaults to True.</span>
<span class="sd">        all_to_mip (bool, optional): Whether to convert all images to MIP. Defaults to False.</span>
<span class="sd">        settings (dict, optional): Additional settings for preprocessing. Defaults to {}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_run_test_mode</span><span class="p">,</span> <span class="n">_get_regex</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_default_settings_preprocess_img_data</span>
    
    <span class="n">src</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">delete_empty_subdirectories</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;nd2&#39;</span><span class="p">,</span> <span class="s1">&#39;czi&#39;</span><span class="p">,</span> <span class="s1">&#39;lif&#39;</span><span class="p">]</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="c1"># Filter only valid extensions</span>
    <span class="n">valid_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ext</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extensions</span> <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">valid_ext</span><span class="p">]</span>
    <span class="c1"># Determine most common valid extension</span>
    <span class="n">img_format</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">valid_extensions</span><span class="p">:</span>
        <span class="n">extension_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">valid_extensions</span><span class="p">)</span>
        <span class="n">most_common_extension</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">valid_extensions</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">img_format</span> <span class="o">=</span> <span class="n">most_common_extension</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="n">most_common_extension</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s2"> files&quot;</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find any </span><span class="si">{</span><span class="n">valid_ext</span><span class="si">}</span><span class="s2"> files in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">files</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please check the folder and try again&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;stack&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing stack folder.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;channel_stack&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing channel_stack folder.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;masks&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing masks folder. Skipping preprocessing&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span>

    <span class="n">mask_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_settings_preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">regex</span> <span class="o">=</span> <span class="n">_get_regex</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_type&#39;</span><span class="p">],</span> <span class="n">img_format</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_regex&#39;</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;test_mode&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running spacr in test mode&quot;</span><span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted test directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting test directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete manually before running test mode&quot;</span><span class="p">)</span>
                <span class="k">pass</span>

        <span class="n">src</span> <span class="o">=</span> <span class="n">_run_test_mode</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="n">regex</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;test_images&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;random_test&#39;</span><span class="p">])</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
    
    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
            <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   
   
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">img_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.lif&#39;</span><span class="p">]</span>
                <span class="n">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_type&#39;</span><span class="p">],</span> <span class="n">img_format</span><span class="p">)</span>
                
                <span class="c1">#Make sure no batches will be of only one image</span>
                <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
                <span class="n">full_batches</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">//</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
                <span class="n">last_batch_size</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
                
                <span class="c1"># Check if the last batch is of size 1</span>
                <span class="k">if</span> <span class="n">last_batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># If there&#39;s only one batch and its size is 1, it&#39;s also an issue</span>
                    <span class="k">if</span> <span class="n">full_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
                    <span class="c1"># If the last batch is of size 1, merge it with the second last batch</span>
                    <span class="k">elif</span> <span class="n">full_batches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;all images: </span><span class="si">{</span><span class="n">all_imgs</span><span class="si">}</span><span class="s2">,  full batch: </span><span class="si">{</span><span class="n">full_batches</span><span class="si">}</span><span class="s2">, last batch: </span><span class="si">{</span><span class="n">last_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Last batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
        
                <span class="n">nr_channel_folders</span> <span class="o">=</span> <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">nr_channel_folders</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of channels does not match number of channel folders. channels: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> channel folders: </span><span class="si">{</span><span class="n">nr_channel_folders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nr_channel_folders</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing channels from </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_channels</span>

                <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">]:</span>
                    <span class="n">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fps&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">/stack&quot;</span><span class="p">)</span>
                    <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;figuresize&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span> <span class="n">nr</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;normalize&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;all_to_mip&#39;</span><span class="p">]:</span>
                    <span class="n">_mip_all</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plotting </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">/stack&quot;</span><span class="p">)</span>
                        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;figuresize&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span> <span class="n">nr</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nr&#39;</span><span class="p">],</span> <span class="n">normalize</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;normalize&#39;</span><span class="p">])</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">stack_path</span><span class="p">,</span>
                              <span class="n">channels</span><span class="o">=</span><span class="n">mask_channels</span><span class="p">,</span>
                              <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                              <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span></div>

    
<span class="k">def</span> <span class="nf">_check_masks</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_filenames</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the masks in a batch and filter out the ones that already exist in the output folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (list): List of masks.</span>
<span class="sd">        batch_filenames (list): List of filenames corresponding to the masks.</span>
<span class="sd">        output_folder (str): Path to the output folder.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the filtered batch (numpy array) and the filtered filenames (list).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a mask for filenames that are already present in the output folder</span>
    <span class="n">existing_files_mask</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">batch_filenames</span><span class="p">]</span>

    <span class="c1"># Use the mask to filter the batch and batch_filenames</span>
    <span class="n">filtered_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">existing_files_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">exists</span><span class="p">]</span>
    <span class="n">filtered_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_filenames</span><span class="p">,</span> <span class="n">existing_files_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">exists</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_batch</span><span class="p">),</span> <span class="n">filtered_filenames</span>

<span class="k">def</span> <span class="nf">_get_avg_object_size</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate:</span>
<span class="sd">    - average number of objects per image</span>
<span class="sd">    - average object size over all objects</span>

<span class="sd">    Parameters:</span>
<span class="sd">    masks (list): A list of 2D or 3D masks with labeled objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">    tuple:</span>
<span class="sd">        avg_num_objects_per_image (float)</span>
<span class="sd">        avg_object_size (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">per_image_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_areas</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">props</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">props</span><span class="p">]</span>
            <span class="n">per_image_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">areas</span><span class="p">))</span>
            <span class="n">all_areas</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">per_image_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Mask </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is empty.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Mask </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has invalid dimension: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Average number of objects per image</span>
    <span class="k">if</span> <span class="n">per_image_counts</span><span class="p">:</span>
        <span class="n">avg_num_objects_per_image</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">per_image_counts</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">per_image_counts</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">avg_num_objects_per_image</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Average object size over all objects</span>
    <span class="k">if</span> <span class="n">all_areas</span><span class="p">:</span>
        <span class="n">avg_object_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">all_areas</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_areas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">avg_object_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">avg_num_objects_per_image</span><span class="p">,</span> <span class="n">avg_object_size</span>

<span class="k">def</span> <span class="nf">_get_avg_object_size_v1</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the average size of objects in a list of masks.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    masks (list): A list of masks representing objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">    float: The average size of objects in the masks. Returns 0 if no objects are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">object_areas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
        <span class="c1"># Check if the mask is a 2D or 3D array and is not empty</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">object_areas</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask is empty. &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask is not in the correct format. dim: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">if</span> <span class="n">object_areas</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">object_areas</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_areas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Return 0 if no objects are found</span>
    
<span class="k">def</span> <span class="nf">_save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">all_folders</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a figure to a specified location.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    fig (matplotlib.figure.Figure): The figure to be saved.</span>
<span class="sd">    src (str): The source file path.</span>
<span class="sd">    text (str): The text to be included in the figure name.</span>
<span class="sd">    dpi (int, optional): The resolution of the saved figure. Defaults to 300.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">obj_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_folder</span><span class="p">)</span>
    <span class="n">save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s1">.pdf&#39;</span>        
    <span class="n">save_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">fig_name</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_location</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

    <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">all_folders</span>
    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Saving Figures&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved single cell figure: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">fig</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    
<span class="k">def</span> <span class="nf">_read_and_join_tables</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;png_list&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads and joins tables from a SQLite database.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_path (str): The path to the SQLite database file.</span>
<span class="sd">        table_names (list, optional): The names of the tables to read and join. Defaults to [&#39;cell&#39;, &#39;cytoplasm&#39;, &#39;nucleus&#39;, &#39;pathogen&#39;, &#39;png_list&#39;].</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: The joined DataFrame containing the data from the specified tables, or None if an error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span>
    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">dataframes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataframes</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> not found in the database.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;png_list&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">][[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;png_path&#39;</span><span class="p">,</span> <span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;rowID&#39;</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">png_list_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cell_id&#39;</span><span class="p">:</span> <span class="s1">&#39;object_label&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
            <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;rowID&#39;</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">,</span><span class="s1">&#39;fieldID&#39;</span><span class="p">]</span>
            <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">png_list_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">join_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell table not found in database tables.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">png_list_df</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
            <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">non_numeric_cols</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">}</span>
            <span class="n">agg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">non_numeric_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">]})</span>
            <span class="n">grouping_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">]</span>
            <span class="n">agg_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_cols</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span>
            <span class="n">agg_df</span><span class="p">[</span><span class="s1">&#39;count_&#39;</span> <span class="o">+</span> <span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_cols</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_df</span>
    <span class="n">joined_df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
        <span class="n">joined_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;cytoplasm&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
        <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cytoplasm&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_cytoplasm&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
            <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">joined_df</span>
    
<span class="k">def</span> <span class="nf">_save_settings_to_db</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the settings dictionary to a SQLite database.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): A dictionary containing the settings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert the settings dictionary into a DataFrame</span>
    <span class="n">settings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;setting_key&#39;</span><span class="p">,</span> <span class="s1">&#39;setting_value&#39;</span><span class="p">])</span>
    <span class="c1"># Convert all values in the &#39;setting_value&#39; column to strings</span>
    <span class="n">settings_df</span><span class="p">[</span><span class="s1">&#39;setting_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_df</span><span class="p">[</span><span class="s1">&#39;setting_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">settings_df</span><span class="p">)</span>
    <span class="c1"># Determine the directory path</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/measurements&#39;</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Database connection and saving the settings DataFrame</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/measurements.db&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">settings_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Replace the table if it already exists</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_save_mask_timelapse_as_gif</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">tracks_df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a timelapse animation of masks as a GIF.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - masks (list): List of mask frames.</span>
<span class="sd">    - tracks_df (pandas.DataFrame): DataFrame containing track information.</span>
<span class="sd">    - path (str): Path to save the GIF file.</span>
<span class="sd">    - cmap (str or matplotlib.colors.Colormap): Colormap for displaying the masks.</span>
<span class="sd">    - norm (matplotlib.colors.Normalize): Normalization for the colormap.</span>
<span class="sd">    - filenames (list): List of filenames corresponding to each mask frame.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the face color for the figure to black</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  <span class="c1"># Set the axes background color to black</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Turn off the axis</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Adjust the subplot edges</span>

    <span class="n">filename_text_obj</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize a variable to keep track of the text object</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the frame of the animation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - frame (int): The frame number to update.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">filename_text_obj</span>  <span class="c1"># Reference the nonlocal variable to update it</span>
        <span class="k">if</span> <span class="n">filename_text_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename_text_obj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># Remove the previous text object if it exists</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear the axis to draw the new frame</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Ensure axis is still off after clearing</span>
        <span class="n">current_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">current_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame: </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

        <span class="c1"># Add the filename as text on the figure</span>
        <span class="n">filename_text</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>  <span class="c1"># Get the filename corresponding to the current frame</span>
        <span class="n">filename_text_obj</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">filename_text</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># Adjust text position, size, and color as needed</span>

        <span class="c1"># Annotate each object with its label number from the mask</span>
        <span class="k">for</span> <span class="n">label_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">current_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># Skip background</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_mask</span> <span class="o">==</span> <span class="n">label_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_value</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Overlay tracks</span>
        <span class="k">if</span> <span class="n">tracks_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">_track</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="p">[</span><span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_track</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">_track</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">_update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">),</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>  <span class="c1"># Adjust DPI for size/quality</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved timelapse to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_save_object_counts_to_database</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">object_type</span><span class="p">,</span> <span class="n">file_names</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">added_string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the counts of unique objects in masks to a SQLite database.</span>

<span class="sd">    Args:</span>
<span class="sd">        arrays (List[np.ndarray]): List of masks.</span>
<span class="sd">        object_type (str): Type of object.</span>
<span class="sd">        file_names (List[str]): List of file names corresponding to the masks.</span>
<span class="sd">        db_path (str): Path to the SQLite database.</span>
<span class="sd">        added_string (str): Additional string to append to the count type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_count_objects</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count unique objects in a mask, assuming 0 is the background.&quot;&quot;&quot;</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Assuming 0 is the background label, remove it from the count</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>

    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">file_names</span><span class="p">):</span>
        <span class="n">object_count</span> <span class="o">=</span> <span class="n">_count_objects</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">count_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">object_type</span><span class="si">}{</span><span class="n">added_string</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Append a tuple of (file_name, count_type, object_count) to the records list</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_name</span><span class="p">,</span> <span class="n">count_type</span><span class="p">,</span> <span class="n">object_count</span><span class="p">))</span>

    <span class="c1"># Connect to the database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Create the table if it doesn&#39;t exist</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    CREATE TABLE IF NOT EXISTS object_counts (</span>
<span class="s1">        file_name TEXT,</span>
<span class="s1">        count_type TEXT,</span>
<span class="s1">        object_count INTEGER,</span>
<span class="s1">        PRIMARY KEY (file_name, count_type)</span>
<span class="s1">    )</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Batch insert or update the object counts</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    INSERT INTO object_counts (file_name, count_type, object_count)</span>
<span class="s1">    VALUES (?, ?, ?)</span>
<span class="s1">    ON CONFLICT(file_name, count_type) DO UPDATE SET</span>
<span class="s1">    object_count = excluded.object_count</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>

    <span class="c1"># Commit changes and close the database connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_create_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a SQLite database at the specified path.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_path (str): The path where the database should be created.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
    
<span class="k">def</span> <span class="nf">_load_and_concatenate_arrays</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">cell_chann_dim</span><span class="p">,</span> <span class="n">nucleus_chann_dim</span><span class="p">,</span> <span class="n">pathogen_chann_dim</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and concatenate arrays from multiple folders.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the arrays.</span>
<span class="sd">        channels (list): List of channel indices to select from the arrays.</span>
<span class="sd">        cell_chann_dim (int): Dimension of the cell channel.</span>
<span class="sd">        nucleus_chann_dim (int): Dimension of the nucleus channel.</span>
<span class="sd">        pathogen_chann_dim (int): Dimension of the pathogen channel.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folder_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="s1">&#39;/stack&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">cell_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_mask_stack&#39;</span><span class="p">)):</span>
        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span><span class="s1">&#39;cell_mask_stack&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">nucleus_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus_mask_stack&#39;</span><span class="p">)):</span>
        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span><span class="s1">&#39;nucleus_mask_stack&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">pathogen_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_mask_stack&#39;</span><span class="p">)):</span>
        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">,</span><span class="s1">&#39;pathogen_mask_stack&#39;</span><span class="p">)]</span>

    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;/merged&#39;</span>
    <span class="n">reference_folder</span> <span class="o">=</span> <span class="n">folder_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">))</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Iterate through each file in the reference folder</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">)):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Check if this file exists in all the other specified folders</span>
            <span class="n">exists_in_all_folders</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_paths</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exists_in_all_folders</span><span class="p">:</span>
                <span class="c1"># Load and potentially modify the array from the reference folder</span>
                <span class="n">ref_array_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">concatenated_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_array_path</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">concatenated_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">concatenated_array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Add the array from the reference folder to &#39;stack_ls&#39;</span>
                <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concatenated_array</span><span class="p">)</span>

                <span class="c1"># For each of the other folders, load the array and add it to &#39;stack_ls&#39;</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">array_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="c1">#array = np.load(array_path)</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">array_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Add an extra dimension if the array is 2D</span>
                    <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">]</span>
                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#max_dims = np.max(np.array(list(unique_shapes)), axis=0)</span>
                    <span class="c1"># Determine the maximum length of tuples in unique_shapes</span>
                    <span class="n">max_tuple_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">unique_shapes</span><span class="p">)</span>
                    <span class="c1"># Pad shorter tuples with zeros to make them all the same length</span>
                    <span class="n">padded_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_tuple_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">unique_shapes</span><span class="p">]</span>
                    <span class="c1"># Now create a NumPy array and find the maximum dimensions</span>
                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded_shapes</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found. Padding arrays to max X,Y dimentions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1">#print(f&#39;Warning: arrays with multiple shapes found. Padding arrays to max X,Y dimentions {max_dims}&#39;, end=&#39;\r&#39;, flush=True)</span>
                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
                    <span class="c1"># Concatenate the padded arrays along the channel dimension (last dimension)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">concatenated_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
        
        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">files_processed</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">all_imgs</span>
        <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Merging Arrays&quot;</span><span class="p">)</span>

    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read data from a SQLite database.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - db_loc (str): The location of the SQLite database file.</span>
<span class="sd">    - tables (list): A list of table names to read from.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - dfs (list): A list of pandas DataFrames, each containing the data from a table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span><span class="p">,</span> <span class="n">correct_metadata</span>
    
    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">correct_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dfs</span>
    
<span class="k">def</span> <span class="nf">_results_to_csv</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_well</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the given dataframes as CSV files in the specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The directory path where the CSV files will be saved.</span>
<span class="sd">        df (pandas.DataFrame): The dataframe containing cell data.</span>
<span class="sd">        df_well (pandas.DataFrame): The dataframe containing well data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the cell dataframe and well dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">df</span>
    <span class="n">wells</span> <span class="o">=</span> <span class="n">df_well</span>
    <span class="n">results_loc</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;/results&#39;</span>
    <span class="n">wells_loc</span> <span class="o">=</span> <span class="n">results_loc</span><span class="o">+</span><span class="s1">&#39;/wells.csv&#39;</span>
    <span class="n">cells_loc</span> <span class="o">=</span> <span class="n">results_loc</span><span class="o">+</span><span class="s1">&#39;/cells.csv&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_loc</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">wells</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">wells_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cells</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">cells_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cells</span><span class="p">,</span> <span class="n">wells</span>

<div class="viewcode-block" id="read_plot_model_stats">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.read_plot_model_stats">[docs]</a>
<span class="k">def</span> <span class="nf">read_plot_model_stats</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">val_file_path</span> <span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">read_plot_model_stats</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">val_file_path</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads training and validation statistics from CSV files, generates plots for various metrics, </span>
<span class="sd">        and optionally saves the plots as PDF files.</span>
<span class="sd">        Args:</span>
<span class="sd">            train_file_path (str): Path to the CSV file containing training statistics.</span>
<span class="sd">            val_file_path (str): Path to the CSV file containing validation statistics.</span>
<span class="sd">            save (bool, optional): If True, saves the plots as PDF files in the same directory as </span>
<span class="sd">                the training file. If False, displays the plots interactively. Defaults to False.</span>
<span class="sd">        Metrics Plotted:</span>
<span class="sd">            - accuracy</span>
<span class="sd">            - neg_accuracy</span>
<span class="sd">            - pos_accuracy</span>
<span class="sd">            - loss</span>
<span class="sd">            - prauc</span>
<span class="sd">            - optimal_threshold</span>
<span class="sd">        Notes:</span>
<span class="sd">            - The CSV files should have a column named &#39;epoch&#39; and columns corresponding to the </span>
<span class="sd">              metrics listed above.</span>
<span class="sd">            - The plots are saved with filenames corresponding to the metric name (e.g., &#39;accuracy.pdf&#39;).</span>
<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the specified CSV files do not exist.</span>
<span class="sd">            ValueError: If the CSV files do not contain the required columns.</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; read_plot_model_stats(&quot;train_stats.csv&quot;, &quot;val_stats.csv&quot;, save=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
        
        <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>

        <span class="c1"># Create subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plotting</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">val_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Read the CSVs into DataFrames</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">val_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Get the folder path for saving plots</span>
    <span class="n">fldr_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Setting the style</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
    
    <span class="c1"># Plot and save the results</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;prauc&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span></div>

    
<span class="k">def</span> <span class="nf">_save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">results_df</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">intermedeate_save</span><span class="o">=</span><span class="p">[</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.98</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.94</span><span class="p">],</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the model based on certain conditions during training.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The trained model to be saved.</span>
<span class="sd">        model_type (str): The type of the model.</span>
<span class="sd">        results_df (pandas.DataFrame): The dataframe containing the training results.</span>
<span class="sd">        dst (str): The destination directory to save the model.</span>
<span class="sd">        epoch (int): The current epoch number.</span>
<span class="sd">        epochs (int): The total number of epochs.</span>
<span class="sd">        intermedeate_save (list, optional): List of accuracy thresholds to trigger intermediate model saves. </span>
<span class="sd">                                            Defaults to [0.99, 0.98, 0.95, 0.94].</span>
<span class="sd">        channels (list, optional): List of channels used. Defaults to [&#39;r&#39;, &#39;g&#39;, &#39;b&#39;].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">channels_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">save_model_at_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">percentile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found: </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s1">% accurate model&#39;</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">_acc_</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s1">_channels_</span><span class="si">{</span><span class="n">channels_str</span><span class="si">}</span><span class="s1">.pth&#39;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">epochs</span><span class="p">:</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">}</span><span class="s1">_channels_</span><span class="si">{</span><span class="n">channels_str</span><span class="si">}</span><span class="s1">.pth&#39;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">intermedeate_save</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nc class accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Pc class Accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="n">save_model_at_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="n">model_path</span>

<span class="k">def</span> <span class="nf">_save_progress</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the progress of the classification model.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    dst (str): The destination directory to save the progress.</span>
<span class="sd">    train_df (pandas.DataFrame): The DataFrame containing training stats.</span>
<span class="sd">    validation_df (pandas.DataFrame): The DataFrame containing validation stats (if available).</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_save_df_to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the given DataFrame to the specified CSV file, either creating a new file or appending to an existing one.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        file_path (str): The file path where the CSV will be saved.</span>
<span class="sd">        df (pandas.DataFrame): The DataFrame to save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># Ensure data is written to the file system</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                
    <span class="c1"># Save accuracy, loss, PRAUC</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results_path_train</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
    <span class="n">results_path_validation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;validation.csv&#39;</span><span class="p">)</span>

    <span class="c1"># Save training data</span>
    <span class="n">_save_df_to_csv</span><span class="p">(</span><span class="n">results_path_train</span><span class="p">,</span> <span class="n">train_df</span><span class="p">)</span>

    <span class="c1"># Save validation data if available</span>
    <span class="k">if</span> <span class="n">validation_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_save_df_to_csv</span><span class="p">(</span><span class="n">results_path_validation</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">)</span>

        <span class="c1"># Call read_plot_model_stats after ensuring the files are saved</span>
        <span class="n">read_plot_model_stats</span><span class="p">(</span><span class="n">results_path_train</span><span class="p">,</span> <span class="n">results_path_validation</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_copy_missclassified</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copies misclassified images to designated folders based on their classification.</span>

<span class="sd">    This function identifies rows in the given DataFrame where the &#39;true_label&#39; </span>
<span class="sd">    does not match the &#39;predicted_label&#39;. It then copies the corresponding files </span>
<span class="sd">    to a &quot;missclassified&quot; directory, organizing them into subdirectories </span>
<span class="sd">    (&quot;pc&quot; or &quot;nc&quot;) based on the presence of &quot;pc&quot; in the original file path.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.DataFrame): A DataFrame containing at least the following columns:</span>
<span class="sd">            - &#39;filename&#39;: The file path of the image.</span>
<span class="sd">            - &#39;true_label&#39;: The actual label of the image.</span>
<span class="sd">            - &#39;predicted_label&#39;: The predicted label of the image.</span>

<span class="sd">    Side Effects:</span>
<span class="sd">        - Creates directories for storing misclassified images if they do not exist.</span>
<span class="sd">        - Copies files from their original locations to the appropriate &quot;missclassified&quot; subdirectory.</span>

<span class="sd">    Prints:</span>
<span class="sd">        A message indicating the number of misclassified images copied.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">misclassified</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;true_label&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;predicted_label&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">misclassified</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">original_path</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span>
        <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">original_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;pc&quot;</span> <span class="ow">in</span> <span class="n">original_path</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s2">&quot;missclassified/pc&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s2">&quot;missclassified/nc&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">new_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">misclassified</span><span class="p">)</span><span class="si">}</span><span class="s2"> misclassified images.&quot;</span><span class="p">)</span>
    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads data from specified tables in a SQLite database and applies metadata corrections.</span>
<span class="sd">    Args:</span>
<span class="sd">        db_loc (str): The file path to the SQLite database.</span>
<span class="sd">        tables (list of str): A list of table names to read from the database.</span>
<span class="sd">    Returns:</span>
<span class="sd">        list of pandas.DataFrame: A list of DataFrames, each containing the data from one of the specified tables.</span>
<span class="sd">    Notes:</span>
<span class="sd">        - The function assumes the presence of utility functions `rename_columns_in_db` and `correct_metadata` </span>
<span class="sd">          in the `utils` module.</span>
<span class="sd">        - `rename_columns_in_db` is called to preprocess the database before reading.</span>
<span class="sd">        - `correct_metadata` is applied to each DataFrame after reading.</span>
<span class="sd">        - The database connection is closed after all tables are read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span><span class="p">,</span> <span class="n">correct_metadata</span>
    
    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span> <span class="c1"># Create a connection to the database</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Write a SQL query to get the data from the database</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span> <span class="c1"># Use the read_sql_query function to get the data and save it as a DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">correct_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the connection</span>
    <span class="k">return</span> <span class="n">dfs</span>

<span class="k">def</span> <span class="nf">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nuclei_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pathogen_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">change_plate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads and merges data from multiple locations and tables, processes the data, and returns a merged DataFrame </span>
<span class="sd">    along with a list of object-specific DataFrames.</span>
<span class="sd">    Args:</span>
<span class="sd">        locs (list): List of file paths or locations containing the data to be read.</span>
<span class="sd">        tables (list): List of table names to be extracted and processed.</span>
<span class="sd">        verbose (bool, optional): If True, prints detailed information about the processing steps. Defaults to False.</span>
<span class="sd">        nuclei_limit (int or bool, optional): Limit on the number of nuclei per cell. If False, only single nuclei </span>
<span class="sd">            per cell are retained. Defaults to 10.</span>
<span class="sd">        pathogen_limit (int, float, or bool, optional): Limit on the number of pathogens per cell. If False, only </span>
<span class="sd">            single pathogens per cell are retained. Defaults to 10.</span>
<span class="sd">        change_plate (bool, optional): If True, assigns unique plate IDs to each location. Defaults to False.</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            - pd.DataFrame: A merged DataFrame containing processed data from all specified tables.</span>
<span class="sd">            - list: A list of DataFrames for individual object types (e.g., cell, cytoplasm, nucleus, pathogen) </span>
<span class="sd">              if they exist in the input data.</span>
<span class="sd">    Notes:</span>
<span class="sd">        - The function processes data from multiple tables such as &#39;cell&#39;, &#39;cytoplasm&#39;, &#39;nucleus&#39;, &#39;pathogen&#39;, </span>
<span class="sd">          and &#39;png_list&#39;, if available.</span>
<span class="sd">        - Data is grouped and merged based on unique identifiers such as &#39;prcfo&#39; (plate, row, column, field, object).</span>
<span class="sd">        - Metadata is generated and merged with the final DataFrame.</span>
<span class="sd">        - The function handles missing data and applies limits on nuclei and pathogens per cell if specified.</span>
<span class="sd">        - Verbose mode provides detailed logs of the processing steps and the resulting data dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_split_data</span>

    <span class="c1"># Initialize an empty dictionary to store DataFrames by table name</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">table</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">}</span>

    <span class="c1"># Extract plate DataFrames</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">locs</span><span class="p">):</span>
        <span class="n">db_dfs</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">change_plate</span><span class="p">:</span>
            <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;plate</span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;columnID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">db_dfs</span><span class="p">):</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Concatenate rows across locations for each table</span>
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">dfs</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dfs</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize merged DataFrame with &#39;cells&#39; if available</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Process each table</span>
    <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
        <span class="n">cells_g_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">cells_g_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="si">}</span><span class="s1">, cells grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;cytoplasm&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;cytoplasm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">cytoplasms</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">cytoplasms</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">)</span><span class="si">}</span><span class="s1">, cytoplasms grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cytoplasms_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cytoplasms_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cytoplasms: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">)</span><span class="si">}</span><span class="s1">, cytoplasms grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">nucleus</span><span class="p">[</span><span class="s1">&#39;nucleus_prcfo_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">)[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nuclei_limit</span><span class="p">:</span>
            <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="p">[</span><span class="n">nucleus</span><span class="p">[</span><span class="s1">&#39;nucleus_prcfo_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus</span><span class="p">)</span><span class="si">}</span><span class="s1">, nucleus grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nucleus_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">nucleus_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus</span><span class="p">)</span><span class="si">}</span><span class="s1">, nucleus grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">)[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pathogen_limit</span><span class="p">:</span>
            <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="p">[</span><span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="p">[</span><span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">]):</span>
            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">pathogens</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogens: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens</span><span class="p">)</span><span class="si">}</span><span class="s1">, pathogens grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathogens_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">pathogens</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pathogens_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogens: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens</span><span class="p">)</span><span class="si">}</span><span class="s1">, pathogens grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="s1">&#39;png_list&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">png_list</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">png_list_g_df_numeric</span><span class="p">,</span> <span class="n">png_list_g_df_non_numeric</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">png_list</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
        <span class="n">png_list_g_df_non_numeric</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">,</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="s1">&#39;columnID&#39;</span><span class="p">,</span><span class="s1">&#39;fieldID&#39;</span><span class="p">,</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;png_list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">png_list</span><span class="p">)</span><span class="si">}</span><span class="s1">, png_list grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">png_list_g_df_numeric</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added png_list columns: </span><span class="si">{</span><span class="n">png_list_g_df_numeric</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">png_list_g_df_non_numeric</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">png_list_g_df_numeric</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">png_list_g_df_non_numeric</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Add prc (plate row column) and prcfo (plate row column field object) columns</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;columnID&#39;</span><span class="p">])</span>
    <span class="n">cells_well</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cells_per_well&#39;</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cells_well</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;columnID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;fieldID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Merge metadata with final merged DataFrame</span>
    <span class="c1">#merged_df = metadata.merge(merged_df, left_index=True, right_index=True).dropna(axis=1)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label_list_morphology&#39;</span><span class="p">,</span> <span class="s1">&#39;label_list_intensity&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated dataframe with: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1"> columns and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> rows&#39;</span><span class="p">)</span>
    
    <span class="c1"># Prepare object DataFrames for output</span>
    <span class="n">obj_df_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">merged_df</span><span class="p">,</span> <span class="n">obj_df_ls</span>
    
<span class="k">def</span> <span class="nf">_read_mask</span><span class="p">(</span><span class="n">mask_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a mask image from the specified file path and ensures it is of type uint16.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        mask_path (str): The file path to the mask image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The mask image as a NumPy array with dtype uint16.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">imageio2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">img_as_uint</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>

<div class="viewcode-block" id="convert_numpy_to_tiff">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.convert_numpy_to_tiff">[docs]</a>
<span class="k">def</span> <span class="nf">convert_numpy_to_tiff</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts all .npy files in a folder to .tiff images and saves them in a &#39;tiff&#39; subdirectory.</span>

<span class="sd">    This function searches for `.npy` files in the specified folder, loads each as a NumPy array,</span>
<span class="sd">    and writes it as a `.tiff` image using `tifffile.imwrite`. The resulting images are saved in</span>
<span class="sd">    a `tiff` subdirectory within the input folder. Optionally, processing can be limited to a</span>
<span class="sd">    specific number of files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder_path : str</span>
<span class="sd">        The path to the directory containing `.npy` files to be converted.</span>
<span class="sd">    limit : int, optional</span>
<span class="sd">        Maximum number of `.npy` files to convert. If None (default), all `.npy` files are converted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        The function saves the converted TIFF files to disk and prints status messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the subdirectory &#39;tiff&#39; within the specified folder if it doesn&#39;t already exist</span>
    <span class="n">tiff_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

    <span class="n">npy_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
    
    <span class="c1"># Iterate over all files in the folder</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Construct the full file path</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Load the numpy file</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="c1"># Construct the output TIFF file path</span>
        <span class="n">tiff_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
        <span class="n">tiff_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">tiff_filename</span><span class="p">)</span>
        
        <span class="c1"># Save the numpy array as a TIFF file</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tiff_file_path</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">tiff_filename</span><span class="si">}</span><span class="s2"> and saved in &#39;tiff&#39; subdirectory.&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>

    
<div class="viewcode-block" id="generate_cellpose_train_test">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.generate_cellpose_train_test">[docs]</a>
<span class="k">def</span> <span class="nf">generate_cellpose_train_test</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits a directory of TIFF images and corresponding Cellpose masks into training and test sets.</span>

<span class="sd">    This function searches the `src` directory for TIFF images and ensures that corresponding</span>
<span class="sd">    masks exist in the `src/masks/` folder. It then shuffles and splits the dataset into </span>
<span class="sd">    training and test sets based on the specified `test_split` ratio. The resulting subsets</span>
<span class="sd">    are copied into `train/` and `test/` folders (with `masks/` subfolders) located </span>
<span class="sd">    in the parent directory of `src`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    src : str</span>
<span class="sd">        Path to the directory containing TIFF images and a subdirectory `masks/` with corresponding mask files.</span>
<span class="sd">    test_split : float, optional</span>
<span class="sd">        Proportion of the dataset to be used for testing (default is 0.1, i.e., 10%).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Files are copied to disk and progress messages are printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;*.tif&#39;</span><span class="p">))</span>
    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">]</span>
    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_filenames</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">file</span><span class="p">))]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> images with masks&#39;</span><span class="p">)</span>
    
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span>
    <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_split</span><span class="p">)</span>
    <span class="n">train_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>
    <span class="n">test_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
    <span class="n">list_of_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_files</span><span class="p">,</span> <span class="n">train_files</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Split dataset into Train </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> and Test </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
    
    <span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">train_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="n">test_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_lists</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">test_dir</span>
            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">test_dir_masks</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">train_dir</span>
            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">train_dir_masks</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span>
            
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">new_img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">new_mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_mask</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">new_img_path</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">new_mask_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copied </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images to </span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s1"> set&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span></div>


<div class="viewcode-block" id="parse_gz_files">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.parse_gz_files">[docs]</a>
<span class="k">def</span> <span class="nf">parse_gz_files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the .fastq.gz files in the specified folder path and returns a dictionary</span>
<span class="sd">    containing the sample names and their corresponding file paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): The path to the folder containing the .fastq.gz files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where the keys are the sample names and the values are</span>
<span class="sd">        dictionaries containing the file paths for the &#39;R1&#39; and &#39;R2&#39; read directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="n">gz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fastq.gz&#39;</span><span class="p">)]</span>

    <span class="n">samples_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gz_file</span> <span class="ow">in</span> <span class="n">gz_files</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">gz_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">sample_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">read_direction</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">samples_dict</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R1&quot;</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples_dict</span></div>


<div class="viewcode-block" id="generate_dataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.generate_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">generate_dataset</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a tar archive containing a dataset of images collected from one or more database sources.</span>

<span class="sd">    This function selects image paths from one or more SQLite databases, optionally samples from them,</span>
<span class="sd">    and writes the images into a tar archive using multiprocessing to parallelize the process. Temporary tar</span>
<span class="sd">    files are created and merged into a final tar file. The function also logs and saves dataset settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : dict, optional</span>
<span class="sd">        Dictionary of user-defined settings. The following keys are used:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;src&#39; (str or list of str): Path(s) to the source folder(s) containing the database(s).</span>
<span class="sd">        - &#39;experiment&#39; (str): Name of the experiment, used to name the output tar.</span>
<span class="sd">        - &#39;sample&#39; (int or list, optional): If int, randomly sample that many images; if list, sample per src index.</span>
<span class="sd">        - &#39;file_metadata&#39; (str, optional): Metadata column name used to filter/select files.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the final tar archive containing the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">initiate_counter</span><span class="p">,</span> <span class="n">add_images_to_tar</span><span class="p">,</span> <span class="n">save_settings</span><span class="p">,</span> <span class="n">generate_path_list_from_db</span><span class="p">,</span> <span class="n">correct_paths</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_dataset_defaults</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;generate_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
            <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">)</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">generate_path_list_from_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">file_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">])</span>
            <span class="n">correct_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
            <span class="n">all_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">all_paths</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All paths: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>

    <span class="n">total_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>

    <span class="c1"># Create a temp folder in dst</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;temp_tars&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Chunking the data</span>
    <span class="n">num_procs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_procs</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_procs</span>

    <span class="n">paths_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">paths_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>

    <span class="n">temp_tar_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.tar&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating temporary tar files in </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize shared counter and lock</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initiate_counter</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">lock</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">add_images_to_tar</span><span class="p">,</span> <span class="p">[(</span><span class="n">paths_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp_tar_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">total_images</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)])</span>

    <span class="c1"># Combine the temporary tar files into a final tar</span>
    <span class="n">date_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">date_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_combined&quot;</span>
    <span class="c1">#if not settings[&#39;file_metadata&#39;] is None:</span>
    <span class="c1">#    tar_name = f&quot;{date_name}_{settings[&#39;experiment&#39;]}_{settings[&#39;file_metadata&#39;]}.tar&quot;</span>
    <span class="c1">#else:</span>
    <span class="n">tar_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.tar&quot;</span>
    <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tar_name</span><span class="p">):</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tar_name_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2">.tar&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> exists, saving as </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name_2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name_2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging temporary files&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">final_tar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">temp_tar_path</span> <span class="ow">in</span> <span class="n">temp_tar_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_tar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
                    <span class="n">final_tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">)</span>

    <span class="c1"># Delete the temp folder</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images to </span><span class="si">{</span><span class="n">tar_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tar_name</span></div>


<div class="viewcode-block" id="generate_loaders">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.generate_loaders">[docs]</a>
<span class="k">def</span> <span class="nf">generate_loaders</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span><span class="s1">&#39;pc&#39;</span><span class="p">],</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate data loaders for training and validation/test datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - src (str): The source directory containing the data.</span>
<span class="sd">    - mode (str): The mode of operation. Options are &#39;train&#39; or &#39;test&#39;.</span>
<span class="sd">    - image_size (int): The size of the input images.</span>
<span class="sd">    - batch_size (int): The batch size for the data loaders.</span>
<span class="sd">    - classes (list): The list of classes to consider.</span>
<span class="sd">    - n_jobs (int): The number of worker threads for data loading.</span>
<span class="sd">    - validation_split (float): The fraction of data to use for validation.</span>
<span class="sd">    - pin_memory (bool): Whether to pin memory for faster data transfer.</span>
<span class="sd">    - normalize (bool): Whether to normalize the input images.</span>
<span class="sd">    - verbose (bool): Whether to print additional information and show images.</span>
<span class="sd">    - channels (list): The list of channels to retain. Options are [1, 2, 3] for all channels, [1, 2] for blue and green, etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - train_loaders (list): List of data loaders for training datasets.</span>
<span class="sd">    - val_loaders (list): List of data loaders for validation datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">SelectChannels</span><span class="p">,</span> <span class="n">augment_dataset</span>

    <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">channels</span> <span class="o">=</span> <span class="n">chans</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training a network on channels: </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel 1: Red, Channel 2: Green, Channel 3: Blue&#39;</span><span class="p">)</span>
        
    <span class="n">train_loaders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading Train and validation datasets&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading test dataset&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not valid, use mode = train or test&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">class_1_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">class_2_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_1_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_2_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One or more classes not found in </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Possible class names are </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">spacrDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">)</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">validation_split</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">validation_split</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">val_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">augment</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data:</span><span class="si">{</span><span class="n">train_size</span><span class="si">}</span><span class="s1">, Validation data:</span><span class="si">{</span><span class="n">val_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">val_size</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data before augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">, Validataion:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">augment_dataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">is_grayscale</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data after augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating Dataloader with </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s1"> workers&#39;</span><span class="p">)</span>
        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">val_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#dataset (Dataset)  dataset from which to load the data.</span>
    <span class="c1">#batch_size (int, optional)  how many samples per batch to load (default: 1).</span>
    <span class="c1">#shuffle (bool, optional)  set to True to have the data reshuffled at every epoch (default: False).</span>
    <span class="c1">#sampler (Sampler or Iterable, optional)  defines the strategy to draw samples from the dataset. Can be any Iterable with __len__ implemented. If specified, shuffle must not be specified.</span>
    <span class="c1">#batch_sampler (Sampler or Iterable, optional)  like sampler, but returns a batch of indices at a time. Mutually exclusive with batch_size, shuffle, sampler, and drop_last.</span>
    <span class="c1">#num_workers (int, optional)  how many subprocesses to use for data loading. 0 means that the data will be loaded in the main process. (default: 0)</span>
    <span class="c1">#collate_fn (Callable, optional)  merges a list of samples to form a mini-batch of Tensor(s). Used when using batched loading from a map-style dataset.</span>
    <span class="c1">#pin_memory (bool, optional)  If True, the data loader will copy Tensors into device/CUDA pinned memory before returning them. If your data elements are a custom type, or your collate_fn returns a batch that is a custom type, see the example below.</span>
    <span class="c1">#drop_last (bool, optional)  set to True to drop the last incomplete batch, if the dataset size is not divisible by the batch size. If False and the size of dataset is not divisible by the batch size, then the last batch will be smaller. (default: False)</span>
    <span class="c1">#timeout (numeric, optional)  if positive, the timeout value for collecting a batch from workers. Should always be non-negative. (default: 0)</span>
    <span class="c1">#worker_init_fn (Callable, optional)  If not None, this will be called on each worker subprocess with the worker id (an int in [0, num_workers - 1]) as input, after seeding and before data loading. (default: None)</span>
    <span class="c1">#multiprocessing_context (str or multiprocessing.context.BaseContext, optional)  If None, the default multiprocessing context of your operating system will be used. (default: None)</span>
    <span class="c1">#generator (torch.Generator, optional)  If not None, this RNG will be used by RandomSampler to generate random indexes and multiprocessing to generate base_seed for workers. (default: None)</span>
    <span class="c1">#prefetch_factor (int, optional, keyword-only arg)  Number of batches loaded in advance by each worker. 2 means there will be a total of 2 * num_workers batches prefetched across all workers. (default value depends on the set value for num_workers. If value of num_workers=0 default is None. Otherwise, if value of num_workers &gt; 0 default is 2).</span>
    <span class="c1">#persistent_workers (bool, optional)  If True, the data loader will not shut down the worker processes after a dataset has been consumed once. This allows to maintain the workers Dataset instances alive. (default: False)</span>
    <span class="c1">#pin_memory_device (str, optional)  the device to pin_memory to if pin_memory is True.</span>

    <span class="c1">#images, labels, filenames = next(iter(train_loaders))</span>
    <span class="c1">#images = images.cpu()</span>
    <span class="c1">#label_strings = [str(label.item()) for label in labels]</span>
    <span class="c1">#train_fig = _imshow_gpu(images, label_strings, nrow=20, fontsize=12)</span>
    <span class="c1">#if verbose:</span>
    <span class="c1">#    plt.show()</span>
    
    <span class="n">train_fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">train_loaders</span><span class="p">,</span> <span class="n">val_loaders</span><span class="p">,</span> <span class="n">train_fig</span></div>


<div class="viewcode-block" id="generate_training_dataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.generate_training_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">generate_training_dataset</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a training dataset from a SQLite database using measurement-based or annotation/metadata-based selection.</span>

<span class="sd">    Depending on the `settings`, this function selects images corresponding to high and low phenotypes (e.g., recruitment)</span>
<span class="sd">    or based on metadata or manual annotation. Selected image paths are grouped by class and returned for further use</span>
<span class="sd">    (e.g., saving to folders or training models).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings : dict</span>
<span class="sd">        Configuration dictionary with the following required keys:</span>

<span class="sd">        - &#39;class_metadata&#39; (list of str): Metadata conditions to define classes (e.g., treatment names).</span>
<span class="sd">        - &#39;channel_of_interest&#39; (int): Channel index used for computing recruitment scores.</span>
<span class="sd">        - &#39;png_type&#39; (str): Type of PNG to retrieve (&#39;raw&#39;, &#39;outline&#39;, etc.).</span>
<span class="sd">        - &#39;size&#39; (int): Number of images to sample per class.</span>
<span class="sd">        - &#39;nuclei_limit&#39; (int or None): Minimum nucleus size for filtering (used in _read_and_merge_data).</span>
<span class="sd">        - &#39;pathogen_limit&#39; (int or None): Minimum pathogen size for filtering.</span>
<span class="sd">        - &#39;custom_measurement&#39; (list of str or None): If provided, defines custom numerator and denominator columns.</span>
<span class="sd">        - &#39;classes&#39; (list of str): Treatments to annotate using `annotate_conditions`.</span>
<span class="sd">        - &#39;metadata_type_by&#39; (str): Column in the DB to use for metadata classification (&#39;columnID&#39; or &#39;rowID&#39;).</span>
<span class="sd">        - &#39;tables&#39; (list of str): Tables to extract from database, e.g., [&#39;cell&#39;, &#39;nucleus&#39;].</span>
<span class="sd">        - &#39;dataset_mode&#39; (str): Either &#39;annotation&#39; or &#39;metadata&#39;. Controls how class sizes are determined.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of list of str</span>
<span class="sd">        A list where each sublist contains paths to PNGs belonging to one class (e.g., low vs high recruitment).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Function to filter png_list_df by prcfo present in df without merging</span>
    <span class="k">def</span> <span class="nf">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>
                
        <span class="p">[</span><span class="n">png_list_df</span><span class="p">]</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">])</span>
        <span class="n">filtered_png_list_df</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">filtered_png_list_df</span>

    <span class="c1"># Function to get the smallest class size based on the dataset mode</span>
    <span class="k">def</span> <span class="nf">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">dataset_mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]]</span>
            <span class="c1">#sizes = [len(df[df[&#39;condition&#39;].isin(class_list)]) for class_list in settings[&#39;class_metadata&#39;]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class sizes: </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span> <span class="k">for</span> <span class="n">class_paths</span> <span class="ow">in</span> <span class="n">df</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using the smallest class size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">size</span>
    
    <span class="c1"># Measurement-based selection logic</span>
    <span class="k">def</span> <span class="nf">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 1&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HeLa&#39;</span><span class="p">],</span> <span class="n">pathogens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">],</span> <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">],</span>
                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span><span class="c1">#, types=settings[&#39;metadata_type_by&#39;])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 2&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        
        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;custom_measurement should be a list.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pathogen_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cytoplasm_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span>

        <span class="n">q25</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">q75</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">df_lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">q25</span><span class="p">]</span>
        <span class="n">df_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">q75</span><span class="p">]</span>

        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_lower</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">)</span>

        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_upper</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>

    <span class="c1"># Metadata-based selection logic</span>
    <span class="k">def</span> <span class="nf">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
                
        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                 <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">cell_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">pathogens</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_name&#39;</span><span class="p">],</span>
                                 <span class="n">pathogen_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_value&#39;</span><span class="p">],</span>
                                 <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_name&#39;</span><span class="p">],</span>
                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_value&#39;</span><span class="p">])</span>
        
        <span class="c1">#if settings[&#39;metadata_type_by&#39;] == &#39;condition&#39;:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">])</span>
            
        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]:</span>
            <span class="n">class_temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
            <span class="c1">#class_temp_df = df[df[&#39;condition&#39;].isin(class_)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_temp_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> images for class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">class_temp_df</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># Ensure to sample `size` number of images (smallest class size)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

            <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>

    <span class="c1"># Annotation-based selection logic</span>
    <span class="k">def</span> <span class="nf">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>
    
    <span class="c1"># Metadata-Annotation-based selection logic</span>
    <span class="k">def</span> <span class="nf">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">],</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_type_by&#39;</span><span class="p">],</span> <span class="n">class_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_paths_from_db</span><span class="p">,</span> <span class="n">annotate_conditions</span><span class="p">,</span> <span class="n">save_settings</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_training_dataset_defaults</span>
    
    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_training_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
       
    <span class="c1"># Set default settings and save</span>
    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;cv_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">class_path_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
        <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training_all&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">)</span>

        <span class="c1"># Create a new directory for training data if necessary</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new directory for training: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="c1"># Select dataset based on dataset mode</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;measurement&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
            
        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata_annotation&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dataset mode: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid options are: &#39;annotation&#39;, &#39;metadata&#39;, &#39;measurement&#39;, &#39;metadata_annotation&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">class_path_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_path_list</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">))]</span>

        <span class="c1"># Extend each list in class_path_list with the corresponding list from class_paths_ls</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">)):</span>
            <span class="n">class_path_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="c1"># Generate and return training and testing directories</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class_path_list&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">class_path_list</span><span class="p">))</span>
    <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="o">=</span><span class="n">class_path_list</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">],</span> <span class="n">test_split</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;test_split&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span></div>


<div class="viewcode-block" id="training_dataset_from_annotation">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.training_dataset_from_annotation">[docs]</a>
<span class="k">def</span> <span class="nf">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts image paths from a database and groups them into class-based lists based on annotation values.</span>

<span class="sd">    This function reads from a SQLite database (`png_list` table), extracts image paths and corresponding</span>
<span class="sd">    class annotations, and groups them by the specified `annotated_classes`. If only one class is provided,</span>
<span class="sd">    it automatically generates a second class by sampling the remaining entries not in the target class</span>
<span class="sd">    to create a balanced binary dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    db_path : str</span>
<span class="sd">        Path to the SQLite database file containing the `png_list` table.</span>
<span class="sd">    </span>
<span class="sd">    dst : str</span>
<span class="sd">        Output path (currently unused in the function, included for compatibility with caller).</span>
<span class="sd">    </span>
<span class="sd">    annotation_column : str, default=&#39;test&#39;</span>
<span class="sd">        Column name in the `png_list` table that contains class annotations.</span>
<span class="sd">    </span>
<span class="sd">    annotated_classes : tuple of int, default=(1, 2)</span>
<span class="sd">        Class labels to extract from the annotation column.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class_paths : list of list of str</span>
<span class="sd">        A list where each sublist contains the file paths for images belonging to one class.</span>
<span class="sd">        The number of sublists equals the number of unique classes returned.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - If only one annotated class is provided, the function creates a balanced second class</span>
<span class="sd">      from non-annotated images.</span>
<span class="sd">    - This function does not copy or move any files  it only collects and returns path lists.</span>
<span class="sd">    - All path and annotation data is assumed to be stored in the `png_list` table of the SQLite DB.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Retrieve all paths and annotations from the database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> FROM png_list&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
    
    <span class="c1"># Filter paths based on annotated_classes</span>
    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        
        <span class="c1"># Sample the same number of images for both classes</span>
        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>

        <span class="c1"># Resample target class to match the smaller size</span>
        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
        
        <span class="c1"># Update class paths</span>
        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">class_paths</span></div>


<div class="viewcode-block" id="training_dataset_from_annotation_metadata">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.training_dataset_from_annotation_metadata">[docs]</a>
<span class="k">def</span> <span class="nf">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="s1">&#39;columnID&#39;</span><span class="p">,</span> <span class="n">class_metadata</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;c2&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts annotated image paths from a database, filtered by metadata location (row/column).</span>

<span class="sd">    This function reads image paths and annotations from a SQLite database (`png_list` table), filters them</span>
<span class="sd">    by metadata (either `row_name` or `column_name`), and organizes them into class-specific lists based on</span>
<span class="sd">    annotation values. If only one class is specified, the function samples a balanced second class from </span>
<span class="sd">    remaining entries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    db_path : str</span>
<span class="sd">        Path to the SQLite database containing the `png_list` table.</span>

<span class="sd">    dst : str</span>
<span class="sd">        Output directory (unused in this function but required for compatibility).</span>

<span class="sd">    annotation_column : str, default=&#39;test&#39;</span>
<span class="sd">        The column name in `png_list` storing the annotation labels.</span>

<span class="sd">    annotated_classes : tuple of int, default=(1, 2)</span>
<span class="sd">        Annotation values to be used for splitting data into separate class groups.</span>

<span class="sd">    metadata_type_by : str, {&#39;rowID&#39;, &#39;columnID&#39;}, default=&#39;columnID&#39;</span>
<span class="sd">        Which metadata field to filter by  either &#39;rowID&#39; (uses `row_name`) or &#39;columnID&#39; (uses `column_name`).</span>

<span class="sd">    class_metadata : list of str, default=[&#39;c1&#39;, &#39;c2&#39;]</span>
<span class="sd">        The metadata values to include (e.g., specific row or column identifiers to filter on).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class_paths : list of list of str</span>
<span class="sd">        A list where each sublist contains paths to images in one class.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `metadata_type_by` is not one of &#39;rowID&#39; or &#39;columnID&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - If only one class is specified in `annotated_classes`, a second class is constructed by sampling</span>
<span class="sd">      from non-target annotations in the filtered set to ensure balanced class representation.</span>
<span class="sd">    - This function assumes that `png_path`, `annotation_column`, `row_name`, and `column_name` exist</span>
<span class="sd">      in the `png_list` table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Retrieve all paths and annotations from the database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2">, row_name, column_name FROM png_list&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
    
    <span class="c1"># Filter all_paths by metadata_type_by and class_metadata</span>
    <span class="n">filtered_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metadata_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rowID&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_type_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metadata_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid metadata_type_by value: </span><span class="si">{</span><span class="n">metadata_type_by</span><span class="si">}</span><span class="s2">. Must be &#39;rowID&#39; or &#39;columnID&#39;. </span><span class="si">{</span><span class="n">class_metadata</span><span class="si">}</span><span class="s2"> must be a list formatted as [&#39;c1&#39;, &#39;c2&#39;] or [&#39;r1&#39;, &#39;r2&#39;]&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">metadata_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">class_metadata</span><span class="p">:</span>
            <span class="n">filtered_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total filtered paths:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_paths</span><span class="p">))</span>
    <span class="c1">#all_paths = filtered_paths</span>
    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_paths</span><span class="p">]</span>
    
    <span class="c1"># Filter paths based on annotated_classes</span>
    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        
        <span class="c1"># Sample the same number of images for both classes</span>
        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>

        <span class="c1"># Resample target class to match the smaller size</span>
        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
        
        <span class="c1"># Update class paths</span>
        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">class_paths</span></div>


<div class="viewcode-block" id="generate_dataset_from_lists">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.generate_dataset_from_lists">[docs]</a>
<span class="k">def</span> <span class="nf">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a train/test image dataset directory structure from class-wise path lists.</span>

<span class="sd">    This function creates `train` and `test` subdirectories under the given destination directory (`dst`)</span>
<span class="sd">    and copies the image files into class-specific folders after performing a train-test split.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dst : str</span>
<span class="sd">        Destination directory where the dataset will be created. Subdirectories for each class will be made under `train/` and `test/`.</span>

<span class="sd">    class_data : list of list of str</span>
<span class="sd">        A list where each sublist contains paths to image files belonging to a specific class.</span>

<span class="sd">    classes : list of str</span>
<span class="sd">        Class names corresponding to the order of `class_data`.</span>

<span class="sd">    test_split : float, default=0.1</span>
<span class="sd">        Proportion of data to be used for the test set. The remainder is used for training.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    train_dir : str</span>
<span class="sd">        Path to the top-level training directory.</span>

<span class="sd">    test_dir : str</span>
<span class="sd">        Path to the top-level test directory.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the number of class labels does not match the number of class data lists.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The train/test split is deterministic (random_state=42).</span>
<span class="sd">    File copying is timed and progress is reported via `print_progress`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
    <span class="c1"># Make sure that the length of class_data matches the length of classes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;class_data and classes must have the same length.&quot;</span><span class="p">)</span>

    <span class="n">total_files</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">class_data</span><span class="p">)</span>
    <span class="n">processed_files</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">class_data</span><span class="p">):</span>
        <span class="c1"># Create directories</span>
        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="c1"># Split the data</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">test_split</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_split</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="c1"># Copy train files</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Train dataset&quot;</span><span class="p">)</span>
            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Copy test files</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Test dataset&quot;</span><span class="p">)</span>
            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Print summary</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">, Test class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_separate_files_to_yokogawa">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.convert_separate_files_to_yokogawa">[docs]</a>
<span class="k">def</span> <span class="nf">convert_separate_files_to_yokogawa</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts image files from a folder into Yokogawa-style naming format with optional MIP across Z-slices.</span>

<span class="sd">    This function parses filenames using a provided regex, extracts metadata such as well ID, channel, field,</span>
<span class="sd">    timepoint, and slice, and renames the images to the Yokogawa convention:</span>
<span class="sd">    `plateX_WELL_TttttFfffL01Ccc.tif`. If multiple Z-slices exist, it computes a maximum intensity projection (MIP).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str</span>
<span class="sd">        Path to the folder containing input TIFF images.</span>

<span class="sd">    regex : str</span>
<span class="sd">        Regular expression with named capture groups:</span>
<span class="sd">        - &#39;plateID&#39; (optional)</span>
<span class="sd">        - &#39;wellID&#39; (required)</span>
<span class="sd">        - &#39;fieldID&#39; (optional)</span>
<span class="sd">        - &#39;timeID&#39; (optional)</span>
<span class="sd">        - &#39;chanID&#39; (optional)</span>
<span class="sd">        - &#39;sliceID&#39; (optional)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Saves renamed TIFF files and a CSV log (`rename_log.csv`) in the same folder.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Automatically assigns new well names (`plateX_WELL`) if missing or non-standard.</span>
<span class="sd">    - Groups images by region (plate, well, field, time, channel) and performs MIP if multiple slices are present.</span>
<span class="sd">    - Skips files that do not match the regex or are missing required metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
    <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
    <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">):</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">WELLS</span><span class="p">:</span>
            <span class="n">well_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">well_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_wells</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">well_name</span>
            <span class="k">if</span> <span class="n">well</span> <span class="o">==</span> <span class="s2">&quot;P24&quot;</span><span class="p">:</span>
                <span class="n">plate</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_A01&quot;</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

    <span class="n">files_by_region</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rename_log</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;rename_log.csv&quot;</span><span class="p">)</span>
    <span class="n">used_wells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">region_to_well</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Group files by (plateID, wellID, fieldID, timeID, chanID)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: does not match regex.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>

        <span class="c1"># Mandatory metadata</span>
        <span class="k">if</span> <span class="s1">&#39;wellID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">or</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;wellID&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: missing mandatory wellID.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">wellID</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;wellID&#39;</span><span class="p">]</span>

        <span class="c1"># Optional metadata with defaults</span>
        <span class="n">plateID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">fieldID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fieldID&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">timeID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">chanID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chanID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sliceID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sliceID&#39;</span><span class="p">)</span>
        <span class="n">sliceID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sliceID</span><span class="p">)</span> <span class="k">if</span> <span class="n">sliceID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">region_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plateID</span><span class="p">,</span> <span class="n">wellID</span><span class="p">,</span> <span class="n">fieldID</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">chanID</span><span class="p">)</span>

        <span class="n">files_by_region</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">region_key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file</span><span class="p">,</span> <span class="n">sliceID</span><span class="p">))</span>

    <span class="c1"># Assign wells and process files per region</span>
    <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">files_by_region</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">region_to_well</span><span class="p">:</span>
            <span class="n">next_well</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>
            <span class="n">region_to_well</span><span class="p">[</span><span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">next_well</span>
            <span class="n">used_wells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_well</span><span class="p">)</span>

        <span class="n">assigned_well</span> <span class="o">=</span> <span class="n">region_to_well</span><span class="p">[</span><span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">plateID</span><span class="p">,</span> <span class="n">wellID</span><span class="p">,</span> <span class="n">fieldID</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">chanID</span> <span class="o">=</span> <span class="n">region</span>

        <span class="c1"># Check if multiple slices exist and are meaningful</span>
        <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sid</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">unique_slices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># Perform MIP only if multiple unique slices are present</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_slices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">img_to_save</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_to_save</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="n">img_to_save</span><span class="o">.</span><span class="n">dtype</span>

        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assigned_well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">timeID</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fieldID</span><span class="p">)</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">chanID</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
        <span class="n">new_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">new_filepath</span><span class="p">,</span> <span class="n">img_to_save</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

        <span class="c1"># Log original filenames involved in MIP or single file rename</span>
        <span class="n">original_files</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">)</span>
        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File(s)&quot;</span><span class="p">:</span> <span class="n">original_files</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">new_filename</span><span class="p">})</span>

    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rename_log</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete. Files saved in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> and rename log saved as </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_to_yokogawa">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.convert_to_yokogawa">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_yokogawa</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts microscopy image files in a folder to Yokogawa-style TIFF filenames.</span>

<span class="sd">    This function processes raw microscopy images in various formats (ND2, CZI, LIF, TIFF, PNG, JPEG, BMP) </span>
<span class="sd">    and converts them into a standardized Yokogawa naming scheme using maximum intensity projections (MIPs).</span>
<span class="sd">    Each image is assigned a unique well location (e.g., plate1_A01) across one or more 384-well plates.</span>
<span class="sd">    The output files are saved in the same directory with renamed filenames. A CSV log is generated </span>
<span class="sd">    to track the mapping between original files and the renamed TIFFs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    folder : str</span>
<span class="sd">        Path to the directory containing the input microscopy files.</span>

<span class="sd">    Supported Formats</span>
<span class="sd">    -----------------</span>
<span class="sd">    - `.nd2` : Nikon ND2 format (processed using ND2Reader)</span>
<span class="sd">    - `.czi` : Zeiss CZI format (processed using pyczi)</span>
<span class="sd">    - `.lif` : Leica LIF format (processed using readlif)</span>
<span class="sd">    - `.tif`, `.tiff`, `.png`, `.jpg`, `.jpeg`, `.bmp` : Image files (processed using tifffile)</span>

<span class="sd">    Behavior</span>
<span class="sd">    --------</span>
<span class="sd">    - Computes maximum intensity projections across Z-stacks.</span>
<span class="sd">    - Generates Yokogawa-style filenames: `plateX_&lt;WELL&gt;_T####F###L01C##.tif`</span>
<span class="sd">    - Handles timepoints, Z-stacks, channels, fields, and scenes depending on format.</span>
<span class="sd">    - Avoids reusing well positions across multiple files and scenes.</span>
<span class="sd">    - Skips malformed or incomplete image structures.</span>
<span class="sd">    - Logs all renamed output files to `rename_log.csv` in the same folder.</span>

<span class="sd">    Output</span>
<span class="sd">    ------</span>
<span class="sd">    - Converted TIFF images saved in the input folder with Yokogawa-style filenames.</span>
<span class="sd">    - A CSV log `rename_log.csv` containing columns:</span>
<span class="sd">        &#39;Original File&#39;, &#39;Renamed TIFF&#39;, &#39;ext&#39;, &#39;time&#39;, &#39;field&#39;, &#39;channel&#39;, &#39;z&#39;, &#39;scene&#39;, &#39;slice&#39;, &#39;well&#39;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Requires `ND2Reader`, `pyczi`, `readlif`, `tifffile`, and `pandas`.</span>
<span class="sd">    - Handles multi-dimensional images (2D, 3D, 4D).</span>
<span class="sd">    - Images with unsupported dimensions or structure are skipped with warnings.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; convert_to_yokogawa(&quot;/path/to/raw_images&quot;)</span>
<span class="sd">    Processing complete. Files saved in /path/to/raw_images and rename log saved as rename_log.csv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the next available well position across multiple 384-well plates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
        <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
        <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>

        <span class="n">plate</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">WELLS</span><span class="p">:</span>
                <span class="n">well_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">well_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_wells</span><span class="p">:</span>
                    <span class="n">used_wells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">well_name</span>
            <span class="n">plate</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># All wells exhausted in current plate, increment to next plate</span>


    <span class="c1"># Define 384-well plate format</span>
    <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
    <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
    <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>

    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rename_log</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;rename_log.csv&quot;</span><span class="p">)</span>
    <span class="n">used_wells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># **Dictionary to store well assignments per original file**</span>
    <span class="n">file_to_well</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># **Assign a well only once per original file**</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_to_well</span><span class="p">:</span>
            <span class="n">file_to_well</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>
            <span class="c1">#used_wells.add(file_to_well[file])  # Mark it as used</span>

        <span class="n">well</span> <span class="o">=</span> <span class="n">file_to_well</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>  <span class="c1"># Use the same well for all channels/times</span>

        <span class="c1">### **Process Nikon ND2 Files**</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;nd2&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">nd2</span> <span class="o">=</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">nd2</span><span class="o">.</span><span class="n">metadata</span>

                <span class="n">timepoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frames&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields_of_view&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">z_levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_levels&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_levels&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channels&quot;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="n">timepoints</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f_idx</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span>
                                    <span class="n">nd2</span><span class="o">.</span><span class="n">get_frame_2D</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">f_idx</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_idx</span><span class="p">)</span> 
                                    <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="n">z_levels</span>
                                <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="n">f_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> 
                                                   <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                                                   <span class="s2">&quot;ext&quot;</span><span class="p">:</span> <span class="n">ext</span><span class="p">,</span>
                                                   <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">t_idx</span><span class="p">,</span>
                                                   <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">f_idx</span><span class="p">,</span>
                                                   <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
                                                   <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z_levels</span><span class="p">})</span>

                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: ND2 file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has an incomplete data structure. Skipping.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing ND2 file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;czi&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Open the CZI in streaming mode</span>
                <span class="k">with</span> <span class="n">pyczi</span><span class="o">.</span><span class="n">open_czi</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czidoc</span><span class="p">:</span>

                    <span class="c1"># 1) Global dimension ranges</span>
                    <span class="n">bbox</span>    <span class="o">=</span> <span class="n">czidoc</span><span class="o">.</span><span class="n">total_bounding_box</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">tlen</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">zlen</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

                    <span class="c1"># 2) Scene  list of scene indices</span>
                    <span class="n">scenes_bb</span> <span class="o">=</span> <span class="n">czidoc</span><span class="o">.</span><span class="n">scenes_bounding_rectangle</span>
                    <span class="n">scenes</span>    <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scenes_bb</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">scenes_bb</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

                    <span class="c1"># 3) Output folder (same as .czi)</span>
                    <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                    <span class="c1"># 4) Loop scene  time  channel  Z</span>
                    <span class="k">for</span> <span class="n">scene</span> <span class="ow">in</span> <span class="n">scenes</span><span class="p">:</span>
                        <span class="c1"># *** assign a unique well for this scene ***</span>
                        <span class="n">scene_well</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>

                        <span class="c1"># Field index = scene+1 (or 1 if no scene)</span>
                        <span class="n">F_idx</span> <span class="o">=</span> <span class="n">scene</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">scene</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
                        <span class="c1"># Scene index for A</span>
                        <span class="n">A_idx</span> <span class="o">=</span> <span class="n">scene</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">scene</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tlen</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clen</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">zlen</span><span class="p">):</span>
                                    <span class="c1"># Read exactly one 2D plane</span>
                                    <span class="n">arr</span> <span class="o">=</span> <span class="n">czidoc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                                        <span class="n">plane</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">},</span>
                                        <span class="n">scene</span><span class="o">=</span><span class="n">scene</span>
                                    <span class="p">)</span>
                                    <span class="n">plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

                                    <span class="c1"># Build Yokogawastyle filename:</span>
                                    <span class="n">fn</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scene_well</span><span class="si">}</span><span class="s2">_&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;T</span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;F</span><span class="si">{</span><span class="n">F_idx</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;L01&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;A</span><span class="si">{</span><span class="n">A_idx</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;Z</span><span class="si">{</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                                    <span class="p">)</span>
                                    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

                                    <span class="c1"># Write with lossless compression</span>
                                    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span>
                                        <span class="n">outpath</span><span class="p">,</span>
                                        <span class="n">plane</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                                        <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span>
                                    <span class="p">)</span>

                                    <span class="c1"># Log it</span>
                                    <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                        <span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span>
                                        <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">fn</span><span class="p">,</span>
                                        <span class="s2">&quot;ext&quot;</span><span class="p">:</span> <span class="n">ext</span><span class="p">,</span>
                                        <span class="s2">&quot;scene&quot;</span><span class="p">:</span> <span class="n">scene</span><span class="p">,</span>
                                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
                                        <span class="s2">&quot;slice&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
                                        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">F_idx</span><span class="p">,</span>
                                        <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                                        <span class="s2">&quot;well&quot;</span><span class="p">:</span> <span class="n">scene_well</span>
                                    <span class="p">})</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing CZI file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">### **Process Leica LIF Files**</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;lif&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lif_file</span> <span class="o">=</span> <span class="n">readlif</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">image_idx</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lif_file</span><span class="o">.</span><span class="n">getIterImage</span><span class="p">()):</span>
                    <span class="n">timepoints</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">z_levels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="n">timepoints</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c_idx</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                            <span class="n">z_stack</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="n">z_levels</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">frame</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">getFrame</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_idx</span><span class="p">)</span>
                                    <span class="n">z_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing frame: T</span><span class="si">{</span><span class="n">t_idx</span><span class="si">}</span><span class="s2">, Z</span><span class="si">{</span><span class="n">z_idx</span><span class="si">}</span><span class="s2">, C</span><span class="si">{</span><span class="n">c_idx</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">, skipping frame.&quot;</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">z_stack</span><span class="p">:</span>
                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">z_stack</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="n">image_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing LIF file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">### **Process Standard Image Files (TIFF, PNG, JPEG, BMP)**</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;bmp&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;plate&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
                    <span class="n">images</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
                    <span class="n">ndim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">ndim</span>

                    <span class="c1"># Defaults</span>
                    <span class="n">t_dim</span> <span class="o">=</span> <span class="n">z_dim</span> <span class="o">=</span> <span class="n">c_dim</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># Determine dimensions more explicitly</span>
                    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">mip_image</span> <span class="o">=</span> <span class="n">images</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C01.tif&quot;</span>
                        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
                        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
                        <span class="k">continue</span>

                    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Likely channels</span>
                            <span class="n">c_dim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c_dim</span><span class="p">):</span>
                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C</span><span class="si">{</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Z-stack</span>
                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C01.tif&quot;</span>
                            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
                            <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>

                    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="n">t_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_dim</span><span class="p">):</span>
                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F001L01C01.tif&quot;</span>
                            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
                            <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported TIFF dimensions: </span><span class="si">{</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing standard image file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Save rename log as CSV</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rename_log</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete. Files saved in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> and rename log saved as </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="apply_augmentation">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.apply_augmentation">[docs]</a>
<span class="k">def</span> <span class="nf">apply_augmentation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the specified augmentation method to the given image.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        image (numpy.ndarray): The input image to be augmented.</span>
<span class="sd">        method (str): The augmentation method to apply. Supported methods are:</span>
<span class="sd">            - &#39;rotate90&#39;: Rotates the image 90 degrees clockwise.</span>
<span class="sd">            - &#39;rotate180&#39;: Rotates the image 180 degrees.</span>
<span class="sd">            - &#39;rotate270&#39;: Rotates the image 90 degrees counterclockwise.</span>
<span class="sd">            - &#39;flip_h&#39;: Flips the image horizontally.</span>
<span class="sd">            - &#39;flip_v&#39;: Flips the image vertically.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The augmented image. If the method is not recognized, </span>
<span class="sd">        the original image is returned unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate90&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_90_CLOCKWISE</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate180&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_180</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate270&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_90_COUNTERCLOCKWISE</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flip_h&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flip_v&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="process_instruction">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.process_instruction">[docs]</a>
<span class="k">def</span> <span class="nf">process_instruction</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes a single image/mask entry by reading, optionally augmenting, and saving both image and mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    entry : dict</span>
<span class="sd">        A dictionary with the following keys:</span>
<span class="sd">            - &#39;src_img&#39; (str): Path to the source image file.</span>
<span class="sd">            - &#39;src_msk&#39; (str): Path to the source mask file.</span>
<span class="sd">            - &#39;dst_img&#39; (str): Path to save the processed image.</span>
<span class="sd">            - &#39;dst_msk&#39; (str): Path to save the processed mask.</span>
<span class="sd">            - &#39;augment&#39; (str or None): Augmentation identifier to apply (e.g., &#39;rotate90&#39;, &#39;flip&#39;, or None).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Returns 1 upon successful completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src_img&quot;</span><span class="p">])</span>
    <span class="n">msk</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src_msk&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">]:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">apply_augmentation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">])</span>
        <span class="n">msk</span> <span class="o">=</span> <span class="n">apply_augmentation</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">])</span>
    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dst_img&quot;</span><span class="p">],</span> <span class="n">img</span><span class="p">)</span>
    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dst_msk&quot;</span><span class="p">],</span> <span class="n">msk</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="prepare_cellpose_dataset">
<a class="viewcode-back" href="../../api/spacr/io/index.html#spacr.io.prepare_cellpose_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_cellpose_dataset</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="n">augment_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_fraction</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare a training and testing dataset for Cellpose from multiple subdirectories containing TIFF images and corresponding masks.</span>

<span class="sd">    This function scans all subfolders in `input_root` that contain a &quot;masks/&quot; directory, finds image-mask pairs,</span>
<span class="sd">    and splits them into train/test sets. Optionally, it augments data using rotation and flipping to balance dataset sizes</span>
<span class="sd">    across all datasets. All output is saved in a standardized format to a new &quot;cellpose_dataset/&quot; folder inside `input_root`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_root : str</span>
<span class="sd">        Path to the folder containing one or more datasets. Each dataset should have a &#39;masks/&#39; subfolder with mask files</span>
<span class="sd">        matching the TIFF filenames.</span>

<span class="sd">    augment_data : bool, optional</span>
<span class="sd">        If True, perform data augmentation (rotation/flipping) to increase or equalize the number of samples per dataset. </span>
<span class="sd">        Default is False.</span>

<span class="sd">    train_fraction : float, optional</span>
<span class="sd">        Fraction of data to use for training. The rest will go to testing. Default is 0.8 (i.e., 80% train, 20% test).</span>

<span class="sd">    n_jobs : int or None, optional</span>
<span class="sd">        Number of parallel worker processes. If None, uses all available CPUs minus one.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        All output TIFFs are saved under `input_root/cellpose_dataset/train/` and `.../test/` folders with consistent naming.</span>
<span class="sd">        A progress bar is printed to track the status of preprocessing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>

    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">input_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_root</span><span class="p">)</span>
    <span class="n">output_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="s2">&quot;cellpose_dataset&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_augmentations</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;rotate90&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate180&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate270&#39;</span><span class="p">,</span> <span class="s1">&#39;flip_h&#39;</span><span class="p">,</span> <span class="s1">&#39;flip_v&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">find_image_mask_pairs</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">):</span>
        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
                <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="n">msk_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">msk_path</span><span class="p">):</span>
                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pairs</span>

    <span class="k">def</span> <span class="nf">prepare_output_folders</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scanning datasets...&quot;</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_root</span><span class="p">):</span>
        <span class="n">dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)):</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="n">find_image_mask_pairs</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> images in </span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid datasets with images and masks found.&quot;</span><span class="p">)</span>

    <span class="n">prepare_output_folders</span><span class="p">(</span><span class="n">output_root</span><span class="p">)</span>

    <span class="n">min_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="n">min_size</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">augment_data</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Preparing instruction list...&quot;</span><span class="p">)</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">global_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="n">dataset_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>

        <span class="c1"># --- Step 1: Sample or augment ---</span>
        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dataset_len</span> <span class="o">&gt;=</span> <span class="n">target_size</span><span class="p">:</span>
            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">augment_data</span><span class="p">:</span>
                <span class="n">needed</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">-</span> <span class="n">dataset_len</span>
                <span class="n">aug_methods</span> <span class="o">=</span> <span class="n">get_augmentations</span><span class="p">()</span>
                <span class="n">full_loops</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">)</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_loops</span><span class="p">):</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">),</span> <span class="n">aug</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">aug_methods</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset_len</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">))):</span>
                        <span class="n">sampled_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">extra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pairs</span> <span class="o">*</span> <span class="p">((</span><span class="n">extra</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">extra</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">),</span> <span class="n">aug</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">aug_methods</span><span class="p">[:</span><span class="n">extra</span><span class="p">]):</span>
                        <span class="n">sampled_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span><span class="p">))</span>

        <span class="c1"># Add &quot;no augmentation&quot; tag to original files</span>
        <span class="n">augmented_sampled</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">tup</span>
            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">sampled_pairs</span>
        <span class="p">]</span>

        <span class="c1"># --- Step 2: Split into train/test ---</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">augmented_sampled</span><span class="p">)</span>
        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_fraction</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">augmented_sampled</span><span class="p">))</span>
        <span class="n">split_sets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">augmented_sampled</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span>
            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">augmented_sampled</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">subset</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">split_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">dst_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
                <span class="n">dst_msk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
                <span class="n">instructions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;src_img&quot;</span><span class="p">:</span> <span class="n">img_path</span><span class="p">,</span>
                    <span class="s2">&quot;src_msk&quot;</span><span class="p">:</span> <span class="n">msk_path</span><span class="p">,</span>
                    <span class="s2">&quot;dst_img&quot;</span><span class="p">:</span> <span class="n">dst_img</span><span class="p">,</span>
                    <span class="s2">&quot;dst_msk&quot;</span><span class="p">:</span> <span class="n">dst_msk</span><span class="p">,</span>
                    <span class="s2">&quot;augment&quot;</span><span class="p">:</span> <span class="n">aug</span>
                <span class="p">})</span>
                <span class="n">global_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total files to process: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Step 3: Process with multiprocessing ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing images with multiprocessing...&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span>
        
    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">process_instruction</span><span class="p">,</span> <span class="n">instructions</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;cellpose dataset&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done. Dataset saved to: </span><span class="si">{</span><span class="n">output_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>