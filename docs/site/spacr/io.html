<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>spacr.io API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../spacr.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;spacr</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#process_non_tif_non_2D_images">process_non_tif_non_2D_images</a>
            </li>
            <li>
                    <a class="class" href="#CombineLoaders">CombineLoaders</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CombineLoaders.__init__">CombineLoaders</a>
                        </li>
                        <li>
                                <a class="variable" href="#CombineLoaders.train_loaders">train_loaders</a>
                        </li>
                        <li>
                                <a class="variable" href="#CombineLoaders.loader_iters">loader_iters</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CombinedDataset">CombinedDataset</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CombinedDataset.__init__">CombinedDataset</a>
                        </li>
                        <li>
                                <a class="variable" href="#CombinedDataset.datasets">datasets</a>
                        </li>
                        <li>
                                <a class="variable" href="#CombinedDataset.lengths">lengths</a>
                        </li>
                        <li>
                                <a class="variable" href="#CombinedDataset.total_length">total_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#CombinedDataset.shuffle">shuffle</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#NoClassDataset">NoClassDataset</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NoClassDataset.__init__">NoClassDataset</a>
                        </li>
                        <li>
                                <a class="variable" href="#NoClassDataset.data_dir">data_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#NoClassDataset.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#NoClassDataset.shuffle">shuffle</a>
                        </li>
                        <li>
                                <a class="variable" href="#NoClassDataset.load_to_memory">load_to_memory</a>
                        </li>
                        <li>
                                <a class="variable" href="#NoClassDataset.filenames">filenames</a>
                        </li>
                        <li>
                                <a class="function" href="#NoClassDataset.load_image">load_image</a>
                        </li>
                        <li>
                                <a class="function" href="#NoClassDataset.shuffle_dataset">shuffle_dataset</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#spacrDataset">spacrDataset</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#spacrDataset.__init__">spacrDataset</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.data_dir">data_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.classes">classes</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.shuffle">shuffle</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.pin_memory">pin_memory</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.filenames">filenames</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataset.labels">labels</a>
                        </li>
                        <li>
                                <a class="function" href="#spacrDataset.load_image">load_image</a>
                        </li>
                        <li>
                                <a class="function" href="#spacrDataset.shuffle_dataset">shuffle_dataset</a>
                        </li>
                        <li>
                                <a class="function" href="#spacrDataset.get_plate">get_plate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#spacrDataLoader">spacrDataLoader</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#spacrDataLoader.__init__">spacrDataLoader</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataLoader.preload_batches">preload_batches</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataLoader.batch_queue">batch_queue</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataLoader.process">process</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataLoader.current_batch_index">current_batch_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#spacrDataLoader.pin_memory">pin_memory</a>
                        </li>
                        <li>
                                <a class="function" href="#spacrDataLoader.cleanup">cleanup</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TarImageDataset">TarImageDataset</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TarImageDataset.__init__">TarImageDataset</a>
                        </li>
                        <li>
                                <a class="variable" href="#TarImageDataset.tar_path">tar_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#TarImageDataset.transform">transform</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#load_images_from_paths">load_images_from_paths</a>
            </li>
            <li>
                    <a class="function" href="#concatenate_and_normalize">concatenate_and_normalize</a>
            </li>
            <li>
                    <a class="function" href="#delete_empty_subdirectories">delete_empty_subdirectories</a>
            </li>
            <li>
                    <a class="function" href="#preprocess_img_data">preprocess_img_data</a>
            </li>
            <li>
                    <a class="function" href="#read_plot_model_stats">read_plot_model_stats</a>
            </li>
            <li>
                    <a class="function" href="#convert_numpy_to_tiff">convert_numpy_to_tiff</a>
            </li>
            <li>
                    <a class="function" href="#generate_cellpose_train_test">generate_cellpose_train_test</a>
            </li>
            <li>
                    <a class="function" href="#parse_gz_files">parse_gz_files</a>
            </li>
            <li>
                    <a class="function" href="#generate_dataset">generate_dataset</a>
            </li>
            <li>
                    <a class="function" href="#generate_loaders">generate_loaders</a>
            </li>
            <li>
                    <a class="function" href="#generate_training_dataset">generate_training_dataset</a>
            </li>
            <li>
                    <a class="function" href="#training_dataset_from_annotation">training_dataset_from_annotation</a>
            </li>
            <li>
                    <a class="function" href="#training_dataset_from_annotation_metadata">training_dataset_from_annotation_metadata</a>
            </li>
            <li>
                    <a class="function" href="#generate_dataset_from_lists">generate_dataset_from_lists</a>
            </li>
            <li>
                    <a class="function" href="#convert_separate_files_to_yokogawa">convert_separate_files_to_yokogawa</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_yokogawa">convert_to_yokogawa</a>
            </li>
            <li>
                    <a class="function" href="#apply_augmentation">apply_augmentation</a>
            </li>
            <li>
                    <a class="function" href="#process_instruction">process_instruction</a>
            </li>
            <li>
                    <a class="function" href="#prepare_cellpose_dataset">prepare_cellpose_dataset</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../spacr.html">spacr</a><wbr>.io    </h1>

                
                        <input id="mod-io-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-io-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">tarfile</span><span class="o">,</span> <span class="nn">cellpose</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">queue</span><span class="o">,</span> <span class="nn">tifffile</span><span class="o">,</span> <span class="nn">czifile</span><span class="o">,</span> <span class="nn">atexit</span><span class="o">,</span> <span class="nn">datetime</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">img_as_uint</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">skimage.exposure</span> <span class="kn">import</span> <span class="n">rescale_intensity</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">skimage.measure</span> <span class="k">as</span> <span class="nn">measure</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">import</span> <span class="nn">imageio.v2</span> <span class="k">as</span> <span class="nn">imageio2</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Lock</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> 
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span> <span class="nn">nd2reader</span> <span class="kn">import</span> <span class="n">ND2Reader</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">import</span> <span class="nn">readlif</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="k">def</span> <span class="nf">process_non_tif_non_2D_images</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes all images in the folder and splits them into grayscale channels, preserving bit depth.&quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>    
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    <span class="c1"># Helper function to save grayscale images</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>    <span class="k">def</span> <span class="nf">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save grayscale images with appropriate suffix based on channel, z, and t, preserving bit depth.&quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_C</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_Z</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_T</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="c1"># Function to handle splitting of multi-dimensional images into grayscale channels</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="k">def</span> <span class="nf">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits the image into channels and handles 3D, 4D, and 5D image cases.&quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>            <span class="c1"># Grayscale image, already processed separately</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>            <span class="k">return</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>        
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>            <span class="c1"># 3D image: (height, width, channels)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>                <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>            <span class="c1"># 4D image: (height, width, channels, Z-dimension)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>                    <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>            <span class="c1"># 5D image: (height, width, channels, Z-dimension, Time)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>                        <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="c1"># Function to load images in various formats</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads image from various formats and returns it as a numpy array along with its dtype.&quot;&quot;&quot;</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">]:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.czi&#39;</span><span class="p">:</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>            <span class="k">with</span> <span class="n">czifile</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czi</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>            <span class="k">with</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">nd2</span><span class="p">:</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nd2</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="c1"># Function to check if an image is grayscale and save it as a TIFF if it isn&#39;t already</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>    <span class="k">def</span> <span class="nf">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert grayscale images that are not in TIFF format to TIFF, preserving bit depth.&quot;&quot;&quot;</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted grayscale image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to TIFF with bit depth </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>    <span class="c1"># Supported formats</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">]</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="c1"># Loop through all files in the folder</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>                <span class="c1"># Load the image and its dtype</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>                <span class="n">image</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>                
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>                <span class="c1"># If the image is grayscale (2D), convert it to TIFF if it&#39;s not already in TIFF format</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>                        <span class="n">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is already grayscale and in TIFF format, skipping.&quot;</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>                    <span class="k">continue</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>                
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>                <span class="c1"># Otherwise, split channels and save images</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>                <span class="n">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>            
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="k">def</span> <span class="nf">_load_images_and_labels</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>    
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">invert_image</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>    <span class="n">image_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">])</span> <span class="k">if</span> <span class="n">image_files</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>    <span class="n">label_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">])</span> <span class="k">if</span> <span class="n">label_files</span> <span class="k">else</span> <span class="p">[]</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>    <span class="k">if</span> <span class="n">image_files</span> <span class="ow">and</span> <span class="n">label_files</span><span class="p">:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="k">for</span> <span class="n">img_file</span><span class="p">,</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load image: </span><span class="si">{</span><span class="n">img_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>                <span class="k">continue</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load label: </span><span class="si">{</span><span class="n">lbl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>                <span class="k">continue</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>    <span class="k">elif</span> <span class="n">image_files</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="k">for</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load image: </span><span class="si">{</span><span class="n">img_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                <span class="k">continue</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>    <span class="k">elif</span> <span class="n">label_files</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="k">for</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>            <span class="n">label</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Could not load label: </span><span class="si">{</span><span class="n">lbl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                <span class="k">continue</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">image_files</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>    <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">label_files</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels from </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">label_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>    <span class="k">if</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image shape: </span><span class="si">{</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, image type: </span><span class="si">{</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">; &#39;</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>              <span class="sa">f</span><span class="s1">&#39;label shape: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, label type: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_names</span><span class="p">,</span> <span class="n">label_names</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="k">def</span> <span class="nf">_load_normalized_images_and_labels</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>                                       <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>                                       <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Signal_to_noise</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>    
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">normalize_and_visualize</span><span class="p">,</span> <span class="n">plot_resize</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">invert_image</span><span class="p">,</span> <span class="n">apply_mask</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>    <span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span> <span class="k">as</span> <span class="n">resizescikit</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>    <span class="c1"># Ensure percentiles are valid</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="n">percentiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="n">percentiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>    <span class="n">signal_thresholds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">Signal_to_noise</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>    <span class="n">lower_percentile</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">orig_dims</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="n">num_channels</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="n">percentiles_1</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)]</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>    <span class="n">percentiles_99</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>    <span class="n">image_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">]</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>    <span class="k">if</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">]</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="n">label_names</span><span class="p">,</span> <span class="n">label_dir</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>    <span class="c1"># Load, normalize, and resize images</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_files</span><span class="p">):</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="n">orig_dims</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="c1"># Select specific channels if needed</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="c1"># Calculate percentiles if not provided</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                <span class="n">percentiles_1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                <span class="c1"># Ensure `signal_thresholds` and `p` are floats for comparison</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>                <span class="k">for</span> <span class="n">percentile</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="mf">99.999</span><span class="p">]:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>                    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentile</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">signal_thresholds</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                        <span class="n">percentiles_99</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                        <span class="k">break</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="c1"># Resize image if required</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">and</span> <span class="n">target_width</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">resizescikit</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>    <span class="c1"># Calculate average percentiles if needed</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>    <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="n">avg_p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles_1</span><span class="p">]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="n">avg_p99</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="k">else</span> <span class="n">avg_p1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">percentiles_99</span><span class="p">)]</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average 1st percentiles: </span><span class="si">{</span><span class="n">avg_p1</span><span class="si">}</span><span class="s1">, Average 99th percentiles: </span><span class="si">{</span><span class="n">avg_p99</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="n">normalized_images</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">avg_p1</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">avg_p99</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>                      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="p">]</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">normalized_images</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> 
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>                                        <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                                                  <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> 
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                                        <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> 
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="p">]</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>    <span class="c1"># Load and resize labels if provided</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>    <span class="k">if</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">resizescikit</span><span class="p">(</span><span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">),</span> 
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                               <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_height</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="k">else</span> <span class="n">orig_dims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>                               <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_files</span><span class="p">)]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded and normalized </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels from </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">label_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>    <span class="k">if</span> <span class="n">visualize</span> <span class="ow">and</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="n">plot_resize</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">normalized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>    <span class="k">return</span> <span class="n">normalized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_names</span><span class="p">,</span> <span class="n">label_names</span><span class="p">,</span> <span class="n">orig_dims</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="k">class</span> <span class="nc">CombineLoaders</span><span class="p">:</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">    A class that combines multiple data loaders into a single iterator.</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">    Args:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">        train_loaders (list): A list of data loaders.</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">    Attributes:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">        train_loaders (list): A list of data loaders.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">        loader_iters (list): A list of iterator objects for each data loader.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">    Methods:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">        __iter__(): Returns the iterator object itself.</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">        __next__(): Returns the next batch from one of the data loaders.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">    Raises:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">        StopIteration: If all data loaders have been exhausted.</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loaders</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_loaders</span> <span class="o">=</span> <span class="n">train_loaders</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span> <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">train_loaders</span><span class="p">]</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">:</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">)</span>  <span class="c1"># Shuffle the loader_iters list</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loader_iter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">loader_iter</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                    <span class="k">continue</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                <span class="k">break</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="k">class</span> <span class="nc">CombinedDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">    A dataset that combines multiple datasets into one.</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">    Args:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">        datasets (list): A list of datasets to be combined.</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">        shuffle (bool, optional): Whether to shuffle the combined dataset. Defaults to True.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_length</span><span class="p">))</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">):</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="n">index</span> <span class="o">-=</span> <span class="n">length</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="k">class</span> <span class="nc">NoClassDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">    A custom dataset class for handling image data without class labels.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">    </span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">    Args:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        data_dir (str): The directory path where the image files are located.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        transform (callable, optional): A function/transform to apply to the image data. Default is None.</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        shuffle (bool, optional): Whether to shuffle the dataset. Default is True.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        load_to_memory (bool, optional): Whether to load all images into memory. Default is False.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">    </span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">    Attributes:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        data_dir (str): The directory path where the image files are located.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">        transform (callable): A function/transform to apply to the image data.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">        shuffle (bool): Whether to shuffle the dataset.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">        load_to_memory (bool): Whether to load all images into memory.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">        filenames (list): A list of file paths for the image files.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        images (list): A list of loaded images (if load_to_memory is True).</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>    
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>    <span class="c1">#@lru_cache(maxsize=None)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">        Load an image from the given file path.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">        </span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">        Args:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">            img_path (str): The file path of the image.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        </span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        Returns:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">            PIL.Image: The loaded image.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>    
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        Get the total number of images in the dataset.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">        </span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">        Returns:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">            int: The number of images in the dataset.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>    
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">        Shuffle the dataset.</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>    
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">        Get the image and its corresponding filename at the given index.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        </span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">        Args:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">            index (int): The index of the image in the dataset.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">        </span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">        Returns:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">            tuple: A tuple containing the image and its filename.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="c1"># Return both the image and its filename</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a><span class="k">class</span> <span class="nc">spacrDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">loader_classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">specific_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specific_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">loader_classes</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="k">if</span> <span class="n">specific_files</span> <span class="ow">and</span> <span class="n">specific_labels</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">specific_files</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">specific_labels</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="n">class_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="n">class_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_files</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_name</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_files</span><span class="p">))</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>            <span class="c1"># Use multiprocessing to load images in parallel</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># Handle image orientation</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combined</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="k">def</span> <span class="nf">get_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">filename</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="k">class</span> <span class="nc">spacrDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">preload_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span> <span class="o">=</span> <span class="n">preload_batches</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">preload_batches</span><span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin_memory&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>    <span class="k">def</span> <span class="nf">_preload_next_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">):</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>                    <span class="k">break</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>                <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            <span class="k">pass</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>    <span class="k">def</span> <span class="nf">_start_preloading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">())</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">()</span>  <span class="c1"># Directly load if pin_memory is True</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>    <span class="k">def</span> <span class="nf">_pin_memory_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>            <span class="k">return</span> <span class="n">batch</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="c1"># Start preloading the next batches</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="k">return</span> <span class="n">next_batch</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="k">class</span> <span class="nc">NoClassDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>    
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="k">class</span> <span class="nc">TarImageDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span> <span class="o">=</span> <span class="n">tar_path</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="c1"># Open the tar file just to build the list of members</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isfile</span><span class="p">()]</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>            
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>    
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a><span class="k">def</span> <span class="nf">load_images_from_paths</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">):</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="n">images_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>        <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                    <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading image from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>    
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>    <span class="k">return</span> <span class="n">images_dict</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="c1">#@log_function_call </span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="k">def</span> <span class="nf">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pick_slice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_mode</span><span class="o">=</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="n">metadata_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">img_format</span><span class="o">=</span><span class="s1">&#39;.tif&#39;</span><span class="p">):</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">    Convert z-stack images to maximum intensity projection (MIP) images.</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">    Args:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">        src (str): The source directory containing the z-stack images.</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">        regex (str): The regular expression pattern used to match the filenames of the z-stack images.</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        batch_size (int, optional): The number of images to process in each batch. Defaults to 100.</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        pick_slice (bool, optional): Whether to pick a specific slice based on the provided skip mode. Defaults to False.</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        skip_mode (str, optional): The skip mode used to filter out specific slices. Defaults to &#39;01&#39;.</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;&#39;.</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">    Returns:</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">        None</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>    
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img_format</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="n">img_format</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_format</span><span class="p">]</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>    
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_extract_filename_metadata</span><span class="p">,</span> <span class="n">print_progress</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>    
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>    <span class="n">regular_expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>    <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stack_path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>        <span class="n">all_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">img_format</span><span class="p">)]</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="n">all_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_filenames</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="c1">#Exclude hidden files</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>        <span class="n">image_paths_by_key</span> <span class="o">=</span> <span class="n">_extract_filename_metadata</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">regular_expression</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>        <span class="c1"># Convert dictionary keys to a list for batching</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>        <span class="n">batching_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All unique FOV: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="p">)</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>            <span class="c1"># Select batch keys and create a subset of the dictionary for this batch</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="n">batch_keys</span> <span class="o">=</span> <span class="n">batching_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="n">batch_images_by_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">image_paths_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_keys</span><span class="p">}</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="n">images_by_key</span> <span class="o">=</span> <span class="n">load_images_from_paths</span><span class="p">(</span><span class="n">batch_images_by_key</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="k">if</span> <span class="n">pick_slice</span><span class="p">:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">):</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                    <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                    <span class="n">max_intensity_slice</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                    <span class="n">mip_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">max_intensity_slice</span><span class="p">)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">.tif&#39;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                    <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                    <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                    <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                    <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>                    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Preprocessing filenames&#39;</span><span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                        <span class="n">mip_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                    <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                    <span class="n">mip_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mip</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">.tif&#39;</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                    <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                    <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                    <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                    <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Preprocessing filenames&#39;</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                        <span class="n">mip_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="n">images_by_key</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="c1"># Move original images to a new directory</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>            <span class="c1">#print(f&quot;{filename}: {os.path.splitext(filename)[1]}&quot;)</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">img_format</span><span class="p">:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                <span class="n">move</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="p">):</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">move</span><span class="p">)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>    <span class="k">return</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="k">def</span> <span class="nf">_merge_file</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">,</span> <span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">    Merge multiple channels into a single stack and save it as a numpy array, using os module for path handling.</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">    </span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">    Args:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">        chan_dirs (list): List of directories containing channel images.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        stack_dir (str): Directory to save the merged stack.</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        file_name (str): File name of the channel image.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">    Returns:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        None</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>    <span class="c1"># Construct new file path</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>    <span class="n">file_root</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>    <span class="n">new_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>    
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>    <span class="c1"># Check if the new file exists and create the stack directory if it doesn&#39;t</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_file</span><span class="p">):</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chan_dir</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">):</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chan_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to read image </span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                <span class="k">continue</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="n">chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="k">del</span> <span class="n">img</span>  <span class="c1"># Explicitly delete the reference to the image to free up memory</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Periodically suggest garbage collection</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="k">if</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid channels to merge for file </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="k">def</span> <span class="nf">_is_dir_empty</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">    Check if a directory is empty using os module.</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="k">def</span> <span class="nf">_generate_time_lists</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="sd">    Generate sorted lists of filenames grouped by plate, well, and field.</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="sd">    Args:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">        file_list (list): A list of filenames.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">    Returns:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">        list: A list of sorted file lists, where each file list contains filenames</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">              belonging to the same plate, well, and field, sorted by timepoint.</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="n">file_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="n">parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>                    <span class="n">timepoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                    <span class="k">continue</span>  <span class="c1"># Skip file on conversion error</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                <span class="n">file_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">timepoint</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                <span class="k">continue</span>  <span class="c1"># Skip file if not correctly formatted</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>    <span class="c1"># Sort each list by timepoint, but keep them grouped</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>    <span class="n">sorted_grouped_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>    <span class="c1"># Extract just the filenames from each group</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>    <span class="n">sorted_file_lists</span> <span class="o">=</span> <span class="p">[[</span><span class="n">filename</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sorted_grouped_filenames</span><span class="p">]</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>    <span class="k">return</span> <span class="n">sorted_file_lists</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="k">def</span> <span class="nf">_move_to_chan_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_safe_int_convert</span><span class="p">,</span> <span class="n">_convert_cq1_well_id</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>    
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="n">src_path</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>    <span class="n">src</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>    <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src</span> <span class="o">/</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> 
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                    <span class="k">try</span><span class="p">:</span>                  
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                            <span class="n">plateID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;plateID&#39;</span><span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                        <span class="k">except</span><span class="p">:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                            <span class="n">plateID</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                        <span class="n">wellID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;wellID&#39;</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                        <span class="n">fieldID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;fieldID&#39;</span><span class="p">)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                        <span class="n">chanID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;chanID&#39;</span><span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                        <span class="n">timeID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;timeID&#39;</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                        <span class="k">if</span> <span class="n">wellID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                            <span class="n">wellID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">wellID</span><span class="p">))</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                        <span class="k">if</span> <span class="n">fieldID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>                            <span class="n">fieldID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">fieldID</span><span class="p">))</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                        <span class="k">if</span> <span class="n">chanID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>                            <span class="n">chanID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">chanID</span><span class="p">))</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                        <span class="k">if</span> <span class="n">timeID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                            <span class="n">timeID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">timeID</span><span class="p">))</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                        <span class="k">if</span> <span class="n">metadata_type</span> <span class="o">==</span><span class="s1">&#39;cq1&#39;</span><span class="p">:</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                            <span class="n">orig_wellID</span> <span class="o">=</span> <span class="n">wellID</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                            <span class="n">wellID</span> <span class="o">=</span> <span class="n">_convert_cq1_well_id</span><span class="p">(</span><span class="n">wellID</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Converted Well ID: </span><span class="si">{</span><span class="n">orig_wellID</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">wellID</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                        <span class="n">newname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plateID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">wellID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fieldID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeID</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">timelapse</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                        <span class="n">newpath</span> <span class="o">=</span> <span class="n">src</span> <span class="o">/</span> <span class="n">chanID</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                        <span class="n">move</span> <span class="o">=</span> <span class="n">newpath</span> <span class="o">/</span> <span class="n">newname</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                        <span class="k">if</span> <span class="n">move</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                            <span class="n">newpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract information from filename </span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">regex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="c1"># Move original images to a new directory</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">)</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                <span class="n">move</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="p">):</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">move</span><span class="p">)</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>    <span class="k">return</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="k">def</span> <span class="nf">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">    Merge the channels in the given source directory and save the merged files in a &#39;stack&#39; directory without using multiprocessing.</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>    <span class="n">stack_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>    <span class="c1">#allowed_names = [&#39;01&#39;, &#39;02&#39;, &#39;03&#39;, &#39;04&#39;, &#39;00&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;0&#39;]</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>    
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>    <span class="n">string_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>    <span class="n">allowed_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">string_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>    
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>    <span class="c1"># List directories that match the allowed names</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>    <span class="n">chan_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">allowed_names</span><span class="p">]</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>    <span class="n">chan_dirs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>    
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>    <span class="n">num_matching_folders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;List of folders in src: </span><span class="si">{</span><span class="n">chan_dirs</span><span class="si">}</span><span class="s1">. Single channel folders.&#39;</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>    
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>    <span class="c1"># Assuming chan_dirs[0] is not empty and exists, adjust according to your logic</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>    <span class="n">first_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">chan_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>    <span class="n">dir_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">first_dir_path</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>    <span class="c1"># Create the &#39;stack&#39; directory if it doesn&#39;t exist</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">):</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated folder with merged arrays: </span><span class="si">{</span><span class="n">stack_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>    <span class="k">if</span> <span class="n">_is_dir_empty</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">):</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>        <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dir_files</span><span class="p">)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dir_files</span><span class="p">):</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="n">full_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">):</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>                <span class="n">_merge_file</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">chan_dirs</span><span class="p">],</span> <span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Merging channels into npy stacks&#39;</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">))</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>    <span class="k">return</span> <span class="n">num_matching_folders</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="k">def</span> <span class="nf">_mip_all</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">include_first_chan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="w">    </span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">    Generate maximum intensity projections (MIPs) for each NumPy array file in the specified directory.</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">    Args:</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        src (str): The directory path containing the NumPy array files.</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">        include_first_chan (bool, optional): Whether to include the first channel of the array in the MIP computation. </span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">                                                Defaults to True.</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">    Returns:</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">        None</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>    <span class="c1">#print(&#39;========== generating MIPs ==========&#39;)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>    <span class="c1"># Iterate over each file in the specified directory (src).</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="c1"># Check if the current file is a NumPy array file (with .npy extension).</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>            <span class="c1"># Load the array from the file.</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>            <span class="c1"># Normalize the array </span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>            <span class="c1">#array = normalize_to_dtype(array, q1=0, q2=99, percentiles=None)</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Check if the array is not 3-dimensional.</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>                <span class="c1"># Log a message indicating a zero array will be generated due to unexpected dimensions.</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating zero array for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> due to unexpected dimensions: </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>                <span class="c1"># Create a zero array with the same height and width as the original array, but with a single depth layer.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>                <span class="n">zeros_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>                <span class="c1"># Concatenate the original array with the zero array along the depth axis.</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>                <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">zeros_array</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                <span class="k">if</span> <span class="n">include_first_chan</span><span class="p">:</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                    <span class="c1"># Compute the MIP for the entire array along the third axis.</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                    <span class="c1"># Compute the MIP excluding the first layer of the array along the depth axis.</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>                <span class="c1"># Reshape the MIP to make it 3-dimensional.</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>                <span class="n">mip</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                <span class="c1"># Concatenate the MIP with the original array.</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">mip</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="c1"># save</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">concatenated</span><span class="p">)</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>    <span class="k">return</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="c1">#@log_function_call</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="k">def</span> <span class="nf">_concatenate_channel</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">    Concatenates channel data from multiple files and saves the concatenated data as numpy arrays.</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">    Args:</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">        src (str): The source directory containing the channel data files.</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        channels (list): The list of channel indices to be concatenated.</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">    Returns:</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        str: The directory path where the concatenated channel data is saved.</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>    <span class="n">channel_stack_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;channel_stack&#39;</span><span class="p">)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>    <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>                <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">time_stack_path_lists</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.npz&#39;</span><span class="p">)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>                <span class="k">del</span> <span class="n">stack</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Added this to name the output files</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>  <span class="c1"># store the filename</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimentions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">.npz&#39;</span><span class="p">)</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increment this after each batch is saved</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>                <span class="k">del</span> <span class="n">stack</span>  <span class="c1"># delete to free memory</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty the list for the next batch</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty the filenames list for the next batch</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and saved to:</span><span class="si">{</span><span class="n">channel_stack_loc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>    <span class="k">return</span> <span class="n">channel_stack_loc</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="k">def</span> <span class="nf">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>    
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">    Normalize the stack of images.</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">    Args:</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">        stack (numpy.ndarray): The stack of images to normalize.</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">        lower_percentile (int): Lower percentile value for normalization.</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        save_dtype (numpy.dtype): Data type for saving the normalized stack.</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        settings (dict): keword arguments</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">    Returns:</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">        numpy.ndarray: The normalized stack.</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>    <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>    
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>    <span class="c1">#for channel in range(stack.shape[-1]):</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">]:</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">]</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">]</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_nucleus&#39;</span><span class="p">]</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">]:</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">]</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">]</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_cell&#39;</span><span class="p">]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]:</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_pathogen&#39;</span><span class="p">]</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: background=</span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s1">, signal_threshold=</span><span class="si">{</span><span class="n">signal_threshold</span><span class="si">}</span><span class="s1">, remove_background=</span><span class="si">{</span><span class="n">remove_background</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="c1"># Step 3: Remove background if required</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>            <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="c1"># Step 4: Calculate global lower percentile for the channel</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="n">non_zero_single_channel</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>        <span class="n">global_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;lower_percentile&#39;</span><span class="p">])</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>        <span class="c1"># Step 5: Calculate global upper percentile for the channel</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>        <span class="n">global_upper</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>        <span class="k">for</span> <span class="n">upper_p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>            <span class="n">upper_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>            <span class="k">if</span> <span class="n">upper_value</span> <span class="o">&gt;=</span> <span class="n">signal_threshold</span><span class="p">:</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>                <span class="n">global_upper</span> <span class="o">=</span> <span class="n">upper_value</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>                <span class="k">break</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="k">if</span> <span class="n">global_upper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="n">global_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>  <span class="c1"># Fallback in case no upper percentile met the threshold</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: global_lower=</span><span class="si">{</span><span class="n">global_lower</span><span class="si">}</span><span class="s1">, global_upper=</span><span class="si">{</span><span class="n">global_upper</span><span class="si">}</span><span class="s1">, Signal-to-noise=</span><span class="si">{</span><span class="n">global_upper</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">global_lower</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>        <span class="c1"># Step 6: Normalize each array from global_lower to global_upper between 0 and 1</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>            <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="n">arr_2d_normalized</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">global_lower</span><span class="p">,</span> <span class="n">global_upper</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="n">normalized_stack</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_normalized</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>        <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>        <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normalizing&quot;</span><span class="p">)</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>    <span class="k">return</span> <span class="n">normalized_stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">save_dtype</span><span class="p">)</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="k">def</span> <span class="nf">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">    Concatenates and normalizes channel data from multiple files and saves the normalized data.</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">    Args:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">        src (str): The source directory containing the channel data files.</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">        channels (list): The list of channel indices to be concatenated and normalized.</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">        remove_backgrounds (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a><span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">    Returns:</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">        str: The directory path where the concatenated and normalized channel data is saved.</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">]:</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>                <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> 
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>                
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;randomize&#39;</span><span class="p">]:</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>        <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>                <span class="k">continue</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>            <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimensions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>                
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">_norm.npz&#39;</span><span class="p">)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and normalized. Saved to: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>    <span class="k">return</span> <span class="n">output_fldr</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="k">def</span> <span class="nf">_get_lists_for_normalization</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">    Get lists for normalization based on the provided settings.</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">    Args:</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="sd">        settings (dict): A dictionary containing the settings for normalization.</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="sd">    Returns:</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">        tuple: A tuple containing three lists - backgrounds, signal_to_noise, and signal_thresholds.</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="c1"># Initialize the lists</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="n">signal_to_noise</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>    <span class="n">signal_thresholds</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="n">remove_background</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>    <span class="c1"># Iterate through the channels and append the corresponding values if the channel is not None</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="c1"># for ch in settings[&#39;channels&#39;]:</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]:</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">]:</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">])</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">])</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">])</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_nucleus&#39;</span><span class="p">])</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">]:</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">])</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">])</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">])</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_cell&#39;</span><span class="p">])</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">])</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">])</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">])</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_pathogen&#39;</span><span class="p">])</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="k">return</span> <span class="n">backgrounds</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="p">,</span> <span class="n">signal_thresholds</span><span class="p">,</span> <span class="n">remove_background</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="k">def</span> <span class="nf">_normalize_stack</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">backgrounds</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">remove_backgrounds</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">signal_thresholds</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]):</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">    Normalize the stack of images.</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">    Args:</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">        src (str): The source directory containing the stack of images.</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">        remove_background (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">    Returns:</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">        None</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>            <span class="n">filenames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>        
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>        <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="k">for</span> <span class="n">chan_index</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="n">background</span> <span class="o">=</span> <span class="n">backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">signal_thresholds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">remove_backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>            <span class="n">signal_2_noise</span> <span class="o">=</span> <span class="n">signal_to_noise</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chan_index:</span><span class="si">{</span><span class="n">chan_index</span><span class="si">}</span><span class="s1"> background:</span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s1"> signal_threshold:</span><span class="si">{</span><span class="n">signal_threshold</span><span class="si">}</span><span class="s1"> remove_background:</span><span class="si">{</span><span class="n">remove_background</span><span class="si">}</span><span class="s1"> signal_2_noise:</span><span class="si">{</span><span class="n">signal_2_noise</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="c1"># Calculate the global lower and upper percentiles for non-zero pixels</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="n">non_zero_single_channel</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>            <span class="n">global_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">)</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="k">for</span> <span class="n">upper_p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>                <span class="n">global_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">)</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                <span class="k">if</span> <span class="n">global_upper</span> <span class="o">&gt;=</span> <span class="n">signal_threshold</span><span class="p">:</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                    <span class="k">break</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="c1"># Normalize the pixels in each image to the global percentiles and then dtype.</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">arr_2d_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">single_channel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">single_channel</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="n">signal_to_noise_ratio_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>                <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>                <span class="n">non_zero_arr_2d</span> <span class="o">=</span> <span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                <span class="k">if</span> <span class="n">non_zero_arr_2d</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_arr_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">lower_percentile</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">))</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>                    <span class="n">signal_to_noise_ratio</span> <span class="o">=</span> <span class="n">upper</span> <span class="o">/</span> <span class="n">lower</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>                    <span class="n">signal_to_noise_ratio</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>                <span class="n">signal_to_noise_ratio_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal_to_noise_ratio</span><span class="p">)</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>                <span class="n">average_stnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signal_to_noise_ratio_ls</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_to_noise_ratio_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>                <span class="k">if</span> <span class="n">signal_to_noise_ratio</span> <span class="o">&gt;</span> <span class="n">signal_2_noise</span><span class="p">:</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                    <span class="n">arr_2d_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>                    <span class="n">arr_2d_normalized</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr_2d_rescaled</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>                    <span class="n">arr_2d_normalized</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr_2d</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>                <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>                <span class="n">average_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time_ls</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels:</span><span class="si">{</span><span class="n">chan_index</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">, arrays:</span><span class="si">{</span><span class="n">array_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, Signal:</span><span class="si">{</span><span class="n">upper</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, noise:</span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Signal-to-noise:</span><span class="si">{</span><span class="n">average_stnr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Time/channel:</span><span class="si">{</span><span class="n">average_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">sec&#39;</span><span class="p">)</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>                <span class="c1">#stop = time.time()</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>                <span class="c1">#duration = stop - start</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>                <span class="c1">#time_ls.append(duration)</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>                <span class="c1">#files_processed = file_index + 1</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>                <span class="c1">#files_to_process = len(paths)</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>                <span class="c1">#print_progress(files_processed, files_to_process, n_jobs=1, time_ls=time_ls, batch_size=None, operation_type=&quot;Normalizing&quot;)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>                
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>            <span class="n">normalized_stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_normalized</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>        
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_stack.npz&#39;</span><span class="p">)</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">save_dtype</span><span class="p">),</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        <span class="k">del</span> <span class="n">normalized_stack</span><span class="p">,</span> <span class="n">single_channel</span><span class="p">,</span> <span class="n">arr_2d_normalized</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>    
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved stacks: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="k">def</span> <span class="nf">_normalize_timelapse</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">    Normalize the timelapse data by rescaling the intensity values based on percentiles.</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">    Args:</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">        src (str): The source directory containing the timelapse data files.</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">        lower_percentile (int, optional): The lower percentile used to calculate the intensity range. Defaults to 1.</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a><span class="sd">        save_dtype (numpy.dtype, optional): The data type to save the normalized stack. Defaults to np.float32.</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>            <span class="n">filenames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>        <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>        <span class="k">for</span> <span class="n">chan_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>            <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>            <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>            <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>                <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">]</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>                <span class="c1"># Calculate the 1% and 98% percentiles for this specific image</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>                <span class="n">q_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="p">)</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                <span class="n">q_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">98</span><span class="p">)</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>                <span class="c1"># Rescale intensity based on the calculated percentiles to fill the dtype range</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>                <span class="n">arr_2d_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">q_low</span><span class="p">,</span> <span class="n">q_high</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="s1">&#39;dtype&#39;</span><span class="p">)</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>                <span class="n">normalized_stack</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_rescaled</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels:</span><span class="si">{</span><span class="n">chan_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, arrays:</span><span class="si">{</span><span class="n">array_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>                <span class="c1">#stop = time.time()</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>                <span class="c1">#duration = stop - start</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>                <span class="c1">#time_ls.append(duration)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>                <span class="c1">#files_processed = file_index+1</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>                <span class="c1">#files_to_process = len(paths)</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>                <span class="c1">#print_progress(files_processed, files_to_process, n_jobs=1, time_ls=time_ls, batch_size=None, operation_type=&quot;Normalizing&quot;)</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="k">del</span> <span class="n">normalized_stack</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saved normalized stacks: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="k">def</span> <span class="nf">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">    Create movies from numpy files per channel.</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">    Args:</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">        src (str): The source directory containing the numpy files.</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">        fps (int, optional): Frames per second for the output movies. Defaults to 10.</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>    
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>    <span class="kn">from</span> <span class="nn">.timelapse</span> <span class="kn">import</span> <span class="n">_npz_to_movie</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>    
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>    <span class="n">master_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">master_path</span><span class="p">,</span><span class="s1">&#39;movies&#39;</span><span class="p">)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>    <span class="c1"># Organize files by plate, well, field</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>    <span class="n">organized_files</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)_(\w+)_(\w+)_(\d+)\.npy&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">organized_files</span><span class="p">:</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>                <span class="n">organized_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>            <span class="n">organized_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">organized_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>        <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="c1">#if array.dtype != np.uint8:</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="c1">#    array = ((array - array.min()) / (array.max() - array.min()) * 255).astype(np.uint8)</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arrays</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="c1"># Extract the current channel for all time points</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="n">channel_arrays</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>        <span class="c1"># Flatten the channel data to compute global percentiles</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        <span class="n">channel_data_flat</span> <span class="o">=</span> <span class="n">channel_arrays</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>        <span class="n">p1</span><span class="p">,</span> <span class="n">p99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_data_flat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="c1"># Normalize and rescale each array in the channel</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="n">normalized_channel_arrays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">arr</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p99</span> <span class="o">-</span> <span class="n">p1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">channel_arrays</span><span class="p">]</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="c1"># Convert the list of 2D arrays into a list of 3D arrays with a single channel</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>        <span class="n">normalized_channel_arrays_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">normalized_channel_arrays</span><span class="p">]</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>        <span class="c1"># Save as movie for the current channel</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>        <span class="n">channel_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">_channel_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.mp4&#39;</span><span class="p">)</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>        <span class="n">_npz_to_movie</span><span class="p">(</span><span class="n">normalized_channel_arrays_3d</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">channel_save_path</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="k">def</span> <span class="nf">delete_empty_subdirectories</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a><span class="sd">    Deletes all empty subdirectories in the specified folder.</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a><span class="sd">    Args:</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="sd">    - folder_path (str): The path to the folder in which to look for empty subdirectories.</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>    <span class="c1"># Check each item in the specified folder</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>        <span class="c1"># os.walk is used with topdown=False to start from the innermost directories and work upwards.</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>        <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>            <span class="c1"># Construct the full path to the subdirectory</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="n">full_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>            <span class="c1"># Try to remove the directory and catch any error (like if the directory is not empty)</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">full_dir_path</span><span class="p">)</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted empty directory: </span><span class="si">{</span><span class="n">full_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="k">continue</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                <span class="c1"># An error occurred, likely because the directory is not empty</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                <span class="c1">#print(f&quot;Skipping non-empty directory: {full_dir_path}&quot;)</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="c1">#@log_function_call</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a><span class="k">def</span> <span class="nf">preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>    
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_run_test_mode</span><span class="p">,</span> <span class="n">_get_regex</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_default_settings_preprocess_img_data</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a><span class="w">    </span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a><span class="sd">    Preprocesses image data by converting z-stack images to maximum intensity projection (MIP) images.</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a><span class="sd">    Args:</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a><span class="sd">        src (str): The source directory containing the z-stack images.</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a><span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;cellvoyager&#39;.</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a><span class="sd">        custom_regex (str, optional): The custom regular expression pattern used to match the filenames of the z-stack images. Defaults to None.</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a><span class="sd">        cmap (str, optional): The colormap used for plotting. Defaults to &#39;inferno&#39;.</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">        figuresize (int, optional): The size of the figure for plotting. Defaults to 15.</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a><span class="sd">        normalize (bool, optional): Whether to normalize the images. Defaults to False.</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a><span class="sd">        nr (int, optional): The number of images to preprocess. Defaults to 1.</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a><span class="sd">        plot (bool, optional): Whether to plot the images. Defaults to False.</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a><span class="sd">        mask_channels (list, optional): The channels to use for masking. Defaults to [0, 1, 2].</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a><span class="sd">        batch_size (list, optional): The number of images to process in each batch. Defaults to [100, 100, 100].</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="sd">        timelapse (bool, optional): Whether the images are from a timelapse experiment. Defaults to False.</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a><span class="sd">        remove_background (bool, optional): Whether to remove the background from the images. Defaults to False.</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a><span class="sd">        backgrounds (int, optional): The number of background images to use for background removal. Defaults to 100.</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a><span class="sd">        lower_percentile (float, optional): The lower percentile used for background removal. Defaults to 1.</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a><span class="sd">        save_dtype (type, optional): The data type used for saving the preprocessed images. Defaults to np.float32.</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a><span class="sd">        randomize (bool, optional): Whether to randomize the order of the images. Defaults to True.</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a><span class="sd">        all_to_mip (bool, optional): Whether to convert all images to MIP. Defaults to False.</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a><span class="sd">        pick_slice (bool, optional): Whether to pick a specific slice based on the provided skip mode. Defaults to False.</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a><span class="sd">        skip_mode (str, optional): The skip mode used to filter out specific slices. Defaults to &#39;01&#39;.</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a><span class="sd">        settings (dict, optional): Additional settings for preprocessing. Defaults to {}.</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a><span class="sd">    Returns:</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a><span class="sd">        None</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>    
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>    <span class="n">src</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">]</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>    <span class="n">extension_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>    <span class="n">most_common_extension</span> <span class="o">=</span> <span class="n">extension_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>    <span class="n">img_format</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>    
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>    <span class="n">delete_empty_subdirectories</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>    <span class="c1"># Check if the most common extension is one of the specified image formats</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>    <span class="k">if</span> <span class="n">most_common_extension</span> <span class="ow">in</span> <span class="n">valid_ext</span><span class="p">:</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="n">img_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="n">most_common_extension</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find any </span><span class="si">{</span><span class="n">valid_ext</span><span class="si">}</span><span class="s1"> files in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1"> only found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;stack&#39;</span><span class="p">)):</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing stack folder.&#39;</span><span class="p">)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;channel_stack&#39;</span><span class="p">)):</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing channel_stack folder.&#39;</span><span class="p">)</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)):</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing norm_channel_stack folder. Skipping preprocessing&#39;</span><span class="p">)</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>    <span class="n">mask_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>    <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]]</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>    
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>    <span class="n">settings</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">custom_regex</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">randomize</span><span class="p">,</span> <span class="n">all_to_mip</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">save_dtype</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">random_test</span> <span class="o">=</span> <span class="n">set_default_settings_preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>    
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>    <span class="n">regex</span> <span class="o">=</span> <span class="n">_get_regex</span><span class="p">(</span><span class="n">metadata_type</span><span class="p">,</span> <span class="n">img_format</span><span class="p">,</span> <span class="n">custom_regex</span><span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>    
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>    <span class="k">if</span> <span class="n">test_mode</span><span class="p">:</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running spacr in test mode&#39;</span><span class="p">)</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted test directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting test directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete manually before running test mode&quot;</span><span class="p">)</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>            <span class="k">pass</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        <span class="n">src</span> <span class="o">=</span> <span class="n">_run_test_mode</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">random_test</span><span class="p">)</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>    
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>    <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>   
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>                    <span class="n">_move_to_chan_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">)</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>                    <span class="n">img_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.lif&#39;</span><span class="p">]</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>                    <span class="n">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">img_format</span><span class="p">)</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>                    
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>                    <span class="c1">#Make sure no batches will be of only one image</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>                    <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                    <span class="n">full_batches</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">//</span> <span class="n">batch_size</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>                    <span class="n">last_batch_size</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">%</span> <span class="n">batch_size</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>                    
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                    <span class="c1"># Check if the last batch is of size 1</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>                    <span class="k">if</span> <span class="n">last_batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>                        <span class="c1"># If there&#39;s only one batch and its size is 1, it&#39;s also an issue</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>                        <span class="k">if</span> <span class="n">full_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>                        <span class="c1"># If the last batch is of size 1, merge it with the second last batch</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>                        <span class="k">elif</span> <span class="n">full_batches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;all images: </span><span class="si">{</span><span class="n">all_imgs</span><span class="si">}</span><span class="s2">,  full batch: </span><span class="si">{</span><span class="n">full_batches</span><span class="si">}</span><span class="s2">, last batch: </span><span class="si">{</span><span class="n">last_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Last batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>        
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>                <span class="n">nr_channel_folders</span> <span class="o">=</span> <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>                
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">nr_channel_folders</span><span class="p">:</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of channels does not match number of channel folders. channels: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> channel folders: </span><span class="si">{</span><span class="n">nr_channel_folders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>                    <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nr_channel_folders</span><span class="p">))</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing channels from </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>                    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_channels</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>                    <span class="n">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>                <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/stack&#39;</span><span class="p">)</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>                    <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>                <span class="k">if</span> <span class="n">all_to_mip</span><span class="p">:</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>                    <span class="n">_mip_all</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/stack&#39;</span><span class="p">)</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>                        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>    
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>    <span class="n">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">stack_path</span><span class="p">,</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>                              <span class="n">channels</span><span class="o">=</span><span class="n">mask_channels</span><span class="p">,</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>                              <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>                              <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>    <span class="c1">#if plot:</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>    <span class="c1">#    _plot_4D_arrays(src+&#39;/norm_channel_stack&#39;, nr_npz=1, nr=nr)</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>    
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="k">def</span> <span class="nf">_check_masks</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_filenames</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="sd">    Check the masks in a batch and filter out the ones that already exist in the output folder.</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="sd">    Args:</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">        batch (list): List of masks.</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">        batch_filenames (list): List of filenames corresponding to the masks.</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">        output_folder (str): Path to the output folder.</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="sd">    Returns:</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">        tuple: A tuple containing the filtered batch (numpy array) and the filtered filenames (list).</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>    <span class="c1"># Create a mask for filenames that are already present in the output folder</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>    <span class="n">existing_files_mask</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">batch_filenames</span><span class="p">]</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>    <span class="c1"># Use the mask to filter the batch and batch_filenames</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>    <span class="n">filtered_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">existing_files_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">exists</span><span class="p">]</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>    <span class="n">filtered_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_filenames</span><span class="p">,</span> <span class="n">existing_files_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">exists</span><span class="p">]</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_batch</span><span class="p">),</span> <span class="n">filtered_filenames</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a><span class="k">def</span> <span class="nf">_get_avg_object_size</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a><span class="sd">    Calculate the average size of objects in a list of masks.</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a><span class="sd">    masks (list): A list of masks representing objects.</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a><span class="sd">    Returns:</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a><span class="sd">    float: The average size of objects in the masks. Returns 0 if no objects are found.</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>    <span class="n">object_areas</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>        <span class="c1"># Check if the mask is a 2D or 3D array and is not empty</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>            <span class="n">properties</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>            <span class="n">object_areas</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask is empty. &quot;</span><span class="p">)</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask is not in the correct format. dim: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>            <span class="k">continue</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>    <span class="k">if</span> <span class="n">object_areas</span><span class="p">:</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">object_areas</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_areas</span><span class="p">)</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Return 0 if no objects are found</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>    
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a><span class="k">def</span> <span class="nf">_save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">all_folders</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a><span class="sd">    Save a figure to a specified location.</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a><span class="sd">    fig (matplotlib.figure.Figure): The figure to be saved.</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a><span class="sd">    src (str): The source file path.</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a><span class="sd">    text (str): The text to be included in the figure name.</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a><span class="sd">    dpi (int, optional): The resolution of the saved figure. Defaults to 300.</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>    <span class="n">save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>    <span class="n">obj_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_folder</span><span class="p">)</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>    <span class="n">save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">)</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>    <span class="n">fig_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s1">.pdf&#39;</span>        
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>    <span class="n">save_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">fig_name</span><span class="p">)</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_location</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>    <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>    <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">all_folders</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Saving Figures&quot;</span><span class="p">)</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved single cell figure: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>    <span class="k">del</span> <span class="n">fig</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>    
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a><span class="k">def</span> <span class="nf">_read_and_join_tables</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;png_list&#39;</span><span class="p">]):</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a><span class="sd">    Reads and joins tables from a SQLite database.</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a><span class="sd">    Args:</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a><span class="sd">        db_path (str): The path to the SQLite database file.</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a><span class="sd">        table_names (list, optional): The names of the tables to read and join. Defaults to [&#39;cell&#39;, &#39;cytoplasm&#39;, &#39;nucleus&#39;, &#39;pathogen&#39;, &#39;png_list&#39;].</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a><span class="sd">    Returns:</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a><span class="sd">        pandas.DataFrame: The joined DataFrame containing the data from the specified tables, or None if an error occurs.</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>    
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>    <span class="n">dataframes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>            <span class="n">dataframes</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> not found in the database.&quot;</span><span class="p">)</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>    <span class="k">if</span> <span class="s1">&#39;png_list&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">][[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;png_path&#39;</span><span class="p">,</span> <span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;rowID&#39;</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>        <span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>        <span class="n">png_list_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cell_id&#39;</span><span class="p">:</span> <span class="s1">&#39;object_label&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>        <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>            <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;rowID&#39;</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">,</span><span class="s1">&#39;fieldID&#39;</span><span class="p">]</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>            <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">png_list_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">join_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell table not found in database tables.&quot;</span><span class="p">)</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>            <span class="k">return</span> <span class="n">png_list_df</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]:</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>        <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>            <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>            <span class="n">non_numeric_cols</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>            <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">}</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>            <span class="n">agg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">non_numeric_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">]})</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>            <span class="n">grouping_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">]</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>            <span class="n">agg_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_cols</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>            <span class="n">agg_df</span><span class="p">[</span><span class="s1">&#39;count_&#39;</span> <span class="o">+</span> <span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_cols</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>            <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_df</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>    <span class="n">joined_df</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>    <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="n">joined_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>    <span class="k">if</span> <span class="s1">&#39;cytoplasm&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>        <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cytoplasm&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_cytoplasm&#39;</span><span class="p">))</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]:</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>        <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>            <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>    <span class="k">return</span> <span class="n">joined_df</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>    
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a><span class="k">def</span> <span class="nf">_save_settings_to_db</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a><span class="sd">    Save the settings dictionary to a SQLite database.</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a><span class="sd">    Args:</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a><span class="sd">        settings (dict): A dictionary containing the settings.</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="sd">    Returns:</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a><span class="sd">        None</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>    <span class="c1"># Convert the settings dictionary into a DataFrame</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>    <span class="n">settings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;setting_key&#39;</span><span class="p">,</span> <span class="s1">&#39;setting_value&#39;</span><span class="p">])</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>    <span class="c1"># Convert all values in the &#39;setting_value&#39; column to strings</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>    <span class="n">settings_df</span><span class="p">[</span><span class="s1">&#39;setting_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_df</span><span class="p">[</span><span class="s1">&#39;setting_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>    <span class="n">display</span><span class="p">(</span><span class="n">settings_df</span><span class="p">)</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>    <span class="c1"># Determine the directory path</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>    <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/measurements&#39;</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>    <span class="c1"># Create the directory if it doesn&#39;t exist</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>    <span class="c1"># Database connection and saving the settings DataFrame</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/measurements.db&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>    <span class="n">settings_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Replace the table if it already exists</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a><span class="k">def</span> <span class="nf">_save_mask_timelapse_as_gif</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">tracks_df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a><span class="sd">    Save a timelapse animation of masks as a GIF.</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a><span class="sd">    Parameters:</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a><span class="sd">    - masks (list): List of mask frames.</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a><span class="sd">    - tracks_df (pandas.DataFrame): DataFrame containing track information.</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a><span class="sd">    - path (str): Path to save the GIF file.</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a><span class="sd">    - cmap (str or matplotlib.colors.Colormap): Colormap for displaying the masks.</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a><span class="sd">    - norm (matplotlib.colors.Normalize): Normalization for the colormap.</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a><span class="sd">    - filenames (list): List of filenames corresponding to each mask frame.</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a><span class="sd">    Returns:</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a><span class="sd">    None</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>    <span class="c1"># Set the face color for the figure to black</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  <span class="c1"># Set the axes background color to black</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Turn off the axis</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Adjust the subplot edges</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>    <span class="n">filename_text_obj</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize a variable to keep track of the text object</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a><span class="sd">        Update the frame of the animation.</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a><span class="sd">        Parameters:</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a><span class="sd">        - frame (int): The frame number to update.</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a><span class="sd">        Returns:</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a><span class="sd">        None</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>        <span class="k">nonlocal</span> <span class="n">filename_text_obj</span>  <span class="c1"># Reference the nonlocal variable to update it</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>        <span class="k">if</span> <span class="n">filename_text_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>            <span class="n">filename_text_obj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># Remove the previous text object if it exists</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear the axis to draw the new frame</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Ensure axis is still off after clearing</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>        <span class="n">current_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">current_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame: </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>        <span class="c1"># Add the filename as text on the figure</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>        <span class="n">filename_text</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>  <span class="c1"># Get the filename corresponding to the current frame</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>        <span class="n">filename_text_obj</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">filename_text</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># Adjust text position, size, and color as needed</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>        <span class="c1"># Annotate each object with its label number from the mask</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>        <span class="k">for</span> <span class="n">label_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">current_mask</span><span class="p">):</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>            <span class="k">if</span> <span class="n">label_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># Skip background</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_mask</span> <span class="o">==</span> <span class="n">label_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_value</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>        <span class="c1"># Overlay tracks</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>        <span class="k">if</span> <span class="n">tracks_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>                <span class="n">_track</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="p">[</span><span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">]</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_track</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">_track</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>    <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">_update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">),</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>  <span class="c1"># Adjust DPI for size/quality</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved timelapse to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a><span class="k">def</span> <span class="nf">_save_object_counts_to_database</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">object_type</span><span class="p">,</span> <span class="n">file_names</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">added_string</span><span class="p">):</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="sd">    Save the counts of unique objects in masks to a SQLite database.</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">    Args:</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a><span class="sd">        arrays (List[np.ndarray]): List of masks.</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a><span class="sd">        object_type (str): Type of object.</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a><span class="sd">        file_names (List[str]): List of file names corresponding to the masks.</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a><span class="sd">        db_path (str): Path to the SQLite database.</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="sd">        added_string (str): Additional string to append to the count type.</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a><span class="sd">    Returns:</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="sd">        None</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>    <span class="k">def</span> <span class="nf">_count_objects</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Count unique objects in a mask, assuming 0 is the background.&quot;&quot;&quot;</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>        <span class="c1"># Assuming 0 is the background label, remove it from the count</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>        <span class="k">if</span> <span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>    <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">file_names</span><span class="p">):</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>        <span class="n">object_count</span> <span class="o">=</span> <span class="n">_count_objects</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>        <span class="n">count_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">object_type</span><span class="si">}{</span><span class="n">added_string</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>        <span class="c1"># Append a tuple of (file_name, count_type, object_count) to the records list</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_name</span><span class="p">,</span> <span class="n">count_type</span><span class="p">,</span> <span class="n">object_count</span><span class="p">))</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>    <span class="c1"># Connect to the database</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>    <span class="c1"># Create the table if it doesn&#39;t exist</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a><span class="s1">    CREATE TABLE IF NOT EXISTS object_counts (</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a><span class="s1">        file_name TEXT,</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a><span class="s1">        count_type TEXT,</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a><span class="s1">        object_count INTEGER,</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a><span class="s1">        PRIMARY KEY (file_name, count_type)</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a><span class="s1">    )</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a><span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>    <span class="c1"># Batch insert or update the object counts</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a><span class="s1">    INSERT INTO object_counts (file_name, count_type, object_count)</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a><span class="s1">    VALUES (?, ?, ?)</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a><span class="s1">    ON CONFLICT(file_name, count_type) DO UPDATE SET</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a><span class="s1">    object_count = excluded.object_count</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a><span class="s1">    &#39;&#39;&#39;</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>    <span class="c1"># Commit changes and close the database connection</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a><span class="k">def</span> <span class="nf">_create_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a><span class="sd">    Creates a SQLite database at the specified path.</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a><span class="sd">    Args:</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a><span class="sd">        db_path (str): The path where the database should be created.</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a><span class="sd">    Returns:</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a><span class="sd">        None</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>        <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>    
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a><span class="k">def</span> <span class="nf">_load_and_concatenate_arrays</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">cell_chann_dim</span><span class="p">,</span> <span class="n">nucleus_chann_dim</span><span class="p">,</span> <span class="n">pathogen_chann_dim</span><span class="p">):</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a><span class="sd">    Load and concatenate arrays from multiple folders.</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a><span class="sd">    Args:</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a><span class="sd">        src (str): The source directory containing the arrays.</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a><span class="sd">        channels (list): List of channel indices to select from the arrays.</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a><span class="sd">        cell_chann_dim (int): Dimension of the cell channel.</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a><span class="sd">        nucleus_chann_dim (int): Dimension of the nucleus channel.</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a><span class="sd">        pathogen_chann_dim (int): Dimension of the pathogen channel.</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="sd">    Returns:</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a><span class="sd">        None</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>    <span class="n">folder_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="s1">&#39;/stack&#39;</span><span class="p">)]</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>    <span class="k">if</span> <span class="n">cell_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_mask_stack&#39;</span><span class="p">)):</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span><span class="s1">&#39;cell_mask_stack&#39;</span><span class="p">)]</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>    <span class="k">if</span> <span class="n">nucleus_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus_mask_stack&#39;</span><span class="p">)):</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span><span class="s1">&#39;nucleus_mask_stack&#39;</span><span class="p">)]</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>    <span class="k">if</span> <span class="n">pathogen_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_mask_stack&#39;</span><span class="p">)):</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span><span class="s1">&#39;pathogen_mask_stack&#39;</span><span class="p">)]</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;/merged&#39;</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>    <span class="n">reference_folder</span> <span class="o">=</span> <span class="n">folder_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>    <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">))</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>    <span class="c1"># Iterate through each file in the reference folder</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">)):</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>            <span class="c1"># Check if this file exists in all the other specified folders</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>            <span class="n">exists_in_all_folders</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_paths</span><span class="p">)</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>            <span class="k">if</span> <span class="n">exists_in_all_folders</span><span class="p">:</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>                <span class="c1"># Load and potentially modify the array from the reference folder</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>                <span class="n">ref_array_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>                <span class="n">concatenated_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_array_path</span><span class="p">)</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>                <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>                    <span class="n">concatenated_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">concatenated_array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>                <span class="c1"># Add the array from the reference folder to &#39;stack_ls&#39;</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>                <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concatenated_array</span><span class="p">)</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>                <span class="c1"># For each of the other folders, load the array and add it to &#39;stack_ls&#39;</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>                    <span class="n">array_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>                    <span class="c1">#array = np.load(array_path)</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">array_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>                    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Add an extra dimension if the array is 2D</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>                    <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">]</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>                    <span class="c1">#max_dims = np.max(np.array(list(unique_shapes)), axis=0)</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>                    <span class="c1"># Determine the maximum length of tuples in unique_shapes</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>                    <span class="n">max_tuple_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">unique_shapes</span><span class="p">)</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>                    <span class="c1"># Pad shorter tuples with zeros to make them all the same length</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>                    <span class="n">padded_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_tuple_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">unique_shapes</span><span class="p">]</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>                    <span class="c1"># Now create a NumPy array and find the maximum dimensions</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded_shapes</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found. Padding arrays to max X,Y dimentions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>                    <span class="c1">#print(f&#39;Warning: arrays with multiple shapes found. Padding arrays to max X,Y dimentions {max_dims}&#39;, end=&#39;\r&#39;, flush=True)</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>                    <span class="c1"># Concatenate the padded arrays along the channel dimension (last dimension)</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>                <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">concatenated_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>        
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>        <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>        <span class="n">files_processed</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>        <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">all_imgs</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>        <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Merging Arrays&quot;</span><span class="p">)</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>    <span class="k">return</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>    
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a><span class="k">def</span> <span class="nf">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a><span class="sd">    Read data from a SQLite database.</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a><span class="sd">    Parameters:</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a><span class="sd">    - db_loc (str): The location of the SQLite database file.</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a><span class="sd">    - tables (list): A list of table names to read from.</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a><span class="sd">    Returns:</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a><span class="sd">    - dfs (list): A list of pandas DataFrames, each containing the data from a table.</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span><span class="p">,</span> <span class="n">correct_metadata</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>    
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>    
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">correct_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>    <span class="k">return</span> <span class="n">dfs</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>    
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a><span class="k">def</span> <span class="nf">_results_to_csv</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_well</span><span class="p">):</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a><span class="sd">    Save the given dataframes as CSV files in the specified directory.</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a><span class="sd">    Args:</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a><span class="sd">        src (str): The directory path where the CSV files will be saved.</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a><span class="sd">        df (pandas.DataFrame): The dataframe containing cell data.</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a><span class="sd">        df_well (pandas.DataFrame): The dataframe containing well data.</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a><span class="sd">    Returns:</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a><span class="sd">        tuple: A tuple containing the cell dataframe and well dataframe.</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>    <span class="n">cells</span> <span class="o">=</span> <span class="n">df</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>    <span class="n">wells</span> <span class="o">=</span> <span class="n">df_well</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>    <span class="n">results_loc</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;/results&#39;</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>    <span class="n">wells_loc</span> <span class="o">=</span> <span class="n">results_loc</span><span class="o">+</span><span class="s1">&#39;/wells.csv&#39;</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>    <span class="n">cells_loc</span> <span class="o">=</span> <span class="n">results_loc</span><span class="o">+</span><span class="s1">&#39;/cells.csv&#39;</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_loc</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>    <span class="n">wells</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">wells_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>    <span class="n">cells</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">cells_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>    <span class="k">return</span> <span class="n">cells</span><span class="p">,</span> <span class="n">wells</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a><span class="k">def</span> <span class="nf">read_plot_model_stats</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">val_file_path</span> <span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>    
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>    <span class="k">def</span> <span class="nf">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>        <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>        <span class="c1"># Create subplots</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>        <span class="c1"># Plotting</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">val_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>        <span class="c1"># Set titles and labels</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>    <span class="c1"># Read the CSVs into DataFrames</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>    <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">val_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>    <span class="c1"># Get the folder path for saving plots</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>    <span class="n">fldr_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">)</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>    
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>        <span class="c1"># Setting the style</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>    
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>    <span class="c1"># Plot and save the results</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;prauc&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>    
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a><span class="k">def</span> <span class="nf">_save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">results_df</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">intermedeate_save</span><span class="o">=</span><span class="p">[</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.98</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.94</span><span class="p">],</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]):</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a><span class="sd">    Save the model based on certain conditions during training.</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a><span class="sd">    Args:</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a><span class="sd">        model (torch.nn.Module): The trained model to be saved.</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a><span class="sd">        model_type (str): The type of the model.</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a><span class="sd">        results_df (pandas.DataFrame): The dataframe containing the training results.</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a><span class="sd">        dst (str): The destination directory to save the model.</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a><span class="sd">        epoch (int): The current epoch number.</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a><span class="sd">        epochs (int): The total number of epochs.</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a><span class="sd">        intermedeate_save (list, optional): List of accuracy thresholds to trigger intermediate model saves. </span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a><span class="sd">                                            Defaults to [0.99, 0.98, 0.95, 0.94].</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a><span class="sd">        channels (list, optional): List of channels used. Defaults to [&#39;r&#39;, &#39;g&#39;, &#39;b&#39;].</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>    <span class="n">channels_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>    
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>    <span class="k">def</span> <span class="nf">save_model_at_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>        <span class="n">percentile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found: </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s1">% accurate model&#39;</span><span class="p">)</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">_acc_</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s1">_channels_</span><span class="si">{</span><span class="n">channels_str</span><span class="si">}</span><span class="s1">.pth&#39;</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>        <span class="k">return</span> <span class="n">model_path</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">epochs</span><span class="p">:</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">}</span><span class="s1">_channels_</span><span class="si">{</span><span class="n">channels_str</span><span class="si">}</span><span class="s1">.pth&#39;</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>        <span class="k">return</span> <span class="n">model_path</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>    <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">intermedeate_save</span><span class="p">:</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>        <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nc class accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Pc class Accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>            <span class="n">model_path</span> <span class="o">=</span> <span class="n">save_model_at_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>            <span class="k">break</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>            <span class="n">model_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>    
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>    <span class="k">return</span> <span class="n">model_path</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a><span class="k">def</span> <span class="nf">_save_progress</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">):</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a><span class="sd">    Save the progress of the classification model.</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a><span class="sd">    Parameters:</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a><span class="sd">    dst (str): The destination directory to save the progress.</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a><span class="sd">    train_df (pandas.DataFrame): The DataFrame containing training stats.</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a><span class="sd">    validation_df (pandas.DataFrame): The DataFrame containing validation stats (if available).</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a><span class="sd">    Returns:</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a><span class="sd">    None</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>    <span class="k">def</span> <span class="nf">_save_df_to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a><span class="sd">        Save the given DataFrame to the specified CSV file, either creating a new file or appending to an existing one.</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a><span class="sd">        Parameters:</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a><span class="sd">        file_path (str): The file path where the CSV will be saved.</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a><span class="sd">        df (pandas.DataFrame): The DataFrame to save.</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># Ensure data is written to the file system</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>                
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>    <span class="c1"># Save accuracy, loss, PRAUC</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>    <span class="n">results_path_train</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>    <span class="n">results_path_validation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;validation.csv&#39;</span><span class="p">)</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>    <span class="c1"># Save training data</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>    <span class="n">_save_df_to_csv</span><span class="p">(</span><span class="n">results_path_train</span><span class="p">,</span> <span class="n">train_df</span><span class="p">)</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>    <span class="c1"># Save validation data if available</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>    <span class="k">if</span> <span class="n">validation_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>        <span class="n">_save_df_to_csv</span><span class="p">(</span><span class="n">results_path_validation</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">)</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>        <span class="c1"># Call read_plot_model_stats after ensuring the files are saved</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>        <span class="n">read_plot_model_stats</span><span class="p">(</span><span class="n">results_path_train</span><span class="p">,</span> <span class="n">results_path_validation</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>    <span class="k">return</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>    
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a><span class="k">def</span> <span class="nf">_copy_missclassified</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>    <span class="n">misclassified</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;true_label&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;predicted_label&#39;</span><span class="p">]]</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">misclassified</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>        <span class="n">original_path</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>        <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">original_path</span><span class="p">))</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>        <span class="k">if</span> <span class="s2">&quot;pc&quot;</span> <span class="ow">in</span> <span class="n">original_path</span><span class="p">:</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>            <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s2">&quot;missclassified/pc&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>            <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s2">&quot;missclassified/nc&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">new_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">misclassified</span><span class="p">)</span><span class="si">}</span><span class="s2"> misclassified images.&quot;</span><span class="p">)</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>    <span class="k">return</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>    
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a><span class="k">def</span> <span class="nf">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>    
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span><span class="p">,</span> <span class="n">correct_metadata</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>    
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span> <span class="c1"># Create a connection to the database</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Write a SQL query to get the data from the database</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span> <span class="c1"># Use the read_sql_query function to get the data and save it as a DataFrame</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">correct_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the connection</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>    <span class="k">return</span> <span class="n">dfs</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a><span class="k">def</span> <span class="nf">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nuclei_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pathogen_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">change_plate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_split_data</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>    <span class="c1"># Initialize an empty dictionary to store DataFrames by table name</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">table</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">}</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>    <span class="c1"># Extract plate DataFrames</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">locs</span><span class="p">):</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="n">db_dfs</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>        <span class="k">if</span> <span class="n">change_plate</span><span class="p">:</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>            <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;plate</span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>            <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;columnID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">db_dfs</span><span class="p">):</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>            <span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>    <span class="c1"># Concatenate rows across locations for each table</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">dfs</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>        <span class="k">if</span> <span class="n">dfs</span><span class="p">:</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>            <span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>            
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>    <span class="c1"># Initialize merged DataFrame with &#39;cells&#39; if available</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>    <span class="c1"># Process each table</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>    <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>        <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        <span class="n">cells_g_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">cells_g_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="si">}</span><span class="s1">, cells grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>    <span class="k">if</span> <span class="s1">&#39;cytoplasm&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;cytoplasm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">cytoplasms</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">cytoplasms</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>        
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>            
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">)</span><span class="si">}</span><span class="s1">, cytoplasms grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>            
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>            <span class="n">cytoplasms_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cytoplasms_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>            
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cytoplasms: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">)</span><span class="si">}</span><span class="s1">, cytoplasms grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>        <span class="n">nucleus</span><span class="p">[</span><span class="s1">&#39;nucleus_prcfo_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">)[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">nuclei_limit</span><span class="p">:</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>            <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="p">[</span><span class="n">nucleus</span><span class="p">[</span><span class="s1">&#39;nucleus_prcfo_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>            
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>            
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus</span><span class="p">)</span><span class="si">}</span><span class="s1">, nucleus grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>            
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>            <span class="n">nucleus_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">nucleus_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>            
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus</span><span class="p">)</span><span class="si">}</span><span class="s1">, nucleus grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>        <span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">)[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pathogen_limit</span><span class="p">:</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>            <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="p">[</span><span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>            <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="p">[</span><span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">)]</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">]):</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">pathogens</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>            
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogens: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens</span><span class="p">)</span><span class="si">}</span><span class="s1">, pathogens grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>            
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>            <span class="n">pathogens_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">pathogens</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pathogens_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>        
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogens: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens</span><span class="p">)</span><span class="si">}</span><span class="s1">, pathogens grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>            
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>    <span class="k">if</span> <span class="s1">&#39;png_list&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>        <span class="n">png_list</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>        <span class="n">png_list_g_df_numeric</span><span class="p">,</span> <span class="n">png_list_g_df_non_numeric</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">png_list</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>        <span class="n">png_list_g_df_non_numeric</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">,</span><span class="s1">&#39;rowID&#39;</span><span class="p">,</span><span class="s1">&#39;columnID&#39;</span><span class="p">,</span><span class="s1">&#39;fieldID&#39;</span><span class="p">,</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;png_list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">png_list</span><span class="p">)</span><span class="si">}</span><span class="s1">, png_list grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">png_list_g_df_numeric</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added png_list columns: </span><span class="si">{</span><span class="n">png_list_g_df_numeric</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">png_list_g_df_non_numeric</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">png_list_g_df_numeric</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">png_list_g_df_non_numeric</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>    
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>    <span class="c1"># Add prc (plate row column) and prcfo (plate row column field object) columns</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;columnID&#39;</span><span class="p">])</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>    <span class="n">cells_well</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cells_per_well&#39;</span><span class="p">)</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cells_well</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">)</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;plateID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;rowID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;columnID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;fieldID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>    <span class="n">metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>    
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>    <span class="c1"># Merge metadata with final merged DataFrame</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>    <span class="c1">#merged_df = metadata.merge(merged_df, left_index=True, right_index=True).dropna(axis=1)</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>    <span class="n">merged_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label_list_morphology&#39;</span><span class="p">,</span> <span class="s1">&#39;label_list_intensity&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>    
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated dataframe with: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1"> columns and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> rows&#39;</span><span class="p">)</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>    
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>    <span class="c1"># Prepare object DataFrames for output</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>    <span class="n">obj_df_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">]</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>    
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>    <span class="k">return</span> <span class="n">merged_df</span><span class="p">,</span> <span class="n">obj_df_ls</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>    
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a><span class="k">def</span> <span class="nf">_read_mask</span><span class="p">(</span><span class="n">mask_path</span><span class="p">):</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">imageio2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">img_as_uint</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>    <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a><span class="k">def</span> <span class="nf">convert_numpy_to_tiff</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a><span class="sd">    Converts all numpy files in a folder to TIFF format and saves them in a subdirectory &#39;tiff&#39;.</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a><span class="sd">    </span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a><span class="sd">    Args:</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a><span class="sd">    folder_path (str): The path to the folder containing numpy files.</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>    <span class="c1"># Create the subdirectory &#39;tiff&#39; within the specified folder if it doesn&#39;t already exist</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>    <span class="n">tiff_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">)</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a>    <span class="n">npy_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>    
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>    <span class="c1"># Iterate over all files in the folder</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>            <span class="k">break</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>            <span class="k">continue</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>        <span class="c1"># Construct the full file path</span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>        <span class="c1"># Load the numpy file</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>        
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>        <span class="c1"># Construct the output TIFF file path</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>        <span class="n">tiff_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a>        <span class="n">tiff_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">tiff_filename</span><span class="p">)</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>        
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>        <span class="c1"># Save the numpy array as a TIFF file</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tiff_file_path</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">)</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>        
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">tiff_filename</span><span class="si">}</span><span class="s2"> and saved in &#39;tiff&#39; subdirectory.&quot;</span><span class="p">)</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>    <span class="k">return</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>    
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a><span class="k">def</span> <span class="nf">generate_cellpose_train_test</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>    <span class="n">mask_src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;*.tif&#39;</span><span class="p">))</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">]</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_filenames</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">file</span><span class="p">))]</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> images with masks&#39;</span><span class="p">)</span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>    
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>    <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_split</span><span class="p">)</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>    <span class="n">train_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>    <span class="n">test_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>    <span class="n">list_of_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_files</span><span class="p">,</span> <span class="n">train_files</span><span class="p">]</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Split dataset into Train </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> and Test </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>    
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>    <span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>    <span class="n">train_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>    <span class="n">test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>    <span class="n">test_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>    
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>    
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_lists</span><span class="p">):</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">test_dir</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">test_dir_masks</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">train_dir</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">train_dir_masks</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>            
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>            <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>            <span class="n">new_img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>            <span class="n">new_mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_mask</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>            
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">new_img_path</span><span class="p">)</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">new_mask_path</span><span class="p">)</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copied </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images to </span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s1"> set&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a><span class="k">def</span> <span class="nf">parse_gz_files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a><span class="sd">    Parses the .fastq.gz files in the specified folder path and returns a dictionary</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a><span class="sd">    containing the sample names and their corresponding file paths.</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a><span class="sd">    Args:</span>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a><span class="sd">        folder_path (str): The path to the folder containing the .fastq.gz files.</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a><span class="sd">    Returns:</span>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a><span class="sd">        dict: A dictionary where the keys are the sample names and the values are</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a><span class="sd">        dictionaries containing the file paths for the &#39;R1&#39; and &#39;R2&#39; read directions.</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>    <span class="n">gz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fastq.gz&#39;</span><span class="p">)]</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>    <span class="n">samples_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>    <span class="k">for</span> <span class="n">gz_file</span> <span class="ow">in</span> <span class="n">gz_files</span><span class="p">:</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">gz_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>        <span class="n">sample_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>        <span class="n">read_direction</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">samples_dict</span><span class="p">:</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>        <span class="k">if</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R1&quot;</span><span class="p">:</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>        <span class="k">elif</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>    <span class="k">return</span> <span class="n">samples_dict</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a><span class="k">def</span> <span class="nf">generate_dataset</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>    
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">initiate_counter</span><span class="p">,</span> <span class="n">add_images_to_tar</span><span class="p">,</span> <span class="n">save_settings</span><span class="p">,</span> <span class="n">generate_path_list_from_db</span><span class="p">,</span> <span class="n">correct_paths</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_dataset_defaults</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;generate_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>        <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>            <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">)</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>            <span class="n">paths</span> <span class="o">=</span> <span class="n">generate_path_list_from_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">file_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">])</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>            <span class="n">correct_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>            <span class="n">all_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a>            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a>            <span class="n">sample</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">all_paths</span>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All paths: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>    <span class="n">total_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>    <span class="c1"># Create a temp folder in dst</span>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a>    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;temp_tars&quot;</span><span class="p">)</span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>    <span class="c1"># Chunking the data</span>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>    <span class="n">num_procs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_procs</span>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a>    <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_procs</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>    <span class="n">paths_chunks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">):</span>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>        <span class="n">paths_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>    <span class="n">temp_tar_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.tar&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)]</span>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating temporary tar files in </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a>    <span class="c1"># Initialize shared counter and lock</span>
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>    <span class="n">counter</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a>    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a>    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initiate_counter</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">lock</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a>        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">add_images_to_tar</span><span class="p">,</span> <span class="p">[(</span><span class="n">paths_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp_tar_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">total_images</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)])</span>
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a>    <span class="c1"># Combine the temporary tar files into a final tar</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a>    <span class="n">date_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a>        <span class="n">date_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_combined&quot;</span>
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a>    <span class="c1">#if not settings[&#39;file_metadata&#39;] is None:</span>
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a>    <span class="c1">#    tar_name = f&quot;{date_name}_{settings[&#39;experiment&#39;]}_{settings[&#39;file_metadata&#39;]}.tar&quot;</span>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a>    <span class="c1">#else:</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a>    <span class="n">tar_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.tar&quot;</span>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a>    <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name</span><span class="p">)</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tar_name</span><span class="p">):</span>
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a>        <span class="n">number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a>        <span class="n">tar_name_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2">.tar&quot;</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> exists, saving as </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name_2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>        <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name_2</span><span class="p">)</span>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging temporary files&quot;</span><span class="p">)</span>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a>    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">final_tar</span><span class="p">:</span>
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a>        <span class="k">for</span> <span class="n">temp_tar_path</span> <span class="ow">in</span> <span class="n">temp_tar_files</span><span class="p">:</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_tar</span><span class="p">:</span>
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>                    <span class="n">final_tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">)</span>
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>    <span class="c1"># Delete the temp folder</span>
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images to </span><span class="si">{</span><span class="n">tar_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>    <span class="k">return</span> <span class="n">tar_name</span>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a><span class="k">def</span> <span class="nf">generate_loaders</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span><span class="s1">&#39;pc&#39;</span><span class="p">],</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a><span class="w">    </span>
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a><span class="sd">    Generate data loaders for training and validation/test datasets.</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a><span class="sd">    Parameters:</span>
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a><span class="sd">    - src (str): The source directory containing the data.</span>
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a><span class="sd">    - mode (str): The mode of operation. Options are &#39;train&#39; or &#39;test&#39;.</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a><span class="sd">    - image_size (int): The size of the input images.</span>
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a><span class="sd">    - batch_size (int): The batch size for the data loaders.</span>
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a><span class="sd">    - classes (list): The list of classes to consider.</span>
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a><span class="sd">    - n_jobs (int): The number of worker threads for data loading.</span>
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a><span class="sd">    - validation_split (float): The fraction of data to use for validation.</span>
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a><span class="sd">    - pin_memory (bool): Whether to pin memory for faster data transfer.</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a><span class="sd">    - normalize (bool): Whether to normalize the input images.</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a><span class="sd">    - verbose (bool): Whether to print additional information and show images.</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a><span class="sd">    - channels (list): The list of channels to retain. Options are [1, 2, 3] for all channels, [1, 2] for blue and green, etc.</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a><span class="sd">    Returns:</span>
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a><span class="sd">    - train_loaders (list): List of data loaders for training datasets.</span>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a><span class="sd">    - val_loaders (list): List of data loaders for validation datasets.</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">SelectChannels</span><span class="p">,</span> <span class="n">augment_dataset</span>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a>    <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a>    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a>        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a>    <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a>        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a>    <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a>        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a>
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a>    <span class="n">channels</span> <span class="o">=</span> <span class="n">chans</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training a network on channels: </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel 1: Red, Channel 2: Green, Channel 3: Blue&#39;</span><span class="p">)</span>
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a>        
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a>    <span class="n">train_loaders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a>    <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a>    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a>        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a>            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a>        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a>            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)])</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a>        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a>        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading Train and validation datasets&#39;</span><span class="p">)</span>
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a>        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a>        <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a>        <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a>        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading test dataset&#39;</span><span class="p">)</span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not valid, use mode = train or test&#39;</span><span class="p">)</span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a>        <span class="k">return</span>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a>    
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a>    <span class="n">class_1_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a>    <span class="n">class_2_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_1_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_2_path</span><span class="p">):</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One or more classes not found in </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a>        <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Possible class names are </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">spacrDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">)</span>
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a>    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a>    
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a>    <span class="k">if</span> <span class="n">validation_split</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a>        <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">validation_split</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a>        <span class="n">val_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">augment</span><span class="p">:</span>
</span><span id="L-2730"><a href="#L-2730"><span class="linenos">2730</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data:</span><span class="si">{</span><span class="n">train_size</span><span class="si">}</span><span class="s1">, Validation data:</span><span class="si">{</span><span class="n">val_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2731"><a href="#L-2731"><span class="linenos">2731</span></a>        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">val_size</span><span class="p">])</span>
</span><span id="L-2732"><a href="#L-2732"><span class="linenos">2732</span></a>
</span><span id="L-2733"><a href="#L-2733"><span class="linenos">2733</span></a>        <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
</span><span id="L-2734"><a href="#L-2734"><span class="linenos">2734</span></a>
</span><span id="L-2735"><a href="#L-2735"><span class="linenos">2735</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data before augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">, Validataion:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2736"><a href="#L-2736"><span class="linenos">2736</span></a>            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">augment_dataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">is_grayscale</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-2737"><a href="#L-2737"><span class="linenos">2737</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data after augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2738"><a href="#L-2738"><span class="linenos">2738</span></a>            
</span><span id="L-2739"><a href="#L-2739"><span class="linenos">2739</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating Dataloader with </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s1"> workers&#39;</span><span class="p">)</span>
</span><span id="L-2740"><a href="#L-2740"><span class="linenos">2740</span></a>        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2741"><a href="#L-2741"><span class="linenos">2741</span></a>        <span class="n">val_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2742"><a href="#L-2742"><span class="linenos">2742</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2743"><a href="#L-2743"><span class="linenos">2743</span></a>        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2744"><a href="#L-2744"><span class="linenos">2744</span></a>
</span><span id="L-2745"><a href="#L-2745"><span class="linenos">2745</span></a>    <span class="c1">#dataset (Dataset)  dataset from which to load the data.</span>
</span><span id="L-2746"><a href="#L-2746"><span class="linenos">2746</span></a>    <span class="c1">#batch_size (int, optional)  how many samples per batch to load (default: 1).</span>
</span><span id="L-2747"><a href="#L-2747"><span class="linenos">2747</span></a>    <span class="c1">#shuffle (bool, optional)  set to True to have the data reshuffled at every epoch (default: False).</span>
</span><span id="L-2748"><a href="#L-2748"><span class="linenos">2748</span></a>    <span class="c1">#sampler (Sampler or Iterable, optional)  defines the strategy to draw samples from the dataset. Can be any Iterable with __len__ implemented. If specified, shuffle must not be specified.</span>
</span><span id="L-2749"><a href="#L-2749"><span class="linenos">2749</span></a>    <span class="c1">#batch_sampler (Sampler or Iterable, optional)  like sampler, but returns a batch of indices at a time. Mutually exclusive with batch_size, shuffle, sampler, and drop_last.</span>
</span><span id="L-2750"><a href="#L-2750"><span class="linenos">2750</span></a>    <span class="c1">#num_workers (int, optional)  how many subprocesses to use for data loading. 0 means that the data will be loaded in the main process. (default: 0)</span>
</span><span id="L-2751"><a href="#L-2751"><span class="linenos">2751</span></a>    <span class="c1">#collate_fn (Callable, optional)  merges a list of samples to form a mini-batch of Tensor(s). Used when using batched loading from a map-style dataset.</span>
</span><span id="L-2752"><a href="#L-2752"><span class="linenos">2752</span></a>    <span class="c1">#pin_memory (bool, optional)  If True, the data loader will copy Tensors into device/CUDA pinned memory before returning them. If your data elements are a custom type, or your collate_fn returns a batch that is a custom type, see the example below.</span>
</span><span id="L-2753"><a href="#L-2753"><span class="linenos">2753</span></a>    <span class="c1">#drop_last (bool, optional)  set to True to drop the last incomplete batch, if the dataset size is not divisible by the batch size. If False and the size of dataset is not divisible by the batch size, then the last batch will be smaller. (default: False)</span>
</span><span id="L-2754"><a href="#L-2754"><span class="linenos">2754</span></a>    <span class="c1">#timeout (numeric, optional)  if positive, the timeout value for collecting a batch from workers. Should always be non-negative. (default: 0)</span>
</span><span id="L-2755"><a href="#L-2755"><span class="linenos">2755</span></a>    <span class="c1">#worker_init_fn (Callable, optional)  If not None, this will be called on each worker subprocess with the worker id (an int in [0, num_workers - 1]) as input, after seeding and before data loading. (default: None)</span>
</span><span id="L-2756"><a href="#L-2756"><span class="linenos">2756</span></a>    <span class="c1">#multiprocessing_context (str or multiprocessing.context.BaseContext, optional)  If None, the default multiprocessing context of your operating system will be used. (default: None)</span>
</span><span id="L-2757"><a href="#L-2757"><span class="linenos">2757</span></a>    <span class="c1">#generator (torch.Generator, optional)  If not None, this RNG will be used by RandomSampler to generate random indexes and multiprocessing to generate base_seed for workers. (default: None)</span>
</span><span id="L-2758"><a href="#L-2758"><span class="linenos">2758</span></a>    <span class="c1">#prefetch_factor (int, optional, keyword-only arg)  Number of batches loaded in advance by each worker. 2 means there will be a total of 2 * num_workers batches prefetched across all workers. (default value depends on the set value for num_workers. If value of num_workers=0 default is None. Otherwise, if value of num_workers &gt; 0 default is 2).</span>
</span><span id="L-2759"><a href="#L-2759"><span class="linenos">2759</span></a>    <span class="c1">#persistent_workers (bool, optional)  If True, the data loader will not shut down the worker processes after a dataset has been consumed once. This allows to maintain the workers Dataset instances alive. (default: False)</span>
</span><span id="L-2760"><a href="#L-2760"><span class="linenos">2760</span></a>    <span class="c1">#pin_memory_device (str, optional)  the device to pin_memory to if pin_memory is True.</span>
</span><span id="L-2761"><a href="#L-2761"><span class="linenos">2761</span></a>
</span><span id="L-2762"><a href="#L-2762"><span class="linenos">2762</span></a>    <span class="c1">#images, labels, filenames = next(iter(train_loaders))</span>
</span><span id="L-2763"><a href="#L-2763"><span class="linenos">2763</span></a>    <span class="c1">#images = images.cpu()</span>
</span><span id="L-2764"><a href="#L-2764"><span class="linenos">2764</span></a>    <span class="c1">#label_strings = [str(label.item()) for label in labels]</span>
</span><span id="L-2765"><a href="#L-2765"><span class="linenos">2765</span></a>    <span class="c1">#train_fig = _imshow_gpu(images, label_strings, nrow=20, fontsize=12)</span>
</span><span id="L-2766"><a href="#L-2766"><span class="linenos">2766</span></a>    <span class="c1">#if verbose:</span>
</span><span id="L-2767"><a href="#L-2767"><span class="linenos">2767</span></a>    <span class="c1">#    plt.show()</span>
</span><span id="L-2768"><a href="#L-2768"><span class="linenos">2768</span></a>    
</span><span id="L-2769"><a href="#L-2769"><span class="linenos">2769</span></a>    <span class="n">train_fig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2770"><a href="#L-2770"><span class="linenos">2770</span></a>
</span><span id="L-2771"><a href="#L-2771"><span class="linenos">2771</span></a>    <span class="k">return</span> <span class="n">train_loaders</span><span class="p">,</span> <span class="n">val_loaders</span><span class="p">,</span> <span class="n">train_fig</span>
</span><span id="L-2772"><a href="#L-2772"><span class="linenos">2772</span></a>
</span><span id="L-2773"><a href="#L-2773"><span class="linenos">2773</span></a><span class="k">def</span> <span class="nf">generate_training_dataset</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-2774"><a href="#L-2774"><span class="linenos">2774</span></a>    
</span><span id="L-2775"><a href="#L-2775"><span class="linenos">2775</span></a>    <span class="c1"># Function to filter png_list_df by prcfo present in df without merging</span>
</span><span id="L-2776"><a href="#L-2776"><span class="linenos">2776</span></a>    <span class="k">def</span> <span class="nf">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
</span><span id="L-2777"><a href="#L-2777"><span class="linenos">2777</span></a>        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
</span><span id="L-2778"><a href="#L-2778"><span class="linenos">2778</span></a>                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
</span><span id="L-2779"><a href="#L-2779"><span class="linenos">2779</span></a>                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2780"><a href="#L-2780"><span class="linenos">2780</span></a>                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
</span><span id="L-2781"><a href="#L-2781"><span class="linenos">2781</span></a>                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>
</span><span id="L-2782"><a href="#L-2782"><span class="linenos">2782</span></a>                
</span><span id="L-2783"><a href="#L-2783"><span class="linenos">2783</span></a>        <span class="p">[</span><span class="n">png_list_df</span><span class="p">]</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">])</span>
</span><span id="L-2784"><a href="#L-2784"><span class="linenos">2784</span></a>        <span class="n">filtered_png_list_df</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
</span><span id="L-2785"><a href="#L-2785"><span class="linenos">2785</span></a>        <span class="k">return</span> <span class="n">filtered_png_list_df</span>
</span><span id="L-2786"><a href="#L-2786"><span class="linenos">2786</span></a>
</span><span id="L-2787"><a href="#L-2787"><span class="linenos">2787</span></a>    <span class="c1"># Function to get the smallest class size based on the dataset mode</span>
</span><span id="L-2788"><a href="#L-2788"><span class="linenos">2788</span></a>    <span class="k">def</span> <span class="nf">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">dataset_mode</span><span class="p">):</span>
</span><span id="L-2789"><a href="#L-2789"><span class="linenos">2789</span></a>        <span class="k">if</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
</span><span id="L-2790"><a href="#L-2790"><span class="linenos">2790</span></a>            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]]</span>
</span><span id="L-2791"><a href="#L-2791"><span class="linenos">2791</span></a>            <span class="c1">#sizes = [len(df[df[&#39;condition&#39;].isin(class_list)]) for class_list in settings[&#39;class_metadata&#39;]]</span>
</span><span id="L-2792"><a href="#L-2792"><span class="linenos">2792</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class sizes: </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2793"><a href="#L-2793"><span class="linenos">2793</span></a>        <span class="k">elif</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
</span><span id="L-2794"><a href="#L-2794"><span class="linenos">2794</span></a>            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span> <span class="k">for</span> <span class="n">class_paths</span> <span class="ow">in</span> <span class="n">df</span><span class="p">]</span>
</span><span id="L-2795"><a href="#L-2795"><span class="linenos">2795</span></a>        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
</span><span id="L-2796"><a href="#L-2796"><span class="linenos">2796</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using the smallest class size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2797"><a href="#L-2797"><span class="linenos">2797</span></a>        <span class="k">return</span> <span class="n">size</span>
</span><span id="L-2798"><a href="#L-2798"><span class="linenos">2798</span></a>    
</span><span id="L-2799"><a href="#L-2799"><span class="linenos">2799</span></a>    <span class="c1"># Measurement-based selection logic</span>
</span><span id="L-2800"><a href="#L-2800"><span class="linenos">2800</span></a>    <span class="k">def</span> <span class="nf">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
</span><span id="L-2801"><a href="#L-2801"><span class="linenos">2801</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2802"><a href="#L-2802"><span class="linenos">2802</span></a>        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
</span><span id="L-2803"><a href="#L-2803"><span class="linenos">2803</span></a>                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
</span><span id="L-2804"><a href="#L-2804"><span class="linenos">2804</span></a>                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2805"><a href="#L-2805"><span class="linenos">2805</span></a>                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
</span><span id="L-2806"><a href="#L-2806"><span class="linenos">2806</span></a>                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>
</span><span id="L-2807"><a href="#L-2807"><span class="linenos">2807</span></a>
</span><span id="L-2808"><a href="#L-2808"><span class="linenos">2808</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 1&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</span><span id="L-2809"><a href="#L-2809"><span class="linenos">2809</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HeLa&#39;</span><span class="p">],</span> <span class="n">pathogens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">],</span> <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">],</span>
</span><span id="L-2810"><a href="#L-2810"><span class="linenos">2810</span></a>                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span><span class="c1">#, types=settings[&#39;metadata_type_by&#39;])</span>
</span><span id="L-2811"><a href="#L-2811"><span class="linenos">2811</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 2&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</span><span id="L-2812"><a href="#L-2812"><span class="linenos">2812</span></a>        
</span><span id="L-2813"><a href="#L-2813"><span class="linenos">2813</span></a>        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
</span><span id="L-2814"><a href="#L-2814"><span class="linenos">2814</span></a>
</span><span id="L-2815"><a href="#L-2815"><span class="linenos">2815</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">]:</span>
</span><span id="L-2816"><a href="#L-2816"><span class="linenos">2816</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-2817"><a href="#L-2817"><span class="linenos">2817</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2818"><a href="#L-2818"><span class="linenos">2818</span></a>                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="L-2819"><a href="#L-2819"><span class="linenos">2819</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2820"><a href="#L-2820"><span class="linenos">2820</span></a>                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="L-2821"><a href="#L-2821"><span class="linenos">2821</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2822"><a href="#L-2822"><span class="linenos">2822</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;custom_measurement should be a list.&quot;</span><span class="p">)</span>
</span><span id="L-2823"><a href="#L-2823"><span class="linenos">2823</span></a>                <span class="k">return</span>
</span><span id="L-2824"><a href="#L-2824"><span class="linenos">2824</span></a>
</span><span id="L-2825"><a href="#L-2825"><span class="linenos">2825</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2826"><a href="#L-2826"><span class="linenos">2826</span></a>            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pathogen_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cytoplasm_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span>
</span><span id="L-2827"><a href="#L-2827"><span class="linenos">2827</span></a>
</span><span id="L-2828"><a href="#L-2828"><span class="linenos">2828</span></a>        <span class="n">q25</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
</span><span id="L-2829"><a href="#L-2829"><span class="linenos">2829</span></a>        <span class="n">q75</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
</span><span id="L-2830"><a href="#L-2830"><span class="linenos">2830</span></a>        <span class="n">df_lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">q25</span><span class="p">]</span>
</span><span id="L-2831"><a href="#L-2831"><span class="linenos">2831</span></a>        <span class="n">df_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">q75</span><span class="p">]</span>
</span><span id="L-2832"><a href="#L-2832"><span class="linenos">2832</span></a>
</span><span id="L-2833"><a href="#L-2833"><span class="linenos">2833</span></a>        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_lower</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
</span><span id="L-2834"><a href="#L-2834"><span class="linenos">2834</span></a>        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
</span><span id="L-2835"><a href="#L-2835"><span class="linenos">2835</span></a>        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">)</span>
</span><span id="L-2836"><a href="#L-2836"><span class="linenos">2836</span></a>
</span><span id="L-2837"><a href="#L-2837"><span class="linenos">2837</span></a>        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_upper</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
</span><span id="L-2838"><a href="#L-2838"><span class="linenos">2838</span></a>        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
</span><span id="L-2839"><a href="#L-2839"><span class="linenos">2839</span></a>        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">)</span>
</span><span id="L-2840"><a href="#L-2840"><span class="linenos">2840</span></a>
</span><span id="L-2841"><a href="#L-2841"><span class="linenos">2841</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="L-2842"><a href="#L-2842"><span class="linenos">2842</span></a>
</span><span id="L-2843"><a href="#L-2843"><span class="linenos">2843</span></a>    <span class="c1"># Metadata-based selection logic</span>
</span><span id="L-2844"><a href="#L-2844"><span class="linenos">2844</span></a>    <span class="k">def</span> <span class="nf">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="L-2845"><a href="#L-2845"><span class="linenos">2845</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2846"><a href="#L-2846"><span class="linenos">2846</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
</span><span id="L-2847"><a href="#L-2847"><span class="linenos">2847</span></a>                
</span><span id="L-2848"><a href="#L-2848"><span class="linenos">2848</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
</span><span id="L-2849"><a href="#L-2849"><span class="linenos">2849</span></a>                                 <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2850"><a href="#L-2850"><span class="linenos">2850</span></a>                                 <span class="n">cell_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2851"><a href="#L-2851"><span class="linenos">2851</span></a>                                 <span class="n">pathogens</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_name&#39;</span><span class="p">],</span>
</span><span id="L-2852"><a href="#L-2852"><span class="linenos">2852</span></a>                                 <span class="n">pathogen_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_value&#39;</span><span class="p">],</span>
</span><span id="L-2853"><a href="#L-2853"><span class="linenos">2853</span></a>                                 <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_name&#39;</span><span class="p">],</span>
</span><span id="L-2854"><a href="#L-2854"><span class="linenos">2854</span></a>                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_value&#39;</span><span class="p">])</span>
</span><span id="L-2855"><a href="#L-2855"><span class="linenos">2855</span></a>        
</span><span id="L-2856"><a href="#L-2856"><span class="linenos">2856</span></a>        <span class="c1">#if settings[&#39;metadata_type_by&#39;] == &#39;condition&#39;:</span>
</span><span id="L-2857"><a href="#L-2857"><span class="linenos">2857</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">])</span>
</span><span id="L-2858"><a href="#L-2858"><span class="linenos">2858</span></a>            
</span><span id="L-2859"><a href="#L-2859"><span class="linenos">2859</span></a>        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2860"><a href="#L-2860"><span class="linenos">2860</span></a>
</span><span id="L-2861"><a href="#L-2861"><span class="linenos">2861</span></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
</span><span id="L-2862"><a href="#L-2862"><span class="linenos">2862</span></a>        
</span><span id="L-2863"><a href="#L-2863"><span class="linenos">2863</span></a>        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]:</span>
</span><span id="L-2864"><a href="#L-2864"><span class="linenos">2864</span></a>            <span class="n">class_temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
</span><span id="L-2865"><a href="#L-2865"><span class="linenos">2865</span></a>            <span class="c1">#class_temp_df = df[df[&#39;condition&#39;].isin(class_)]</span>
</span><span id="L-2866"><a href="#L-2866"><span class="linenos">2866</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_temp_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> images for class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2867"><a href="#L-2867"><span class="linenos">2867</span></a>            <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">class_temp_df</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-2868"><a href="#L-2868"><span class="linenos">2868</span></a>
</span><span id="L-2869"><a href="#L-2869"><span class="linenos">2869</span></a>            <span class="c1"># Ensure to sample `size` number of images (smallest class size)</span>
</span><span id="L-2870"><a href="#L-2870"><span class="linenos">2870</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
</span><span id="L-2871"><a href="#L-2871"><span class="linenos">2871</span></a>                <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span id="L-2872"><a href="#L-2872"><span class="linenos">2872</span></a>
</span><span id="L-2873"><a href="#L-2873"><span class="linenos">2873</span></a>            <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
</span><span id="L-2874"><a href="#L-2874"><span class="linenos">2874</span></a>
</span><span id="L-2875"><a href="#L-2875"><span class="linenos">2875</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="L-2876"><a href="#L-2876"><span class="linenos">2876</span></a>
</span><span id="L-2877"><a href="#L-2877"><span class="linenos">2877</span></a>    <span class="c1"># Annotation-based selection logic</span>
</span><span id="L-2878"><a href="#L-2878"><span class="linenos">2878</span></a>    <span class="k">def</span> <span class="nf">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="L-2879"><a href="#L-2879"><span class="linenos">2879</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">])</span>
</span><span id="L-2880"><a href="#L-2880"><span class="linenos">2880</span></a>
</span><span id="L-2881"><a href="#L-2881"><span class="linenos">2881</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="L-2882"><a href="#L-2882"><span class="linenos">2882</span></a>    
</span><span id="L-2883"><a href="#L-2883"><span class="linenos">2883</span></a>    <span class="c1"># Metadata-Annotation-based selection logic</span>
</span><span id="L-2884"><a href="#L-2884"><span class="linenos">2884</span></a>    <span class="k">def</span> <span class="nf">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="L-2885"><a href="#L-2885"><span class="linenos">2885</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">],</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_type_by&#39;</span><span class="p">],</span> <span class="n">class_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span>
</span><span id="L-2886"><a href="#L-2886"><span class="linenos">2886</span></a>
</span><span id="L-2887"><a href="#L-2887"><span class="linenos">2887</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="L-2888"><a href="#L-2888"><span class="linenos">2888</span></a>    
</span><span id="L-2889"><a href="#L-2889"><span class="linenos">2889</span></a>    <span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">_read_and_merge_data</span><span class="p">,</span> <span class="n">_read_db</span>
</span><span id="L-2890"><a href="#L-2890"><span class="linenos">2890</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_paths_from_db</span><span class="p">,</span> <span class="n">annotate_conditions</span><span class="p">,</span> <span class="n">save_settings</span>
</span><span id="L-2891"><a href="#L-2891"><span class="linenos">2891</span></a>    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_training_dataset_defaults</span>
</span><span id="L-2892"><a href="#L-2892"><span class="linenos">2892</span></a>    
</span><span id="L-2893"><a href="#L-2893"><span class="linenos">2893</span></a>    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_training_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-2894"><a href="#L-2894"><span class="linenos">2894</span></a>
</span><span id="L-2895"><a href="#L-2895"><span class="linenos">2895</span></a>    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
</span><span id="L-2896"><a href="#L-2896"><span class="linenos">2896</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2897"><a href="#L-2897"><span class="linenos">2897</span></a>        
</span><span id="L-2898"><a href="#L-2898"><span class="linenos">2898</span></a>    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
</span><span id="L-2899"><a href="#L-2899"><span class="linenos">2899</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2900"><a href="#L-2900"><span class="linenos">2900</span></a>       
</span><span id="L-2901"><a href="#L-2901"><span class="linenos">2901</span></a>    <span class="c1"># Set default settings and save</span>
</span><span id="L-2902"><a href="#L-2902"><span class="linenos">2902</span></a>    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;cv_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2903"><a href="#L-2903"><span class="linenos">2903</span></a>
</span><span id="L-2904"><a href="#L-2904"><span class="linenos">2904</span></a>    <span class="n">class_path_list</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2905"><a href="#L-2905"><span class="linenos">2905</span></a>
</span><span id="L-2906"><a href="#L-2906"><span class="linenos">2906</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2907"><a href="#L-2907"><span class="linenos">2907</span></a>        <span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
</span><span id="L-2908"><a href="#L-2908"><span class="linenos">2908</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="L-2909"><a href="#L-2909"><span class="linenos">2909</span></a>
</span><span id="L-2910"><a href="#L-2910"><span class="linenos">2910</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
</span><span id="L-2911"><a href="#L-2911"><span class="linenos">2911</span></a>        <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
</span><span id="L-2912"><a href="#L-2912"><span class="linenos">2912</span></a>        
</span><span id="L-2913"><a href="#L-2913"><span class="linenos">2913</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2914"><a href="#L-2914"><span class="linenos">2914</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training_all&#39;</span><span class="p">)</span>
</span><span id="L-2915"><a href="#L-2915"><span class="linenos">2915</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2916"><a href="#L-2916"><span class="linenos">2916</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">)</span>
</span><span id="L-2917"><a href="#L-2917"><span class="linenos">2917</span></a>
</span><span id="L-2918"><a href="#L-2918"><span class="linenos">2918</span></a>        <span class="c1"># Create a new directory for training data if necessary</span>
</span><span id="L-2919"><a href="#L-2919"><span class="linenos">2919</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
</span><span id="L-2920"><a href="#L-2920"><span class="linenos">2920</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
</span><span id="L-2921"><a href="#L-2921"><span class="linenos">2921</span></a>                <span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="L-2922"><a href="#L-2922"><span class="linenos">2922</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
</span><span id="L-2923"><a href="#L-2923"><span class="linenos">2923</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new directory for training: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2924"><a href="#L-2924"><span class="linenos">2924</span></a>                    <span class="k">break</span>
</span><span id="L-2925"><a href="#L-2925"><span class="linenos">2925</span></a>
</span><span id="L-2926"><a href="#L-2926"><span class="linenos">2926</span></a>        <span class="c1"># Select dataset based on dataset mode</span>
</span><span id="L-2927"><a href="#L-2927"><span class="linenos">2927</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
</span><span id="L-2928"><a href="#L-2928"><span class="linenos">2928</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-2929"><a href="#L-2929"><span class="linenos">2929</span></a>
</span><span id="L-2930"><a href="#L-2930"><span class="linenos">2930</span></a>        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
</span><span id="L-2931"><a href="#L-2931"><span class="linenos">2931</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-2932"><a href="#L-2932"><span class="linenos">2932</span></a>
</span><span id="L-2933"><a href="#L-2933"><span class="linenos">2933</span></a>        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;measurement&#39;</span><span class="p">:</span>
</span><span id="L-2934"><a href="#L-2934"><span class="linenos">2934</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
</span><span id="L-2935"><a href="#L-2935"><span class="linenos">2935</span></a>            
</span><span id="L-2936"><a href="#L-2936"><span class="linenos">2936</span></a>        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata_annotation&#39;</span><span class="p">:</span>
</span><span id="L-2937"><a href="#L-2937"><span class="linenos">2937</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-2938"><a href="#L-2938"><span class="linenos">2938</span></a>            
</span><span id="L-2939"><a href="#L-2939"><span class="linenos">2939</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2940"><a href="#L-2940"><span class="linenos">2940</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dataset mode: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2941"><a href="#L-2941"><span class="linenos">2941</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid options are: &#39;annotation&#39;, &#39;metadata&#39;, &#39;measurement&#39;, &#39;metadata_annotation&#39;&quot;</span><span class="p">)</span>
</span><span id="L-2942"><a href="#L-2942"><span class="linenos">2942</span></a>            <span class="k">return</span>
</span><span id="L-2943"><a href="#L-2943"><span class="linenos">2943</span></a>        
</span><span id="L-2944"><a href="#L-2944"><span class="linenos">2944</span></a>        <span class="k">if</span> <span class="n">class_path_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2945"><a href="#L-2945"><span class="linenos">2945</span></a>            <span class="n">class_path_list</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">))]</span>
</span><span id="L-2946"><a href="#L-2946"><span class="linenos">2946</span></a>
</span><span id="L-2947"><a href="#L-2947"><span class="linenos">2947</span></a>        <span class="c1"># Extend each list in class_path_list with the corresponding list from class_paths_ls</span>
</span><span id="L-2948"><a href="#L-2948"><span class="linenos">2948</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">)):</span>
</span><span id="L-2949"><a href="#L-2949"><span class="linenos">2949</span></a>            <span class="n">class_path_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="L-2950"><a href="#L-2950"><span class="linenos">2950</span></a>
</span><span id="L-2951"><a href="#L-2951"><span class="linenos">2951</span></a>    <span class="c1"># Generate and return training and testing directories</span>
</span><span id="L-2952"><a href="#L-2952"><span class="linenos">2952</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class_path_list&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">class_path_list</span><span class="p">))</span>
</span><span id="L-2953"><a href="#L-2953"><span class="linenos">2953</span></a>    <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="o">=</span><span class="n">class_path_list</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">],</span> <span class="n">test_split</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;test_split&#39;</span><span class="p">])</span>
</span><span id="L-2954"><a href="#L-2954"><span class="linenos">2954</span></a>
</span><span id="L-2955"><a href="#L-2955"><span class="linenos">2955</span></a>    <span class="k">return</span> <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span>
</span><span id="L-2956"><a href="#L-2956"><span class="linenos">2956</span></a>
</span><span id="L-2957"><a href="#L-2957"><span class="linenos">2957</span></a><span class="k">def</span> <span class="nf">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
</span><span id="L-2958"><a href="#L-2958"><span class="linenos">2958</span></a>    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2959"><a href="#L-2959"><span class="linenos">2959</span></a>
</span><span id="L-2960"><a href="#L-2960"><span class="linenos">2960</span></a>    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
</span><span id="L-2961"><a href="#L-2961"><span class="linenos">2961</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2962"><a href="#L-2962"><span class="linenos">2962</span></a>    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-2963"><a href="#L-2963"><span class="linenos">2963</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="L-2964"><a href="#L-2964"><span class="linenos">2964</span></a>        <span class="c1"># Retrieve all paths and annotations from the database</span>
</span><span id="L-2965"><a href="#L-2965"><span class="linenos">2965</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> FROM png_list&quot;</span>
</span><span id="L-2966"><a href="#L-2966"><span class="linenos">2966</span></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="L-2967"><a href="#L-2967"><span class="linenos">2967</span></a>        
</span><span id="L-2968"><a href="#L-2968"><span class="linenos">2968</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-2969"><a href="#L-2969"><span class="linenos">2969</span></a>            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-2970"><a href="#L-2970"><span class="linenos">2970</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="L-2971"><a href="#L-2971"><span class="linenos">2971</span></a>                <span class="k">break</span>
</span><span id="L-2972"><a href="#L-2972"><span class="linenos">2972</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="L-2973"><a href="#L-2973"><span class="linenos">2973</span></a>                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="L-2974"><a href="#L-2974"><span class="linenos">2974</span></a>
</span><span id="L-2975"><a href="#L-2975"><span class="linenos">2975</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
</span><span id="L-2976"><a href="#L-2976"><span class="linenos">2976</span></a>    
</span><span id="L-2977"><a href="#L-2977"><span class="linenos">2977</span></a>    <span class="c1"># Filter paths based on annotated_classes</span>
</span><span id="L-2978"><a href="#L-2978"><span class="linenos">2978</span></a>    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2979"><a href="#L-2979"><span class="linenos">2979</span></a>    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
</span><span id="L-2980"><a href="#L-2980"><span class="linenos">2980</span></a>        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
</span><span id="L-2981"><a href="#L-2981"><span class="linenos">2981</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
</span><span id="L-2982"><a href="#L-2982"><span class="linenos">2982</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2983"><a href="#L-2983"><span class="linenos">2983</span></a>        
</span><span id="L-2984"><a href="#L-2984"><span class="linenos">2984</span></a>    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
</span><span id="L-2985"><a href="#L-2985"><span class="linenos">2985</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2986"><a href="#L-2986"><span class="linenos">2986</span></a>        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2987"><a href="#L-2987"><span class="linenos">2987</span></a>        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-2988"><a href="#L-2988"><span class="linenos">2988</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="L-2989"><a href="#L-2989"><span class="linenos">2989</span></a>        
</span><span id="L-2990"><a href="#L-2990"><span class="linenos">2990</span></a>        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
</span><span id="L-2991"><a href="#L-2991"><span class="linenos">2991</span></a>        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
</span><span id="L-2992"><a href="#L-2992"><span class="linenos">2992</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="L-2993"><a href="#L-2993"><span class="linenos">2993</span></a>        
</span><span id="L-2994"><a href="#L-2994"><span class="linenos">2994</span></a>        <span class="c1"># Sample the same number of images for both classes</span>
</span><span id="L-2995"><a href="#L-2995"><span class="linenos">2995</span></a>        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="L-2996"><a href="#L-2996"><span class="linenos">2996</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>
</span><span id="L-2997"><a href="#L-2997"><span class="linenos">2997</span></a>
</span><span id="L-2998"><a href="#L-2998"><span class="linenos">2998</span></a>        <span class="c1"># Resample target class to match the smaller size</span>
</span><span id="L-2999"><a href="#L-2999"><span class="linenos">2999</span></a>        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="L-3000"><a href="#L-3000"><span class="linenos">3000</span></a>        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="L-3001"><a href="#L-3001"><span class="linenos">3001</span></a>        
</span><span id="L-3002"><a href="#L-3002"><span class="linenos">3002</span></a>        <span class="c1"># Update class paths</span>
</span><span id="L-3003"><a href="#L-3003"><span class="linenos">3003</span></a>        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
</span><span id="L-3004"><a href="#L-3004"><span class="linenos">3004</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>
</span><span id="L-3005"><a href="#L-3005"><span class="linenos">3005</span></a>
</span><span id="L-3006"><a href="#L-3006"><span class="linenos">3006</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
</span><span id="L-3007"><a href="#L-3007"><span class="linenos">3007</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
</span><span id="L-3008"><a href="#L-3008"><span class="linenos">3008</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="L-3009"><a href="#L-3009"><span class="linenos">3009</span></a>        
</span><span id="L-3010"><a href="#L-3010"><span class="linenos">3010</span></a>    <span class="k">return</span> <span class="n">class_paths</span>
</span><span id="L-3011"><a href="#L-3011"><span class="linenos">3011</span></a>
</span><span id="L-3012"><a href="#L-3012"><span class="linenos">3012</span></a><span class="k">def</span> <span class="nf">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="s1">&#39;columnID&#39;</span><span class="p">,</span> <span class="n">class_metadata</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;c2&#39;</span><span class="p">]):</span>
</span><span id="L-3013"><a href="#L-3013"><span class="linenos">3013</span></a>    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3014"><a href="#L-3014"><span class="linenos">3014</span></a>
</span><span id="L-3015"><a href="#L-3015"><span class="linenos">3015</span></a>    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
</span><span id="L-3016"><a href="#L-3016"><span class="linenos">3016</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3017"><a href="#L-3017"><span class="linenos">3017</span></a>    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="L-3018"><a href="#L-3018"><span class="linenos">3018</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="L-3019"><a href="#L-3019"><span class="linenos">3019</span></a>        <span class="c1"># Retrieve all paths and annotations from the database</span>
</span><span id="L-3020"><a href="#L-3020"><span class="linenos">3020</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2">, row_name, column_name FROM png_list&quot;</span>
</span><span id="L-3021"><a href="#L-3021"><span class="linenos">3021</span></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="L-3022"><a href="#L-3022"><span class="linenos">3022</span></a>        
</span><span id="L-3023"><a href="#L-3023"><span class="linenos">3023</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-3024"><a href="#L-3024"><span class="linenos">3024</span></a>            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="L-3025"><a href="#L-3025"><span class="linenos">3025</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="L-3026"><a href="#L-3026"><span class="linenos">3026</span></a>                <span class="k">break</span>
</span><span id="L-3027"><a href="#L-3027"><span class="linenos">3027</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="L-3028"><a href="#L-3028"><span class="linenos">3028</span></a>                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="L-3029"><a href="#L-3029"><span class="linenos">3029</span></a>
</span><span id="L-3030"><a href="#L-3030"><span class="linenos">3030</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
</span><span id="L-3031"><a href="#L-3031"><span class="linenos">3031</span></a>    
</span><span id="L-3032"><a href="#L-3032"><span class="linenos">3032</span></a>    <span class="c1"># Filter all_paths by metadata_type_by and class_metadata</span>
</span><span id="L-3033"><a href="#L-3033"><span class="linenos">3033</span></a>    <span class="n">filtered_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3034"><a href="#L-3034"><span class="linenos">3034</span></a>    <span class="n">metadata_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rowID&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_type_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-3035"><a href="#L-3035"><span class="linenos">3035</span></a>    <span class="k">if</span> <span class="n">metadata_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3036"><a href="#L-3036"><span class="linenos">3036</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid metadata_type_by value: </span><span class="si">{</span><span class="n">metadata_type_by</span><span class="si">}</span><span class="s2">. Must be &#39;rowID&#39; or &#39;columnID&#39;. </span><span class="si">{</span><span class="n">class_metadata</span><span class="si">}</span><span class="s2"> must be a list formatted as [&#39;c1&#39;, &#39;c2&#39;] or [&#39;r1&#39;, &#39;r2&#39;]&quot;</span><span class="p">)</span>
</span><span id="L-3037"><a href="#L-3037"><span class="linenos">3037</span></a>
</span><span id="L-3038"><a href="#L-3038"><span class="linenos">3038</span></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_paths</span><span class="p">:</span>
</span><span id="L-3039"><a href="#L-3039"><span class="linenos">3039</span></a>        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">metadata_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">class_metadata</span><span class="p">:</span>
</span><span id="L-3040"><a href="#L-3040"><span class="linenos">3040</span></a>            <span class="n">filtered_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="L-3041"><a href="#L-3041"><span class="linenos">3041</span></a>
</span><span id="L-3042"><a href="#L-3042"><span class="linenos">3042</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total filtered paths:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_paths</span><span class="p">))</span>
</span><span id="L-3043"><a href="#L-3043"><span class="linenos">3043</span></a>    <span class="c1">#all_paths = filtered_paths</span>
</span><span id="L-3044"><a href="#L-3044"><span class="linenos">3044</span></a>    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_paths</span><span class="p">]</span>
</span><span id="L-3045"><a href="#L-3045"><span class="linenos">3045</span></a>    
</span><span id="L-3046"><a href="#L-3046"><span class="linenos">3046</span></a>    <span class="c1"># Filter paths based on annotated_classes</span>
</span><span id="L-3047"><a href="#L-3047"><span class="linenos">3047</span></a>    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3048"><a href="#L-3048"><span class="linenos">3048</span></a>    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
</span><span id="L-3049"><a href="#L-3049"><span class="linenos">3049</span></a>        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
</span><span id="L-3050"><a href="#L-3050"><span class="linenos">3050</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
</span><span id="L-3051"><a href="#L-3051"><span class="linenos">3051</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3052"><a href="#L-3052"><span class="linenos">3052</span></a>        
</span><span id="L-3053"><a href="#L-3053"><span class="linenos">3053</span></a>    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
</span><span id="L-3054"><a href="#L-3054"><span class="linenos">3054</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-3055"><a href="#L-3055"><span class="linenos">3055</span></a>        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3056"><a href="#L-3056"><span class="linenos">3056</span></a>        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-3057"><a href="#L-3057"><span class="linenos">3057</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="L-3058"><a href="#L-3058"><span class="linenos">3058</span></a>        
</span><span id="L-3059"><a href="#L-3059"><span class="linenos">3059</span></a>        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
</span><span id="L-3060"><a href="#L-3060"><span class="linenos">3060</span></a>        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
</span><span id="L-3061"><a href="#L-3061"><span class="linenos">3061</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="L-3062"><a href="#L-3062"><span class="linenos">3062</span></a>        
</span><span id="L-3063"><a href="#L-3063"><span class="linenos">3063</span></a>        <span class="c1"># Sample the same number of images for both classes</span>
</span><span id="L-3064"><a href="#L-3064"><span class="linenos">3064</span></a>        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="L-3065"><a href="#L-3065"><span class="linenos">3065</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>
</span><span id="L-3066"><a href="#L-3066"><span class="linenos">3066</span></a>
</span><span id="L-3067"><a href="#L-3067"><span class="linenos">3067</span></a>        <span class="c1"># Resample target class to match the smaller size</span>
</span><span id="L-3068"><a href="#L-3068"><span class="linenos">3068</span></a>        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="L-3069"><a href="#L-3069"><span class="linenos">3069</span></a>        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="L-3070"><a href="#L-3070"><span class="linenos">3070</span></a>        
</span><span id="L-3071"><a href="#L-3071"><span class="linenos">3071</span></a>        <span class="c1"># Update class paths</span>
</span><span id="L-3072"><a href="#L-3072"><span class="linenos">3072</span></a>        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
</span><span id="L-3073"><a href="#L-3073"><span class="linenos">3073</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>
</span><span id="L-3074"><a href="#L-3074"><span class="linenos">3074</span></a>
</span><span id="L-3075"><a href="#L-3075"><span class="linenos">3075</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
</span><span id="L-3076"><a href="#L-3076"><span class="linenos">3076</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
</span><span id="L-3077"><a href="#L-3077"><span class="linenos">3077</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="L-3078"><a href="#L-3078"><span class="linenos">3078</span></a>        
</span><span id="L-3079"><a href="#L-3079"><span class="linenos">3079</span></a>    <span class="k">return</span> <span class="n">class_paths</span>
</span><span id="L-3080"><a href="#L-3080"><span class="linenos">3080</span></a>
</span><span id="L-3081"><a href="#L-3081"><span class="linenos">3081</span></a><span class="k">def</span> <span class="nf">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="L-3082"><a href="#L-3082"><span class="linenos">3082</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-3083"><a href="#L-3083"><span class="linenos">3083</span></a>    <span class="c1"># Make sure that the length of class_data matches the length of classes</span>
</span><span id="L-3084"><a href="#L-3084"><span class="linenos">3084</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
</span><span id="L-3085"><a href="#L-3085"><span class="linenos">3085</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;class_data and classes must have the same length.&quot;</span><span class="p">)</span>
</span><span id="L-3086"><a href="#L-3086"><span class="linenos">3086</span></a>
</span><span id="L-3087"><a href="#L-3087"><span class="linenos">3087</span></a>    <span class="n">total_files</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">class_data</span><span class="p">)</span>
</span><span id="L-3088"><a href="#L-3088"><span class="linenos">3088</span></a>    <span class="n">processed_files</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3089"><a href="#L-3089"><span class="linenos">3089</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3090"><a href="#L-3090"><span class="linenos">3090</span></a>    
</span><span id="L-3091"><a href="#L-3091"><span class="linenos">3091</span></a>    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">class_data</span><span class="p">):</span>
</span><span id="L-3092"><a href="#L-3092"><span class="linenos">3092</span></a>        <span class="c1"># Create directories</span>
</span><span id="L-3093"><a href="#L-3093"><span class="linenos">3093</span></a>        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3094"><a href="#L-3094"><span class="linenos">3094</span></a>        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3095"><a href="#L-3095"><span class="linenos">3095</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3096"><a href="#L-3096"><span class="linenos">3096</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3097"><a href="#L-3097"><span class="linenos">3097</span></a>                
</span><span id="L-3098"><a href="#L-3098"><span class="linenos">3098</span></a>        <span class="c1"># Split the data</span>
</span><span id="L-3099"><a href="#L-3099"><span class="linenos">3099</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">test_split</span><span class="p">)</span>
</span><span id="L-3100"><a href="#L-3100"><span class="linenos">3100</span></a>        <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_split</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="L-3101"><a href="#L-3101"><span class="linenos">3101</span></a>        
</span><span id="L-3102"><a href="#L-3102"><span class="linenos">3102</span></a>        <span class="c1"># Copy train files</span>
</span><span id="L-3103"><a href="#L-3103"><span class="linenos">3103</span></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
</span><span id="L-3104"><a href="#L-3104"><span class="linenos">3104</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-3105"><a href="#L-3105"><span class="linenos">3105</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
</span><span id="L-3106"><a href="#L-3106"><span class="linenos">3106</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-3107"><a href="#L-3107"><span class="linenos">3107</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-3108"><a href="#L-3108"><span class="linenos">3108</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Train dataset&quot;</span><span class="p">)</span>
</span><span id="L-3109"><a href="#L-3109"><span class="linenos">3109</span></a>            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3110"><a href="#L-3110"><span class="linenos">3110</span></a>
</span><span id="L-3111"><a href="#L-3111"><span class="linenos">3111</span></a>        <span class="c1"># Copy test files</span>
</span><span id="L-3112"><a href="#L-3112"><span class="linenos">3112</span></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
</span><span id="L-3113"><a href="#L-3113"><span class="linenos">3113</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-3114"><a href="#L-3114"><span class="linenos">3114</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
</span><span id="L-3115"><a href="#L-3115"><span class="linenos">3115</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="L-3116"><a href="#L-3116"><span class="linenos">3116</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="L-3117"><a href="#L-3117"><span class="linenos">3117</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Test dataset&quot;</span><span class="p">)</span>
</span><span id="L-3118"><a href="#L-3118"><span class="linenos">3118</span></a>            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3119"><a href="#L-3119"><span class="linenos">3119</span></a>
</span><span id="L-3120"><a href="#L-3120"><span class="linenos">3120</span></a>    <span class="c1"># Print summary</span>
</span><span id="L-3121"><a href="#L-3121"><span class="linenos">3121</span></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="L-3122"><a href="#L-3122"><span class="linenos">3122</span></a>        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3123"><a href="#L-3123"><span class="linenos">3123</span></a>        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3124"><a href="#L-3124"><span class="linenos">3124</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">, Test class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-3125"><a href="#L-3125"><span class="linenos">3125</span></a>
</span><span id="L-3126"><a href="#L-3126"><span class="linenos">3126</span></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span><span id="L-3127"><a href="#L-3127"><span class="linenos">3127</span></a>
</span><span id="L-3128"><a href="#L-3128"><span class="linenos">3128</span></a><span class="k">def</span> <span class="nf">convert_separate_files_to_yokogawa</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
</span><span id="L-3129"><a href="#L-3129"><span class="linenos">3129</span></a>    
</span><span id="L-3130"><a href="#L-3130"><span class="linenos">3130</span></a>    <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
</span><span id="L-3131"><a href="#L-3131"><span class="linenos">3131</span></a>    <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</span><span id="L-3132"><a href="#L-3132"><span class="linenos">3132</span></a>    <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>
</span><span id="L-3133"><a href="#L-3133"><span class="linenos">3133</span></a>
</span><span id="L-3134"><a href="#L-3134"><span class="linenos">3134</span></a>    <span class="k">def</span> <span class="nf">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">):</span>
</span><span id="L-3135"><a href="#L-3135"><span class="linenos">3135</span></a>        <span class="n">plate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3136"><a href="#L-3136"><span class="linenos">3136</span></a>        <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">WELLS</span><span class="p">:</span>
</span><span id="L-3137"><a href="#L-3137"><span class="linenos">3137</span></a>            <span class="n">well_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-3138"><a href="#L-3138"><span class="linenos">3138</span></a>            <span class="k">if</span> <span class="n">well_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_wells</span><span class="p">:</span>
</span><span id="L-3139"><a href="#L-3139"><span class="linenos">3139</span></a>                <span class="k">return</span> <span class="n">well_name</span>
</span><span id="L-3140"><a href="#L-3140"><span class="linenos">3140</span></a>            <span class="k">if</span> <span class="n">well</span> <span class="o">==</span> <span class="s2">&quot;P24&quot;</span><span class="p">:</span>
</span><span id="L-3141"><a href="#L-3141"><span class="linenos">3141</span></a>                <span class="n">plate</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3142"><a href="#L-3142"><span class="linenos">3142</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_A01&quot;</span>
</span><span id="L-3143"><a href="#L-3143"><span class="linenos">3143</span></a>
</span><span id="L-3144"><a href="#L-3144"><span class="linenos">3144</span></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
</span><span id="L-3145"><a href="#L-3145"><span class="linenos">3145</span></a>
</span><span id="L-3146"><a href="#L-3146"><span class="linenos">3146</span></a>    <span class="n">files_by_region</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-3147"><a href="#L-3147"><span class="linenos">3147</span></a>    <span class="n">rename_log</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3148"><a href="#L-3148"><span class="linenos">3148</span></a>    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;rename_log.csv&quot;</span><span class="p">)</span>
</span><span id="L-3149"><a href="#L-3149"><span class="linenos">3149</span></a>    <span class="n">used_wells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-3150"><a href="#L-3150"><span class="linenos">3150</span></a>    <span class="n">region_to_well</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-3151"><a href="#L-3151"><span class="linenos">3151</span></a>
</span><span id="L-3152"><a href="#L-3152"><span class="linenos">3152</span></a>    <span class="c1"># Group files by (plateID, wellID, fieldID, timeID, chanID)</span>
</span><span id="L-3153"><a href="#L-3153"><span class="linenos">3153</span></a>    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="L-3154"><a href="#L-3154"><span class="linenos">3154</span></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-3155"><a href="#L-3155"><span class="linenos">3155</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
</span><span id="L-3156"><a href="#L-3156"><span class="linenos">3156</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: does not match regex.&quot;</span><span class="p">)</span>
</span><span id="L-3157"><a href="#L-3157"><span class="linenos">3157</span></a>            <span class="k">continue</span>
</span><span id="L-3158"><a href="#L-3158"><span class="linenos">3158</span></a>
</span><span id="L-3159"><a href="#L-3159"><span class="linenos">3159</span></a>        <span class="n">meta</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
</span><span id="L-3160"><a href="#L-3160"><span class="linenos">3160</span></a>
</span><span id="L-3161"><a href="#L-3161"><span class="linenos">3161</span></a>        <span class="c1"># Mandatory metadata</span>
</span><span id="L-3162"><a href="#L-3162"><span class="linenos">3162</span></a>        <span class="k">if</span> <span class="s1">&#39;wellID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">or</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;wellID&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3163"><a href="#L-3163"><span class="linenos">3163</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: missing mandatory wellID.&quot;</span><span class="p">)</span>
</span><span id="L-3164"><a href="#L-3164"><span class="linenos">3164</span></a>            <span class="k">continue</span>
</span><span id="L-3165"><a href="#L-3165"><span class="linenos">3165</span></a>        <span class="n">wellID</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;wellID&#39;</span><span class="p">]</span>
</span><span id="L-3166"><a href="#L-3166"><span class="linenos">3166</span></a>
</span><span id="L-3167"><a href="#L-3167"><span class="linenos">3167</span></a>        <span class="c1"># Optional metadata with defaults</span>
</span><span id="L-3168"><a href="#L-3168"><span class="linenos">3168</span></a>        <span class="n">plateID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span>
</span><span id="L-3169"><a href="#L-3169"><span class="linenos">3169</span></a>        <span class="n">fieldID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fieldID&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span>
</span><span id="L-3170"><a href="#L-3170"><span class="linenos">3170</span></a>        <span class="n">timeID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-3171"><a href="#L-3171"><span class="linenos">3171</span></a>        <span class="n">chanID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chanID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-3172"><a href="#L-3172"><span class="linenos">3172</span></a>        <span class="n">sliceID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sliceID&#39;</span><span class="p">)</span>
</span><span id="L-3173"><a href="#L-3173"><span class="linenos">3173</span></a>        <span class="n">sliceID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sliceID</span><span class="p">)</span> <span class="k">if</span> <span class="n">sliceID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-3174"><a href="#L-3174"><span class="linenos">3174</span></a>
</span><span id="L-3175"><a href="#L-3175"><span class="linenos">3175</span></a>        <span class="n">region_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plateID</span><span class="p">,</span> <span class="n">wellID</span><span class="p">,</span> <span class="n">fieldID</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">chanID</span><span class="p">)</span>
</span><span id="L-3176"><a href="#L-3176"><span class="linenos">3176</span></a>
</span><span id="L-3177"><a href="#L-3177"><span class="linenos">3177</span></a>        <span class="n">files_by_region</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">region_key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file</span><span class="p">,</span> <span class="n">sliceID</span><span class="p">))</span>
</span><span id="L-3178"><a href="#L-3178"><span class="linenos">3178</span></a>
</span><span id="L-3179"><a href="#L-3179"><span class="linenos">3179</span></a>    <span class="c1"># Assign wells and process files per region</span>
</span><span id="L-3180"><a href="#L-3180"><span class="linenos">3180</span></a>    <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">files_by_region</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-3181"><a href="#L-3181"><span class="linenos">3181</span></a>        <span class="k">if</span> <span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">region_to_well</span><span class="p">:</span>
</span><span id="L-3182"><a href="#L-3182"><span class="linenos">3182</span></a>            <span class="n">next_well</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>
</span><span id="L-3183"><a href="#L-3183"><span class="linenos">3183</span></a>            <span class="n">region_to_well</span><span class="p">[</span><span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">next_well</span>
</span><span id="L-3184"><a href="#L-3184"><span class="linenos">3184</span></a>            <span class="n">used_wells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_well</span><span class="p">)</span>
</span><span id="L-3185"><a href="#L-3185"><span class="linenos">3185</span></a>
</span><span id="L-3186"><a href="#L-3186"><span class="linenos">3186</span></a>        <span class="n">assigned_well</span> <span class="o">=</span> <span class="n">region_to_well</span><span class="p">[</span><span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="L-3187"><a href="#L-3187"><span class="linenos">3187</span></a>        <span class="n">plateID</span><span class="p">,</span> <span class="n">wellID</span><span class="p">,</span> <span class="n">fieldID</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">chanID</span> <span class="o">=</span> <span class="n">region</span>
</span><span id="L-3188"><a href="#L-3188"><span class="linenos">3188</span></a>
</span><span id="L-3189"><a href="#L-3189"><span class="linenos">3189</span></a>        <span class="c1"># Check if multiple slices exist and are meaningful</span>
</span><span id="L-3190"><a href="#L-3190"><span class="linenos">3190</span></a>        <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sid</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-3191"><a href="#L-3191"><span class="linenos">3191</span></a>        <span class="n">unique_slices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>
</span><span id="L-3192"><a href="#L-3192"><span class="linenos">3192</span></a>
</span><span id="L-3193"><a href="#L-3193"><span class="linenos">3193</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3194"><a href="#L-3194"><span class="linenos">3194</span></a>        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-3195"><a href="#L-3195"><span class="linenos">3195</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</span><span id="L-3196"><a href="#L-3196"><span class="linenos">3196</span></a>            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-3197"><a href="#L-3197"><span class="linenos">3197</span></a>
</span><span id="L-3198"><a href="#L-3198"><span class="linenos">3198</span></a>        <span class="c1"># Perform MIP only if multiple unique slices are present</span>
</span><span id="L-3199"><a href="#L-3199"><span class="linenos">3199</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_slices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-3200"><a href="#L-3200"><span class="linenos">3200</span></a>            <span class="n">img_to_save</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3201"><a href="#L-3201"><span class="linenos">3201</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3202"><a href="#L-3202"><span class="linenos">3202</span></a>            <span class="n">img_to_save</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3203"><a href="#L-3203"><span class="linenos">3203</span></a>
</span><span id="L-3204"><a href="#L-3204"><span class="linenos">3204</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">img_to_save</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-3205"><a href="#L-3205"><span class="linenos">3205</span></a>
</span><span id="L-3206"><a href="#L-3206"><span class="linenos">3206</span></a>        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assigned_well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">timeID</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fieldID</span><span class="p">)</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">chanID</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="L-3207"><a href="#L-3207"><span class="linenos">3207</span></a>        <span class="n">new_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>
</span><span id="L-3208"><a href="#L-3208"><span class="linenos">3208</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">new_filepath</span><span class="p">,</span> <span class="n">img_to_save</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="L-3209"><a href="#L-3209"><span class="linenos">3209</span></a>
</span><span id="L-3210"><a href="#L-3210"><span class="linenos">3210</span></a>        <span class="c1"># Log original filenames involved in MIP or single file rename</span>
</span><span id="L-3211"><a href="#L-3211"><span class="linenos">3211</span></a>        <span class="n">original_files</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">)</span>
</span><span id="L-3212"><a href="#L-3212"><span class="linenos">3212</span></a>        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File(s)&quot;</span><span class="p">:</span> <span class="n">original_files</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">new_filename</span><span class="p">})</span>
</span><span id="L-3213"><a href="#L-3213"><span class="linenos">3213</span></a>
</span><span id="L-3214"><a href="#L-3214"><span class="linenos">3214</span></a>    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rename_log</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3215"><a href="#L-3215"><span class="linenos">3215</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete. Files saved in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> and rename log saved as </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-3216"><a href="#L-3216"><span class="linenos">3216</span></a>    
</span><span id="L-3217"><a href="#L-3217"><span class="linenos">3217</span></a><span class="k">def</span> <span class="nf">convert_to_yokogawa</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="L-3218"><a href="#L-3218"><span class="linenos">3218</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3219"><a href="#L-3219"><span class="linenos">3219</span></a><span class="sd">    Detects file type in the folder and converts them</span>
</span><span id="L-3220"><a href="#L-3220"><span class="linenos">3220</span></a><span class="sd">    to Yokogawa-style naming with Maximum Intensity Projection (MIP).</span>
</span><span id="L-3221"><a href="#L-3221"><span class="linenos">3221</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3222"><a href="#L-3222"><span class="linenos">3222</span></a>    
</span><span id="L-3223"><a href="#L-3223"><span class="linenos">3223</span></a>    <span class="c1">#def _get_next_well(used_wells):</span>
</span><span id="L-3224"><a href="#L-3224"><span class="linenos">3224</span></a>    <span class="c1">#    &quot;&quot;&quot;</span>
</span><span id="L-3225"><a href="#L-3225"><span class="linenos">3225</span></a>    <span class="c1">#    Determines the next available well position in a 384-well format.</span>
</span><span id="L-3226"><a href="#L-3226"><span class="linenos">3226</span></a>    <span class="c1">#    Iterates wells, and after P24, switches to plate2.</span>
</span><span id="L-3227"><a href="#L-3227"><span class="linenos">3227</span></a>    <span class="c1">#    &quot;&quot;&quot;</span>
</span><span id="L-3228"><a href="#L-3228"><span class="linenos">3228</span></a>    <span class="c1">#    plate = 1</span>
</span><span id="L-3229"><a href="#L-3229"><span class="linenos">3229</span></a>    <span class="c1">#    for well in WELLS:</span>
</span><span id="L-3230"><a href="#L-3230"><span class="linenos">3230</span></a>    <span class="c1">#        well_name = f&quot;plate{plate}_{well}&quot;</span>
</span><span id="L-3231"><a href="#L-3231"><span class="linenos">3231</span></a>    <span class="c1">#        if well_name not in used_wells:</span>
</span><span id="L-3232"><a href="#L-3232"><span class="linenos">3232</span></a>    <span class="c1">#            used_wells.add(well_name)</span>
</span><span id="L-3233"><a href="#L-3233"><span class="linenos">3233</span></a>    <span class="c1">#            return well_name</span>
</span><span id="L-3234"><a href="#L-3234"><span class="linenos">3234</span></a>    <span class="c1">#        if well == &quot;P24&quot;:  </span>
</span><span id="L-3235"><a href="#L-3235"><span class="linenos">3235</span></a>    <span class="c1">#            plate += 1  </span>
</span><span id="L-3236"><a href="#L-3236"><span class="linenos">3236</span></a>    <span class="c1">#    raise ValueError(&quot;All wells exhausted.&quot;)</span>
</span><span id="L-3237"><a href="#L-3237"><span class="linenos">3237</span></a>    
</span><span id="L-3238"><a href="#L-3238"><span class="linenos">3238</span></a>    <span class="k">def</span> <span class="nf">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">):</span>
</span><span id="L-3239"><a href="#L-3239"><span class="linenos">3239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3240"><a href="#L-3240"><span class="linenos">3240</span></a><span class="sd">        Determines the next available well position across multiple 384-well plates.</span>
</span><span id="L-3241"><a href="#L-3241"><span class="linenos">3241</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-3242"><a href="#L-3242"><span class="linenos">3242</span></a>        <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
</span><span id="L-3243"><a href="#L-3243"><span class="linenos">3243</span></a>        <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</span><span id="L-3244"><a href="#L-3244"><span class="linenos">3244</span></a>        <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>
</span><span id="L-3245"><a href="#L-3245"><span class="linenos">3245</span></a>
</span><span id="L-3246"><a href="#L-3246"><span class="linenos">3246</span></a>        <span class="n">plate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3247"><a href="#L-3247"><span class="linenos">3247</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-3248"><a href="#L-3248"><span class="linenos">3248</span></a>            <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">WELLS</span><span class="p">:</span>
</span><span id="L-3249"><a href="#L-3249"><span class="linenos">3249</span></a>                <span class="n">well_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-3250"><a href="#L-3250"><span class="linenos">3250</span></a>                <span class="k">if</span> <span class="n">well_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_wells</span><span class="p">:</span>
</span><span id="L-3251"><a href="#L-3251"><span class="linenos">3251</span></a>                    <span class="n">used_wells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span>
</span><span id="L-3252"><a href="#L-3252"><span class="linenos">3252</span></a>                    <span class="k">return</span> <span class="n">well_name</span>
</span><span id="L-3253"><a href="#L-3253"><span class="linenos">3253</span></a>            <span class="n">plate</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># All wells exhausted in current plate, increment to next plate</span>
</span><span id="L-3254"><a href="#L-3254"><span class="linenos">3254</span></a>
</span><span id="L-3255"><a href="#L-3255"><span class="linenos">3255</span></a>
</span><span id="L-3256"><a href="#L-3256"><span class="linenos">3256</span></a>    <span class="c1"># Define 384-well plate format</span>
</span><span id="L-3257"><a href="#L-3257"><span class="linenos">3257</span></a>    <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
</span><span id="L-3258"><a href="#L-3258"><span class="linenos">3258</span></a>    <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</span><span id="L-3259"><a href="#L-3259"><span class="linenos">3259</span></a>    <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>
</span><span id="L-3260"><a href="#L-3260"><span class="linenos">3260</span></a>
</span><span id="L-3261"><a href="#L-3261"><span class="linenos">3261</span></a>    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3262"><a href="#L-3262"><span class="linenos">3262</span></a>    <span class="n">rename_log</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3263"><a href="#L-3263"><span class="linenos">3263</span></a>    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;rename_log.csv&quot;</span><span class="p">)</span>
</span><span id="L-3264"><a href="#L-3264"><span class="linenos">3264</span></a>    <span class="n">used_wells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-3265"><a href="#L-3265"><span class="linenos">3265</span></a>
</span><span id="L-3266"><a href="#L-3266"><span class="linenos">3266</span></a>    <span class="c1"># **Dictionary to store well assignments per original file**</span>
</span><span id="L-3267"><a href="#L-3267"><span class="linenos">3267</span></a>    <span class="n">file_to_well</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-3268"><a href="#L-3268"><span class="linenos">3268</span></a>
</span><span id="L-3269"><a href="#L-3269"><span class="linenos">3269</span></a>    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="L-3270"><a href="#L-3270"><span class="linenos">3270</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="L-3271"><a href="#L-3271"><span class="linenos">3271</span></a>        <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-3272"><a href="#L-3272"><span class="linenos">3272</span></a>
</span><span id="L-3273"><a href="#L-3273"><span class="linenos">3273</span></a>        <span class="c1"># **Assign a well only once per original file**</span>
</span><span id="L-3274"><a href="#L-3274"><span class="linenos">3274</span></a>        <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_to_well</span><span class="p">:</span>
</span><span id="L-3275"><a href="#L-3275"><span class="linenos">3275</span></a>            <span class="n">file_to_well</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>
</span><span id="L-3276"><a href="#L-3276"><span class="linenos">3276</span></a>            <span class="c1">#used_wells.add(file_to_well[file])  # Mark it as used</span>
</span><span id="L-3277"><a href="#L-3277"><span class="linenos">3277</span></a>
</span><span id="L-3278"><a href="#L-3278"><span class="linenos">3278</span></a>        <span class="n">well</span> <span class="o">=</span> <span class="n">file_to_well</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>  <span class="c1"># Use the same well for all channels/times</span>
</span><span id="L-3279"><a href="#L-3279"><span class="linenos">3279</span></a>
</span><span id="L-3280"><a href="#L-3280"><span class="linenos">3280</span></a>        <span class="c1">### **Process Nikon ND2 Files**</span>
</span><span id="L-3281"><a href="#L-3281"><span class="linenos">3281</span></a>        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;nd2&#39;</span><span class="p">:</span>
</span><span id="L-3282"><a href="#L-3282"><span class="linenos">3282</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3283"><a href="#L-3283"><span class="linenos">3283</span></a>                <span class="n">nd2</span> <span class="o">=</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-3284"><a href="#L-3284"><span class="linenos">3284</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">nd2</span><span class="o">.</span><span class="n">metadata</span>
</span><span id="L-3285"><a href="#L-3285"><span class="linenos">3285</span></a>
</span><span id="L-3286"><a href="#L-3286"><span class="linenos">3286</span></a>                <span class="n">timepoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frames&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3287"><a href="#L-3287"><span class="linenos">3287</span></a>                <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields_of_view&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3288"><a href="#L-3288"><span class="linenos">3288</span></a>                <span class="n">z_levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_levels&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_levels&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3289"><a href="#L-3289"><span class="linenos">3289</span></a>                <span class="n">channels</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channels&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-3290"><a href="#L-3290"><span class="linenos">3290</span></a>
</span><span id="L-3291"><a href="#L-3291"><span class="linenos">3291</span></a>                <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="n">timepoints</span><span class="p">:</span>
</span><span id="L-3292"><a href="#L-3292"><span class="linenos">3292</span></a>                    <span class="k">for</span> <span class="n">f_idx</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span><span id="L-3293"><a href="#L-3293"><span class="linenos">3293</span></a>                        <span class="k">for</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
</span><span id="L-3294"><a href="#L-3294"><span class="linenos">3294</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3295"><a href="#L-3295"><span class="linenos">3295</span></a>                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span>
</span><span id="L-3296"><a href="#L-3296"><span class="linenos">3296</span></a>                                    <span class="n">nd2</span><span class="o">.</span><span class="n">get_frame_2D</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">f_idx</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_idx</span><span class="p">)</span> 
</span><span id="L-3297"><a href="#L-3297"><span class="linenos">3297</span></a>                                    <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="n">z_levels</span>
</span><span id="L-3298"><a href="#L-3298"><span class="linenos">3298</span></a>                                <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3299"><a href="#L-3299"><span class="linenos">3299</span></a>
</span><span id="L-3300"><a href="#L-3300"><span class="linenos">3300</span></a>                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-3301"><a href="#L-3301"><span class="linenos">3301</span></a>                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="n">f_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="L-3302"><a href="#L-3302"><span class="linenos">3302</span></a>                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-3303"><a href="#L-3303"><span class="linenos">3303</span></a>
</span><span id="L-3304"><a href="#L-3304"><span class="linenos">3304</span></a>                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="L-3305"><a href="#L-3305"><span class="linenos">3305</span></a>                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3306"><a href="#L-3306"><span class="linenos">3306</span></a>
</span><span id="L-3307"><a href="#L-3307"><span class="linenos">3307</span></a>                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-3308"><a href="#L-3308"><span class="linenos">3308</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: ND2 file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has an incomplete data structure. Skipping.&quot;</span><span class="p">)</span>
</span><span id="L-3309"><a href="#L-3309"><span class="linenos">3309</span></a>
</span><span id="L-3310"><a href="#L-3310"><span class="linenos">3310</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-3311"><a href="#L-3311"><span class="linenos">3311</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing ND2 file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3312"><a href="#L-3312"><span class="linenos">3312</span></a>
</span><span id="L-3313"><a href="#L-3313"><span class="linenos">3313</span></a>        <span class="c1">### **Process Zeiss CZI Files**</span>
</span><span id="L-3314"><a href="#L-3314"><span class="linenos">3314</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;czi&#39;</span><span class="p">:</span>
</span><span id="L-3315"><a href="#L-3315"><span class="linenos">3315</span></a>            <span class="k">with</span> <span class="n">czifile</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czi</span><span class="p">:</span>
</span><span id="L-3316"><a href="#L-3316"><span class="linenos">3316</span></a>                <span class="n">img_data</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>  <span class="c1"># Read the full image array</span>
</span><span id="L-3317"><a href="#L-3317"><span class="linenos">3317</span></a>
</span><span id="L-3318"><a href="#L-3318"><span class="linenos">3318</span></a>                <span class="c1"># Remove singleton dimensions (if any)</span>
</span><span id="L-3319"><a href="#L-3319"><span class="linenos">3319</span></a>                <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
</span><span id="L-3320"><a href="#L-3320"><span class="linenos">3320</span></a>
</span><span id="L-3321"><a href="#L-3321"><span class="linenos">3321</span></a>                <span class="c1"># Get the actual shape of the data</span>
</span><span id="L-3322"><a href="#L-3322"><span class="linenos">3322</span></a>                <span class="n">shape</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-3323"><a href="#L-3323"><span class="linenos">3323</span></a>                <span class="n">num_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-3324"><a href="#L-3324"><span class="linenos">3324</span></a>
</span><span id="L-3325"><a href="#L-3325"><span class="linenos">3325</span></a>                <span class="c1"># Default values if dimensions are missing</span>
</span><span id="L-3326"><a href="#L-3326"><span class="linenos">3326</span></a>                <span class="n">timepoints</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3327"><a href="#L-3327"><span class="linenos">3327</span></a>                <span class="n">z_levels</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3328"><a href="#L-3328"><span class="linenos">3328</span></a>                <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3329"><a href="#L-3329"><span class="linenos">3329</span></a>
</span><span id="L-3330"><a href="#L-3330"><span class="linenos">3330</span></a>                <span class="c1"># Determine dimension mapping dynamically</span>
</span><span id="L-3331"><a href="#L-3331"><span class="linenos">3331</span></a>                <span class="k">if</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># (Y, X)  Single 2D image</span>
</span><span id="L-3332"><a href="#L-3332"><span class="linenos">3332</span></a>                    <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="L-3333"><a href="#L-3333"><span class="linenos">3333</span></a>                    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing dimensions</span>
</span><span id="L-3334"><a href="#L-3334"><span class="linenos">3334</span></a>                <span class="k">elif</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># (C, Y, X) or (Z, Y, X)</span>
</span><span id="L-3335"><a href="#L-3335"><span class="linenos">3335</span></a>                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Likely (C, Y, X)</span>
</span><span id="L-3336"><a href="#L-3336"><span class="linenos">3336</span></a>                        <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="L-3337"><a href="#L-3337"><span class="linenos">3337</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing dimensions</span>
</span><span id="L-3338"><a href="#L-3338"><span class="linenos">3338</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Likely (Z, Y, X)</span>
</span><span id="L-3339"><a href="#L-3339"><span class="linenos">3339</span></a>                        <span class="n">z_levels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="L-3340"><a href="#L-3340"><span class="linenos">3340</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing dimensions</span>
</span><span id="L-3341"><a href="#L-3341"><span class="linenos">3341</span></a>                <span class="k">elif</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Could be (T, C, Y, X) or (T, Z, Y, X) or (Z, C, Y, X)</span>
</span><span id="L-3342"><a href="#L-3342"><span class="linenos">3342</span></a>                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Assume (T, C, Y, X)</span>
</span><span id="L-3343"><a href="#L-3343"><span class="linenos">3343</span></a>                        <span class="n">timepoints</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="L-3344"><a href="#L-3344"><span class="linenos">3344</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing Z</span>
</span><span id="L-3345"><a href="#L-3345"><span class="linenos">3345</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Assume (T, Z, Y, X) or (Z, C, Y, X)</span>
</span><span id="L-3346"><a href="#L-3346"><span class="linenos">3346</span></a>                        <span class="n">timepoints</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="L-3347"><a href="#L-3347"><span class="linenos">3347</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing C</span>
</span><span id="L-3348"><a href="#L-3348"><span class="linenos">3348</span></a>                <span class="k">elif</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Standard (T, Z, C, Y, X)</span>
</span><span id="L-3349"><a href="#L-3349"><span class="linenos">3349</span></a>                    <span class="n">timepoints</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="L-3350"><a href="#L-3350"><span class="linenos">3350</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-3351"><a href="#L-3351"><span class="linenos">3351</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected CZI shape: </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Unable to process.&quot;</span><span class="p">)</span>
</span><span id="L-3352"><a href="#L-3352"><span class="linenos">3352</span></a>
</span><span id="L-3353"><a href="#L-3353"><span class="linenos">3353</span></a>                <span class="c1"># Iterate over detected timepoints, channels, and perform MIP over Z</span>
</span><span id="L-3354"><a href="#L-3354"><span class="linenos">3354</span></a>                <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timepoints</span><span class="p">):</span>
</span><span id="L-3355"><a href="#L-3355"><span class="linenos">3355</span></a>                    <span class="k">for</span> <span class="n">c_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
</span><span id="L-3356"><a href="#L-3356"><span class="linenos">3356</span></a>                        <span class="c1"># Extract Z-stack or single image</span>
</span><span id="L-3357"><a href="#L-3357"><span class="linenos">3357</span></a>                        <span class="k">if</span> <span class="n">z_levels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-3358"><a href="#L-3358"><span class="linenos">3358</span></a>                            <span class="n">z_stack</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># MIP over Z</span>
</span><span id="L-3359"><a href="#L-3359"><span class="linenos">3359</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3360"><a href="#L-3360"><span class="linenos">3360</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3361"><a href="#L-3361"><span class="linenos">3361</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># No Z, take directly</span>
</span><span id="L-3362"><a href="#L-3362"><span class="linenos">3362</span></a>
</span><span id="L-3363"><a href="#L-3363"><span class="linenos">3363</span></a>                        <span class="c1"># Ensure correct dtype</span>
</span><span id="L-3364"><a href="#L-3364"><span class="linenos">3364</span></a>                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-3365"><a href="#L-3365"><span class="linenos">3365</span></a>
</span><span id="L-3366"><a href="#L-3366"><span class="linenos">3366</span></a>                        <span class="c1"># Generate Yokogawa-style filename</span>
</span><span id="L-3367"><a href="#L-3367"><span class="linenos">3367</span></a>                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F001L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="L-3368"><a href="#L-3368"><span class="linenos">3368</span></a>                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-3369"><a href="#L-3369"><span class="linenos">3369</span></a>
</span><span id="L-3370"><a href="#L-3370"><span class="linenos">3370</span></a>                        <span class="c1"># Save the extracted image</span>
</span><span id="L-3371"><a href="#L-3371"><span class="linenos">3371</span></a>                        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="L-3372"><a href="#L-3372"><span class="linenos">3372</span></a>
</span><span id="L-3373"><a href="#L-3373"><span class="linenos">3373</span></a>                        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3374"><a href="#L-3374"><span class="linenos">3374</span></a>
</span><span id="L-3375"><a href="#L-3375"><span class="linenos">3375</span></a>        <span class="c1">### **Process Leica LIF Files**</span>
</span><span id="L-3376"><a href="#L-3376"><span class="linenos">3376</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;lif&#39;</span><span class="p">:</span>
</span><span id="L-3377"><a href="#L-3377"><span class="linenos">3377</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3378"><a href="#L-3378"><span class="linenos">3378</span></a>                <span class="n">lif_file</span> <span class="o">=</span> <span class="n">readlif</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-3379"><a href="#L-3379"><span class="linenos">3379</span></a>
</span><span id="L-3380"><a href="#L-3380"><span class="linenos">3380</span></a>                <span class="k">for</span> <span class="n">image_idx</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lif_file</span><span class="o">.</span><span class="n">getIterImage</span><span class="p">()):</span>
</span><span id="L-3381"><a href="#L-3381"><span class="linenos">3381</span></a>                    <span class="n">timepoints</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-3382"><a href="#L-3382"><span class="linenos">3382</span></a>                    <span class="n">z_levels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-3383"><a href="#L-3383"><span class="linenos">3383</span></a>                    <span class="n">channels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-3384"><a href="#L-3384"><span class="linenos">3384</span></a>
</span><span id="L-3385"><a href="#L-3385"><span class="linenos">3385</span></a>                    <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="n">timepoints</span><span class="p">:</span>
</span><span id="L-3386"><a href="#L-3386"><span class="linenos">3386</span></a>                        <span class="k">for</span> <span class="n">c_idx</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="L-3387"><a href="#L-3387"><span class="linenos">3387</span></a>                            <span class="n">z_stack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3388"><a href="#L-3388"><span class="linenos">3388</span></a>                            <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="n">z_levels</span><span class="p">:</span>
</span><span id="L-3389"><a href="#L-3389"><span class="linenos">3389</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="L-3390"><a href="#L-3390"><span class="linenos">3390</span></a>                                    <span class="n">frame</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">getFrame</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_idx</span><span class="p">)</span>
</span><span id="L-3391"><a href="#L-3391"><span class="linenos">3391</span></a>                                    <span class="n">z_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span><span id="L-3392"><a href="#L-3392"><span class="linenos">3392</span></a>                                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-3393"><a href="#L-3393"><span class="linenos">3393</span></a>                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing frame: T</span><span class="si">{</span><span class="n">t_idx</span><span class="si">}</span><span class="s2">, Z</span><span class="si">{</span><span class="n">z_idx</span><span class="si">}</span><span class="s2">, C</span><span class="si">{</span><span class="n">c_idx</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">, skipping frame.&quot;</span><span class="p">)</span>
</span><span id="L-3394"><a href="#L-3394"><span class="linenos">3394</span></a>                            
</span><span id="L-3395"><a href="#L-3395"><span class="linenos">3395</span></a>                            <span class="k">if</span> <span class="n">z_stack</span><span class="p">:</span>
</span><span id="L-3396"><a href="#L-3396"><span class="linenos">3396</span></a>                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">z_stack</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3397"><a href="#L-3397"><span class="linenos">3397</span></a>                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-3398"><a href="#L-3398"><span class="linenos">3398</span></a>                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="n">image_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="L-3399"><a href="#L-3399"><span class="linenos">3399</span></a>                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-3400"><a href="#L-3400"><span class="linenos">3400</span></a>
</span><span id="L-3401"><a href="#L-3401"><span class="linenos">3401</span></a>                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="L-3402"><a href="#L-3402"><span class="linenos">3402</span></a>                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3403"><a href="#L-3403"><span class="linenos">3403</span></a>
</span><span id="L-3404"><a href="#L-3404"><span class="linenos">3404</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-3405"><a href="#L-3405"><span class="linenos">3405</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing LIF file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3406"><a href="#L-3406"><span class="linenos">3406</span></a>
</span><span id="L-3407"><a href="#L-3407"><span class="linenos">3407</span></a>        <span class="c1">### **Process Standard Image Files (TIFF, PNG, JPEG, BMP)**</span>
</span><span id="L-3408"><a href="#L-3408"><span class="linenos">3408</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;bmp&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;plate&quot;</span><span class="p">):</span>
</span><span id="L-3409"><a href="#L-3409"><span class="linenos">3409</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3410"><a href="#L-3410"><span class="linenos">3410</span></a>                <span class="k">with</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
</span><span id="L-3411"><a href="#L-3411"><span class="linenos">3411</span></a>                    <span class="n">images</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
</span><span id="L-3412"><a href="#L-3412"><span class="linenos">3412</span></a>                    <span class="n">ndim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">ndim</span>
</span><span id="L-3413"><a href="#L-3413"><span class="linenos">3413</span></a>
</span><span id="L-3414"><a href="#L-3414"><span class="linenos">3414</span></a>                    <span class="c1"># Defaults</span>
</span><span id="L-3415"><a href="#L-3415"><span class="linenos">3415</span></a>                    <span class="n">t_dim</span> <span class="o">=</span> <span class="n">z_dim</span> <span class="o">=</span> <span class="n">c_dim</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-3416"><a href="#L-3416"><span class="linenos">3416</span></a>
</span><span id="L-3417"><a href="#L-3417"><span class="linenos">3417</span></a>                    <span class="c1"># Determine dimensions more explicitly</span>
</span><span id="L-3418"><a href="#L-3418"><span class="linenos">3418</span></a>                    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-3419"><a href="#L-3419"><span class="linenos">3419</span></a>                        <span class="n">mip_image</span> <span class="o">=</span> <span class="n">images</span>
</span><span id="L-3420"><a href="#L-3420"><span class="linenos">3420</span></a>                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C01.tif&quot;</span>
</span><span id="L-3421"><a href="#L-3421"><span class="linenos">3421</span></a>                        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="L-3422"><a href="#L-3422"><span class="linenos">3422</span></a>                        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3423"><a href="#L-3423"><span class="linenos">3423</span></a>                        <span class="k">continue</span>
</span><span id="L-3424"><a href="#L-3424"><span class="linenos">3424</span></a>
</span><span id="L-3425"><a href="#L-3425"><span class="linenos">3425</span></a>                    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-3426"><a href="#L-3426"><span class="linenos">3426</span></a>                        <span class="k">if</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Likely channels</span>
</span><span id="L-3427"><a href="#L-3427"><span class="linenos">3427</span></a>                            <span class="n">c_dim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3428"><a href="#L-3428"><span class="linenos">3428</span></a>                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c_dim</span><span class="p">):</span>
</span><span id="L-3429"><a href="#L-3429"><span class="linenos">3429</span></a>                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-3430"><a href="#L-3430"><span class="linenos">3430</span></a>                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C</span><span class="si">{</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="L-3431"><a href="#L-3431"><span class="linenos">3431</span></a>                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="L-3432"><a href="#L-3432"><span class="linenos">3432</span></a>                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3433"><a href="#L-3433"><span class="linenos">3433</span></a>                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Z-stack</span>
</span><span id="L-3434"><a href="#L-3434"><span class="linenos">3434</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3435"><a href="#L-3435"><span class="linenos">3435</span></a>                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C01.tif&quot;</span>
</span><span id="L-3436"><a href="#L-3436"><span class="linenos">3436</span></a>                            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="L-3437"><a href="#L-3437"><span class="linenos">3437</span></a>                            <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3438"><a href="#L-3438"><span class="linenos">3438</span></a>
</span><span id="L-3439"><a href="#L-3439"><span class="linenos">3439</span></a>                    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-3440"><a href="#L-3440"><span class="linenos">3440</span></a>                        <span class="n">t_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-3441"><a href="#L-3441"><span class="linenos">3441</span></a>                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_dim</span><span class="p">):</span>
</span><span id="L-3442"><a href="#L-3442"><span class="linenos">3442</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-3443"><a href="#L-3443"><span class="linenos">3443</span></a>                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F001L01C01.tif&quot;</span>
</span><span id="L-3444"><a href="#L-3444"><span class="linenos">3444</span></a>                            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="L-3445"><a href="#L-3445"><span class="linenos">3445</span></a>                            <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="L-3446"><a href="#L-3446"><span class="linenos">3446</span></a>
</span><span id="L-3447"><a href="#L-3447"><span class="linenos">3447</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-3448"><a href="#L-3448"><span class="linenos">3448</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported TIFF dimensions: </span><span class="si">{</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3449"><a href="#L-3449"><span class="linenos">3449</span></a>
</span><span id="L-3450"><a href="#L-3450"><span class="linenos">3450</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-3451"><a href="#L-3451"><span class="linenos">3451</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing standard image file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3452"><a href="#L-3452"><span class="linenos">3452</span></a>
</span><span id="L-3453"><a href="#L-3453"><span class="linenos">3453</span></a>
</span><span id="L-3454"><a href="#L-3454"><span class="linenos">3454</span></a>    <span class="c1"># Save rename log as CSV</span>
</span><span id="L-3455"><a href="#L-3455"><span class="linenos">3455</span></a>    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rename_log</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3456"><a href="#L-3456"><span class="linenos">3456</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete. Files saved in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> and rename log saved as </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-3457"><a href="#L-3457"><span class="linenos">3457</span></a>    
</span><span id="L-3458"><a href="#L-3458"><span class="linenos">3458</span></a><span class="k">def</span> <span class="nf">apply_augmentation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
</span><span id="L-3459"><a href="#L-3459"><span class="linenos">3459</span></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate90&#39;</span><span class="p">:</span>
</span><span id="L-3460"><a href="#L-3460"><span class="linenos">3460</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_90_CLOCKWISE</span><span class="p">)</span>
</span><span id="L-3461"><a href="#L-3461"><span class="linenos">3461</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate180&#39;</span><span class="p">:</span>
</span><span id="L-3462"><a href="#L-3462"><span class="linenos">3462</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_180</span><span class="p">)</span>
</span><span id="L-3463"><a href="#L-3463"><span class="linenos">3463</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate270&#39;</span><span class="p">:</span>
</span><span id="L-3464"><a href="#L-3464"><span class="linenos">3464</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_90_COUNTERCLOCKWISE</span><span class="p">)</span>
</span><span id="L-3465"><a href="#L-3465"><span class="linenos">3465</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flip_h&#39;</span><span class="p">:</span>
</span><span id="L-3466"><a href="#L-3466"><span class="linenos">3466</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-3467"><a href="#L-3467"><span class="linenos">3467</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flip_v&#39;</span><span class="p">:</span>
</span><span id="L-3468"><a href="#L-3468"><span class="linenos">3468</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-3469"><a href="#L-3469"><span class="linenos">3469</span></a>    <span class="k">return</span> <span class="n">image</span>
</span><span id="L-3470"><a href="#L-3470"><span class="linenos">3470</span></a>
</span><span id="L-3471"><a href="#L-3471"><span class="linenos">3471</span></a><span class="k">def</span> <span class="nf">process_instruction</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
</span><span id="L-3472"><a href="#L-3472"><span class="linenos">3472</span></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src_img&quot;</span><span class="p">])</span>
</span><span id="L-3473"><a href="#L-3473"><span class="linenos">3473</span></a>    <span class="n">msk</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src_msk&quot;</span><span class="p">])</span>
</span><span id="L-3474"><a href="#L-3474"><span class="linenos">3474</span></a>    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">]:</span>
</span><span id="L-3475"><a href="#L-3475"><span class="linenos">3475</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">apply_augmentation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">])</span>
</span><span id="L-3476"><a href="#L-3476"><span class="linenos">3476</span></a>        <span class="n">msk</span> <span class="o">=</span> <span class="n">apply_augmentation</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">])</span>
</span><span id="L-3477"><a href="#L-3477"><span class="linenos">3477</span></a>    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dst_img&quot;</span><span class="p">],</span> <span class="n">img</span><span class="p">)</span>
</span><span id="L-3478"><a href="#L-3478"><span class="linenos">3478</span></a>    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dst_msk&quot;</span><span class="p">],</span> <span class="n">msk</span><span class="p">)</span>
</span><span id="L-3479"><a href="#L-3479"><span class="linenos">3479</span></a>    <span class="k">return</span> <span class="mi">1</span>
</span><span id="L-3480"><a href="#L-3480"><span class="linenos">3480</span></a>
</span><span id="L-3481"><a href="#L-3481"><span class="linenos">3481</span></a><span class="k">def</span> <span class="nf">prepare_cellpose_dataset</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="n">augment_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_fraction</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-3482"><a href="#L-3482"><span class="linenos">3482</span></a>    
</span><span id="L-3483"><a href="#L-3483"><span class="linenos">3483</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="L-3484"><a href="#L-3484"><span class="linenos">3484</span></a>
</span><span id="L-3485"><a href="#L-3485"><span class="linenos">3485</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3486"><a href="#L-3486"><span class="linenos">3486</span></a>    <span class="n">input_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_root</span><span class="p">)</span>
</span><span id="L-3487"><a href="#L-3487"><span class="linenos">3487</span></a>    <span class="n">output_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="s2">&quot;cellpose_dataset&quot;</span><span class="p">)</span>
</span><span id="L-3488"><a href="#L-3488"><span class="linenos">3488</span></a>
</span><span id="L-3489"><a href="#L-3489"><span class="linenos">3489</span></a>    <span class="k">def</span> <span class="nf">get_augmentations</span><span class="p">():</span>
</span><span id="L-3490"><a href="#L-3490"><span class="linenos">3490</span></a>        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;rotate90&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate180&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate270&#39;</span><span class="p">,</span> <span class="s1">&#39;flip_h&#39;</span><span class="p">,</span> <span class="s1">&#39;flip_v&#39;</span><span class="p">]</span>
</span><span id="L-3491"><a href="#L-3491"><span class="linenos">3491</span></a>
</span><span id="L-3492"><a href="#L-3492"><span class="linenos">3492</span></a>    <span class="k">def</span> <span class="nf">find_image_mask_pairs</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">):</span>
</span><span id="L-3493"><a href="#L-3493"><span class="linenos">3493</span></a>        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)</span>
</span><span id="L-3494"><a href="#L-3494"><span class="linenos">3494</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3495"><a href="#L-3495"><span class="linenos">3495</span></a>        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">):</span>
</span><span id="L-3496"><a href="#L-3496"><span class="linenos">3496</span></a>            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
</span><span id="L-3497"><a href="#L-3497"><span class="linenos">3497</span></a>                <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="L-3498"><a href="#L-3498"><span class="linenos">3498</span></a>                <span class="n">msk_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="L-3499"><a href="#L-3499"><span class="linenos">3499</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">msk_path</span><span class="p">):</span>
</span><span id="L-3500"><a href="#L-3500"><span class="linenos">3500</span></a>                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">))</span>
</span><span id="L-3501"><a href="#L-3501"><span class="linenos">3501</span></a>        <span class="k">return</span> <span class="n">pairs</span>
</span><span id="L-3502"><a href="#L-3502"><span class="linenos">3502</span></a>
</span><span id="L-3503"><a href="#L-3503"><span class="linenos">3503</span></a>    <span class="k">def</span> <span class="nf">prepare_output_folders</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
</span><span id="L-3504"><a href="#L-3504"><span class="linenos">3504</span></a>        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="L-3505"><a href="#L-3505"><span class="linenos">3505</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3506"><a href="#L-3506"><span class="linenos">3506</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3507"><a href="#L-3507"><span class="linenos">3507</span></a>
</span><span id="L-3508"><a href="#L-3508"><span class="linenos">3508</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scanning datasets...&quot;</span><span class="p">)</span>
</span><span id="L-3509"><a href="#L-3509"><span class="linenos">3509</span></a>    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3510"><a href="#L-3510"><span class="linenos">3510</span></a>    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_root</span><span class="p">):</span>
</span><span id="L-3511"><a href="#L-3511"><span class="linenos">3511</span></a>        <span class="n">dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>
</span><span id="L-3512"><a href="#L-3512"><span class="linenos">3512</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)):</span>
</span><span id="L-3513"><a href="#L-3513"><span class="linenos">3513</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">find_image_mask_pairs</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>
</span><span id="L-3514"><a href="#L-3514"><span class="linenos">3514</span></a>            <span class="k">if</span> <span class="n">pairs</span><span class="p">:</span>
</span><span id="L-3515"><a href="#L-3515"><span class="linenos">3515</span></a>                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</span><span id="L-3516"><a href="#L-3516"><span class="linenos">3516</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> images in </span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3517"><a href="#L-3517"><span class="linenos">3517</span></a>
</span><span id="L-3518"><a href="#L-3518"><span class="linenos">3518</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
</span><span id="L-3519"><a href="#L-3519"><span class="linenos">3519</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid datasets with images and masks found.&quot;</span><span class="p">)</span>
</span><span id="L-3520"><a href="#L-3520"><span class="linenos">3520</span></a>
</span><span id="L-3521"><a href="#L-3521"><span class="linenos">3521</span></a>    <span class="n">prepare_output_folders</span><span class="p">(</span><span class="n">output_root</span><span class="p">)</span>
</span><span id="L-3522"><a href="#L-3522"><span class="linenos">3522</span></a>
</span><span id="L-3523"><a href="#L-3523"><span class="linenos">3523</span></a>    <span class="n">min_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>
</span><span id="L-3524"><a href="#L-3524"><span class="linenos">3524</span></a>    <span class="n">target_size</span> <span class="o">=</span> <span class="n">min_size</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">augment_data</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>
</span><span id="L-3525"><a href="#L-3525"><span class="linenos">3525</span></a>
</span><span id="L-3526"><a href="#L-3526"><span class="linenos">3526</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Preparing instruction list...&quot;</span><span class="p">)</span>
</span><span id="L-3527"><a href="#L-3527"><span class="linenos">3527</span></a>    <span class="n">instructions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3528"><a href="#L-3528"><span class="linenos">3528</span></a>    <span class="n">global_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3529"><a href="#L-3529"><span class="linenos">3529</span></a>
</span><span id="L-3530"><a href="#L-3530"><span class="linenos">3530</span></a>    <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
</span><span id="L-3531"><a href="#L-3531"><span class="linenos">3531</span></a>        <span class="n">dataset_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</span><span id="L-3532"><a href="#L-3532"><span class="linenos">3532</span></a>
</span><span id="L-3533"><a href="#L-3533"><span class="linenos">3533</span></a>        <span class="c1"># --- Step 1: Sample or augment ---</span>
</span><span id="L-3534"><a href="#L-3534"><span class="linenos">3534</span></a>        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3535"><a href="#L-3535"><span class="linenos">3535</span></a>        <span class="k">if</span> <span class="n">dataset_len</span> <span class="o">&gt;=</span> <span class="n">target_size</span><span class="p">:</span>
</span><span id="L-3536"><a href="#L-3536"><span class="linenos">3536</span></a>            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
</span><span id="L-3537"><a href="#L-3537"><span class="linenos">3537</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3538"><a href="#L-3538"><span class="linenos">3538</span></a>            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-3539"><a href="#L-3539"><span class="linenos">3539</span></a>            <span class="k">if</span> <span class="n">augment_data</span><span class="p">:</span>
</span><span id="L-3540"><a href="#L-3540"><span class="linenos">3540</span></a>                <span class="n">needed</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">-</span> <span class="n">dataset_len</span>
</span><span id="L-3541"><a href="#L-3541"><span class="linenos">3541</span></a>                <span class="n">aug_methods</span> <span class="o">=</span> <span class="n">get_augmentations</span><span class="p">()</span>
</span><span id="L-3542"><a href="#L-3542"><span class="linenos">3542</span></a>                <span class="n">full_loops</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">)</span>
</span><span id="L-3543"><a href="#L-3543"><span class="linenos">3543</span></a>                <span class="n">extra</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">)</span>
</span><span id="L-3544"><a href="#L-3544"><span class="linenos">3544</span></a>
</span><span id="L-3545"><a href="#L-3545"><span class="linenos">3545</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_loops</span><span class="p">):</span>
</span><span id="L-3546"><a href="#L-3546"><span class="linenos">3546</span></a>                    <span class="k">for</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">),</span> <span class="n">aug</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">aug_methods</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset_len</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">))):</span>
</span><span id="L-3547"><a href="#L-3547"><span class="linenos">3547</span></a>                        <span class="n">sampled_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span><span class="p">))</span>
</span><span id="L-3548"><a href="#L-3548"><span class="linenos">3548</span></a>                <span class="k">if</span> <span class="n">extra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3549"><a href="#L-3549"><span class="linenos">3549</span></a>                    <span class="n">subset</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pairs</span> <span class="o">*</span> <span class="p">((</span><span class="n">extra</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">extra</span><span class="p">)</span>
</span><span id="L-3550"><a href="#L-3550"><span class="linenos">3550</span></a>                    <span class="k">for</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">),</span> <span class="n">aug</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">aug_methods</span><span class="p">[:</span><span class="n">extra</span><span class="p">]):</span>
</span><span id="L-3551"><a href="#L-3551"><span class="linenos">3551</span></a>                        <span class="n">sampled_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span><span class="p">))</span>
</span><span id="L-3552"><a href="#L-3552"><span class="linenos">3552</span></a>
</span><span id="L-3553"><a href="#L-3553"><span class="linenos">3553</span></a>        <span class="c1"># Add &quot;no augmentation&quot; tag to original files</span>
</span><span id="L-3554"><a href="#L-3554"><span class="linenos">3554</span></a>        <span class="n">augmented_sampled</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-3555"><a href="#L-3555"><span class="linenos">3555</span></a>            <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">tup</span>
</span><span id="L-3556"><a href="#L-3556"><span class="linenos">3556</span></a>            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">sampled_pairs</span>
</span><span id="L-3557"><a href="#L-3557"><span class="linenos">3557</span></a>        <span class="p">]</span>
</span><span id="L-3558"><a href="#L-3558"><span class="linenos">3558</span></a>
</span><span id="L-3559"><a href="#L-3559"><span class="linenos">3559</span></a>        <span class="c1"># --- Step 2: Split into train/test ---</span>
</span><span id="L-3560"><a href="#L-3560"><span class="linenos">3560</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">augmented_sampled</span><span class="p">)</span>
</span><span id="L-3561"><a href="#L-3561"><span class="linenos">3561</span></a>        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_fraction</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">augmented_sampled</span><span class="p">))</span>
</span><span id="L-3562"><a href="#L-3562"><span class="linenos">3562</span></a>        <span class="n">split_sets</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-3563"><a href="#L-3563"><span class="linenos">3563</span></a>            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">augmented_sampled</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span>
</span><span id="L-3564"><a href="#L-3564"><span class="linenos">3564</span></a>            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">augmented_sampled</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
</span><span id="L-3565"><a href="#L-3565"><span class="linenos">3565</span></a>        <span class="p">}</span>
</span><span id="L-3566"><a href="#L-3566"><span class="linenos">3566</span></a>
</span><span id="L-3567"><a href="#L-3567"><span class="linenos">3567</span></a>        <span class="k">for</span> <span class="n">subset</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">split_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-3568"><a href="#L-3568"><span class="linenos">3568</span></a>            <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
</span><span id="L-3569"><a href="#L-3569"><span class="linenos">3569</span></a>                <span class="n">dst_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="L-3570"><a href="#L-3570"><span class="linenos">3570</span></a>                <span class="n">dst_msk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="L-3571"><a href="#L-3571"><span class="linenos">3571</span></a>                <span class="n">instructions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-3572"><a href="#L-3572"><span class="linenos">3572</span></a>                    <span class="s2">&quot;src_img&quot;</span><span class="p">:</span> <span class="n">img_path</span><span class="p">,</span>
</span><span id="L-3573"><a href="#L-3573"><span class="linenos">3573</span></a>                    <span class="s2">&quot;src_msk&quot;</span><span class="p">:</span> <span class="n">msk_path</span><span class="p">,</span>
</span><span id="L-3574"><a href="#L-3574"><span class="linenos">3574</span></a>                    <span class="s2">&quot;dst_img&quot;</span><span class="p">:</span> <span class="n">dst_img</span><span class="p">,</span>
</span><span id="L-3575"><a href="#L-3575"><span class="linenos">3575</span></a>                    <span class="s2">&quot;dst_msk&quot;</span><span class="p">:</span> <span class="n">dst_msk</span><span class="p">,</span>
</span><span id="L-3576"><a href="#L-3576"><span class="linenos">3576</span></a>                    <span class="s2">&quot;augment&quot;</span><span class="p">:</span> <span class="n">aug</span>
</span><span id="L-3577"><a href="#L-3577"><span class="linenos">3577</span></a>                <span class="p">})</span>
</span><span id="L-3578"><a href="#L-3578"><span class="linenos">3578</span></a>                <span class="n">global_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3579"><a href="#L-3579"><span class="linenos">3579</span></a>
</span><span id="L-3580"><a href="#L-3580"><span class="linenos">3580</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total files to process: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3581"><a href="#L-3581"><span class="linenos">3581</span></a>
</span><span id="L-3582"><a href="#L-3582"><span class="linenos">3582</span></a>    <span class="c1"># --- Step 3: Process with multiprocessing ---</span>
</span><span id="L-3583"><a href="#L-3583"><span class="linenos">3583</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing images with multiprocessing...&quot;</span><span class="p">)</span>
</span><span id="L-3584"><a href="#L-3584"><span class="linenos">3584</span></a>    
</span><span id="L-3585"><a href="#L-3585"><span class="linenos">3585</span></a>    <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3586"><a href="#L-3586"><span class="linenos">3586</span></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-3587"><a href="#L-3587"><span class="linenos">3587</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-3588"><a href="#L-3588"><span class="linenos">3588</span></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span>
</span><span id="L-3589"><a href="#L-3589"><span class="linenos">3589</span></a>        
</span><span id="L-3590"><a href="#L-3590"><span class="linenos">3590</span></a>    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="L-3591"><a href="#L-3591"><span class="linenos">3591</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">process_instruction</span><span class="p">,</span> <span class="n">instructions</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-3592"><a href="#L-3592"><span class="linenos">3592</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;cellpose dataset&quot;</span><span class="p">)</span>
</span><span id="L-3593"><a href="#L-3593"><span class="linenos">3593</span></a>
</span><span id="L-3594"><a href="#L-3594"><span class="linenos">3594</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done. Dataset saved to: </span><span class="si">{</span><span class="n">output_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="process_non_tif_non_2D_images">
                            <input id="process_non_tif_non_2D_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_non_tif_non_2D_images</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">folder</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="process_non_tif_non_2D_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#process_non_tif_non_2D_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="process_non_tif_non_2D_images-29"><a href="#process_non_tif_non_2D_images-29"><span class="linenos"> 29</span></a><span class="k">def</span> <span class="nf">process_non_tif_non_2D_images</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="process_non_tif_non_2D_images-30"><a href="#process_non_tif_non_2D_images-30"><span class="linenos"> 30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes all images in the folder and splits them into grayscale channels, preserving bit depth.&quot;&quot;&quot;</span>
</span><span id="process_non_tif_non_2D_images-31"><a href="#process_non_tif_non_2D_images-31"><span class="linenos"> 31</span></a>    
</span><span id="process_non_tif_non_2D_images-32"><a href="#process_non_tif_non_2D_images-32"><span class="linenos"> 32</span></a>    <span class="c1"># Helper function to save grayscale images</span>
</span><span id="process_non_tif_non_2D_images-33"><a href="#process_non_tif_non_2D_images-33"><span class="linenos"> 33</span></a>    <span class="k">def</span> <span class="nf">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="process_non_tif_non_2D_images-34"><a href="#process_non_tif_non_2D_images-34"><span class="linenos"> 34</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save grayscale images with appropriate suffix based on channel, z, and t, preserving bit depth.&quot;&quot;&quot;</span>
</span><span id="process_non_tif_non_2D_images-35"><a href="#process_non_tif_non_2D_images-35"><span class="linenos"> 35</span></a>        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="process_non_tif_non_2D_images-36"><a href="#process_non_tif_non_2D_images-36"><span class="linenos"> 36</span></a>        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-37"><a href="#process_non_tif_non_2D_images-37"><span class="linenos"> 37</span></a>            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_C</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="process_non_tif_non_2D_images-38"><a href="#process_non_tif_non_2D_images-38"><span class="linenos"> 38</span></a>        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-39"><a href="#process_non_tif_non_2D_images-39"><span class="linenos"> 39</span></a>            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_Z</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="process_non_tif_non_2D_images-40"><a href="#process_non_tif_non_2D_images-40"><span class="linenos"> 40</span></a>        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-41"><a href="#process_non_tif_non_2D_images-41"><span class="linenos"> 41</span></a>            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_T</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="process_non_tif_non_2D_images-42"><a href="#process_non_tif_non_2D_images-42"><span class="linenos"> 42</span></a>
</span><span id="process_non_tif_non_2D_images-43"><a href="#process_non_tif_non_2D_images-43"><span class="linenos"> 43</span></a>        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-44"><a href="#process_non_tif_non_2D_images-44"><span class="linenos"> 44</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="process_non_tif_non_2D_images-45"><a href="#process_non_tif_non_2D_images-45"><span class="linenos"> 45</span></a>
</span><span id="process_non_tif_non_2D_images-46"><a href="#process_non_tif_non_2D_images-46"><span class="linenos"> 46</span></a>    <span class="c1"># Function to handle splitting of multi-dimensional images into grayscale channels</span>
</span><span id="process_non_tif_non_2D_images-47"><a href="#process_non_tif_non_2D_images-47"><span class="linenos"> 47</span></a>    <span class="k">def</span> <span class="nf">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="process_non_tif_non_2D_images-48"><a href="#process_non_tif_non_2D_images-48"><span class="linenos"> 48</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits the image into channels and handles 3D, 4D, and 5D image cases.&quot;&quot;&quot;</span>
</span><span id="process_non_tif_non_2D_images-49"><a href="#process_non_tif_non_2D_images-49"><span class="linenos"> 49</span></a>        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-50"><a href="#process_non_tif_non_2D_images-50"><span class="linenos"> 50</span></a>            <span class="c1"># Grayscale image, already processed separately</span>
</span><span id="process_non_tif_non_2D_images-51"><a href="#process_non_tif_non_2D_images-51"><span class="linenos"> 51</span></a>            <span class="k">return</span>
</span><span id="process_non_tif_non_2D_images-52"><a href="#process_non_tif_non_2D_images-52"><span class="linenos"> 52</span></a>        
</span><span id="process_non_tif_non_2D_images-53"><a href="#process_non_tif_non_2D_images-53"><span class="linenos"> 53</span></a>        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-54"><a href="#process_non_tif_non_2D_images-54"><span class="linenos"> 54</span></a>            <span class="c1"># 3D image: (height, width, channels)</span>
</span><span id="process_non_tif_non_2D_images-55"><a href="#process_non_tif_non_2D_images-55"><span class="linenos"> 55</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="process_non_tif_non_2D_images-56"><a href="#process_non_tif_non_2D_images-56"><span class="linenos"> 56</span></a>                <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-57"><a href="#process_non_tif_non_2D_images-57"><span class="linenos"> 57</span></a>        
</span><span id="process_non_tif_non_2D_images-58"><a href="#process_non_tif_non_2D_images-58"><span class="linenos"> 58</span></a>        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-59"><a href="#process_non_tif_non_2D_images-59"><span class="linenos"> 59</span></a>            <span class="c1"># 4D image: (height, width, channels, Z-dimension)</span>
</span><span id="process_non_tif_non_2D_images-60"><a href="#process_non_tif_non_2D_images-60"><span class="linenos"> 60</span></a>            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
</span><span id="process_non_tif_non_2D_images-61"><a href="#process_non_tif_non_2D_images-61"><span class="linenos"> 61</span></a>                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="process_non_tif_non_2D_images-62"><a href="#process_non_tif_non_2D_images-62"><span class="linenos"> 62</span></a>                    <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-63"><a href="#process_non_tif_non_2D_images-63"><span class="linenos"> 63</span></a>        
</span><span id="process_non_tif_non_2D_images-64"><a href="#process_non_tif_non_2D_images-64"><span class="linenos"> 64</span></a>        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-65"><a href="#process_non_tif_non_2D_images-65"><span class="linenos"> 65</span></a>            <span class="c1"># 5D image: (height, width, channels, Z-dimension, Time)</span>
</span><span id="process_non_tif_non_2D_images-66"><a href="#process_non_tif_non_2D_images-66"><span class="linenos"> 66</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
</span><span id="process_non_tif_non_2D_images-67"><a href="#process_non_tif_non_2D_images-67"><span class="linenos"> 67</span></a>                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
</span><span id="process_non_tif_non_2D_images-68"><a href="#process_non_tif_non_2D_images-68"><span class="linenos"> 68</span></a>                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="process_non_tif_non_2D_images-69"><a href="#process_non_tif_non_2D_images-69"><span class="linenos"> 69</span></a>                        <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-70"><a href="#process_non_tif_non_2D_images-70"><span class="linenos"> 70</span></a>
</span><span id="process_non_tif_non_2D_images-71"><a href="#process_non_tif_non_2D_images-71"><span class="linenos"> 71</span></a>    <span class="c1"># Function to load images in various formats</span>
</span><span id="process_non_tif_non_2D_images-72"><a href="#process_non_tif_non_2D_images-72"><span class="linenos"> 72</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="process_non_tif_non_2D_images-73"><a href="#process_non_tif_non_2D_images-73"><span class="linenos"> 73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads image from various formats and returns it as a numpy array along with its dtype.&quot;&quot;&quot;</span>
</span><span id="process_non_tif_non_2D_images-74"><a href="#process_non_tif_non_2D_images-74"><span class="linenos"> 74</span></a>        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="process_non_tif_non_2D_images-75"><a href="#process_non_tif_non_2D_images-75"><span class="linenos"> 75</span></a>        
</span><span id="process_non_tif_non_2D_images-76"><a href="#process_non_tif_non_2D_images-76"><span class="linenos"> 76</span></a>        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
</span><span id="process_non_tif_non_2D_images-77"><a href="#process_non_tif_non_2D_images-77"><span class="linenos"> 77</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-78"><a href="#process_non_tif_non_2D_images-78"><span class="linenos"> 78</span></a>            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="process_non_tif_non_2D_images-79"><a href="#process_non_tif_non_2D_images-79"><span class="linenos"> 79</span></a>        
</span><span id="process_non_tif_non_2D_images-80"><a href="#process_non_tif_non_2D_images-80"><span class="linenos"> 80</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">]:</span>
</span><span id="process_non_tif_non_2D_images-81"><a href="#process_non_tif_non_2D_images-81"><span class="linenos"> 81</span></a>            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-82"><a href="#process_non_tif_non_2D_images-82"><span class="linenos"> 82</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span>
</span><span id="process_non_tif_non_2D_images-83"><a href="#process_non_tif_non_2D_images-83"><span class="linenos"> 83</span></a>        
</span><span id="process_non_tif_non_2D_images-84"><a href="#process_non_tif_non_2D_images-84"><span class="linenos"> 84</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.czi&#39;</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-85"><a href="#process_non_tif_non_2D_images-85"><span class="linenos"> 85</span></a>            <span class="k">with</span> <span class="n">czifile</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czi</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-86"><a href="#process_non_tif_non_2D_images-86"><span class="linenos"> 86</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
</span><span id="process_non_tif_non_2D_images-87"><a href="#process_non_tif_non_2D_images-87"><span class="linenos"> 87</span></a>                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="process_non_tif_non_2D_images-88"><a href="#process_non_tif_non_2D_images-88"><span class="linenos"> 88</span></a>        
</span><span id="process_non_tif_non_2D_images-89"><a href="#process_non_tif_non_2D_images-89"><span class="linenos"> 89</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-90"><a href="#process_non_tif_non_2D_images-90"><span class="linenos"> 90</span></a>            <span class="k">with</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">nd2</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-91"><a href="#process_non_tif_non_2D_images-91"><span class="linenos"> 91</span></a>                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nd2</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-92"><a href="#process_non_tif_non_2D_images-92"><span class="linenos"> 92</span></a>                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="process_non_tif_non_2D_images-93"><a href="#process_non_tif_non_2D_images-93"><span class="linenos"> 93</span></a>        
</span><span id="process_non_tif_non_2D_images-94"><a href="#process_non_tif_non_2D_images-94"><span class="linenos"> 94</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-95"><a href="#process_non_tif_non_2D_images-95"><span class="linenos"> 95</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-96"><a href="#process_non_tif_non_2D_images-96"><span class="linenos"> 96</span></a>
</span><span id="process_non_tif_non_2D_images-97"><a href="#process_non_tif_non_2D_images-97"><span class="linenos"> 97</span></a>    <span class="c1"># Function to check if an image is grayscale and save it as a TIFF if it isn&#39;t already</span>
</span><span id="process_non_tif_non_2D_images-98"><a href="#process_non_tif_non_2D_images-98"><span class="linenos"> 98</span></a>    <span class="k">def</span> <span class="nf">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
</span><span id="process_non_tif_non_2D_images-99"><a href="#process_non_tif_non_2D_images-99"><span class="linenos"> 99</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert grayscale images that are not in TIFF format to TIFF, preserving bit depth.&quot;&quot;&quot;</span>
</span><span id="process_non_tif_non_2D_images-100"><a href="#process_non_tif_non_2D_images-100"><span class="linenos">100</span></a>        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="process_non_tif_non_2D_images-101"><a href="#process_non_tif_non_2D_images-101"><span class="linenos">101</span></a>        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-102"><a href="#process_non_tif_non_2D_images-102"><span class="linenos">102</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="process_non_tif_non_2D_images-103"><a href="#process_non_tif_non_2D_images-103"><span class="linenos">103</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted grayscale image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to TIFF with bit depth </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-104"><a href="#process_non_tif_non_2D_images-104"><span class="linenos">104</span></a>
</span><span id="process_non_tif_non_2D_images-105"><a href="#process_non_tif_non_2D_images-105"><span class="linenos">105</span></a>    <span class="c1"># Supported formats</span>
</span><span id="process_non_tif_non_2D_images-106"><a href="#process_non_tif_non_2D_images-106"><span class="linenos">106</span></a>    <span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">]</span>
</span><span id="process_non_tif_non_2D_images-107"><a href="#process_non_tif_non_2D_images-107"><span class="linenos">107</span></a>    
</span><span id="process_non_tif_non_2D_images-108"><a href="#process_non_tif_non_2D_images-108"><span class="linenos">108</span></a>    <span class="c1"># Loop through all files in the folder</span>
</span><span id="process_non_tif_non_2D_images-109"><a href="#process_non_tif_non_2D_images-109"><span class="linenos">109</span></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="process_non_tif_non_2D_images-110"><a href="#process_non_tif_non_2D_images-110"><span class="linenos">110</span></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-111"><a href="#process_non_tif_non_2D_images-111"><span class="linenos">111</span></a>        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="process_non_tif_non_2D_images-112"><a href="#process_non_tif_non_2D_images-112"><span class="linenos">112</span></a>
</span><span id="process_non_tif_non_2D_images-113"><a href="#process_non_tif_non_2D_images-113"><span class="linenos">113</span></a>        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-114"><a href="#process_non_tif_non_2D_images-114"><span class="linenos">114</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-115"><a href="#process_non_tif_non_2D_images-115"><span class="linenos">115</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-116"><a href="#process_non_tif_non_2D_images-116"><span class="linenos">116</span></a>                <span class="c1"># Load the image and its dtype</span>
</span><span id="process_non_tif_non_2D_images-117"><a href="#process_non_tif_non_2D_images-117"><span class="linenos">117</span></a>                <span class="n">image</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-118"><a href="#process_non_tif_non_2D_images-118"><span class="linenos">118</span></a>                
</span><span id="process_non_tif_non_2D_images-119"><a href="#process_non_tif_non_2D_images-119"><span class="linenos">119</span></a>                <span class="c1"># If the image is grayscale (2D), convert it to TIFF if it&#39;s not already in TIFF format</span>
</span><span id="process_non_tif_non_2D_images-120"><a href="#process_non_tif_non_2D_images-120"><span class="linenos">120</span></a>                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-121"><a href="#process_non_tif_non_2D_images-121"><span class="linenos">121</span></a>                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
</span><span id="process_non_tif_non_2D_images-122"><a href="#process_non_tif_non_2D_images-122"><span class="linenos">122</span></a>                        <span class="n">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-123"><a href="#process_non_tif_non_2D_images-123"><span class="linenos">123</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-124"><a href="#process_non_tif_non_2D_images-124"><span class="linenos">124</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is already grayscale and in TIFF format, skipping.&quot;</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-125"><a href="#process_non_tif_non_2D_images-125"><span class="linenos">125</span></a>                    <span class="k">continue</span>
</span><span id="process_non_tif_non_2D_images-126"><a href="#process_non_tif_non_2D_images-126"><span class="linenos">126</span></a>                
</span><span id="process_non_tif_non_2D_images-127"><a href="#process_non_tif_non_2D_images-127"><span class="linenos">127</span></a>                <span class="c1"># Otherwise, split channels and save images</span>
</span><span id="process_non_tif_non_2D_images-128"><a href="#process_non_tif_non_2D_images-128"><span class="linenos">128</span></a>                <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="process_non_tif_non_2D_images-129"><a href="#process_non_tif_non_2D_images-129"><span class="linenos">129</span></a>                <span class="n">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
</span><span id="process_non_tif_non_2D_images-130"><a href="#process_non_tif_non_2D_images-130"><span class="linenos">130</span></a>            
</span><span id="process_non_tif_non_2D_images-131"><a href="#process_non_tif_non_2D_images-131"><span class="linenos">131</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="process_non_tif_non_2D_images-132"><a href="#process_non_tif_non_2D_images-132"><span class="linenos">132</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Processes all images in the folder and splits them into grayscale channels, preserving bit depth.</p>
</div>


                </section>
                <section id="CombineLoaders">
                            <input id="CombineLoaders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CombineLoaders</span>:

                <label class="view-source-button" for="CombineLoaders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CombineLoaders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CombineLoaders-300"><a href="#CombineLoaders-300"><span class="linenos">300</span></a><span class="k">class</span> <span class="nc">CombineLoaders</span><span class="p">:</span>
</span><span id="CombineLoaders-301"><a href="#CombineLoaders-301"><span class="linenos">301</span></a>
</span><span id="CombineLoaders-302"><a href="#CombineLoaders-302"><span class="linenos">302</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CombineLoaders-303"><a href="#CombineLoaders-303"><span class="linenos">303</span></a><span class="sd">    A class that combines multiple data loaders into a single iterator.</span>
</span><span id="CombineLoaders-304"><a href="#CombineLoaders-304"><span class="linenos">304</span></a>
</span><span id="CombineLoaders-305"><a href="#CombineLoaders-305"><span class="linenos">305</span></a><span class="sd">    Args:</span>
</span><span id="CombineLoaders-306"><a href="#CombineLoaders-306"><span class="linenos">306</span></a><span class="sd">        train_loaders (list): A list of data loaders.</span>
</span><span id="CombineLoaders-307"><a href="#CombineLoaders-307"><span class="linenos">307</span></a>
</span><span id="CombineLoaders-308"><a href="#CombineLoaders-308"><span class="linenos">308</span></a><span class="sd">    Attributes:</span>
</span><span id="CombineLoaders-309"><a href="#CombineLoaders-309"><span class="linenos">309</span></a><span class="sd">        train_loaders (list): A list of data loaders.</span>
</span><span id="CombineLoaders-310"><a href="#CombineLoaders-310"><span class="linenos">310</span></a><span class="sd">        loader_iters (list): A list of iterator objects for each data loader.</span>
</span><span id="CombineLoaders-311"><a href="#CombineLoaders-311"><span class="linenos">311</span></a>
</span><span id="CombineLoaders-312"><a href="#CombineLoaders-312"><span class="linenos">312</span></a><span class="sd">    Methods:</span>
</span><span id="CombineLoaders-313"><a href="#CombineLoaders-313"><span class="linenos">313</span></a><span class="sd">        __iter__(): Returns the iterator object itself.</span>
</span><span id="CombineLoaders-314"><a href="#CombineLoaders-314"><span class="linenos">314</span></a><span class="sd">        __next__(): Returns the next batch from one of the data loaders.</span>
</span><span id="CombineLoaders-315"><a href="#CombineLoaders-315"><span class="linenos">315</span></a>
</span><span id="CombineLoaders-316"><a href="#CombineLoaders-316"><span class="linenos">316</span></a><span class="sd">    Raises:</span>
</span><span id="CombineLoaders-317"><a href="#CombineLoaders-317"><span class="linenos">317</span></a><span class="sd">        StopIteration: If all data loaders have been exhausted.</span>
</span><span id="CombineLoaders-318"><a href="#CombineLoaders-318"><span class="linenos">318</span></a>
</span><span id="CombineLoaders-319"><a href="#CombineLoaders-319"><span class="linenos">319</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CombineLoaders-320"><a href="#CombineLoaders-320"><span class="linenos">320</span></a>
</span><span id="CombineLoaders-321"><a href="#CombineLoaders-321"><span class="linenos">321</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loaders</span><span class="p">):</span>
</span><span id="CombineLoaders-322"><a href="#CombineLoaders-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_loaders</span> <span class="o">=</span> <span class="n">train_loaders</span>
</span><span id="CombineLoaders-323"><a href="#CombineLoaders-323"><span class="linenos">323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span> <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">train_loaders</span><span class="p">]</span>
</span><span id="CombineLoaders-324"><a href="#CombineLoaders-324"><span class="linenos">324</span></a>
</span><span id="CombineLoaders-325"><a href="#CombineLoaders-325"><span class="linenos">325</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CombineLoaders-326"><a href="#CombineLoaders-326"><span class="linenos">326</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="CombineLoaders-327"><a href="#CombineLoaders-327"><span class="linenos">327</span></a>
</span><span id="CombineLoaders-328"><a href="#CombineLoaders-328"><span class="linenos">328</span></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CombineLoaders-329"><a href="#CombineLoaders-329"><span class="linenos">329</span></a>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">:</span>
</span><span id="CombineLoaders-330"><a href="#CombineLoaders-330"><span class="linenos">330</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">)</span>  <span class="c1"># Shuffle the loader_iters list</span>
</span><span id="CombineLoaders-331"><a href="#CombineLoaders-331"><span class="linenos">331</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loader_iter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">):</span>
</span><span id="CombineLoaders-332"><a href="#CombineLoaders-332"><span class="linenos">332</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="CombineLoaders-333"><a href="#CombineLoaders-333"><span class="linenos">333</span></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">loader_iter</span><span class="p">)</span>
</span><span id="CombineLoaders-334"><a href="#CombineLoaders-334"><span class="linenos">334</span></a>                    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span>
</span><span id="CombineLoaders-335"><a href="#CombineLoaders-335"><span class="linenos">335</span></a>                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="CombineLoaders-336"><a href="#CombineLoaders-336"><span class="linenos">336</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="CombineLoaders-337"><a href="#CombineLoaders-337"><span class="linenos">337</span></a>                    <span class="k">continue</span>
</span><span id="CombineLoaders-338"><a href="#CombineLoaders-338"><span class="linenos">338</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CombineLoaders-339"><a href="#CombineLoaders-339"><span class="linenos">339</span></a>                <span class="k">break</span>
</span><span id="CombineLoaders-340"><a href="#CombineLoaders-340"><span class="linenos">340</span></a>        <span class="k">raise</span> <span class="ne">StopIteration</span>
</span></pre></div>


            <div class="docstring"><p>A class that combines multiple data loaders into a single iterator.</p>

<p>Args:
    train_loaders (list): A list of data loaders.</p>

<p>Attributes:
    train_loaders (list): A list of data loaders.
    loader_iters (list): A list of iterator objects for each data loader.</p>

<p>Methods:
    __iter__(): Returns the iterator object itself.
    __next__(): Returns the next batch from one of the data loaders.</p>

<p>Raises:
    StopIteration: If all data loaders have been exhausted.</p>
</div>


                            <div id="CombineLoaders.__init__" class="classattr">
                                        <input id="CombineLoaders.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CombineLoaders</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">train_loaders</span></span>)</span>

                <label class="view-source-button" for="CombineLoaders.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CombineLoaders.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CombineLoaders.__init__-321"><a href="#CombineLoaders.__init__-321"><span class="linenos">321</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loaders</span><span class="p">):</span>
</span><span id="CombineLoaders.__init__-322"><a href="#CombineLoaders.__init__-322"><span class="linenos">322</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_loaders</span> <span class="o">=</span> <span class="n">train_loaders</span>
</span><span id="CombineLoaders.__init__-323"><a href="#CombineLoaders.__init__-323"><span class="linenos">323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span> <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">train_loaders</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="CombineLoaders.train_loaders" class="classattr">
                                <div class="attr variable">
            <span class="name">train_loaders</span>

        
    </div>
    <a class="headerlink" href="#CombineLoaders.train_loaders"></a>
    
    

                            </div>
                            <div id="CombineLoaders.loader_iters" class="classattr">
                                <div class="attr variable">
            <span class="name">loader_iters</span>

        
    </div>
    <a class="headerlink" href="#CombineLoaders.loader_iters"></a>
    
    

                            </div>
                </section>
                <section id="CombinedDataset">
                            <input id="CombinedDataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CombinedDataset</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="CombinedDataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CombinedDataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CombinedDataset-342"><a href="#CombinedDataset-342"><span class="linenos">342</span></a><span class="k">class</span> <span class="nc">CombinedDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="CombinedDataset-343"><a href="#CombinedDataset-343"><span class="linenos">343</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="CombinedDataset-344"><a href="#CombinedDataset-344"><span class="linenos">344</span></a><span class="sd">    A dataset that combines multiple datasets into one.</span>
</span><span id="CombinedDataset-345"><a href="#CombinedDataset-345"><span class="linenos">345</span></a>
</span><span id="CombinedDataset-346"><a href="#CombinedDataset-346"><span class="linenos">346</span></a><span class="sd">    Args:</span>
</span><span id="CombinedDataset-347"><a href="#CombinedDataset-347"><span class="linenos">347</span></a><span class="sd">        datasets (list): A list of datasets to be combined.</span>
</span><span id="CombinedDataset-348"><a href="#CombinedDataset-348"><span class="linenos">348</span></a><span class="sd">        shuffle (bool, optional): Whether to shuffle the combined dataset. Defaults to True.</span>
</span><span id="CombinedDataset-349"><a href="#CombinedDataset-349"><span class="linenos">349</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CombinedDataset-350"><a href="#CombinedDataset-350"><span class="linenos">350</span></a>
</span><span id="CombinedDataset-351"><a href="#CombinedDataset-351"><span class="linenos">351</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="CombinedDataset-352"><a href="#CombinedDataset-352"><span class="linenos">352</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
</span><span id="CombinedDataset-353"><a href="#CombinedDataset-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
</span><span id="CombinedDataset-354"><a href="#CombinedDataset-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
</span><span id="CombinedDataset-355"><a href="#CombinedDataset-355"><span class="linenos">355</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="CombinedDataset-356"><a href="#CombinedDataset-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
</span><span id="CombinedDataset-357"><a href="#CombinedDataset-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_length</span><span class="p">))</span>
</span><span id="CombinedDataset-358"><a href="#CombinedDataset-358"><span class="linenos">358</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
</span><span id="CombinedDataset-359"><a href="#CombinedDataset-359"><span class="linenos">359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CombinedDataset-360"><a href="#CombinedDataset-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CombinedDataset-361"><a href="#CombinedDataset-361"><span class="linenos">361</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="CombinedDataset-362"><a href="#CombinedDataset-362"><span class="linenos">362</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="CombinedDataset-363"><a href="#CombinedDataset-363"><span class="linenos">363</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="CombinedDataset-364"><a href="#CombinedDataset-364"><span class="linenos">364</span></a>        <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">):</span>
</span><span id="CombinedDataset-365"><a href="#CombinedDataset-365"><span class="linenos">365</span></a>            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
</span><span id="CombinedDataset-366"><a href="#CombinedDataset-366"><span class="linenos">366</span></a>                <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="CombinedDataset-367"><a href="#CombinedDataset-367"><span class="linenos">367</span></a>            <span class="n">index</span> <span class="o">-=</span> <span class="n">length</span>
</span><span id="CombinedDataset-368"><a href="#CombinedDataset-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CombinedDataset-369"><a href="#CombinedDataset-369"><span class="linenos">369</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span>
</span></pre></div>


            <div class="docstring"><p>A dataset that combines multiple datasets into one.</p>

<p>Args:
    datasets (list): A list of datasets to be combined.
    shuffle (bool, optional): Whether to shuffle the combined dataset. Defaults to True.</p>
</div>


                            <div id="CombinedDataset.__init__" class="classattr">
                                        <input id="CombinedDataset.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CombinedDataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">datasets</span>, </span><span class="param"><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="CombinedDataset.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CombinedDataset.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CombinedDataset.__init__-351"><a href="#CombinedDataset.__init__-351"><span class="linenos">351</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="CombinedDataset.__init__-352"><a href="#CombinedDataset.__init__-352"><span class="linenos">352</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
</span><span id="CombinedDataset.__init__-353"><a href="#CombinedDataset.__init__-353"><span class="linenos">353</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
</span><span id="CombinedDataset.__init__-354"><a href="#CombinedDataset.__init__-354"><span class="linenos">354</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
</span><span id="CombinedDataset.__init__-355"><a href="#CombinedDataset.__init__-355"><span class="linenos">355</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="CombinedDataset.__init__-356"><a href="#CombinedDataset.__init__-356"><span class="linenos">356</span></a>        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
</span><span id="CombinedDataset.__init__-357"><a href="#CombinedDataset.__init__-357"><span class="linenos">357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_length</span><span class="p">))</span>
</span><span id="CombinedDataset.__init__-358"><a href="#CombinedDataset.__init__-358"><span class="linenos">358</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
</span><span id="CombinedDataset.__init__-359"><a href="#CombinedDataset.__init__-359"><span class="linenos">359</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CombinedDataset.__init__-360"><a href="#CombinedDataset.__init__-360"><span class="linenos">360</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="CombinedDataset.datasets" class="classattr">
                                <div class="attr variable">
            <span class="name">datasets</span>

        
    </div>
    <a class="headerlink" href="#CombinedDataset.datasets"></a>
    
    

                            </div>
                            <div id="CombinedDataset.lengths" class="classattr">
                                <div class="attr variable">
            <span class="name">lengths</span>

        
    </div>
    <a class="headerlink" href="#CombinedDataset.lengths"></a>
    
    

                            </div>
                            <div id="CombinedDataset.total_length" class="classattr">
                                <div class="attr variable">
            <span class="name">total_length</span>

        
    </div>
    <a class="headerlink" href="#CombinedDataset.total_length"></a>
    
    

                            </div>
                            <div id="CombinedDataset.shuffle" class="classattr">
                                <div class="attr variable">
            <span class="name">shuffle</span>

        
    </div>
    <a class="headerlink" href="#CombinedDataset.shuffle"></a>
    
    

                            </div>
                </section>
                <section id="NoClassDataset">
                            <input id="NoClassDataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NoClassDataset</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="NoClassDataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NoClassDataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NoClassDataset-371"><a href="#NoClassDataset-371"><span class="linenos">371</span></a><span class="k">class</span> <span class="nc">NoClassDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="NoClassDataset-372"><a href="#NoClassDataset-372"><span class="linenos">372</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NoClassDataset-373"><a href="#NoClassDataset-373"><span class="linenos">373</span></a><span class="sd">    A custom dataset class for handling image data without class labels.</span>
</span><span id="NoClassDataset-374"><a href="#NoClassDataset-374"><span class="linenos">374</span></a><span class="sd">    </span>
</span><span id="NoClassDataset-375"><a href="#NoClassDataset-375"><span class="linenos">375</span></a><span class="sd">    Args:</span>
</span><span id="NoClassDataset-376"><a href="#NoClassDataset-376"><span class="linenos">376</span></a><span class="sd">        data_dir (str): The directory path where the image files are located.</span>
</span><span id="NoClassDataset-377"><a href="#NoClassDataset-377"><span class="linenos">377</span></a><span class="sd">        transform (callable, optional): A function/transform to apply to the image data. Default is None.</span>
</span><span id="NoClassDataset-378"><a href="#NoClassDataset-378"><span class="linenos">378</span></a><span class="sd">        shuffle (bool, optional): Whether to shuffle the dataset. Default is True.</span>
</span><span id="NoClassDataset-379"><a href="#NoClassDataset-379"><span class="linenos">379</span></a><span class="sd">        load_to_memory (bool, optional): Whether to load all images into memory. Default is False.</span>
</span><span id="NoClassDataset-380"><a href="#NoClassDataset-380"><span class="linenos">380</span></a><span class="sd">    </span>
</span><span id="NoClassDataset-381"><a href="#NoClassDataset-381"><span class="linenos">381</span></a><span class="sd">    Attributes:</span>
</span><span id="NoClassDataset-382"><a href="#NoClassDataset-382"><span class="linenos">382</span></a><span class="sd">        data_dir (str): The directory path where the image files are located.</span>
</span><span id="NoClassDataset-383"><a href="#NoClassDataset-383"><span class="linenos">383</span></a><span class="sd">        transform (callable): A function/transform to apply to the image data.</span>
</span><span id="NoClassDataset-384"><a href="#NoClassDataset-384"><span class="linenos">384</span></a><span class="sd">        shuffle (bool): Whether to shuffle the dataset.</span>
</span><span id="NoClassDataset-385"><a href="#NoClassDataset-385"><span class="linenos">385</span></a><span class="sd">        load_to_memory (bool): Whether to load all images into memory.</span>
</span><span id="NoClassDataset-386"><a href="#NoClassDataset-386"><span class="linenos">386</span></a><span class="sd">        filenames (list): A list of file paths for the image files.</span>
</span><span id="NoClassDataset-387"><a href="#NoClassDataset-387"><span class="linenos">387</span></a><span class="sd">        images (list): A list of loaded images (if load_to_memory is True).</span>
</span><span id="NoClassDataset-388"><a href="#NoClassDataset-388"><span class="linenos">388</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NoClassDataset-389"><a href="#NoClassDataset-389"><span class="linenos">389</span></a>    
</span><span id="NoClassDataset-390"><a href="#NoClassDataset-390"><span class="linenos">390</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NoClassDataset-391"><a href="#NoClassDataset-391"><span class="linenos">391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="NoClassDataset-392"><a href="#NoClassDataset-392"><span class="linenos">392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="NoClassDataset-393"><a href="#NoClassDataset-393"><span class="linenos">393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="NoClassDataset-394"><a href="#NoClassDataset-394"><span class="linenos">394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span>
</span><span id="NoClassDataset-395"><a href="#NoClassDataset-395"><span class="linenos">395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="NoClassDataset-396"><a href="#NoClassDataset-396"><span class="linenos">396</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="NoClassDataset-397"><a href="#NoClassDataset-397"><span class="linenos">397</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="NoClassDataset-398"><a href="#NoClassDataset-398"><span class="linenos">398</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="NoClassDataset-399"><a href="#NoClassDataset-399"><span class="linenos">399</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span><span id="NoClassDataset-400"><a href="#NoClassDataset-400"><span class="linenos">400</span></a>    
</span><span id="NoClassDataset-401"><a href="#NoClassDataset-401"><span class="linenos">401</span></a>    <span class="c1">#@lru_cache(maxsize=None)</span>
</span><span id="NoClassDataset-402"><a href="#NoClassDataset-402"><span class="linenos">402</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="NoClassDataset-403"><a href="#NoClassDataset-403"><span class="linenos">403</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NoClassDataset-404"><a href="#NoClassDataset-404"><span class="linenos">404</span></a><span class="sd">        Load an image from the given file path.</span>
</span><span id="NoClassDataset-405"><a href="#NoClassDataset-405"><span class="linenos">405</span></a><span class="sd">        </span>
</span><span id="NoClassDataset-406"><a href="#NoClassDataset-406"><span class="linenos">406</span></a><span class="sd">        Args:</span>
</span><span id="NoClassDataset-407"><a href="#NoClassDataset-407"><span class="linenos">407</span></a><span class="sd">            img_path (str): The file path of the image.</span>
</span><span id="NoClassDataset-408"><a href="#NoClassDataset-408"><span class="linenos">408</span></a><span class="sd">        </span>
</span><span id="NoClassDataset-409"><a href="#NoClassDataset-409"><span class="linenos">409</span></a><span class="sd">        Returns:</span>
</span><span id="NoClassDataset-410"><a href="#NoClassDataset-410"><span class="linenos">410</span></a><span class="sd">            PIL.Image: The loaded image.</span>
</span><span id="NoClassDataset-411"><a href="#NoClassDataset-411"><span class="linenos">411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NoClassDataset-412"><a href="#NoClassDataset-412"><span class="linenos">412</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="NoClassDataset-413"><a href="#NoClassDataset-413"><span class="linenos">413</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="NoClassDataset-414"><a href="#NoClassDataset-414"><span class="linenos">414</span></a>    
</span><span id="NoClassDataset-415"><a href="#NoClassDataset-415"><span class="linenos">415</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NoClassDataset-416"><a href="#NoClassDataset-416"><span class="linenos">416</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NoClassDataset-417"><a href="#NoClassDataset-417"><span class="linenos">417</span></a><span class="sd">        Get the total number of images in the dataset.</span>
</span><span id="NoClassDataset-418"><a href="#NoClassDataset-418"><span class="linenos">418</span></a><span class="sd">        </span>
</span><span id="NoClassDataset-419"><a href="#NoClassDataset-419"><span class="linenos">419</span></a><span class="sd">        Returns:</span>
</span><span id="NoClassDataset-420"><a href="#NoClassDataset-420"><span class="linenos">420</span></a><span class="sd">            int: The number of images in the dataset.</span>
</span><span id="NoClassDataset-421"><a href="#NoClassDataset-421"><span class="linenos">421</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NoClassDataset-422"><a href="#NoClassDataset-422"><span class="linenos">422</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="NoClassDataset-423"><a href="#NoClassDataset-423"><span class="linenos">423</span></a>    
</span><span id="NoClassDataset-424"><a href="#NoClassDataset-424"><span class="linenos">424</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NoClassDataset-425"><a href="#NoClassDataset-425"><span class="linenos">425</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NoClassDataset-426"><a href="#NoClassDataset-426"><span class="linenos">426</span></a><span class="sd">        Shuffle the dataset.</span>
</span><span id="NoClassDataset-427"><a href="#NoClassDataset-427"><span class="linenos">427</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NoClassDataset-428"><a href="#NoClassDataset-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="NoClassDataset-429"><a href="#NoClassDataset-429"><span class="linenos">429</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="NoClassDataset-430"><a href="#NoClassDataset-430"><span class="linenos">430</span></a>    
</span><span id="NoClassDataset-431"><a href="#NoClassDataset-431"><span class="linenos">431</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="NoClassDataset-432"><a href="#NoClassDataset-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NoClassDataset-433"><a href="#NoClassDataset-433"><span class="linenos">433</span></a><span class="sd">        Get the image and its corresponding filename at the given index.</span>
</span><span id="NoClassDataset-434"><a href="#NoClassDataset-434"><span class="linenos">434</span></a><span class="sd">        </span>
</span><span id="NoClassDataset-435"><a href="#NoClassDataset-435"><span class="linenos">435</span></a><span class="sd">        Args:</span>
</span><span id="NoClassDataset-436"><a href="#NoClassDataset-436"><span class="linenos">436</span></a><span class="sd">            index (int): The index of the image in the dataset.</span>
</span><span id="NoClassDataset-437"><a href="#NoClassDataset-437"><span class="linenos">437</span></a><span class="sd">        </span>
</span><span id="NoClassDataset-438"><a href="#NoClassDataset-438"><span class="linenos">438</span></a><span class="sd">        Returns:</span>
</span><span id="NoClassDataset-439"><a href="#NoClassDataset-439"><span class="linenos">439</span></a><span class="sd">            tuple: A tuple containing the image and its filename.</span>
</span><span id="NoClassDataset-440"><a href="#NoClassDataset-440"><span class="linenos">440</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NoClassDataset-441"><a href="#NoClassDataset-441"><span class="linenos">441</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="NoClassDataset-442"><a href="#NoClassDataset-442"><span class="linenos">442</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="NoClassDataset-443"><a href="#NoClassDataset-443"><span class="linenos">443</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NoClassDataset-444"><a href="#NoClassDataset-444"><span class="linenos">444</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="NoClassDataset-445"><a href="#NoClassDataset-445"><span class="linenos">445</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NoClassDataset-446"><a href="#NoClassDataset-446"><span class="linenos">446</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="NoClassDataset-447"><a href="#NoClassDataset-447"><span class="linenos">447</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NoClassDataset-448"><a href="#NoClassDataset-448"><span class="linenos">448</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
</span><span id="NoClassDataset-449"><a href="#NoClassDataset-449"><span class="linenos">449</span></a>        <span class="c1"># Return both the image and its filename</span>
</span><span id="NoClassDataset-450"><a href="#NoClassDataset-450"><span class="linenos">450</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>An abstract class representing a <code>Dataset</code>.</p>

<p>All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite <code>__getitem__()</code>, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
<code>__len__()</code>, which is expected to return the size of the dataset by many
<code>~torch.utils.data.Sampler</code> implementations and the default options
of <code>~torch.utils.data.DataLoader</code>. Subclasses could also
optionally implement <code>__getitems__()</code>, for speedup batched samples
loading. This method accepts list of indices of samples of batch and returns
list of samples.</p>

<div class="alert note">

<p>sampler that yields integral indices.  To make it work with a map-style
dataset with non-integral indices/keys, a custom sampler must be provided.</p>

</div>
</div>


                            <div id="NoClassDataset.__init__" class="classattr">
                                        <input id="NoClassDataset.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NoClassDataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data_dir</span>, </span><span class="param"><span class="n">transform</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="NoClassDataset.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NoClassDataset.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NoClassDataset.__init__-583"><a href="#NoClassDataset.__init__-583"><span class="linenos">583</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="NoClassDataset.__init__-584"><a href="#NoClassDataset.__init__-584"><span class="linenos">584</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="NoClassDataset.__init__-585"><a href="#NoClassDataset.__init__-585"><span class="linenos">585</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="NoClassDataset.__init__-586"><a href="#NoClassDataset.__init__-586"><span class="linenos">586</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="NoClassDataset.__init__-587"><a href="#NoClassDataset.__init__-587"><span class="linenos">587</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span>
</span><span id="NoClassDataset.__init__-588"><a href="#NoClassDataset.__init__-588"><span class="linenos">588</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="NoClassDataset.__init__-589"><a href="#NoClassDataset.__init__-589"><span class="linenos">589</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="NoClassDataset.__init__-590"><a href="#NoClassDataset.__init__-590"><span class="linenos">590</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="NoClassDataset.__init__-591"><a href="#NoClassDataset.__init__-591"><span class="linenos">591</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
</span><span id="NoClassDataset.__init__-592"><a href="#NoClassDataset.__init__-592"><span class="linenos">592</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="NoClassDataset.data_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">data_dir</span>

        
    </div>
    <a class="headerlink" href="#NoClassDataset.data_dir"></a>
    
    

                            </div>
                            <div id="NoClassDataset.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span>

        
    </div>
    <a class="headerlink" href="#NoClassDataset.transform"></a>
    
    

                            </div>
                            <div id="NoClassDataset.shuffle" class="classattr">
                                <div class="attr variable">
            <span class="name">shuffle</span>

        
    </div>
    <a class="headerlink" href="#NoClassDataset.shuffle"></a>
    
    

                            </div>
                            <div id="NoClassDataset.load_to_memory" class="classattr">
                                <div class="attr variable">
            <span class="name">load_to_memory</span>

        
    </div>
    <a class="headerlink" href="#NoClassDataset.load_to_memory"></a>
    
    

                            </div>
                            <div id="NoClassDataset.filenames" class="classattr">
                                <div class="attr variable">
            <span class="name">filenames</span>

        
    </div>
    <a class="headerlink" href="#NoClassDataset.filenames"></a>
    
    

                            </div>
                            <div id="NoClassDataset.load_image" class="classattr">
                                        <input id="NoClassDataset.load_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">img_path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NoClassDataset.load_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NoClassDataset.load_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NoClassDataset.load_image-594"><a href="#NoClassDataset.load_image-594"><span class="linenos">594</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="NoClassDataset.load_image-595"><a href="#NoClassDataset.load_image-595"><span class="linenos">595</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="NoClassDataset.load_image-596"><a href="#NoClassDataset.load_image-596"><span class="linenos">596</span></a>        <span class="k">return</span> <span class="n">img</span>
</span></pre></div>


            <div class="docstring"><p>Load an image from the given file path.</p>

<p>Args:
    img_path (str): The file path of the image.</p>

<p>Returns:
    PIL.Image: The loaded image.</p>
</div>


                            </div>
                            <div id="NoClassDataset.shuffle_dataset" class="classattr">
                                        <input id="NoClassDataset.shuffle_dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shuffle_dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="NoClassDataset.shuffle_dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NoClassDataset.shuffle_dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NoClassDataset.shuffle_dataset-602"><a href="#NoClassDataset.shuffle_dataset-602"><span class="linenos">602</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="NoClassDataset.shuffle_dataset-603"><a href="#NoClassDataset.shuffle_dataset-603"><span class="linenos">603</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="NoClassDataset.shuffle_dataset-604"><a href="#NoClassDataset.shuffle_dataset-604"><span class="linenos">604</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Shuffle the dataset.</p>
</div>


                            </div>
                </section>
                <section id="spacrDataset">
                            <input id="spacrDataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">spacrDataset</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="spacrDataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataset-452"><a href="#spacrDataset-452"><span class="linenos">452</span></a><span class="k">class</span> <span class="nc">spacrDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="spacrDataset-453"><a href="#spacrDataset-453"><span class="linenos">453</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">loader_classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">specific_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specific_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="spacrDataset-454"><a href="#spacrDataset-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="spacrDataset-455"><a href="#spacrDataset-455"><span class="linenos">455</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">loader_classes</span>
</span><span id="spacrDataset-456"><a href="#spacrDataset-456"><span class="linenos">456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="spacrDataset-457"><a href="#spacrDataset-457"><span class="linenos">457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="spacrDataset-458"><a href="#spacrDataset-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span>
</span><span id="spacrDataset-459"><a href="#spacrDataset-459"><span class="linenos">459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="spacrDataset-460"><a href="#spacrDataset-460"><span class="linenos">460</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="spacrDataset-461"><a href="#spacrDataset-461"><span class="linenos">461</span></a>
</span><span id="spacrDataset-462"><a href="#spacrDataset-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="n">specific_files</span> <span class="ow">and</span> <span class="n">specific_labels</span><span class="p">:</span>
</span><span id="spacrDataset-463"><a href="#spacrDataset-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">specific_files</span>
</span><span id="spacrDataset-464"><a href="#spacrDataset-464"><span class="linenos">464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">specific_labels</span>
</span><span id="spacrDataset-465"><a href="#spacrDataset-465"><span class="linenos">465</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataset-466"><a href="#spacrDataset-466"><span class="linenos">466</span></a>            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
</span><span id="spacrDataset-467"><a href="#spacrDataset-467"><span class="linenos">467</span></a>                <span class="n">class_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
</span><span id="spacrDataset-468"><a href="#spacrDataset-468"><span class="linenos">468</span></a>                <span class="n">class_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="spacrDataset-469"><a href="#spacrDataset-469"><span class="linenos">469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_files</span><span class="p">)</span>
</span><span id="spacrDataset-470"><a href="#spacrDataset-470"><span class="linenos">470</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_name</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_files</span><span class="p">))</span>
</span><span id="spacrDataset-471"><a href="#spacrDataset-471"><span class="linenos">471</span></a>        
</span><span id="spacrDataset-472"><a href="#spacrDataset-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="spacrDataset-473"><a href="#spacrDataset-473"><span class="linenos">473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="spacrDataset-474"><a href="#spacrDataset-474"><span class="linenos">474</span></a>
</span><span id="spacrDataset-475"><a href="#spacrDataset-475"><span class="linenos">475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="spacrDataset-476"><a href="#spacrDataset-476"><span class="linenos">476</span></a>            <span class="c1"># Use multiprocessing to load images in parallel</span>
</span><span id="spacrDataset-477"><a href="#spacrDataset-477"><span class="linenos">477</span></a>            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="spacrDataset-478"><a href="#spacrDataset-478"><span class="linenos">478</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="spacrDataset-479"><a href="#spacrDataset-479"><span class="linenos">479</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataset-480"><a href="#spacrDataset-480"><span class="linenos">480</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="spacrDataset-481"><a href="#spacrDataset-481"><span class="linenos">481</span></a>
</span><span id="spacrDataset-482"><a href="#spacrDataset-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="spacrDataset-483"><a href="#spacrDataset-483"><span class="linenos">483</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="spacrDataset-484"><a href="#spacrDataset-484"><span class="linenos">484</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># Handle image orientation</span>
</span><span id="spacrDataset-485"><a href="#spacrDataset-485"><span class="linenos">485</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="spacrDataset-486"><a href="#spacrDataset-486"><span class="linenos">486</span></a>
</span><span id="spacrDataset-487"><a href="#spacrDataset-487"><span class="linenos">487</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataset-488"><a href="#spacrDataset-488"><span class="linenos">488</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="spacrDataset-489"><a href="#spacrDataset-489"><span class="linenos">489</span></a>
</span><span id="spacrDataset-490"><a href="#spacrDataset-490"><span class="linenos">490</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataset-491"><a href="#spacrDataset-491"><span class="linenos">491</span></a>        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
</span><span id="spacrDataset-492"><a href="#spacrDataset-492"><span class="linenos">492</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
</span><span id="spacrDataset-493"><a href="#spacrDataset-493"><span class="linenos">493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combined</span><span class="p">)</span>
</span><span id="spacrDataset-494"><a href="#spacrDataset-494"><span class="linenos">494</span></a>
</span><span id="spacrDataset-495"><a href="#spacrDataset-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">get_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
</span><span id="spacrDataset-496"><a href="#spacrDataset-496"><span class="linenos">496</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span><span id="spacrDataset-497"><a href="#spacrDataset-497"><span class="linenos">497</span></a>        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="spacrDataset-498"><a href="#spacrDataset-498"><span class="linenos">498</span></a>
</span><span id="spacrDataset-499"><a href="#spacrDataset-499"><span class="linenos">499</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="spacrDataset-500"><a href="#spacrDataset-500"><span class="linenos">500</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="spacrDataset-501"><a href="#spacrDataset-501"><span class="linenos">501</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="spacrDataset-502"><a href="#spacrDataset-502"><span class="linenos">502</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataset-503"><a href="#spacrDataset-503"><span class="linenos">503</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="spacrDataset-504"><a href="#spacrDataset-504"><span class="linenos">504</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="spacrDataset-505"><a href="#spacrDataset-505"><span class="linenos">505</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="spacrDataset-506"><a href="#spacrDataset-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="spacrDataset-507"><a href="#spacrDataset-507"><span class="linenos">507</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="spacrDataset-508"><a href="#spacrDataset-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">filename</span>
</span></pre></div>


            <div class="docstring"><p>An abstract class representing a <code>Dataset</code>.</p>

<p>All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite <code>__getitem__()</code>, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
<code>__len__()</code>, which is expected to return the size of the dataset by many
<code>~torch.utils.data.Sampler</code> implementations and the default options
of <code>~torch.utils.data.DataLoader</code>. Subclasses could also
optionally implement <code>__getitems__()</code>, for speedup batched samples
loading. This method accepts list of indices of samples of batch and returns
list of samples.</p>

<div class="alert note">

<p>sampler that yields integral indices.  To make it work with a map-style
dataset with non-integral indices/keys, a custom sampler must be provided.</p>

</div>
</div>


                            <div id="spacrDataset.__init__" class="classattr">
                                        <input id="spacrDataset.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">spacrDataset</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data_dir</span>,</span><span class="param">	<span class="n">loader_classes</span>,</span><span class="param">	<span class="n">transform</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">specific_files</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">specific_labels</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="spacrDataset.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataset.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataset.__init__-453"><a href="#spacrDataset.__init__-453"><span class="linenos">453</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">loader_classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">specific_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specific_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="spacrDataset.__init__-454"><a href="#spacrDataset.__init__-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
</span><span id="spacrDataset.__init__-455"><a href="#spacrDataset.__init__-455"><span class="linenos">455</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">loader_classes</span>
</span><span id="spacrDataset.__init__-456"><a href="#spacrDataset.__init__-456"><span class="linenos">456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="spacrDataset.__init__-457"><a href="#spacrDataset.__init__-457"><span class="linenos">457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
</span><span id="spacrDataset.__init__-458"><a href="#spacrDataset.__init__-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span>
</span><span id="spacrDataset.__init__-459"><a href="#spacrDataset.__init__-459"><span class="linenos">459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="spacrDataset.__init__-460"><a href="#spacrDataset.__init__-460"><span class="linenos">460</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="spacrDataset.__init__-461"><a href="#spacrDataset.__init__-461"><span class="linenos">461</span></a>
</span><span id="spacrDataset.__init__-462"><a href="#spacrDataset.__init__-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="n">specific_files</span> <span class="ow">and</span> <span class="n">specific_labels</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-463"><a href="#spacrDataset.__init__-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">specific_files</span>
</span><span id="spacrDataset.__init__-464"><a href="#spacrDataset.__init__-464"><span class="linenos">464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">specific_labels</span>
</span><span id="spacrDataset.__init__-465"><a href="#spacrDataset.__init__-465"><span class="linenos">465</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-466"><a href="#spacrDataset.__init__-466"><span class="linenos">466</span></a>            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-467"><a href="#spacrDataset.__init__-467"><span class="linenos">467</span></a>                <span class="n">class_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
</span><span id="spacrDataset.__init__-468"><a href="#spacrDataset.__init__-468"><span class="linenos">468</span></a>                <span class="n">class_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="spacrDataset.__init__-469"><a href="#spacrDataset.__init__-469"><span class="linenos">469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_files</span><span class="p">)</span>
</span><span id="spacrDataset.__init__-470"><a href="#spacrDataset.__init__-470"><span class="linenos">470</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_name</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_files</span><span class="p">))</span>
</span><span id="spacrDataset.__init__-471"><a href="#spacrDataset.__init__-471"><span class="linenos">471</span></a>        
</span><span id="spacrDataset.__init__-472"><a href="#spacrDataset.__init__-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-473"><a href="#spacrDataset.__init__-473"><span class="linenos">473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
</span><span id="spacrDataset.__init__-474"><a href="#spacrDataset.__init__-474"><span class="linenos">474</span></a>
</span><span id="spacrDataset.__init__-475"><a href="#spacrDataset.__init__-475"><span class="linenos">475</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-476"><a href="#spacrDataset.__init__-476"><span class="linenos">476</span></a>            <span class="c1"># Use multiprocessing to load images in parallel</span>
</span><span id="spacrDataset.__init__-477"><a href="#spacrDataset.__init__-477"><span class="linenos">477</span></a>            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-478"><a href="#spacrDataset.__init__-478"><span class="linenos">478</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
</span><span id="spacrDataset.__init__-479"><a href="#spacrDataset.__init__-479"><span class="linenos">479</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataset.__init__-480"><a href="#spacrDataset.__init__-480"><span class="linenos">480</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="spacrDataset.data_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">data_dir</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.data_dir"></a>
    
    

                            </div>
                            <div id="spacrDataset.classes" class="classattr">
                                <div class="attr variable">
            <span class="name">classes</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.classes"></a>
    
    

                            </div>
                            <div id="spacrDataset.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.transform"></a>
    
    

                            </div>
                            <div id="spacrDataset.shuffle" class="classattr">
                                <div class="attr variable">
            <span class="name">shuffle</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.shuffle"></a>
    
    

                            </div>
                            <div id="spacrDataset.pin_memory" class="classattr">
                                <div class="attr variable">
            <span class="name">pin_memory</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.pin_memory"></a>
    
    

                            </div>
                            <div id="spacrDataset.filenames" class="classattr">
                                <div class="attr variable">
            <span class="name">filenames</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.filenames"></a>
    
    

                            </div>
                            <div id="spacrDataset.labels" class="classattr">
                                <div class="attr variable">
            <span class="name">labels</span>

        
    </div>
    <a class="headerlink" href="#spacrDataset.labels"></a>
    
    

                            </div>
                            <div id="spacrDataset.load_image" class="classattr">
                                        <input id="spacrDataset.load_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">img_path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="spacrDataset.load_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataset.load_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataset.load_image-482"><a href="#spacrDataset.load_image-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
</span><span id="spacrDataset.load_image-483"><a href="#spacrDataset.load_image-483"><span class="linenos">483</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
</span><span id="spacrDataset.load_image-484"><a href="#spacrDataset.load_image-484"><span class="linenos">484</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># Handle image orientation</span>
</span><span id="spacrDataset.load_image-485"><a href="#spacrDataset.load_image-485"><span class="linenos">485</span></a>        <span class="k">return</span> <span class="n">img</span>
</span></pre></div>


    

                            </div>
                            <div id="spacrDataset.shuffle_dataset" class="classattr">
                                        <input id="spacrDataset.shuffle_dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shuffle_dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="spacrDataset.shuffle_dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataset.shuffle_dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataset.shuffle_dataset-490"><a href="#spacrDataset.shuffle_dataset-490"><span class="linenos">490</span></a>    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataset.shuffle_dataset-491"><a href="#spacrDataset.shuffle_dataset-491"><span class="linenos">491</span></a>        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
</span><span id="spacrDataset.shuffle_dataset-492"><a href="#spacrDataset.shuffle_dataset-492"><span class="linenos">492</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
</span><span id="spacrDataset.shuffle_dataset-493"><a href="#spacrDataset.shuffle_dataset-493"><span class="linenos">493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combined</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="spacrDataset.get_plate" class="classattr">
                                        <input id="spacrDataset.get_plate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_plate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filepath</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="spacrDataset.get_plate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataset.get_plate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataset.get_plate-495"><a href="#spacrDataset.get_plate-495"><span class="linenos">495</span></a>    <span class="k">def</span> <span class="nf">get_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
</span><span id="spacrDataset.get_plate-496"><a href="#spacrDataset.get_plate-496"><span class="linenos">496</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span><span id="spacrDataset.get_plate-497"><a href="#spacrDataset.get_plate-497"><span class="linenos">497</span></a>        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="spacrDataLoader">
                            <input id="spacrDataLoader-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">spacrDataLoader</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="spacrDataLoader-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataLoader"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataLoader-510"><a href="#spacrDataLoader-510"><span class="linenos">510</span></a><span class="k">class</span> <span class="nc">spacrDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
</span><span id="spacrDataLoader-511"><a href="#spacrDataLoader-511"><span class="linenos">511</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">preload_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="spacrDataLoader-512"><a href="#spacrDataLoader-512"><span class="linenos">512</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="spacrDataLoader-513"><a href="#spacrDataLoader-513"><span class="linenos">513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span> <span class="o">=</span> <span class="n">preload_batches</span>
</span><span id="spacrDataLoader-514"><a href="#spacrDataLoader-514"><span class="linenos">514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">preload_batches</span><span class="p">)</span>
</span><span id="spacrDataLoader-515"><a href="#spacrDataLoader-515"><span class="linenos">515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="spacrDataLoader-516"><a href="#spacrDataLoader-516"><span class="linenos">516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="spacrDataLoader-517"><a href="#spacrDataLoader-517"><span class="linenos">517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="spacrDataLoader-518"><a href="#spacrDataLoader-518"><span class="linenos">518</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin_memory&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="spacrDataLoader-519"><a href="#spacrDataLoader-519"><span class="linenos">519</span></a>        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>
</span><span id="spacrDataLoader-520"><a href="#spacrDataLoader-520"><span class="linenos">520</span></a>
</span><span id="spacrDataLoader-521"><a href="#spacrDataLoader-521"><span class="linenos">521</span></a>    <span class="k">def</span> <span class="nf">_preload_next_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader-522"><a href="#spacrDataLoader-522"><span class="linenos">522</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="spacrDataLoader-523"><a href="#spacrDataLoader-523"><span class="linenos">523</span></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">):</span>
</span><span id="spacrDataLoader-524"><a href="#spacrDataLoader-524"><span class="linenos">524</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="p">:</span>
</span><span id="spacrDataLoader-525"><a href="#spacrDataLoader-525"><span class="linenos">525</span></a>                    <span class="k">break</span>
</span><span id="spacrDataLoader-526"><a href="#spacrDataLoader-526"><span class="linenos">526</span></a>                <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>
</span><span id="spacrDataLoader-527"><a href="#spacrDataLoader-527"><span class="linenos">527</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="spacrDataLoader-528"><a href="#spacrDataLoader-528"><span class="linenos">528</span></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="spacrDataLoader-529"><a href="#spacrDataLoader-529"><span class="linenos">529</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="spacrDataLoader-530"><a href="#spacrDataLoader-530"><span class="linenos">530</span></a>        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="spacrDataLoader-531"><a href="#spacrDataLoader-531"><span class="linenos">531</span></a>            <span class="k">pass</span>
</span><span id="spacrDataLoader-532"><a href="#spacrDataLoader-532"><span class="linenos">532</span></a>
</span><span id="spacrDataLoader-533"><a href="#spacrDataLoader-533"><span class="linenos">533</span></a>    <span class="k">def</span> <span class="nf">_start_preloading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader-534"><a href="#spacrDataLoader-534"><span class="linenos">534</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span id="spacrDataLoader-535"><a href="#spacrDataLoader-535"><span class="linenos">535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">())</span>
</span><span id="spacrDataLoader-536"><a href="#spacrDataLoader-536"><span class="linenos">536</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="spacrDataLoader-537"><a href="#spacrDataLoader-537"><span class="linenos">537</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">)</span>
</span><span id="spacrDataLoader-538"><a href="#spacrDataLoader-538"><span class="linenos">538</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="spacrDataLoader-539"><a href="#spacrDataLoader-539"><span class="linenos">539</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataLoader-540"><a href="#spacrDataLoader-540"><span class="linenos">540</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">()</span>  <span class="c1"># Directly load if pin_memory is True</span>
</span><span id="spacrDataLoader-541"><a href="#spacrDataLoader-541"><span class="linenos">541</span></a>
</span><span id="spacrDataLoader-542"><a href="#spacrDataLoader-542"><span class="linenos">542</span></a>    <span class="k">def</span> <span class="nf">_pin_memory_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
</span><span id="spacrDataLoader-543"><a href="#spacrDataLoader-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
</span><span id="spacrDataLoader-544"><a href="#spacrDataLoader-544"><span class="linenos">544</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
</span><span id="spacrDataLoader-545"><a href="#spacrDataLoader-545"><span class="linenos">545</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="spacrDataLoader-546"><a href="#spacrDataLoader-546"><span class="linenos">546</span></a>            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span>
</span><span id="spacrDataLoader-547"><a href="#spacrDataLoader-547"><span class="linenos">547</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataLoader-548"><a href="#spacrDataLoader-548"><span class="linenos">548</span></a>            <span class="k">return</span> <span class="n">batch</span>
</span><span id="spacrDataLoader-549"><a href="#spacrDataLoader-549"><span class="linenos">549</span></a>
</span><span id="spacrDataLoader-550"><a href="#spacrDataLoader-550"><span class="linenos">550</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader-551"><a href="#spacrDataLoader-551"><span class="linenos">551</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>
</span><span id="spacrDataLoader-552"><a href="#spacrDataLoader-552"><span class="linenos">552</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="spacrDataLoader-553"><a href="#spacrDataLoader-553"><span class="linenos">553</span></a>
</span><span id="spacrDataLoader-554"><a href="#spacrDataLoader-554"><span class="linenos">554</span></a>    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader-555"><a href="#spacrDataLoader-555"><span class="linenos">555</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span><span id="spacrDataLoader-556"><a href="#spacrDataLoader-556"><span class="linenos">556</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="spacrDataLoader-557"><a href="#spacrDataLoader-557"><span class="linenos">557</span></a>
</span><span id="spacrDataLoader-558"><a href="#spacrDataLoader-558"><span class="linenos">558</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="spacrDataLoader-559"><a href="#spacrDataLoader-559"><span class="linenos">559</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
</span><span id="spacrDataLoader-560"><a href="#spacrDataLoader-560"><span class="linenos">560</span></a>                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="spacrDataLoader-561"><a href="#spacrDataLoader-561"><span class="linenos">561</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="spacrDataLoader-562"><a href="#spacrDataLoader-562"><span class="linenos">562</span></a>                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="spacrDataLoader-563"><a href="#spacrDataLoader-563"><span class="linenos">563</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="spacrDataLoader-564"><a href="#spacrDataLoader-564"><span class="linenos">564</span></a>
</span><span id="spacrDataLoader-565"><a href="#spacrDataLoader-565"><span class="linenos">565</span></a>            <span class="c1"># Start preloading the next batches</span>
</span><span id="spacrDataLoader-566"><a href="#spacrDataLoader-566"><span class="linenos">566</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">:</span>
</span><span id="spacrDataLoader-567"><a href="#spacrDataLoader-567"><span class="linenos">567</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>
</span><span id="spacrDataLoader-568"><a href="#spacrDataLoader-568"><span class="linenos">568</span></a>
</span><span id="spacrDataLoader-569"><a href="#spacrDataLoader-569"><span class="linenos">569</span></a>            <span class="k">return</span> <span class="n">next_batch</span>
</span><span id="spacrDataLoader-570"><a href="#spacrDataLoader-570"><span class="linenos">570</span></a>        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span><span id="spacrDataLoader-571"><a href="#spacrDataLoader-571"><span class="linenos">571</span></a>            <span class="k">raise</span> <span class="ne">StopIteration</span>
</span><span id="spacrDataLoader-572"><a href="#spacrDataLoader-572"><span class="linenos">572</span></a>
</span><span id="spacrDataLoader-573"><a href="#spacrDataLoader-573"><span class="linenos">573</span></a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader-574"><a href="#spacrDataLoader-574"><span class="linenos">574</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="spacrDataLoader-575"><a href="#spacrDataLoader-575"><span class="linenos">575</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span id="spacrDataLoader-576"><a href="#spacrDataLoader-576"><span class="linenos">576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="spacrDataLoader-577"><a href="#spacrDataLoader-577"><span class="linenos">577</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span id="spacrDataLoader-578"><a href="#spacrDataLoader-578"><span class="linenos">578</span></a>
</span><span id="spacrDataLoader-579"><a href="#spacrDataLoader-579"><span class="linenos">579</span></a>    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader-580"><a href="#spacrDataLoader-580"><span class="linenos">580</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Data loader combines a dataset and a sampler, and provides an iterable over the given dataset.</p>

<p>The <code>~torch.utils.data.DataLoader</code> supports both map-style and
iterable-style datasets with single- or multi-process loading, customizing
loading order and optional automatic batching (collation) and memory pinning.</p>

<p>See <code>torch.utils.data</code> documentation page for more details.</p>

<p>Args:
    dataset (Dataset): dataset from which to load the data.
    batch_size (int, optional): how many samples per batch to load
        (default: <code>1</code>).
    shuffle (bool, optional): set to <code>True</code> to have the data reshuffled
        at every epoch (default: <code>False</code>).
    sampler (Sampler or Iterable, optional): defines the strategy to draw
        samples from the dataset. Can be any <code>Iterable</code> with <code>__len__</code>
        implemented. If specified, <code>shuffle</code> must not be specified.
    batch_sampler (Sampler or Iterable, optional): like <code><a href="#spacrDataLoader.sampler">sampler</a></code>, but
        returns a batch of indices at a time. Mutually exclusive with
        <code><a href="#spacrDataLoader.batch_size">batch_size</a></code>, <code>shuffle</code>, <code><a href="#spacrDataLoader.sampler">sampler</a></code>,
        and <code><a href="#spacrDataLoader.drop_last">drop_last</a></code>.
    num_workers (int, optional): how many subprocesses to use for data
        loading. <code>0</code> means that the data will be loaded in the main process.
        (default: <code>0</code>)
    collate_fn (Callable, optional): merges a list of samples to form a
        mini-batch of Tensor(s).  Used when using batched loading from a
        map-style dataset.
    pin_memory (bool, optional): If <code>True</code>, the data loader will copy Tensors
        into device/CUDA pinned memory before returning them.  If your data elements
        are a custom type, or your <code><a href="#spacrDataLoader.collate_fn">collate_fn</a></code> returns a batch that is a custom type,
        see the example below.
    drop_last (bool, optional): set to <code>True</code> to drop the last incomplete batch,
        if the dataset size is not divisible by the batch size. If <code>False</code> and
        the size of dataset is not divisible by the batch size, then the last batch
        will be smaller. (default: <code>False</code>)
    timeout (numeric, optional): if positive, the timeout value for collecting a batch
        from workers. Should always be non-negative. (default: <code>0</code>)
    worker_init_fn (Callable, optional): If not <code>None</code>, this will be called on each
        worker subprocess with the worker id (an int in <code>[0, num_workers - 1]</code>) as
        input, after seeding and before data loading. (default: <code>None</code>)
    multiprocessing_context (str or multiprocessing.context.BaseContext, optional): If
        <code>None</code>, the default <a href="https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods">multiprocessing context</a> of your operating system will
        be used. (default: <code>None</code>)
    generator (torch.Generator, optional): If not <code>None</code>, this RNG will be used
        by RandomSampler to generate random indexes and multiprocessing to generate
        <code>base_seed</code> for workers. (default: <code>None</code>)
    prefetch_factor (int, optional, keyword-only arg): Number of batches loaded
        in advance by each worker. <code>2</code> means there will be a total of
        2 * num_workers batches prefetched across all workers. (default value depends
        on the set value for num_workers. If value of num_workers=0 default is <code>None</code>.
        Otherwise, if value of <code>num_workers &gt; 0</code> default is <code>2</code>).
    persistent_workers (bool, optional): If <code>True</code>, the data loader will not shut down
        the worker processes after a dataset has been consumed once. This allows to
        maintain the workers <code>Dataset</code> instances alive. (default: <code>False</code>)
    pin_memory_device (str, optional): the device to <code><a href="#spacrDataLoader.pin_memory">pin_memory</a></code> to if <code><a href="#spacrDataLoader.pin_memory">pin_memory</a></code> is
        <code>True</code>.</p>

<div class="alert warning">

<h6 id="if-the-spawn-start-method-is-used-worker_init_fn">If the <code>spawn</code> start method is used, <code><a href="#spacrDataLoader.worker_init_fn">worker_init_fn</a></code></h6>

<p>cannot be an unpicklable object, e.g., a lambda function. See
:ref:<code>multiprocessing-best-practices</code> on more details related
to multiprocessing in PyTorch.</p>

</div>

<div class="alert warning">

<h6 id="lendataloader-heuristic-is-based-on-the-length-of-the-sampler-used"><code>len(dataloader)</code> heuristic is based on the length of the sampler used.</h6>

<p>When <code><a href="#spacrDataLoader.dataset">dataset</a></code> is an <code>~torch.utils.data.IterableDataset</code>,
it instead returns an estimate based on <code>len(dataset) / batch_size</code>, with proper
rounding depending on <code><a href="#spacrDataLoader.drop_last">drop_last</a></code>, regardless of multi-process loading
configurations. This represents the best guess PyTorch can make because PyTorch
trusts user <code><a href="#spacrDataLoader.dataset">dataset</a></code> code in correctly handling multi-process
loading to avoid duplicate data.</p>

<p>However, if sharding results in multiple workers having incomplete last batches,
this estimate can still be inaccurate, because (1) an otherwise complete batch can
be broken into multiple ones and (2) more than one batch worth of samples can be
dropped when <code><a href="#spacrDataLoader.drop_last">drop_last</a></code> is set. Unfortunately, PyTorch can not detect such
cases in general.</p>

<p>See <code>Dataset Types</code>_ for more details on these two types of datasets and how
<code>~torch.utils.data.IterableDataset</code> interacts with
<code>Multi-process data loading</code>_.</p>

</div>

<div class="alert warning">

<h6 id="see-refreproducibility-and-refdataloader-workers-random-seed-and">See :ref:<code>reproducibility</code>, and :ref:<code>dataloader-workers-random-seed</code>, and</h6>

</div>
</div>


                            <div id="spacrDataLoader.__init__" class="classattr">
                                        <input id="spacrDataLoader.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">spacrDataLoader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="n">preload_batches</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="spacrDataLoader.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataLoader.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataLoader.__init__-511"><a href="#spacrDataLoader.__init__-511"><span class="linenos">511</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">preload_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="spacrDataLoader.__init__-512"><a href="#spacrDataLoader.__init__-512"><span class="linenos">512</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="spacrDataLoader.__init__-513"><a href="#spacrDataLoader.__init__-513"><span class="linenos">513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span> <span class="o">=</span> <span class="n">preload_batches</span>
</span><span id="spacrDataLoader.__init__-514"><a href="#spacrDataLoader.__init__-514"><span class="linenos">514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">preload_batches</span><span class="p">)</span>
</span><span id="spacrDataLoader.__init__-515"><a href="#spacrDataLoader.__init__-515"><span class="linenos">515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="spacrDataLoader.__init__-516"><a href="#spacrDataLoader.__init__-516"><span class="linenos">516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="spacrDataLoader.__init__-517"><a href="#spacrDataLoader.__init__-517"><span class="linenos">517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="spacrDataLoader.__init__-518"><a href="#spacrDataLoader.__init__-518"><span class="linenos">518</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin_memory&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="spacrDataLoader.__init__-519"><a href="#spacrDataLoader.__init__-519"><span class="linenos">519</span></a>        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="spacrDataLoader.preload_batches" class="classattr">
                                <div class="attr variable">
            <span class="name">preload_batches</span>

        
    </div>
    <a class="headerlink" href="#spacrDataLoader.preload_batches"></a>
    
    

                            </div>
                            <div id="spacrDataLoader.batch_queue" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_queue</span>

        
    </div>
    <a class="headerlink" href="#spacrDataLoader.batch_queue"></a>
    
    

                            </div>
                            <div id="spacrDataLoader.process" class="classattr">
                                <div class="attr variable">
            <span class="name">process</span>

        
    </div>
    <a class="headerlink" href="#spacrDataLoader.process"></a>
    
    

                            </div>
                            <div id="spacrDataLoader.current_batch_index" class="classattr">
                                <div class="attr variable">
            <span class="name">current_batch_index</span>

        
    </div>
    <a class="headerlink" href="#spacrDataLoader.current_batch_index"></a>
    
    

                            </div>
                            <div id="spacrDataLoader.pin_memory" class="classattr">
                                <div class="attr variable">
            <span class="name">pin_memory</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#spacrDataLoader.pin_memory"></a>
    
    

                            </div>
                            <div id="spacrDataLoader.cleanup" class="classattr">
                                        <input id="spacrDataLoader.cleanup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cleanup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="spacrDataLoader.cleanup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#spacrDataLoader.cleanup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="spacrDataLoader.cleanup-573"><a href="#spacrDataLoader.cleanup-573"><span class="linenos">573</span></a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="spacrDataLoader.cleanup-574"><a href="#spacrDataLoader.cleanup-574"><span class="linenos">574</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="spacrDataLoader.cleanup-575"><a href="#spacrDataLoader.cleanup-575"><span class="linenos">575</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span id="spacrDataLoader.cleanup-576"><a href="#spacrDataLoader.cleanup-576"><span class="linenos">576</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="spacrDataLoader.cleanup-577"><a href="#spacrDataLoader.cleanup-577"><span class="linenos">577</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="TarImageDataset">
                            <input id="TarImageDataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TarImageDataset</span><wbr>(<span class="base">typing.Generic[+T_co]</span>):

                <label class="view-source-button" for="TarImageDataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TarImageDataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TarImageDataset-618"><a href="#TarImageDataset-618"><span class="linenos">618</span></a><span class="k">class</span> <span class="nc">TarImageDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
</span><span id="TarImageDataset-619"><a href="#TarImageDataset-619"><span class="linenos">619</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TarImageDataset-620"><a href="#TarImageDataset-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span> <span class="o">=</span> <span class="n">tar_path</span>
</span><span id="TarImageDataset-621"><a href="#TarImageDataset-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="TarImageDataset-622"><a href="#TarImageDataset-622"><span class="linenos">622</span></a>
</span><span id="TarImageDataset-623"><a href="#TarImageDataset-623"><span class="linenos">623</span></a>        <span class="c1"># Open the tar file just to build the list of members</span>
</span><span id="TarImageDataset-624"><a href="#TarImageDataset-624"><span class="linenos">624</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="TarImageDataset-625"><a href="#TarImageDataset-625"><span class="linenos">625</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isfile</span><span class="p">()]</span>
</span><span id="TarImageDataset-626"><a href="#TarImageDataset-626"><span class="linenos">626</span></a>
</span><span id="TarImageDataset-627"><a href="#TarImageDataset-627"><span class="linenos">627</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TarImageDataset-628"><a href="#TarImageDataset-628"><span class="linenos">628</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
</span><span id="TarImageDataset-629"><a href="#TarImageDataset-629"><span class="linenos">629</span></a>
</span><span id="TarImageDataset-630"><a href="#TarImageDataset-630"><span class="linenos">630</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="TarImageDataset-631"><a href="#TarImageDataset-631"><span class="linenos">631</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="TarImageDataset-632"><a href="#TarImageDataset-632"><span class="linenos">632</span></a>            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="TarImageDataset-633"><a href="#TarImageDataset-633"><span class="linenos">633</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span id="TarImageDataset-634"><a href="#TarImageDataset-634"><span class="linenos">634</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
</span><span id="TarImageDataset-635"><a href="#TarImageDataset-635"><span class="linenos">635</span></a>            
</span><span id="TarImageDataset-636"><a href="#TarImageDataset-636"><span class="linenos">636</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="TarImageDataset-637"><a href="#TarImageDataset-637"><span class="linenos">637</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="TarImageDataset-638"><a href="#TarImageDataset-638"><span class="linenos">638</span></a>        
</span><span id="TarImageDataset-639"><a href="#TarImageDataset-639"><span class="linenos">639</span></a>        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span>
</span></pre></div>


            <div class="docstring"><p>An abstract class representing a <code>Dataset</code>.</p>

<p>All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite <code>__getitem__()</code>, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
<code>__len__()</code>, which is expected to return the size of the dataset by many
<code>~torch.utils.data.Sampler</code> implementations and the default options
of <code>~torch.utils.data.DataLoader</code>. Subclasses could also
optionally implement <code>__getitems__()</code>, for speedup batched samples
loading. This method accepts list of indices of samples of batch and returns
list of samples.</p>

<div class="alert note">

<p>sampler that yields integral indices.  To make it work with a map-style
dataset with non-integral indices/keys, a custom sampler must be provided.</p>

</div>
</div>


                            <div id="TarImageDataset.__init__" class="classattr">
                                        <input id="TarImageDataset.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TarImageDataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">tar_path</span>, </span><span class="param"><span class="n">transform</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="TarImageDataset.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TarImageDataset.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TarImageDataset.__init__-619"><a href="#TarImageDataset.__init__-619"><span class="linenos">619</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TarImageDataset.__init__-620"><a href="#TarImageDataset.__init__-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span> <span class="o">=</span> <span class="n">tar_path</span>
</span><span id="TarImageDataset.__init__-621"><a href="#TarImageDataset.__init__-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="TarImageDataset.__init__-622"><a href="#TarImageDataset.__init__-622"><span class="linenos">622</span></a>
</span><span id="TarImageDataset.__init__-623"><a href="#TarImageDataset.__init__-623"><span class="linenos">623</span></a>        <span class="c1"># Open the tar file just to build the list of members</span>
</span><span id="TarImageDataset.__init__-624"><a href="#TarImageDataset.__init__-624"><span class="linenos">624</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="TarImageDataset.__init__-625"><a href="#TarImageDataset.__init__-625"><span class="linenos">625</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isfile</span><span class="p">()]</span>
</span></pre></div>


    

                            </div>
                            <div id="TarImageDataset.tar_path" class="classattr">
                                <div class="attr variable">
            <span class="name">tar_path</span>

        
    </div>
    <a class="headerlink" href="#TarImageDataset.tar_path"></a>
    
    

                            </div>
                            <div id="TarImageDataset.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span>

        
    </div>
    <a class="headerlink" href="#TarImageDataset.transform"></a>
    
    

                            </div>
                </section>
                <section id="load_images_from_paths">
                            <input id="load_images_from_paths-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_images_from_paths</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">images_by_key</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_images_from_paths-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_images_from_paths"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_images_from_paths-641"><a href="#load_images_from_paths-641"><span class="linenos">641</span></a><span class="k">def</span> <span class="nf">load_images_from_paths</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">):</span>
</span><span id="load_images_from_paths-642"><a href="#load_images_from_paths-642"><span class="linenos">642</span></a>    <span class="n">images_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="load_images_from_paths-643"><a href="#load_images_from_paths-643"><span class="linenos">643</span></a>
</span><span id="load_images_from_paths-644"><a href="#load_images_from_paths-644"><span class="linenos">644</span></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="load_images_from_paths-645"><a href="#load_images_from_paths-645"><span class="linenos">645</span></a>        <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="load_images_from_paths-646"><a href="#load_images_from_paths-646"><span class="linenos">646</span></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
</span><span id="load_images_from_paths-647"><a href="#load_images_from_paths-647"><span class="linenos">647</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="load_images_from_paths-648"><a href="#load_images_from_paths-648"><span class="linenos">648</span></a>                <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
</span><span id="load_images_from_paths-649"><a href="#load_images_from_paths-649"><span class="linenos">649</span></a>                    <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
</span><span id="load_images_from_paths-650"><a href="#load_images_from_paths-650"><span class="linenos">650</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="load_images_from_paths-651"><a href="#load_images_from_paths-651"><span class="linenos">651</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading image from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="load_images_from_paths-652"><a href="#load_images_from_paths-652"><span class="linenos">652</span></a>    
</span><span id="load_images_from_paths-653"><a href="#load_images_from_paths-653"><span class="linenos">653</span></a>    <span class="k">return</span> <span class="n">images_dict</span>
</span></pre></div>


    

                </section>
                <section id="concatenate_and_normalize">
                            <input id="concatenate_and_normalize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">concatenate_and_normalize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">src</span>, </span><span class="param"><span class="n">channels</span>, </span><span class="param">save_dtype=&lt;class &#x27;numpy.float32&#x27;&gt;, </span><span class="param"><span class="n">settings</span><span class="o">=</span><span class="p">{}</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="concatenate_and_normalize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#concatenate_and_normalize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="concatenate_and_normalize-1166"><a href="#concatenate_and_normalize-1166"><span class="linenos">1166</span></a><span class="k">def</span> <span class="nf">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="concatenate_and_normalize-1167"><a href="#concatenate_and_normalize-1167"><span class="linenos">1167</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="concatenate_and_normalize-1168"><a href="#concatenate_and_normalize-1168"><span class="linenos">1168</span></a>
</span><span id="concatenate_and_normalize-1169"><a href="#concatenate_and_normalize-1169"><span class="linenos">1169</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="concatenate_and_normalize-1170"><a href="#concatenate_and_normalize-1170"><span class="linenos">1170</span></a><span class="sd">    Concatenates and normalizes channel data from multiple files and saves the normalized data.</span>
</span><span id="concatenate_and_normalize-1171"><a href="#concatenate_and_normalize-1171"><span class="linenos">1171</span></a>
</span><span id="concatenate_and_normalize-1172"><a href="#concatenate_and_normalize-1172"><span class="linenos">1172</span></a><span class="sd">    Args:</span>
</span><span id="concatenate_and_normalize-1173"><a href="#concatenate_and_normalize-1173"><span class="linenos">1173</span></a><span class="sd">        src (str): The source directory containing the channel data files.</span>
</span><span id="concatenate_and_normalize-1174"><a href="#concatenate_and_normalize-1174"><span class="linenos">1174</span></a><span class="sd">        channels (list): The list of channel indices to be concatenated and normalized.</span>
</span><span id="concatenate_and_normalize-1175"><a href="#concatenate_and_normalize-1175"><span class="linenos">1175</span></a><span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
</span><span id="concatenate_and_normalize-1176"><a href="#concatenate_and_normalize-1176"><span class="linenos">1176</span></a><span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
</span><span id="concatenate_and_normalize-1177"><a href="#concatenate_and_normalize-1177"><span class="linenos">1177</span></a><span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>
</span><span id="concatenate_and_normalize-1178"><a href="#concatenate_and_normalize-1178"><span class="linenos">1178</span></a><span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
</span><span id="concatenate_and_normalize-1179"><a href="#concatenate_and_normalize-1179"><span class="linenos">1179</span></a><span class="sd">        remove_backgrounds (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
</span><span id="concatenate_and_normalize-1180"><a href="#concatenate_and_normalize-1180"><span class="linenos">1180</span></a><span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
</span><span id="concatenate_and_normalize-1181"><a href="#concatenate_and_normalize-1181"><span class="linenos">1181</span></a><span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
</span><span id="concatenate_and_normalize-1182"><a href="#concatenate_and_normalize-1182"><span class="linenos">1182</span></a><span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
</span><span id="concatenate_and_normalize-1183"><a href="#concatenate_and_normalize-1183"><span class="linenos">1183</span></a><span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>
</span><span id="concatenate_and_normalize-1184"><a href="#concatenate_and_normalize-1184"><span class="linenos">1184</span></a>
</span><span id="concatenate_and_normalize-1185"><a href="#concatenate_and_normalize-1185"><span class="linenos">1185</span></a><span class="sd">    Returns:</span>
</span><span id="concatenate_and_normalize-1186"><a href="#concatenate_and_normalize-1186"><span class="linenos">1186</span></a><span class="sd">        str: The directory path where the concatenated and normalized channel data is saved.</span>
</span><span id="concatenate_and_normalize-1187"><a href="#concatenate_and_normalize-1187"><span class="linenos">1187</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="concatenate_and_normalize-1188"><a href="#concatenate_and_normalize-1188"><span class="linenos">1188</span></a>
</span><span id="concatenate_and_normalize-1189"><a href="#concatenate_and_normalize-1189"><span class="linenos">1189</span></a>    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="concatenate_and_normalize-1190"><a href="#concatenate_and_normalize-1190"><span class="linenos">1190</span></a>
</span><span id="concatenate_and_normalize-1191"><a href="#concatenate_and_normalize-1191"><span class="linenos">1191</span></a>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1192"><a href="#concatenate_and_normalize-1192"><span class="linenos">1192</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1193"><a href="#concatenate_and_normalize-1193"><span class="linenos">1193</span></a>    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1194"><a href="#concatenate_and_normalize-1194"><span class="linenos">1194</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1195"><a href="#concatenate_and_normalize-1195"><span class="linenos">1195</span></a>
</span><span id="concatenate_and_normalize-1196"><a href="#concatenate_and_normalize-1196"><span class="linenos">1196</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">]:</span>
</span><span id="concatenate_and_normalize-1197"><a href="#concatenate_and_normalize-1197"><span class="linenos">1197</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1198"><a href="#concatenate_and_normalize-1198"><span class="linenos">1198</span></a>            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
</span><span id="concatenate_and_normalize-1199"><a href="#concatenate_and_normalize-1199"><span class="linenos">1199</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
</span><span id="concatenate_and_normalize-1200"><a href="#concatenate_and_normalize-1200"><span class="linenos">1200</span></a>                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="concatenate_and_normalize-1201"><a href="#concatenate_and_normalize-1201"><span class="linenos">1201</span></a>                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1202"><a href="#concatenate_and_normalize-1202"><span class="linenos">1202</span></a>                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1203"><a href="#concatenate_and_normalize-1203"><span class="linenos">1203</span></a>                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
</span><span id="concatenate_and_normalize-1204"><a href="#concatenate_and_normalize-1204"><span class="linenos">1204</span></a>                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1205"><a href="#concatenate_and_normalize-1205"><span class="linenos">1205</span></a>                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1206"><a href="#concatenate_and_normalize-1206"><span class="linenos">1206</span></a>                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1207"><a href="#concatenate_and_normalize-1207"><span class="linenos">1207</span></a>                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="concatenate_and_normalize-1208"><a href="#concatenate_and_normalize-1208"><span class="linenos">1208</span></a>                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1209"><a href="#concatenate_and_normalize-1209"><span class="linenos">1209</span></a>                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1210"><a href="#concatenate_and_normalize-1210"><span class="linenos">1210</span></a>                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="concatenate_and_normalize-1211"><a href="#concatenate_and_normalize-1211"><span class="linenos">1211</span></a>                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="concatenate_and_normalize-1212"><a href="#concatenate_and_normalize-1212"><span class="linenos">1212</span></a>                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="concatenate_and_normalize-1213"><a href="#concatenate_and_normalize-1213"><span class="linenos">1213</span></a>                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1214"><a href="#concatenate_and_normalize-1214"><span class="linenos">1214</span></a>                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span><span id="concatenate_and_normalize-1215"><a href="#concatenate_and_normalize-1215"><span class="linenos">1215</span></a>                <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1216"><a href="#concatenate_and_normalize-1216"><span class="linenos">1216</span></a>                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1217"><a href="#concatenate_and_normalize-1217"><span class="linenos">1217</span></a>                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1218"><a href="#concatenate_and_normalize-1218"><span class="linenos">1218</span></a>
</span><span id="concatenate_and_normalize-1219"><a href="#concatenate_and_normalize-1219"><span class="linenos">1219</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
</span><span id="concatenate_and_normalize-1220"><a href="#concatenate_and_normalize-1220"><span class="linenos">1220</span></a>                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> 
</span><span id="concatenate_and_normalize-1221"><a href="#concatenate_and_normalize-1221"><span class="linenos">1221</span></a>                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
</span><span id="concatenate_and_normalize-1222"><a href="#concatenate_and_normalize-1222"><span class="linenos">1222</span></a>                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1223"><a href="#concatenate_and_normalize-1223"><span class="linenos">1223</span></a>                
</span><span id="concatenate_and_normalize-1224"><a href="#concatenate_and_normalize-1224"><span class="linenos">1224</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
</span><span id="concatenate_and_normalize-1225"><a href="#concatenate_and_normalize-1225"><span class="linenos">1225</span></a>                
</span><span id="concatenate_and_normalize-1226"><a href="#concatenate_and_normalize-1226"><span class="linenos">1226</span></a>                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1227"><a href="#concatenate_and_normalize-1227"><span class="linenos">1227</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1228"><a href="#concatenate_and_normalize-1228"><span class="linenos">1228</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1229"><a href="#concatenate_and_normalize-1229"><span class="linenos">1229</span></a>                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
</span><span id="concatenate_and_normalize-1230"><a href="#concatenate_and_normalize-1230"><span class="linenos">1230</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1231"><a href="#concatenate_and_normalize-1231"><span class="linenos">1231</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1232"><a href="#concatenate_and_normalize-1232"><span class="linenos">1232</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1233"><a href="#concatenate_and_normalize-1233"><span class="linenos">1233</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1234"><a href="#concatenate_and_normalize-1234"><span class="linenos">1234</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
</span><span id="concatenate_and_normalize-1235"><a href="#concatenate_and_normalize-1235"><span class="linenos">1235</span></a>            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="concatenate_and_normalize-1236"><a href="#concatenate_and_normalize-1236"><span class="linenos">1236</span></a>                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1237"><a href="#concatenate_and_normalize-1237"><span class="linenos">1237</span></a>                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1238"><a href="#concatenate_and_normalize-1238"><span class="linenos">1238</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;randomize&#39;</span><span class="p">]:</span>
</span><span id="concatenate_and_normalize-1239"><a href="#concatenate_and_normalize-1239"><span class="linenos">1239</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1240"><a href="#concatenate_and_normalize-1240"><span class="linenos">1240</span></a>        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1241"><a href="#concatenate_and_normalize-1241"><span class="linenos">1241</span></a>        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="concatenate_and_normalize-1242"><a href="#concatenate_and_normalize-1242"><span class="linenos">1242</span></a>        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1243"><a href="#concatenate_and_normalize-1243"><span class="linenos">1243</span></a>        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1244"><a href="#concatenate_and_normalize-1244"><span class="linenos">1244</span></a>        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1245"><a href="#concatenate_and_normalize-1245"><span class="linenos">1245</span></a>        <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="concatenate_and_normalize-1246"><a href="#concatenate_and_normalize-1246"><span class="linenos">1246</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
</span><span id="concatenate_and_normalize-1247"><a href="#concatenate_and_normalize-1247"><span class="linenos">1247</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="concatenate_and_normalize-1248"><a href="#concatenate_and_normalize-1248"><span class="linenos">1248</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1249"><a href="#concatenate_and_normalize-1249"><span class="linenos">1249</span></a>                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1250"><a href="#concatenate_and_normalize-1250"><span class="linenos">1250</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1251"><a href="#concatenate_and_normalize-1251"><span class="linenos">1251</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading file </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1252"><a href="#concatenate_and_normalize-1252"><span class="linenos">1252</span></a>                <span class="k">continue</span>
</span><span id="concatenate_and_normalize-1253"><a href="#concatenate_and_normalize-1253"><span class="linenos">1253</span></a>            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1254"><a href="#concatenate_and_normalize-1254"><span class="linenos">1254</span></a>            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="concatenate_and_normalize-1255"><a href="#concatenate_and_normalize-1255"><span class="linenos">1255</span></a>            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="concatenate_and_normalize-1256"><a href="#concatenate_and_normalize-1256"><span class="linenos">1256</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="concatenate_and_normalize-1257"><a href="#concatenate_and_normalize-1257"><span class="linenos">1257</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1258"><a href="#concatenate_and_normalize-1258"><span class="linenos">1258</span></a>            <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="concatenate_and_normalize-1259"><a href="#concatenate_and_normalize-1259"><span class="linenos">1259</span></a>            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
</span><span id="concatenate_and_normalize-1260"><a href="#concatenate_and_normalize-1260"><span class="linenos">1260</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1261"><a href="#concatenate_and_normalize-1261"><span class="linenos">1261</span></a>
</span><span id="concatenate_and_normalize-1262"><a href="#concatenate_and_normalize-1262"><span class="linenos">1262</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1263"><a href="#concatenate_and_normalize-1263"><span class="linenos">1263</span></a>                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
</span><span id="concatenate_and_normalize-1264"><a href="#concatenate_and_normalize-1264"><span class="linenos">1264</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1265"><a href="#concatenate_and_normalize-1265"><span class="linenos">1265</span></a>                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1266"><a href="#concatenate_and_normalize-1266"><span class="linenos">1266</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimensions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1267"><a href="#concatenate_and_normalize-1267"><span class="linenos">1267</span></a>                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1268"><a href="#concatenate_and_normalize-1268"><span class="linenos">1268</span></a>                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1269"><a href="#concatenate_and_normalize-1269"><span class="linenos">1269</span></a>                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="concatenate_and_normalize-1270"><a href="#concatenate_and_normalize-1270"><span class="linenos">1270</span></a>                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="concatenate_and_normalize-1271"><a href="#concatenate_and_normalize-1271"><span class="linenos">1271</span></a>                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1272"><a href="#concatenate_and_normalize-1272"><span class="linenos">1272</span></a>                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1273"><a href="#concatenate_and_normalize-1273"><span class="linenos">1273</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1274"><a href="#concatenate_and_normalize-1274"><span class="linenos">1274</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="concatenate_and_normalize-1275"><a href="#concatenate_and_normalize-1275"><span class="linenos">1275</span></a>                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1276"><a href="#concatenate_and_normalize-1276"><span class="linenos">1276</span></a>                
</span><span id="concatenate_and_normalize-1277"><a href="#concatenate_and_normalize-1277"><span class="linenos">1277</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
</span><span id="concatenate_and_normalize-1278"><a href="#concatenate_and_normalize-1278"><span class="linenos">1278</span></a>                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
</span><span id="concatenate_and_normalize-1279"><a href="#concatenate_and_normalize-1279"><span class="linenos">1279</span></a>                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
</span><span id="concatenate_and_normalize-1280"><a href="#concatenate_and_normalize-1280"><span class="linenos">1280</span></a>                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1281"><a href="#concatenate_and_normalize-1281"><span class="linenos">1281</span></a>                
</span><span id="concatenate_and_normalize-1282"><a href="#concatenate_and_normalize-1282"><span class="linenos">1282</span></a>                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
</span><span id="concatenate_and_normalize-1283"><a href="#concatenate_and_normalize-1283"><span class="linenos">1283</span></a>
</span><span id="concatenate_and_normalize-1284"><a href="#concatenate_and_normalize-1284"><span class="linenos">1284</span></a>                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">_norm.npz&#39;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1285"><a href="#concatenate_and_normalize-1285"><span class="linenos">1285</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1286"><a href="#concatenate_and_normalize-1286"><span class="linenos">1286</span></a>                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="concatenate_and_normalize-1287"><a href="#concatenate_and_normalize-1287"><span class="linenos">1287</span></a>                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
</span><span id="concatenate_and_normalize-1288"><a href="#concatenate_and_normalize-1288"><span class="linenos">1288</span></a>                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1289"><a href="#concatenate_and_normalize-1289"><span class="linenos">1289</span></a>                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1290"><a href="#concatenate_and_normalize-1290"><span class="linenos">1290</span></a>                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="concatenate_and_normalize-1291"><a href="#concatenate_and_normalize-1291"><span class="linenos">1291</span></a>
</span><span id="concatenate_and_normalize-1292"><a href="#concatenate_and_normalize-1292"><span class="linenos">1292</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and normalized. Saved to: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="concatenate_and_normalize-1293"><a href="#concatenate_and_normalize-1293"><span class="linenos">1293</span></a>    <span class="k">return</span> <span class="n">output_fldr</span>
</span></pre></div>


    

                </section>
                <section id="delete_empty_subdirectories">
                            <input id="delete_empty_subdirectories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_empty_subdirectories</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">folder_path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="delete_empty_subdirectories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#delete_empty_subdirectories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="delete_empty_subdirectories-1530"><a href="#delete_empty_subdirectories-1530"><span class="linenos">1530</span></a><span class="k">def</span> <span class="nf">delete_empty_subdirectories</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="delete_empty_subdirectories-1531"><a href="#delete_empty_subdirectories-1531"><span class="linenos">1531</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="delete_empty_subdirectories-1532"><a href="#delete_empty_subdirectories-1532"><span class="linenos">1532</span></a><span class="sd">    Deletes all empty subdirectories in the specified folder.</span>
</span><span id="delete_empty_subdirectories-1533"><a href="#delete_empty_subdirectories-1533"><span class="linenos">1533</span></a>
</span><span id="delete_empty_subdirectories-1534"><a href="#delete_empty_subdirectories-1534"><span class="linenos">1534</span></a><span class="sd">    Args:</span>
</span><span id="delete_empty_subdirectories-1535"><a href="#delete_empty_subdirectories-1535"><span class="linenos">1535</span></a><span class="sd">    - folder_path (str): The path to the folder in which to look for empty subdirectories.</span>
</span><span id="delete_empty_subdirectories-1536"><a href="#delete_empty_subdirectories-1536"><span class="linenos">1536</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="delete_empty_subdirectories-1537"><a href="#delete_empty_subdirectories-1537"><span class="linenos">1537</span></a>    <span class="c1"># Check each item in the specified folder</span>
</span><span id="delete_empty_subdirectories-1538"><a href="#delete_empty_subdirectories-1538"><span class="linenos">1538</span></a>    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="delete_empty_subdirectories-1539"><a href="#delete_empty_subdirectories-1539"><span class="linenos">1539</span></a>        <span class="c1"># os.walk is used with topdown=False to start from the innermost directories and work upwards.</span>
</span><span id="delete_empty_subdirectories-1540"><a href="#delete_empty_subdirectories-1540"><span class="linenos">1540</span></a>        <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
</span><span id="delete_empty_subdirectories-1541"><a href="#delete_empty_subdirectories-1541"><span class="linenos">1541</span></a>            <span class="c1"># Construct the full path to the subdirectory</span>
</span><span id="delete_empty_subdirectories-1542"><a href="#delete_empty_subdirectories-1542"><span class="linenos">1542</span></a>            <span class="n">full_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
</span><span id="delete_empty_subdirectories-1543"><a href="#delete_empty_subdirectories-1543"><span class="linenos">1543</span></a>            <span class="c1"># Try to remove the directory and catch any error (like if the directory is not empty)</span>
</span><span id="delete_empty_subdirectories-1544"><a href="#delete_empty_subdirectories-1544"><span class="linenos">1544</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="delete_empty_subdirectories-1545"><a href="#delete_empty_subdirectories-1545"><span class="linenos">1545</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">full_dir_path</span><span class="p">)</span>
</span><span id="delete_empty_subdirectories-1546"><a href="#delete_empty_subdirectories-1546"><span class="linenos">1546</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted empty directory: </span><span class="si">{</span><span class="n">full_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="delete_empty_subdirectories-1547"><a href="#delete_empty_subdirectories-1547"><span class="linenos">1547</span></a>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="delete_empty_subdirectories-1548"><a href="#delete_empty_subdirectories-1548"><span class="linenos">1548</span></a>                <span class="k">continue</span>
</span><span id="delete_empty_subdirectories-1549"><a href="#delete_empty_subdirectories-1549"><span class="linenos">1549</span></a>                <span class="c1"># An error occurred, likely because the directory is not empty</span>
</span><span id="delete_empty_subdirectories-1550"><a href="#delete_empty_subdirectories-1550"><span class="linenos">1550</span></a>                <span class="c1">#print(f&quot;Skipping non-empty directory: {full_dir_path}&quot;)</span>
</span></pre></div>


            <div class="docstring"><p>Deletes all empty subdirectories in the specified folder.</p>

<p>Args:</p>

<ul>
<li>folder_path (str): The path to the folder in which to look for empty subdirectories.</li>
</ul>
</div>


                </section>
                <section id="preprocess_img_data">
                            <input id="preprocess_img_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">preprocess_img_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="preprocess_img_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#preprocess_img_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="preprocess_img_data-1553"><a href="#preprocess_img_data-1553"><span class="linenos">1553</span></a><span class="k">def</span> <span class="nf">preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="preprocess_img_data-1554"><a href="#preprocess_img_data-1554"><span class="linenos">1554</span></a>    
</span><span id="preprocess_img_data-1555"><a href="#preprocess_img_data-1555"><span class="linenos">1555</span></a>    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
</span><span id="preprocess_img_data-1556"><a href="#preprocess_img_data-1556"><span class="linenos">1556</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_run_test_mode</span><span class="p">,</span> <span class="n">_get_regex</span>
</span><span id="preprocess_img_data-1557"><a href="#preprocess_img_data-1557"><span class="linenos">1557</span></a>    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_default_settings_preprocess_img_data</span>
</span><span id="preprocess_img_data-1558"><a href="#preprocess_img_data-1558"><span class="linenos">1558</span></a><span class="w">    </span>
</span><span id="preprocess_img_data-1559"><a href="#preprocess_img_data-1559"><span class="linenos">1559</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="preprocess_img_data-1560"><a href="#preprocess_img_data-1560"><span class="linenos">1560</span></a><span class="sd">    Preprocesses image data by converting z-stack images to maximum intensity projection (MIP) images.</span>
</span><span id="preprocess_img_data-1561"><a href="#preprocess_img_data-1561"><span class="linenos">1561</span></a>
</span><span id="preprocess_img_data-1562"><a href="#preprocess_img_data-1562"><span class="linenos">1562</span></a><span class="sd">    Args:</span>
</span><span id="preprocess_img_data-1563"><a href="#preprocess_img_data-1563"><span class="linenos">1563</span></a><span class="sd">        src (str): The source directory containing the z-stack images.</span>
</span><span id="preprocess_img_data-1564"><a href="#preprocess_img_data-1564"><span class="linenos">1564</span></a><span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;cellvoyager&#39;.</span>
</span><span id="preprocess_img_data-1565"><a href="#preprocess_img_data-1565"><span class="linenos">1565</span></a><span class="sd">        custom_regex (str, optional): The custom regular expression pattern used to match the filenames of the z-stack images. Defaults to None.</span>
</span><span id="preprocess_img_data-1566"><a href="#preprocess_img_data-1566"><span class="linenos">1566</span></a><span class="sd">        cmap (str, optional): The colormap used for plotting. Defaults to &#39;inferno&#39;.</span>
</span><span id="preprocess_img_data-1567"><a href="#preprocess_img_data-1567"><span class="linenos">1567</span></a><span class="sd">        figuresize (int, optional): The size of the figure for plotting. Defaults to 15.</span>
</span><span id="preprocess_img_data-1568"><a href="#preprocess_img_data-1568"><span class="linenos">1568</span></a><span class="sd">        normalize (bool, optional): Whether to normalize the images. Defaults to False.</span>
</span><span id="preprocess_img_data-1569"><a href="#preprocess_img_data-1569"><span class="linenos">1569</span></a><span class="sd">        nr (int, optional): The number of images to preprocess. Defaults to 1.</span>
</span><span id="preprocess_img_data-1570"><a href="#preprocess_img_data-1570"><span class="linenos">1570</span></a><span class="sd">        plot (bool, optional): Whether to plot the images. Defaults to False.</span>
</span><span id="preprocess_img_data-1571"><a href="#preprocess_img_data-1571"><span class="linenos">1571</span></a><span class="sd">        mask_channels (list, optional): The channels to use for masking. Defaults to [0, 1, 2].</span>
</span><span id="preprocess_img_data-1572"><a href="#preprocess_img_data-1572"><span class="linenos">1572</span></a><span class="sd">        batch_size (list, optional): The number of images to process in each batch. Defaults to [100, 100, 100].</span>
</span><span id="preprocess_img_data-1573"><a href="#preprocess_img_data-1573"><span class="linenos">1573</span></a><span class="sd">        timelapse (bool, optional): Whether the images are from a timelapse experiment. Defaults to False.</span>
</span><span id="preprocess_img_data-1574"><a href="#preprocess_img_data-1574"><span class="linenos">1574</span></a><span class="sd">        remove_background (bool, optional): Whether to remove the background from the images. Defaults to False.</span>
</span><span id="preprocess_img_data-1575"><a href="#preprocess_img_data-1575"><span class="linenos">1575</span></a><span class="sd">        backgrounds (int, optional): The number of background images to use for background removal. Defaults to 100.</span>
</span><span id="preprocess_img_data-1576"><a href="#preprocess_img_data-1576"><span class="linenos">1576</span></a><span class="sd">        lower_percentile (float, optional): The lower percentile used for background removal. Defaults to 1.</span>
</span><span id="preprocess_img_data-1577"><a href="#preprocess_img_data-1577"><span class="linenos">1577</span></a><span class="sd">        save_dtype (type, optional): The data type used for saving the preprocessed images. Defaults to np.float32.</span>
</span><span id="preprocess_img_data-1578"><a href="#preprocess_img_data-1578"><span class="linenos">1578</span></a><span class="sd">        randomize (bool, optional): Whether to randomize the order of the images. Defaults to True.</span>
</span><span id="preprocess_img_data-1579"><a href="#preprocess_img_data-1579"><span class="linenos">1579</span></a><span class="sd">        all_to_mip (bool, optional): Whether to convert all images to MIP. Defaults to False.</span>
</span><span id="preprocess_img_data-1580"><a href="#preprocess_img_data-1580"><span class="linenos">1580</span></a><span class="sd">        pick_slice (bool, optional): Whether to pick a specific slice based on the provided skip mode. Defaults to False.</span>
</span><span id="preprocess_img_data-1581"><a href="#preprocess_img_data-1581"><span class="linenos">1581</span></a><span class="sd">        skip_mode (str, optional): The skip mode used to filter out specific slices. Defaults to &#39;01&#39;.</span>
</span><span id="preprocess_img_data-1582"><a href="#preprocess_img_data-1582"><span class="linenos">1582</span></a><span class="sd">        settings (dict, optional): Additional settings for preprocessing. Defaults to {}.</span>
</span><span id="preprocess_img_data-1583"><a href="#preprocess_img_data-1583"><span class="linenos">1583</span></a>
</span><span id="preprocess_img_data-1584"><a href="#preprocess_img_data-1584"><span class="linenos">1584</span></a><span class="sd">    Returns:</span>
</span><span id="preprocess_img_data-1585"><a href="#preprocess_img_data-1585"><span class="linenos">1585</span></a><span class="sd">        None</span>
</span><span id="preprocess_img_data-1586"><a href="#preprocess_img_data-1586"><span class="linenos">1586</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="preprocess_img_data-1587"><a href="#preprocess_img_data-1587"><span class="linenos">1587</span></a>    
</span><span id="preprocess_img_data-1588"><a href="#preprocess_img_data-1588"><span class="linenos">1588</span></a>    <span class="n">src</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
</span><span id="preprocess_img_data-1589"><a href="#preprocess_img_data-1589"><span class="linenos">1589</span></a>    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">]</span>
</span><span id="preprocess_img_data-1590"><a href="#preprocess_img_data-1590"><span class="linenos">1590</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="preprocess_img_data-1591"><a href="#preprocess_img_data-1591"><span class="linenos">1591</span></a>    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
</span><span id="preprocess_img_data-1592"><a href="#preprocess_img_data-1592"><span class="linenos">1592</span></a>    <span class="n">extension_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
</span><span id="preprocess_img_data-1593"><a href="#preprocess_img_data-1593"><span class="linenos">1593</span></a>    <span class="n">most_common_extension</span> <span class="o">=</span> <span class="n">extension_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="preprocess_img_data-1594"><a href="#preprocess_img_data-1594"><span class="linenos">1594</span></a>    <span class="n">img_format</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="preprocess_img_data-1595"><a href="#preprocess_img_data-1595"><span class="linenos">1595</span></a>    
</span><span id="preprocess_img_data-1596"><a href="#preprocess_img_data-1596"><span class="linenos">1596</span></a>    <span class="n">delete_empty_subdirectories</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="preprocess_img_data-1597"><a href="#preprocess_img_data-1597"><span class="linenos">1597</span></a>
</span><span id="preprocess_img_data-1598"><a href="#preprocess_img_data-1598"><span class="linenos">1598</span></a>    <span class="c1"># Check if the most common extension is one of the specified image formats</span>
</span><span id="preprocess_img_data-1599"><a href="#preprocess_img_data-1599"><span class="linenos">1599</span></a>    <span class="k">if</span> <span class="n">most_common_extension</span> <span class="ow">in</span> <span class="n">valid_ext</span><span class="p">:</span>
</span><span id="preprocess_img_data-1600"><a href="#preprocess_img_data-1600"><span class="linenos">1600</span></a>        <span class="n">img_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="preprocess_img_data-1601"><a href="#preprocess_img_data-1601"><span class="linenos">1601</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="n">most_common_extension</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1602"><a href="#preprocess_img_data-1602"><span class="linenos">1602</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="preprocess_img_data-1603"><a href="#preprocess_img_data-1603"><span class="linenos">1603</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find any </span><span class="si">{</span><span class="n">valid_ext</span><span class="si">}</span><span class="s1"> files in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1"> only found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1604"><a href="#preprocess_img_data-1604"><span class="linenos">1604</span></a>        
</span><span id="preprocess_img_data-1605"><a href="#preprocess_img_data-1605"><span class="linenos">1605</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;stack&#39;</span><span class="p">)):</span>
</span><span id="preprocess_img_data-1606"><a href="#preprocess_img_data-1606"><span class="linenos">1606</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing stack folder.&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1607"><a href="#preprocess_img_data-1607"><span class="linenos">1607</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;channel_stack&#39;</span><span class="p">)):</span>
</span><span id="preprocess_img_data-1608"><a href="#preprocess_img_data-1608"><span class="linenos">1608</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing channel_stack folder.&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1609"><a href="#preprocess_img_data-1609"><span class="linenos">1609</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)):</span>
</span><span id="preprocess_img_data-1610"><a href="#preprocess_img_data-1610"><span class="linenos">1610</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing norm_channel_stack folder. Skipping preprocessing&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1611"><a href="#preprocess_img_data-1611"><span class="linenos">1611</span></a>            <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span>
</span><span id="preprocess_img_data-1612"><a href="#preprocess_img_data-1612"><span class="linenos">1612</span></a>        
</span><span id="preprocess_img_data-1613"><a href="#preprocess_img_data-1613"><span class="linenos">1613</span></a>    <span class="n">mask_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]</span>
</span><span id="preprocess_img_data-1614"><a href="#preprocess_img_data-1614"><span class="linenos">1614</span></a>    <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]]</span>
</span><span id="preprocess_img_data-1615"><a href="#preprocess_img_data-1615"><span class="linenos">1615</span></a>    
</span><span id="preprocess_img_data-1616"><a href="#preprocess_img_data-1616"><span class="linenos">1616</span></a>    <span class="n">settings</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">custom_regex</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">randomize</span><span class="p">,</span> <span class="n">all_to_mip</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">save_dtype</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">random_test</span> <span class="o">=</span> <span class="n">set_default_settings_preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="preprocess_img_data-1617"><a href="#preprocess_img_data-1617"><span class="linenos">1617</span></a>    
</span><span id="preprocess_img_data-1618"><a href="#preprocess_img_data-1618"><span class="linenos">1618</span></a>    <span class="n">regex</span> <span class="o">=</span> <span class="n">_get_regex</span><span class="p">(</span><span class="n">metadata_type</span><span class="p">,</span> <span class="n">img_format</span><span class="p">,</span> <span class="n">custom_regex</span><span class="p">)</span>
</span><span id="preprocess_img_data-1619"><a href="#preprocess_img_data-1619"><span class="linenos">1619</span></a>    
</span><span id="preprocess_img_data-1620"><a href="#preprocess_img_data-1620"><span class="linenos">1620</span></a>    <span class="k">if</span> <span class="n">test_mode</span><span class="p">:</span>
</span><span id="preprocess_img_data-1621"><a href="#preprocess_img_data-1621"><span class="linenos">1621</span></a>
</span><span id="preprocess_img_data-1622"><a href="#preprocess_img_data-1622"><span class="linenos">1622</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running spacr in test mode&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1623"><a href="#preprocess_img_data-1623"><span class="linenos">1623</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="preprocess_img_data-1624"><a href="#preprocess_img_data-1624"><span class="linenos">1624</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="preprocess_img_data-1625"><a href="#preprocess_img_data-1625"><span class="linenos">1625</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span>
</span><span id="preprocess_img_data-1626"><a href="#preprocess_img_data-1626"><span class="linenos">1626</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted test directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1627"><a href="#preprocess_img_data-1627"><span class="linenos">1627</span></a>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="preprocess_img_data-1628"><a href="#preprocess_img_data-1628"><span class="linenos">1628</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting test directory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1629"><a href="#preprocess_img_data-1629"><span class="linenos">1629</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete manually before running test mode&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1630"><a href="#preprocess_img_data-1630"><span class="linenos">1630</span></a>            <span class="k">pass</span>
</span><span id="preprocess_img_data-1631"><a href="#preprocess_img_data-1631"><span class="linenos">1631</span></a>
</span><span id="preprocess_img_data-1632"><a href="#preprocess_img_data-1632"><span class="linenos">1632</span></a>        <span class="n">src</span> <span class="o">=</span> <span class="n">_run_test_mode</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">random_test</span><span class="p">)</span>
</span><span id="preprocess_img_data-1633"><a href="#preprocess_img_data-1633"><span class="linenos">1633</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="preprocess_img_data-1634"><a href="#preprocess_img_data-1634"><span class="linenos">1634</span></a>    
</span><span id="preprocess_img_data-1635"><a href="#preprocess_img_data-1635"><span class="linenos">1635</span></a>    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1636"><a href="#preprocess_img_data-1636"><span class="linenos">1636</span></a>    <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="preprocess_img_data-1637"><a href="#preprocess_img_data-1637"><span class="linenos">1637</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
</span><span id="preprocess_img_data-1638"><a href="#preprocess_img_data-1638"><span class="linenos">1638</span></a>            <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   
</span><span id="preprocess_img_data-1639"><a href="#preprocess_img_data-1639"><span class="linenos">1639</span></a>   
</span><span id="preprocess_img_data-1640"><a href="#preprocess_img_data-1640"><span class="linenos">1640</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
</span><span id="preprocess_img_data-1641"><a href="#preprocess_img_data-1641"><span class="linenos">1641</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="preprocess_img_data-1642"><a href="#preprocess_img_data-1642"><span class="linenos">1642</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="preprocess_img_data-1643"><a href="#preprocess_img_data-1643"><span class="linenos">1643</span></a>                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
</span><span id="preprocess_img_data-1644"><a href="#preprocess_img_data-1644"><span class="linenos">1644</span></a>                    <span class="n">_move_to_chan_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">)</span>
</span><span id="preprocess_img_data-1645"><a href="#preprocess_img_data-1645"><span class="linenos">1645</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="preprocess_img_data-1646"><a href="#preprocess_img_data-1646"><span class="linenos">1646</span></a>                    <span class="n">img_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.bmp&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.lif&#39;</span><span class="p">]</span>
</span><span id="preprocess_img_data-1647"><a href="#preprocess_img_data-1647"><span class="linenos">1647</span></a>                    <span class="n">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">img_format</span><span class="p">)</span>
</span><span id="preprocess_img_data-1648"><a href="#preprocess_img_data-1648"><span class="linenos">1648</span></a>                    
</span><span id="preprocess_img_data-1649"><a href="#preprocess_img_data-1649"><span class="linenos">1649</span></a>                    <span class="c1">#Make sure no batches will be of only one image</span>
</span><span id="preprocess_img_data-1650"><a href="#preprocess_img_data-1650"><span class="linenos">1650</span></a>                    <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
</span><span id="preprocess_img_data-1651"><a href="#preprocess_img_data-1651"><span class="linenos">1651</span></a>                    <span class="n">full_batches</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">//</span> <span class="n">batch_size</span>
</span><span id="preprocess_img_data-1652"><a href="#preprocess_img_data-1652"><span class="linenos">1652</span></a>                    <span class="n">last_batch_size</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">%</span> <span class="n">batch_size</span>
</span><span id="preprocess_img_data-1653"><a href="#preprocess_img_data-1653"><span class="linenos">1653</span></a>                    
</span><span id="preprocess_img_data-1654"><a href="#preprocess_img_data-1654"><span class="linenos">1654</span></a>                    <span class="c1"># Check if the last batch is of size 1</span>
</span><span id="preprocess_img_data-1655"><a href="#preprocess_img_data-1655"><span class="linenos">1655</span></a>                    <span class="k">if</span> <span class="n">last_batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="preprocess_img_data-1656"><a href="#preprocess_img_data-1656"><span class="linenos">1656</span></a>                        <span class="c1"># If there&#39;s only one batch and its size is 1, it&#39;s also an issue</span>
</span><span id="preprocess_img_data-1657"><a href="#preprocess_img_data-1657"><span class="linenos">1657</span></a>                        <span class="k">if</span> <span class="n">full_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="preprocess_img_data-1658"><a href="#preprocess_img_data-1658"><span class="linenos">1658</span></a>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1659"><a href="#preprocess_img_data-1659"><span class="linenos">1659</span></a>                        <span class="c1"># If the last batch is of size 1, merge it with the second last batch</span>
</span><span id="preprocess_img_data-1660"><a href="#preprocess_img_data-1660"><span class="linenos">1660</span></a>                        <span class="k">elif</span> <span class="n">full_batches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="preprocess_img_data-1661"><a href="#preprocess_img_data-1661"><span class="linenos">1661</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;all images: </span><span class="si">{</span><span class="n">all_imgs</span><span class="si">}</span><span class="s2">,  full batch: </span><span class="si">{</span><span class="n">full_batches</span><span class="si">}</span><span class="s2">, last batch: </span><span class="si">{</span><span class="n">last_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1662"><a href="#preprocess_img_data-1662"><span class="linenos">1662</span></a>                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Last batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1663"><a href="#preprocess_img_data-1663"><span class="linenos">1663</span></a>        
</span><span id="preprocess_img_data-1664"><a href="#preprocess_img_data-1664"><span class="linenos">1664</span></a>                <span class="n">nr_channel_folders</span> <span class="o">=</span> <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="preprocess_img_data-1665"><a href="#preprocess_img_data-1665"><span class="linenos">1665</span></a>                
</span><span id="preprocess_img_data-1666"><a href="#preprocess_img_data-1666"><span class="linenos">1666</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">nr_channel_folders</span><span class="p">:</span>
</span><span id="preprocess_img_data-1667"><a href="#preprocess_img_data-1667"><span class="linenos">1667</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of channels does not match number of channel folders. channels: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> channel folders: </span><span class="si">{</span><span class="n">nr_channel_folders</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1668"><a href="#preprocess_img_data-1668"><span class="linenos">1668</span></a>                    <span class="n">new_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nr_channel_folders</span><span class="p">))</span>
</span><span id="preprocess_img_data-1669"><a href="#preprocess_img_data-1669"><span class="linenos">1669</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changing channels from </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1670"><a href="#preprocess_img_data-1670"><span class="linenos">1670</span></a>                    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_channels</span>
</span><span id="preprocess_img_data-1671"><a href="#preprocess_img_data-1671"><span class="linenos">1671</span></a>
</span><span id="preprocess_img_data-1672"><a href="#preprocess_img_data-1672"><span class="linenos">1672</span></a>                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
</span><span id="preprocess_img_data-1673"><a href="#preprocess_img_data-1673"><span class="linenos">1673</span></a>                    <span class="n">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="preprocess_img_data-1674"><a href="#preprocess_img_data-1674"><span class="linenos">1674</span></a>
</span><span id="preprocess_img_data-1675"><a href="#preprocess_img_data-1675"><span class="linenos">1675</span></a>                <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="preprocess_img_data-1676"><a href="#preprocess_img_data-1676"><span class="linenos">1676</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/stack&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1677"><a href="#preprocess_img_data-1677"><span class="linenos">1677</span></a>                    <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
</span><span id="preprocess_img_data-1678"><a href="#preprocess_img_data-1678"><span class="linenos">1678</span></a>
</span><span id="preprocess_img_data-1679"><a href="#preprocess_img_data-1679"><span class="linenos">1679</span></a>                <span class="k">if</span> <span class="n">all_to_mip</span><span class="p">:</span>
</span><span id="preprocess_img_data-1680"><a href="#preprocess_img_data-1680"><span class="linenos">1680</span></a>                    <span class="n">_mip_all</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
</span><span id="preprocess_img_data-1681"><a href="#preprocess_img_data-1681"><span class="linenos">1681</span></a>                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
</span><span id="preprocess_img_data-1682"><a href="#preprocess_img_data-1682"><span class="linenos">1682</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/stack&#39;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1683"><a href="#preprocess_img_data-1683"><span class="linenos">1683</span></a>                        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
</span><span id="preprocess_img_data-1684"><a href="#preprocess_img_data-1684"><span class="linenos">1684</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="preprocess_img_data-1685"><a href="#preprocess_img_data-1685"><span class="linenos">1685</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="preprocess_img_data-1686"><a href="#preprocess_img_data-1686"><span class="linenos">1686</span></a>    
</span><span id="preprocess_img_data-1687"><a href="#preprocess_img_data-1687"><span class="linenos">1687</span></a>    <span class="n">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">stack_path</span><span class="p">,</span>
</span><span id="preprocess_img_data-1688"><a href="#preprocess_img_data-1688"><span class="linenos">1688</span></a>                              <span class="n">channels</span><span class="o">=</span><span class="n">mask_channels</span><span class="p">,</span>
</span><span id="preprocess_img_data-1689"><a href="#preprocess_img_data-1689"><span class="linenos">1689</span></a>                              <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
</span><span id="preprocess_img_data-1690"><a href="#preprocess_img_data-1690"><span class="linenos">1690</span></a>                              <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
</span><span id="preprocess_img_data-1691"><a href="#preprocess_img_data-1691"><span class="linenos">1691</span></a>
</span><span id="preprocess_img_data-1692"><a href="#preprocess_img_data-1692"><span class="linenos">1692</span></a>    <span class="c1">#if plot:</span>
</span><span id="preprocess_img_data-1693"><a href="#preprocess_img_data-1693"><span class="linenos">1693</span></a>    <span class="c1">#    _plot_4D_arrays(src+&#39;/norm_channel_stack&#39;, nr_npz=1, nr=nr)</span>
</span><span id="preprocess_img_data-1694"><a href="#preprocess_img_data-1694"><span class="linenos">1694</span></a>
</span><span id="preprocess_img_data-1695"><a href="#preprocess_img_data-1695"><span class="linenos">1695</span></a>    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span>
</span></pre></div>


    

                </section>
                <section id="read_plot_model_stats">
                            <input id="read_plot_model_stats-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read_plot_model_stats</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">train_file_path</span>, </span><span class="param"><span class="n">val_file_path</span>, </span><span class="param"><span class="n">save</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="read_plot_model_stats-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#read_plot_model_stats"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="read_plot_model_stats-2141"><a href="#read_plot_model_stats-2141"><span class="linenos">2141</span></a><span class="k">def</span> <span class="nf">read_plot_model_stats</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">val_file_path</span> <span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="read_plot_model_stats-2142"><a href="#read_plot_model_stats-2142"><span class="linenos">2142</span></a>    
</span><span id="read_plot_model_stats-2143"><a href="#read_plot_model_stats-2143"><span class="linenos">2143</span></a>    <span class="k">def</span> <span class="nf">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
</span><span id="read_plot_model_stats-2144"><a href="#read_plot_model_stats-2144"><span class="linenos">2144</span></a>        
</span><span id="read_plot_model_stats-2145"><a href="#read_plot_model_stats-2145"><span class="linenos">2145</span></a>        <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2146"><a href="#read_plot_model_stats-2146"><span class="linenos">2146</span></a>
</span><span id="read_plot_model_stats-2147"><a href="#read_plot_model_stats-2147"><span class="linenos">2147</span></a>        <span class="c1"># Create subplots</span>
</span><span id="read_plot_model_stats-2148"><a href="#read_plot_model_stats-2148"><span class="linenos">2148</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2149"><a href="#read_plot_model_stats-2149"><span class="linenos">2149</span></a>
</span><span id="read_plot_model_stats-2150"><a href="#read_plot_model_stats-2150"><span class="linenos">2150</span></a>        <span class="c1"># Plotting</span>
</span><span id="read_plot_model_stats-2151"><a href="#read_plot_model_stats-2151"><span class="linenos">2151</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2152"><a href="#read_plot_model_stats-2152"><span class="linenos">2152</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">val_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2153"><a href="#read_plot_model_stats-2153"><span class="linenos">2153</span></a>
</span><span id="read_plot_model_stats-2154"><a href="#read_plot_model_stats-2154"><span class="linenos">2154</span></a>        <span class="c1"># Set titles and labels</span>
</span><span id="read_plot_model_stats-2155"><a href="#read_plot_model_stats-2155"><span class="linenos">2155</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2156"><a href="#read_plot_model_stats-2156"><span class="linenos">2156</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2157"><a href="#read_plot_model_stats-2157"><span class="linenos">2157</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2158"><a href="#read_plot_model_stats-2158"><span class="linenos">2158</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2159"><a href="#read_plot_model_stats-2159"><span class="linenos">2159</span></a>
</span><span id="read_plot_model_stats-2160"><a href="#read_plot_model_stats-2160"><span class="linenos">2160</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2161"><a href="#read_plot_model_stats-2161"><span class="linenos">2161</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2162"><a href="#read_plot_model_stats-2162"><span class="linenos">2162</span></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2163"><a href="#read_plot_model_stats-2163"><span class="linenos">2163</span></a>
</span><span id="read_plot_model_stats-2164"><a href="#read_plot_model_stats-2164"><span class="linenos">2164</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="read_plot_model_stats-2165"><a href="#read_plot_model_stats-2165"><span class="linenos">2165</span></a>
</span><span id="read_plot_model_stats-2166"><a href="#read_plot_model_stats-2166"><span class="linenos">2166</span></a>        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
</span><span id="read_plot_model_stats-2167"><a href="#read_plot_model_stats-2167"><span class="linenos">2167</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2168"><a href="#read_plot_model_stats-2168"><span class="linenos">2168</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="read_plot_model_stats-2169"><a href="#read_plot_model_stats-2169"><span class="linenos">2169</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="read_plot_model_stats-2170"><a href="#read_plot_model_stats-2170"><span class="linenos">2170</span></a>
</span><span id="read_plot_model_stats-2171"><a href="#read_plot_model_stats-2171"><span class="linenos">2171</span></a>    <span class="c1"># Read the CSVs into DataFrames</span>
</span><span id="read_plot_model_stats-2172"><a href="#read_plot_model_stats-2172"><span class="linenos">2172</span></a>    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2173"><a href="#read_plot_model_stats-2173"><span class="linenos">2173</span></a>    <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">val_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2174"><a href="#read_plot_model_stats-2174"><span class="linenos">2174</span></a>
</span><span id="read_plot_model_stats-2175"><a href="#read_plot_model_stats-2175"><span class="linenos">2175</span></a>    <span class="c1"># Get the folder path for saving plots</span>
</span><span id="read_plot_model_stats-2176"><a href="#read_plot_model_stats-2176"><span class="linenos">2176</span></a>    <span class="n">fldr_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2177"><a href="#read_plot_model_stats-2177"><span class="linenos">2177</span></a>    
</span><span id="read_plot_model_stats-2178"><a href="#read_plot_model_stats-2178"><span class="linenos">2178</span></a>    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
</span><span id="read_plot_model_stats-2179"><a href="#read_plot_model_stats-2179"><span class="linenos">2179</span></a>        <span class="c1"># Setting the style</span>
</span><span id="read_plot_model_stats-2180"><a href="#read_plot_model_stats-2180"><span class="linenos">2180</span></a>        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2181"><a href="#read_plot_model_stats-2181"><span class="linenos">2181</span></a>    
</span><span id="read_plot_model_stats-2182"><a href="#read_plot_model_stats-2182"><span class="linenos">2182</span></a>    <span class="c1"># Plot and save the results</span>
</span><span id="read_plot_model_stats-2183"><a href="#read_plot_model_stats-2183"><span class="linenos">2183</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2184"><a href="#read_plot_model_stats-2184"><span class="linenos">2184</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2185"><a href="#read_plot_model_stats-2185"><span class="linenos">2185</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2186"><a href="#read_plot_model_stats-2186"><span class="linenos">2186</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2187"><a href="#read_plot_model_stats-2187"><span class="linenos">2187</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;prauc&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span><span id="read_plot_model_stats-2188"><a href="#read_plot_model_stats-2188"><span class="linenos">2188</span></a>    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="convert_numpy_to_tiff">
                            <input id="convert_numpy_to_tiff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_numpy_to_tiff</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">folder_path</span>, </span><span class="param"><span class="n">limit</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="convert_numpy_to_tiff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#convert_numpy_to_tiff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="convert_numpy_to_tiff-2447"><a href="#convert_numpy_to_tiff-2447"><span class="linenos">2447</span></a><span class="k">def</span> <span class="nf">convert_numpy_to_tiff</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="convert_numpy_to_tiff-2448"><a href="#convert_numpy_to_tiff-2448"><span class="linenos">2448</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="convert_numpy_to_tiff-2449"><a href="#convert_numpy_to_tiff-2449"><span class="linenos">2449</span></a><span class="sd">    Converts all numpy files in a folder to TIFF format and saves them in a subdirectory &#39;tiff&#39;.</span>
</span><span id="convert_numpy_to_tiff-2450"><a href="#convert_numpy_to_tiff-2450"><span class="linenos">2450</span></a><span class="sd">    </span>
</span><span id="convert_numpy_to_tiff-2451"><a href="#convert_numpy_to_tiff-2451"><span class="linenos">2451</span></a><span class="sd">    Args:</span>
</span><span id="convert_numpy_to_tiff-2452"><a href="#convert_numpy_to_tiff-2452"><span class="linenos">2452</span></a><span class="sd">    folder_path (str): The path to the folder containing numpy files.</span>
</span><span id="convert_numpy_to_tiff-2453"><a href="#convert_numpy_to_tiff-2453"><span class="linenos">2453</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="convert_numpy_to_tiff-2454"><a href="#convert_numpy_to_tiff-2454"><span class="linenos">2454</span></a>    <span class="c1"># Create the subdirectory &#39;tiff&#39; within the specified folder if it doesn&#39;t already exist</span>
</span><span id="convert_numpy_to_tiff-2455"><a href="#convert_numpy_to_tiff-2455"><span class="linenos">2455</span></a>    <span class="n">tiff_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2456"><a href="#convert_numpy_to_tiff-2456"><span class="linenos">2456</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2457"><a href="#convert_numpy_to_tiff-2457"><span class="linenos">2457</span></a>
</span><span id="convert_numpy_to_tiff-2458"><a href="#convert_numpy_to_tiff-2458"><span class="linenos">2458</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2459"><a href="#convert_numpy_to_tiff-2459"><span class="linenos">2459</span></a>
</span><span id="convert_numpy_to_tiff-2460"><a href="#convert_numpy_to_tiff-2460"><span class="linenos">2460</span></a>    <span class="n">npy_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
</span><span id="convert_numpy_to_tiff-2461"><a href="#convert_numpy_to_tiff-2461"><span class="linenos">2461</span></a>    
</span><span id="convert_numpy_to_tiff-2462"><a href="#convert_numpy_to_tiff-2462"><span class="linenos">2462</span></a>    <span class="c1"># Iterate over all files in the folder</span>
</span><span id="convert_numpy_to_tiff-2463"><a href="#convert_numpy_to_tiff-2463"><span class="linenos">2463</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
</span><span id="convert_numpy_to_tiff-2464"><a href="#convert_numpy_to_tiff-2464"><span class="linenos">2464</span></a>        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
</span><span id="convert_numpy_to_tiff-2465"><a href="#convert_numpy_to_tiff-2465"><span class="linenos">2465</span></a>            <span class="k">break</span>
</span><span id="convert_numpy_to_tiff-2466"><a href="#convert_numpy_to_tiff-2466"><span class="linenos">2466</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
</span><span id="convert_numpy_to_tiff-2467"><a href="#convert_numpy_to_tiff-2467"><span class="linenos">2467</span></a>            <span class="k">continue</span>
</span><span id="convert_numpy_to_tiff-2468"><a href="#convert_numpy_to_tiff-2468"><span class="linenos">2468</span></a>
</span><span id="convert_numpy_to_tiff-2469"><a href="#convert_numpy_to_tiff-2469"><span class="linenos">2469</span></a>        <span class="c1"># Construct the full file path</span>
</span><span id="convert_numpy_to_tiff-2470"><a href="#convert_numpy_to_tiff-2470"><span class="linenos">2470</span></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2471"><a href="#convert_numpy_to_tiff-2471"><span class="linenos">2471</span></a>        <span class="c1"># Load the numpy file</span>
</span><span id="convert_numpy_to_tiff-2472"><a href="#convert_numpy_to_tiff-2472"><span class="linenos">2472</span></a>        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2473"><a href="#convert_numpy_to_tiff-2473"><span class="linenos">2473</span></a>        
</span><span id="convert_numpy_to_tiff-2474"><a href="#convert_numpy_to_tiff-2474"><span class="linenos">2474</span></a>        <span class="c1"># Construct the output TIFF file path</span>
</span><span id="convert_numpy_to_tiff-2475"><a href="#convert_numpy_to_tiff-2475"><span class="linenos">2475</span></a>        <span class="n">tiff_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
</span><span id="convert_numpy_to_tiff-2476"><a href="#convert_numpy_to_tiff-2476"><span class="linenos">2476</span></a>        <span class="n">tiff_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">tiff_filename</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2477"><a href="#convert_numpy_to_tiff-2477"><span class="linenos">2477</span></a>        
</span><span id="convert_numpy_to_tiff-2478"><a href="#convert_numpy_to_tiff-2478"><span class="linenos">2478</span></a>        <span class="c1"># Save the numpy array as a TIFF file</span>
</span><span id="convert_numpy_to_tiff-2479"><a href="#convert_numpy_to_tiff-2479"><span class="linenos">2479</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tiff_file_path</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2480"><a href="#convert_numpy_to_tiff-2480"><span class="linenos">2480</span></a>        
</span><span id="convert_numpy_to_tiff-2481"><a href="#convert_numpy_to_tiff-2481"><span class="linenos">2481</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">tiff_filename</span><span class="si">}</span><span class="s2"> and saved in &#39;tiff&#39; subdirectory.&quot;</span><span class="p">)</span>
</span><span id="convert_numpy_to_tiff-2482"><a href="#convert_numpy_to_tiff-2482"><span class="linenos">2482</span></a>    <span class="k">return</span>
</span></pre></div>


            <div class="docstring"><p>Converts all numpy files in a folder to TIFF format and saves them in a subdirectory 'tiff'.</p>

<p>Args:
folder_path (str): The path to the folder containing numpy files.</p>
</div>


                </section>
                <section id="generate_cellpose_train_test">
                            <input id="generate_cellpose_train_test-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_cellpose_train_test</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">src</span>, </span><span class="param"><span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="generate_cellpose_train_test-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_cellpose_train_test"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_cellpose_train_test-2484"><a href="#generate_cellpose_train_test-2484"><span class="linenos">2484</span></a><span class="k">def</span> <span class="nf">generate_cellpose_train_test</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="generate_cellpose_train_test-2485"><a href="#generate_cellpose_train_test-2485"><span class="linenos">2485</span></a>    <span class="n">mask_src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2486"><a href="#generate_cellpose_train_test-2486"><span class="linenos">2486</span></a>    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;*.tif&#39;</span><span class="p">))</span>
</span><span id="generate_cellpose_train_test-2487"><a href="#generate_cellpose_train_test-2487"><span class="linenos">2487</span></a>    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">]</span>
</span><span id="generate_cellpose_train_test-2488"><a href="#generate_cellpose_train_test-2488"><span class="linenos">2488</span></a>    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_filenames</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">file</span><span class="p">))]</span>
</span><span id="generate_cellpose_train_test-2489"><a href="#generate_cellpose_train_test-2489"><span class="linenos">2489</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> images with masks&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2490"><a href="#generate_cellpose_train_test-2490"><span class="linenos">2490</span></a>    
</span><span id="generate_cellpose_train_test-2491"><a href="#generate_cellpose_train_test-2491"><span class="linenos">2491</span></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2492"><a href="#generate_cellpose_train_test-2492"><span class="linenos">2492</span></a>    <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_split</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2493"><a href="#generate_cellpose_train_test-2493"><span class="linenos">2493</span></a>    <span class="n">train_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>
</span><span id="generate_cellpose_train_test-2494"><a href="#generate_cellpose_train_test-2494"><span class="linenos">2494</span></a>    <span class="n">test_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
</span><span id="generate_cellpose_train_test-2495"><a href="#generate_cellpose_train_test-2495"><span class="linenos">2495</span></a>    <span class="n">list_of_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_files</span><span class="p">,</span> <span class="n">train_files</span><span class="p">]</span>
</span><span id="generate_cellpose_train_test-2496"><a href="#generate_cellpose_train_test-2496"><span class="linenos">2496</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Split dataset into Train </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> and Test </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2497"><a href="#generate_cellpose_train_test-2497"><span class="linenos">2497</span></a>    
</span><span id="generate_cellpose_train_test-2498"><a href="#generate_cellpose_train_test-2498"><span class="linenos">2498</span></a>    <span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2499"><a href="#generate_cellpose_train_test-2499"><span class="linenos">2499</span></a>    <span class="n">train_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2500"><a href="#generate_cellpose_train_test-2500"><span class="linenos">2500</span></a>    <span class="n">test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2501"><a href="#generate_cellpose_train_test-2501"><span class="linenos">2501</span></a>    <span class="n">test_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2502"><a href="#generate_cellpose_train_test-2502"><span class="linenos">2502</span></a>    
</span><span id="generate_cellpose_train_test-2503"><a href="#generate_cellpose_train_test-2503"><span class="linenos">2503</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2504"><a href="#generate_cellpose_train_test-2504"><span class="linenos">2504</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2505"><a href="#generate_cellpose_train_test-2505"><span class="linenos">2505</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2506"><a href="#generate_cellpose_train_test-2506"><span class="linenos">2506</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2507"><a href="#generate_cellpose_train_test-2507"><span class="linenos">2507</span></a>    
</span><span id="generate_cellpose_train_test-2508"><a href="#generate_cellpose_train_test-2508"><span class="linenos">2508</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_lists</span><span class="p">):</span>
</span><span id="generate_cellpose_train_test-2509"><a href="#generate_cellpose_train_test-2509"><span class="linenos">2509</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="generate_cellpose_train_test-2510"><a href="#generate_cellpose_train_test-2510"><span class="linenos">2510</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">test_dir</span>
</span><span id="generate_cellpose_train_test-2511"><a href="#generate_cellpose_train_test-2511"><span class="linenos">2511</span></a>            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">test_dir_masks</span>
</span><span id="generate_cellpose_train_test-2512"><a href="#generate_cellpose_train_test-2512"><span class="linenos">2512</span></a>            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
</span><span id="generate_cellpose_train_test-2513"><a href="#generate_cellpose_train_test-2513"><span class="linenos">2513</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="generate_cellpose_train_test-2514"><a href="#generate_cellpose_train_test-2514"><span class="linenos">2514</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">train_dir</span>
</span><span id="generate_cellpose_train_test-2515"><a href="#generate_cellpose_train_test-2515"><span class="linenos">2515</span></a>            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">train_dir_masks</span>
</span><span id="generate_cellpose_train_test-2516"><a href="#generate_cellpose_train_test-2516"><span class="linenos">2516</span></a>            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span>
</span><span id="generate_cellpose_train_test-2517"><a href="#generate_cellpose_train_test-2517"><span class="linenos">2517</span></a>            
</span><span id="generate_cellpose_train_test-2518"><a href="#generate_cellpose_train_test-2518"><span class="linenos">2518</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
</span><span id="generate_cellpose_train_test-2519"><a href="#generate_cellpose_train_test-2519"><span class="linenos">2519</span></a>            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2520"><a href="#generate_cellpose_train_test-2520"><span class="linenos">2520</span></a>            <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2521"><a href="#generate_cellpose_train_test-2521"><span class="linenos">2521</span></a>            <span class="n">new_img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2522"><a href="#generate_cellpose_train_test-2522"><span class="linenos">2522</span></a>            <span class="n">new_mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_mask</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>            
</span><span id="generate_cellpose_train_test-2523"><a href="#generate_cellpose_train_test-2523"><span class="linenos">2523</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">new_img_path</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2524"><a href="#generate_cellpose_train_test-2524"><span class="linenos">2524</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">new_mask_path</span><span class="p">)</span>
</span><span id="generate_cellpose_train_test-2525"><a href="#generate_cellpose_train_test-2525"><span class="linenos">2525</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copied </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images to </span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s1"> set&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span>
</span></pre></div>


    

                </section>
                <section id="parse_gz_files">
                            <input id="parse_gz_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parse_gz_files</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">folder_path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="parse_gz_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#parse_gz_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="parse_gz_files-2527"><a href="#parse_gz_files-2527"><span class="linenos">2527</span></a><span class="k">def</span> <span class="nf">parse_gz_files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
</span><span id="parse_gz_files-2528"><a href="#parse_gz_files-2528"><span class="linenos">2528</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="parse_gz_files-2529"><a href="#parse_gz_files-2529"><span class="linenos">2529</span></a><span class="sd">    Parses the .fastq.gz files in the specified folder path and returns a dictionary</span>
</span><span id="parse_gz_files-2530"><a href="#parse_gz_files-2530"><span class="linenos">2530</span></a><span class="sd">    containing the sample names and their corresponding file paths.</span>
</span><span id="parse_gz_files-2531"><a href="#parse_gz_files-2531"><span class="linenos">2531</span></a>
</span><span id="parse_gz_files-2532"><a href="#parse_gz_files-2532"><span class="linenos">2532</span></a><span class="sd">    Args:</span>
</span><span id="parse_gz_files-2533"><a href="#parse_gz_files-2533"><span class="linenos">2533</span></a><span class="sd">        folder_path (str): The path to the folder containing the .fastq.gz files.</span>
</span><span id="parse_gz_files-2534"><a href="#parse_gz_files-2534"><span class="linenos">2534</span></a>
</span><span id="parse_gz_files-2535"><a href="#parse_gz_files-2535"><span class="linenos">2535</span></a><span class="sd">    Returns:</span>
</span><span id="parse_gz_files-2536"><a href="#parse_gz_files-2536"><span class="linenos">2536</span></a><span class="sd">        dict: A dictionary where the keys are the sample names and the values are</span>
</span><span id="parse_gz_files-2537"><a href="#parse_gz_files-2537"><span class="linenos">2537</span></a><span class="sd">        dictionaries containing the file paths for the &#39;R1&#39; and &#39;R2&#39; read directions.</span>
</span><span id="parse_gz_files-2538"><a href="#parse_gz_files-2538"><span class="linenos">2538</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="parse_gz_files-2539"><a href="#parse_gz_files-2539"><span class="linenos">2539</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
</span><span id="parse_gz_files-2540"><a href="#parse_gz_files-2540"><span class="linenos">2540</span></a>    <span class="n">gz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fastq.gz&#39;</span><span class="p">)]</span>
</span><span id="parse_gz_files-2541"><a href="#parse_gz_files-2541"><span class="linenos">2541</span></a>
</span><span id="parse_gz_files-2542"><a href="#parse_gz_files-2542"><span class="linenos">2542</span></a>    <span class="n">samples_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="parse_gz_files-2543"><a href="#parse_gz_files-2543"><span class="linenos">2543</span></a>    <span class="k">for</span> <span class="n">gz_file</span> <span class="ow">in</span> <span class="n">gz_files</span><span class="p">:</span>
</span><span id="parse_gz_files-2544"><a href="#parse_gz_files-2544"><span class="linenos">2544</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">gz_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="parse_gz_files-2545"><a href="#parse_gz_files-2545"><span class="linenos">2545</span></a>        <span class="n">sample_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="parse_gz_files-2546"><a href="#parse_gz_files-2546"><span class="linenos">2546</span></a>        <span class="n">read_direction</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="parse_gz_files-2547"><a href="#parse_gz_files-2547"><span class="linenos">2547</span></a>
</span><span id="parse_gz_files-2548"><a href="#parse_gz_files-2548"><span class="linenos">2548</span></a>        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">samples_dict</span><span class="p">:</span>
</span><span id="parse_gz_files-2549"><a href="#parse_gz_files-2549"><span class="linenos">2549</span></a>            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="parse_gz_files-2550"><a href="#parse_gz_files-2550"><span class="linenos">2550</span></a>
</span><span id="parse_gz_files-2551"><a href="#parse_gz_files-2551"><span class="linenos">2551</span></a>        <span class="k">if</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R1&quot;</span><span class="p">:</span>
</span><span id="parse_gz_files-2552"><a href="#parse_gz_files-2552"><span class="linenos">2552</span></a>            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
</span><span id="parse_gz_files-2553"><a href="#parse_gz_files-2553"><span class="linenos">2553</span></a>        <span class="k">elif</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span>
</span><span id="parse_gz_files-2554"><a href="#parse_gz_files-2554"><span class="linenos">2554</span></a>            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
</span><span id="parse_gz_files-2555"><a href="#parse_gz_files-2555"><span class="linenos">2555</span></a>    <span class="k">return</span> <span class="n">samples_dict</span>
</span></pre></div>


            <div class="docstring"><p>Parses the .fastq.gz files in the specified folder path and returns a dictionary
containing the sample names and their corresponding file paths.</p>

<p>Args:
    folder_path (str): The path to the folder containing the .fastq.gz files.</p>

<p>Returns:
    dict: A dictionary where the keys are the sample names and the values are
    dictionaries containing the file paths for the 'R1' and 'R2' read directions.</p>
</div>


                </section>
                <section id="generate_dataset">
                            <input id="generate_dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span><span class="o">=</span><span class="p">{}</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="generate_dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_dataset-2557"><a href="#generate_dataset-2557"><span class="linenos">2557</span></a><span class="k">def</span> <span class="nf">generate_dataset</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
</span><span id="generate_dataset-2558"><a href="#generate_dataset-2558"><span class="linenos">2558</span></a>    
</span><span id="generate_dataset-2559"><a href="#generate_dataset-2559"><span class="linenos">2559</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">initiate_counter</span><span class="p">,</span> <span class="n">add_images_to_tar</span><span class="p">,</span> <span class="n">save_settings</span><span class="p">,</span> <span class="n">generate_path_list_from_db</span><span class="p">,</span> <span class="n">correct_paths</span>
</span><span id="generate_dataset-2560"><a href="#generate_dataset-2560"><span class="linenos">2560</span></a>    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_dataset_defaults</span>
</span><span id="generate_dataset-2561"><a href="#generate_dataset-2561"><span class="linenos">2561</span></a>
</span><span id="generate_dataset-2562"><a href="#generate_dataset-2562"><span class="linenos">2562</span></a>    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="generate_dataset-2563"><a href="#generate_dataset-2563"><span class="linenos">2563</span></a>    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;generate_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_dataset-2564"><a href="#generate_dataset-2564"><span class="linenos">2564</span></a>
</span><span id="generate_dataset-2565"><a href="#generate_dataset-2565"><span class="linenos">2565</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="generate_dataset-2566"><a href="#generate_dataset-2566"><span class="linenos">2566</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
</span><span id="generate_dataset-2567"><a href="#generate_dataset-2567"><span class="linenos">2567</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="generate_dataset-2568"><a href="#generate_dataset-2568"><span class="linenos">2568</span></a>        <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_dataset-2569"><a href="#generate_dataset-2569"><span class="linenos">2569</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
</span><span id="generate_dataset-2570"><a href="#generate_dataset-2570"><span class="linenos">2570</span></a>            <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
</span><span id="generate_dataset-2571"><a href="#generate_dataset-2571"><span class="linenos">2571</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="generate_dataset-2572"><a href="#generate_dataset-2572"><span class="linenos">2572</span></a>                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">)</span>
</span><span id="generate_dataset-2573"><a href="#generate_dataset-2573"><span class="linenos">2573</span></a>            <span class="n">paths</span> <span class="o">=</span> <span class="n">generate_path_list_from_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">file_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">])</span>
</span><span id="generate_dataset-2574"><a href="#generate_dataset-2574"><span class="linenos">2574</span></a>            <span class="n">correct_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
</span><span id="generate_dataset-2575"><a href="#generate_dataset-2575"><span class="linenos">2575</span></a>            <span class="n">all_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="generate_dataset-2576"><a href="#generate_dataset-2576"><span class="linenos">2576</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="generate_dataset-2577"><a href="#generate_dataset-2577"><span class="linenos">2577</span></a>            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
</span><span id="generate_dataset-2578"><a href="#generate_dataset-2578"><span class="linenos">2578</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2579"><a href="#generate_dataset-2579"><span class="linenos">2579</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="generate_dataset-2580"><a href="#generate_dataset-2580"><span class="linenos">2580</span></a>            <span class="n">sample</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="generate_dataset-2581"><a href="#generate_dataset-2581"><span class="linenos">2581</span></a>            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
</span><span id="generate_dataset-2582"><a href="#generate_dataset-2582"><span class="linenos">2582</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2583"><a href="#generate_dataset-2583"><span class="linenos">2583</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="generate_dataset-2584"><a href="#generate_dataset-2584"><span class="linenos">2584</span></a>            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">all_paths</span>
</span><span id="generate_dataset-2585"><a href="#generate_dataset-2585"><span class="linenos">2585</span></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
</span><span id="generate_dataset-2586"><a href="#generate_dataset-2586"><span class="linenos">2586</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All paths: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2587"><a href="#generate_dataset-2587"><span class="linenos">2587</span></a>
</span><span id="generate_dataset-2588"><a href="#generate_dataset-2588"><span class="linenos">2588</span></a>    <span class="n">total_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
</span><span id="generate_dataset-2589"><a href="#generate_dataset-2589"><span class="linenos">2589</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2590"><a href="#generate_dataset-2590"><span class="linenos">2590</span></a>
</span><span id="generate_dataset-2591"><a href="#generate_dataset-2591"><span class="linenos">2591</span></a>    <span class="c1"># Create a temp folder in dst</span>
</span><span id="generate_dataset-2592"><a href="#generate_dataset-2592"><span class="linenos">2592</span></a>    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;temp_tars&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2593"><a href="#generate_dataset-2593"><span class="linenos">2593</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_dataset-2594"><a href="#generate_dataset-2594"><span class="linenos">2594</span></a>
</span><span id="generate_dataset-2595"><a href="#generate_dataset-2595"><span class="linenos">2595</span></a>    <span class="c1"># Chunking the data</span>
</span><span id="generate_dataset-2596"><a href="#generate_dataset-2596"><span class="linenos">2596</span></a>    <span class="n">num_procs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="generate_dataset-2597"><a href="#generate_dataset-2597"><span class="linenos">2597</span></a>    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_procs</span>
</span><span id="generate_dataset-2598"><a href="#generate_dataset-2598"><span class="linenos">2598</span></a>    <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_procs</span>
</span><span id="generate_dataset-2599"><a href="#generate_dataset-2599"><span class="linenos">2599</span></a>
</span><span id="generate_dataset-2600"><a href="#generate_dataset-2600"><span class="linenos">2600</span></a>    <span class="n">paths_chunks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_dataset-2601"><a href="#generate_dataset-2601"><span class="linenos">2601</span></a>    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="generate_dataset-2602"><a href="#generate_dataset-2602"><span class="linenos">2602</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">):</span>
</span><span id="generate_dataset-2603"><a href="#generate_dataset-2603"><span class="linenos">2603</span></a>        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="generate_dataset-2604"><a href="#generate_dataset-2604"><span class="linenos">2604</span></a>        <span class="n">paths_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
</span><span id="generate_dataset-2605"><a href="#generate_dataset-2605"><span class="linenos">2605</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
</span><span id="generate_dataset-2606"><a href="#generate_dataset-2606"><span class="linenos">2606</span></a>
</span><span id="generate_dataset-2607"><a href="#generate_dataset-2607"><span class="linenos">2607</span></a>    <span class="n">temp_tar_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.tar&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)]</span>
</span><span id="generate_dataset-2608"><a href="#generate_dataset-2608"><span class="linenos">2608</span></a>
</span><span id="generate_dataset-2609"><a href="#generate_dataset-2609"><span class="linenos">2609</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating temporary tar files in </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2610"><a href="#generate_dataset-2610"><span class="linenos">2610</span></a>
</span><span id="generate_dataset-2611"><a href="#generate_dataset-2611"><span class="linenos">2611</span></a>    <span class="c1"># Initialize shared counter and lock</span>
</span><span id="generate_dataset-2612"><a href="#generate_dataset-2612"><span class="linenos">2612</span></a>    <span class="n">counter</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="generate_dataset-2613"><a href="#generate_dataset-2613"><span class="linenos">2613</span></a>    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
</span><span id="generate_dataset-2614"><a href="#generate_dataset-2614"><span class="linenos">2614</span></a>
</span><span id="generate_dataset-2615"><a href="#generate_dataset-2615"><span class="linenos">2615</span></a>    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initiate_counter</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">lock</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="generate_dataset-2616"><a href="#generate_dataset-2616"><span class="linenos">2616</span></a>        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">add_images_to_tar</span><span class="p">,</span> <span class="p">[(</span><span class="n">paths_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp_tar_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">total_images</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)])</span>
</span><span id="generate_dataset-2617"><a href="#generate_dataset-2617"><span class="linenos">2617</span></a>
</span><span id="generate_dataset-2618"><a href="#generate_dataset-2618"><span class="linenos">2618</span></a>    <span class="c1"># Combine the temporary tar files into a final tar</span>
</span><span id="generate_dataset-2619"><a href="#generate_dataset-2619"><span class="linenos">2619</span></a>    <span class="n">date_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_dataset-2620"><a href="#generate_dataset-2620"><span class="linenos">2620</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="generate_dataset-2621"><a href="#generate_dataset-2621"><span class="linenos">2621</span></a>        <span class="n">date_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_combined&quot;</span>
</span><span id="generate_dataset-2622"><a href="#generate_dataset-2622"><span class="linenos">2622</span></a>    <span class="c1">#if not settings[&#39;file_metadata&#39;] is None:</span>
</span><span id="generate_dataset-2623"><a href="#generate_dataset-2623"><span class="linenos">2623</span></a>    <span class="c1">#    tar_name = f&quot;{date_name}_{settings[&#39;experiment&#39;]}_{settings[&#39;file_metadata&#39;]}.tar&quot;</span>
</span><span id="generate_dataset-2624"><a href="#generate_dataset-2624"><span class="linenos">2624</span></a>    <span class="c1">#else:</span>
</span><span id="generate_dataset-2625"><a href="#generate_dataset-2625"><span class="linenos">2625</span></a>    <span class="n">tar_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.tar&quot;</span>
</span><span id="generate_dataset-2626"><a href="#generate_dataset-2626"><span class="linenos">2626</span></a>    <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name</span><span class="p">)</span>
</span><span id="generate_dataset-2627"><a href="#generate_dataset-2627"><span class="linenos">2627</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tar_name</span><span class="p">):</span>
</span><span id="generate_dataset-2628"><a href="#generate_dataset-2628"><span class="linenos">2628</span></a>        <span class="n">number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="generate_dataset-2629"><a href="#generate_dataset-2629"><span class="linenos">2629</span></a>        <span class="n">tar_name_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2">.tar&quot;</span>
</span><span id="generate_dataset-2630"><a href="#generate_dataset-2630"><span class="linenos">2630</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> exists, saving as </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name_2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2631"><a href="#generate_dataset-2631"><span class="linenos">2631</span></a>        <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name_2</span><span class="p">)</span>
</span><span id="generate_dataset-2632"><a href="#generate_dataset-2632"><span class="linenos">2632</span></a>
</span><span id="generate_dataset-2633"><a href="#generate_dataset-2633"><span class="linenos">2633</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging temporary files&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2634"><a href="#generate_dataset-2634"><span class="linenos">2634</span></a>
</span><span id="generate_dataset-2635"><a href="#generate_dataset-2635"><span class="linenos">2635</span></a>    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">final_tar</span><span class="p">:</span>
</span><span id="generate_dataset-2636"><a href="#generate_dataset-2636"><span class="linenos">2636</span></a>        <span class="k">for</span> <span class="n">temp_tar_path</span> <span class="ow">in</span> <span class="n">temp_tar_files</span><span class="p">:</span>
</span><span id="generate_dataset-2637"><a href="#generate_dataset-2637"><span class="linenos">2637</span></a>            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_tar</span><span class="p">:</span>
</span><span id="generate_dataset-2638"><a href="#generate_dataset-2638"><span class="linenos">2638</span></a>                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
</span><span id="generate_dataset-2639"><a href="#generate_dataset-2639"><span class="linenos">2639</span></a>                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span id="generate_dataset-2640"><a href="#generate_dataset-2640"><span class="linenos">2640</span></a>                    <span class="n">final_tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span>
</span><span id="generate_dataset-2641"><a href="#generate_dataset-2641"><span class="linenos">2641</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">)</span>
</span><span id="generate_dataset-2642"><a href="#generate_dataset-2642"><span class="linenos">2642</span></a>
</span><span id="generate_dataset-2643"><a href="#generate_dataset-2643"><span class="linenos">2643</span></a>    <span class="c1"># Delete the temp folder</span>
</span><span id="generate_dataset-2644"><a href="#generate_dataset-2644"><span class="linenos">2644</span></a>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</span><span id="generate_dataset-2645"><a href="#generate_dataset-2645"><span class="linenos">2645</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images to </span><span class="si">{</span><span class="n">tar_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="generate_dataset-2646"><a href="#generate_dataset-2646"><span class="linenos">2646</span></a>
</span><span id="generate_dataset-2647"><a href="#generate_dataset-2647"><span class="linenos">2647</span></a>    <span class="k">return</span> <span class="n">tar_name</span>
</span></pre></div>


    

                </section>
                <section id="generate_loaders">
                            <input id="generate_loaders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_loaders</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">src</span>,</span><span class="param">	<span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span>,</span><span class="param">	<span class="n">image_size</span><span class="o">=</span><span class="mi">224</span>,</span><span class="param">	<span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>,</span><span class="param">	<span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">validation_split</span><span class="o">=</span><span class="mf">0.0</span>,</span><span class="param">	<span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">normalize</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>,</span><span class="param">	<span class="n">augment</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="generate_loaders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_loaders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_loaders-2649"><a href="#generate_loaders-2649"><span class="linenos">2649</span></a><span class="k">def</span> <span class="nf">generate_loaders</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span><span class="s1">&#39;pc&#39;</span><span class="p">],</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="generate_loaders-2650"><a href="#generate_loaders-2650"><span class="linenos">2650</span></a><span class="w">    </span>
</span><span id="generate_loaders-2651"><a href="#generate_loaders-2651"><span class="linenos">2651</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="generate_loaders-2652"><a href="#generate_loaders-2652"><span class="linenos">2652</span></a><span class="sd">    Generate data loaders for training and validation/test datasets.</span>
</span><span id="generate_loaders-2653"><a href="#generate_loaders-2653"><span class="linenos">2653</span></a>
</span><span id="generate_loaders-2654"><a href="#generate_loaders-2654"><span class="linenos">2654</span></a><span class="sd">    Parameters:</span>
</span><span id="generate_loaders-2655"><a href="#generate_loaders-2655"><span class="linenos">2655</span></a><span class="sd">    - src (str): The source directory containing the data.</span>
</span><span id="generate_loaders-2656"><a href="#generate_loaders-2656"><span class="linenos">2656</span></a><span class="sd">    - mode (str): The mode of operation. Options are &#39;train&#39; or &#39;test&#39;.</span>
</span><span id="generate_loaders-2657"><a href="#generate_loaders-2657"><span class="linenos">2657</span></a><span class="sd">    - image_size (int): The size of the input images.</span>
</span><span id="generate_loaders-2658"><a href="#generate_loaders-2658"><span class="linenos">2658</span></a><span class="sd">    - batch_size (int): The batch size for the data loaders.</span>
</span><span id="generate_loaders-2659"><a href="#generate_loaders-2659"><span class="linenos">2659</span></a><span class="sd">    - classes (list): The list of classes to consider.</span>
</span><span id="generate_loaders-2660"><a href="#generate_loaders-2660"><span class="linenos">2660</span></a><span class="sd">    - n_jobs (int): The number of worker threads for data loading.</span>
</span><span id="generate_loaders-2661"><a href="#generate_loaders-2661"><span class="linenos">2661</span></a><span class="sd">    - validation_split (float): The fraction of data to use for validation.</span>
</span><span id="generate_loaders-2662"><a href="#generate_loaders-2662"><span class="linenos">2662</span></a><span class="sd">    - pin_memory (bool): Whether to pin memory for faster data transfer.</span>
</span><span id="generate_loaders-2663"><a href="#generate_loaders-2663"><span class="linenos">2663</span></a><span class="sd">    - normalize (bool): Whether to normalize the input images.</span>
</span><span id="generate_loaders-2664"><a href="#generate_loaders-2664"><span class="linenos">2664</span></a><span class="sd">    - verbose (bool): Whether to print additional information and show images.</span>
</span><span id="generate_loaders-2665"><a href="#generate_loaders-2665"><span class="linenos">2665</span></a><span class="sd">    - channels (list): The list of channels to retain. Options are [1, 2, 3] for all channels, [1, 2] for blue and green, etc.</span>
</span><span id="generate_loaders-2666"><a href="#generate_loaders-2666"><span class="linenos">2666</span></a>
</span><span id="generate_loaders-2667"><a href="#generate_loaders-2667"><span class="linenos">2667</span></a><span class="sd">    Returns:</span>
</span><span id="generate_loaders-2668"><a href="#generate_loaders-2668"><span class="linenos">2668</span></a><span class="sd">    - train_loaders (list): List of data loaders for training datasets.</span>
</span><span id="generate_loaders-2669"><a href="#generate_loaders-2669"><span class="linenos">2669</span></a><span class="sd">    - val_loaders (list): List of data loaders for validation datasets.</span>
</span><span id="generate_loaders-2670"><a href="#generate_loaders-2670"><span class="linenos">2670</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="generate_loaders-2671"><a href="#generate_loaders-2671"><span class="linenos">2671</span></a>
</span><span id="generate_loaders-2672"><a href="#generate_loaders-2672"><span class="linenos">2672</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">SelectChannels</span><span class="p">,</span> <span class="n">augment_dataset</span>
</span><span id="generate_loaders-2673"><a href="#generate_loaders-2673"><span class="linenos">2673</span></a>
</span><span id="generate_loaders-2674"><a href="#generate_loaders-2674"><span class="linenos">2674</span></a>    <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_loaders-2675"><a href="#generate_loaders-2675"><span class="linenos">2675</span></a>
</span><span id="generate_loaders-2676"><a href="#generate_loaders-2676"><span class="linenos">2676</span></a>    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="generate_loaders-2677"><a href="#generate_loaders-2677"><span class="linenos">2677</span></a>        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="generate_loaders-2678"><a href="#generate_loaders-2678"><span class="linenos">2678</span></a>    <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="generate_loaders-2679"><a href="#generate_loaders-2679"><span class="linenos">2679</span></a>        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="generate_loaders-2680"><a href="#generate_loaders-2680"><span class="linenos">2680</span></a>    <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="generate_loaders-2681"><a href="#generate_loaders-2681"><span class="linenos">2681</span></a>        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="generate_loaders-2682"><a href="#generate_loaders-2682"><span class="linenos">2682</span></a>
</span><span id="generate_loaders-2683"><a href="#generate_loaders-2683"><span class="linenos">2683</span></a>    <span class="n">channels</span> <span class="o">=</span> <span class="n">chans</span>
</span><span id="generate_loaders-2684"><a href="#generate_loaders-2684"><span class="linenos">2684</span></a>
</span><span id="generate_loaders-2685"><a href="#generate_loaders-2685"><span class="linenos">2685</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="generate_loaders-2686"><a href="#generate_loaders-2686"><span class="linenos">2686</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training a network on channels: </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2687"><a href="#generate_loaders-2687"><span class="linenos">2687</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel 1: Red, Channel 2: Green, Channel 3: Blue&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2688"><a href="#generate_loaders-2688"><span class="linenos">2688</span></a>        
</span><span id="generate_loaders-2689"><a href="#generate_loaders-2689"><span class="linenos">2689</span></a>    <span class="n">train_loaders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_loaders-2690"><a href="#generate_loaders-2690"><span class="linenos">2690</span></a>    <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_loaders-2691"><a href="#generate_loaders-2691"><span class="linenos">2691</span></a>
</span><span id="generate_loaders-2692"><a href="#generate_loaders-2692"><span class="linenos">2692</span></a>    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="generate_loaders-2693"><a href="#generate_loaders-2693"><span class="linenos">2693</span></a>        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
</span><span id="generate_loaders-2694"><a href="#generate_loaders-2694"><span class="linenos">2694</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
</span><span id="generate_loaders-2695"><a href="#generate_loaders-2695"><span class="linenos">2695</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
</span><span id="generate_loaders-2696"><a href="#generate_loaders-2696"><span class="linenos">2696</span></a>            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span>
</span><span id="generate_loaders-2697"><a href="#generate_loaders-2697"><span class="linenos">2697</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
</span><span id="generate_loaders-2698"><a href="#generate_loaders-2698"><span class="linenos">2698</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="generate_loaders-2699"><a href="#generate_loaders-2699"><span class="linenos">2699</span></a>        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
</span><span id="generate_loaders-2700"><a href="#generate_loaders-2700"><span class="linenos">2700</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
</span><span id="generate_loaders-2701"><a href="#generate_loaders-2701"><span class="linenos">2701</span></a>            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
</span><span id="generate_loaders-2702"><a href="#generate_loaders-2702"><span class="linenos">2702</span></a>            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)])</span>
</span><span id="generate_loaders-2703"><a href="#generate_loaders-2703"><span class="linenos">2703</span></a>
</span><span id="generate_loaders-2704"><a href="#generate_loaders-2704"><span class="linenos">2704</span></a>    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
</span><span id="generate_loaders-2705"><a href="#generate_loaders-2705"><span class="linenos">2705</span></a>        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2706"><a href="#generate_loaders-2706"><span class="linenos">2706</span></a>        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="generate_loaders-2707"><a href="#generate_loaders-2707"><span class="linenos">2707</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading Train and validation datasets&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2708"><a href="#generate_loaders-2708"><span class="linenos">2708</span></a>    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
</span><span id="generate_loaders-2709"><a href="#generate_loaders-2709"><span class="linenos">2709</span></a>        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2710"><a href="#generate_loaders-2710"><span class="linenos">2710</span></a>        <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_loaders-2711"><a href="#generate_loaders-2711"><span class="linenos">2711</span></a>        <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="generate_loaders-2712"><a href="#generate_loaders-2712"><span class="linenos">2712</span></a>        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="generate_loaders-2713"><a href="#generate_loaders-2713"><span class="linenos">2713</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading test dataset&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2714"><a href="#generate_loaders-2714"><span class="linenos">2714</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="generate_loaders-2715"><a href="#generate_loaders-2715"><span class="linenos">2715</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not valid, use mode = train or test&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2716"><a href="#generate_loaders-2716"><span class="linenos">2716</span></a>        <span class="k">return</span>
</span><span id="generate_loaders-2717"><a href="#generate_loaders-2717"><span class="linenos">2717</span></a>    
</span><span id="generate_loaders-2718"><a href="#generate_loaders-2718"><span class="linenos">2718</span></a>    <span class="n">class_1_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="generate_loaders-2719"><a href="#generate_loaders-2719"><span class="linenos">2719</span></a>    <span class="n">class_2_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="generate_loaders-2720"><a href="#generate_loaders-2720"><span class="linenos">2720</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_1_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_2_path</span><span class="p">):</span>
</span><span id="generate_loaders-2721"><a href="#generate_loaders-2721"><span class="linenos">2721</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One or more classes not found in </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2722"><a href="#generate_loaders-2722"><span class="linenos">2722</span></a>        <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Possible class names are </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2723"><a href="#generate_loaders-2723"><span class="linenos">2723</span></a>
</span><span id="generate_loaders-2724"><a href="#generate_loaders-2724"><span class="linenos">2724</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">spacrDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">)</span>
</span><span id="generate_loaders-2725"><a href="#generate_loaders-2725"><span class="linenos">2725</span></a>    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="generate_loaders-2726"><a href="#generate_loaders-2726"><span class="linenos">2726</span></a>    
</span><span id="generate_loaders-2727"><a href="#generate_loaders-2727"><span class="linenos">2727</span></a>    <span class="k">if</span> <span class="n">validation_split</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="generate_loaders-2728"><a href="#generate_loaders-2728"><span class="linenos">2728</span></a>        <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">validation_split</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span><span id="generate_loaders-2729"><a href="#generate_loaders-2729"><span class="linenos">2729</span></a>        <span class="n">val_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
</span><span id="generate_loaders-2730"><a href="#generate_loaders-2730"><span class="linenos">2730</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">augment</span><span class="p">:</span>
</span><span id="generate_loaders-2731"><a href="#generate_loaders-2731"><span class="linenos">2731</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data:</span><span class="si">{</span><span class="n">train_size</span><span class="si">}</span><span class="s1">, Validation data:</span><span class="si">{</span><span class="n">val_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2732"><a href="#generate_loaders-2732"><span class="linenos">2732</span></a>        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">val_size</span><span class="p">])</span>
</span><span id="generate_loaders-2733"><a href="#generate_loaders-2733"><span class="linenos">2733</span></a>
</span><span id="generate_loaders-2734"><a href="#generate_loaders-2734"><span class="linenos">2734</span></a>        <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
</span><span id="generate_loaders-2735"><a href="#generate_loaders-2735"><span class="linenos">2735</span></a>
</span><span id="generate_loaders-2736"><a href="#generate_loaders-2736"><span class="linenos">2736</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data before augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">, Validataion:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2737"><a href="#generate_loaders-2737"><span class="linenos">2737</span></a>            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">augment_dataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">is_grayscale</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="generate_loaders-2738"><a href="#generate_loaders-2738"><span class="linenos">2738</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data after augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2739"><a href="#generate_loaders-2739"><span class="linenos">2739</span></a>            
</span><span id="generate_loaders-2740"><a href="#generate_loaders-2740"><span class="linenos">2740</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating Dataloader with </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s1"> workers&#39;</span><span class="p">)</span>
</span><span id="generate_loaders-2741"><a href="#generate_loaders-2741"><span class="linenos">2741</span></a>        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_loaders-2742"><a href="#generate_loaders-2742"><span class="linenos">2742</span></a>        <span class="n">val_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_loaders-2743"><a href="#generate_loaders-2743"><span class="linenos">2743</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="generate_loaders-2744"><a href="#generate_loaders-2744"><span class="linenos">2744</span></a>        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_loaders-2745"><a href="#generate_loaders-2745"><span class="linenos">2745</span></a>
</span><span id="generate_loaders-2746"><a href="#generate_loaders-2746"><span class="linenos">2746</span></a>    <span class="c1">#dataset (Dataset)  dataset from which to load the data.</span>
</span><span id="generate_loaders-2747"><a href="#generate_loaders-2747"><span class="linenos">2747</span></a>    <span class="c1">#batch_size (int, optional)  how many samples per batch to load (default: 1).</span>
</span><span id="generate_loaders-2748"><a href="#generate_loaders-2748"><span class="linenos">2748</span></a>    <span class="c1">#shuffle (bool, optional)  set to True to have the data reshuffled at every epoch (default: False).</span>
</span><span id="generate_loaders-2749"><a href="#generate_loaders-2749"><span class="linenos">2749</span></a>    <span class="c1">#sampler (Sampler or Iterable, optional)  defines the strategy to draw samples from the dataset. Can be any Iterable with __len__ implemented. If specified, shuffle must not be specified.</span>
</span><span id="generate_loaders-2750"><a href="#generate_loaders-2750"><span class="linenos">2750</span></a>    <span class="c1">#batch_sampler (Sampler or Iterable, optional)  like sampler, but returns a batch of indices at a time. Mutually exclusive with batch_size, shuffle, sampler, and drop_last.</span>
</span><span id="generate_loaders-2751"><a href="#generate_loaders-2751"><span class="linenos">2751</span></a>    <span class="c1">#num_workers (int, optional)  how many subprocesses to use for data loading. 0 means that the data will be loaded in the main process. (default: 0)</span>
</span><span id="generate_loaders-2752"><a href="#generate_loaders-2752"><span class="linenos">2752</span></a>    <span class="c1">#collate_fn (Callable, optional)  merges a list of samples to form a mini-batch of Tensor(s). Used when using batched loading from a map-style dataset.</span>
</span><span id="generate_loaders-2753"><a href="#generate_loaders-2753"><span class="linenos">2753</span></a>    <span class="c1">#pin_memory (bool, optional)  If True, the data loader will copy Tensors into device/CUDA pinned memory before returning them. If your data elements are a custom type, or your collate_fn returns a batch that is a custom type, see the example below.</span>
</span><span id="generate_loaders-2754"><a href="#generate_loaders-2754"><span class="linenos">2754</span></a>    <span class="c1">#drop_last (bool, optional)  set to True to drop the last incomplete batch, if the dataset size is not divisible by the batch size. If False and the size of dataset is not divisible by the batch size, then the last batch will be smaller. (default: False)</span>
</span><span id="generate_loaders-2755"><a href="#generate_loaders-2755"><span class="linenos">2755</span></a>    <span class="c1">#timeout (numeric, optional)  if positive, the timeout value for collecting a batch from workers. Should always be non-negative. (default: 0)</span>
</span><span id="generate_loaders-2756"><a href="#generate_loaders-2756"><span class="linenos">2756</span></a>    <span class="c1">#worker_init_fn (Callable, optional)  If not None, this will be called on each worker subprocess with the worker id (an int in [0, num_workers - 1]) as input, after seeding and before data loading. (default: None)</span>
</span><span id="generate_loaders-2757"><a href="#generate_loaders-2757"><span class="linenos">2757</span></a>    <span class="c1">#multiprocessing_context (str or multiprocessing.context.BaseContext, optional)  If None, the default multiprocessing context of your operating system will be used. (default: None)</span>
</span><span id="generate_loaders-2758"><a href="#generate_loaders-2758"><span class="linenos">2758</span></a>    <span class="c1">#generator (torch.Generator, optional)  If not None, this RNG will be used by RandomSampler to generate random indexes and multiprocessing to generate base_seed for workers. (default: None)</span>
</span><span id="generate_loaders-2759"><a href="#generate_loaders-2759"><span class="linenos">2759</span></a>    <span class="c1">#prefetch_factor (int, optional, keyword-only arg)  Number of batches loaded in advance by each worker. 2 means there will be a total of 2 * num_workers batches prefetched across all workers. (default value depends on the set value for num_workers. If value of num_workers=0 default is None. Otherwise, if value of num_workers &gt; 0 default is 2).</span>
</span><span id="generate_loaders-2760"><a href="#generate_loaders-2760"><span class="linenos">2760</span></a>    <span class="c1">#persistent_workers (bool, optional)  If True, the data loader will not shut down the worker processes after a dataset has been consumed once. This allows to maintain the workers Dataset instances alive. (default: False)</span>
</span><span id="generate_loaders-2761"><a href="#generate_loaders-2761"><span class="linenos">2761</span></a>    <span class="c1">#pin_memory_device (str, optional)  the device to pin_memory to if pin_memory is True.</span>
</span><span id="generate_loaders-2762"><a href="#generate_loaders-2762"><span class="linenos">2762</span></a>
</span><span id="generate_loaders-2763"><a href="#generate_loaders-2763"><span class="linenos">2763</span></a>    <span class="c1">#images, labels, filenames = next(iter(train_loaders))</span>
</span><span id="generate_loaders-2764"><a href="#generate_loaders-2764"><span class="linenos">2764</span></a>    <span class="c1">#images = images.cpu()</span>
</span><span id="generate_loaders-2765"><a href="#generate_loaders-2765"><span class="linenos">2765</span></a>    <span class="c1">#label_strings = [str(label.item()) for label in labels]</span>
</span><span id="generate_loaders-2766"><a href="#generate_loaders-2766"><span class="linenos">2766</span></a>    <span class="c1">#train_fig = _imshow_gpu(images, label_strings, nrow=20, fontsize=12)</span>
</span><span id="generate_loaders-2767"><a href="#generate_loaders-2767"><span class="linenos">2767</span></a>    <span class="c1">#if verbose:</span>
</span><span id="generate_loaders-2768"><a href="#generate_loaders-2768"><span class="linenos">2768</span></a>    <span class="c1">#    plt.show()</span>
</span><span id="generate_loaders-2769"><a href="#generate_loaders-2769"><span class="linenos">2769</span></a>    
</span><span id="generate_loaders-2770"><a href="#generate_loaders-2770"><span class="linenos">2770</span></a>    <span class="n">train_fig</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="generate_loaders-2771"><a href="#generate_loaders-2771"><span class="linenos">2771</span></a>
</span><span id="generate_loaders-2772"><a href="#generate_loaders-2772"><span class="linenos">2772</span></a>    <span class="k">return</span> <span class="n">train_loaders</span><span class="p">,</span> <span class="n">val_loaders</span><span class="p">,</span> <span class="n">train_fig</span>
</span></pre></div>


            <div class="docstring"><p>Generate data loaders for training and validation/test datasets.</p>

<p>Parameters:</p>

<ul>
<li>src (str): The source directory containing the data.</li>
<li>mode (str): The mode of operation. Options are 'train' or 'test'.</li>
<li>image_size (int): The size of the input images.</li>
<li>batch_size (int): The batch size for the data loaders.</li>
<li>classes (list): The list of classes to consider.</li>
<li>n_jobs (int): The number of worker threads for data loading.</li>
<li>validation_split (float): The fraction of data to use for validation.</li>
<li>pin_memory (bool): Whether to pin memory for faster data transfer.</li>
<li>normalize (bool): Whether to normalize the input images.</li>
<li>verbose (bool): Whether to print additional information and show images.</li>
<li>channels (list): The list of channels to retain. Options are [1, 2, 3] for all channels, [1, 2] for blue and green, etc.</li>
</ul>

<p>Returns:</p>

<ul>
<li>train_loaders (list): List of data loaders for training datasets.</li>
<li>val_loaders (list): List of data loaders for validation datasets.</li>
</ul>
</div>


                </section>
                <section id="generate_training_dataset">
                            <input id="generate_training_dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_training_dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="generate_training_dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_training_dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_training_dataset-2774"><a href="#generate_training_dataset-2774"><span class="linenos">2774</span></a><span class="k">def</span> <span class="nf">generate_training_dataset</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="generate_training_dataset-2775"><a href="#generate_training_dataset-2775"><span class="linenos">2775</span></a>    
</span><span id="generate_training_dataset-2776"><a href="#generate_training_dataset-2776"><span class="linenos">2776</span></a>    <span class="c1"># Function to filter png_list_df by prcfo present in df without merging</span>
</span><span id="generate_training_dataset-2777"><a href="#generate_training_dataset-2777"><span class="linenos">2777</span></a>    <span class="k">def</span> <span class="nf">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
</span><span id="generate_training_dataset-2778"><a href="#generate_training_dataset-2778"><span class="linenos">2778</span></a>        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
</span><span id="generate_training_dataset-2779"><a href="#generate_training_dataset-2779"><span class="linenos">2779</span></a>                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
</span><span id="generate_training_dataset-2780"><a href="#generate_training_dataset-2780"><span class="linenos">2780</span></a>                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_training_dataset-2781"><a href="#generate_training_dataset-2781"><span class="linenos">2781</span></a>                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
</span><span id="generate_training_dataset-2782"><a href="#generate_training_dataset-2782"><span class="linenos">2782</span></a>                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2783"><a href="#generate_training_dataset-2783"><span class="linenos">2783</span></a>                
</span><span id="generate_training_dataset-2784"><a href="#generate_training_dataset-2784"><span class="linenos">2784</span></a>        <span class="p">[</span><span class="n">png_list_df</span><span class="p">]</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2785"><a href="#generate_training_dataset-2785"><span class="linenos">2785</span></a>        <span class="n">filtered_png_list_df</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
</span><span id="generate_training_dataset-2786"><a href="#generate_training_dataset-2786"><span class="linenos">2786</span></a>        <span class="k">return</span> <span class="n">filtered_png_list_df</span>
</span><span id="generate_training_dataset-2787"><a href="#generate_training_dataset-2787"><span class="linenos">2787</span></a>
</span><span id="generate_training_dataset-2788"><a href="#generate_training_dataset-2788"><span class="linenos">2788</span></a>    <span class="c1"># Function to get the smallest class size based on the dataset mode</span>
</span><span id="generate_training_dataset-2789"><a href="#generate_training_dataset-2789"><span class="linenos">2789</span></a>    <span class="k">def</span> <span class="nf">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">dataset_mode</span><span class="p">):</span>
</span><span id="generate_training_dataset-2790"><a href="#generate_training_dataset-2790"><span class="linenos">2790</span></a>        <span class="k">if</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
</span><span id="generate_training_dataset-2791"><a href="#generate_training_dataset-2791"><span class="linenos">2791</span></a>            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]]</span>
</span><span id="generate_training_dataset-2792"><a href="#generate_training_dataset-2792"><span class="linenos">2792</span></a>            <span class="c1">#sizes = [len(df[df[&#39;condition&#39;].isin(class_list)]) for class_list in settings[&#39;class_metadata&#39;]]</span>
</span><span id="generate_training_dataset-2793"><a href="#generate_training_dataset-2793"><span class="linenos">2793</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class sizes: </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2794"><a href="#generate_training_dataset-2794"><span class="linenos">2794</span></a>        <span class="k">elif</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
</span><span id="generate_training_dataset-2795"><a href="#generate_training_dataset-2795"><span class="linenos">2795</span></a>            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span> <span class="k">for</span> <span class="n">class_paths</span> <span class="ow">in</span> <span class="n">df</span><span class="p">]</span>
</span><span id="generate_training_dataset-2796"><a href="#generate_training_dataset-2796"><span class="linenos">2796</span></a>        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
</span><span id="generate_training_dataset-2797"><a href="#generate_training_dataset-2797"><span class="linenos">2797</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using the smallest class size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2798"><a href="#generate_training_dataset-2798"><span class="linenos">2798</span></a>        <span class="k">return</span> <span class="n">size</span>
</span><span id="generate_training_dataset-2799"><a href="#generate_training_dataset-2799"><span class="linenos">2799</span></a>    
</span><span id="generate_training_dataset-2800"><a href="#generate_training_dataset-2800"><span class="linenos">2800</span></a>    <span class="c1"># Measurement-based selection logic</span>
</span><span id="generate_training_dataset-2801"><a href="#generate_training_dataset-2801"><span class="linenos">2801</span></a>    <span class="k">def</span> <span class="nf">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
</span><span id="generate_training_dataset-2802"><a href="#generate_training_dataset-2802"><span class="linenos">2802</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_training_dataset-2803"><a href="#generate_training_dataset-2803"><span class="linenos">2803</span></a>        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
</span><span id="generate_training_dataset-2804"><a href="#generate_training_dataset-2804"><span class="linenos">2804</span></a>                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
</span><span id="generate_training_dataset-2805"><a href="#generate_training_dataset-2805"><span class="linenos">2805</span></a>                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="generate_training_dataset-2806"><a href="#generate_training_dataset-2806"><span class="linenos">2806</span></a>                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
</span><span id="generate_training_dataset-2807"><a href="#generate_training_dataset-2807"><span class="linenos">2807</span></a>                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2808"><a href="#generate_training_dataset-2808"><span class="linenos">2808</span></a>
</span><span id="generate_training_dataset-2809"><a href="#generate_training_dataset-2809"><span class="linenos">2809</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 1&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</span><span id="generate_training_dataset-2810"><a href="#generate_training_dataset-2810"><span class="linenos">2810</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HeLa&#39;</span><span class="p">],</span> <span class="n">pathogens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">],</span> <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">],</span>
</span><span id="generate_training_dataset-2811"><a href="#generate_training_dataset-2811"><span class="linenos">2811</span></a>                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span><span class="c1">#, types=settings[&#39;metadata_type_by&#39;])</span>
</span><span id="generate_training_dataset-2812"><a href="#generate_training_dataset-2812"><span class="linenos">2812</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 2&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
</span><span id="generate_training_dataset-2813"><a href="#generate_training_dataset-2813"><span class="linenos">2813</span></a>        
</span><span id="generate_training_dataset-2814"><a href="#generate_training_dataset-2814"><span class="linenos">2814</span></a>        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2815"><a href="#generate_training_dataset-2815"><span class="linenos">2815</span></a>
</span><span id="generate_training_dataset-2816"><a href="#generate_training_dataset-2816"><span class="linenos">2816</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">]:</span>
</span><span id="generate_training_dataset-2817"><a href="#generate_training_dataset-2817"><span class="linenos">2817</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="generate_training_dataset-2818"><a href="#generate_training_dataset-2818"><span class="linenos">2818</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="generate_training_dataset-2819"><a href="#generate_training_dataset-2819"><span class="linenos">2819</span></a>                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="generate_training_dataset-2820"><a href="#generate_training_dataset-2820"><span class="linenos">2820</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="generate_training_dataset-2821"><a href="#generate_training_dataset-2821"><span class="linenos">2821</span></a>                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="generate_training_dataset-2822"><a href="#generate_training_dataset-2822"><span class="linenos">2822</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="generate_training_dataset-2823"><a href="#generate_training_dataset-2823"><span class="linenos">2823</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;custom_measurement should be a list.&quot;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2824"><a href="#generate_training_dataset-2824"><span class="linenos">2824</span></a>                <span class="k">return</span>
</span><span id="generate_training_dataset-2825"><a href="#generate_training_dataset-2825"><span class="linenos">2825</span></a>
</span><span id="generate_training_dataset-2826"><a href="#generate_training_dataset-2826"><span class="linenos">2826</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="generate_training_dataset-2827"><a href="#generate_training_dataset-2827"><span class="linenos">2827</span></a>            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pathogen_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cytoplasm_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span>
</span><span id="generate_training_dataset-2828"><a href="#generate_training_dataset-2828"><span class="linenos">2828</span></a>
</span><span id="generate_training_dataset-2829"><a href="#generate_training_dataset-2829"><span class="linenos">2829</span></a>        <span class="n">q25</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
</span><span id="generate_training_dataset-2830"><a href="#generate_training_dataset-2830"><span class="linenos">2830</span></a>        <span class="n">q75</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
</span><span id="generate_training_dataset-2831"><a href="#generate_training_dataset-2831"><span class="linenos">2831</span></a>        <span class="n">df_lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">q25</span><span class="p">]</span>
</span><span id="generate_training_dataset-2832"><a href="#generate_training_dataset-2832"><span class="linenos">2832</span></a>        <span class="n">df_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">q75</span><span class="p">]</span>
</span><span id="generate_training_dataset-2833"><a href="#generate_training_dataset-2833"><span class="linenos">2833</span></a>
</span><span id="generate_training_dataset-2834"><a href="#generate_training_dataset-2834"><span class="linenos">2834</span></a>        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_lower</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2835"><a href="#generate_training_dataset-2835"><span class="linenos">2835</span></a>        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2836"><a href="#generate_training_dataset-2836"><span class="linenos">2836</span></a>        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">)</span>
</span><span id="generate_training_dataset-2837"><a href="#generate_training_dataset-2837"><span class="linenos">2837</span></a>
</span><span id="generate_training_dataset-2838"><a href="#generate_training_dataset-2838"><span class="linenos">2838</span></a>        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_upper</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2839"><a href="#generate_training_dataset-2839"><span class="linenos">2839</span></a>        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2840"><a href="#generate_training_dataset-2840"><span class="linenos">2840</span></a>        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">)</span>
</span><span id="generate_training_dataset-2841"><a href="#generate_training_dataset-2841"><span class="linenos">2841</span></a>
</span><span id="generate_training_dataset-2842"><a href="#generate_training_dataset-2842"><span class="linenos">2842</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="generate_training_dataset-2843"><a href="#generate_training_dataset-2843"><span class="linenos">2843</span></a>
</span><span id="generate_training_dataset-2844"><a href="#generate_training_dataset-2844"><span class="linenos">2844</span></a>    <span class="c1"># Metadata-based selection logic</span>
</span><span id="generate_training_dataset-2845"><a href="#generate_training_dataset-2845"><span class="linenos">2845</span></a>    <span class="k">def</span> <span class="nf">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="generate_training_dataset-2846"><a href="#generate_training_dataset-2846"><span class="linenos">2846</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_training_dataset-2847"><a href="#generate_training_dataset-2847"><span class="linenos">2847</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2848"><a href="#generate_training_dataset-2848"><span class="linenos">2848</span></a>                
</span><span id="generate_training_dataset-2849"><a href="#generate_training_dataset-2849"><span class="linenos">2849</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
</span><span id="generate_training_dataset-2850"><a href="#generate_training_dataset-2850"><span class="linenos">2850</span></a>                                 <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_training_dataset-2851"><a href="#generate_training_dataset-2851"><span class="linenos">2851</span></a>                                 <span class="n">cell_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="generate_training_dataset-2852"><a href="#generate_training_dataset-2852"><span class="linenos">2852</span></a>                                 <span class="n">pathogens</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_name&#39;</span><span class="p">],</span>
</span><span id="generate_training_dataset-2853"><a href="#generate_training_dataset-2853"><span class="linenos">2853</span></a>                                 <span class="n">pathogen_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_value&#39;</span><span class="p">],</span>
</span><span id="generate_training_dataset-2854"><a href="#generate_training_dataset-2854"><span class="linenos">2854</span></a>                                 <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_name&#39;</span><span class="p">],</span>
</span><span id="generate_training_dataset-2855"><a href="#generate_training_dataset-2855"><span class="linenos">2855</span></a>                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_value&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2856"><a href="#generate_training_dataset-2856"><span class="linenos">2856</span></a>        
</span><span id="generate_training_dataset-2857"><a href="#generate_training_dataset-2857"><span class="linenos">2857</span></a>        <span class="c1">#if settings[&#39;metadata_type_by&#39;] == &#39;condition&#39;:</span>
</span><span id="generate_training_dataset-2858"><a href="#generate_training_dataset-2858"><span class="linenos">2858</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2859"><a href="#generate_training_dataset-2859"><span class="linenos">2859</span></a>            
</span><span id="generate_training_dataset-2860"><a href="#generate_training_dataset-2860"><span class="linenos">2860</span></a>        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="generate_training_dataset-2861"><a href="#generate_training_dataset-2861"><span class="linenos">2861</span></a>
</span><span id="generate_training_dataset-2862"><a href="#generate_training_dataset-2862"><span class="linenos">2862</span></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2863"><a href="#generate_training_dataset-2863"><span class="linenos">2863</span></a>        
</span><span id="generate_training_dataset-2864"><a href="#generate_training_dataset-2864"><span class="linenos">2864</span></a>        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]:</span>
</span><span id="generate_training_dataset-2865"><a href="#generate_training_dataset-2865"><span class="linenos">2865</span></a>            <span class="n">class_temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
</span><span id="generate_training_dataset-2866"><a href="#generate_training_dataset-2866"><span class="linenos">2866</span></a>            <span class="c1">#class_temp_df = df[df[&#39;condition&#39;].isin(class_)]</span>
</span><span id="generate_training_dataset-2867"><a href="#generate_training_dataset-2867"><span class="linenos">2867</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_temp_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> images for class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2868"><a href="#generate_training_dataset-2868"><span class="linenos">2868</span></a>            <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">class_temp_df</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="generate_training_dataset-2869"><a href="#generate_training_dataset-2869"><span class="linenos">2869</span></a>
</span><span id="generate_training_dataset-2870"><a href="#generate_training_dataset-2870"><span class="linenos">2870</span></a>            <span class="c1"># Ensure to sample `size` number of images (smallest class size)</span>
</span><span id="generate_training_dataset-2871"><a href="#generate_training_dataset-2871"><span class="linenos">2871</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
</span><span id="generate_training_dataset-2872"><a href="#generate_training_dataset-2872"><span class="linenos">2872</span></a>                <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span id="generate_training_dataset-2873"><a href="#generate_training_dataset-2873"><span class="linenos">2873</span></a>
</span><span id="generate_training_dataset-2874"><a href="#generate_training_dataset-2874"><span class="linenos">2874</span></a>            <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
</span><span id="generate_training_dataset-2875"><a href="#generate_training_dataset-2875"><span class="linenos">2875</span></a>
</span><span id="generate_training_dataset-2876"><a href="#generate_training_dataset-2876"><span class="linenos">2876</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="generate_training_dataset-2877"><a href="#generate_training_dataset-2877"><span class="linenos">2877</span></a>
</span><span id="generate_training_dataset-2878"><a href="#generate_training_dataset-2878"><span class="linenos">2878</span></a>    <span class="c1"># Annotation-based selection logic</span>
</span><span id="generate_training_dataset-2879"><a href="#generate_training_dataset-2879"><span class="linenos">2879</span></a>    <span class="k">def</span> <span class="nf">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="generate_training_dataset-2880"><a href="#generate_training_dataset-2880"><span class="linenos">2880</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2881"><a href="#generate_training_dataset-2881"><span class="linenos">2881</span></a>
</span><span id="generate_training_dataset-2882"><a href="#generate_training_dataset-2882"><span class="linenos">2882</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="generate_training_dataset-2883"><a href="#generate_training_dataset-2883"><span class="linenos">2883</span></a>    
</span><span id="generate_training_dataset-2884"><a href="#generate_training_dataset-2884"><span class="linenos">2884</span></a>    <span class="c1"># Metadata-Annotation-based selection logic</span>
</span><span id="generate_training_dataset-2885"><a href="#generate_training_dataset-2885"><span class="linenos">2885</span></a>    <span class="k">def</span> <span class="nf">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="generate_training_dataset-2886"><a href="#generate_training_dataset-2886"><span class="linenos">2886</span></a>        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">],</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_type_by&#39;</span><span class="p">],</span> <span class="n">class_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2887"><a href="#generate_training_dataset-2887"><span class="linenos">2887</span></a>
</span><span id="generate_training_dataset-2888"><a href="#generate_training_dataset-2888"><span class="linenos">2888</span></a>        <span class="k">return</span> <span class="n">class_paths_ls</span>
</span><span id="generate_training_dataset-2889"><a href="#generate_training_dataset-2889"><span class="linenos">2889</span></a>    
</span><span id="generate_training_dataset-2890"><a href="#generate_training_dataset-2890"><span class="linenos">2890</span></a>    <span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">_read_and_merge_data</span><span class="p">,</span> <span class="n">_read_db</span>
</span><span id="generate_training_dataset-2891"><a href="#generate_training_dataset-2891"><span class="linenos">2891</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_paths_from_db</span><span class="p">,</span> <span class="n">annotate_conditions</span><span class="p">,</span> <span class="n">save_settings</span>
</span><span id="generate_training_dataset-2892"><a href="#generate_training_dataset-2892"><span class="linenos">2892</span></a>    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_training_dataset_defaults</span>
</span><span id="generate_training_dataset-2893"><a href="#generate_training_dataset-2893"><span class="linenos">2893</span></a>    
</span><span id="generate_training_dataset-2894"><a href="#generate_training_dataset-2894"><span class="linenos">2894</span></a>    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_training_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="generate_training_dataset-2895"><a href="#generate_training_dataset-2895"><span class="linenos">2895</span></a>
</span><span id="generate_training_dataset-2896"><a href="#generate_training_dataset-2896"><span class="linenos">2896</span></a>    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
</span><span id="generate_training_dataset-2897"><a href="#generate_training_dataset-2897"><span class="linenos">2897</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="generate_training_dataset-2898"><a href="#generate_training_dataset-2898"><span class="linenos">2898</span></a>        
</span><span id="generate_training_dataset-2899"><a href="#generate_training_dataset-2899"><span class="linenos">2899</span></a>    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
</span><span id="generate_training_dataset-2900"><a href="#generate_training_dataset-2900"><span class="linenos">2900</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="generate_training_dataset-2901"><a href="#generate_training_dataset-2901"><span class="linenos">2901</span></a>       
</span><span id="generate_training_dataset-2902"><a href="#generate_training_dataset-2902"><span class="linenos">2902</span></a>    <span class="c1"># Set default settings and save</span>
</span><span id="generate_training_dataset-2903"><a href="#generate_training_dataset-2903"><span class="linenos">2903</span></a>    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;cv_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_training_dataset-2904"><a href="#generate_training_dataset-2904"><span class="linenos">2904</span></a>
</span><span id="generate_training_dataset-2905"><a href="#generate_training_dataset-2905"><span class="linenos">2905</span></a>    <span class="n">class_path_list</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="generate_training_dataset-2906"><a href="#generate_training_dataset-2906"><span class="linenos">2906</span></a>
</span><span id="generate_training_dataset-2907"><a href="#generate_training_dataset-2907"><span class="linenos">2907</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="generate_training_dataset-2908"><a href="#generate_training_dataset-2908"><span class="linenos">2908</span></a>        <span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
</span><span id="generate_training_dataset-2909"><a href="#generate_training_dataset-2909"><span class="linenos">2909</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
</span><span id="generate_training_dataset-2910"><a href="#generate_training_dataset-2910"><span class="linenos">2910</span></a>
</span><span id="generate_training_dataset-2911"><a href="#generate_training_dataset-2911"><span class="linenos">2911</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
</span><span id="generate_training_dataset-2912"><a href="#generate_training_dataset-2912"><span class="linenos">2912</span></a>        <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2913"><a href="#generate_training_dataset-2913"><span class="linenos">2913</span></a>        
</span><span id="generate_training_dataset-2914"><a href="#generate_training_dataset-2914"><span class="linenos">2914</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="generate_training_dataset-2915"><a href="#generate_training_dataset-2915"><span class="linenos">2915</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training_all&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2916"><a href="#generate_training_dataset-2916"><span class="linenos">2916</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="generate_training_dataset-2917"><a href="#generate_training_dataset-2917"><span class="linenos">2917</span></a>            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2918"><a href="#generate_training_dataset-2918"><span class="linenos">2918</span></a>
</span><span id="generate_training_dataset-2919"><a href="#generate_training_dataset-2919"><span class="linenos">2919</span></a>        <span class="c1"># Create a new directory for training data if necessary</span>
</span><span id="generate_training_dataset-2920"><a href="#generate_training_dataset-2920"><span class="linenos">2920</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
</span><span id="generate_training_dataset-2921"><a href="#generate_training_dataset-2921"><span class="linenos">2921</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
</span><span id="generate_training_dataset-2922"><a href="#generate_training_dataset-2922"><span class="linenos">2922</span></a>                <span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
</span><span id="generate_training_dataset-2923"><a href="#generate_training_dataset-2923"><span class="linenos">2923</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
</span><span id="generate_training_dataset-2924"><a href="#generate_training_dataset-2924"><span class="linenos">2924</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new directory for training: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2925"><a href="#generate_training_dataset-2925"><span class="linenos">2925</span></a>                    <span class="k">break</span>
</span><span id="generate_training_dataset-2926"><a href="#generate_training_dataset-2926"><span class="linenos">2926</span></a>
</span><span id="generate_training_dataset-2927"><a href="#generate_training_dataset-2927"><span class="linenos">2927</span></a>        <span class="c1"># Select dataset based on dataset mode</span>
</span><span id="generate_training_dataset-2928"><a href="#generate_training_dataset-2928"><span class="linenos">2928</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
</span><span id="generate_training_dataset-2929"><a href="#generate_training_dataset-2929"><span class="linenos">2929</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="generate_training_dataset-2930"><a href="#generate_training_dataset-2930"><span class="linenos">2930</span></a>
</span><span id="generate_training_dataset-2931"><a href="#generate_training_dataset-2931"><span class="linenos">2931</span></a>        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
</span><span id="generate_training_dataset-2932"><a href="#generate_training_dataset-2932"><span class="linenos">2932</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="generate_training_dataset-2933"><a href="#generate_training_dataset-2933"><span class="linenos">2933</span></a>
</span><span id="generate_training_dataset-2934"><a href="#generate_training_dataset-2934"><span class="linenos">2934</span></a>        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;measurement&#39;</span><span class="p">:</span>
</span><span id="generate_training_dataset-2935"><a href="#generate_training_dataset-2935"><span class="linenos">2935</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2936"><a href="#generate_training_dataset-2936"><span class="linenos">2936</span></a>            
</span><span id="generate_training_dataset-2937"><a href="#generate_training_dataset-2937"><span class="linenos">2937</span></a>        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata_annotation&#39;</span><span class="p">:</span>
</span><span id="generate_training_dataset-2938"><a href="#generate_training_dataset-2938"><span class="linenos">2938</span></a>            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="generate_training_dataset-2939"><a href="#generate_training_dataset-2939"><span class="linenos">2939</span></a>            
</span><span id="generate_training_dataset-2940"><a href="#generate_training_dataset-2940"><span class="linenos">2940</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="generate_training_dataset-2941"><a href="#generate_training_dataset-2941"><span class="linenos">2941</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dataset mode: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2942"><a href="#generate_training_dataset-2942"><span class="linenos">2942</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid options are: &#39;annotation&#39;, &#39;metadata&#39;, &#39;measurement&#39;, &#39;metadata_annotation&#39;&quot;</span><span class="p">)</span>
</span><span id="generate_training_dataset-2943"><a href="#generate_training_dataset-2943"><span class="linenos">2943</span></a>            <span class="k">return</span>
</span><span id="generate_training_dataset-2944"><a href="#generate_training_dataset-2944"><span class="linenos">2944</span></a>        
</span><span id="generate_training_dataset-2945"><a href="#generate_training_dataset-2945"><span class="linenos">2945</span></a>        <span class="k">if</span> <span class="n">class_path_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="generate_training_dataset-2946"><a href="#generate_training_dataset-2946"><span class="linenos">2946</span></a>            <span class="n">class_path_list</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">))]</span>
</span><span id="generate_training_dataset-2947"><a href="#generate_training_dataset-2947"><span class="linenos">2947</span></a>
</span><span id="generate_training_dataset-2948"><a href="#generate_training_dataset-2948"><span class="linenos">2948</span></a>        <span class="c1"># Extend each list in class_path_list with the corresponding list from class_paths_ls</span>
</span><span id="generate_training_dataset-2949"><a href="#generate_training_dataset-2949"><span class="linenos">2949</span></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">)):</span>
</span><span id="generate_training_dataset-2950"><a href="#generate_training_dataset-2950"><span class="linenos">2950</span></a>            <span class="n">class_path_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span><span id="generate_training_dataset-2951"><a href="#generate_training_dataset-2951"><span class="linenos">2951</span></a>
</span><span id="generate_training_dataset-2952"><a href="#generate_training_dataset-2952"><span class="linenos">2952</span></a>    <span class="c1"># Generate and return training and testing directories</span>
</span><span id="generate_training_dataset-2953"><a href="#generate_training_dataset-2953"><span class="linenos">2953</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class_path_list&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">class_path_list</span><span class="p">))</span>
</span><span id="generate_training_dataset-2954"><a href="#generate_training_dataset-2954"><span class="linenos">2954</span></a>    <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="o">=</span><span class="n">class_path_list</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">],</span> <span class="n">test_split</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;test_split&#39;</span><span class="p">])</span>
</span><span id="generate_training_dataset-2955"><a href="#generate_training_dataset-2955"><span class="linenos">2955</span></a>
</span><span id="generate_training_dataset-2956"><a href="#generate_training_dataset-2956"><span class="linenos">2956</span></a>    <span class="k">return</span> <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span>
</span></pre></div>


    

                </section>
                <section id="training_dataset_from_annotation">
                            <input id="training_dataset_from_annotation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">training_dataset_from_annotation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">db_path</span>, </span><span class="param"><span class="n">dst</span>, </span><span class="param"><span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span>, </span><span class="param"><span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="training_dataset_from_annotation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#training_dataset_from_annotation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="training_dataset_from_annotation-2958"><a href="#training_dataset_from_annotation-2958"><span class="linenos">2958</span></a><span class="k">def</span> <span class="nf">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
</span><span id="training_dataset_from_annotation-2959"><a href="#training_dataset_from_annotation-2959"><span class="linenos">2959</span></a>    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="training_dataset_from_annotation-2960"><a href="#training_dataset_from_annotation-2960"><span class="linenos">2960</span></a>
</span><span id="training_dataset_from_annotation-2961"><a href="#training_dataset_from_annotation-2961"><span class="linenos">2961</span></a>    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
</span><span id="training_dataset_from_annotation-2962"><a href="#training_dataset_from_annotation-2962"><span class="linenos">2962</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2963"><a href="#training_dataset_from_annotation-2963"><span class="linenos">2963</span></a>    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation-2964"><a href="#training_dataset_from_annotation-2964"><span class="linenos">2964</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="training_dataset_from_annotation-2965"><a href="#training_dataset_from_annotation-2965"><span class="linenos">2965</span></a>        <span class="c1"># Retrieve all paths and annotations from the database</span>
</span><span id="training_dataset_from_annotation-2966"><a href="#training_dataset_from_annotation-2966"><span class="linenos">2966</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> FROM png_list&quot;</span>
</span><span id="training_dataset_from_annotation-2967"><a href="#training_dataset_from_annotation-2967"><span class="linenos">2967</span></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2968"><a href="#training_dataset_from_annotation-2968"><span class="linenos">2968</span></a>        
</span><span id="training_dataset_from_annotation-2969"><a href="#training_dataset_from_annotation-2969"><span class="linenos">2969</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation-2970"><a href="#training_dataset_from_annotation-2970"><span class="linenos">2970</span></a>            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2971"><a href="#training_dataset_from_annotation-2971"><span class="linenos">2971</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation-2972"><a href="#training_dataset_from_annotation-2972"><span class="linenos">2972</span></a>                <span class="k">break</span>
</span><span id="training_dataset_from_annotation-2973"><a href="#training_dataset_from_annotation-2973"><span class="linenos">2973</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation-2974"><a href="#training_dataset_from_annotation-2974"><span class="linenos">2974</span></a>                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2975"><a href="#training_dataset_from_annotation-2975"><span class="linenos">2975</span></a>
</span><span id="training_dataset_from_annotation-2976"><a href="#training_dataset_from_annotation-2976"><span class="linenos">2976</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation-2977"><a href="#training_dataset_from_annotation-2977"><span class="linenos">2977</span></a>    
</span><span id="training_dataset_from_annotation-2978"><a href="#training_dataset_from_annotation-2978"><span class="linenos">2978</span></a>    <span class="c1"># Filter paths based on annotated_classes</span>
</span><span id="training_dataset_from_annotation-2979"><a href="#training_dataset_from_annotation-2979"><span class="linenos">2979</span></a>    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="training_dataset_from_annotation-2980"><a href="#training_dataset_from_annotation-2980"><span class="linenos">2980</span></a>    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation-2981"><a href="#training_dataset_from_annotation-2981"><span class="linenos">2981</span></a>        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation-2982"><a href="#training_dataset_from_annotation-2982"><span class="linenos">2982</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2983"><a href="#training_dataset_from_annotation-2983"><span class="linenos">2983</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2984"><a href="#training_dataset_from_annotation-2984"><span class="linenos">2984</span></a>        
</span><span id="training_dataset_from_annotation-2985"><a href="#training_dataset_from_annotation-2985"><span class="linenos">2985</span></a>    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
</span><span id="training_dataset_from_annotation-2986"><a href="#training_dataset_from_annotation-2986"><span class="linenos">2986</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation-2987"><a href="#training_dataset_from_annotation-2987"><span class="linenos">2987</span></a>        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation-2988"><a href="#training_dataset_from_annotation-2988"><span class="linenos">2988</span></a>        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="training_dataset_from_annotation-2989"><a href="#training_dataset_from_annotation-2989"><span class="linenos">2989</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2990"><a href="#training_dataset_from_annotation-2990"><span class="linenos">2990</span></a>        
</span><span id="training_dataset_from_annotation-2991"><a href="#training_dataset_from_annotation-2991"><span class="linenos">2991</span></a>        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
</span><span id="training_dataset_from_annotation-2992"><a href="#training_dataset_from_annotation-2992"><span class="linenos">2992</span></a>        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation-2993"><a href="#training_dataset_from_annotation-2993"><span class="linenos">2993</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation-2994"><a href="#training_dataset_from_annotation-2994"><span class="linenos">2994</span></a>        
</span><span id="training_dataset_from_annotation-2995"><a href="#training_dataset_from_annotation-2995"><span class="linenos">2995</span></a>        <span class="c1"># Sample the same number of images for both classes</span>
</span><span id="training_dataset_from_annotation-2996"><a href="#training_dataset_from_annotation-2996"><span class="linenos">2996</span></a>        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation-2997"><a href="#training_dataset_from_annotation-2997"><span class="linenos">2997</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-2998"><a href="#training_dataset_from_annotation-2998"><span class="linenos">2998</span></a>
</span><span id="training_dataset_from_annotation-2999"><a href="#training_dataset_from_annotation-2999"><span class="linenos">2999</span></a>        <span class="c1"># Resample target class to match the smaller size</span>
</span><span id="training_dataset_from_annotation-3000"><a href="#training_dataset_from_annotation-3000"><span class="linenos">3000</span></a>        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-3001"><a href="#training_dataset_from_annotation-3001"><span class="linenos">3001</span></a>        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-3002"><a href="#training_dataset_from_annotation-3002"><span class="linenos">3002</span></a>        
</span><span id="training_dataset_from_annotation-3003"><a href="#training_dataset_from_annotation-3003"><span class="linenos">3003</span></a>        <span class="c1"># Update class paths</span>
</span><span id="training_dataset_from_annotation-3004"><a href="#training_dataset_from_annotation-3004"><span class="linenos">3004</span></a>        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
</span><span id="training_dataset_from_annotation-3005"><a href="#training_dataset_from_annotation-3005"><span class="linenos">3005</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-3006"><a href="#training_dataset_from_annotation-3006"><span class="linenos">3006</span></a>
</span><span id="training_dataset_from_annotation-3007"><a href="#training_dataset_from_annotation-3007"><span class="linenos">3007</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-3008"><a href="#training_dataset_from_annotation-3008"><span class="linenos">3008</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
</span><span id="training_dataset_from_annotation-3009"><a href="#training_dataset_from_annotation-3009"><span class="linenos">3009</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation-3010"><a href="#training_dataset_from_annotation-3010"><span class="linenos">3010</span></a>        
</span><span id="training_dataset_from_annotation-3011"><a href="#training_dataset_from_annotation-3011"><span class="linenos">3011</span></a>    <span class="k">return</span> <span class="n">class_paths</span>
</span></pre></div>


    

                </section>
                <section id="training_dataset_from_annotation_metadata">
                            <input id="training_dataset_from_annotation_metadata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">training_dataset_from_annotation_metadata</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">db_path</span>,</span><span class="param">	<span class="n">dst</span>,</span><span class="param">	<span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span>,</span><span class="param">	<span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>,</span><span class="param">	<span class="n">metadata_type_by</span><span class="o">=</span><span class="s1">&#39;columnID&#39;</span>,</span><span class="param">	<span class="n">class_metadata</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="training_dataset_from_annotation_metadata-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#training_dataset_from_annotation_metadata"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="training_dataset_from_annotation_metadata-3013"><a href="#training_dataset_from_annotation_metadata-3013"><span class="linenos">3013</span></a><span class="k">def</span> <span class="nf">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="s1">&#39;columnID&#39;</span><span class="p">,</span> <span class="n">class_metadata</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;c2&#39;</span><span class="p">]):</span>
</span><span id="training_dataset_from_annotation_metadata-3014"><a href="#training_dataset_from_annotation_metadata-3014"><span class="linenos">3014</span></a>    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="training_dataset_from_annotation_metadata-3015"><a href="#training_dataset_from_annotation_metadata-3015"><span class="linenos">3015</span></a>
</span><span id="training_dataset_from_annotation_metadata-3016"><a href="#training_dataset_from_annotation_metadata-3016"><span class="linenos">3016</span></a>    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
</span><span id="training_dataset_from_annotation_metadata-3017"><a href="#training_dataset_from_annotation_metadata-3017"><span class="linenos">3017</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3018"><a href="#training_dataset_from_annotation_metadata-3018"><span class="linenos">3018</span></a>    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3019"><a href="#training_dataset_from_annotation_metadata-3019"><span class="linenos">3019</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="training_dataset_from_annotation_metadata-3020"><a href="#training_dataset_from_annotation_metadata-3020"><span class="linenos">3020</span></a>        <span class="c1"># Retrieve all paths and annotations from the database</span>
</span><span id="training_dataset_from_annotation_metadata-3021"><a href="#training_dataset_from_annotation_metadata-3021"><span class="linenos">3021</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2">, row_name, column_name FROM png_list&quot;</span>
</span><span id="training_dataset_from_annotation_metadata-3022"><a href="#training_dataset_from_annotation_metadata-3022"><span class="linenos">3022</span></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3023"><a href="#training_dataset_from_annotation_metadata-3023"><span class="linenos">3023</span></a>        
</span><span id="training_dataset_from_annotation_metadata-3024"><a href="#training_dataset_from_annotation_metadata-3024"><span class="linenos">3024</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3025"><a href="#training_dataset_from_annotation_metadata-3025"><span class="linenos">3025</span></a>            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3026"><a href="#training_dataset_from_annotation_metadata-3026"><span class="linenos">3026</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3027"><a href="#training_dataset_from_annotation_metadata-3027"><span class="linenos">3027</span></a>                <span class="k">break</span>
</span><span id="training_dataset_from_annotation_metadata-3028"><a href="#training_dataset_from_annotation_metadata-3028"><span class="linenos">3028</span></a>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3029"><a href="#training_dataset_from_annotation_metadata-3029"><span class="linenos">3029</span></a>                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3030"><a href="#training_dataset_from_annotation_metadata-3030"><span class="linenos">3030</span></a>
</span><span id="training_dataset_from_annotation_metadata-3031"><a href="#training_dataset_from_annotation_metadata-3031"><span class="linenos">3031</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation_metadata-3032"><a href="#training_dataset_from_annotation_metadata-3032"><span class="linenos">3032</span></a>    
</span><span id="training_dataset_from_annotation_metadata-3033"><a href="#training_dataset_from_annotation_metadata-3033"><span class="linenos">3033</span></a>    <span class="c1"># Filter all_paths by metadata_type_by and class_metadata</span>
</span><span id="training_dataset_from_annotation_metadata-3034"><a href="#training_dataset_from_annotation_metadata-3034"><span class="linenos">3034</span></a>    <span class="n">filtered_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="training_dataset_from_annotation_metadata-3035"><a href="#training_dataset_from_annotation_metadata-3035"><span class="linenos">3035</span></a>    <span class="n">metadata_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rowID&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;columnID&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_type_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3036"><a href="#training_dataset_from_annotation_metadata-3036"><span class="linenos">3036</span></a>    <span class="k">if</span> <span class="n">metadata_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3037"><a href="#training_dataset_from_annotation_metadata-3037"><span class="linenos">3037</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid metadata_type_by value: </span><span class="si">{</span><span class="n">metadata_type_by</span><span class="si">}</span><span class="s2">. Must be &#39;rowID&#39; or &#39;columnID&#39;. </span><span class="si">{</span><span class="n">class_metadata</span><span class="si">}</span><span class="s2"> must be a list formatted as [&#39;c1&#39;, &#39;c2&#39;] or [&#39;r1&#39;, &#39;r2&#39;]&quot;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3038"><a href="#training_dataset_from_annotation_metadata-3038"><span class="linenos">3038</span></a>
</span><span id="training_dataset_from_annotation_metadata-3039"><a href="#training_dataset_from_annotation_metadata-3039"><span class="linenos">3039</span></a>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_paths</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3040"><a href="#training_dataset_from_annotation_metadata-3040"><span class="linenos">3040</span></a>        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">metadata_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">class_metadata</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3041"><a href="#training_dataset_from_annotation_metadata-3041"><span class="linenos">3041</span></a>            <span class="n">filtered_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3042"><a href="#training_dataset_from_annotation_metadata-3042"><span class="linenos">3042</span></a>
</span><span id="training_dataset_from_annotation_metadata-3043"><a href="#training_dataset_from_annotation_metadata-3043"><span class="linenos">3043</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total filtered paths:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation_metadata-3044"><a href="#training_dataset_from_annotation_metadata-3044"><span class="linenos">3044</span></a>    <span class="c1">#all_paths = filtered_paths</span>
</span><span id="training_dataset_from_annotation_metadata-3045"><a href="#training_dataset_from_annotation_metadata-3045"><span class="linenos">3045</span></a>    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_paths</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation_metadata-3046"><a href="#training_dataset_from_annotation_metadata-3046"><span class="linenos">3046</span></a>    
</span><span id="training_dataset_from_annotation_metadata-3047"><a href="#training_dataset_from_annotation_metadata-3047"><span class="linenos">3047</span></a>    <span class="c1"># Filter paths based on annotated_classes</span>
</span><span id="training_dataset_from_annotation_metadata-3048"><a href="#training_dataset_from_annotation_metadata-3048"><span class="linenos">3048</span></a>    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="training_dataset_from_annotation_metadata-3049"><a href="#training_dataset_from_annotation_metadata-3049"><span class="linenos">3049</span></a>    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3050"><a href="#training_dataset_from_annotation_metadata-3050"><span class="linenos">3050</span></a>        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation_metadata-3051"><a href="#training_dataset_from_annotation_metadata-3051"><span class="linenos">3051</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3052"><a href="#training_dataset_from_annotation_metadata-3052"><span class="linenos">3052</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3053"><a href="#training_dataset_from_annotation_metadata-3053"><span class="linenos">3053</span></a>        
</span><span id="training_dataset_from_annotation_metadata-3054"><a href="#training_dataset_from_annotation_metadata-3054"><span class="linenos">3054</span></a>    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
</span><span id="training_dataset_from_annotation_metadata-3055"><a href="#training_dataset_from_annotation_metadata-3055"><span class="linenos">3055</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="training_dataset_from_annotation_metadata-3056"><a href="#training_dataset_from_annotation_metadata-3056"><span class="linenos">3056</span></a>        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation_metadata-3057"><a href="#training_dataset_from_annotation_metadata-3057"><span class="linenos">3057</span></a>        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="training_dataset_from_annotation_metadata-3058"><a href="#training_dataset_from_annotation_metadata-3058"><span class="linenos">3058</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3059"><a href="#training_dataset_from_annotation_metadata-3059"><span class="linenos">3059</span></a>        
</span><span id="training_dataset_from_annotation_metadata-3060"><a href="#training_dataset_from_annotation_metadata-3060"><span class="linenos">3060</span></a>        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
</span><span id="training_dataset_from_annotation_metadata-3061"><a href="#training_dataset_from_annotation_metadata-3061"><span class="linenos">3061</span></a>        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
</span><span id="training_dataset_from_annotation_metadata-3062"><a href="#training_dataset_from_annotation_metadata-3062"><span class="linenos">3062</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation_metadata-3063"><a href="#training_dataset_from_annotation_metadata-3063"><span class="linenos">3063</span></a>        
</span><span id="training_dataset_from_annotation_metadata-3064"><a href="#training_dataset_from_annotation_metadata-3064"><span class="linenos">3064</span></a>        <span class="c1"># Sample the same number of images for both classes</span>
</span><span id="training_dataset_from_annotation_metadata-3065"><a href="#training_dataset_from_annotation_metadata-3065"><span class="linenos">3065</span></a>        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
</span><span id="training_dataset_from_annotation_metadata-3066"><a href="#training_dataset_from_annotation_metadata-3066"><span class="linenos">3066</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3067"><a href="#training_dataset_from_annotation_metadata-3067"><span class="linenos">3067</span></a>
</span><span id="training_dataset_from_annotation_metadata-3068"><a href="#training_dataset_from_annotation_metadata-3068"><span class="linenos">3068</span></a>        <span class="c1"># Resample target class to match the smaller size</span>
</span><span id="training_dataset_from_annotation_metadata-3069"><a href="#training_dataset_from_annotation_metadata-3069"><span class="linenos">3069</span></a>        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3070"><a href="#training_dataset_from_annotation_metadata-3070"><span class="linenos">3070</span></a>        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3071"><a href="#training_dataset_from_annotation_metadata-3071"><span class="linenos">3071</span></a>        
</span><span id="training_dataset_from_annotation_metadata-3072"><a href="#training_dataset_from_annotation_metadata-3072"><span class="linenos">3072</span></a>        <span class="c1"># Update class paths</span>
</span><span id="training_dataset_from_annotation_metadata-3073"><a href="#training_dataset_from_annotation_metadata-3073"><span class="linenos">3073</span></a>        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
</span><span id="training_dataset_from_annotation_metadata-3074"><a href="#training_dataset_from_annotation_metadata-3074"><span class="linenos">3074</span></a>        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3075"><a href="#training_dataset_from_annotation_metadata-3075"><span class="linenos">3075</span></a>
</span><span id="training_dataset_from_annotation_metadata-3076"><a href="#training_dataset_from_annotation_metadata-3076"><span class="linenos">3076</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3077"><a href="#training_dataset_from_annotation_metadata-3077"><span class="linenos">3077</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
</span><span id="training_dataset_from_annotation_metadata-3078"><a href="#training_dataset_from_annotation_metadata-3078"><span class="linenos">3078</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
</span><span id="training_dataset_from_annotation_metadata-3079"><a href="#training_dataset_from_annotation_metadata-3079"><span class="linenos">3079</span></a>        
</span><span id="training_dataset_from_annotation_metadata-3080"><a href="#training_dataset_from_annotation_metadata-3080"><span class="linenos">3080</span></a>    <span class="k">return</span> <span class="n">class_paths</span>
</span></pre></div>


    

                </section>
                <section id="generate_dataset_from_lists">
                            <input id="generate_dataset_from_lists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_dataset_from_lists</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dst</span>, </span><span class="param"><span class="n">class_data</span>, </span><span class="param"><span class="n">classes</span>, </span><span class="param"><span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="generate_dataset_from_lists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_dataset_from_lists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_dataset_from_lists-3082"><a href="#generate_dataset_from_lists-3082"><span class="linenos">3082</span></a><span class="k">def</span> <span class="nf">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="generate_dataset_from_lists-3083"><a href="#generate_dataset_from_lists-3083"><span class="linenos">3083</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="generate_dataset_from_lists-3084"><a href="#generate_dataset_from_lists-3084"><span class="linenos">3084</span></a>    <span class="c1"># Make sure that the length of class_data matches the length of classes</span>
</span><span id="generate_dataset_from_lists-3085"><a href="#generate_dataset_from_lists-3085"><span class="linenos">3085</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
</span><span id="generate_dataset_from_lists-3086"><a href="#generate_dataset_from_lists-3086"><span class="linenos">3086</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;class_data and classes must have the same length.&quot;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3087"><a href="#generate_dataset_from_lists-3087"><span class="linenos">3087</span></a>
</span><span id="generate_dataset_from_lists-3088"><a href="#generate_dataset_from_lists-3088"><span class="linenos">3088</span></a>    <span class="n">total_files</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">class_data</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3089"><a href="#generate_dataset_from_lists-3089"><span class="linenos">3089</span></a>    <span class="n">processed_files</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="generate_dataset_from_lists-3090"><a href="#generate_dataset_from_lists-3090"><span class="linenos">3090</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="generate_dataset_from_lists-3091"><a href="#generate_dataset_from_lists-3091"><span class="linenos">3091</span></a>    
</span><span id="generate_dataset_from_lists-3092"><a href="#generate_dataset_from_lists-3092"><span class="linenos">3092</span></a>    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">class_data</span><span class="p">):</span>
</span><span id="generate_dataset_from_lists-3093"><a href="#generate_dataset_from_lists-3093"><span class="linenos">3093</span></a>        <span class="c1"># Create directories</span>
</span><span id="generate_dataset_from_lists-3094"><a href="#generate_dataset_from_lists-3094"><span class="linenos">3094</span></a>        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3095"><a href="#generate_dataset_from_lists-3095"><span class="linenos">3095</span></a>        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3096"><a href="#generate_dataset_from_lists-3096"><span class="linenos">3096</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3097"><a href="#generate_dataset_from_lists-3097"><span class="linenos">3097</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3098"><a href="#generate_dataset_from_lists-3098"><span class="linenos">3098</span></a>                
</span><span id="generate_dataset_from_lists-3099"><a href="#generate_dataset_from_lists-3099"><span class="linenos">3099</span></a>        <span class="c1"># Split the data</span>
</span><span id="generate_dataset_from_lists-3100"><a href="#generate_dataset_from_lists-3100"><span class="linenos">3100</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">test_split</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3101"><a href="#generate_dataset_from_lists-3101"><span class="linenos">3101</span></a>        <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_split</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3102"><a href="#generate_dataset_from_lists-3102"><span class="linenos">3102</span></a>        
</span><span id="generate_dataset_from_lists-3103"><a href="#generate_dataset_from_lists-3103"><span class="linenos">3103</span></a>        <span class="c1"># Copy train files</span>
</span><span id="generate_dataset_from_lists-3104"><a href="#generate_dataset_from_lists-3104"><span class="linenos">3104</span></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
</span><span id="generate_dataset_from_lists-3105"><a href="#generate_dataset_from_lists-3105"><span class="linenos">3105</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="generate_dataset_from_lists-3106"><a href="#generate_dataset_from_lists-3106"><span class="linenos">3106</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
</span><span id="generate_dataset_from_lists-3107"><a href="#generate_dataset_from_lists-3107"><span class="linenos">3107</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="generate_dataset_from_lists-3108"><a href="#generate_dataset_from_lists-3108"><span class="linenos">3108</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3109"><a href="#generate_dataset_from_lists-3109"><span class="linenos">3109</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Train dataset&quot;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3110"><a href="#generate_dataset_from_lists-3110"><span class="linenos">3110</span></a>            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="generate_dataset_from_lists-3111"><a href="#generate_dataset_from_lists-3111"><span class="linenos">3111</span></a>
</span><span id="generate_dataset_from_lists-3112"><a href="#generate_dataset_from_lists-3112"><span class="linenos">3112</span></a>        <span class="c1"># Copy test files</span>
</span><span id="generate_dataset_from_lists-3113"><a href="#generate_dataset_from_lists-3113"><span class="linenos">3113</span></a>        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
</span><span id="generate_dataset_from_lists-3114"><a href="#generate_dataset_from_lists-3114"><span class="linenos">3114</span></a>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="generate_dataset_from_lists-3115"><a href="#generate_dataset_from_lists-3115"><span class="linenos">3115</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
</span><span id="generate_dataset_from_lists-3116"><a href="#generate_dataset_from_lists-3116"><span class="linenos">3116</span></a>            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span><span id="generate_dataset_from_lists-3117"><a href="#generate_dataset_from_lists-3117"><span class="linenos">3117</span></a>            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3118"><a href="#generate_dataset_from_lists-3118"><span class="linenos">3118</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Test dataset&quot;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3119"><a href="#generate_dataset_from_lists-3119"><span class="linenos">3119</span></a>            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="generate_dataset_from_lists-3120"><a href="#generate_dataset_from_lists-3120"><span class="linenos">3120</span></a>
</span><span id="generate_dataset_from_lists-3121"><a href="#generate_dataset_from_lists-3121"><span class="linenos">3121</span></a>    <span class="c1"># Print summary</span>
</span><span id="generate_dataset_from_lists-3122"><a href="#generate_dataset_from_lists-3122"><span class="linenos">3122</span></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="generate_dataset_from_lists-3123"><a href="#generate_dataset_from_lists-3123"><span class="linenos">3123</span></a>        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3124"><a href="#generate_dataset_from_lists-3124"><span class="linenos">3124</span></a>        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3125"><a href="#generate_dataset_from_lists-3125"><span class="linenos">3125</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">, Test class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="generate_dataset_from_lists-3126"><a href="#generate_dataset_from_lists-3126"><span class="linenos">3126</span></a>
</span><span id="generate_dataset_from_lists-3127"><a href="#generate_dataset_from_lists-3127"><span class="linenos">3127</span></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="convert_separate_files_to_yokogawa">
                            <input id="convert_separate_files_to_yokogawa-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_separate_files_to_yokogawa</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">folder</span>, </span><span class="param"><span class="n">regex</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="convert_separate_files_to_yokogawa-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#convert_separate_files_to_yokogawa"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="convert_separate_files_to_yokogawa-3129"><a href="#convert_separate_files_to_yokogawa-3129"><span class="linenos">3129</span></a><span class="k">def</span> <span class="nf">convert_separate_files_to_yokogawa</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">regex</span><span class="p">):</span>
</span><span id="convert_separate_files_to_yokogawa-3130"><a href="#convert_separate_files_to_yokogawa-3130"><span class="linenos">3130</span></a>    
</span><span id="convert_separate_files_to_yokogawa-3131"><a href="#convert_separate_files_to_yokogawa-3131"><span class="linenos">3131</span></a>    <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
</span><span id="convert_separate_files_to_yokogawa-3132"><a href="#convert_separate_files_to_yokogawa-3132"><span class="linenos">3132</span></a>    <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</span><span id="convert_separate_files_to_yokogawa-3133"><a href="#convert_separate_files_to_yokogawa-3133"><span class="linenos">3133</span></a>    <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>
</span><span id="convert_separate_files_to_yokogawa-3134"><a href="#convert_separate_files_to_yokogawa-3134"><span class="linenos">3134</span></a>
</span><span id="convert_separate_files_to_yokogawa-3135"><a href="#convert_separate_files_to_yokogawa-3135"><span class="linenos">3135</span></a>    <span class="k">def</span> <span class="nf">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">):</span>
</span><span id="convert_separate_files_to_yokogawa-3136"><a href="#convert_separate_files_to_yokogawa-3136"><span class="linenos">3136</span></a>        <span class="n">plate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="convert_separate_files_to_yokogawa-3137"><a href="#convert_separate_files_to_yokogawa-3137"><span class="linenos">3137</span></a>        <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">WELLS</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3138"><a href="#convert_separate_files_to_yokogawa-3138"><span class="linenos">3138</span></a>            <span class="n">well_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="convert_separate_files_to_yokogawa-3139"><a href="#convert_separate_files_to_yokogawa-3139"><span class="linenos">3139</span></a>            <span class="k">if</span> <span class="n">well_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_wells</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3140"><a href="#convert_separate_files_to_yokogawa-3140"><span class="linenos">3140</span></a>                <span class="k">return</span> <span class="n">well_name</span>
</span><span id="convert_separate_files_to_yokogawa-3141"><a href="#convert_separate_files_to_yokogawa-3141"><span class="linenos">3141</span></a>            <span class="k">if</span> <span class="n">well</span> <span class="o">==</span> <span class="s2">&quot;P24&quot;</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3142"><a href="#convert_separate_files_to_yokogawa-3142"><span class="linenos">3142</span></a>                <span class="n">plate</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="convert_separate_files_to_yokogawa-3143"><a href="#convert_separate_files_to_yokogawa-3143"><span class="linenos">3143</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_A01&quot;</span>
</span><span id="convert_separate_files_to_yokogawa-3144"><a href="#convert_separate_files_to_yokogawa-3144"><span class="linenos">3144</span></a>
</span><span id="convert_separate_files_to_yokogawa-3145"><a href="#convert_separate_files_to_yokogawa-3145"><span class="linenos">3145</span></a>    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3146"><a href="#convert_separate_files_to_yokogawa-3146"><span class="linenos">3146</span></a>
</span><span id="convert_separate_files_to_yokogawa-3147"><a href="#convert_separate_files_to_yokogawa-3147"><span class="linenos">3147</span></a>    <span class="n">files_by_region</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="convert_separate_files_to_yokogawa-3148"><a href="#convert_separate_files_to_yokogawa-3148"><span class="linenos">3148</span></a>    <span class="n">rename_log</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="convert_separate_files_to_yokogawa-3149"><a href="#convert_separate_files_to_yokogawa-3149"><span class="linenos">3149</span></a>    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;rename_log.csv&quot;</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3150"><a href="#convert_separate_files_to_yokogawa-3150"><span class="linenos">3150</span></a>    <span class="n">used_wells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="convert_separate_files_to_yokogawa-3151"><a href="#convert_separate_files_to_yokogawa-3151"><span class="linenos">3151</span></a>    <span class="n">region_to_well</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="convert_separate_files_to_yokogawa-3152"><a href="#convert_separate_files_to_yokogawa-3152"><span class="linenos">3152</span></a>
</span><span id="convert_separate_files_to_yokogawa-3153"><a href="#convert_separate_files_to_yokogawa-3153"><span class="linenos">3153</span></a>    <span class="c1"># Group files by (plateID, wellID, fieldID, timeID, chanID)</span>
</span><span id="convert_separate_files_to_yokogawa-3154"><a href="#convert_separate_files_to_yokogawa-3154"><span class="linenos">3154</span></a>    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="convert_separate_files_to_yokogawa-3155"><a href="#convert_separate_files_to_yokogawa-3155"><span class="linenos">3155</span></a>        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3156"><a href="#convert_separate_files_to_yokogawa-3156"><span class="linenos">3156</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3157"><a href="#convert_separate_files_to_yokogawa-3157"><span class="linenos">3157</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: does not match regex.&quot;</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3158"><a href="#convert_separate_files_to_yokogawa-3158"><span class="linenos">3158</span></a>            <span class="k">continue</span>
</span><span id="convert_separate_files_to_yokogawa-3159"><a href="#convert_separate_files_to_yokogawa-3159"><span class="linenos">3159</span></a>
</span><span id="convert_separate_files_to_yokogawa-3160"><a href="#convert_separate_files_to_yokogawa-3160"><span class="linenos">3160</span></a>        <span class="n">meta</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
</span><span id="convert_separate_files_to_yokogawa-3161"><a href="#convert_separate_files_to_yokogawa-3161"><span class="linenos">3161</span></a>
</span><span id="convert_separate_files_to_yokogawa-3162"><a href="#convert_separate_files_to_yokogawa-3162"><span class="linenos">3162</span></a>        <span class="c1"># Mandatory metadata</span>
</span><span id="convert_separate_files_to_yokogawa-3163"><a href="#convert_separate_files_to_yokogawa-3163"><span class="linenos">3163</span></a>        <span class="k">if</span> <span class="s1">&#39;wellID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meta</span> <span class="ow">or</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;wellID&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3164"><a href="#convert_separate_files_to_yokogawa-3164"><span class="linenos">3164</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: missing mandatory wellID.&quot;</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3165"><a href="#convert_separate_files_to_yokogawa-3165"><span class="linenos">3165</span></a>            <span class="k">continue</span>
</span><span id="convert_separate_files_to_yokogawa-3166"><a href="#convert_separate_files_to_yokogawa-3166"><span class="linenos">3166</span></a>        <span class="n">wellID</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;wellID&#39;</span><span class="p">]</span>
</span><span id="convert_separate_files_to_yokogawa-3167"><a href="#convert_separate_files_to_yokogawa-3167"><span class="linenos">3167</span></a>
</span><span id="convert_separate_files_to_yokogawa-3168"><a href="#convert_separate_files_to_yokogawa-3168"><span class="linenos">3168</span></a>        <span class="c1"># Optional metadata with defaults</span>
</span><span id="convert_separate_files_to_yokogawa-3169"><a href="#convert_separate_files_to_yokogawa-3169"><span class="linenos">3169</span></a>        <span class="n">plateID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plateID&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span>
</span><span id="convert_separate_files_to_yokogawa-3170"><a href="#convert_separate_files_to_yokogawa-3170"><span class="linenos">3170</span></a>        <span class="n">fieldID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fieldID&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;1&#39;</span>
</span><span id="convert_separate_files_to_yokogawa-3171"><a href="#convert_separate_files_to_yokogawa-3171"><span class="linenos">3171</span></a>        <span class="n">timeID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3172"><a href="#convert_separate_files_to_yokogawa-3172"><span class="linenos">3172</span></a>        <span class="n">chanID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chanID&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3173"><a href="#convert_separate_files_to_yokogawa-3173"><span class="linenos">3173</span></a>        <span class="n">sliceID</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sliceID&#39;</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3174"><a href="#convert_separate_files_to_yokogawa-3174"><span class="linenos">3174</span></a>        <span class="n">sliceID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sliceID</span><span class="p">)</span> <span class="k">if</span> <span class="n">sliceID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="convert_separate_files_to_yokogawa-3175"><a href="#convert_separate_files_to_yokogawa-3175"><span class="linenos">3175</span></a>
</span><span id="convert_separate_files_to_yokogawa-3176"><a href="#convert_separate_files_to_yokogawa-3176"><span class="linenos">3176</span></a>        <span class="n">region_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plateID</span><span class="p">,</span> <span class="n">wellID</span><span class="p">,</span> <span class="n">fieldID</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">chanID</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3177"><a href="#convert_separate_files_to_yokogawa-3177"><span class="linenos">3177</span></a>
</span><span id="convert_separate_files_to_yokogawa-3178"><a href="#convert_separate_files_to_yokogawa-3178"><span class="linenos">3178</span></a>        <span class="n">files_by_region</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">region_key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file</span><span class="p">,</span> <span class="n">sliceID</span><span class="p">))</span>
</span><span id="convert_separate_files_to_yokogawa-3179"><a href="#convert_separate_files_to_yokogawa-3179"><span class="linenos">3179</span></a>
</span><span id="convert_separate_files_to_yokogawa-3180"><a href="#convert_separate_files_to_yokogawa-3180"><span class="linenos">3180</span></a>    <span class="c1"># Assign wells and process files per region</span>
</span><span id="convert_separate_files_to_yokogawa-3181"><a href="#convert_separate_files_to_yokogawa-3181"><span class="linenos">3181</span></a>    <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">files_by_region</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="convert_separate_files_to_yokogawa-3182"><a href="#convert_separate_files_to_yokogawa-3182"><span class="linenos">3182</span></a>        <span class="k">if</span> <span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">region_to_well</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3183"><a href="#convert_separate_files_to_yokogawa-3183"><span class="linenos">3183</span></a>            <span class="n">next_well</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3184"><a href="#convert_separate_files_to_yokogawa-3184"><span class="linenos">3184</span></a>            <span class="n">region_to_well</span><span class="p">[</span><span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">next_well</span>
</span><span id="convert_separate_files_to_yokogawa-3185"><a href="#convert_separate_files_to_yokogawa-3185"><span class="linenos">3185</span></a>            <span class="n">used_wells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_well</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3186"><a href="#convert_separate_files_to_yokogawa-3186"><span class="linenos">3186</span></a>
</span><span id="convert_separate_files_to_yokogawa-3187"><a href="#convert_separate_files_to_yokogawa-3187"><span class="linenos">3187</span></a>        <span class="n">assigned_well</span> <span class="o">=</span> <span class="n">region_to_well</span><span class="p">[</span><span class="n">region</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
</span><span id="convert_separate_files_to_yokogawa-3188"><a href="#convert_separate_files_to_yokogawa-3188"><span class="linenos">3188</span></a>        <span class="n">plateID</span><span class="p">,</span> <span class="n">wellID</span><span class="p">,</span> <span class="n">fieldID</span><span class="p">,</span> <span class="n">timeID</span><span class="p">,</span> <span class="n">chanID</span> <span class="o">=</span> <span class="n">region</span>
</span><span id="convert_separate_files_to_yokogawa-3189"><a href="#convert_separate_files_to_yokogawa-3189"><span class="linenos">3189</span></a>
</span><span id="convert_separate_files_to_yokogawa-3190"><a href="#convert_separate_files_to_yokogawa-3190"><span class="linenos">3190</span></a>        <span class="c1"># Check if multiple slices exist and are meaningful</span>
</span><span id="convert_separate_files_to_yokogawa-3191"><a href="#convert_separate_files_to_yokogawa-3191"><span class="linenos">3191</span></a>        <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sid</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="convert_separate_files_to_yokogawa-3192"><a href="#convert_separate_files_to_yokogawa-3192"><span class="linenos">3192</span></a>        <span class="n">unique_slices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3193"><a href="#convert_separate_files_to_yokogawa-3193"><span class="linenos">3193</span></a>
</span><span id="convert_separate_files_to_yokogawa-3194"><a href="#convert_separate_files_to_yokogawa-3194"><span class="linenos">3194</span></a>        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="convert_separate_files_to_yokogawa-3195"><a href="#convert_separate_files_to_yokogawa-3195"><span class="linenos">3195</span></a>        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="convert_separate_files_to_yokogawa-3196"><a href="#convert_separate_files_to_yokogawa-3196"><span class="linenos">3196</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</span><span id="convert_separate_files_to_yokogawa-3197"><a href="#convert_separate_files_to_yokogawa-3197"><span class="linenos">3197</span></a>            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3198"><a href="#convert_separate_files_to_yokogawa-3198"><span class="linenos">3198</span></a>
</span><span id="convert_separate_files_to_yokogawa-3199"><a href="#convert_separate_files_to_yokogawa-3199"><span class="linenos">3199</span></a>        <span class="c1"># Perform MIP only if multiple unique slices are present</span>
</span><span id="convert_separate_files_to_yokogawa-3200"><a href="#convert_separate_files_to_yokogawa-3200"><span class="linenos">3200</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_slices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3201"><a href="#convert_separate_files_to_yokogawa-3201"><span class="linenos">3201</span></a>            <span class="n">img_to_save</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3202"><a href="#convert_separate_files_to_yokogawa-3202"><span class="linenos">3202</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="convert_separate_files_to_yokogawa-3203"><a href="#convert_separate_files_to_yokogawa-3203"><span class="linenos">3203</span></a>            <span class="n">img_to_save</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="convert_separate_files_to_yokogawa-3204"><a href="#convert_separate_files_to_yokogawa-3204"><span class="linenos">3204</span></a>
</span><span id="convert_separate_files_to_yokogawa-3205"><a href="#convert_separate_files_to_yokogawa-3205"><span class="linenos">3205</span></a>        <span class="n">dtype</span> <span class="o">=</span> <span class="n">img_to_save</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="convert_separate_files_to_yokogawa-3206"><a href="#convert_separate_files_to_yokogawa-3206"><span class="linenos">3206</span></a>
</span><span id="convert_separate_files_to_yokogawa-3207"><a href="#convert_separate_files_to_yokogawa-3207"><span class="linenos">3207</span></a>        <span class="n">new_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">assigned_well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">timeID</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fieldID</span><span class="p">)</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">chanID</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="convert_separate_files_to_yokogawa-3208"><a href="#convert_separate_files_to_yokogawa-3208"><span class="linenos">3208</span></a>        <span class="n">new_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3209"><a href="#convert_separate_files_to_yokogawa-3209"><span class="linenos">3209</span></a>        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">new_filepath</span><span class="p">,</span> <span class="n">img_to_save</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="convert_separate_files_to_yokogawa-3210"><a href="#convert_separate_files_to_yokogawa-3210"><span class="linenos">3210</span></a>
</span><span id="convert_separate_files_to_yokogawa-3211"><a href="#convert_separate_files_to_yokogawa-3211"><span class="linenos">3211</span></a>        <span class="c1"># Log original filenames involved in MIP or single file rename</span>
</span><span id="convert_separate_files_to_yokogawa-3212"><a href="#convert_separate_files_to_yokogawa-3212"><span class="linenos">3212</span></a>        <span class="n">original_files</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3213"><a href="#convert_separate_files_to_yokogawa-3213"><span class="linenos">3213</span></a>        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File(s)&quot;</span><span class="p">:</span> <span class="n">original_files</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">new_filename</span><span class="p">})</span>
</span><span id="convert_separate_files_to_yokogawa-3214"><a href="#convert_separate_files_to_yokogawa-3214"><span class="linenos">3214</span></a>
</span><span id="convert_separate_files_to_yokogawa-3215"><a href="#convert_separate_files_to_yokogawa-3215"><span class="linenos">3215</span></a>    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rename_log</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="convert_separate_files_to_yokogawa-3216"><a href="#convert_separate_files_to_yokogawa-3216"><span class="linenos">3216</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete. Files saved in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> and rename log saved as </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="convert_to_yokogawa">
                            <input id="convert_to_yokogawa-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_to_yokogawa</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">folder</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="convert_to_yokogawa-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#convert_to_yokogawa"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="convert_to_yokogawa-3218"><a href="#convert_to_yokogawa-3218"><span class="linenos">3218</span></a><span class="k">def</span> <span class="nf">convert_to_yokogawa</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3219"><a href="#convert_to_yokogawa-3219"><span class="linenos">3219</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="convert_to_yokogawa-3220"><a href="#convert_to_yokogawa-3220"><span class="linenos">3220</span></a><span class="sd">    Detects file type in the folder and converts them</span>
</span><span id="convert_to_yokogawa-3221"><a href="#convert_to_yokogawa-3221"><span class="linenos">3221</span></a><span class="sd">    to Yokogawa-style naming with Maximum Intensity Projection (MIP).</span>
</span><span id="convert_to_yokogawa-3222"><a href="#convert_to_yokogawa-3222"><span class="linenos">3222</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="convert_to_yokogawa-3223"><a href="#convert_to_yokogawa-3223"><span class="linenos">3223</span></a>    
</span><span id="convert_to_yokogawa-3224"><a href="#convert_to_yokogawa-3224"><span class="linenos">3224</span></a>    <span class="c1">#def _get_next_well(used_wells):</span>
</span><span id="convert_to_yokogawa-3225"><a href="#convert_to_yokogawa-3225"><span class="linenos">3225</span></a>    <span class="c1">#    &quot;&quot;&quot;</span>
</span><span id="convert_to_yokogawa-3226"><a href="#convert_to_yokogawa-3226"><span class="linenos">3226</span></a>    <span class="c1">#    Determines the next available well position in a 384-well format.</span>
</span><span id="convert_to_yokogawa-3227"><a href="#convert_to_yokogawa-3227"><span class="linenos">3227</span></a>    <span class="c1">#    Iterates wells, and after P24, switches to plate2.</span>
</span><span id="convert_to_yokogawa-3228"><a href="#convert_to_yokogawa-3228"><span class="linenos">3228</span></a>    <span class="c1">#    &quot;&quot;&quot;</span>
</span><span id="convert_to_yokogawa-3229"><a href="#convert_to_yokogawa-3229"><span class="linenos">3229</span></a>    <span class="c1">#    plate = 1</span>
</span><span id="convert_to_yokogawa-3230"><a href="#convert_to_yokogawa-3230"><span class="linenos">3230</span></a>    <span class="c1">#    for well in WELLS:</span>
</span><span id="convert_to_yokogawa-3231"><a href="#convert_to_yokogawa-3231"><span class="linenos">3231</span></a>    <span class="c1">#        well_name = f&quot;plate{plate}_{well}&quot;</span>
</span><span id="convert_to_yokogawa-3232"><a href="#convert_to_yokogawa-3232"><span class="linenos">3232</span></a>    <span class="c1">#        if well_name not in used_wells:</span>
</span><span id="convert_to_yokogawa-3233"><a href="#convert_to_yokogawa-3233"><span class="linenos">3233</span></a>    <span class="c1">#            used_wells.add(well_name)</span>
</span><span id="convert_to_yokogawa-3234"><a href="#convert_to_yokogawa-3234"><span class="linenos">3234</span></a>    <span class="c1">#            return well_name</span>
</span><span id="convert_to_yokogawa-3235"><a href="#convert_to_yokogawa-3235"><span class="linenos">3235</span></a>    <span class="c1">#        if well == &quot;P24&quot;:  </span>
</span><span id="convert_to_yokogawa-3236"><a href="#convert_to_yokogawa-3236"><span class="linenos">3236</span></a>    <span class="c1">#            plate += 1  </span>
</span><span id="convert_to_yokogawa-3237"><a href="#convert_to_yokogawa-3237"><span class="linenos">3237</span></a>    <span class="c1">#    raise ValueError(&quot;All wells exhausted.&quot;)</span>
</span><span id="convert_to_yokogawa-3238"><a href="#convert_to_yokogawa-3238"><span class="linenos">3238</span></a>    
</span><span id="convert_to_yokogawa-3239"><a href="#convert_to_yokogawa-3239"><span class="linenos">3239</span></a>    <span class="k">def</span> <span class="nf">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3240"><a href="#convert_to_yokogawa-3240"><span class="linenos">3240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="convert_to_yokogawa-3241"><a href="#convert_to_yokogawa-3241"><span class="linenos">3241</span></a><span class="sd">        Determines the next available well position across multiple 384-well plates.</span>
</span><span id="convert_to_yokogawa-3242"><a href="#convert_to_yokogawa-3242"><span class="linenos">3242</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="convert_to_yokogawa-3243"><a href="#convert_to_yokogawa-3243"><span class="linenos">3243</span></a>        <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
</span><span id="convert_to_yokogawa-3244"><a href="#convert_to_yokogawa-3244"><span class="linenos">3244</span></a>        <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</span><span id="convert_to_yokogawa-3245"><a href="#convert_to_yokogawa-3245"><span class="linenos">3245</span></a>        <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3246"><a href="#convert_to_yokogawa-3246"><span class="linenos">3246</span></a>
</span><span id="convert_to_yokogawa-3247"><a href="#convert_to_yokogawa-3247"><span class="linenos">3247</span></a>        <span class="n">plate</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="convert_to_yokogawa-3248"><a href="#convert_to_yokogawa-3248"><span class="linenos">3248</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3249"><a href="#convert_to_yokogawa-3249"><span class="linenos">3249</span></a>            <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">WELLS</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3250"><a href="#convert_to_yokogawa-3250"><span class="linenos">3250</span></a>                <span class="n">well_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;plate</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="convert_to_yokogawa-3251"><a href="#convert_to_yokogawa-3251"><span class="linenos">3251</span></a>                <span class="k">if</span> <span class="n">well_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_wells</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3252"><a href="#convert_to_yokogawa-3252"><span class="linenos">3252</span></a>                    <span class="n">used_wells</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">well_name</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3253"><a href="#convert_to_yokogawa-3253"><span class="linenos">3253</span></a>                    <span class="k">return</span> <span class="n">well_name</span>
</span><span id="convert_to_yokogawa-3254"><a href="#convert_to_yokogawa-3254"><span class="linenos">3254</span></a>            <span class="n">plate</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># All wells exhausted in current plate, increment to next plate</span>
</span><span id="convert_to_yokogawa-3255"><a href="#convert_to_yokogawa-3255"><span class="linenos">3255</span></a>
</span><span id="convert_to_yokogawa-3256"><a href="#convert_to_yokogawa-3256"><span class="linenos">3256</span></a>
</span><span id="convert_to_yokogawa-3257"><a href="#convert_to_yokogawa-3257"><span class="linenos">3257</span></a>    <span class="c1"># Define 384-well plate format</span>
</span><span id="convert_to_yokogawa-3258"><a href="#convert_to_yokogawa-3258"><span class="linenos">3258</span></a>    <span class="n">ROWS</span> <span class="o">=</span> <span class="s2">&quot;ABCDEFGHIJKLMNOP&quot;</span>
</span><span id="convert_to_yokogawa-3259"><a href="#convert_to_yokogawa-3259"><span class="linenos">3259</span></a>    <span class="n">COLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">)]</span>
</span><span id="convert_to_yokogawa-3260"><a href="#convert_to_yokogawa-3260"><span class="linenos">3260</span></a>    <span class="n">WELLS</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ROWS</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLS</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3261"><a href="#convert_to_yokogawa-3261"><span class="linenos">3261</span></a>
</span><span id="convert_to_yokogawa-3262"><a href="#convert_to_yokogawa-3262"><span class="linenos">3262</span></a>    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="convert_to_yokogawa-3263"><a href="#convert_to_yokogawa-3263"><span class="linenos">3263</span></a>    <span class="n">rename_log</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="convert_to_yokogawa-3264"><a href="#convert_to_yokogawa-3264"><span class="linenos">3264</span></a>    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s2">&quot;rename_log.csv&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3265"><a href="#convert_to_yokogawa-3265"><span class="linenos">3265</span></a>    <span class="n">used_wells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="convert_to_yokogawa-3266"><a href="#convert_to_yokogawa-3266"><span class="linenos">3266</span></a>
</span><span id="convert_to_yokogawa-3267"><a href="#convert_to_yokogawa-3267"><span class="linenos">3267</span></a>    <span class="c1"># **Dictionary to store well assignments per original file**</span>
</span><span id="convert_to_yokogawa-3268"><a href="#convert_to_yokogawa-3268"><span class="linenos">3268</span></a>    <span class="n">file_to_well</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="convert_to_yokogawa-3269"><a href="#convert_to_yokogawa-3269"><span class="linenos">3269</span></a>
</span><span id="convert_to_yokogawa-3270"><a href="#convert_to_yokogawa-3270"><span class="linenos">3270</span></a>    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3271"><a href="#convert_to_yokogawa-3271"><span class="linenos">3271</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3272"><a href="#convert_to_yokogawa-3272"><span class="linenos">3272</span></a>        <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3273"><a href="#convert_to_yokogawa-3273"><span class="linenos">3273</span></a>
</span><span id="convert_to_yokogawa-3274"><a href="#convert_to_yokogawa-3274"><span class="linenos">3274</span></a>        <span class="c1"># **Assign a well only once per original file**</span>
</span><span id="convert_to_yokogawa-3275"><a href="#convert_to_yokogawa-3275"><span class="linenos">3275</span></a>        <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_to_well</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3276"><a href="#convert_to_yokogawa-3276"><span class="linenos">3276</span></a>            <span class="n">file_to_well</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_next_well</span><span class="p">(</span><span class="n">used_wells</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3277"><a href="#convert_to_yokogawa-3277"><span class="linenos">3277</span></a>            <span class="c1">#used_wells.add(file_to_well[file])  # Mark it as used</span>
</span><span id="convert_to_yokogawa-3278"><a href="#convert_to_yokogawa-3278"><span class="linenos">3278</span></a>
</span><span id="convert_to_yokogawa-3279"><a href="#convert_to_yokogawa-3279"><span class="linenos">3279</span></a>        <span class="n">well</span> <span class="o">=</span> <span class="n">file_to_well</span><span class="p">[</span><span class="n">file</span><span class="p">]</span>  <span class="c1"># Use the same well for all channels/times</span>
</span><span id="convert_to_yokogawa-3280"><a href="#convert_to_yokogawa-3280"><span class="linenos">3280</span></a>
</span><span id="convert_to_yokogawa-3281"><a href="#convert_to_yokogawa-3281"><span class="linenos">3281</span></a>        <span class="c1">### **Process Nikon ND2 Files**</span>
</span><span id="convert_to_yokogawa-3282"><a href="#convert_to_yokogawa-3282"><span class="linenos">3282</span></a>        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;nd2&#39;</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3283"><a href="#convert_to_yokogawa-3283"><span class="linenos">3283</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3284"><a href="#convert_to_yokogawa-3284"><span class="linenos">3284</span></a>                <span class="n">nd2</span> <span class="o">=</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3285"><a href="#convert_to_yokogawa-3285"><span class="linenos">3285</span></a>                <span class="n">metadata</span> <span class="o">=</span> <span class="n">nd2</span><span class="o">.</span><span class="n">metadata</span>
</span><span id="convert_to_yokogawa-3286"><a href="#convert_to_yokogawa-3286"><span class="linenos">3286</span></a>
</span><span id="convert_to_yokogawa-3287"><a href="#convert_to_yokogawa-3287"><span class="linenos">3287</span></a>                <span class="n">timepoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frames&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3288"><a href="#convert_to_yokogawa-3288"><span class="linenos">3288</span></a>                <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields_of_view&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))))</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3289"><a href="#convert_to_yokogawa-3289"><span class="linenos">3289</span></a>                <span class="n">z_levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_levels&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;z_levels&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3290"><a href="#convert_to_yokogawa-3290"><span class="linenos">3290</span></a>                <span class="n">channels</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channels&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="convert_to_yokogawa-3291"><a href="#convert_to_yokogawa-3291"><span class="linenos">3291</span></a>
</span><span id="convert_to_yokogawa-3292"><a href="#convert_to_yokogawa-3292"><span class="linenos">3292</span></a>                <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="n">timepoints</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3293"><a href="#convert_to_yokogawa-3293"><span class="linenos">3293</span></a>                    <span class="k">for</span> <span class="n">f_idx</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3294"><a href="#convert_to_yokogawa-3294"><span class="linenos">3294</span></a>                        <span class="k">for</span> <span class="n">c_idx</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3295"><a href="#convert_to_yokogawa-3295"><span class="linenos">3295</span></a>                            <span class="k">try</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3296"><a href="#convert_to_yokogawa-3296"><span class="linenos">3296</span></a>                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span>
</span><span id="convert_to_yokogawa-3297"><a href="#convert_to_yokogawa-3297"><span class="linenos">3297</span></a>                                    <span class="n">nd2</span><span class="o">.</span><span class="n">get_frame_2D</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">f_idx</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_idx</span><span class="p">)</span> 
</span><span id="convert_to_yokogawa-3298"><a href="#convert_to_yokogawa-3298"><span class="linenos">3298</span></a>                                    <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="n">z_levels</span>
</span><span id="convert_to_yokogawa-3299"><a href="#convert_to_yokogawa-3299"><span class="linenos">3299</span></a>                                <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3300"><a href="#convert_to_yokogawa-3300"><span class="linenos">3300</span></a>
</span><span id="convert_to_yokogawa-3301"><a href="#convert_to_yokogawa-3301"><span class="linenos">3301</span></a>                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="convert_to_yokogawa-3302"><a href="#convert_to_yokogawa-3302"><span class="linenos">3302</span></a>                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="n">f_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="convert_to_yokogawa-3303"><a href="#convert_to_yokogawa-3303"><span class="linenos">3303</span></a>                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3304"><a href="#convert_to_yokogawa-3304"><span class="linenos">3304</span></a>
</span><span id="convert_to_yokogawa-3305"><a href="#convert_to_yokogawa-3305"><span class="linenos">3305</span></a>                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="convert_to_yokogawa-3306"><a href="#convert_to_yokogawa-3306"><span class="linenos">3306</span></a>                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3307"><a href="#convert_to_yokogawa-3307"><span class="linenos">3307</span></a>
</span><span id="convert_to_yokogawa-3308"><a href="#convert_to_yokogawa-3308"><span class="linenos">3308</span></a>                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3309"><a href="#convert_to_yokogawa-3309"><span class="linenos">3309</span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: ND2 file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2"> has an incomplete data structure. Skipping.&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3310"><a href="#convert_to_yokogawa-3310"><span class="linenos">3310</span></a>
</span><span id="convert_to_yokogawa-3311"><a href="#convert_to_yokogawa-3311"><span class="linenos">3311</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3312"><a href="#convert_to_yokogawa-3312"><span class="linenos">3312</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing ND2 file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3313"><a href="#convert_to_yokogawa-3313"><span class="linenos">3313</span></a>
</span><span id="convert_to_yokogawa-3314"><a href="#convert_to_yokogawa-3314"><span class="linenos">3314</span></a>        <span class="c1">### **Process Zeiss CZI Files**</span>
</span><span id="convert_to_yokogawa-3315"><a href="#convert_to_yokogawa-3315"><span class="linenos">3315</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;czi&#39;</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3316"><a href="#convert_to_yokogawa-3316"><span class="linenos">3316</span></a>            <span class="k">with</span> <span class="n">czifile</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czi</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3317"><a href="#convert_to_yokogawa-3317"><span class="linenos">3317</span></a>                <span class="n">img_data</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>  <span class="c1"># Read the full image array</span>
</span><span id="convert_to_yokogawa-3318"><a href="#convert_to_yokogawa-3318"><span class="linenos">3318</span></a>
</span><span id="convert_to_yokogawa-3319"><a href="#convert_to_yokogawa-3319"><span class="linenos">3319</span></a>                <span class="c1"># Remove singleton dimensions (if any)</span>
</span><span id="convert_to_yokogawa-3320"><a href="#convert_to_yokogawa-3320"><span class="linenos">3320</span></a>                <span class="n">img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">img_data</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3321"><a href="#convert_to_yokogawa-3321"><span class="linenos">3321</span></a>
</span><span id="convert_to_yokogawa-3322"><a href="#convert_to_yokogawa-3322"><span class="linenos">3322</span></a>                <span class="c1"># Get the actual shape of the data</span>
</span><span id="convert_to_yokogawa-3323"><a href="#convert_to_yokogawa-3323"><span class="linenos">3323</span></a>                <span class="n">shape</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="convert_to_yokogawa-3324"><a href="#convert_to_yokogawa-3324"><span class="linenos">3324</span></a>                <span class="n">num_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3325"><a href="#convert_to_yokogawa-3325"><span class="linenos">3325</span></a>
</span><span id="convert_to_yokogawa-3326"><a href="#convert_to_yokogawa-3326"><span class="linenos">3326</span></a>                <span class="c1"># Default values if dimensions are missing</span>
</span><span id="convert_to_yokogawa-3327"><a href="#convert_to_yokogawa-3327"><span class="linenos">3327</span></a>                <span class="n">timepoints</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="convert_to_yokogawa-3328"><a href="#convert_to_yokogawa-3328"><span class="linenos">3328</span></a>                <span class="n">z_levels</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="convert_to_yokogawa-3329"><a href="#convert_to_yokogawa-3329"><span class="linenos">3329</span></a>                <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="convert_to_yokogawa-3330"><a href="#convert_to_yokogawa-3330"><span class="linenos">3330</span></a>
</span><span id="convert_to_yokogawa-3331"><a href="#convert_to_yokogawa-3331"><span class="linenos">3331</span></a>                <span class="c1"># Determine dimension mapping dynamically</span>
</span><span id="convert_to_yokogawa-3332"><a href="#convert_to_yokogawa-3332"><span class="linenos">3332</span></a>                <span class="k">if</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># (Y, X)  Single 2D image</span>
</span><span id="convert_to_yokogawa-3333"><a href="#convert_to_yokogawa-3333"><span class="linenos">3333</span></a>                    <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="convert_to_yokogawa-3334"><a href="#convert_to_yokogawa-3334"><span class="linenos">3334</span></a>                    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing dimensions</span>
</span><span id="convert_to_yokogawa-3335"><a href="#convert_to_yokogawa-3335"><span class="linenos">3335</span></a>                <span class="k">elif</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># (C, Y, X) or (Z, Y, X)</span>
</span><span id="convert_to_yokogawa-3336"><a href="#convert_to_yokogawa-3336"><span class="linenos">3336</span></a>                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Likely (C, Y, X)</span>
</span><span id="convert_to_yokogawa-3337"><a href="#convert_to_yokogawa-3337"><span class="linenos">3337</span></a>                        <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="convert_to_yokogawa-3338"><a href="#convert_to_yokogawa-3338"><span class="linenos">3338</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing dimensions</span>
</span><span id="convert_to_yokogawa-3339"><a href="#convert_to_yokogawa-3339"><span class="linenos">3339</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Likely (Z, Y, X)</span>
</span><span id="convert_to_yokogawa-3340"><a href="#convert_to_yokogawa-3340"><span class="linenos">3340</span></a>                        <span class="n">z_levels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="convert_to_yokogawa-3341"><a href="#convert_to_yokogawa-3341"><span class="linenos">3341</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing dimensions</span>
</span><span id="convert_to_yokogawa-3342"><a href="#convert_to_yokogawa-3342"><span class="linenos">3342</span></a>                <span class="k">elif</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Could be (T, C, Y, X) or (T, Z, Y, X) or (Z, C, Y, X)</span>
</span><span id="convert_to_yokogawa-3343"><a href="#convert_to_yokogawa-3343"><span class="linenos">3343</span></a>                    <span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Assume (T, C, Y, X)</span>
</span><span id="convert_to_yokogawa-3344"><a href="#convert_to_yokogawa-3344"><span class="linenos">3344</span></a>                        <span class="n">timepoints</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="convert_to_yokogawa-3345"><a href="#convert_to_yokogawa-3345"><span class="linenos">3345</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing Z</span>
</span><span id="convert_to_yokogawa-3346"><a href="#convert_to_yokogawa-3346"><span class="linenos">3346</span></a>                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Assume (T, Z, Y, X) or (Z, C, Y, X)</span>
</span><span id="convert_to_yokogawa-3347"><a href="#convert_to_yokogawa-3347"><span class="linenos">3347</span></a>                        <span class="n">timepoints</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="convert_to_yokogawa-3348"><a href="#convert_to_yokogawa-3348"><span class="linenos">3348</span></a>                        <span class="n">img_data</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">)</span>  <span class="c1"># Add missing C</span>
</span><span id="convert_to_yokogawa-3349"><a href="#convert_to_yokogawa-3349"><span class="linenos">3349</span></a>                <span class="k">elif</span> <span class="n">num_dims</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Standard (T, Z, C, Y, X)</span>
</span><span id="convert_to_yokogawa-3350"><a href="#convert_to_yokogawa-3350"><span class="linenos">3350</span></a>                    <span class="n">timepoints</span><span class="p">,</span> <span class="n">z_levels</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">shape</span>
</span><span id="convert_to_yokogawa-3351"><a href="#convert_to_yokogawa-3351"><span class="linenos">3351</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3352"><a href="#convert_to_yokogawa-3352"><span class="linenos">3352</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected CZI shape: </span><span class="si">{</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Unable to process.&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3353"><a href="#convert_to_yokogawa-3353"><span class="linenos">3353</span></a>
</span><span id="convert_to_yokogawa-3354"><a href="#convert_to_yokogawa-3354"><span class="linenos">3354</span></a>                <span class="c1"># Iterate over detected timepoints, channels, and perform MIP over Z</span>
</span><span id="convert_to_yokogawa-3355"><a href="#convert_to_yokogawa-3355"><span class="linenos">3355</span></a>                <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timepoints</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3356"><a href="#convert_to_yokogawa-3356"><span class="linenos">3356</span></a>                    <span class="k">for</span> <span class="n">c_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3357"><a href="#convert_to_yokogawa-3357"><span class="linenos">3357</span></a>                        <span class="c1"># Extract Z-stack or single image</span>
</span><span id="convert_to_yokogawa-3358"><a href="#convert_to_yokogawa-3358"><span class="linenos">3358</span></a>                        <span class="k">if</span> <span class="n">z_levels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3359"><a href="#convert_to_yokogawa-3359"><span class="linenos">3359</span></a>                            <span class="n">z_stack</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># MIP over Z</span>
</span><span id="convert_to_yokogawa-3360"><a href="#convert_to_yokogawa-3360"><span class="linenos">3360</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3361"><a href="#convert_to_yokogawa-3361"><span class="linenos">3361</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3362"><a href="#convert_to_yokogawa-3362"><span class="linenos">3362</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">img_data</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># No Z, take directly</span>
</span><span id="convert_to_yokogawa-3363"><a href="#convert_to_yokogawa-3363"><span class="linenos">3363</span></a>
</span><span id="convert_to_yokogawa-3364"><a href="#convert_to_yokogawa-3364"><span class="linenos">3364</span></a>                        <span class="c1"># Ensure correct dtype</span>
</span><span id="convert_to_yokogawa-3365"><a href="#convert_to_yokogawa-3365"><span class="linenos">3365</span></a>                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="convert_to_yokogawa-3366"><a href="#convert_to_yokogawa-3366"><span class="linenos">3366</span></a>
</span><span id="convert_to_yokogawa-3367"><a href="#convert_to_yokogawa-3367"><span class="linenos">3367</span></a>                        <span class="c1"># Generate Yokogawa-style filename</span>
</span><span id="convert_to_yokogawa-3368"><a href="#convert_to_yokogawa-3368"><span class="linenos">3368</span></a>                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F001L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="convert_to_yokogawa-3369"><a href="#convert_to_yokogawa-3369"><span class="linenos">3369</span></a>                        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3370"><a href="#convert_to_yokogawa-3370"><span class="linenos">3370</span></a>
</span><span id="convert_to_yokogawa-3371"><a href="#convert_to_yokogawa-3371"><span class="linenos">3371</span></a>                        <span class="c1"># Save the extracted image</span>
</span><span id="convert_to_yokogawa-3372"><a href="#convert_to_yokogawa-3372"><span class="linenos">3372</span></a>                        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="convert_to_yokogawa-3373"><a href="#convert_to_yokogawa-3373"><span class="linenos">3373</span></a>
</span><span id="convert_to_yokogawa-3374"><a href="#convert_to_yokogawa-3374"><span class="linenos">3374</span></a>                        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3375"><a href="#convert_to_yokogawa-3375"><span class="linenos">3375</span></a>
</span><span id="convert_to_yokogawa-3376"><a href="#convert_to_yokogawa-3376"><span class="linenos">3376</span></a>        <span class="c1">### **Process Leica LIF Files**</span>
</span><span id="convert_to_yokogawa-3377"><a href="#convert_to_yokogawa-3377"><span class="linenos">3377</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;lif&#39;</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3378"><a href="#convert_to_yokogawa-3378"><span class="linenos">3378</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3379"><a href="#convert_to_yokogawa-3379"><span class="linenos">3379</span></a>                <span class="n">lif_file</span> <span class="o">=</span> <span class="n">readlif</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3380"><a href="#convert_to_yokogawa-3380"><span class="linenos">3380</span></a>
</span><span id="convert_to_yokogawa-3381"><a href="#convert_to_yokogawa-3381"><span class="linenos">3381</span></a>                <span class="k">for</span> <span class="n">image_idx</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lif_file</span><span class="o">.</span><span class="n">getIterImage</span><span class="p">()):</span>
</span><span id="convert_to_yokogawa-3382"><a href="#convert_to_yokogawa-3382"><span class="linenos">3382</span></a>                    <span class="n">timepoints</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="convert_to_yokogawa-3383"><a href="#convert_to_yokogawa-3383"><span class="linenos">3383</span></a>                    <span class="n">z_levels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="convert_to_yokogawa-3384"><a href="#convert_to_yokogawa-3384"><span class="linenos">3384</span></a>                    <span class="n">channels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="convert_to_yokogawa-3385"><a href="#convert_to_yokogawa-3385"><span class="linenos">3385</span></a>
</span><span id="convert_to_yokogawa-3386"><a href="#convert_to_yokogawa-3386"><span class="linenos">3386</span></a>                    <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="n">timepoints</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3387"><a href="#convert_to_yokogawa-3387"><span class="linenos">3387</span></a>                        <span class="k">for</span> <span class="n">c_idx</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3388"><a href="#convert_to_yokogawa-3388"><span class="linenos">3388</span></a>                            <span class="n">z_stack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="convert_to_yokogawa-3389"><a href="#convert_to_yokogawa-3389"><span class="linenos">3389</span></a>                            <span class="k">for</span> <span class="n">z_idx</span> <span class="ow">in</span> <span class="n">z_levels</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3390"><a href="#convert_to_yokogawa-3390"><span class="linenos">3390</span></a>                                <span class="k">try</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3391"><a href="#convert_to_yokogawa-3391"><span class="linenos">3391</span></a>                                    <span class="n">frame</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">getFrame</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">z_idx</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_idx</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3392"><a href="#convert_to_yokogawa-3392"><span class="linenos">3392</span></a>                                    <span class="n">z_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3393"><a href="#convert_to_yokogawa-3393"><span class="linenos">3393</span></a>                                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3394"><a href="#convert_to_yokogawa-3394"><span class="linenos">3394</span></a>                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing frame: T</span><span class="si">{</span><span class="n">t_idx</span><span class="si">}</span><span class="s2">, Z</span><span class="si">{</span><span class="n">z_idx</span><span class="si">}</span><span class="s2">, C</span><span class="si">{</span><span class="n">c_idx</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">, skipping frame.&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3395"><a href="#convert_to_yokogawa-3395"><span class="linenos">3395</span></a>                            
</span><span id="convert_to_yokogawa-3396"><a href="#convert_to_yokogawa-3396"><span class="linenos">3396</span></a>                            <span class="k">if</span> <span class="n">z_stack</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3397"><a href="#convert_to_yokogawa-3397"><span class="linenos">3397</span></a>                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">z_stack</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3398"><a href="#convert_to_yokogawa-3398"><span class="linenos">3398</span></a>                                <span class="n">dtype</span> <span class="o">=</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="convert_to_yokogawa-3399"><a href="#convert_to_yokogawa-3399"><span class="linenos">3399</span></a>                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F</span><span class="si">{</span><span class="n">image_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">L01C</span><span class="si">{</span><span class="n">c_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="convert_to_yokogawa-3400"><a href="#convert_to_yokogawa-3400"><span class="linenos">3400</span></a>                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3401"><a href="#convert_to_yokogawa-3401"><span class="linenos">3401</span></a>
</span><span id="convert_to_yokogawa-3402"><a href="#convert_to_yokogawa-3402"><span class="linenos">3402</span></a>                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mip_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</span><span id="convert_to_yokogawa-3403"><a href="#convert_to_yokogawa-3403"><span class="linenos">3403</span></a>                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3404"><a href="#convert_to_yokogawa-3404"><span class="linenos">3404</span></a>
</span><span id="convert_to_yokogawa-3405"><a href="#convert_to_yokogawa-3405"><span class="linenos">3405</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3406"><a href="#convert_to_yokogawa-3406"><span class="linenos">3406</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing LIF file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3407"><a href="#convert_to_yokogawa-3407"><span class="linenos">3407</span></a>
</span><span id="convert_to_yokogawa-3408"><a href="#convert_to_yokogawa-3408"><span class="linenos">3408</span></a>        <span class="c1">### **Process Standard Image Files (TIFF, PNG, JPEG, BMP)**</span>
</span><span id="convert_to_yokogawa-3409"><a href="#convert_to_yokogawa-3409"><span class="linenos">3409</span></a>        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;bmp&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;plate&quot;</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3410"><a href="#convert_to_yokogawa-3410"><span class="linenos">3410</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3411"><a href="#convert_to_yokogawa-3411"><span class="linenos">3411</span></a>                <span class="k">with</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3412"><a href="#convert_to_yokogawa-3412"><span class="linenos">3412</span></a>                    <span class="n">images</span> <span class="o">=</span> <span class="n">tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
</span><span id="convert_to_yokogawa-3413"><a href="#convert_to_yokogawa-3413"><span class="linenos">3413</span></a>                    <span class="n">ndim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">ndim</span>
</span><span id="convert_to_yokogawa-3414"><a href="#convert_to_yokogawa-3414"><span class="linenos">3414</span></a>
</span><span id="convert_to_yokogawa-3415"><a href="#convert_to_yokogawa-3415"><span class="linenos">3415</span></a>                    <span class="c1"># Defaults</span>
</span><span id="convert_to_yokogawa-3416"><a href="#convert_to_yokogawa-3416"><span class="linenos">3416</span></a>                    <span class="n">t_dim</span> <span class="o">=</span> <span class="n">z_dim</span> <span class="o">=</span> <span class="n">c_dim</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="convert_to_yokogawa-3417"><a href="#convert_to_yokogawa-3417"><span class="linenos">3417</span></a>
</span><span id="convert_to_yokogawa-3418"><a href="#convert_to_yokogawa-3418"><span class="linenos">3418</span></a>                    <span class="c1"># Determine dimensions more explicitly</span>
</span><span id="convert_to_yokogawa-3419"><a href="#convert_to_yokogawa-3419"><span class="linenos">3419</span></a>                    <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3420"><a href="#convert_to_yokogawa-3420"><span class="linenos">3420</span></a>                        <span class="n">mip_image</span> <span class="o">=</span> <span class="n">images</span>
</span><span id="convert_to_yokogawa-3421"><a href="#convert_to_yokogawa-3421"><span class="linenos">3421</span></a>                        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C01.tif&quot;</span>
</span><span id="convert_to_yokogawa-3422"><a href="#convert_to_yokogawa-3422"><span class="linenos">3422</span></a>                        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3423"><a href="#convert_to_yokogawa-3423"><span class="linenos">3423</span></a>                        <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3424"><a href="#convert_to_yokogawa-3424"><span class="linenos">3424</span></a>                        <span class="k">continue</span>
</span><span id="convert_to_yokogawa-3425"><a href="#convert_to_yokogawa-3425"><span class="linenos">3425</span></a>
</span><span id="convert_to_yokogawa-3426"><a href="#convert_to_yokogawa-3426"><span class="linenos">3426</span></a>                    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3427"><a href="#convert_to_yokogawa-3427"><span class="linenos">3427</span></a>                        <span class="k">if</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Likely channels</span>
</span><span id="convert_to_yokogawa-3428"><a href="#convert_to_yokogawa-3428"><span class="linenos">3428</span></a>                            <span class="n">c_dim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="convert_to_yokogawa-3429"><a href="#convert_to_yokogawa-3429"><span class="linenos">3429</span></a>                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c_dim</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3430"><a href="#convert_to_yokogawa-3430"><span class="linenos">3430</span></a>                                <span class="n">mip_image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="convert_to_yokogawa-3431"><a href="#convert_to_yokogawa-3431"><span class="linenos">3431</span></a>                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C</span><span class="si">{</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
</span><span id="convert_to_yokogawa-3432"><a href="#convert_to_yokogawa-3432"><span class="linenos">3432</span></a>                                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3433"><a href="#convert_to_yokogawa-3433"><span class="linenos">3433</span></a>                                <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3434"><a href="#convert_to_yokogawa-3434"><span class="linenos">3434</span></a>                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Z-stack</span>
</span><span id="convert_to_yokogawa-3435"><a href="#convert_to_yokogawa-3435"><span class="linenos">3435</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3436"><a href="#convert_to_yokogawa-3436"><span class="linenos">3436</span></a>                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T0001F001L01C01.tif&quot;</span>
</span><span id="convert_to_yokogawa-3437"><a href="#convert_to_yokogawa-3437"><span class="linenos">3437</span></a>                            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3438"><a href="#convert_to_yokogawa-3438"><span class="linenos">3438</span></a>                            <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3439"><a href="#convert_to_yokogawa-3439"><span class="linenos">3439</span></a>
</span><span id="convert_to_yokogawa-3440"><a href="#convert_to_yokogawa-3440"><span class="linenos">3440</span></a>                    <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3441"><a href="#convert_to_yokogawa-3441"><span class="linenos">3441</span></a>                        <span class="n">t_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">x_dim</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span>
</span><span id="convert_to_yokogawa-3442"><a href="#convert_to_yokogawa-3442"><span class="linenos">3442</span></a>                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_dim</span><span class="p">):</span>
</span><span id="convert_to_yokogawa-3443"><a href="#convert_to_yokogawa-3443"><span class="linenos">3443</span></a>                            <span class="n">mip_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3444"><a href="#convert_to_yokogawa-3444"><span class="linenos">3444</span></a>                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s2">_T</span><span class="si">{</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">F001L01C01.tif&quot;</span>
</span><span id="convert_to_yokogawa-3445"><a href="#convert_to_yokogawa-3445"><span class="linenos">3445</span></a>                            <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">mip_image</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3446"><a href="#convert_to_yokogawa-3446"><span class="linenos">3446</span></a>                            <span class="n">rename_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;Original File&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;Renamed TIFF&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">})</span>
</span><span id="convert_to_yokogawa-3447"><a href="#convert_to_yokogawa-3447"><span class="linenos">3447</span></a>
</span><span id="convert_to_yokogawa-3448"><a href="#convert_to_yokogawa-3448"><span class="linenos">3448</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3449"><a href="#convert_to_yokogawa-3449"><span class="linenos">3449</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported TIFF dimensions: </span><span class="si">{</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3450"><a href="#convert_to_yokogawa-3450"><span class="linenos">3450</span></a>
</span><span id="convert_to_yokogawa-3451"><a href="#convert_to_yokogawa-3451"><span class="linenos">3451</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="convert_to_yokogawa-3452"><a href="#convert_to_yokogawa-3452"><span class="linenos">3452</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing standard image file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3453"><a href="#convert_to_yokogawa-3453"><span class="linenos">3453</span></a>
</span><span id="convert_to_yokogawa-3454"><a href="#convert_to_yokogawa-3454"><span class="linenos">3454</span></a>
</span><span id="convert_to_yokogawa-3455"><a href="#convert_to_yokogawa-3455"><span class="linenos">3455</span></a>    <span class="c1"># Save rename log as CSV</span>
</span><span id="convert_to_yokogawa-3456"><a href="#convert_to_yokogawa-3456"><span class="linenos">3456</span></a>    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rename_log</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="convert_to_yokogawa-3457"><a href="#convert_to_yokogawa-3457"><span class="linenos">3457</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing complete. Files saved in </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2"> and rename log saved as </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Detects file type in the folder and converts them
to Yokogawa-style naming with Maximum Intensity Projection (MIP).</p>
</div>


                </section>
                <section id="apply_augmentation">
                            <input id="apply_augmentation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply_augmentation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">method</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="apply_augmentation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#apply_augmentation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="apply_augmentation-3459"><a href="#apply_augmentation-3459"><span class="linenos">3459</span></a><span class="k">def</span> <span class="nf">apply_augmentation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
</span><span id="apply_augmentation-3460"><a href="#apply_augmentation-3460"><span class="linenos">3460</span></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate90&#39;</span><span class="p">:</span>
</span><span id="apply_augmentation-3461"><a href="#apply_augmentation-3461"><span class="linenos">3461</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_90_CLOCKWISE</span><span class="p">)</span>
</span><span id="apply_augmentation-3462"><a href="#apply_augmentation-3462"><span class="linenos">3462</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate180&#39;</span><span class="p">:</span>
</span><span id="apply_augmentation-3463"><a href="#apply_augmentation-3463"><span class="linenos">3463</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_180</span><span class="p">)</span>
</span><span id="apply_augmentation-3464"><a href="#apply_augmentation-3464"><span class="linenos">3464</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rotate270&#39;</span><span class="p">:</span>
</span><span id="apply_augmentation-3465"><a href="#apply_augmentation-3465"><span class="linenos">3465</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ROTATE_90_COUNTERCLOCKWISE</span><span class="p">)</span>
</span><span id="apply_augmentation-3466"><a href="#apply_augmentation-3466"><span class="linenos">3466</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flip_h&#39;</span><span class="p">:</span>
</span><span id="apply_augmentation-3467"><a href="#apply_augmentation-3467"><span class="linenos">3467</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="apply_augmentation-3468"><a href="#apply_augmentation-3468"><span class="linenos">3468</span></a>    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;flip_v&#39;</span><span class="p">:</span>
</span><span id="apply_augmentation-3469"><a href="#apply_augmentation-3469"><span class="linenos">3469</span></a>        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="apply_augmentation-3470"><a href="#apply_augmentation-3470"><span class="linenos">3470</span></a>    <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


    

                </section>
                <section id="process_instruction">
                            <input id="process_instruction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_instruction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">entry</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="process_instruction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#process_instruction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="process_instruction-3472"><a href="#process_instruction-3472"><span class="linenos">3472</span></a><span class="k">def</span> <span class="nf">process_instruction</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
</span><span id="process_instruction-3473"><a href="#process_instruction-3473"><span class="linenos">3473</span></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src_img&quot;</span><span class="p">])</span>
</span><span id="process_instruction-3474"><a href="#process_instruction-3474"><span class="linenos">3474</span></a>    <span class="n">msk</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src_msk&quot;</span><span class="p">])</span>
</span><span id="process_instruction-3475"><a href="#process_instruction-3475"><span class="linenos">3475</span></a>    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">]:</span>
</span><span id="process_instruction-3476"><a href="#process_instruction-3476"><span class="linenos">3476</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">apply_augmentation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">])</span>
</span><span id="process_instruction-3477"><a href="#process_instruction-3477"><span class="linenos">3477</span></a>        <span class="n">msk</span> <span class="o">=</span> <span class="n">apply_augmentation</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;augment&quot;</span><span class="p">])</span>
</span><span id="process_instruction-3478"><a href="#process_instruction-3478"><span class="linenos">3478</span></a>    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dst_img&quot;</span><span class="p">],</span> <span class="n">img</span><span class="p">)</span>
</span><span id="process_instruction-3479"><a href="#process_instruction-3479"><span class="linenos">3479</span></a>    <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;dst_msk&quot;</span><span class="p">],</span> <span class="n">msk</span><span class="p">)</span>
</span><span id="process_instruction-3480"><a href="#process_instruction-3480"><span class="linenos">3480</span></a>    <span class="k">return</span> <span class="mi">1</span>
</span></pre></div>


    

                </section>
                <section id="prepare_cellpose_dataset">
                            <input id="prepare_cellpose_dataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prepare_cellpose_dataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">input_root</span>, </span><span class="param"><span class="n">augment_data</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">train_fraction</span><span class="o">=</span><span class="mf">0.8</span>, </span><span class="param"><span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="prepare_cellpose_dataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#prepare_cellpose_dataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="prepare_cellpose_dataset-3482"><a href="#prepare_cellpose_dataset-3482"><span class="linenos">3482</span></a><span class="k">def</span> <span class="nf">prepare_cellpose_dataset</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="n">augment_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_fraction</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3483"><a href="#prepare_cellpose_dataset-3483"><span class="linenos">3483</span></a>    
</span><span id="prepare_cellpose_dataset-3484"><a href="#prepare_cellpose_dataset-3484"><span class="linenos">3484</span></a>    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
</span><span id="prepare_cellpose_dataset-3485"><a href="#prepare_cellpose_dataset-3485"><span class="linenos">3485</span></a>
</span><span id="prepare_cellpose_dataset-3486"><a href="#prepare_cellpose_dataset-3486"><span class="linenos">3486</span></a>    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="prepare_cellpose_dataset-3487"><a href="#prepare_cellpose_dataset-3487"><span class="linenos">3487</span></a>    <span class="n">input_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_root</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3488"><a href="#prepare_cellpose_dataset-3488"><span class="linenos">3488</span></a>    <span class="n">output_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="s2">&quot;cellpose_dataset&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3489"><a href="#prepare_cellpose_dataset-3489"><span class="linenos">3489</span></a>
</span><span id="prepare_cellpose_dataset-3490"><a href="#prepare_cellpose_dataset-3490"><span class="linenos">3490</span></a>    <span class="k">def</span> <span class="nf">get_augmentations</span><span class="p">():</span>
</span><span id="prepare_cellpose_dataset-3491"><a href="#prepare_cellpose_dataset-3491"><span class="linenos">3491</span></a>        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;rotate90&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate180&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate270&#39;</span><span class="p">,</span> <span class="s1">&#39;flip_h&#39;</span><span class="p">,</span> <span class="s1">&#39;flip_v&#39;</span><span class="p">]</span>
</span><span id="prepare_cellpose_dataset-3492"><a href="#prepare_cellpose_dataset-3492"><span class="linenos">3492</span></a>
</span><span id="prepare_cellpose_dataset-3493"><a href="#prepare_cellpose_dataset-3493"><span class="linenos">3493</span></a>    <span class="k">def</span> <span class="nf">find_image_mask_pairs</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3494"><a href="#prepare_cellpose_dataset-3494"><span class="linenos">3494</span></a>        <span class="n">mask_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3495"><a href="#prepare_cellpose_dataset-3495"><span class="linenos">3495</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="prepare_cellpose_dataset-3496"><a href="#prepare_cellpose_dataset-3496"><span class="linenos">3496</span></a>        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3497"><a href="#prepare_cellpose_dataset-3497"><span class="linenos">3497</span></a>            <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)):</span>
</span><span id="prepare_cellpose_dataset-3498"><a href="#prepare_cellpose_dataset-3498"><span class="linenos">3498</span></a>                <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3499"><a href="#prepare_cellpose_dataset-3499"><span class="linenos">3499</span></a>                <span class="n">msk_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3500"><a href="#prepare_cellpose_dataset-3500"><span class="linenos">3500</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">msk_path</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3501"><a href="#prepare_cellpose_dataset-3501"><span class="linenos">3501</span></a>                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">))</span>
</span><span id="prepare_cellpose_dataset-3502"><a href="#prepare_cellpose_dataset-3502"><span class="linenos">3502</span></a>        <span class="k">return</span> <span class="n">pairs</span>
</span><span id="prepare_cellpose_dataset-3503"><a href="#prepare_cellpose_dataset-3503"><span class="linenos">3503</span></a>
</span><span id="prepare_cellpose_dataset-3504"><a href="#prepare_cellpose_dataset-3504"><span class="linenos">3504</span></a>    <span class="k">def</span> <span class="nf">prepare_output_folders</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3505"><a href="#prepare_cellpose_dataset-3505"><span class="linenos">3505</span></a>        <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
</span><span id="prepare_cellpose_dataset-3506"><a href="#prepare_cellpose_dataset-3506"><span class="linenos">3506</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3507"><a href="#prepare_cellpose_dataset-3507"><span class="linenos">3507</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3508"><a href="#prepare_cellpose_dataset-3508"><span class="linenos">3508</span></a>
</span><span id="prepare_cellpose_dataset-3509"><a href="#prepare_cellpose_dataset-3509"><span class="linenos">3509</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scanning datasets...&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3510"><a href="#prepare_cellpose_dataset-3510"><span class="linenos">3510</span></a>    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="prepare_cellpose_dataset-3511"><a href="#prepare_cellpose_dataset-3511"><span class="linenos">3511</span></a>    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_root</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3512"><a href="#prepare_cellpose_dataset-3512"><span class="linenos">3512</span></a>        <span class="n">dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_root</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3513"><a href="#prepare_cellpose_dataset-3513"><span class="linenos">3513</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">)):</span>
</span><span id="prepare_cellpose_dataset-3514"><a href="#prepare_cellpose_dataset-3514"><span class="linenos">3514</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">find_image_mask_pairs</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3515"><a href="#prepare_cellpose_dataset-3515"><span class="linenos">3515</span></a>            <span class="k">if</span> <span class="n">pairs</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3516"><a href="#prepare_cellpose_dataset-3516"><span class="linenos">3516</span></a>                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3517"><a href="#prepare_cellpose_dataset-3517"><span class="linenos">3517</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2"> images in </span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3518"><a href="#prepare_cellpose_dataset-3518"><span class="linenos">3518</span></a>
</span><span id="prepare_cellpose_dataset-3519"><a href="#prepare_cellpose_dataset-3519"><span class="linenos">3519</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">datasets</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3520"><a href="#prepare_cellpose_dataset-3520"><span class="linenos">3520</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid datasets with images and masks found.&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3521"><a href="#prepare_cellpose_dataset-3521"><span class="linenos">3521</span></a>
</span><span id="prepare_cellpose_dataset-3522"><a href="#prepare_cellpose_dataset-3522"><span class="linenos">3522</span></a>    <span class="n">prepare_output_folders</span><span class="p">(</span><span class="n">output_root</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3523"><a href="#prepare_cellpose_dataset-3523"><span class="linenos">3523</span></a>
</span><span id="prepare_cellpose_dataset-3524"><a href="#prepare_cellpose_dataset-3524"><span class="linenos">3524</span></a>    <span class="n">min_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3525"><a href="#prepare_cellpose_dataset-3525"><span class="linenos">3525</span></a>    <span class="n">target_size</span> <span class="o">=</span> <span class="n">min_size</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">augment_data</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3526"><a href="#prepare_cellpose_dataset-3526"><span class="linenos">3526</span></a>
</span><span id="prepare_cellpose_dataset-3527"><a href="#prepare_cellpose_dataset-3527"><span class="linenos">3527</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Preparing instruction list...&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3528"><a href="#prepare_cellpose_dataset-3528"><span class="linenos">3528</span></a>    <span class="n">instructions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="prepare_cellpose_dataset-3529"><a href="#prepare_cellpose_dataset-3529"><span class="linenos">3529</span></a>    <span class="n">global_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="prepare_cellpose_dataset-3530"><a href="#prepare_cellpose_dataset-3530"><span class="linenos">3530</span></a>
</span><span id="prepare_cellpose_dataset-3531"><a href="#prepare_cellpose_dataset-3531"><span class="linenos">3531</span></a>    <span class="k">for</span> <span class="n">pairs</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3532"><a href="#prepare_cellpose_dataset-3532"><span class="linenos">3532</span></a>        <span class="n">dataset_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3533"><a href="#prepare_cellpose_dataset-3533"><span class="linenos">3533</span></a>
</span><span id="prepare_cellpose_dataset-3534"><a href="#prepare_cellpose_dataset-3534"><span class="linenos">3534</span></a>        <span class="c1"># --- Step 1: Sample or augment ---</span>
</span><span id="prepare_cellpose_dataset-3535"><a href="#prepare_cellpose_dataset-3535"><span class="linenos">3535</span></a>        <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="prepare_cellpose_dataset-3536"><a href="#prepare_cellpose_dataset-3536"><span class="linenos">3536</span></a>        <span class="k">if</span> <span class="n">dataset_len</span> <span class="o">&gt;=</span> <span class="n">target_size</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3537"><a href="#prepare_cellpose_dataset-3537"><span class="linenos">3537</span></a>            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3538"><a href="#prepare_cellpose_dataset-3538"><span class="linenos">3538</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3539"><a href="#prepare_cellpose_dataset-3539"><span class="linenos">3539</span></a>            <span class="n">sampled_pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="prepare_cellpose_dataset-3540"><a href="#prepare_cellpose_dataset-3540"><span class="linenos">3540</span></a>            <span class="k">if</span> <span class="n">augment_data</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3541"><a href="#prepare_cellpose_dataset-3541"><span class="linenos">3541</span></a>                <span class="n">needed</span> <span class="o">=</span> <span class="n">target_size</span> <span class="o">-</span> <span class="n">dataset_len</span>
</span><span id="prepare_cellpose_dataset-3542"><a href="#prepare_cellpose_dataset-3542"><span class="linenos">3542</span></a>                <span class="n">aug_methods</span> <span class="o">=</span> <span class="n">get_augmentations</span><span class="p">()</span>
</span><span id="prepare_cellpose_dataset-3543"><a href="#prepare_cellpose_dataset-3543"><span class="linenos">3543</span></a>                <span class="n">full_loops</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3544"><a href="#prepare_cellpose_dataset-3544"><span class="linenos">3544</span></a>                <span class="n">extra</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3545"><a href="#prepare_cellpose_dataset-3545"><span class="linenos">3545</span></a>
</span><span id="prepare_cellpose_dataset-3546"><a href="#prepare_cellpose_dataset-3546"><span class="linenos">3546</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full_loops</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3547"><a href="#prepare_cellpose_dataset-3547"><span class="linenos">3547</span></a>                    <span class="k">for</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">),</span> <span class="n">aug</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">aug_methods</span> <span class="o">*</span> <span class="p">(</span><span class="n">dataset_len</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">))):</span>
</span><span id="prepare_cellpose_dataset-3548"><a href="#prepare_cellpose_dataset-3548"><span class="linenos">3548</span></a>                        <span class="n">sampled_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span><span class="p">))</span>
</span><span id="prepare_cellpose_dataset-3549"><a href="#prepare_cellpose_dataset-3549"><span class="linenos">3549</span></a>                <span class="k">if</span> <span class="n">extra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3550"><a href="#prepare_cellpose_dataset-3550"><span class="linenos">3550</span></a>                    <span class="n">subset</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pairs</span> <span class="o">*</span> <span class="p">((</span><span class="n">extra</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">aug_methods</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">extra</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3551"><a href="#prepare_cellpose_dataset-3551"><span class="linenos">3551</span></a>                    <span class="k">for</span> <span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">),</span> <span class="n">aug</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">aug_methods</span><span class="p">[:</span><span class="n">extra</span><span class="p">]):</span>
</span><span id="prepare_cellpose_dataset-3552"><a href="#prepare_cellpose_dataset-3552"><span class="linenos">3552</span></a>                        <span class="n">sampled_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span><span class="p">))</span>
</span><span id="prepare_cellpose_dataset-3553"><a href="#prepare_cellpose_dataset-3553"><span class="linenos">3553</span></a>
</span><span id="prepare_cellpose_dataset-3554"><a href="#prepare_cellpose_dataset-3554"><span class="linenos">3554</span></a>        <span class="c1"># Add &quot;no augmentation&quot; tag to original files</span>
</span><span id="prepare_cellpose_dataset-3555"><a href="#prepare_cellpose_dataset-3555"><span class="linenos">3555</span></a>        <span class="n">augmented_sampled</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="prepare_cellpose_dataset-3556"><a href="#prepare_cellpose_dataset-3556"><span class="linenos">3556</span></a>            <span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">tup</span>
</span><span id="prepare_cellpose_dataset-3557"><a href="#prepare_cellpose_dataset-3557"><span class="linenos">3557</span></a>            <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">sampled_pairs</span>
</span><span id="prepare_cellpose_dataset-3558"><a href="#prepare_cellpose_dataset-3558"><span class="linenos">3558</span></a>        <span class="p">]</span>
</span><span id="prepare_cellpose_dataset-3559"><a href="#prepare_cellpose_dataset-3559"><span class="linenos">3559</span></a>
</span><span id="prepare_cellpose_dataset-3560"><a href="#prepare_cellpose_dataset-3560"><span class="linenos">3560</span></a>        <span class="c1"># --- Step 2: Split into train/test ---</span>
</span><span id="prepare_cellpose_dataset-3561"><a href="#prepare_cellpose_dataset-3561"><span class="linenos">3561</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">augmented_sampled</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3562"><a href="#prepare_cellpose_dataset-3562"><span class="linenos">3562</span></a>        <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_fraction</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">augmented_sampled</span><span class="p">))</span>
</span><span id="prepare_cellpose_dataset-3563"><a href="#prepare_cellpose_dataset-3563"><span class="linenos">3563</span></a>        <span class="n">split_sets</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="prepare_cellpose_dataset-3564"><a href="#prepare_cellpose_dataset-3564"><span class="linenos">3564</span></a>            <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">augmented_sampled</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span>
</span><span id="prepare_cellpose_dataset-3565"><a href="#prepare_cellpose_dataset-3565"><span class="linenos">3565</span></a>            <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">augmented_sampled</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
</span><span id="prepare_cellpose_dataset-3566"><a href="#prepare_cellpose_dataset-3566"><span class="linenos">3566</span></a>        <span class="p">}</span>
</span><span id="prepare_cellpose_dataset-3567"><a href="#prepare_cellpose_dataset-3567"><span class="linenos">3567</span></a>
</span><span id="prepare_cellpose_dataset-3568"><a href="#prepare_cellpose_dataset-3568"><span class="linenos">3568</span></a>        <span class="k">for</span> <span class="n">subset</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">split_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="prepare_cellpose_dataset-3569"><a href="#prepare_cellpose_dataset-3569"><span class="linenos">3569</span></a>            <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">msk_path</span><span class="p">,</span> <span class="n">aug</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3570"><a href="#prepare_cellpose_dataset-3570"><span class="linenos">3570</span></a>                <span class="n">dst_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3571"><a href="#prepare_cellpose_dataset-3571"><span class="linenos">3571</span></a>                <span class="n">dst_msk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_root</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">global_index</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3572"><a href="#prepare_cellpose_dataset-3572"><span class="linenos">3572</span></a>                <span class="n">instructions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="prepare_cellpose_dataset-3573"><a href="#prepare_cellpose_dataset-3573"><span class="linenos">3573</span></a>                    <span class="s2">&quot;src_img&quot;</span><span class="p">:</span> <span class="n">img_path</span><span class="p">,</span>
</span><span id="prepare_cellpose_dataset-3574"><a href="#prepare_cellpose_dataset-3574"><span class="linenos">3574</span></a>                    <span class="s2">&quot;src_msk&quot;</span><span class="p">:</span> <span class="n">msk_path</span><span class="p">,</span>
</span><span id="prepare_cellpose_dataset-3575"><a href="#prepare_cellpose_dataset-3575"><span class="linenos">3575</span></a>                    <span class="s2">&quot;dst_img&quot;</span><span class="p">:</span> <span class="n">dst_img</span><span class="p">,</span>
</span><span id="prepare_cellpose_dataset-3576"><a href="#prepare_cellpose_dataset-3576"><span class="linenos">3576</span></a>                    <span class="s2">&quot;dst_msk&quot;</span><span class="p">:</span> <span class="n">dst_msk</span><span class="p">,</span>
</span><span id="prepare_cellpose_dataset-3577"><a href="#prepare_cellpose_dataset-3577"><span class="linenos">3577</span></a>                    <span class="s2">&quot;augment&quot;</span><span class="p">:</span> <span class="n">aug</span>
</span><span id="prepare_cellpose_dataset-3578"><a href="#prepare_cellpose_dataset-3578"><span class="linenos">3578</span></a>                <span class="p">})</span>
</span><span id="prepare_cellpose_dataset-3579"><a href="#prepare_cellpose_dataset-3579"><span class="linenos">3579</span></a>                <span class="n">global_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="prepare_cellpose_dataset-3580"><a href="#prepare_cellpose_dataset-3580"><span class="linenos">3580</span></a>
</span><span id="prepare_cellpose_dataset-3581"><a href="#prepare_cellpose_dataset-3581"><span class="linenos">3581</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total files to process: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3582"><a href="#prepare_cellpose_dataset-3582"><span class="linenos">3582</span></a>
</span><span id="prepare_cellpose_dataset-3583"><a href="#prepare_cellpose_dataset-3583"><span class="linenos">3583</span></a>    <span class="c1"># --- Step 3: Process with multiprocessing ---</span>
</span><span id="prepare_cellpose_dataset-3584"><a href="#prepare_cellpose_dataset-3584"><span class="linenos">3584</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing images with multiprocessing...&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3585"><a href="#prepare_cellpose_dataset-3585"><span class="linenos">3585</span></a>    
</span><span id="prepare_cellpose_dataset-3586"><a href="#prepare_cellpose_dataset-3586"><span class="linenos">3586</span></a>    <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3587"><a href="#prepare_cellpose_dataset-3587"><span class="linenos">3587</span></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3588"><a href="#prepare_cellpose_dataset-3588"><span class="linenos">3588</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3589"><a href="#prepare_cellpose_dataset-3589"><span class="linenos">3589</span></a>        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3590"><a href="#prepare_cellpose_dataset-3590"><span class="linenos">3590</span></a>        
</span><span id="prepare_cellpose_dataset-3591"><a href="#prepare_cellpose_dataset-3591"><span class="linenos">3591</span></a>    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span><span id="prepare_cellpose_dataset-3592"><a href="#prepare_cellpose_dataset-3592"><span class="linenos">3592</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">process_instruction</span><span class="p">,</span> <span class="n">instructions</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="prepare_cellpose_dataset-3593"><a href="#prepare_cellpose_dataset-3593"><span class="linenos">3593</span></a>            <span class="n">print_progress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">),</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;cellpose dataset&quot;</span><span class="p">)</span>
</span><span id="prepare_cellpose_dataset-3594"><a href="#prepare_cellpose_dataset-3594"><span class="linenos">3594</span></a>
</span><span id="prepare_cellpose_dataset-3595"><a href="#prepare_cellpose_dataset-3595"><span class="linenos">3595</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done. Dataset saved to: </span><span class="si">{</span><span class="n">output_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>