<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spacr.sequencing &mdash; spacr 0.2.56 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=aa0fc99b"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            spacr
          </a>
              <div class="version">
                0.2.56
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">spacr</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spacr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spacr.sequencing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spacr.sequencing</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">pairwise2</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.regression.mixed_linear_model</span> <span class="kn">import</span> <span class="n">MixedLM</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gmean</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">SequenceMatcher</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">rapidfuzz</span> <span class="kn">import</span> <span class="n">process</span><span class="p">,</span> <span class="n">fuzz</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span><span class="p">,</span> <span class="n">MinMaxScaler</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">shapiro</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="kn">import</span> <span class="n">dmatrices</span>

<span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">SeqIO</span>
<span class="kn">from</span> <span class="nn">Bio.Seq</span> <span class="kn">import</span> <span class="n">Seq</span>
<span class="kn">from</span> <span class="nn">Bio.SeqRecord</span> <span class="kn">import</span> <span class="n">SeqRecord</span>

<div class="viewcode-block" id="parse_gz_files">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.parse_gz_files">[docs]</a>
<span class="k">def</span> <span class="nf">parse_gz_files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the .fastq.gz files in the specified folder path and returns a dictionary</span>
<span class="sd">    containing the sample names and their corresponding file paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): The path to the folder containing the .fastq.gz files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where the keys are the sample names and the values are</span>
<span class="sd">        dictionaries containing the file paths for the &#39;R1&#39; and &#39;R2&#39; read directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="n">gz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fastq.gz&#39;</span><span class="p">)]</span>

    <span class="n">samples_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gz_file</span> <span class="ow">in</span> <span class="n">gz_files</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">gz_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">sample_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">read_direction</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">samples_dict</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R1&quot;</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples_dict</span></div>


<div class="viewcode-block" id="process_chunk_for_consensus">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.process_chunk_for_consensus">[docs]</a>
<span class="k">def</span> <span class="nf">process_chunk_for_consensus</span><span class="p">(</span><span class="n">r1_chunk</span><span class="p">,</span> <span class="n">r2_chunk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a chunk of paired-end sequencing reads to generate consensus sequences.</span>

<span class="sd">    Args:</span>
<span class="sd">        r1_chunk (list): List of SeqRecord objects representing the first read in each pair.</span>
<span class="sd">        r2_chunk (list): List of SeqRecord objects representing the second read in each pair.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of SeqRecord objects representing the consensus sequences.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">consensus_records</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">r1_record</span><span class="p">,</span> <span class="n">r2_record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1_chunk</span><span class="p">,</span> <span class="n">r2_chunk</span><span class="p">):</span>
        <span class="n">best_sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">best_quality</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">base1</span><span class="p">,</span> <span class="n">base2</span><span class="p">,</span> <span class="n">qual1</span><span class="p">,</span> <span class="n">qual2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1_record</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">r2_record</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">r1_record</span><span class="o">.</span><span class="n">letter_annotations</span><span class="p">[</span><span class="s2">&quot;phred_quality&quot;</span><span class="p">],</span> <span class="n">r2_record</span><span class="o">.</span><span class="n">letter_annotations</span><span class="p">[</span><span class="s2">&quot;phred_quality&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">qual1</span> <span class="o">&gt;=</span> <span class="n">qual2</span><span class="p">:</span>
                <span class="n">best_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base1</span><span class="p">)</span>
                <span class="n">best_quality</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qual1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base2</span><span class="p">)</span>
                <span class="n">best_quality</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qual2</span><span class="p">)</span>

        <span class="n">consensus_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_sequence</span><span class="p">))</span>
        
        <span class="c1"># Create a new SeqRecord for the consensus sequence</span>
        <span class="n">consensus_record</span> <span class="o">=</span> <span class="n">SeqRecord</span><span class="p">(</span><span class="n">consensus_seq</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">r1_record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">letter_annotations</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;phred_quality&quot;</span><span class="p">:</span> <span class="n">best_quality</span><span class="p">})</span>
        
        <span class="c1"># Add the consensus record to the list</span>
        <span class="n">consensus_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">consensus_record</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">consensus_records</span></div>


<div class="viewcode-block" id="consensus_sequence">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.consensus_sequence">[docs]</a>
<span class="k">def</span> <span class="nf">consensus_sequence</span><span class="p">(</span><span class="n">fastq_r1</span><span class="p">,</span> <span class="n">fastq_r2</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the consensus sequence from two FASTQ files (R1 and R2) and write the result to an output file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - fastq_r1 (str): Path to the R1 FASTQ file.</span>
<span class="sd">    - fastq_r2 (str): Path to the R2 FASTQ file.</span>
<span class="sd">    - output_file (str): Path to the output file where the consensus sequence will be written.</span>
<span class="sd">    - chunk_size (int): Number of reads to process in each chunk. Default is 1000000.</span>
<span class="sd">    - n_jobs (int): Number of parallel processes to use. If None, it will use the number of available CPUs minus 2.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span><span class="p">,</span> <span class="n">count_reads_in_fastq</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating read count for </span><span class="si">{</span><span class="n">fastq_r1</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="n">total_reads</span> <span class="o">=</span> <span class="n">count_reads_in_fastq</span><span class="p">(</span><span class="n">fastq_r1</span><span class="p">)</span>
    <span class="n">chunks_nr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">total_reads</span> <span class="o">/</span> <span class="n">chunk_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="k">else</span> <span class="n">cpu_count</span><span class="p">())</span>

    <span class="n">total_reads_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq_r1</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r1_handle</span><span class="p">,</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq_r2</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r2_handle</span><span class="p">,</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_handle</span><span class="p">:</span>
        <span class="n">r1_iter</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">r1_handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
        <span class="n">r2_iter</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">r2_handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">r1_chunk</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">r1_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">))</span> <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">r2_chunk</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">r2_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">))</span> <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            
            <span class="c1"># If either chunk is empty, we have reached the end of one or both files</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r1_chunk</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r2_chunk</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">chunk_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total_reads_processed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1_chunk</span><span class="p">)</span>
            
            <span class="c1"># Split the records into chunks to be processed by each core</span>
            <span class="n">r1_chunked</span> <span class="o">=</span> <span class="p">[</span><span class="n">r1_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1_chunk</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>
            <span class="n">r2_chunked</span> <span class="o">=</span> <span class="p">[</span><span class="n">r2_chunk</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">r2_chunk</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

            <span class="c1"># Process each chunk in parallel</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">process_chunk_for_consensus</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1_chunked</span><span class="p">,</span> <span class="n">r2_chunked</span><span class="p">))</span>
            
            <span class="c1"># Write the results to the output file</span>
            <span class="k">for</span> <span class="n">consensus_records</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">consensus_records</span><span class="p">,</span> <span class="n">output_handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>

            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">chunk_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_time</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="o">=</span><span class="n">chunk_count</span><span class="p">,</span> <span class="n">files_to_process</span><span class="o">=</span><span class="n">chunks_nr</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot; Consensus sequence from R1 &amp; R2&quot;</span><span class="p">)</span>

        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<div class="viewcode-block" id="consensus_sequence_v1">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.consensus_sequence_v1">[docs]</a>
<span class="k">def</span> <span class="nf">consensus_sequence_v1</span><span class="p">(</span><span class="n">fastq_r1</span><span class="p">,</span> <span class="n">fastq_r2</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a consensus sequence from paired-end FASTQ files.</span>

<span class="sd">    Args:</span>
<span class="sd">        fastq_r1 (str): Path to the first input FASTQ file.</span>
<span class="sd">        fastq_r2 (str): Path to the second input FASTQ file.</span>
<span class="sd">        output_file (str): Path to the output FASTQ file.</span>
<span class="sd">        chunk_size (int, optional): Number of reads to process in each iteration. Defaults to 1000000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span><span class="p">,</span> <span class="n">count_reads_in_fastq</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating read count for </span><span class="si">{</span><span class="n">fastq_r1</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="n">total_reads</span> <span class="o">=</span> <span class="n">count_reads_in_fastq</span><span class="p">(</span><span class="n">fastq_r1</span><span class="p">)</span>
    <span class="n">chunks_nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_reads</span><span class="o">/</span><span class="n">chunk_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">total_reads</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq_r1</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r1_handle</span><span class="p">,</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq_r2</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r2_handle</span><span class="p">,</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_handle</span><span class="p">:</span>
        <span class="n">r1_iter</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">r1_handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
        <span class="n">r2_iter</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">r2_handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">r1_chunk</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">r1_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">))</span> <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">r2_chunk</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">r2_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">))</span> <span class="k">if</span> <span class="n">rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            
            <span class="c1"># If either chunk is empty, we have reached the end of one or both files</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r1_chunk</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r2_chunk</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="n">chunk_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">total_reads</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r1_chunk</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">r1_record</span><span class="p">,</span> <span class="n">r2_record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1_chunk</span><span class="p">,</span> <span class="n">r2_chunk</span><span class="p">):</span>
                <span class="n">best_sequence</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">best_quality</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">base1</span><span class="p">,</span> <span class="n">base2</span><span class="p">,</span> <span class="n">qual1</span><span class="p">,</span> <span class="n">qual2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r1_record</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">r2_record</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">r1_record</span><span class="o">.</span><span class="n">letter_annotations</span><span class="p">[</span><span class="s2">&quot;phred_quality&quot;</span><span class="p">],</span> <span class="n">r2_record</span><span class="o">.</span><span class="n">letter_annotations</span><span class="p">[</span><span class="s2">&quot;phred_quality&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">qual1</span> <span class="o">&gt;=</span> <span class="n">qual2</span><span class="p">:</span>
                        <span class="n">best_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base1</span><span class="p">)</span>
                        <span class="n">best_quality</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qual1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">best_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base2</span><span class="p">)</span>
                        <span class="n">best_quality</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qual2</span><span class="p">)</span>
                
                <span class="n">consensus_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_sequence</span><span class="p">))</span>
                
                <span class="c1"># Create a new SeqRecord for the consensus sequence</span>
                <span class="n">consensus_record</span> <span class="o">=</span> <span class="n">SeqRecord</span><span class="p">(</span><span class="n">consensus_seq</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">r1_record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">letter_annotations</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;phred_quality&quot;</span><span class="p">:</span> <span class="n">best_quality</span><span class="p">})</span>
                
                <span class="c1"># Write the consensus sequence to the output file</span>
                <span class="n">SeqIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">consensus_record</span><span class="p">,</span> <span class="n">output_handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
            
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">chunk_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_time</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="o">=</span><span class="n">chunk_count</span><span class="p">,</span> <span class="n">files_to_process</span><span class="o">=</span><span class="n">chunks_nr</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot; Consensus sequence from R1 &amp; R2&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_to_hdf">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.save_to_hdf">[docs]</a>
<span class="k">def</span> <span class="nf">save_to_hdf</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save data from a queue to an HDF file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - queue: Queue object</span>
<span class="sd">        The queue containing the data to be saved.</span>
<span class="sd">    - output_file: strs</span>
<span class="sd">        The path to the output HDF file.</span>
<span class="sd">    - complevel: int, optional</span>
<span class="sd">        The compression level to use (default is 9).</span>
<span class="sd">    - compression: str, optional</span>
<span class="sd">        The compression algorithm to use (default is &#39;zlib&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span> <span class="k">as</span> <span class="n">store</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk_count</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing chunks to H5PY ...&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chunk_</span><span class="si">{</span><span class="n">chunk_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">data_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_top_two_matches">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.get_top_two_matches">[docs]</a>
<span class="k">def</span> <span class="nf">get_top_two_matches</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">barcode_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the top two closest matches for a given sequence in a barcode dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        seq (str): The sequence to find the closest matches for.</span>
<span class="sd">        barcode_dict (dict): A dictionary containing barcodes as keys and their corresponding values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of tuples: A list containing up to two tuples, each with a barcode match and its score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">barcode_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">scorer</span><span class="o">=</span><span class="n">fuzz</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[(</span><span class="n">barcode_dict</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="c1"># Pad the matches list if there are fewer than two results</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">matches</span></div>


<div class="viewcode-block" id="process_chunk_for_mapping">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.process_chunk_for_mapping">[docs]</a>
<span class="k">def</span> <span class="nf">process_chunk_for_mapping</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">barcode_mapping</span><span class="p">,</span> <span class="n">barcode_dicts</span><span class="p">,</span> <span class="n">barcode_coordinates</span><span class="p">,</span> <span class="n">reverse_complements</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a chunk of records for barcode mapping, including highest and second-highest scores.</span>

<span class="sd">    Args:</span>
<span class="sd">        records (list): A list of records to process.</span>
<span class="sd">        barcode_mapping (dict): A dictionary mapping barcodes to their corresponding keys.</span>
<span class="sd">        barcode_dicts (dict): A dictionary of barcode dictionaries.</span>
<span class="sd">        barcode_coordinates (dict): A dictionary mapping barcode keys to their start and end coordinates.</span>
<span class="sd">        reverse_complements (dict): A dictionary indicating whether to reverse complement the extracted sequences for each barcode key.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: A DataFrame containing the processed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">barcode_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">seq_data</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_seq&quot;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">barcode_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">score_data_1</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_1&quot;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">barcode_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">score_data_2</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_2&quot;</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">barcode_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">barcode_coordinates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">coord</span>
            <span class="n">extracted_seq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">reverse_complements</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">extracted_seq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Seq</span><span class="p">(</span><span class="n">extracted_seq</span><span class="p">)</span><span class="o">.</span><span class="n">reverse_complement</span><span class="p">())</span>

            <span class="n">seq_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_seq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_seq</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">barcode_dicts</span><span class="p">:</span>
                <span class="n">exact_match</span> <span class="o">=</span> <span class="n">barcode_dicts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extracted_seq</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exact_match</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exact_match</span><span class="p">)</span>
                    <span class="n">score_data_1</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">score_data_2</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">get_top_two_matches</span><span class="p">(</span><span class="n">extracted_seq</span><span class="p">,</span> <span class="n">barcode_dicts</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">score_data_1</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">score_data_2</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_seq</span><span class="p">)</span>
                <span class="n">score_data_1</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">score_data_2</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_score_2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">df_seq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seq_data</span><span class="p">)</span>
    <span class="n">df_score_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">score_data_1</span><span class="p">)</span>
    <span class="n">df_score_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">score_data_2</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequences</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_seq</span><span class="p">,</span> <span class="n">df_score_1</span><span class="p">,</span> <span class="n">df_score_2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="extract_barcodes_from_fastq">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.extract_barcodes_from_fastq">[docs]</a>
<span class="k">def</span> <span class="nf">extract_barcodes_from_fastq</span><span class="p">(</span><span class="n">fastq</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">barcode_mapping</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts barcodes from a FASTQ file and maps them based on a barcode mapping.</span>

<span class="sd">    Args:</span>
<span class="sd">        fastq (str): Path to the input FASTQ file.</span>
<span class="sd">        output_file (str): Path to the output file where the mapped barcodes will be saved.</span>
<span class="sd">        chunk_size (int): Number of records to process in each chunk.</span>
<span class="sd">        barcode_mapping (dict): Dictionary containing barcode mapping information.</span>
<span class="sd">            The keys are the names of the barcode sets, and the values are tuples</span>
<span class="sd">            containing the path to the CSV file, barcode coordinates, and reverse complement flag.</span>
<span class="sd">        n_jobs (int, optional): Number of parallel processes to use for mapping. Defaults to None.</span>
<span class="sd">        compression (str, optional): Compression algorithm to use for saving the output file. Defaults to &#39;zlib&#39;.</span>
<span class="sd">        complevel (int, optional): Compression level to use for saving the output file. Defaults to 9.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span><span class="p">,</span> <span class="n">count_reads_in_fastq</span>

    <span class="c1"># Ensure the file is deleted before starting</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

    <span class="c1"># Validate and process barcode mapping</span>
    <span class="n">barcode_dicts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">barcode_coordinates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">reverse_complements</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">reverse_comp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">barcode_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;sequence&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: CSV file </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2"> does not have required columns &#39;name&#39; and &#39;sequence&#39;. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">barcode_dicts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">barcode_coordinates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span>
        <span class="n">reverse_complements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse_comp</span>

    <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">3</span>  <span class="c1"># Reserve one core for saving</span>
    
    <span class="n">analyzed_chunks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating read count for </span><span class="si">{</span><span class="n">fastq</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="n">total_reads</span> <span class="o">=</span> <span class="n">count_reads_in_fastq</span><span class="p">(</span><span class="n">fastq</span><span class="p">)</span>
    <span class="n">chunks_nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_reads</span><span class="o">/</span><span class="n">chunk_size</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mapping barcodes for </span><span class="si">{</span><span class="n">total_reads</span><span class="si">}</span><span class="s1"> reads in </span><span class="si">{</span><span class="n">chunks_nr</span><span class="si">}</span><span class="s1"> batches for </span><span class="si">{</span><span class="n">fastq</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create a queue to hold dataframes to be saved</span>
    <span class="n">save_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="c1"># Start a separate process for saving the data</span>
    <span class="n">save_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">save_to_hdf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">save_queue</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">complevel</span><span class="p">,</span> <span class="n">compression</span><span class="p">))</span>
    <span class="n">save_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">fastq_iter</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Read n_jobs * chunk_size records into memory</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">),</span> <span class="n">fastq_iter</span><span class="p">)]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">analyzed_chunks_1</span> <span class="o">=</span> <span class="n">analyzed_chunks</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">chunk_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">analyzed_chunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_count</span><span class="o">*</span><span class="n">n_jobs</span><span class="p">)</span>
            <span class="n">analyzed_chunks_ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">analyzed_chunks_1</span><span class="p">,</span> <span class="n">analyzed_chunks</span><span class="p">))</span>

            <span class="c1"># Split the records into chunks to be processed by each core</span>
            <span class="n">chunked_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">records</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

            <span class="c1"># Process each chunk in parallel</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">process_chunk_for_mapping</span><span class="p">,</span> <span class="p">[(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">barcode_mapping</span><span class="p">,</span> <span class="n">barcode_dicts</span><span class="p">,</span> <span class="n">barcode_coordinates</span><span class="p">,</span> <span class="n">reverse_complements</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunked_records</span><span class="p">])</span>

            <span class="c1"># Queue the dataframes to be saved</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">save_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">chunk_count</span><span class="p">,</span> <span class="n">df</span><span class="p">))</span>

            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">chunk_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_time</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">az_chunks</span> <span class="ow">in</span> <span class="n">analyzed_chunks_ls</span><span class="p">:</span>
                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="o">=</span><span class="n">az_chunks</span><span class="p">,</span> <span class="n">files_to_process</span><span class="o">=</span><span class="n">chunks_nr</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot; Mapping Barcodes&quot;</span><span class="p">)</span>

            <span class="k">del</span> <span class="n">records</span><span class="p">,</span> <span class="n">chunked_records</span><span class="p">,</span> <span class="n">dfs</span><span class="p">,</span> <span class="n">df</span>

        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="c1"># Send a sentinel value to indicate the saving process should stop</span>
    <span class="n">save_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">save_process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<div class="viewcode-block" id="extract_barcodes_from_fastq_v1">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.extract_barcodes_from_fastq_v1">[docs]</a>
<span class="k">def</span> <span class="nf">extract_barcodes_from_fastq_v1</span><span class="p">(</span><span class="n">fastq</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">barcode_mapping</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zlib&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts barcodes from a FASTQ file and saves the results to an output file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - fastq (str): Path to the input FASTQ file.</span>
<span class="sd">    - output_file (str): Path to the output file where the barcode data will be saved.</span>
<span class="sd">    - chunk_size (int): Number of records to process in each chunk.</span>
<span class="sd">    - barcode_mapping (dict): Mapping of barcode keys to CSV file paths, barcode coordinates, and reverse complement flags.</span>
<span class="sd">    - n_jobs (int, optional): Number of parallel processes to use for barcode mapping. Defaults to None.</span>
<span class="sd">    - compression (str, optional): Compression algorithm to use for the output file. Defaults to &#39;zlib&#39;.</span>
<span class="sd">    - complevel (int, optional): Compression level to use for the output file. Defaults to 9.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span><span class="p">,</span> <span class="n">count_reads_in_fastq</span>

    <span class="c1"># Ensure the file is deleted before starting</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

    <span class="c1"># Validate and process barcode mapping</span>
    <span class="n">barcode_dicts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">barcode_coordinates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">reverse_complements</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">reverse_comp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">barcode_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;sequence&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: CSV file </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2"> does not have required columns &#39;name&#39; and &#39;sequence&#39;. Aborting.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">barcode_dicts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">barcode_coordinates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span>
        <span class="n">reverse_complements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse_comp</span>

    <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span>

    <span class="n">chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating read count for </span><span class="si">{</span><span class="n">fastq</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="n">total_reads</span> <span class="o">=</span> <span class="n">count_reads_in_fastq</span><span class="p">(</span><span class="n">fastq</span><span class="p">)</span>
    <span class="n">chunks_nr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">total_reads</span><span class="o">/</span><span class="n">chunk_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> 
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mapping barcodes for </span><span class="si">{</span><span class="n">total_reads</span><span class="si">}</span><span class="s1"> reads in </span><span class="si">{</span><span class="n">chunks_nr</span><span class="si">}</span><span class="s1"> batches for </span><span class="si">{</span><span class="n">fastq</span><span class="si">}</span><span class="s1"> ...&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fastq</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">fastq_iter</span> <span class="o">=</span> <span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;fastq&quot;</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Read n_jobs * chunk_size records into memory</span>
            <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">),</span> <span class="n">fastq_iter</span><span class="p">)]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">chunk_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Split the records into chunks to be processed by each core</span>
            <span class="n">chunked_records</span> <span class="o">=</span> <span class="p">[</span><span class="n">records</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>

            <span class="c1"># Process each chunk in parallel</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">process_chunk_for_mapping</span><span class="p">,</span> <span class="p">[(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">barcode_mapping</span><span class="p">,</span> <span class="n">barcode_dicts</span><span class="p">,</span> <span class="n">barcode_coordinates</span><span class="p">,</span> <span class="n">reverse_complements</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunked_records</span><span class="p">])</span>

            <span class="c1"># Join the results</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Save to HDF5 with compression</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing chunk </span><span class="si">{</span><span class="n">chunk_count</span><span class="si">}</span><span class="s1"> to H5PY ...&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;chunk_</span><span class="si">{</span><span class="n">chunk_count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">complevel</span><span class="o">=</span><span class="n">complevel</span><span class="p">,</span> <span class="n">complib</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span>

            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">chunk_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_time</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="o">=</span><span class="n">chunk_count</span><span class="p">,</span> <span class="n">files_to_process</span><span class="o">=</span><span class="n">chunks_nr</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot; Mapping Barcodes&quot;</span><span class="p">)</span>

            <span class="k">del</span> <span class="n">records</span><span class="p">,</span> <span class="n">chunked_records</span><span class="p">,</span> <span class="n">dfs</span><span class="p">,</span> <span class="n">df</span>

        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


<div class="viewcode-block" id="generate_barecode_mapping">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.generate_barecode_mapping">[docs]</a>
<span class="k">def</span> <span class="nf">generate_barecode_mapping</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_default_generate_barecode_mapping</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_default_generate_barecode_mapping</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">samples_dict</span> <span class="o">=</span> <span class="n">parse_gz_files</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">samples_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">samples_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">samples_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]:</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">samples_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span>
            <span class="n">R2</span> <span class="o">=</span> <span class="n">samples_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span>
            <span class="n">consensus_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">R1</span><span class="p">),</span> <span class="s1">&#39;consensus&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">consensus_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">consensus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">consensus_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_consensus.fastq.gz&quot;</span><span class="p">)</span>
            <span class="n">h5</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">consensus_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_barecodes.h5&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">consensus</span><span class="p">):</span>
                <span class="n">consensus_sequence</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">consensus</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;chunk_size&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Consensus file </span><span class="si">{</span><span class="n">consensus</span><span class="si">}</span><span class="s2"> already exists. Mapping barecodes.&quot;</span><span class="p">)</span>

            <span class="n">extract_barcodes_from_fastq</span><span class="p">(</span><span class="n">fastq</span><span class="o">=</span><span class="n">consensus</span><span class="p">,</span>
                                        <span class="n">output_file</span><span class="o">=</span><span class="n">h5</span><span class="p">,</span>
                                        <span class="n">chunk_size</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;chunk_size&#39;</span><span class="p">],</span>
                                        <span class="n">barcode_mapping</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;barcode_mapping&#39;</span><span class="p">],</span>
                                        <span class="n">n_jobs</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;n_jobs&#39;</span><span class="p">],</span>
                                        <span class="n">compression</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;compression&#39;</span><span class="p">],</span>
                                        <span class="n">complevel</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;complevel&#39;</span><span class="p">])</span></div>





















<div class="viewcode-block" id="grna_plate_heatmap">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.grna_plate_heatmap">[docs]</a>
<span class="k">def</span> <span class="nf">grna_plate_heatmap</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">specific_grna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a heatmap of gRNA plate data.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The path to the CSV file containing the gRNA plate data.</span>
<span class="sd">        specific_grna (str, optional): The specific gRNA to filter the data for. Defaults to None.</span>
<span class="sd">        min_max (str or list or tuple, optional): The range of values to use for the color scale. </span>
<span class="sd">            If &#39;all&#39;, the range will be determined by the minimum and maximum values in the data.</span>
<span class="sd">            If &#39;allq&#39;, the range will be determined by the 2nd and 98th percentiles of the data.</span>
<span class="sd">            If a list or tuple of two values, the range will be determined by those values.</span>
<span class="sd">            Defaults to &#39;all&#39;.</span>
<span class="sd">        cmap (str, optional): The colormap to use for the heatmap. Defaults to &#39;viridis&#39;.</span>
<span class="sd">        min_count (int, optional): The minimum count threshold for including a gRNA in the heatmap. </span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        save (bool, optional): Whether to save the heatmap as a PDF file. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        matplotlib.figure.Figure: The generated heatmap figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">def</span> <span class="nf">generate_grna_plate_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plate_number</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">min_count</span><span class="p">,</span> <span class="n">specific_grna</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Work on a copy to avoid SettingWithCopyWarning</span>
        
        <span class="c1"># Filtering the dataframe based on the plate_number and specific gRNA if provided</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">plate_number</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">specific_grna</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">specific_grna</span><span class="p">]</span>

        <span class="c1"># Split plate_row into plate and row</span>
        <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Ensure proper ordering</span>
        <span class="n">row_order</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;r</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">)]</span>
        <span class="n">col_order</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;c</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">)]</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">row_order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">col_order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Group by row and column, summing counts</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">plate_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;column&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_map</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">plate_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
        <span class="k">elif</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;allq&#39;</span><span class="p">:</span>
            <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">plate_map</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_max</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">float</span><span class="p">)):</span>
                <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">plate_map</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">)):</span> 
                <span class="n">min_max</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">plate_map</span><span class="p">,</span> <span class="n">min_max</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">plates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plates</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">plate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plates</span><span class="p">):</span>
        <span class="n">plate_map</span><span class="p">,</span> <span class="n">min_max_values</span> <span class="o">=</span> <span class="n">generate_grna_plate_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">min_count</span><span class="p">,</span> <span class="n">specific_grna</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">plate_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">min_max_values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">min_max_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plate</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plates</span><span class="p">),</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
    <span class="c1"># Save the figure</span>
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specific_grna</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">specific_grna</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.pdf&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;saved </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="reverse_complement">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.reverse_complement">[docs]</a>
<span class="k">def</span> <span class="nf">reverse_complement</span><span class="p">(</span><span class="n">dna_sequence</span><span class="p">):</span>
    <span class="n">complement_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="s1">&#39;N&#39;</span><span class="p">}</span>
    <span class="n">reverse_seq</span> <span class="o">=</span> <span class="n">dna_sequence</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">reverse_complement_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">complement_dict</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">reverse_seq</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">reverse_complement_seq</span></div>


<div class="viewcode-block" id="complement">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.complement">[docs]</a>
<span class="k">def</span> <span class="nf">complement</span><span class="p">(</span><span class="n">dna_sequence</span><span class="p">):</span>
    <span class="n">complement_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="s1">&#39;N&#39;</span><span class="p">}</span>
    <span class="n">complement_seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">complement_dict</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">dna_sequence</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">complement_seq</span></div>


<div class="viewcode-block" id="file_len">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.file_len">[docs]</a>
<span class="k">def</span> <span class="nf">file_len</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;wc&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="generate_plate_heatmap">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.generate_plate_heatmap">[docs]</a>
<span class="k">def</span> <span class="nf">generate_plate_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">plate_number</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">min_max</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">]:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>  
        <span class="n">min_max</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">])]</span>   
    <span class="k">if</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;allq&#39;</span><span class="p">:</span>
        <span class="n">min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">variable</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>
    <span class="n">plate</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">plate_number</span><span class="p">]</span>
    <span class="n">plate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">plate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grouping</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">]:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;col&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">variable</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">min_max</span> <span class="o">==</span> <span class="s1">&#39;plate&#39;</span><span class="p">:</span>
        <span class="n">min_max</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">plate</span><span class="p">[</span><span class="n">variable</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">plate</span><span class="p">[</span><span class="n">variable</span><span class="p">])]</span>
    <span class="n">plate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">plate</span><span class="p">)</span>
    <span class="n">plate</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;plate&#39;</span> <span class="ow">in</span> <span class="n">plate</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="n">plate</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pcol</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">prow</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">new_col</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pcol</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">new_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">new_col</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;c15&#39;</span><span class="p">)</span>
    <span class="n">new_row</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prow</span><span class="p">:</span>
        <span class="n">ro</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">new_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ro</span><span class="p">)</span>
    <span class="n">plate_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_col</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">new_row</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">plate</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">plate_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
    <span class="n">plate_map</span> <span class="o">=</span> <span class="n">plate_map</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">plate_map</span><span class="p">),</span> <span class="n">min_max</span></div>


<div class="viewcode-block" id="plot_plates">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.plot_plates">[docs]</a>
<span class="k">def</span> <span class="nf">plot_plates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">grouping</span><span class="p">,</span> <span class="n">min_max</span><span class="p">,</span> <span class="n">cmap</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">plates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">next</span>
    <span class="c1">#plates = np.unique(df[&#39;plate&#39;], return_counts=False)</span>
    <span class="n">nr_of_plates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plates</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nr_of_plates:&#39;</span><span class="p">,</span><span class="n">nr_of_plates</span><span class="p">)</span>
    <span class="c1"># Calculate the number of rows and columns for the subplot grid</span>
    <span class="k">if</span> <span class="n">nr_of_plates</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">nr_of_plates</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
        <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">nr_of_plates</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]:</span>
        <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">nr_of_plates</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">]:</span>
        <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span>

    <span class="c1"># Create the subplot grid with the specified number of rows and columns</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">))</span>

    <span class="c1"># Flatten the axes array to a one-dimensional array</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Loop over each plate and plot the heatmap</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">plate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plates</span><span class="p">):</span>
        <span class="n">plate_number</span> <span class="o">=</span> <span class="n">plate</span>
        <span class="n">plate_map</span><span class="p">,</span> <span class="n">min_max</span> <span class="o">=</span> <span class="n">generate_plate_heatmap</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">plate_number</span><span class="o">=</span><span class="n">plate_number</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="n">grouping</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="n">min_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plate_number:&#39;</span><span class="p">,</span><span class="n">plate_number</span><span class="p">,</span><span class="s1">&#39;minimum:&#39;</span><span class="p">,</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;maximum:&#39;</span><span class="p">,</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Plot the heatmap on the appropriate subplot</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">plate_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plate_number</span><span class="p">)</span>

    <span class="c1"># Remove any empty subplots</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_of_plates</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="c1"># Adjust the spacing between the subplots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Show the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="count_mismatches">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.count_mismatches">[docs]</a>
<span class="k">def</span> <span class="nf">count_mismatches</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">align_length</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">pairwise2</span><span class="o">.</span><span class="n">align</span><span class="o">.</span><span class="n">globalxx</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">)</span>
    <span class="c1"># choose the first alignment (there might be several with the same score)</span>
    <span class="n">alignment</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># alignment is a tuple (seq1_aligned, seq2_aligned, score, begin, end)</span>
    <span class="n">seq1_aligned</span><span class="p">,</span> <span class="n">seq2_aligned</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">alignment</span>
    <span class="c1"># Determine the start of alignment (first position where at least align_length bases are the same)</span>
    <span class="n">start_of_alignment</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq1_aligned</span><span class="p">)</span> <span class="o">-</span> <span class="n">align_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> 
                              <span class="k">if</span> <span class="n">seq1_aligned</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">align_length</span><span class="p">]</span> <span class="o">==</span> <span class="n">seq2_aligned</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">align_length</span><span class="p">])</span>
    <span class="c1"># Trim the sequences to the same length from the start of the alignment</span>
    <span class="n">seq1_aligned</span> <span class="o">=</span> <span class="n">seq1_aligned</span><span class="p">[</span><span class="n">start_of_alignment</span><span class="p">:]</span>
    <span class="n">seq2_aligned</span> <span class="o">=</span> <span class="n">seq2_aligned</span><span class="p">[</span><span class="n">start_of_alignment</span><span class="p">:]</span>
    <span class="c1"># Trim the sequences to be of the same length (from the end)</span>
    <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq1_aligned</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq2_aligned</span><span class="p">))</span>
    <span class="n">seq1_aligned</span> <span class="o">=</span> <span class="n">seq1_aligned</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
    <span class="n">seq2_aligned</span> <span class="o">=</span> <span class="n">seq2_aligned</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
    <span class="n">mismatches</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c1</span> <span class="o">!=</span> <span class="n">c2</span> <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">seq1_aligned</span><span class="p">,</span> <span class="n">seq2_aligned</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mismatches</span></div>

    
<div class="viewcode-block" id="get_sequence_data">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.get_sequence_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_sequence_data</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">):</span>
    <span class="n">forward_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(...GGTGCCACTT)TTTCAAGTTG.*?TTCTAGCTCT(AAAAC[A-Z]{18,22}AACTT)GACATCCCCA.*?AAGGCAAACA(CCCCCTTCGG....).*&#39;</span><span class="p">)</span> 
    <span class="n">r1fd</span> <span class="o">=</span> <span class="n">forward_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
    <span class="n">reverce_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(...CCGAAGGGGG)TGTTTGCCTT.*?TGGGGATGTC(AAGTT[A-Z]{18,22}GTTTT)AGAGCTAGAA.*?CAACTTGAAA(AAGTGGCACC...).*&#39;</span><span class="p">)</span> 
    <span class="n">r2fd</span> <span class="o">=</span> <span class="n">reverce_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
    <span class="n">rc_r1</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
    <span class="n">rc_r2</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span> 
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">r1fd</span><span class="p">,</span> <span class="n">r2fd</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r1_mis_matches</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">count_mismatches</span><span class="p">(</span><span class="n">seq1</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">seq2</span><span class="o">=</span><span class="n">rc_r2</span><span class="p">,</span> <span class="n">align_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">r2_mis_matches</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">count_mismatches</span><span class="p">(</span><span class="n">seq1</span><span class="o">=</span><span class="n">r2</span><span class="p">,</span> <span class="n">seq2</span><span class="o">=</span><span class="n">rc_r1</span><span class="p">,</span> <span class="n">align_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r1_mis_matches</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">r2_mis_matches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">column_r1</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">r1fd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sgrna_r1</span> <span class="o">=</span> <span class="n">r1fd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">platerow_r1</span> <span class="o">=</span> <span class="n">r1fd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">column_r2</span> <span class="o">=</span> <span class="n">r2fd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">sgrna_r2</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">r2fd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">platerow_r2</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">r2fd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;N&#39;</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r1_plate_row&#39;</span><span class="p">:</span><span class="n">platerow_r1</span><span class="p">,</span>
                     <span class="s1">&#39;r1_col&#39;</span><span class="p">:</span><span class="n">column_r1</span><span class="p">,</span>
                     <span class="s1">&#39;r1_gRNA&#39;</span><span class="p">:</span><span class="n">sgrna_r1</span><span class="p">,</span>
                     <span class="s1">&#39;r1_read&#39;</span><span class="p">:</span><span class="n">r1</span><span class="p">,</span>
                     <span class="s1">&#39;r2_plate_row&#39;</span><span class="p">:</span><span class="n">platerow_r2</span><span class="p">,</span>
                     <span class="s1">&#39;r2_col&#39;</span><span class="p">:</span><span class="n">column_r2</span><span class="p">,</span>
                     <span class="s1">&#39;r2_gRNA&#39;</span><span class="p">:</span><span class="n">sgrna_r2</span><span class="p">,</span>
                     <span class="s1">&#39;r2_read&#39;</span><span class="p">:</span><span class="n">r2</span><span class="p">,</span>
                     <span class="s1">&#39;r1_r2_rc_mismatch&#39;</span><span class="p">:</span><span class="n">r1_mis_matches</span><span class="p">,</span>
                     <span class="s1">&#39;r2_r1_rc_mismatch&#39;</span><span class="p">:</span><span class="n">r2_mis_matches</span><span class="p">,</span>
                     <span class="s1">&#39;r1_len&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">),</span>
                     <span class="s1">&#39;r2_len&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r1_mis_matches</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">count_mismatches</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">rc_r2</span><span class="p">,</span> <span class="n">align_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">r2_mis_matches</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">count_mismatches</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">rc_r1</span><span class="p">,</span> <span class="n">align_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">r1_mis_matches</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">r2_mis_matches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;r1_plate_row&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;r1_col&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;r1_gRNA&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;r1_read&#39;</span><span class="p">:</span><span class="n">r1</span><span class="p">,</span>
             <span class="s1">&#39;r2_plate_row&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;r2_col&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;r2_gRNA&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
             <span class="s1">&#39;r2_read&#39;</span><span class="p">:</span><span class="n">r2</span><span class="p">,</span>
             <span class="s1">&#39;r1_r2_rc_mismatch&#39;</span><span class="p">:</span><span class="n">r1_mis_matches</span><span class="p">,</span>
             <span class="s1">&#39;r2_r1_rc_mismatch&#39;</span><span class="p">:</span><span class="n">r2_mis_matches</span><span class="p">,</span>
             <span class="s1">&#39;r1_len&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">),</span>
             <span class="s1">&#39;r2_len&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">)}</span>

    <span class="k">return</span> <span class="n">data_dict</span></div>


<span class="k">def</span> <span class="nf">get_read_data</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="c1"># The first part contains the instrument, run number, flowcell ID, lane, tile, and coordinates</span>
        <span class="n">instrument</span><span class="p">,</span> <span class="n">run_number</span><span class="p">,</span> <span class="n">flowcell_id</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="c1"># The second part contains the read number, filter status, control number, and sample number</span>
        <span class="n">read</span><span class="p">,</span> <span class="n">is_filtered</span><span class="p">,</span> <span class="n">control_number</span><span class="p">,</span> <span class="n">sample_number</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">rund_data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instrument&#39;</span><span class="p">:</span><span class="n">instrument</span><span class="p">,</span> 
                          <span class="s1">&#39;run_number&#39;</span><span class="p">:</span><span class="n">run_number</span><span class="p">,</span> 
                          <span class="s1">&#39;flowcell_id&#39;</span><span class="p">:</span><span class="n">flowcell_id</span><span class="p">,</span> 
                          <span class="s1">&#39;lane&#39;</span><span class="p">:</span><span class="n">lane</span><span class="p">,</span> 
                          <span class="s1">&#39;tile&#39;</span><span class="p">:</span><span class="n">tile</span><span class="p">,</span> 
                          <span class="s1">&#39;x_pos&#39;</span><span class="p">:</span><span class="n">x_pos</span><span class="p">,</span> 
                          <span class="s1">&#39;y_pos&#39;</span><span class="p">:</span><span class="n">y_pos</span><span class="p">,</span> 
                          <span class="s1">&#39;read&#39;</span><span class="p">:</span><span class="n">read</span><span class="p">,</span> 
                          <span class="s1">&#39;is_filtered&#39;</span><span class="p">:</span><span class="n">is_filtered</span><span class="p">,</span> 
                          <span class="s1">&#39;control_number&#39;</span><span class="p">:</span><span class="n">control_number</span><span class="p">,</span> 
                          <span class="s1">&#39;sample_number&#39;</span><span class="p">:</span><span class="n">sample_number</span><span class="p">}</span>
        <span class="n">modified_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rund_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">modified_dict</span>

<div class="viewcode-block" id="pos_dict">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.pos_dict">[docs]</a>
<span class="k">def</span> <span class="nf">pos_dict</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="n">pos_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pos_dict</span><span class="p">:</span>
            <span class="n">pos_dict</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos_dict</span><span class="p">[</span><span class="n">char</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pos_dict</span></div>


<div class="viewcode-block" id="truncate_read">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.truncate_read">[docs]</a>
<span class="k">def</span> <span class="nf">truncate_read</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span><span class="n">qual</span><span class="p">,</span><span class="n">target</span><span class="p">):</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># If the sequence is found</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">-</span><span class="mi">3</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
            <span class="n">qual</span> <span class="o">=</span> <span class="n">qual</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">seq</span><span class="p">,</span> <span class="n">qual</span></div>


<div class="viewcode-block" id="equalize_lengths">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.equalize_lengths">[docs]</a>
<span class="k">def</span> <span class="nf">equalize_lengths</span><span class="p">(</span><span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">pad_char</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">):</span>
    <span class="n">len_diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">len_diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># seq1 is longer</span>
        <span class="n">seq2</span> <span class="o">+=</span> <span class="n">pad_char</span> <span class="o">*</span> <span class="n">len_diff</span>  <span class="c1"># pad seq2 with &#39;N&#39;s</span>
    <span class="k">elif</span> <span class="n">len_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># seq2 is longer</span>
        <span class="n">seq1</span> <span class="o">+=</span> <span class="n">pad_char</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">len_diff</span><span class="p">)</span>  <span class="c1"># pad seq1 with &#39;N&#39;s</span>

    <span class="k">return</span> <span class="n">seq1</span><span class="p">,</span> <span class="n">seq2</span></div>


<div class="viewcode-block" id="get_read_data">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.get_read_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_read_data</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">identifier</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="c1"># The first part contains the instrument, run number, flowcell ID, lane, tile, and coordinates</span>
        <span class="n">instrument</span><span class="p">,</span> <span class="n">run_number</span><span class="p">,</span> <span class="n">flowcell_id</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="c1"># The second part contains the read number, filter status, control number, and sample number</span>
        <span class="n">read</span><span class="p">,</span> <span class="n">is_filtered</span><span class="p">,</span> <span class="n">control_number</span><span class="p">,</span> <span class="n">sample_number</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">rund_data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instrument&#39;</span><span class="p">:</span><span class="n">instrument</span><span class="p">,</span> 
                          <span class="s1">&#39;x_pos&#39;</span><span class="p">:</span><span class="n">x_pos</span><span class="p">,</span> 
                          <span class="s1">&#39;y_pos&#39;</span><span class="p">:</span><span class="n">y_pos</span><span class="p">}</span>
        <span class="n">modified_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rund_data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">modified_dict</span></div>


<div class="viewcode-block" id="extract_barecodes">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.extract_barecodes">[docs]</a>
<span class="k">def</span> <span class="nf">extract_barecodes</span><span class="p">(</span><span class="n">r1_fastq</span><span class="p">,</span> <span class="n">r2_fastq</span><span class="p">,</span> <span class="n">csv_loc</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">data_chunk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Open both FASTQ files.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">r1_fastq</span><span class="p">)</span> <span class="k">as</span> <span class="n">r1_file</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">r2_fastq</span><span class="p">)</span> <span class="k">as</span> <span class="n">r2_file</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">save_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># Read 4 lines at a time</span>
            <span class="n">r1_identifier</span> <span class="o">=</span> <span class="n">r1_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r1_sequence</span> <span class="o">=</span> <span class="n">r1_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r1_plus</span> <span class="o">=</span> <span class="n">r1_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r1_quality</span> <span class="o">=</span> <span class="n">r1_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r2_identifier</span> <span class="o">=</span> <span class="n">r2_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r2_sequence</span> <span class="o">=</span> <span class="n">r2_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r2_sequence</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">r2_sequence</span><span class="p">)</span>
            <span class="n">r2_sequence</span> <span class="o">=</span> <span class="n">r2_sequence</span>
            <span class="n">r2_plus</span> <span class="o">=</span> <span class="n">r2_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r2_quality</span> <span class="o">=</span> <span class="n">r2_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">r2_quality</span> <span class="o">=</span> <span class="n">r2_quality</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r1_identifier</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r2_identifier</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1">#if index &gt; 100:</span>
            <span class="c1">#    break</span>
            <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;GGTGCCACTT&#39;</span>
            <span class="n">r1_sequence</span><span class="p">,</span> <span class="n">r1_quality</span> <span class="o">=</span> <span class="n">truncate_read</span><span class="p">(</span><span class="n">r1_sequence</span><span class="p">,</span> <span class="n">r1_quality</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">r2_sequence</span><span class="p">,</span> <span class="n">r2_quality</span> <span class="o">=</span> <span class="n">truncate_read</span><span class="p">(</span><span class="n">r2_sequence</span><span class="p">,</span> <span class="n">r2_quality</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">r1_sequence</span><span class="p">,</span> <span class="n">r2_sequence</span> <span class="o">=</span> <span class="n">equalize_lengths</span><span class="p">(</span><span class="n">r1_sequence</span><span class="p">,</span> <span class="n">r2_sequence</span><span class="p">,</span> <span class="n">pad_char</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
            <span class="n">r1_quality</span><span class="p">,</span> <span class="n">r2_quality</span> <span class="o">=</span> <span class="n">equalize_lengths</span><span class="p">(</span><span class="n">r1_quality</span><span class="p">,</span> <span class="n">r2_quality</span><span class="p">,</span> <span class="n">pad_char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">alignments</span> <span class="o">=</span> <span class="n">pairwise2</span><span class="o">.</span><span class="n">align</span><span class="o">.</span><span class="n">globalxx</span><span class="p">(</span><span class="n">r1_sequence</span><span class="p">,</span> <span class="n">r2_sequence</span><span class="p">)</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">alignment</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">platerow</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">grna</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="mi">125</span><span class="p">:</span>
                <span class="n">aligned_r1</span> <span class="o">=</span> <span class="n">alignment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aligned_r2</span> <span class="o">=</span> <span class="n">alignment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">position_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="n">base1</span><span class="p">,</span> <span class="n">base2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">base1</span><span class="p">,</span> <span class="n">base2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aligned_r1</span><span class="p">,</span> <span class="n">aligned_r2</span><span class="p">))}</span>
                <span class="n">phred_quality1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">r1_quality</span><span class="p">]</span>
                <span class="n">phred_quality2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">r2_quality</span><span class="p">]</span>
                <span class="n">r1_q_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">quality</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">quality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phred_quality1</span><span class="p">)}</span>
                <span class="n">r2_q_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">quality</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">quality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phred_quality2</span><span class="p">)}</span>
                <span class="n">read</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">position_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">position_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">r1_q_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">r2_q_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                        <span class="n">read</span> <span class="o">=</span> <span class="n">read</span> <span class="o">+</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">position_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">r2_q_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r1_q_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
                        <span class="n">read</span> <span class="o">=</span> <span class="n">read</span> <span class="o">+</span> <span class="n">position_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(...GGTGC)CACTT.*GCTCT(TAAAC[A-Z]{18,22}AACTT)GACAT.*CCCCC(TTCGG....).*&#39;</span><span class="p">)</span>
                <span class="n">regex_patterns</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">regex_patterns</span><span class="p">]):</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="n">regex_patterns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">grna</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">regex_patterns</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">platerow</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">regex_patterns</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mi">125</span><span class="p">:</span>
                <span class="n">read</span> <span class="o">=</span> <span class="n">r1_sequence</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(...GGTGC)CACTT.*GCTCT(TAAAC[A-Z]{18,22}AACTT)GACAT.*CCCCC(TTCGG....).*&#39;</span><span class="p">)</span>
                <span class="n">regex_patterns</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">regex_patterns</span><span class="p">]):</span>
                    <span class="n">column</span> <span class="o">=</span> <span class="n">regex_patterns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">grna</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">regex_patterns</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">platerow</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">regex_patterns</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="c1">#print(&#39;2&#39;, platerow)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;read&#39;</span><span class="p">:</span><span class="n">read</span><span class="p">,</span><span class="s1">&#39;column&#39;</span><span class="p">:</span><span class="n">column</span><span class="p">,</span><span class="s1">&#39;platerow&#39;</span><span class="p">:</span><span class="n">platerow</span><span class="p">,</span><span class="s1">&#39;grna&#39;</span><span class="p">:</span><span class="n">grna</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span><span class="n">score</span><span class="p">}</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grna&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">r1_rund_data_dict</span> <span class="o">=</span> <span class="n">get_read_data</span><span class="p">(</span><span class="n">r1_identifier</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;r1_&#39;</span><span class="p">)</span>
                <span class="n">r2_rund_data_dict</span> <span class="o">=</span> <span class="n">get_read_data</span><span class="p">(</span><span class="n">r2_identifier</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;r2_&#39;</span><span class="p">)</span>
                <span class="n">r1_rund_data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">r2_rund_data_dict</span><span class="p">)</span>
                <span class="n">r1_rund_data_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
                <span class="n">r1_rund_data_dict</span><span class="p">[</span><span class="s1">&#39;r1_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1_quality</span>
                <span class="n">r1_rund_data_dict</span><span class="p">[</span><span class="s1">&#39;r2_quality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r2_quality</span>
                <span class="n">data_chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r1_rund_data_dict</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processed reads: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> Found barecodes in </span><span class="si">{</span><span class="n">save_index</span><span class="si">}</span><span class="s1"> Time/read: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">save_index</span> <span class="o">%</span> <span class="n">chunk_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Every `chunk_size` reads, write to the CSV</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">csv_loc</span><span class="p">):</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_chunk</span><span class="p">)</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_chunk</span><span class="p">)</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_loc</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">data_chunk</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Clear the chunk</span></div>

                    
<div class="viewcode-block" id="split_fastq">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.split_fastq">[docs]</a>
<span class="k">def</span> <span class="nf">split_fastq</span><span class="p">(</span><span class="n">input_fastq</span><span class="p">,</span> <span class="n">output_base</span><span class="p">,</span> <span class="n">num_files</span><span class="p">):</span>
    <span class="c1"># Create file objects for each output file</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_files</span><span class="p">)]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_fastq</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Initialize a counter for the lines</span>
        <span class="n">line_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Determine the output file</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">line_counter</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">%</span> <span class="n">num_files</span><span class="p">]</span>
            <span class="c1"># Write the line to the appropriate output file</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c1"># Increment the line counter</span>
            <span class="n">line_counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Close output files</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="process_barecodes">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.process_barecodes">[docs]</a>
<span class="k">def</span> <span class="nf">process_barecodes</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==== Preprocessing barecodes ====&#39;</span><span class="p">)</span>
    <span class="n">plate_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row_ls</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">column_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grna_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">read_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">score_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">match_score_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">print_every</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">r1_instrument</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r1_instrument&#39;</span><span class="p">]</span>
        <span class="n">r1_x_pos</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r1_x_pos&#39;</span><span class="p">]</span>
        <span class="n">r1_y_pos</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r1_y_pos&#39;</span><span class="p">]</span>
        <span class="n">r2_instrument</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r2_instrument&#39;</span><span class="p">]</span>
        <span class="n">r2_x_pos</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r2_x_pos&#39;</span><span class="p">]</span>
        <span class="n">r2_y_pos</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r2_y_pos&#39;</span><span class="p">]</span>
        <span class="n">read</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
        <span class="n">column</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span>
        <span class="n">platerow</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;platerow&#39;</span><span class="p">]</span>
        <span class="n">grna</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span>
        <span class="n">score</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
        <span class="n">r1_quality</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r1_quality&#39;</span><span class="p">]</span>
        <span class="n">r2_quality</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;r2_quality&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">r1_x_pos</span> <span class="o">==</span> <span class="n">r2_x_pos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r1_y_pos</span> <span class="o">==</span> <span class="n">r2_y_pos</span><span class="p">:</span>
                <span class="n">match_score</span> <span class="o">=</span> <span class="mi">0</span>
                
                <span class="k">if</span> <span class="n">grna</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AAGTT&#39;</span><span class="p">):</span>
                    <span class="n">match_score</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;GGTGC&#39;</span><span class="p">):</span>
                    <span class="n">match_score</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">platerow</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;CCGAA&#39;</span><span class="p">):</span>
                    <span class="n">match_score</span> <span class="o">+=</span> <span class="mf">0.5</span>
                <span class="n">index_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">match_score_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match_score</span><span class="p">)</span>
                <span class="n">score_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">read_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
                <span class="n">plate_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">platerow</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">row_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">platerow</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">column_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">grna_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grna</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="n">print_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processed reads: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_ls</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_ls</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;match_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_score_ls</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plate_ls</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_ls</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_ls</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grna_ls</span>
    <span class="n">df_high_score</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">125</span><span class="p">]</span>
    <span class="n">df_low_score</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">125</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_high_score</span><span class="p">)</span><span class="si">}</span><span class="s1"> high score reads;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_low_score</span><span class="p">)</span><span class="si">}</span><span class="s1"> low score reads&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_high_score</span><span class="p">,</span> <span class="n">df_low_score</span></div>


<div class="viewcode-block" id="find_grna">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.find_grna">[docs]</a>
<span class="k">def</span> <span class="nf">find_grna</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">grna_df</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==== Finding gRNAs ====&#39;</span><span class="p">)</span>
    <span class="n">seqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
    <span class="n">seq_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grna_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">print_every</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="k">for</span> <span class="n">grna</span> <span class="ow">in</span> <span class="n">grna_df</span><span class="o">.</span><span class="n">Seq</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">reverse_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*(</span><span class="si">{}</span><span class="s1">).*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grna</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="n">print_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processed reads: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">found_grna</span> <span class="o">=</span> <span class="n">reverse_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">found_grna</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">seq_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="n">grna_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_grna</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">grna_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_grna</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">grna_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">seq_ls</span><span class="p">,</span> <span class="n">grna_ls</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">grna_seq</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">grna_dict</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="map_unmapped_grnas">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.map_unmapped_grnas">[docs]</a>
<span class="k">def</span> <span class="nf">map_unmapped_grnas</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==== Mapping lost gRNA barecodes ====&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">similar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SequenceMatcher</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">ratio</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">print_every</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">sequence_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna_seq&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">grna_error</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna_seq&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">grna_error</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">similarity_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#change this so that it itterates throug each well</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">match_string</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">sequence_list</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="n">print_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processed reads: </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">similar</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">],</span> <span class="n">string</span><span class="p">)</span>
            <span class="c1"># check if only one character is different</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">])):</span>
                <span class="n">matches</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">matches</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># if we find more than one match, we break and don&#39;t add anything to the dictionary</span>
                    <span class="k">break</span>
                <span class="n">match_string</span> <span class="o">=</span> <span class="n">string</span>
        <span class="k">if</span> <span class="n">matches</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># only add to the dictionary if there was exactly one match</span>
            <span class="n">similarity_dict</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">match_string</span>
    <span class="k">return</span> <span class="n">similarity_dict</span></div>


<div class="viewcode-block" id="translate_barecodes">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.translate_barecodes">[docs]</a>
<span class="k">def</span> <span class="nf">translate_barecodes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">grna_df</span><span class="p">,</span> <span class="n">map_unmapped</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==== Translating barecodes ====&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">map_unmapped</span><span class="p">:</span>
        <span class="n">similarity_dict</span> <span class="o">=</span> <span class="n">map_unmapped_grnas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">seq</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">similarity_dict</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">])[</span><span class="s1">&#39;grna_seq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">grna_dict</span> <span class="o">=</span> <span class="n">grna_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Seq&#39;</span><span class="p">)[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    
    <span class="n">plate_barcodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AA&#39;</span><span class="p">:</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span><span class="s1">&#39;TT&#39;</span><span class="p">:</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span><span class="s1">&#39;CC&#39;</span><span class="p">:</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span><span class="s1">&#39;GG&#39;</span><span class="p">:</span><span class="s1">&#39;p4&#39;</span><span class="p">,</span><span class="s1">&#39;AT&#39;</span><span class="p">:</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span><span class="s1">&#39;TA&#39;</span><span class="p">:</span><span class="s1">&#39;p6&#39;</span><span class="p">,</span><span class="s1">&#39;CG&#39;</span><span class="p">:</span><span class="s1">&#39;p7&#39;</span><span class="p">,</span><span class="s1">&#39;GC&#39;</span><span class="p">:</span><span class="s1">&#39;p8&#39;</span><span class="p">}</span>
    
    <span class="n">row_barcodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AA&#39;</span><span class="p">:</span><span class="s1">&#39;r1&#39;</span><span class="p">,</span><span class="s1">&#39;AT&#39;</span><span class="p">:</span><span class="s1">&#39;r2&#39;</span><span class="p">,</span><span class="s1">&#39;AC&#39;</span><span class="p">:</span><span class="s1">&#39;r3&#39;</span><span class="p">,</span><span class="s1">&#39;AG&#39;</span><span class="p">:</span><span class="s1">&#39;r4&#39;</span><span class="p">,</span><span class="s1">&#39;TT&#39;</span><span class="p">:</span><span class="s1">&#39;r5&#39;</span><span class="p">,</span><span class="s1">&#39;TA&#39;</span><span class="p">:</span><span class="s1">&#39;r6&#39;</span><span class="p">,</span><span class="s1">&#39;TC&#39;</span><span class="p">:</span><span class="s1">&#39;r7&#39;</span><span class="p">,</span><span class="s1">&#39;TG&#39;</span><span class="p">:</span><span class="s1">&#39;r8&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CC&#39;</span><span class="p">:</span><span class="s1">&#39;r9&#39;</span><span class="p">,</span><span class="s1">&#39;CA&#39;</span><span class="p">:</span><span class="s1">&#39;r10&#39;</span><span class="p">,</span><span class="s1">&#39;CT&#39;</span><span class="p">:</span><span class="s1">&#39;r11&#39;</span><span class="p">,</span><span class="s1">&#39;CG&#39;</span><span class="p">:</span><span class="s1">&#39;r12&#39;</span><span class="p">,</span><span class="s1">&#39;GG&#39;</span><span class="p">:</span><span class="s1">&#39;r13&#39;</span><span class="p">,</span><span class="s1">&#39;GA&#39;</span><span class="p">:</span><span class="s1">&#39;r14&#39;</span><span class="p">,</span><span class="s1">&#39;GT&#39;</span><span class="p">:</span><span class="s1">&#39;r15&#39;</span><span class="p">,</span><span class="s1">&#39;GC&#39;</span><span class="p">:</span><span class="s1">&#39;r16&#39;</span><span class="p">}</span>
    
    <span class="n">col_barcodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AAA&#39;</span><span class="p">:</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;TTT&#39;</span><span class="p">:</span><span class="s1">&#39;c2&#39;</span><span class="p">,</span><span class="s1">&#39;CCC&#39;</span><span class="p">:</span><span class="s1">&#39;c3&#39;</span><span class="p">,</span><span class="s1">&#39;GGG&#39;</span><span class="p">:</span><span class="s1">&#39;c4&#39;</span><span class="p">,</span><span class="s1">&#39;AAT&#39;</span><span class="p">:</span><span class="s1">&#39;c5&#39;</span><span class="p">,</span><span class="s1">&#39;AAC&#39;</span><span class="p">:</span><span class="s1">&#39;c6&#39;</span><span class="p">,</span><span class="s1">&#39;AAG&#39;</span><span class="p">:</span><span class="s1">&#39;c7&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TTA&#39;</span><span class="p">:</span><span class="s1">&#39;c8&#39;</span><span class="p">,</span><span class="s1">&#39;TTC&#39;</span><span class="p">:</span><span class="s1">&#39;c9&#39;</span><span class="p">,</span><span class="s1">&#39;TTG&#39;</span><span class="p">:</span><span class="s1">&#39;c10&#39;</span><span class="p">,</span><span class="s1">&#39;CCA&#39;</span><span class="p">:</span><span class="s1">&#39;c11&#39;</span><span class="p">,</span><span class="s1">&#39;CCT&#39;</span><span class="p">:</span><span class="s1">&#39;c12&#39;</span><span class="p">,</span><span class="s1">&#39;CCG&#39;</span><span class="p">:</span><span class="s1">&#39;c13&#39;</span><span class="p">,</span><span class="s1">&#39;GGA&#39;</span><span class="p">:</span><span class="s1">&#39;c14&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;CCT&#39;</span><span class="p">:</span><span class="s1">&#39;c15&#39;</span><span class="p">,</span><span class="s1">&#39;GGC&#39;</span><span class="p">:</span><span class="s1">&#39;c16&#39;</span><span class="p">,</span><span class="s1">&#39;ATT&#39;</span><span class="p">:</span><span class="s1">&#39;c17&#39;</span><span class="p">,</span><span class="s1">&#39;ACC&#39;</span><span class="p">:</span><span class="s1">&#39;c18&#39;</span><span class="p">,</span><span class="s1">&#39;AGG&#39;</span><span class="p">:</span><span class="s1">&#39;c19&#39;</span><span class="p">,</span><span class="s1">&#39;TAA&#39;</span><span class="p">:</span><span class="s1">&#39;c20&#39;</span><span class="p">,</span><span class="s1">&#39;TCC&#39;</span><span class="p">:</span><span class="s1">&#39;c21&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TGG&#39;</span><span class="p">:</span><span class="s1">&#39;c22&#39;</span><span class="p">,</span><span class="s1">&#39;CAA&#39;</span><span class="p">:</span><span class="s1">&#39;c23&#39;</span><span class="p">,</span><span class="s1">&#39;CGG&#39;</span><span class="p">:</span><span class="s1">&#39;c24&#39;</span><span class="p">}</span>

    
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plate_barcodes</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">row_barcodes</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">col_barcodes</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna_seq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">grna_dict</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">error_count</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plate_error</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">row_error</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">col_error</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">grna_error</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matched: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s1"> rows; Errors: plate:</span><span class="si">{</span><span class="n">plate_error</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">% row:</span><span class="si">{</span><span class="n">row_error</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">% column:</span><span class="si">{</span><span class="n">col_error</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">% gRNA:</span><span class="si">{</span><span class="n">grna_error</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="vert_horiz">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.vert_horiz">[docs]</a>
<span class="k">def</span> <span class="nf">vert_horiz</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">n_col</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n_col</span><span class="p">)]:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">,</span><span class="n">h</span></div>

                                            
<div class="viewcode-block" id="plot_data">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.plot_data">[docs]</a>
<span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">log_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x_axis</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">y_axis</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_axis</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">log_x</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log_y</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span><span class="n">vert_horiz</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">n_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="n">h</span>  </div>


<div class="viewcode-block" id="test_error">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.test_error">[docs]</a>
<span class="k">def</span> <span class="nf">test_error</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">max_</span><span class="o">=</span><span class="mi">3025</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">max_</span> <span class="o">=</span> <span class="n">max_</span><span class="o">+</span><span class="n">min_</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">min_</span><span class="p">)</span>
    <span class="n">plate_error_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">col_error_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row_error_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grna_error_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prc_error_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_error_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">temp_len_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum_count&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metric</span><span class="o">==</span><span class="s1">&#39;fraction&#39;</span><span class="p">:</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_</span><span class="p">,</span> <span class="n">max_</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">metric</span><span class="o">==</span><span class="s1">&#39;count&#39;</span><span class="p">:</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min_</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">max_</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">&gt;</span><span class="n">val</span><span class="p">])</span>
        <span class="n">temp_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">temp_len_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_len</span><span class="p">)</span>
        <span class="n">error_count</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">plate_error</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">temp_len</span>
        <span class="n">row_error</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">temp_len</span>
        <span class="n">col_error</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">temp_len</span>
        <span class="n">prc_error</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">temp_len</span>
        <span class="n">grna_error</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">temp_len</span>
        <span class="c1">#print(error_count, plate_error, row_error, col_error, prc_error, grna_error)</span>
        <span class="n">val_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">total_error_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_count</span><span class="p">)</span>
        <span class="n">plate_error_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plate_error</span><span class="p">)</span>
        <span class="n">row_error_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_error</span><span class="p">)</span>
        <span class="n">col_error_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_error</span><span class="p">)</span>
        <span class="n">prc_error_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prc_error</span><span class="p">)</span>
        <span class="n">grna_error_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grna_error</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plate_error_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_error_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_error_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;gRNA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grna_error_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prc_error_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_error_ls</span>
    <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_len_ls</span>
                                 
    <span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lw</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;teal&#39;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_row</span><span class="p">,</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_col</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_row</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span>
    
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;gRNA&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df2</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="n">n_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;len&#39;</span><span class="p">,</span><span class="n">log_x</span><span class="o">=</span><span class="n">log_x</span><span class="p">,</span> <span class="n">log_y</span><span class="o">=</span><span class="n">log_y</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="generate_fraction_map">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.generate_fraction_map">[docs]</a>
<span class="k">def</span> <span class="nf">generate_fraction_map</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">gene_column</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">plates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span><span class="s1">&#39;p4&#39;</span><span class="p">],</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prcs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna_seq&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">min_</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">plates</span><span class="p">)]</span>
    <span class="n">gRNA_well_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;prcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_well_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gRNA_well_count</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_well_count&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_well_count&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">well_sum</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;well_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">well_sum</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;well_sum&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;fraction&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_fraction&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">min_</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">plates</span><span class="p">)]</span>
        <span class="n">gRNA_well_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;prcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;nunique&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_well_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gRNA_well_count</span>
        <span class="n">well_sum</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;well_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">well_sum</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gRNA_fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;well_sum&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;gRNAs/well&#39;</span><span class="p">)</span>
        <span class="n">plot_plates</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;gRNA_well_count&#39;</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="s1">&#39;allq&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;well read sum&#39;</span><span class="p">)</span>
        <span class="n">plot_plates</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;well_sum&#39;</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="s1">&#39;allq&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">genes</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">gene_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">wells</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numer of genes:&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">),</span><span class="s1">&#39;numer of wells:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">))</span>
    <span class="n">independent_variables</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">genes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">wells</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">prc</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span>
        <span class="n">gene</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">gene_column</span><span class="p">]</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;gRNA_fraction&#39;</span><span class="p">]</span>
        <span class="n">independent_variables</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prc</span><span class="p">,</span><span class="n">gene</span><span class="p">]</span><span class="o">=</span><span class="n">fraction</span>
    <span class="n">independent_variables</span> <span class="o">=</span> <span class="n">independent_variables</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">independent_variables</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">independent_variables</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">independent_variables</span> <span class="o">=</span> <span class="n">independent_variables</span><span class="p">[</span><span class="n">independent_variables</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">==</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">independent_variables</span> <span class="o">=</span> <span class="n">independent_variables</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">independent_variables</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;prc&#39;</span>
    <span class="n">independent_variables</span> <span class="o">=</span> <span class="n">independent_variables</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">independent_variables</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">independent_variables</span></div>

    
<div class="viewcode-block" id="precess_reads">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.precess_reads">[docs]</a>
<span class="k">def</span> <span class="nf">precess_reads</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">fraction_threshold</span><span class="p">,</span> <span class="n">plate</span><span class="p">):</span>
    <span class="c1"># Read the CSV file into a DataFrame</span>
    <span class="n">csv_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>

    <span class="c1"># Ensure the necessary columns are present</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CSV file must contain &#39;grna&#39;, &#39;count&#39;, &#39;plate_row&#39;, and &#39;column&#39; columns.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;plate_row&#39;</span> <span class="ow">in</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">csv_df</span><span class="p">[[</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;plate_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">csv_df</span> <span class="o">=</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">])</span>
            <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plate</span>

    <span class="k">if</span> <span class="n">plate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plate</span>

    <span class="c1"># Create the prc column</span>
    <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">csv_df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span>

    <span class="c1"># Group by prc and calculate the sum of counts</span>
    <span class="n">grouped_df</span> <span class="o">=</span> <span class="n">csv_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">grouped_df</span> <span class="o">=</span> <span class="n">grouped_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;total_counts&#39;</span><span class="p">})</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">csv_df</span><span class="p">,</span> <span class="n">grouped_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;total_counts&#39;</span><span class="p">]</span>

    <span class="c1"># Filter rows with fraction under the threshold</span>
    <span class="k">if</span> <span class="n">fraction_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">observations_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">fraction_threshold</span><span class="p">]</span>
        <span class="n">observations_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="n">observations_before</span> <span class="o">-</span> <span class="n">observations_after</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed </span><span class="si">{</span><span class="n">removed</span><span class="si">}</span><span class="s1"> observation below fraction threshold: </span><span class="si">{</span><span class="n">fraction_threshold</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span> <span class="s1">&#39;grna&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;grna&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;org&#39;</span><span class="p">])</span>
            <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;grna&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error splitting grna into org, gene, grna.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">merged_df</span></div>


<div class="viewcode-block" id="apply_transformation">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.apply_transformation">[docs]</a>
<span class="k">def</span> <span class="nf">apply_transformation</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">transform</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span> <span class="o">==</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">:</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">transform</span> <span class="o">==</span> <span class="s1">&#39;square&#39;</span><span class="p">:</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">transformer</span></div>


<div class="viewcode-block" id="check_normality">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.check_normality">[docs]</a>
<span class="k">def</span> <span class="nf">check_normality</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the data is normally distributed using the Shapiro-Wilk test.&quot;&quot;&quot;</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">shapiro</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapiro-Wilk Test for </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">Statistic: </span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">, P-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The data for </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> is normally distributed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The data for </span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2"> is not normally distributed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="process_scores">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.process_scores">[docs]</a>
<span class="k">def</span> <span class="nf">process_scores</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dependent_variable</span><span class="p">,</span> <span class="n">plate</span><span class="p">,</span> <span class="n">min_cell_count</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">agg_type</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">regression_type</span><span class="o">=</span><span class="s1">&#39;ols&#39;</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">plate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plate</span>

    <span class="k">if</span> <span class="s1">&#39;col&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span> <span class="n">dependent_variable</span><span class="p">]]</span>

    <span class="c1"># Group by prc and calculate the mean and count of the dependent_variable</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="n">dependent_variable</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">regression_type</span> <span class="o">!=</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using agg_type: </span><span class="si">{</span><span class="n">agg_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">agg_type</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">agg_type</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">agg_type</span> <span class="o">==</span> <span class="s1">&#39;quantile&#39;</span><span class="p">:</span>
            <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">agg_type</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;prcfo&#39;</span> <span class="ow">in</span> <span class="n">dependent_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">dependent_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported aggregation type </span><span class="si">{</span><span class="n">agg_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span>
        <span class="n">agg_type</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using agg_type: </span><span class="si">{</span><span class="n">agg_type</span><span class="si">}</span><span class="s1"> for poisson regression&#39;</span><span class="p">)</span>
        <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>        
        
    <span class="c1"># Calculate cell_count for all cases</span>
    <span class="n">cell_count</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cell_count&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">agg_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dependent_df</span><span class="p">,</span> <span class="n">cell_count</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dependent_df</span><span class="p">[</span><span class="s1">&#39;cell_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_count</span><span class="p">[</span><span class="s1">&#39;cell_count&#39;</span><span class="p">]</span>

    <span class="n">dependent_df</span> <span class="o">=</span> <span class="n">dependent_df</span><span class="p">[</span><span class="n">dependent_df</span><span class="p">[</span><span class="s1">&#39;cell_count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_cell_count</span><span class="p">]</span>

    <span class="n">is_normal</span> <span class="o">=</span> <span class="n">check_normality</span><span class="p">(</span><span class="n">dependent_df</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">],</span> <span class="n">dependent_variable</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">apply_transformation</span><span class="p">(</span><span class="n">dependent_df</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">transformed_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">transform</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">dependent_variable</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">dependent_df</span><span class="p">[</span><span class="n">transformed_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dependent_df</span><span class="p">[[</span><span class="n">dependent_variable</span><span class="p">]])</span>
        <span class="n">dependent_variable</span> <span class="o">=</span> <span class="n">transformed_var</span>
        <span class="n">is_normal</span> <span class="o">=</span> <span class="n">check_normality</span><span class="p">(</span><span class="n">dependent_df</span><span class="p">[</span><span class="n">transformed_var</span><span class="p">],</span> <span class="n">transformed_var</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_normal</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dependent_variable</span><span class="si">}</span><span class="s1"> is not normally distributed&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dependent_variable</span><span class="si">}</span><span class="s1"> is normally distributed&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dependent_df</span><span class="p">,</span> <span class="n">dependent_variable</span></div>

    
<div class="viewcode-block" id="perform_mixed_model">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.perform_mixed_model">[docs]</a>
<span class="k">def</span> <span class="nf">perform_mixed_model</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="c1"># Ensure groups are defined correctly and check for multicollinearity</span>
    <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Groups must be defined for mixed model regression&quot;</span><span class="p">)</span>

    <span class="c1"># Check for multicollinearity by calculating the VIF for each feature</span>
    <span class="n">X_np</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vif</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X_np</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_np</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;VIF: </span><span class="si">{</span><span class="n">vif</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vif</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multicollinearity detected with VIF: </span><span class="si">{</span><span class="n">vif</span><span class="si">}</span><span class="s2">. Applying Ridge regression to the fixed effects.&quot;</span><span class="p">)</span>
        <span class="n">ridge</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">X_ridge</span> <span class="o">=</span> <span class="n">ridge</span><span class="o">.</span><span class="n">coef_</span> <span class="o">*</span> <span class="n">X</span>  <span class="c1"># Adjust X with Ridge coefficients</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MixedLM</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X_ridge</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MixedLM</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="regression_model">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.regression_model">[docs]</a>
<span class="k">def</span> <span class="nf">regression_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regression_type</span><span class="o">=</span><span class="s1">&#39;ols&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">remove_row_column_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;ols&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        
    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;gls&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">GLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;wls&#39;</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;rlm&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">RLM</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">robust</span><span class="o">.</span><span class="n">norms</span><span class="o">.</span><span class="n">HuberT</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="c1">#model = sm.RLM(y, X, M=sm.robust.norms.TukeyBiweight()).fit()</span>
        <span class="c1">#model = sm.RLM(y, X, M=sm.robust.norms.Hampel()).fit()</span>
        <span class="c1">#model = sm.RLM(y, X, M=sm.robust.norms.LeastSquares()).fit()</span>
        <span class="c1">#model = sm.RLM(y, X, M=sm.robust.norms.RamsayE()).fit()</span>
        <span class="c1">#model = sm.RLM(y, X, M=sm.robust.norms.TrimmedMean()).fit()</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;glm&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span> <span class="c1"># Gaussian: Used for continuous data, similar to OLS regression.</span>
        <span class="c1">#model = sm.GLM(y, X, family=sm.families.Binomial()).fit() # Binomial: Used for binary data, modeling the probability of success.</span>
        <span class="c1">#model = sm.GLM(y, X, family=sm.families.Poisson()).fit() # Poisson: Used for count data.</span>
        <span class="c1">#model = sm.GLM(y, X, family=sm.families.Gamma()).fit() # Gamma: Used for continuous, positive data, often for modeling waiting times or life data.</span>
        <span class="c1">#model = sm.GLM(y, X, family=sm.families.InverseGaussian()).fit() # Inverse Gaussian: Used for positive continuous data with a variance that increases with the </span>
        <span class="c1">#model = sm.GLM(y, X, family=sm.families.NegativeBinomial()).fit() # Negative Binomial: Used for count data with overdispersion (variance greater than the mean).</span>
        <span class="c1">#model = sm.GLM(y, X, family=sm.families.Tweedie()).fit() # Tweedie: Used for data that can take both positive continuous and count values, allowing for a mixture of distributions.</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">perform_mixed_model</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;quantile&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">QuantReg</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;logit&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Logit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;probit&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Probit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;lasso&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;ridge&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported regression type </span><span class="si">{</span><span class="n">regression_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">regression_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lasso&#39;</span><span class="p">,</span> <span class="s1">&#39;ridge&#39;</span><span class="p">]:</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Regression line&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Features&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dependent Variable&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">model</span></div>

    
<div class="viewcode-block" id="clean_controls">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.clean_controls">[docs]</a>
<span class="k">def</span> <span class="nf">clean_controls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">pc</span><span class="p">,</span><span class="n">nc</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;col&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">nc</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">pc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pc</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">other</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">other</span><span class="p">])]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed data from </span><span class="si">{</span><span class="n">nc</span><span class="p">,</span><span class="w"> </span><span class="n">pc</span><span class="p">,</span><span class="w"> </span><span class="n">other</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1"># Remove outliers by capping values at 1st and 99th percentiles for numerical columns only</span>
<div class="viewcode-block" id="remove_outliers">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.remove_outliers">[docs]</a>
<span class="k">def</span> <span class="nf">remove_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span>
    <span class="n">numerical_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">quantiles</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">numerical_cols</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numerical_cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">quantiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">quantiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="calculate_p_values">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.calculate_p_values">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_p_values</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="c1"># Predict y values</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="c1"># Calculate residuals</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span>
    
    <span class="c1"># Calculate the standard error of the residuals</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">residual_std_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">residuals</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span><span class="p">)</span>
    
    <span class="c1"># Calculate the standard error of the coefficients</span>
    <span class="n">X_design</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">X</span><span class="p">))</span>  <span class="c1"># Add intercept</span>
    
    <span class="c1"># Use pseudoinverse instead of inverse to handle singular matrices</span>
    <span class="n">coef_var_covar</span> <span class="o">=</span> <span class="n">residual_std_error</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">X_design</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X_design</span><span class="p">)</span>
    <span class="n">coef_standard_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">coef_var_covar</span><span class="p">))</span>
    
    <span class="c1"># Calculate t-statistics</span>
    <span class="n">t_stats</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span> <span class="o">/</span> <span class="n">coef_standard_errors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># Skip intercept error</span>
    
    <span class="c1"># Calculate p-values</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">dof</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_stats</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>  <span class="c1"># Ensure p_values is a 1-dimensional array</span></div>


<div class="viewcode-block" id="regression">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.regression">[docs]</a>
<span class="k">def</span> <span class="nf">regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">,</span> <span class="n">dependent_variable</span><span class="o">=</span><span class="s1">&#39;predictions&#39;</span><span class="p">,</span> <span class="n">regression_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">remove_row_column_effect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">volcano_plot</span><span class="p">,</span> <span class="n">plot_histogram</span>

    <span class="n">volcano_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">csv_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_volcano_plot.pdf&#39;</span>
    <span class="n">volcano_filename</span> <span class="o">=</span> <span class="n">regression_type</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">volcano_filename</span>
    <span class="k">if</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;quantile&#39;</span><span class="p">:</span>
        <span class="n">volcano_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">volcano_filename</span>
    <span class="n">volcano_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">csv_path</span><span class="p">),</span> <span class="n">volcano_filename</span><span class="p">)</span>

    <span class="n">is_normal</span> <span class="o">=</span> <span class="n">check_normality</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">dependent_variable</span><span class="p">],</span> <span class="n">dependent_variable</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">regression_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_normal</span><span class="p">:</span>
            <span class="n">regression_type</span> <span class="o">=</span> <span class="s1">&#39;ols&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regression_type</span> <span class="o">=</span> <span class="s1">&#39;glm&#39;</span>

    <span class="c1">#df = remove_outliers(df)</span>

    <span class="k">if</span> <span class="n">remove_row_column_effect</span><span class="p">:</span>

        <span class="c1">## 1. Fit the initial model with row and column to estimate their effects</span>
        <span class="c1">## 2. Fit the initial model using the specified regression type</span>
        <span class="c1">## 3. Calculate the residuals</span>
        <span class="c1">### Residual calculation: Residuals are the differences between the observed and predicted values. This step checks if the initial_model has an attribute resid (residuals). If it does, it directly uses them. Otherwise, it calculates residuals manually by subtracting the predicted values from the observed values (y_with_row_col).</span>
        <span class="c1">## 4. Use the residuals as the new dependent variable in the final regression model without row and column</span>
        <span class="c1">### Formula creation: A new regression formula is created, excluding row and column effects, with residuals as the new dependent variable.</span>
        <span class="c1">### Matrix creation: dmatrices is used again to create new design matrices (X for independent variables and y for the new dependent variable, residuals) based on the new formula and the dataframe df.</span>
        <span class="c1">#### Remove Confounding Effects:Variables like row and column can introduce systematic biases or confounding effects that might obscure the relationships between the dependent variable and the variables of interest (fraction:gene and fraction:grna).</span>
        <span class="c1">#### By first estimating the effects of row and column and then using the residuals (the part of the dependent variable that is not explained by row and column), we can focus the final regression model on the relationships of interest without the interference from row and column.</span>

        <span class="c1">#### Reduce Multicollinearity: Including variables like row and column along with other predictors can sometimes lead to multicollinearity, where predictors are highly correlated with each other. This can make it difficult to determine the individual effect of each predictor.</span>
        <span class="c1">#### By regressing out the effects of row and column first, we reduce potential multicollinearity issues in the final model.</span>
        
        <span class="c1"># Fit the initial model with row and column to estimate their effects</span>
        <span class="n">formula_with_row_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dependent_variable</span><span class="si">}</span><span class="s1"> ~ row + column&#39;</span>
        <span class="n">y_with_row_col</span><span class="p">,</span> <span class="n">X_with_row_col</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="n">formula_with_row_col</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span><span class="p">)</span>

        <span class="c1"># Fit the initial model using the specified regression type</span>
        <span class="n">initial_model</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">X_with_row_col</span><span class="p">,</span> <span class="n">y_with_row_col</span><span class="p">,</span> <span class="n">regression_type</span><span class="o">=</span><span class="n">regression_type</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

        <span class="c1"># Calculate the residuals manually</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">initial_model</span><span class="p">,</span> <span class="s1">&#39;resid&#39;</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_model</span><span class="o">.</span><span class="n">resid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_with_row_col</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">-</span> <span class="n">initial_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_with_row_col</span><span class="p">)</span>

        <span class="c1"># Use the residuals as the new dependent variable in the final regression model without row and column</span>
        <span class="n">formula_without_row_col</span> <span class="o">=</span> <span class="s1">&#39;residuals ~ fraction:gene + fraction:grna&#39;</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="n">formula_without_row_col</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span><span class="p">)</span>

        <span class="c1"># Plot histogram of the residuals</span>
        <span class="n">plot_histogram</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;residuals&#39;</span><span class="p">)</span>

        <span class="c1"># Scale the independent variables and residuals</span>
        <span class="n">scaler_X</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">scaler_y</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">scaler_y</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dependent_variable</span><span class="si">}</span><span class="s1"> ~ fraction:gene + fraction:grna + row + column&#39;</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">dmatrices</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span><span class="p">)</span>

        <span class="n">plot_histogram</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dependent_variable</span><span class="p">)</span>

        <span class="c1"># Scale the independent variables and dependent variable</span>
        <span class="n">scaler_X</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">scaler_y</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">scaler_y</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">regression_type</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;performing </span><span class="si">{</span><span class="n">regression_type</span><span class="si">}</span><span class="s1"> regression&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">regression_model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regression_type</span><span class="o">=</span><span class="n">regression_type</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">remove_row_column_effect</span><span class="o">=</span><span class="n">remove_row_column_effect</span><span class="p">)</span>
    
    <span class="c1"># Get the model coefficients and p-values</span>
    <span class="k">if</span> <span class="n">regression_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ols&#39;</span><span class="p">,</span><span class="s1">&#39;gls&#39;</span><span class="p">,</span><span class="s1">&#39;wls&#39;</span><span class="p">,</span><span class="s1">&#39;rlm&#39;</span><span class="p">,</span><span class="s1">&#39;glm&#39;</span><span class="p">,</span><span class="s1">&#39;mixed&#39;</span><span class="p">,</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span><span class="s1">&#39;logit&#39;</span><span class="p">,</span><span class="s1">&#39;probit&#39;</span><span class="p">,</span><span class="s1">&#39;poisson&#39;</span><span class="p">]:</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pvalues</span>

        <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">coefs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="n">coefs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_values</span><span class="o">.</span><span class="n">values</span>
        <span class="p">})</span>
    <span class="k">elif</span> <span class="n">regression_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ridge&#39;</span><span class="p">,</span> <span class="s1">&#39;lasso&#39;</span><span class="p">]:</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1"># Calculate p-values</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="n">calculate_p_values</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Create a DataFrame for the coefficients and p-values</span>
        <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="n">coefs</span><span class="p">,</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_values</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">intercept</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">intercept_</span>
        <span class="n">feature_names</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span>

        <span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
            <span class="s1">&#39;coefficient&#39;</span><span class="p">:</span> <span class="n">coefs</span>
        <span class="p">})</span>
        <span class="n">coef_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;coefficient&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intercept</span>
        <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Placeholder since sklearn doesn&#39;t provide p-values</span>

    <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;-log10(p_value)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">])</span>
    <span class="n">coef_df_v</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">]</span>

    <span class="c1"># Create the highlight column</span>
    <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;highlight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;220950&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">coef_df</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="o">~</span><span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;row|column&#39;</span><span class="p">)]</span>
    <span class="n">volcano_plot</span><span class="p">(</span><span class="n">coef_df</span><span class="p">,</span> <span class="n">volcano_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">coef_df</span></div>


<div class="viewcode-block" id="perform_regression">
<a class="viewcode-back" href="../../spacr.html#spacr.sequencing.perform_regression">[docs]</a>
<span class="k">def</span> <span class="nf">perform_regression</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">spacr.plot</span> <span class="kn">import</span> <span class="n">plot_plates</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">merge_regression_res_with_metadata</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">get_perform_regression_default_settings</span>

    <span class="n">reg_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ols&#39;</span><span class="p">,</span><span class="s1">&#39;gls&#39;</span><span class="p">,</span><span class="s1">&#39;wls&#39;</span><span class="p">,</span><span class="s1">&#39;rlm&#39;</span><span class="p">,</span><span class="s1">&#39;glm&#39;</span><span class="p">,</span><span class="s1">&#39;mixed&#39;</span><span class="p">,</span><span class="s1">&#39;quantile&#39;</span><span class="p">,</span><span class="s1">&#39;logit&#39;</span><span class="p">,</span><span class="s1">&#39;probit&#39;</span><span class="p">,</span><span class="s1">&#39;poisson&#39;</span><span class="p">,</span><span class="s1">&#39;lasso&#39;</span><span class="p">,</span><span class="s1">&#39;ridge&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reg_types</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Possible regression types: </span><span class="si">{</span><span class="n">reg_types</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported regression type </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data must be a DataFrame or a path to a CSV file&quot;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dependent_variable&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Columns in DataFrame:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dependent variable </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dependent_variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in the DataFrame&quot;</span><span class="p">)</span>
        
    <span class="n">results_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_results.csv&#39;</span>
    <span class="n">hits_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_results_significant.csv&#39;</span>
    
    <span class="n">results_filename</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">results_filename</span>
    <span class="n">hits_filename</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">hits_filename</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quantile&#39;</span><span class="p">:</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">results_filename</span>
        <span class="n">hits_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">hits_filename</span>
    <span class="n">results_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">]),</span> <span class="n">results_filename</span><span class="p">)</span>
    <span class="n">hits_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">]),</span> <span class="n">hits_filename</span><span class="p">)</span>
    
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_perform_regression_default_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">settings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">])</span>
    <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">])</span>
    <span class="n">settings_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_regression_settings.csv&quot;</span><span class="p">)</span>
    <span class="n">settings_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">settings_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">settings_df</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">clean_controls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pc&#39;</span><span class="p">],</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;prediction_probability_class_1&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_1_threshold&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prediction_probability_class_1&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_1_threshold&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">dependent_df</span><span class="p">,</span> <span class="n">dependent_variable</span> <span class="o">=</span> <span class="n">process_scores</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dependent_variable&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;min_cell_count&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;agg_type&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">])</span>
    
    <span class="n">display</span><span class="p">(</span><span class="n">dependent_df</span><span class="p">)</span>
    
    <span class="n">independent_df</span> <span class="o">=</span> <span class="n">precess_reads</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fraction_threshold&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">])</span>
    <span class="n">display</span><span class="p">(</span><span class="n">independent_df</span><span class="p">)</span>
    
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">independent_df</span><span class="p">,</span> <span class="n">dependent_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">)</span>
    
    <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plot_plates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">dependent_variable</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">min_max</span><span class="o">=</span><span class="s1">&#39;allq&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;min_cell_count&#39;</span><span class="p">])</span>                

    <span class="n">model</span><span class="p">,</span> <span class="n">coef_df</span> <span class="o">=</span> <span class="n">regression</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gene_weights_csv&#39;</span><span class="p">],</span> <span class="n">dependent_variable</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_row_column_effect&#39;</span><span class="p">])</span>
    
    <span class="n">coef_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lasso&#39;</span><span class="p">:</span>
        <span class="n">significant</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;coefficient&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">significant</span> <span class="o">=</span> <span class="n">coef_df</span><span class="p">[</span><span class="n">coef_df</span><span class="p">[</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="o">&lt;=</span> <span class="mf">0.05</span><span class="p">]</span>
        <span class="c1">#significant = significant[significant[&#39;coefficient&#39;] &gt; 0.1]</span>
        <span class="n">significant</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;coefficient&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">significant</span> <span class="o">=</span> <span class="n">significant</span><span class="p">[</span><span class="o">~</span><span class="n">significant</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;row|column&#39;</span><span class="p">)]</span>
        
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;regression_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ols&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    
    <span class="n">significant</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">hits_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">me49</span> <span class="o">=</span> <span class="s1">&#39;/home/carruthers/Documents/TGME49_Summary.csv&#39;</span>
    <span class="n">gt1</span> <span class="o">=</span> <span class="s1">&#39;/home/carruthers/Documents/TGGT1_Summary.csv&#39;</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">merge_regression_res_with_metadata</span><span class="p">(</span><span class="n">hits_path</span><span class="p">,</span> <span class="n">me49</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_me49_metadata&#39;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">merge_regression_res_with_metadata</span><span class="p">(</span><span class="n">hits_path</span><span class="p">,</span> <span class="n">gt1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gt1_metadata&#39;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">merge_regression_res_with_metadata</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="n">me49</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_me49_metadata&#39;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">merge_regression_res_with_metadata</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="n">gt1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;_gt1_metadata&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Significant Genes&#39;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">significant</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coef_df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Your Name.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>