

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spacr.io &mdash; spacr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            spacr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">spacr</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spacr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spacr.io</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spacr.io</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">torch</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">tarfile</span><span class="o">,</span> <span class="nn">cellpose</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">queue</span><span class="o">,</span> <span class="nn">tifffile</span><span class="o">,</span> <span class="nn">czifile</span><span class="o">,</span> <span class="nn">atexit</span><span class="o">,</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">skimage.util</span> <span class="kn">import</span> <span class="n">img_as_uint</span>
<span class="kn">from</span> <span class="nn">skimage.exposure</span> <span class="kn">import</span> <span class="n">rescale_intensity</span>
<span class="kn">import</span> <span class="nn">skimage.measure</span> <span class="k">as</span> <span class="nn">measure</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>
<span class="kn">import</span> <span class="nn">imageio.v2</span> <span class="k">as</span> <span class="nn">imageio2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">random_split</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> 
<span class="kn">from</span> <span class="nn">nd2reader</span> <span class="kn">import</span> <span class="n">ND2Reader</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<div class="viewcode-block" id="process_non_tif_non_2D_images">
<a class="viewcode-back" href="../../spacr.html#spacr.io.process_non_tif_non_2D_images">[docs]</a>
<span class="k">def</span> <span class="nf">process_non_tif_non_2D_images</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Processes all images in the folder and splits them into grayscale channels, preserving bit depth.&quot;&quot;&quot;</span>
    
    <span class="c1"># Helper function to save grayscale images</span>
    <span class="k">def</span> <span class="nf">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save grayscale images with appropriate suffix based on channel, z, and t, preserving bit depth.&quot;&quot;&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_C</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_Z</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_T</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

    <span class="c1"># Function to handle splitting of multi-dimensional images into grayscale channels</span>
    <span class="k">def</span> <span class="nf">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits the image into channels and handles 3D, 4D, and 5D image cases.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Grayscale image, already processed separately</span>
            <span class="k">return</span>
        
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># 3D image: (height, width, channels)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># 4D image: (height, width, channels, Z-dimension)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># 5D image: (height, width, channels, Z-dimension, Time)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">save_grayscale_images</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Function to load images in various formats</span>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads image from various formats and returns it as a numpy array along with its dtype.&quot;&quot;&quot;</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">]:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.czi&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">czifile</span><span class="o">.</span><span class="n">CziFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">czi</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">czi</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">nd2</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nd2</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Function to check if an image is grayscale and save it as a TIFF if it isn&#39;t already</span>
    <span class="k">def</span> <span class="nf">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert grayscale images that are not in TIFF format to TIFF, preserving bit depth.&quot;&quot;&quot;</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted grayscale image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to TIFF with bit depth </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># Supported formats</span>
    <span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;.czi&#39;</span><span class="p">,</span> <span class="s1">&#39;.nd2&#39;</span><span class="p">]</span>
    
    <span class="c1"># Loop through all files in the folder</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load the image and its dtype</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                
                <span class="c1"># If the image is grayscale (2D), convert it to TIFF if it&#39;s not already in TIFF format</span>
                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.tiff&#39;</span><span class="p">]:</span>
                        <span class="n">convert_grayscale_to_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is already grayscale and in TIFF format, skipping.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Otherwise, split channels and save images</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">split_channels</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_load_images_and_labels</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">invert_image</span><span class="p">,</span> <span class="n">apply_mask</span>
    
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_names</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_files</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="k">for</span> <span class="n">img_file</span><span class="p">,</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">image_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">image_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_dir</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_dir</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Log the number of loaded images and labels</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels from </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">label_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;image shape: </span><span class="si">{</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, image type: images[0].shape mask shape: </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">, image type: labels[0].shape&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_names</span><span class="p">,</span> <span class="n">label_names</span>

<span class="k">def</span> <span class="nf">_load_normalized_images_and_labels</span><span class="p">(</span><span class="n">image_files</span><span class="p">,</span> <span class="n">label_files</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  
                                       <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                       <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Signal_to_noise</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">normalize_and_visualize</span><span class="p">,</span> <span class="n">plot_resize</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">invert_image</span><span class="p">,</span> <span class="n">apply_mask</span>
    <span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span> <span class="k">as</span> <span class="n">resizescikit</span>

    <span class="c1"># Ensure percentiles are valid</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">percentiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">signal_thresholds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">Signal_to_noise</span><span class="p">)</span>
    <span class="n">lower_percentile</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">orig_dims</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">num_channels</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">percentiles_1</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)]</span>
    <span class="n">percentiles_99</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">)]</span>

    <span class="n">image_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">]</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">label_files</span><span class="p">]</span>
        <span class="n">label_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">label_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_names</span><span class="p">,</span> <span class="n">label_dir</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>

    <span class="c1"># Load, normalize, and resize images</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_files</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_file</span><span class="p">)</span>
        <span class="n">orig_dims</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">invert_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># Select specific channels if needed</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate percentiles if not provided</span>
        <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="p">)</span>
                <span class="n">percentiles_1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

                <span class="c1"># Ensure `signal_thresholds` and `p` are floats for comparison</span>
                <span class="k">for</span> <span class="n">percentile</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">,</span> <span class="mf">99.999</span><span class="p">]:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">signal_thresholds</span><span class="p">:</span>
                        <span class="n">percentiles_99</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="c1"># Resize image if required</span>
        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">and</span> <span class="n">target_width</span><span class="p">:</span>
            <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">resizescikit</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># Calculate average percentiles if needed</span>
    <span class="k">if</span> <span class="n">percentiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">avg_p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentiles_1</span><span class="p">]</span>
        <span class="n">avg_p99</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="k">else</span> <span class="n">avg_p1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">percentiles_99</span><span class="p">)]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average 1st percentiles: </span><span class="si">{</span><span class="n">avg_p1</span><span class="si">}</span><span class="s1">, Average 99th percentiles: </span><span class="si">{</span><span class="n">avg_p99</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">normalized_images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">avg_p1</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">avg_p99</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span>
        <span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">normalized_images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> 
                                        <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> 
                                        <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span>
        <span class="p">]</span>

    <span class="c1"># Load and resize labels if provided</span>
    <span class="k">if</span> <span class="n">label_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">resizescikit</span><span class="p">(</span><span class="n">cellpose</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">lbl_file</span><span class="p">),</span> 
                               <span class="p">(</span><span class="n">target_height</span><span class="p">,</span> <span class="n">target_width</span><span class="p">)</span> <span class="k">if</span> <span class="n">target_height</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="k">else</span> <span class="n">orig_dims</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                               <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbl_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_files</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded and normalized </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="si">}</span><span class="s1"> labels from </span><span class="si">{</span><span class="n">image_dir</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">label_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">visualize</span> <span class="ow">and</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">plot_resize</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">normalized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normalized_images</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">image_names</span><span class="p">,</span> <span class="n">label_names</span><span class="p">,</span> <span class="n">orig_dims</span>

<div class="viewcode-block" id="CombineLoaders">
<a class="viewcode-back" href="../../spacr.html#spacr.io.CombineLoaders">[docs]</a>
<span class="k">class</span> <span class="nc">CombineLoaders</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that combines multiple data loaders into a single iterator.</span>

<span class="sd">    Args:</span>
<span class="sd">        train_loaders (list): A list of data loaders.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        train_loaders (list): A list of data loaders.</span>
<span class="sd">        loader_iters (list): A list of iterator objects for each data loader.</span>

<span class="sd">    Methods:</span>
<span class="sd">        __iter__(): Returns the iterator object itself.</span>
<span class="sd">        __next__(): Returns the next batch from one of the data loaders.</span>

<span class="sd">    Raises:</span>
<span class="sd">        StopIteration: If all data loaders have been exhausted.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_loaders</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_loaders</span> <span class="o">=</span> <span class="n">train_loaders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span> <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">train_loaders</span><span class="p">]</span>

<div class="viewcode-block" id="CombineLoaders.__iter__">
<a class="viewcode-back" href="../../spacr.html#spacr.io.CombineLoaders.__iter__">[docs]</a>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="CombineLoaders.__next__">
<a class="viewcode-back" href="../../spacr.html#spacr.io.CombineLoaders.__next__">[docs]</a>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">)</span>  <span class="c1"># Shuffle the loader_iters list</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loader_iter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">loader_iter</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loader_iters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span></div>
</div>


<div class="viewcode-block" id="CombinedDataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.CombinedDataset">[docs]</a>
<span class="k">class</span> <span class="nc">CombinedDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dataset that combines multiple datasets into one.</span>

<span class="sd">    Args:</span>
<span class="sd">        datasets (list): A list of datasets to be combined.</span>
<span class="sd">        shuffle (bool, optional): Whether to shuffle the combined dataset. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_length</span><span class="p">))</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lengths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">-=</span> <span class="n">length</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_length</span></div>

    
<span class="k">class</span> <span class="nc">NoClassDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom dataset class for handling image data without class labels.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_dir (str): The directory path where the image files are located.</span>
<span class="sd">        transform (callable, optional): A function/transform to apply to the image data. Default is None.</span>
<span class="sd">        shuffle (bool, optional): Whether to shuffle the dataset. Default is True.</span>
<span class="sd">        load_to_memory (bool, optional): Whether to load all images into memory. Default is False.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        data_dir (str): The directory path where the image files are located.</span>
<span class="sd">        transform (callable): A function/transform to apply to the image data.</span>
<span class="sd">        shuffle (bool): Whether to shuffle the dataset.</span>
<span class="sd">        load_to_memory (bool): Whether to load all images into memory.</span>
<span class="sd">        filenames (list): A list of file paths for the image files.</span>
<span class="sd">        images (list): A list of loaded images (if load_to_memory is True).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
    
    <span class="c1">#@lru_cache(maxsize=None)</span>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load an image from the given file path.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            img_path (str): The file path of the image.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            PIL.Image: The loaded image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span>
    
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the total number of images in the dataset.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            int: The number of images in the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shuffle the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the image and its corresponding filename at the given index.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            index (int): The index of the image in the dataset.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the image and its filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
        <span class="c1"># Return both the image and its filename</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

<div class="viewcode-block" id="spacrDataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.spacrDataset">[docs]</a>
<span class="k">class</span> <span class="nc">spacrDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">loader_classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">specific_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specific_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">loader_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">pin_memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">specific_files</span> <span class="ow">and</span> <span class="n">specific_labels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">specific_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">specific_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
                <span class="n">class_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
                <span class="n">class_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_files</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">class_name</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_files</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
            <span class="c1"># Use multiprocessing to load images in parallel</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="spacrDataset.load_image">
<a class="viewcode-back" href="../../spacr.html#spacr.io.spacrDataset.load_image">[docs]</a>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">exif_transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># Handle image orientation</span>
        <span class="k">return</span> <span class="n">img</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>

<div class="viewcode-block" id="spacrDataset.shuffle_dataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.spacrDataset.shuffle_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">combined</span><span class="p">)</span></div>


<div class="viewcode-block" id="spacrDataset.get_plate">
<a class="viewcode-back" href="../../spacr.html#spacr.io.spacrDataset.get_plate">[docs]</a>
    <span class="k">def</span> <span class="nf">get_plate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">filename</span></div>

    
<div class="viewcode-block" id="spacrDataLoader">
<a class="viewcode-back" href="../../spacr.html#spacr.io.spacrDataLoader">[docs]</a>
<span class="k">class</span> <span class="nc">spacrDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">preload_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span> <span class="o">=</span> <span class="n">preload_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">preload_batches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pin_memory&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_preload_next_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_start_preloading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_preload_next_batches</span><span class="p">()</span>  <span class="c1"># Directly load if pin_memory is True</span>

    <span class="k">def</span> <span class="nf">_pin_memory_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">batch</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pin_memory</span><span class="p">:</span>
                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Start preloading the next batches</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload_batches</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_start_preloading</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">next_batch</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

<div class="viewcode-block" id="spacrDataLoader.cleanup">
<a class="viewcode-back" href="../../spacr.html#spacr.io.spacrDataLoader.cleanup">[docs]</a>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_event</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>


<div class="viewcode-block" id="NoClassDataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.NoClassDataset">[docs]</a>
<span class="k">class</span> <span class="nc">NoClassDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">load_to_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span> <span class="o">=</span> <span class="n">load_to_memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_dataset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
    
<div class="viewcode-block" id="NoClassDataset.load_image">
<a class="viewcode-back" href="../../spacr.html#spacr.io.NoClassDataset.load_image">[docs]</a>
    <span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>

<div class="viewcode-block" id="NoClassDataset.shuffle_dataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.NoClassDataset.shuffle_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_to_memory</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


    
<div class="viewcode-block" id="TarImageDataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.TarImageDataset">[docs]</a>
<span class="k">class</span> <span class="nc">TarImageDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tar_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span> <span class="o">=</span> <span class="n">tar_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

        <span class="c1"># Open the tar file just to build the list of members</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">isfile</span><span class="p">()]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">img_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span></div>

    
<div class="viewcode-block" id="load_images_from_paths">
<a class="viewcode-back" href="../../spacr.html#spacr.io.load_images_from_paths">[docs]</a>
<span class="k">def</span> <span class="nf">load_images_from_paths</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">):</span>
    <span class="n">images_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                    <span class="n">images_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading image from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">images_dict</span></div>


<span class="c1">#@log_function_call</span>
<span class="k">def</span> <span class="nf">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">pick_slice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_mode</span><span class="o">=</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="n">metadata_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">img_format</span><span class="o">=</span><span class="s1">&#39;.tif&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert z-stack images to maximum intensity projection (MIP) images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the z-stack images.</span>
<span class="sd">        regex (str): The regular expression pattern used to match the filenames of the z-stack images.</span>
<span class="sd">        batch_size (int, optional): The number of images to process in each batch. Defaults to 100.</span>
<span class="sd">        pick_slice (bool, optional): Whether to pick a specific slice based on the provided skip mode. Defaults to False.</span>
<span class="sd">        skip_mode (str, optional): The skip mode used to filter out specific slices. Defaults to &#39;01&#39;.</span>
<span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_extract_filename_metadata</span><span class="p">,</span> <span class="n">print_progress</span>
    
    <span class="n">regular_expression</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
    <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">stack_path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">all_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">img_format</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_paths_by_key</span> <span class="o">=</span> <span class="n">_extract_filename_metadata</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">regular_expression</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">)</span>
        <span class="c1"># Convert dictionary keys to a list for batching</span>
        <span class="n">batching_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All unique FOV: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="p">)</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_paths_by_key</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Select batch keys and create a subset of the dictionary for this batch</span>
            <span class="n">batch_keys</span> <span class="o">=</span> <span class="n">batching_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="n">batch_images_by_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">image_paths_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">batch_keys</span><span class="p">}</span>
            <span class="n">images_by_key</span> <span class="o">=</span> <span class="n">load_images_from_paths</span><span class="p">(</span><span class="n">batch_images_by_key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pick_slice</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">):</span>
                    <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">max_intensity_slice</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">images_by_key</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>
                    <span class="n">mip_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">max_intensity_slice</span><span class="p">)</span>
                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">.tif&#39;</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
                    <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                    <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                    <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span>
                    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Preprocessing filenames&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                        <span class="n">mip_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images_by_key</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">mip_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">mip</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">.tif&#39;</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">)</span>
                    <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                    <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                    <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_filenames</span><span class="p">)</span>
                    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Preprocessing filenames&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                        <span class="n">mip_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">images_by_key</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Move original images to a new directory</span>
        <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="n">img_format</span><span class="p">]</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
                <span class="n">move</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">move</span><span class="p">)</span>
    <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_merge_file</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">,</span> <span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge multiple channels into a single stack and save it as a numpy array, using os module for path handling.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        chan_dirs (list): List of directories containing channel images.</span>
<span class="sd">        stack_dir (str): Directory to save the merged stack.</span>
<span class="sd">        file_name (str): File name of the channel image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Construct new file path</span>
    <span class="n">file_root</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">new_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
    
    <span class="c1"># Check if the new file exists and create the stack directory if it doesn&#39;t</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_file</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chan_dir</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chan_dirs</span><span class="p">):</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chan_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Failed to read image </span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">img</span>  <span class="c1"># Explicitly delete the reference to the image to free up memory</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Periodically suggest garbage collection</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid channels to merge for file </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_is_dir_empty</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a directory is empty using os module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_generate_time_lists</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate sorted lists of filenames grouped by plate, well, and field.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_list (list): A list of filenames.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of sorted file lists, where each file list contains filenames</span>
<span class="sd">              belonging to the same plate, well, and field, sorted by timepoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timepoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># Skip file on conversion error</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">file_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">timepoint</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Skip file if not correctly formatted</span>

    <span class="c1"># Sort each list by timepoint, but keep them grouped</span>
    <span class="n">sorted_grouped_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="c1"># Extract just the filenames from each group</span>
    <span class="n">sorted_file_lists</span> <span class="o">=</span> <span class="p">[[</span><span class="n">filename</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sorted_grouped_filenames</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sorted_file_lists</span>

<span class="k">def</span> <span class="nf">_move_to_chan_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metadata_type</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_safe_int_convert</span><span class="p">,</span> <span class="n">_convert_cq1_well_id</span>
    
    <span class="n">src_path</span> <span class="o">=</span> <span class="n">src</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src</span> <span class="o">/</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> 
                    <span class="k">try</span><span class="p">:</span>                  
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">plateID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;plateID&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">plateID</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span>

                        <span class="n">wellID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;wellID&#39;</span><span class="p">)</span>
                        <span class="n">fieldID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;fieldID&#39;</span><span class="p">)</span>
                        <span class="n">chanID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;chanID&#39;</span><span class="p">)</span>
                        <span class="n">timeID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;timeID&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">wellID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">wellID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">wellID</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">fieldID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">fieldID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">fieldID</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">chanID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">chanID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">chanID</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">timeID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">timeID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_safe_int_convert</span><span class="p">(</span><span class="n">timeID</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">metadata_type</span> <span class="o">==</span><span class="s1">&#39;cq1&#39;</span><span class="p">:</span>
                            <span class="n">orig_wellID</span> <span class="o">=</span> <span class="n">wellID</span>
                            <span class="n">wellID</span> <span class="o">=</span> <span class="n">_convert_cq1_well_id</span><span class="p">(</span><span class="n">wellID</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Converted Well ID: </span><span class="si">{</span><span class="n">orig_wellID</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">wellID</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span>

                        <span class="n">newname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plateID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">wellID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fieldID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timeID</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">timelapse</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">newpath</span> <span class="o">=</span> <span class="n">src</span> <span class="o">/</span> <span class="n">chanID</span>
                        <span class="n">move</span> <span class="o">=</span> <span class="n">newpath</span> <span class="o">/</span> <span class="n">newname</span>
                        <span class="k">if</span> <span class="n">move</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">newpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract information from filename </span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">regex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Move original images to a new directory</span>
        <span class="n">valid_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">]</span>
        <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="s1">&#39;orig&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_exts</span><span class="p">:</span>
                <span class="n">move</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">move</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: A file with the same name already exists at location </span><span class="si">{</span><span class="n">move</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">move</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge the channels in the given source directory and save the merged files in a &#39;stack&#39; directory without using multiprocessing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
    
    <span class="n">stack_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
    <span class="n">allowed_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="s1">&#39;02&#39;</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">,</span> <span class="s1">&#39;04&#39;</span><span class="p">,</span> <span class="s1">&#39;00&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">]</span>
    
    <span class="c1"># List directories that match the allowed names</span>
    <span class="n">chan_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">allowed_names</span><span class="p">]</span>
    <span class="n">chan_dirs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;List of folders in src: </span><span class="si">{</span><span class="n">chan_dirs</span><span class="si">}</span><span class="s1">. Single channel folders.&#39;</span><span class="p">)</span>
    
    <span class="c1"># Assuming chan_dirs[0] is not empty and exists, adjust according to your logic</span>
    <span class="n">first_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">chan_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dir_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">first_dir_path</span><span class="p">)</span>

    <span class="c1"># Create the &#39;stack&#39; directory if it doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated folder with merged arrays: </span><span class="si">{</span><span class="n">stack_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_is_dir_empty</span><span class="p">(</span><span class="n">stack_dir</span><span class="p">):</span>
        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dir_files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dir_files</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">full_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_file_path</span><span class="p">):</span>
                <span class="n">_merge_file</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">chan_dirs</span><span class="p">],</span> <span class="n">stack_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop_time</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s1">&#39;Merging channels into npy stacks&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">))</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">_mip_all</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">include_first_chan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate maximum intensity projections (MIPs) for each NumPy array file in the specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The directory path containing the NumPy array files.</span>
<span class="sd">        include_first_chan (bool, optional): Whether to include the first channel of the array in the MIP computation. </span>
<span class="sd">                                                Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#print(&#39;========== generating MIPs ==========&#39;)</span>
    <span class="c1"># Iterate over each file in the specified directory (src).</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="c1"># Check if the current file is a NumPy array file (with .npy extension).</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="c1"># Load the array from the file.</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="c1"># Normalize the array </span>
            <span class="c1">#array = normalize_to_dtype(array, q1=0, q2=99, percentiles=None)</span>

            <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Check if the array is not 3-dimensional.</span>
                <span class="c1"># Log a message indicating a zero array will be generated due to unexpected dimensions.</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating zero array for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> due to unexpected dimensions: </span><span class="si">{</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Create a zero array with the same height and width as the original array, but with a single depth layer.</span>
                <span class="n">zeros_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                <span class="c1"># Concatenate the original array with the zero array along the depth axis.</span>
                <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">zeros_array</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">include_first_chan</span><span class="p">:</span>
                    <span class="c1"># Compute the MIP for the entire array along the third axis.</span>
                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Compute the MIP excluding the first layer of the array along the depth axis.</span>
                    <span class="n">mip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Reshape the MIP to make it 3-dimensional.</span>
                <span class="n">mip</span> <span class="o">=</span> <span class="n">mip</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="c1"># Concatenate the MIP with the original array.</span>
                <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">array</span><span class="p">,</span> <span class="n">mip</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># save</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">concatenated</span><span class="p">)</span>
    <span class="k">return</span>

<span class="c1">#@log_function_call</span>
<span class="k">def</span> <span class="nf">_concatenate_channel</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timelapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenates channel data from multiple files and saves the concatenated data as numpy arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the channel data files.</span>
<span class="sd">        channels (list): The list of channel indices to be concatenated.</span>
<span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
<span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
<span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The directory path where the concatenated channel data is saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">channel_stack_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;channel_stack&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">time_stack_path_lists</span>
                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>
                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">stack</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Added this to name the output files</span>
        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>  <span class="c1"># store the filename</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimentions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channel_stack_loc</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>
                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># increment this after each batch is saved</span>
                <span class="k">del</span> <span class="n">stack</span>  <span class="c1"># delete to free memory</span>
                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty the list for the next batch</span>
                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># empty the filenames list for the next batch</span>
                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and saved to:</span><span class="si">{</span><span class="n">channel_stack_loc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">channel_stack_loc</span>

<span class="k">def</span> <span class="nf">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the stack of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        stack (numpy.ndarray): The stack of images to normalize.</span>
<span class="sd">        lower_percentile (int): Lower percentile value for normalization.</span>
<span class="sd">        save_dtype (numpy.dtype): Data type for saving the normalized stack.</span>
<span class="sd">        settings (dict): keword arguments</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The normalized stack.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1">#for channel in range(stack.shape[-1]):</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">]:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_nucleus&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">]:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_cell&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">channel</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_pathogen&#39;</span><span class="p">]</span>

        <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: background=</span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s1">, signal_threshold=</span><span class="si">{</span><span class="n">signal_threshold</span><span class="si">}</span><span class="s1">, remove_background=</span><span class="si">{</span><span class="n">remove_background</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Step 3: Remove background if required</span>
        <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
            <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Step 4: Calculate global lower percentile for the channel</span>
        <span class="n">non_zero_single_channel</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">global_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;lower_percentile&#39;</span><span class="p">])</span>

        <span class="c1"># Step 5: Calculate global upper percentile for the channel</span>
        <span class="n">global_upper</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">upper_p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
            <span class="n">upper_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">upper_value</span> <span class="o">&gt;=</span> <span class="n">signal_threshold</span><span class="p">:</span>
                <span class="n">global_upper</span> <span class="o">=</span> <span class="n">upper_value</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">global_upper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">global_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>  <span class="c1"># Fallback in case no upper percentile met the threshold</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: global_lower=</span><span class="si">{</span><span class="n">global_lower</span><span class="si">}</span><span class="s1">, global_upper=</span><span class="si">{</span><span class="n">global_upper</span><span class="si">}</span><span class="s1">, Signal-to-noise=</span><span class="si">{</span><span class="n">global_upper</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">global_lower</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Step 6: Normalize each array from global_lower to global_upper between 0 and 1</span>
        <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">arr_2d_normalized</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">global_lower</span><span class="p">,</span> <span class="n">global_upper</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">normalized_stack</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_normalized</span>

        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normalizing&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normalized_stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">save_dtype</span><span class="p">)</span>

<div class="viewcode-block" id="concatenate_and_normalize">
<a class="viewcode-back" href="../../spacr.html#spacr.io.concatenate_and_normalize">[docs]</a>
<span class="k">def</span> <span class="nf">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenates and normalizes channel data from multiple files and saves the normalized data.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the channel data files.</span>
<span class="sd">        channels (list): The list of channel indices to be concatenated and normalized.</span>
<span class="sd">        randomize (bool, optional): Whether to randomize the order of the files. Defaults to True.</span>
<span class="sd">        timelapse (bool, optional): Whether the channel data is from a timelapse experiment. Defaults to False.</span>
<span class="sd">        batch_size (int, optional): The number of files to be processed in each batch. Defaults to 100.</span>
<span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
<span class="sd">        remove_backgrounds (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
<span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
<span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
<span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
<span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The directory path where the concatenated and normalized channel data is saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;timelapse&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">time_stack_path_lists</span> <span class="o">=</span> <span class="n">_generate_time_lists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">time_stack_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">stack_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filenames_region</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_stack_list</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">stack_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
                    <span class="n">filenames_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">files_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_stack_path_lists</span><span class="p">)</span>
                <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_region</span><span class="p">)</span>

                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> 
                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                
                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>
                
                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_region</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">save_loc</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing files, make sure filenames metadata is structured plate_well_field_time.npy&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;randomize&#39;</span><span class="p">]:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">nr_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">batch_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">filenames_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">files_processed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">nr_files</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Concatinating&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">nr_files</span><span class="p">:</span>
                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found in batch </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. Padding arrays to max X,Y dimensions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span>
                
                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">_normalize_img_batch</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">,</span>
                                                        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
                                                        <span class="n">save_dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">,</span>
                                                        <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
                
                <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">normalized_stack</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channels</span><span class="p">]</span>

                <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stack_</span><span class="si">{</span><span class="n">batch_index</span><span class="si">}</span><span class="s1">_norm.npz&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames_batch</span><span class="p">)</span>
                <span class="n">batch_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">del</span> <span class="n">stack</span><span class="p">,</span> <span class="n">normalized_stack</span>
                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">filenames_batch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All files concatenated and normalized. Saved to: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_fldr</span></div>


<span class="k">def</span> <span class="nf">_get_lists_for_normalization</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get lists for normalization based on the provided settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): A dictionary containing the settings for normalization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing three lists - backgrounds, signal_to_noise, and signal_thresholds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize the lists</span>
    <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">signal_to_noise</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">signal_thresholds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">remove_background</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Iterate through the channels and append the corresponding values if the channel is not None</span>
    <span class="c1"># for ch in settings[&#39;channels&#39;]:</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">]:</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">])</span>
                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">])</span>
                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">])</span>
                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_nucleus&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">]:</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">])</span>
                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">])</span>
                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">])</span>
                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_cell&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]:</span>
                <span class="n">backgrounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">])</span>
                <span class="n">signal_to_noise</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">])</span>
                <span class="n">signal_thresholds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_Signal_to_noise&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">])</span>
                <span class="n">remove_background</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;remove_background_pathogen&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">backgrounds</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="p">,</span> <span class="n">signal_thresholds</span><span class="p">,</span> <span class="n">remove_background</span>

<span class="k">def</span> <span class="nf">_normalize_stack</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">backgrounds</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">remove_backgrounds</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">signal_thresholds</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the stack of images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the stack of images.</span>
<span class="sd">        backgrounds (list, optional): Background values for each channel. Defaults to [100, 100, 100].</span>
<span class="sd">        remove_background (list, optional): Whether to remove background values for each channel. Defaults to [False, False, False].</span>
<span class="sd">        lower_percentile (int, optional): Lower percentile value for normalization. Defaults to 2.</span>
<span class="sd">        save_dtype (numpy.dtype, optional): Data type for saving the normalized stack. Defaults to np.float32.</span>
<span class="sd">        signal_to_noise (list, optional): Signal-to-noise ratio thresholds for each channel. Defaults to [5, 5, 5].</span>
<span class="sd">        signal_thresholds (list, optional): Signal thresholds for each channel. Defaults to [1000, 1000, 1000].</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>
        
        <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chan_index</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="n">signal_threshold</span> <span class="o">=</span> <span class="n">signal_thresholds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="n">remove_background</span> <span class="o">=</span> <span class="n">remove_backgrounds</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="n">signal_2_noise</span> <span class="o">=</span> <span class="n">signal_to_noise</span><span class="p">[</span><span class="n">chan_index</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;chan_index:</span><span class="si">{</span><span class="n">chan_index</span><span class="si">}</span><span class="s1"> background:</span><span class="si">{</span><span class="n">background</span><span class="si">}</span><span class="s1"> signal_threshold:</span><span class="si">{</span><span class="n">signal_threshold</span><span class="si">}</span><span class="s1"> remove_background:</span><span class="si">{</span><span class="n">remove_background</span><span class="si">}</span><span class="s1"> signal_2_noise:</span><span class="si">{</span><span class="n">signal_2_noise</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">remove_background</span><span class="p">:</span>
                <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Calculate the global lower and upper percentiles for non-zero pixels</span>
            <span class="n">non_zero_single_channel</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">single_channel</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">global_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">upper_p</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">global_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_single_channel</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">global_upper</span> <span class="o">&gt;=</span> <span class="n">signal_threshold</span><span class="p">:</span>
                    <span class="k">break</span>
            
            <span class="c1"># Normalize the pixels in each image to the global percentiles and then dtype.</span>
            <span class="n">arr_2d_normalized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">single_channel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">single_channel</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">signal_to_noise_ratio_ls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">non_zero_arr_2d</span> <span class="o">=</span> <span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">non_zero_arr_2d</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">non_zero_arr_2d</span><span class="p">,</span> <span class="p">(</span><span class="n">lower_percentile</span><span class="p">,</span> <span class="n">upper_p</span><span class="p">))</span>
                    <span class="n">signal_to_noise_ratio</span> <span class="o">=</span> <span class="n">upper</span> <span class="o">/</span> <span class="n">lower</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">signal_to_noise_ratio</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">signal_to_noise_ratio_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signal_to_noise_ratio</span><span class="p">)</span>
                <span class="n">average_stnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signal_to_noise_ratio_ls</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal_to_noise_ratio_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">signal_to_noise_ratio</span> <span class="o">&gt;</span> <span class="n">signal_2_noise</span><span class="p">:</span>
                    <span class="n">arr_2d_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">arr_2d_normalized</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr_2d_rescaled</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arr_2d_normalized</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">arr_2d</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
                <span class="n">average_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time_ls</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels:</span><span class="si">{</span><span class="n">chan_index</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">, arrays:</span><span class="si">{</span><span class="n">array_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, Signal:</span><span class="si">{</span><span class="n">upper</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, noise:</span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Signal-to-noise:</span><span class="si">{</span><span class="n">average_stnr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, Time/channel:</span><span class="si">{</span><span class="n">average_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">sec&#39;</span><span class="p">)</span>

                <span class="c1">#stop = time.time()</span>
                <span class="c1">#duration = stop - start</span>
                <span class="c1">#time_ls.append(duration)</span>
                <span class="c1">#files_processed = file_index + 1</span>
                <span class="c1">#files_to_process = len(paths)</span>
                <span class="c1">#print_progress(files_processed, files_to_process, n_jobs=1, time_ls=time_ls, batch_size=None, operation_type=&quot;Normalizing&quot;)</span>
                
            <span class="n">normalized_stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_normalized</span>
        
        <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_stack.npz&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">save_dtype</span><span class="p">),</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">normalized_stack</span><span class="p">,</span> <span class="n">single_channel</span><span class="p">,</span> <span class="n">arr_2d_normalized</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved stacks: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_normalize_timelapse</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the timelapse data by rescaling the intensity values based on percentiles.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the timelapse data files.</span>
<span class="sd">        lower_percentile (int, optional): The lower percentile used to calculate the intensity range. Defaults to 1.</span>
<span class="sd">        save_dtype (numpy.dtype, optional): The data type to save the normalized stack. Defaults to np.float32.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)]</span>
    <span class="n">output_fldr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;filenames&#39;</span><span class="p">]</span>

        <span class="n">normalized_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">save_dtype</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">chan_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">single_channel</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span>
            <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">array_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">arr_2d</span> <span class="o">=</span> <span class="n">single_channel</span><span class="p">[</span><span class="n">array_index</span><span class="p">]</span>
                <span class="c1"># Calculate the 1% and 98% percentiles for this specific image</span>
                <span class="n">q_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lower_percentile</span><span class="p">)</span>
                <span class="n">q_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">[</span><span class="n">arr_2d</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">98</span><span class="p">)</span>

                <span class="c1"># Rescale intensity based on the calculated percentiles to fill the dtype range</span>
                <span class="n">arr_2d_rescaled</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">rescale_intensity</span><span class="p">(</span><span class="n">arr_2d</span><span class="p">,</span> <span class="n">in_range</span><span class="o">=</span><span class="p">(</span><span class="n">q_low</span><span class="p">,</span> <span class="n">q_high</span><span class="p">),</span> <span class="n">out_range</span><span class="o">=</span><span class="s1">&#39;dtype&#39;</span><span class="p">)</span>
                <span class="n">normalized_stack</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">chan_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_2d_rescaled</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;channels:</span><span class="si">{</span><span class="n">chan_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, arrays:</span><span class="si">{</span><span class="n">array_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">single_channel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1">#stop = time.time()</span>
                <span class="c1">#duration = stop - start</span>
                <span class="c1">#time_ls.append(duration)</span>
                <span class="c1">#files_processed = file_index+1</span>
                <span class="c1">#files_to_process = len(paths)</span>
                <span class="c1">#print_progress(files_processed, files_to_process, n_jobs=1, time_ls=time_ls, batch_size=None, operation_type=&quot;Normalizing&quot;)</span>

        <span class="n">save_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_fldr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_norm_timelapse.npz&#39;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">save_loc</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">normalized_stack</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">normalized_stack</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">filenames</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saved normalized stacks: </span><span class="si">{</span><span class="n">output_fldr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create movies from numpy files per channel.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the numpy files.</span>
<span class="sd">        fps (int, optional): Frames per second for the output movies. Defaults to 10.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span> <span class="nn">.timelapse</span> <span class="kn">import</span> <span class="n">_npz_to_movie</span>
    
    <span class="n">master_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">master_path</span><span class="p">,</span><span class="s1">&#39;movies&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Organize files by plate, well, field</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
    <span class="n">organized_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)_(\w+)_(\w+)_(\d+)\.npy&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">organized_files</span><span class="p">:</span>
                <span class="n">organized_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">organized_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">f</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">file_list</span> <span class="ow">in</span> <span class="n">organized_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">plate</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1">#if array.dtype != np.uint8:</span>
            <span class="c1">#    array = ((array - array.min()) / (array.max() - array.min()) * 255).astype(np.uint8)</span>
            <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arrays</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># Extract the current channel for all time points</span>
        <span class="n">channel_arrays</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">channel</span><span class="p">]</span>
        <span class="c1"># Flatten the channel data to compute global percentiles</span>
        <span class="n">channel_data_flat</span> <span class="o">=</span> <span class="n">channel_arrays</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_data_flat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span>
        <span class="c1"># Normalize and rescale each array in the channel</span>
        <span class="n">normalized_channel_arrays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">arr</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p99</span> <span class="o">-</span> <span class="n">p1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">channel_arrays</span><span class="p">]</span>
        <span class="c1"># Convert the list of 2D arrays into a list of 3D arrays with a single channel</span>
        <span class="n">normalized_channel_arrays_3d</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">normalized_channel_arrays</span><span class="p">]</span>
        <span class="c1"># Save as movie for the current channel</span>
        <span class="n">channel_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plate</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">well</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">_channel_</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.mp4&#39;</span><span class="p">)</span>
        <span class="n">_npz_to_movie</span><span class="p">(</span><span class="n">normalized_channel_arrays_3d</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">channel_save_path</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>

<div class="viewcode-block" id="delete_empty_subdirectories">
<a class="viewcode-back" href="../../spacr.html#spacr.io.delete_empty_subdirectories">[docs]</a>
<span class="k">def</span> <span class="nf">delete_empty_subdirectories</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes all empty subdirectories in the specified folder.</span>

<span class="sd">    Args:</span>
<span class="sd">    - folder_path (str): The path to the folder in which to look for empty subdirectories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check each item in the specified folder</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># os.walk is used with topdown=False to start from the innermost directories and work upwards.</span>
        <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="c1"># Construct the full path to the subdirectory</span>
            <span class="n">full_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
            <span class="c1"># Try to remove the directory and catch any error (like if the directory is not empty)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">full_dir_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted empty directory: </span><span class="si">{</span><span class="n">full_dir_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span></div>

                <span class="c1"># An error occurred, likely because the directory is not empty</span>
                <span class="c1">#print(f&quot;Skipping non-empty directory: {full_dir_path}&quot;)</span>

<span class="c1">#@log_function_call</span>
<div class="viewcode-block" id="preprocess_img_data">
<a class="viewcode-back" href="../../spacr.html#spacr.io.preprocess_img_data">[docs]</a>
<span class="k">def</span> <span class="nf">preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.plot</span> <span class="kn">import</span> <span class="n">plot_arrays</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_run_test_mode</span><span class="p">,</span> <span class="n">_get_regex</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_default_settings_preprocess_img_data</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocesses image data by converting z-stack images to maximum intensity projection (MIP) images.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the z-stack images.</span>
<span class="sd">        metadata_type (str, optional): The type of metadata associated with the images. Defaults to &#39;cellvoyager&#39;.</span>
<span class="sd">        custom_regex (str, optional): The custom regular expression pattern used to match the filenames of the z-stack images. Defaults to None.</span>
<span class="sd">        cmap (str, optional): The colormap used for plotting. Defaults to &#39;inferno&#39;.</span>
<span class="sd">        figuresize (int, optional): The size of the figure for plotting. Defaults to 15.</span>
<span class="sd">        normalize (bool, optional): Whether to normalize the images. Defaults to False.</span>
<span class="sd">        nr (int, optional): The number of images to preprocess. Defaults to 1.</span>
<span class="sd">        plot (bool, optional): Whether to plot the images. Defaults to False.</span>
<span class="sd">        mask_channels (list, optional): The channels to use for masking. Defaults to [0, 1, 2].</span>
<span class="sd">        batch_size (list, optional): The number of images to process in each batch. Defaults to [100, 100, 100].</span>
<span class="sd">        timelapse (bool, optional): Whether the images are from a timelapse experiment. Defaults to False.</span>
<span class="sd">        remove_background (bool, optional): Whether to remove the background from the images. Defaults to False.</span>
<span class="sd">        backgrounds (int, optional): The number of background images to use for background removal. Defaults to 100.</span>
<span class="sd">        lower_percentile (float, optional): The lower percentile used for background removal. Defaults to 1.</span>
<span class="sd">        save_dtype (type, optional): The data type used for saving the preprocessed images. Defaults to np.float32.</span>
<span class="sd">        randomize (bool, optional): Whether to randomize the order of the images. Defaults to True.</span>
<span class="sd">        all_to_mip (bool, optional): Whether to convert all images to MIP. Defaults to False.</span>
<span class="sd">        pick_slice (bool, optional): Whether to pick a specific slice based on the provided skip mode. Defaults to False.</span>
<span class="sd">        skip_mode (str, optional): The skip mode used to filter out specific slices. Defaults to &#39;01&#39;.</span>
<span class="sd">        settings (dict, optional): Additional settings for preprocessing. Defaults to {}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tif&#39;</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="n">extension_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
    <span class="n">most_common_extension</span> <span class="o">=</span> <span class="n">extension_counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">img_format</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">delete_empty_subdirectories</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

    <span class="c1"># Check if the most common extension is one of the specified image formats</span>
    <span class="k">if</span> <span class="n">most_common_extension</span> <span class="ow">in</span> <span class="n">valid_ext</span><span class="p">:</span>
        <span class="n">img_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="n">most_common_extension</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">most_common_extension</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find any </span><span class="si">{</span><span class="n">valid_ext</span><span class="si">}</span><span class="s1"> files in </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1"> only found </span><span class="si">{</span><span class="n">extension_counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        
        
        
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;stack&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing stack folder.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;channel_stack&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing channel_stack folder.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found existing norm_channel_stack folder. Skipping preprocessing&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span>
        
    <span class="n">mask_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_channel&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_channel&#39;</span><span class="p">]]</span>
    <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nucleus_background&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cell_background&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_background&#39;</span><span class="p">]]</span>

    <span class="n">settings</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">custom_regex</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">lower_percentile</span><span class="p">,</span> <span class="n">randomize</span><span class="p">,</span> <span class="n">all_to_mip</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">save_dtype</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">random_test</span> <span class="o">=</span> <span class="n">set_default_settings_preprocess_img_data</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">regex</span> <span class="o">=</span> <span class="n">_get_regex</span><span class="p">(</span><span class="n">metadata_type</span><span class="p">,</span> <span class="n">img_format</span><span class="p">,</span> <span class="n">custom_regex</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_mode</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running spacr in test mode&#39;</span><span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted test directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">src</span> <span class="o">=</span> <span class="n">_run_test_mode</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">test_images</span><span class="p">,</span> <span class="n">random_test</span><span class="p">)</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>
    
    <span class="n">stack_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;stack&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
            <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>   
   
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stack_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">img_format</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
                    <span class="n">_move_to_chan_folder</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">timelapse</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_rename_and_organize_image_files</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">pick_slice</span><span class="p">,</span> <span class="n">skip_mode</span><span class="p">,</span> <span class="n">metadata_type</span><span class="p">,</span> <span class="n">img_format</span><span class="p">)</span>
                    
                    <span class="c1">#Make sure no batches will be of only one image</span>
                    <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
                    <span class="n">full_batches</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">//</span> <span class="n">batch_size</span>
                    <span class="n">last_batch_size</span> <span class="o">=</span> <span class="n">all_imgs</span> <span class="o">%</span> <span class="n">batch_size</span>
                    
                    <span class="c1"># Check if the last batch is of size 1</span>
                    <span class="k">if</span> <span class="n">last_batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># If there&#39;s only one batch and its size is 1, it&#39;s also an issue</span>
                        <span class="k">if</span> <span class="n">full_batches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
                        <span class="c1"># If the last batch is of size 1, merge it with the second last batch</span>
                        <span class="k">elif</span> <span class="n">full_batches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;all images: </span><span class="si">{</span><span class="n">all_imgs</span><span class="si">}</span><span class="s2">,  full batch: </span><span class="si">{</span><span class="n">full_batches</span><span class="si">}</span><span class="s2">, last batch: </span><span class="si">{</span><span class="n">last_batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Last batch of size 1 detected. Adjust the batch size.&quot;</span><span class="p">)</span>
        
                <span class="n">_merge_channels</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">timelapse</span><span class="p">:</span>
                    <span class="n">_create_movies_from_npy_per_channel</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/stack&#39;</span><span class="p">)</span>
                    <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">all_to_mip</span><span class="p">:</span>
                    <span class="n">_mip_all</span><span class="p">(</span><span class="n">stack_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;plotting </span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1"> images from </span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/stack&#39;</span><span class="p">)</span>
                        <span class="n">plot_arrays</span><span class="p">(</span><span class="n">stack_path</span><span class="p">,</span> <span class="n">figuresize</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">nr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">concatenate_and_normalize</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">stack_path</span><span class="p">,</span>
                              <span class="n">channels</span><span class="o">=</span><span class="n">mask_channels</span><span class="p">,</span>
                              <span class="n">save_dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                              <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

    <span class="c1">#if plot:</span>
    <span class="c1">#    _plot_4D_arrays(src+&#39;/norm_channel_stack&#39;, nr_npz=1, nr=nr)</span>

    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">src</span></div>

    
<span class="k">def</span> <span class="nf">_check_masks</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_filenames</span><span class="p">,</span> <span class="n">output_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the masks in a batch and filter out the ones that already exist in the output folder.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (list): List of masks.</span>
<span class="sd">        batch_filenames (list): List of filenames corresponding to the masks.</span>
<span class="sd">        output_folder (str): Path to the output folder.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the filtered batch (numpy array) and the filtered filenames (list).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a mask for filenames that are already present in the output folder</span>
    <span class="n">existing_files_mask</span> <span class="o">=</span> <span class="p">[</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">batch_filenames</span><span class="p">]</span>

    <span class="c1"># Use the mask to filter the batch and batch_filenames</span>
    <span class="n">filtered_batch</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">existing_files_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">exists</span><span class="p">]</span>
    <span class="n">filtered_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_filenames</span><span class="p">,</span> <span class="n">existing_files_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">exists</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_batch</span><span class="p">),</span> <span class="n">filtered_filenames</span>

<span class="k">def</span> <span class="nf">_get_avg_object_size</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the average size of objects in a list of masks.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    masks (list): A list of masks representing objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">    float: The average size of objects in the masks. Returns 0 if no objects are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">object_areas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
        <span class="c1"># Check if the mask is a 2D or 3D array and is not empty</span>
        <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">regionprops</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">object_areas</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask is empty. &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mask is not in the correct format. dim: </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="k">if</span> <span class="n">object_areas</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">object_areas</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_areas</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># Return 0 if no objects are found</span>
    
<span class="k">def</span> <span class="nf">_save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">all_folders</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a figure to a specified location.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    fig (matplotlib.figure.Figure): The figure to be saved.</span>
<span class="sd">    src (str): The source file path.</span>
<span class="sd">    text (str): The text to be included in the figure name.</span>
<span class="sd">    dpi (int, optional): The resolution of the saved figure. Defaults to 300.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">obj_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_folder</span><span class="p">)</span>
    <span class="n">save_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj_type</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s1">.pdf&#39;</span>        
    <span class="n">save_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">fig_name</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_location</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

    <span class="n">files_processed</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">all_folders</span>
    <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Saving Figures&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved single cell figure: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_location</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">fig</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    
<span class="k">def</span> <span class="nf">_read_and_join_tables</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">table_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;png_list&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads and joins tables from a SQLite database.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_path (str): The path to the SQLite database file.</span>
<span class="sd">        table_names (list, optional): The names of the tables to read and join. Defaults to [&#39;cell&#39;, &#39;cytoplasm&#39;, &#39;nucleus&#39;, &#39;pathogen&#39;, &#39;png_list&#39;].</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: The joined DataFrame containing the data from the specified tables, or None if an error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span>
    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">dataframes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataframes</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DatabaseError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> not found in the database.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;png_list&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">][[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;png_path&#39;</span><span class="p">,</span> <span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;row_name&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">,</span> <span class="s1">&#39;field&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">png_list_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cell_id&#39;</span><span class="p">:</span> <span class="s1">&#39;object_label&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
            <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;plate&#39;</span><span class="p">,</span> <span class="s1">&#39;row_name&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">]</span>
            <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span> <span class="n">png_list_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">join_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cell table not found in database tables.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">png_list_df</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
            <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">non_numeric_cols</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">agg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">}</span>
            <span class="n">agg_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;first&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">non_numeric_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">]})</span>
            <span class="n">grouping_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">]</span>
            <span class="n">agg_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_cols</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_dict</span><span class="p">)</span>
            <span class="n">agg_df</span><span class="p">[</span><span class="s1">&#39;count_&#39;</span> <span class="o">+</span> <span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouping_cols</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_df</span>
    <span class="n">joined_df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
        <span class="n">joined_df</span> <span class="o">=</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;cytoplasm&#39;</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
        <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">[</span><span class="s1">&#39;cytoplasm&#39;</span><span class="p">],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_cytoplasm&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">dataframes</span><span class="p">:</span>
            <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined_df</span><span class="p">,</span> <span class="n">dataframes</span><span class="p">[</span><span class="n">entity</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">joined_df</span>
    
<span class="k">def</span> <span class="nf">_save_settings_to_db</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the settings dictionary to a SQLite database.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): A dictionary containing the settings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert the settings dictionary into a DataFrame</span>
    <span class="n">settings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;setting_key&#39;</span><span class="p">,</span> <span class="s1">&#39;setting_value&#39;</span><span class="p">])</span>
    <span class="c1"># Convert all values in the &#39;setting_value&#39; column to strings</span>
    <span class="n">settings_df</span><span class="p">[</span><span class="s1">&#39;setting_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_df</span><span class="p">[</span><span class="s1">&#39;setting_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">settings_df</span><span class="p">)</span>
    <span class="c1"># Determine the directory path</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s1">/measurements&#39;</span>
    <span class="c1"># Create the directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Database connection and saving the settings DataFrame</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/measurements.db&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">settings_df</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Replace the table if it already exists</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_save_mask_timelapse_as_gif</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">tracks_df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a timelapse animation of masks as a GIF.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - masks (list): List of mask frames.</span>
<span class="sd">    - tracks_df (pandas.DataFrame): DataFrame containing track information.</span>
<span class="sd">    - path (str): Path to save the GIF file.</span>
<span class="sd">    - cmap (str or matplotlib.colors.Colormap): Colormap for displaying the masks.</span>
<span class="sd">    - norm (matplotlib.colors.Normalize): Normalization for the colormap.</span>
<span class="sd">    - filenames (list): List of filenames corresponding to each mask frame.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set the face color for the figure to black</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  <span class="c1"># Set the axes background color to black</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Turn off the axis</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Adjust the subplot edges</span>

    <span class="n">filename_text_obj</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize a variable to keep track of the text object</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the frame of the animation.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - frame (int): The frame number to update.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">filename_text_obj</span>  <span class="c1"># Reference the nonlocal variable to update it</span>
        <span class="k">if</span> <span class="n">filename_text_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename_text_obj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># Remove the previous text object if it exists</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear the axis to draw the new frame</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Ensure axis is still off after clearing</span>
        <span class="n">current_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">current_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Frame: </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

        <span class="c1"># Add the filename as text on the figure</span>
        <span class="n">filename_text</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>  <span class="c1"># Get the filename corresponding to the current frame</span>
        <span class="n">filename_text_obj</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">filename_text</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># Adjust text position, size, and color as needed</span>

        <span class="c1"># Annotate each object with its label number from the mask</span>
        <span class="k">for</span> <span class="n">label_value</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">current_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>  <span class="c1"># Skip background</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_mask</span> <span class="o">==</span> <span class="n">label_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">label_value</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Overlay tracks</span>
        <span class="k">if</span> <span class="n">tracks_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">_track</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="p">[</span><span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;track_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_track</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">_track</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">_update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">),</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>  <span class="c1"># Adjust DPI for size/quality</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saved timelapse to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_save_object_counts_to_database</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">object_type</span><span class="p">,</span> <span class="n">file_names</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">added_string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the counts of unique objects in masks to a SQLite database.</span>

<span class="sd">    Args:</span>
<span class="sd">        arrays (List[np.ndarray]): List of masks.</span>
<span class="sd">        object_type (str): Type of object.</span>
<span class="sd">        file_names (List[str]): List of file names corresponding to the masks.</span>
<span class="sd">        db_path (str): Path to the SQLite database.</span>
<span class="sd">        added_string (str): Additional string to append to the count type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_count_objects</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count unique objects in a mask, assuming 0 is the background.&quot;&quot;&quot;</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Assuming 0 is the background label, remove it from the count</span>
        <span class="k">if</span> <span class="n">unique</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique</span><span class="p">)</span>

    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">file_names</span><span class="p">):</span>
        <span class="n">object_count</span> <span class="o">=</span> <span class="n">_count_objects</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">count_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">object_type</span><span class="si">}{</span><span class="n">added_string</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Append a tuple of (file_name, count_type, object_count) to the records list</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_name</span><span class="p">,</span> <span class="n">count_type</span><span class="p">,</span> <span class="n">object_count</span><span class="p">))</span>

    <span class="c1"># Connect to the database</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Create the table if it doesn&#39;t exist</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    CREATE TABLE IF NOT EXISTS object_counts (</span>
<span class="s1">        file_name TEXT,</span>
<span class="s1">        count_type TEXT,</span>
<span class="s1">        object_count INTEGER,</span>
<span class="s1">        PRIMARY KEY (file_name, count_type)</span>
<span class="s1">    )</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Batch insert or update the object counts</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    INSERT INTO object_counts (file_name, count_type, object_count)</span>
<span class="s1">    VALUES (?, ?, ?)</span>
<span class="s1">    ON CONFLICT(file_name, count_type) DO UPDATE SET</span>
<span class="s1">    object_count = excluded.object_count</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>

    <span class="c1"># Commit changes and close the database connection</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_create_database</span><span class="p">(</span><span class="n">db_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a SQLite database at the specified path.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_path (str): The path where the database should be created.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
    
<span class="k">def</span> <span class="nf">_load_and_concatenate_arrays</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">cell_chann_dim</span><span class="p">,</span> <span class="n">nucleus_chann_dim</span><span class="p">,</span> <span class="n">pathogen_chann_dim</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and concatenate arrays from multiple folders.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The source directory containing the arrays.</span>
<span class="sd">        channels (list): List of channel indices to select from the arrays.</span>
<span class="sd">        cell_chann_dim (int): Dimension of the cell channel.</span>
<span class="sd">        nucleus_chann_dim (int): Dimension of the nucleus channel.</span>
<span class="sd">        pathogen_chann_dim (int): Dimension of the pathogen channel.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folder_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="o">+</span><span class="s1">&#39;/stack&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">cell_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_mask_stack&#39;</span><span class="p">)):</span>
        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span><span class="s1">&#39;cell_mask_stack&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">nucleus_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus_mask_stack&#39;</span><span class="p">)):</span>
        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span><span class="s1">&#39;nucleus_mask_stack&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">pathogen_chann_dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen_mask_stack&#39;</span><span class="p">)):</span>
        <span class="n">folder_paths</span> <span class="o">=</span> <span class="n">folder_paths</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;norm_channel_stack&#39;</span><span class="p">,</span><span class="s1">&#39;pathogen_mask_stack&#39;</span><span class="p">)]</span>

    <span class="n">output_folder</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;/merged&#39;</span>
    <span class="n">reference_folder</span> <span class="o">=</span> <span class="n">folder_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_imgs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">))</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Iterate through each file in the reference folder</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">)):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Check if this file exists in all the other specified folders</span>
            <span class="n">exists_in_all_folders</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span> <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_paths</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exists_in_all_folders</span><span class="p">:</span>
                <span class="c1"># Load and potentially modify the array from the reference folder</span>
                <span class="n">ref_array_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reference_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">concatenated_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ref_array_path</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">concatenated_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">concatenated_array</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Add the array from the reference folder to &#39;stack_ls&#39;</span>
                <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concatenated_array</span><span class="p">)</span>

                <span class="c1"># For each of the other folders, load the array and add it to &#39;stack_ls&#39;</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">array_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="c1">#array = np.load(array_path)</span>
                    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">array_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Add an extra dimension if the array is 2D</span>
                    <span class="n">stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stack_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">]</span>
                <span class="n">unique_shapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_shapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1">#max_dims = np.max(np.array(list(unique_shapes)), axis=0)</span>
                    <span class="c1"># Determine the maximum length of tuples in unique_shapes</span>
                    <span class="n">max_tuple_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">unique_shapes</span><span class="p">)</span>
                    <span class="c1"># Pad shorter tuples with zeros to make them all the same length</span>
                    <span class="n">padded_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_tuple_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">unique_shapes</span><span class="p">]</span>
                    <span class="c1"># Now create a NumPy array and find the maximum dimensions</span>
                    <span class="n">max_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">padded_shapes</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: arrays with multiple shapes found. Padding arrays to max X,Y dimentions </span><span class="si">{</span><span class="n">max_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1">#print(f&#39;Warning: arrays with multiple shapes found. Padding arrays to max X,Y dimentions {max_dims}&#39;, end=&#39;\r&#39;, flush=True)</span>
                    <span class="n">padded_stack_ls</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">stack_ls</span><span class="p">:</span>
                        <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dim</span> <span class="o">-</span> <span class="n">dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">max_dim</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">max_dims</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
                        <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">padded_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">)</span>
                        <span class="n">padded_stack_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_arr</span><span class="p">)</span>
                    <span class="c1"># Concatenate the padded arrays along the channel dimension (last dimension)</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">padded_stack_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">stack_ls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">concatenated_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
        
        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">files_processed</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">files_to_process</span> <span class="o">=</span> <span class="n">all_imgs</span>
        <span class="n">print_progress</span><span class="p">(</span><span class="n">files_processed</span><span class="p">,</span> <span class="n">files_to_process</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="n">time_ls</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Merging Arrays&quot;</span><span class="p">)</span>

    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read data from a SQLite database.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - db_loc (str): The location of the SQLite database file.</span>
<span class="sd">    - tables (list): A list of table names to read from.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - dfs (list): A list of pandas DataFrames, each containing the data from a table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span>
    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">dfs</span>
    
<span class="k">def</span> <span class="nf">_results_to_csv</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_well</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the given dataframes as CSV files in the specified directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        src (str): The directory path where the CSV files will be saved.</span>
<span class="sd">        df (pandas.DataFrame): The dataframe containing cell data.</span>
<span class="sd">        df_well (pandas.DataFrame): The dataframe containing well data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the cell dataframe and well dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">df</span>
    <span class="n">wells</span> <span class="o">=</span> <span class="n">df_well</span>
    <span class="n">results_loc</span> <span class="o">=</span> <span class="n">src</span><span class="o">+</span><span class="s1">&#39;/results&#39;</span>
    <span class="n">wells_loc</span> <span class="o">=</span> <span class="n">results_loc</span><span class="o">+</span><span class="s1">&#39;/wells.csv&#39;</span>
    <span class="n">cells_loc</span> <span class="o">=</span> <span class="n">results_loc</span><span class="o">+</span><span class="s1">&#39;/cells.csv&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_loc</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">wells</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">wells_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cells</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">cells_loc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cells</span><span class="p">,</span> <span class="n">wells</span>

<div class="viewcode-block" id="read_plot_model_stats">
<a class="viewcode-back" href="../../spacr.html#spacr.io.read_plot_model_stats">[docs]</a>
<span class="k">def</span> <span class="nf">read_plot_model_stats</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">val_file_path</span> <span class="p">,</span><span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">):</span>
        
        <span class="n">pdf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">)</span>

        <span class="c1"># Create subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plotting</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">val_df</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="c1"># Set titles and labels</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Validation </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> vs. Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdf_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Read the CSVs into DataFrames</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">val_file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Get the folder path for saving plots</span>
    <span class="n">fldr_1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">train_file_path</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="c1"># Setting the style</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
    
    <span class="c1"># Plot and save the results</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;prauc&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span>
    <span class="n">_plot_and_save</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;optimal_threshold&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">fldr_1</span><span class="p">)</span></div>

    
<span class="k">def</span> <span class="nf">_save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">results_df</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">intermedeate_save</span><span class="o">=</span><span class="p">[</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.98</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.94</span><span class="p">],</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the model based on certain conditions during training.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The trained model to be saved.</span>
<span class="sd">        model_type (str): The type of the model.</span>
<span class="sd">        results_df (pandas.DataFrame): The dataframe containing the training results.</span>
<span class="sd">        dst (str): The destination directory to save the model.</span>
<span class="sd">        epoch (int): The current epoch number.</span>
<span class="sd">        epochs (int): The total number of epochs.</span>
<span class="sd">        intermedeate_save (list, optional): List of accuracy thresholds to trigger intermediate model saves. </span>
<span class="sd">                                            Defaults to [0.99, 0.98, 0.95, 0.94].</span>
<span class="sd">        channels (list, optional): List of channels used. Defaults to [&#39;r&#39;, &#39;g&#39;, &#39;b&#39;].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">channels_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">save_model_at_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">percentile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found: </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s1">% accurate model&#39;</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">_acc_</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s1">_channels_</span><span class="si">{</span><span class="n">channels_str</span><span class="si">}</span><span class="s1">.pth&#39;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">epoch</span> <span class="o">==</span> <span class="n">epochs</span><span class="p">:</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1">_epoch_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span><span class="si">}</span><span class="s1">_channels_</span><span class="si">{</span><span class="n">channels_str</span><span class="si">}</span><span class="s1">.pth&#39;</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_path</span>

    <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">intermedeate_save</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nc class accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;neg_accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Pc class Accuracy: </span><span class="si">{</span><span class="n">results_df</span><span class="p">[</span><span class="s1">&#39;pos_accuracy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="n">save_model_at_threshold</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="n">model_path</span>

<span class="k">def</span> <span class="nf">_save_progress</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the progress of the classification model.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    dst (str): The destination directory to save the progress.</span>
<span class="sd">    train_df (pandas.DataFrame): The DataFrame containing training stats.</span>
<span class="sd">    validation_df (pandas.DataFrame): The DataFrame containing validation stats (if available).</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_save_df_to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the given DataFrame to the specified CSV file, either creating a new file or appending to an existing one.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        file_path (str): The file path where the CSV will be saved.</span>
<span class="sd">        df (pandas.DataFrame): The DataFrame to save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>  <span class="c1"># Ensure data is written to the file system</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                
    <span class="c1"># Save accuracy, loss, PRAUC</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results_path_train</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train.csv&#39;</span><span class="p">)</span>
    <span class="n">results_path_validation</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;validation.csv&#39;</span><span class="p">)</span>

    <span class="c1"># Save training data</span>
    <span class="n">_save_df_to_csv</span><span class="p">(</span><span class="n">results_path_train</span><span class="p">,</span> <span class="n">train_df</span><span class="p">)</span>

    <span class="c1"># Save validation data if available</span>
    <span class="k">if</span> <span class="n">validation_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_save_df_to_csv</span><span class="p">(</span><span class="n">results_path_validation</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">)</span>

        <span class="c1"># Call read_plot_model_stats after ensuring the files are saved</span>
        <span class="n">read_plot_model_stats</span><span class="p">(</span><span class="n">results_path_train</span><span class="p">,</span> <span class="n">results_path_validation</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_copy_missclassified</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">misclassified</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;true_label&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;predicted_label&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">misclassified</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">original_path</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">original_path</span><span class="p">)</span>
        <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">original_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;pc&quot;</span> <span class="ow">in</span> <span class="n">original_path</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s2">&quot;missclassified/pc&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="s2">&quot;missclassified/nc&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">new_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">original_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">misclassified</span><span class="p">)</span><span class="si">}</span><span class="s2"> misclassified images.&quot;</span><span class="p">)</span>
    <span class="k">return</span>
    
<span class="k">def</span> <span class="nf">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">):</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">rename_columns_in_db</span>
    
    <span class="n">rename_columns_in_db</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span> <span class="c1"># Create a connection to the database</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Write a SQL query to get the data from the database</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span> <span class="c1"># Use the read_sql_query function to get the data and save it as a DataFrame</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Close the connection</span>
    <span class="k">return</span> <span class="n">dfs</span>

<span class="k">def</span> <span class="nf">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nuclei_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pathogen_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">change_plate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">_read_db</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_split_data</span>

    <span class="c1"># Initialize an empty dictionary to store DataFrames by table name</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">table</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">}</span>

    <span class="c1"># Extract plate DataFrames</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">locs</span><span class="p">):</span>
        <span class="n">db_dfs</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">change_plate</span><span class="p">:</span>
            <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;plate</span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;row_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">db_dfs</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">db_dfs</span><span class="p">):</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Concatenate rows across locations for each table</span>
    <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">dfs</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dfs</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize merged DataFrame with &#39;cells&#39; if available</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># Process each table</span>
    <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
        <span class="n">cells_g_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cells</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">cells_g_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="si">}</span><span class="s1">, cells grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cells_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;cytoplasm&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;cytoplasm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">cytoplasms</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">cytoplasms</span> <span class="o">=</span> <span class="n">cytoplasms</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">)</span><span class="si">}</span><span class="s1">, cytoplasms grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cytoplasms_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;object_label&#39;</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cytoplasms_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cytoplasms: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms</span><span class="p">)</span><span class="si">}</span><span class="s1">, cytoplasms grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cytoplasms_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;nucleus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">nucleus</span><span class="p">[</span><span class="s1">&#39;nucleus_prcfo_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nucleus</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">)[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nuclei_limit</span><span class="p">:</span>
            <span class="n">nucleus</span> <span class="o">=</span> <span class="n">nucleus</span><span class="p">[</span><span class="n">nucleus</span><span class="p">[</span><span class="s1">&#39;nucleus_prcfo_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus</span><span class="p">)</span><span class="si">}</span><span class="s1">, nucleus grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nucleus_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">nucleus</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">nucleus_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;nucleus: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus</span><span class="p">)</span><span class="si">}</span><span class="s1">, nucleus grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">object_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cell_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;prcf&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
        <span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathogens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">)[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pathogen_limit</span><span class="p">:</span>
            <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="p">[</span><span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">pathogens</span> <span class="o">=</span> <span class="n">pathogens</span><span class="p">[</span><span class="n">pathogens</span><span class="p">[</span><span class="s1">&#39;pathogen_prcfo_count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pathogen_limit</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">]):</span>
            <span class="n">merged_df</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">pathogens</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogens: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens</span><span class="p">)</span><span class="si">}</span><span class="s1">, pathogens grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathogens_g_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">pathogens</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
            <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pathogens_g_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pathogens: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens</span><span class="p">)</span><span class="si">}</span><span class="s1">, pathogens grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pathogens_g_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="s1">&#39;png_list&#39;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">png_list</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">png_list_g_df_numeric</span><span class="p">,</span> <span class="n">png_list_g_df_non_numeric</span> <span class="o">=</span> <span class="n">_split_data</span><span class="p">(</span><span class="n">png_list</span><span class="p">,</span> <span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">)</span>
        <span class="n">png_list_g_df_non_numeric</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">,</span><span class="s1">&#39;row_name&#39;</span><span class="p">,</span><span class="s1">&#39;column_name&#39;</span><span class="p">,</span><span class="s1">&#39;field&#39;</span><span class="p">,</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prcf&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;png_list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">png_list</span><span class="p">)</span><span class="si">}</span><span class="s1">, png_list grouped: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">png_list_g_df_numeric</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added png_list columns: </span><span class="si">{</span><span class="n">png_list_g_df_numeric</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">png_list_g_df_non_numeric</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">png_list_g_df_numeric</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">png_list_g_df_non_numeric</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="c1"># Add prc (plate row column) and prcfo (plate row column field object) columns</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;row_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">])</span>
    <span class="n">cells_well</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;prc&#39;</span><span class="p">)[</span><span class="s1">&#39;object_label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cells_per_well&#39;</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cells_well</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;prc&#39;</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">prcfo</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;plate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;row_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;object_label&#39;</span><span class="p">])</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;prcfo&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Merge metadata with final merged DataFrame</span>
    <span class="c1">#merged_df = metadata.merge(merged_df, left_index=True, right_index=True).dropna(axis=1)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">merged_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;label_list_morphology&#39;</span><span class="p">,</span> <span class="s1">&#39;label_list_intensity&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated dataframe with: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1"> columns and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> rows&#39;</span><span class="p">)</span>
    
    <span class="c1"># Prepare object DataFrames for output</span>
    <span class="n">obj_df_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_dict</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">merged_df</span><span class="p">,</span> <span class="n">obj_df_ls</span>
    
<span class="k">def</span> <span class="nf">_read_mask</span><span class="p">(</span><span class="n">mask_path</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">imageio2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">img_as_uint</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span>

<div class="viewcode-block" id="convert_numpy_to_tiff">
<a class="viewcode-back" href="../../spacr.html#spacr.io.convert_numpy_to_tiff">[docs]</a>
<span class="k">def</span> <span class="nf">convert_numpy_to_tiff</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts all numpy files in a folder to TIFF format and saves them in a subdirectory &#39;tiff&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    folder_path (str): The path to the folder containing numpy files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the subdirectory &#39;tiff&#39; within the specified folder if it doesn&#39;t already exist</span>
    <span class="n">tiff_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="s1">&#39;tiff&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>

    <span class="n">npy_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)]</span>
    
    <span class="c1"># Iterate over all files in the folder</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Construct the full file path</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Load the numpy file</span>
        <span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="c1"># Construct the output TIFF file path</span>
        <span class="n">tiff_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
        <span class="n">tiff_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tiff_subdir</span><span class="p">,</span> <span class="n">tiff_filename</span><span class="p">)</span>
        
        <span class="c1"># Save the numpy array as a TIFF file</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tiff_file_path</span><span class="p">,</span> <span class="n">numpy_array</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">tiff_filename</span><span class="si">}</span><span class="s2"> and saved in &#39;tiff&#39; subdirectory.&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>

    
<div class="viewcode-block" id="generate_cellpose_train_test">
<a class="viewcode-back" href="../../spacr.html#spacr.io.generate_cellpose_train_test">[docs]</a>
<span class="k">def</span> <span class="nf">generate_cellpose_train_test</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">mask_src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;*.tif&#39;</span><span class="p">))</span>
    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">]</span>
    <span class="n">img_filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">img_filenames</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">file</span><span class="p">))]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span><span class="si">}</span><span class="s1"> images with masks&#39;</span><span class="p">)</span>
    
    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span>
    <span class="n">split_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_filenames</span><span class="p">)</span> <span class="o">*</span> <span class="n">test_split</span><span class="p">)</span>
    <span class="n">train_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[</span><span class="n">split_index</span><span class="p">:]</span>
    <span class="n">test_files</span> <span class="o">=</span> <span class="n">img_filenames</span><span class="p">[:</span><span class="n">split_index</span><span class="p">]</span>
    <span class="n">list_of_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_files</span><span class="p">,</span> <span class="n">train_files</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Split dataset into Train </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> and Test </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> files&#39;</span><span class="p">)</span>
    
    <span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">train_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    <span class="n">test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="n">test_dir_masks</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;masks&#39;</span><span class="p">)</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_dir_masks</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">list_of_lists</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">test_dir</span>
            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">test_dir_masks</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">train_dir</span>
            <span class="n">dst_mask</span> <span class="o">=</span> <span class="n">train_dir_masks</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span>
            
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_src</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">new_img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">new_mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_mask</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>            
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">new_img_path</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask_path</span><span class="p">,</span> <span class="n">new_mask_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Copied </span><span class="si">{</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images to </span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s1"> set&#39;</span><span class="p">)</span><span class="c1">#, end=&#39;\r&#39;, flush=True)</span></div>


<div class="viewcode-block" id="parse_gz_files">
<a class="viewcode-back" href="../../spacr.html#spacr.io.parse_gz_files">[docs]</a>
<span class="k">def</span> <span class="nf">parse_gz_files</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the .fastq.gz files in the specified folder path and returns a dictionary</span>
<span class="sd">    containing the sample names and their corresponding file paths.</span>

<span class="sd">    Args:</span>
<span class="sd">        folder_path (str): The path to the folder containing the .fastq.gz files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where the keys are the sample names and the values are</span>
<span class="sd">        dictionaries containing the file paths for the &#39;R1&#39; and &#39;R2&#39; read directions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="n">gz_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fastq.gz&#39;</span><span class="p">)]</span>

    <span class="n">samples_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">gz_file</span> <span class="ow">in</span> <span class="n">gz_files</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">gz_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">sample_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">read_direction</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sample_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">samples_dict</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R1&quot;</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">read_direction</span> <span class="o">==</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span>
            <span class="n">samples_dict</span><span class="p">[</span><span class="n">sample_name</span><span class="p">][</span><span class="s1">&#39;R2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">gz_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">samples_dict</span></div>


<div class="viewcode-block" id="generate_dataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.generate_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">generate_dataset</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="p">{}):</span>
    
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">initiate_counter</span><span class="p">,</span> <span class="n">add_images_to_tar</span><span class="p">,</span> <span class="n">save_settings</span><span class="p">,</span> <span class="n">generate_path_list_from_db</span><span class="p">,</span> <span class="n">correct_paths</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_dataset_defaults</span>

    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;generate_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
            <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">)</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">generate_path_list_from_db</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">file_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">])</span>
            <span class="n">correct_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
            <span class="n">all_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_paths</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random selection of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_paths</span> <span class="o">=</span> <span class="n">all_paths</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All paths: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths&quot;</span><span class="p">)</span>

    <span class="n">total_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images&quot;</span><span class="p">)</span>

    <span class="c1"># Create a temp folder in dst</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s2">&quot;temp_tars&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Chunking the data</span>
    <span class="n">num_procs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_procs</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">)</span> <span class="o">%</span> <span class="n">num_procs</span>

    <span class="n">paths_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">paths_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_paths</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>

    <span class="n">temp_tar_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.tar&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating temporary tar files in </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize shared counter and lock</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">initiate_counter</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">lock</span><span class="p">))</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">add_images_to_tar</span><span class="p">,</span> <span class="p">[(</span><span class="n">paths_chunks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp_tar_files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">total_images</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)])</span>

    <span class="c1"># Combine the temporary tar files into a final tar</span>
    <span class="n">date_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">date_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_combined&quot;</span>
    <span class="c1">#if not settings[&#39;file_metadata&#39;] is None:</span>
    <span class="c1">#    tar_name = f&quot;{date_name}_{settings[&#39;experiment&#39;]}_{settings[&#39;file_metadata&#39;]}.tar&quot;</span>
    <span class="c1">#else:</span>
    <span class="n">tar_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.tar&quot;</span>
    <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tar_name</span><span class="p">):</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tar_name_2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;file_metadata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2">.tar&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name</span><span class="p">)</span><span class="si">}</span><span class="s2"> exists, saving as </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tar_name_2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="n">tar_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">tar_name_2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging temporary files&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tar_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">final_tar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">temp_tar_path</span> <span class="ow">in</span> <span class="n">temp_tar_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_tar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">temp_tar</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
                    <span class="n">final_tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_tar_path</span><span class="p">)</span>

    <span class="c1"># Delete the temp folder</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saved </span><span class="si">{</span><span class="n">total_images</span><span class="si">}</span><span class="s2"> images to </span><span class="si">{</span><span class="n">tar_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tar_name</span></div>


<div class="viewcode-block" id="generate_loaders">
<a class="viewcode-back" href="../../spacr.html#spacr.io.generate_loaders">[docs]</a>
<span class="k">def</span> <span class="nf">generate_loaders</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">,</span><span class="s1">&#39;pc&#39;</span><span class="p">],</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate data loaders for training and validation/test datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - src (str): The source directory containing the data.</span>
<span class="sd">    - mode (str): The mode of operation. Options are &#39;train&#39; or &#39;test&#39;.</span>
<span class="sd">    - image_size (int): The size of the input images.</span>
<span class="sd">    - batch_size (int): The batch size for the data loaders.</span>
<span class="sd">    - classes (list): The list of classes to consider.</span>
<span class="sd">    - n_jobs (int): The number of worker threads for data loading.</span>
<span class="sd">    - validation_split (float): The fraction of data to use for validation.</span>
<span class="sd">    - pin_memory (bool): Whether to pin memory for faster data transfer.</span>
<span class="sd">    - normalize (bool): Whether to normalize the input images.</span>
<span class="sd">    - verbose (bool): Whether to print additional information and show images.</span>
<span class="sd">    - channels (list): The list of channels to retain. Options are [1, 2, 3] for all channels, [1, 2] for blue and green, etc.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - train_loaders (list): List of data loaders for training datasets.</span>
<span class="sd">    - val_loaders (list): List of data loaders for validation datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">SelectChannels</span><span class="p">,</span> <span class="n">augment_dataset</span>

    <span class="n">chans</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">channels</span> <span class="o">=</span> <span class="n">chans</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Training a network on channels: </span><span class="si">{</span><span class="n">channels</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Channel 1: Red, Channel 2: Green, Channel 3: Blue&#39;</span><span class="p">)</span>
        
    <span class="n">train_loaders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">)),</span>
            <span class="n">SelectChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading Train and validation datasets&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">val_loaders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading test dataset&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mode:</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> is not valid, use mode = train or test&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">class_1_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">class_2_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_1_path</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">class_2_path</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;One or more classes not found in </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Possible class names are </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">spacrDataset</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">)</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">validation_split</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">validation_split</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">val_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">train_size</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">augment</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data:</span><span class="si">{</span><span class="n">train_size</span><span class="si">}</span><span class="s1">, Validation data:</span><span class="si">{</span><span class="n">val_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">random_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">val_size</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data before augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">, Validataion:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">augment_dataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">is_grayscale</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data after augmentation: Train: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generating Dataloader with </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">}</span><span class="s1"> workers&#39;</span><span class="p">)</span>
        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">val_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">train_loaders</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin_memory</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#dataset (Dataset)  dataset from which to load the data.</span>
    <span class="c1">#batch_size (int, optional)  how many samples per batch to load (default: 1).</span>
    <span class="c1">#shuffle (bool, optional)  set to True to have the data reshuffled at every epoch (default: False).</span>
    <span class="c1">#sampler (Sampler or Iterable, optional)  defines the strategy to draw samples from the dataset. Can be any Iterable with __len__ implemented. If specified, shuffle must not be specified.</span>
    <span class="c1">#batch_sampler (Sampler or Iterable, optional)  like sampler, but returns a batch of indices at a time. Mutually exclusive with batch_size, shuffle, sampler, and drop_last.</span>
    <span class="c1">#num_workers (int, optional)  how many subprocesses to use for data loading. 0 means that the data will be loaded in the main process. (default: 0)</span>
    <span class="c1">#collate_fn (Callable, optional)  merges a list of samples to form a mini-batch of Tensor(s). Used when using batched loading from a map-style dataset.</span>
    <span class="c1">#pin_memory (bool, optional)  If True, the data loader will copy Tensors into device/CUDA pinned memory before returning them. If your data elements are a custom type, or your collate_fn returns a batch that is a custom type, see the example below.</span>
    <span class="c1">#drop_last (bool, optional)  set to True to drop the last incomplete batch, if the dataset size is not divisible by the batch size. If False and the size of dataset is not divisible by the batch size, then the last batch will be smaller. (default: False)</span>
    <span class="c1">#timeout (numeric, optional)  if positive, the timeout value for collecting a batch from workers. Should always be non-negative. (default: 0)</span>
    <span class="c1">#worker_init_fn (Callable, optional)  If not None, this will be called on each worker subprocess with the worker id (an int in [0, num_workers - 1]) as input, after seeding and before data loading. (default: None)</span>
    <span class="c1">#multiprocessing_context (str or multiprocessing.context.BaseContext, optional)  If None, the default multiprocessing context of your operating system will be used. (default: None)</span>
    <span class="c1">#generator (torch.Generator, optional)  If not None, this RNG will be used by RandomSampler to generate random indexes and multiprocessing to generate base_seed for workers. (default: None)</span>
    <span class="c1">#prefetch_factor (int, optional, keyword-only arg)  Number of batches loaded in advance by each worker. 2 means there will be a total of 2 * num_workers batches prefetched across all workers. (default value depends on the set value for num_workers. If value of num_workers=0 default is None. Otherwise, if value of num_workers &gt; 0 default is 2).</span>
    <span class="c1">#persistent_workers (bool, optional)  If True, the data loader will not shut down the worker processes after a dataset has been consumed once. This allows to maintain the workers Dataset instances alive. (default: False)</span>
    <span class="c1">#pin_memory_device (str, optional)  the device to pin_memory to if pin_memory is True.</span>

    <span class="c1">#images, labels, filenames = next(iter(train_loaders))</span>
    <span class="c1">#images = images.cpu()</span>
    <span class="c1">#label_strings = [str(label.item()) for label in labels]</span>
    <span class="c1">#train_fig = _imshow_gpu(images, label_strings, nrow=20, fontsize=12)</span>
    <span class="c1">#if verbose:</span>
    <span class="c1">#    plt.show()</span>
    
    <span class="n">train_fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">train_loaders</span><span class="p">,</span> <span class="n">val_loaders</span><span class="p">,</span> <span class="n">train_fig</span></div>


<div class="viewcode-block" id="generate_training_dataset">
<a class="viewcode-back" href="../../spacr.html#spacr.io.generate_training_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">generate_training_dataset</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    
    <span class="c1"># Function to filter png_list_df by prcfo present in df without merging</span>
    <span class="k">def</span> <span class="nf">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>
                
        <span class="p">[</span><span class="n">png_list_df</span><span class="p">]</span> <span class="o">=</span> <span class="n">_read_db</span><span class="p">(</span><span class="n">db_loc</span><span class="o">=</span><span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;png_list&#39;</span><span class="p">])</span>
        <span class="n">filtered_png_list_df</span> <span class="o">=</span> <span class="n">png_list_df</span><span class="p">[</span><span class="n">png_list_df</span><span class="p">[</span><span class="s1">&#39;prcfo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">filtered_png_list_df</span>

    <span class="c1"># Function to get the smallest class size based on the dataset mode</span>
    <span class="k">def</span> <span class="nf">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">dataset_mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]]</span>
            <span class="c1">#sizes = [len(df[df[&#39;condition&#39;].isin(class_list)]) for class_list in settings[&#39;class_metadata&#39;]]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class sizes: </span><span class="si">{</span><span class="n">sizes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataset_mode</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span> <span class="k">for</span> <span class="n">class_paths</span> <span class="ow">in</span> <span class="n">df</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using the smallest class size: </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">size</span>
    
    <span class="c1"># Measurement-based selection logic</span>
    <span class="k">def</span> <span class="nf">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="s1">&#39;nucleus&#39;</span><span class="p">,</span> <span class="s1">&#39;pathogen&#39;</span><span class="p">,</span> <span class="s1">&#39;cytoplasm&#39;</span><span class="p">]):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_read_and_merge_data</span><span class="p">(</span><span class="n">locs</span><span class="o">=</span><span class="p">[</span><span class="n">db_path</span><span class="p">],</span>
                                     <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">nuclei_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">],</span>
                                     <span class="n">pathogen_limit</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 1&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cells</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HeLa&#39;</span><span class="p">],</span> <span class="n">pathogens</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pathogen&#39;</span><span class="p">],</span> <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">],</span>
                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span><span class="c1">#, types=settings[&#39;metadata_type_by&#39;])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;length df 2&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        
        <span class="n">png_list_df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;custom_measurement&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;custom_measurement should be a list.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pathogen_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cytoplasm_channel_</span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;channel_of_interest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_mean_intensity&quot;</span><span class="p">]</span>

        <span class="n">q25</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">q75</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">df_lower</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">q25</span><span class="p">]</span>
        <span class="n">df_upper</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recruitment&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">q75</span><span class="p">]</span>

        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_lower</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
        <span class="n">class_paths_lower</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_lower</span><span class="p">)</span>

        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">get_paths_from_db</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_upper</span><span class="p">,</span> <span class="n">png_df</span><span class="o">=</span><span class="n">png_list_df</span><span class="p">,</span> <span class="n">image_type</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;png_type&#39;</span><span class="p">])</span>
        <span class="n">class_paths_upper</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_upper</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>

    <span class="c1"># Metadata-based selection logic</span>
    <span class="k">def</span> <span class="nf">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">filter_png_list</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
                
        <span class="n">df</span> <span class="o">=</span> <span class="n">annotate_conditions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                 <span class="n">cells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">cell_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">pathogens</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_name&#39;</span><span class="p">],</span>
                                 <span class="n">pathogen_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_1_value&#39;</span><span class="p">],</span>
                                 <span class="n">treatments</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_name&#39;</span><span class="p">],</span>
                                 <span class="n">treatment_loc</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_item_2_value&#39;</span><span class="p">])</span>
        
        <span class="c1">#if settings[&#39;metadata_type_by&#39;] == &#39;condition&#39;:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">])</span>
            
        <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">get_smallest_class_size</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">]:</span>
            <span class="n">class_temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
            <span class="c1">#class_temp_df = df[df[&#39;condition&#39;].isin(class_)]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_temp_df</span><span class="p">)</span><span class="si">}</span><span class="s1"> images for class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">class_temp_df</span><span class="p">[</span><span class="s1">&#39;png_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># Ensure to sample `size` number of images (smallest class size)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>

            <span class="n">class_paths_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>

    <span class="c1"># Annotation-based selection logic</span>
    <span class="k">def</span> <span class="nf">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>
    
    <span class="c1"># Metadata-Annotation-based selection logic</span>
    <span class="k">def</span> <span class="nf">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotation_column&#39;</span><span class="p">],</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;annotated_classes&#39;</span><span class="p">],</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;metadata_type_by&#39;</span><span class="p">],</span> <span class="n">class_metadata</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">class_paths_ls</span>
    
    <span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">_read_and_merge_data</span><span class="p">,</span> <span class="n">_read_db</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_paths_from_db</span><span class="p">,</span> <span class="n">annotate_conditions</span><span class="p">,</span> <span class="n">save_settings</span>
    <span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="n">set_generate_training_dataset_defaults</span>
    
    <span class="n">settings</span> <span class="o">=</span> <span class="n">set_generate_training_dataset_defaults</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;nucleus&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;nuclei_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="s1">&#39;pathogen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">]:</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;pathogen_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
       
    <span class="c1"># Set default settings and save</span>
    <span class="n">save_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;cv_dataset&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">class_path_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]):</span>
        <span class="n">db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;measurements&#39;</span><span class="p">,</span> <span class="s1">&#39;measurements.db&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training_all&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">)</span>

        <span class="c1"># Create a new directory for training data if necessary</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
                <span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new directory for training: </span><span class="si">{</span><span class="n">dst</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="c1"># Select dataset based on dataset mode</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;annotation&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;measurement&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">measurement_based_selection</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">db_path</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;tables&#39;</span><span class="p">])</span>
            
        <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metadata_annotation&#39;</span><span class="p">:</span>
            <span class="n">class_paths_ls</span> <span class="o">=</span> <span class="n">metadata_annotation_based_selection</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dataset mode: </span><span class="si">{</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;dataset_mode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid options are: &#39;annotation&#39;, &#39;metadata&#39;, &#39;measurement&#39;, &#39;metadata_annotation&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">class_path_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_path_list</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">))]</span>

        <span class="c1"># Extend each list in class_path_list with the corresponding list from class_paths_ls</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">)):</span>
            <span class="n">class_path_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">class_paths_ls</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="c1"># Generate and return training and testing directories</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;class_path_list&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">class_path_list</span><span class="p">))</span>
    <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="o">=</span><span class="n">class_path_list</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;class_metadata&#39;</span><span class="p">],</span> <span class="n">test_split</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;test_split&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">train_class_dir</span><span class="p">,</span> <span class="n">test_class_dir</span></div>


<div class="viewcode-block" id="training_dataset_from_annotation">
<a class="viewcode-back" href="../../spacr.html#spacr.io.training_dataset_from_annotation">[docs]</a>
<span class="k">def</span> <span class="nf">training_dataset_from_annotation</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Retrieve all paths and annotations from the database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2"> FROM png_list&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
    
    <span class="c1"># Filter paths based on annotated_classes</span>
    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        
        <span class="c1"># Sample the same number of images for both classes</span>
        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>

        <span class="c1"># Resample target class to match the smaller size</span>
        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
        
        <span class="c1"># Update class paths</span>
        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">class_paths</span></div>


<div class="viewcode-block" id="training_dataset_from_annotation_metadata">
<a class="viewcode-back" href="../../spacr.html#spacr.io.training_dataset_from_annotation_metadata">[docs]</a>
<span class="k">def</span> <span class="nf">training_dataset_from_annotation_metadata</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">annotation_column</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">annotated_classes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">metadata_type_by</span><span class="o">=</span><span class="s1">&#39;column_name&#39;</span><span class="p">,</span> <span class="n">class_metadata</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;c2&#39;</span><span class="p">]):</span>
    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Connect to the database and retrieve the image paths and annotations</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading DataBase: </span><span class="si">{</span><span class="n">db_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># Retrieve all paths and annotations from the database</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT png_path, </span><span class="si">{</span><span class="n">annotation_column</span><span class="si">}</span><span class="s2">, row_name, column_name FROM png_list&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">all_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total paths retrieved:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">))</span>
    
    <span class="c1"># Filter all_paths by metadata_type_by and class_metadata</span>
    <span class="n">filtered_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metadata_index</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;row_name&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_type_by</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metadata_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid metadata_type_by value: </span><span class="si">{</span><span class="n">metadata_type_by</span><span class="si">}</span><span class="s2">. Must be &#39;row_name&#39; or &#39;column_name&#39;. </span><span class="si">{</span><span class="n">class_metadata</span><span class="si">}</span><span class="s2"> must be a list formatted as [&#39;c1&#39;, &#39;c2&#39;] or [&#39;r1&#39;, &#39;r2&#39;]&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">metadata_index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">class_metadata</span><span class="p">:</span>
            <span class="n">filtered_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total filtered paths:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_paths</span><span class="p">))</span>
    <span class="c1">#all_paths = filtered_paths</span>
    <span class="n">all_paths</span> <span class="o">=</span> <span class="p">[(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_paths</span><span class="p">]</span>
    
    <span class="c1"># Filter paths based on annotated_classes</span>
    <span class="n">class_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">annotated_classes</span><span class="p">:</span>
        <span class="n">class_paths_temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">==</span> <span class="n">class_</span><span class="p">]</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths_temp</span><span class="p">)</span><span class="si">}</span><span class="s1"> images in class </span><span class="si">{</span><span class="n">class_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="c1"># If only one class is provided, create an alternative list by sampling paths from all_paths that are not in the annotated class</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_classes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="n">annotated_classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">count_target_class</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated class: </span><span class="si">{</span><span class="n">target_class</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">count_target_class</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
        <span class="c1"># Filter all_paths to exclude paths that belong to the target class</span>
        <span class="n">alt_class_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">all_paths</span> <span class="k">if</span> <span class="n">annotation</span> <span class="o">!=</span> <span class="n">target_class</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternative paths available:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        
        <span class="c1"># Sample the same number of images for both classes</span>
        <span class="n">balanced_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count_target_class</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sampling </span><span class="si">{</span><span class="n">balanced_count</span><span class="si">}</span><span class="s1"> images for each class&#39;</span><span class="p">)</span>

        <span class="c1"># Resample target class to match the smaller size</span>
        <span class="n">sampled_target_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">balanced_count</span><span class="p">)</span>
        <span class="n">sampled_alt_class_paths</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">alt_class_paths</span><span class="p">,</span> <span class="n">balanced_count</span><span class="p">)</span>
        
        <span class="c1"># Update class paths</span>
        <span class="n">class_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_target_class_paths</span>
        <span class="n">class_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_alt_class_paths</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated a list of lists from annotation of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">class_paths</span><span class="p">)</span><span class="si">}</span><span class="s1"> classes&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_paths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Class </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="si">}</span><span class="s1"> images&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">class_paths</span></div>


<div class="viewcode-block" id="generate_dataset_from_lists">
<a class="viewcode-back" href="../../spacr.html#spacr.io.generate_dataset_from_lists">[docs]</a>
<span class="k">def</span> <span class="nf">generate_dataset_from_lists</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">class_data</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">test_split</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">print_progress</span>
    <span class="c1"># Make sure that the length of class_data matches the length of classes</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;class_data and classes must have the same length.&quot;</span><span class="p">)</span>

    <span class="n">total_files</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">class_data</span><span class="p">)</span>
    <span class="n">processed_files</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_ls</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">class_data</span><span class="p">):</span>
        <span class="c1"># Create directories</span>
        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="c1"># Split the data</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">test_split</span><span class="p">)</span>
        <span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_split</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        
        <span class="c1"># Copy train files</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Train dataset&quot;</span><span class="p">)</span>
            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Copy test files</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">time_ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">print_progress</span><span class="p">(</span><span class="n">processed_files</span><span class="p">,</span> <span class="n">total_files</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_ls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operation_type</span><span class="o">=</span><span class="s2">&quot;Copying files for Test dataset&quot;</span><span class="p">)</span>
            <span class="n">processed_files</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Print summary</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">train_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;train/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">test_class_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test/</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">, Test class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">test_class_dir</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Einar Olafsson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>